!function(e){const t=e,n=t.FeaturesState||{};Array.isArray(t.originalMappings)||(t.originalMappings=[]),Array.isArray(t.allMappings)||(t.allMappings=[]),Array.isArray(t.originalRequests)||(t.originalRequests=[]),Array.isArray(t.allRequests)||(t.allRequests=[]),t.mappingIndex instanceof Map||(t.mappingIndex=new Map),"object"==typeof t.mappingTabTotals&&null!==t.mappingTabTotals||(t.mappingTabTotals={all:0,get:0,post:0,put:0,patch:0,delete:0}),"object"==typeof t.requestTabTotals&&null!==t.requestTabTotals||(t.requestTabTotals={all:0,matched:0,unmatched:0}),t.pendingDeletedIds instanceof Set||(t.pendingDeletedIds=new Set),t.deletionTimeouts instanceof Map||(t.deletionTimeouts=new Map),void 0===t.isDemoMode&&(t.isDemoMode=!1),void 0===t.demoModeAnnounced&&(t.demoModeAnnounced=!1),void 0===t.demoModeLastError&&(t.demoModeLastError=null);let a=null;function i(e="automatic"){t.isDemoMode=!0,t.demoModeReason=e,!t.demoModeAnnounced&&void 0!==t.NotificationManager&&t.NotificationManager?.info&&(t.NotificationManager.info("WireMock API unreachable. Showing demo data so the interface stays interactive."),t.demoModeAnnounced=!0)}function s(e){if(!e||"object"!=typeof e)return;t.mappingIndex instanceof Map||(t.mappingIndex=new Map);const n=new Set;["id","uuid","stubMappingId","stubId","mappingId"].forEach(t=>{const a=e[t];a&&n.add(String(a).trim())}),e.metadata?.id&&n.add(String(e.metadata.id).trim()),n.forEach(n=>{n&&t.mappingIndex.set(n,e)})}function o(e){t.mappingIndex instanceof Map?t.mappingIndex.clear():t.mappingIndex=new Map,Array.isArray(e)&&e.forEach(s)}function r(e=[]){const t={all:0,get:0,post:0,put:0,patch:0,delete:0};return Array.isArray(e)&&0!==e.length?(t.all=e.length,e.forEach(e=>{const n=(e?.request?.method||"").toLowerCase();Object.prototype.hasOwnProperty.call(t,n)&&(t[n]+=1)}),t):t}function c(){t.mappingTabTotals=r(t.originalMappings),"function"==typeof t.updateMappingTabCounts&&t.updateMappingTabCounts()}function d(e=[]){const t={all:0,matched:0,unmatched:0};return Array.isArray(e)&&0!==e.length?(t.all=e.length,e.forEach(e=>{!1!==e?.wasMatched?t.matched+=1:t.unmatched+=1}),t):t}function p(){t.requestTabTotals=d(t.originalRequests),"function"==typeof t.updateRequestTabCounts&&t.updateRequestTabCounts()}function l(e){if(!(t.mappingIndex instanceof Map))return;const n="object"==typeof e?e:t.mappingIndex.get(e);if(n)for(const[a,i]of t.mappingIndex.entries())i!==n&&a!==e||t.mappingIndex.delete(a)}async function u({force:e=!1}={}){if(!e&&a)return a;if(e&&a)try{await a}catch(s){}const n=(async()=>{try{return await t.apiFetch(t.ENDPOINTS.MAPPINGS)}catch(s){if(t.DemoData?.isAvailable?.()&&t.DemoData?.getMappingsPayload)return t.demoModeLastError=s,i("mappings-fallback"),t.DemoData.getMappingsPayload();throw s}finally{a===n&&(a=null)}})();return a=n,n}if(n.markDemoModeActive=i,n.addMappingToIndex=s,n.rebuildMappingIndex=o,n.computeMappingTabTotals=r,n.refreshMappingTabSnapshot=c,n.computeRequestTabTotals=d,n.refreshRequestTabSnapshot=p,n.removeMappingFromIndex=l,n.fetchMappingsFromServer=u,t.markDemoModeActive=i,t.addMappingToIndex=s,t.rebuildMappingIndex=o,t.computeMappingTabTotals=r,t.refreshMappingTabSnapshot=c,t.computeRequestTabTotals=d,t.refreshRequestTabSnapshot=p,t.removeMappingFromIndex=l,t.fetchMappingsFromServer=u,t.FeaturesState=n,"function"==typeof t.dispatchEvent){let e;"function"==typeof t.CustomEvent?e=new CustomEvent("features:state-ready",{detail:{state:n}}):"undefined"!=typeof document&&document.createEvent&&(e=document.createEvent("Event"),e.initEvent("features:state-ready",!1,!1),e.detail={state:n}),e&&t.dispatchEvent(e)}}("undefined"!=typeof window?window:globalThis);const e={escapeHtml:e=>"string"!=typeof e?String(e):e.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[e])),formatJson:(e,t="Invalid JSON",n=1e3)=>{try{const t=JSON.stringify(e,null,2);return t.length>n?t.substring(0,n)+"\n... (truncated - "+(t.length-n)+" more characters)":t}catch{return t}},parseRequestTime:e=>{if(!e)return(new Date).toLocaleString("en-US");try{const t=new Date("number"==typeof e?e>1e12?e:1e3*e:e);return isNaN(t.getTime())?`Invalid: ${e}`:t.toLocaleString("en-US")}catch{return`Invalid: ${e}`}},getStatusClass:e=>{const t=parseInt(e)||0;return t>=200&&t<300?"success":t>=300&&t<400?"redirect":t>=400&&t<500?"client-error":t>=500?"server-error":"unknown"}},t=e.escapeHtml,n=e.formatJson,a=e.parseRequestTime,i=e.getStatusClass;function s(){try{const e=document.getElementById("cache-enabled");return!1!==("function"==typeof window.readWiremockSettings?window.readWiremockSettings():{}).cacheEnabled&&(!e||e.checked)}catch(e){return!1}}window.Utils=e,window.escapeHtml=t,window.formatJson=n,window.parseRequestTime=a,window.getStatusClass=i,window.applyFilters=()=>FilterManager.applyMappingFilters(),window.clearMappingFilters=()=>{document.getElementById(SELECTORS.MAPPING_FILTERS.METHOD).value="",document.getElementById(SELECTORS.MAPPING_FILTERS.URL).value="",document.getElementById(SELECTORS.MAPPING_FILTERS.STATUS).value="",FilterManager.applyMappingFilters(),"function"==typeof FilterManager.flushMappingFilters&&FilterManager.flushMappingFilters()},window.applyRequestFilters=()=>FilterManager.applyRequestFilters(),window.applyQuickFilter=()=>{const e=document.getElementById(SELECTORS.REQUEST_FILTERS.QUICK);if(!e)return;const t=e.value;if(!t){const e=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM),t=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO);return e&&(e.value=""),t&&(t.value=""),FilterManager.applyRequestFilters(),void("function"==typeof FilterManager.flushRequestFilters&&FilterManager.flushRequestFilters())}const n=new Date,a=new Date(n),i=t.match(/^(\d+)([mhd])$/);if(!i)return;const s=parseInt(i[1]);switch(i[2]){case"m":a.setMinutes(a.getMinutes()-s);break;case"h":a.setHours(a.getHours()-s);break;case"d":a.setDate(a.getDate()-s);break;default:return}const o=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}T${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`,r=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM),c=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO);r&&(r.value=o(a)),c&&(c.value=o(n)),FilterManager.applyRequestFilters(),"function"==typeof FilterManager.flushRequestFilters&&FilterManager.flushRequestFilters()},window.clearQuickFilter=()=>{const e=document.getElementById(SELECTORS.REQUEST_FILTERS.QUICK);e&&(e.value="")},window.clearRequestFilters=()=>{const e=document.getElementById(SELECTORS.REQUEST_FILTERS.METHOD),t=document.getElementById(SELECTORS.REQUEST_FILTERS.URL),n=document.getElementById(SELECTORS.REQUEST_FILTERS.STATUS),a=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM),i=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO),s=document.getElementById(SELECTORS.REQUEST_FILTERS.QUICK);e&&(e.value=""),t&&(t.value=""),n&&(n.value=""),a&&(a.value=""),i&&(i.value=""),s&&(s.value=""),FilterManager.applyRequestFilters(),"function"==typeof FilterManager.flushRequestFilters&&FilterManager.flushRequestFilters()},window.cacheManager={cache:new Map,optimisticQueue:[],optimisticTTL:3e4,cleanupInterval:null,syncInterval:null,version:0,isSyncing:!1,init(){this.cleanupInterval&&window.LifecycleManager.clearInterval(this.cleanupInterval),this.syncInterval&&window.LifecycleManager.clearInterval(this.syncInterval),this.cleanupInterval=window.LifecycleManager.setInterval(()=>this.cleanupStaleOptimisticUpdates(),5e3),this.syncInterval=window.LifecycleManager.setInterval(()=>this.syncWithServer(),6e4)},addOptimisticUpdate(e,t){const n=e?.id||e?.uuid;n&&this.optimisticQueue.push({id:n,op:t,payload:e,ts:Date.now()})},confirmOptimisticUpdate(e){const t=this.optimisticQueue.findIndex(t=>t.id===e);t>=0&&this.optimisticQueue.splice(t,1)},cleanupStaleOptimisticUpdates(){const e=Date.now(),t=this.optimisticQueue.length;this.optimisticQueue=this.optimisticQueue.filter(t=>!(e-t.ts>this.optimisticTTL));t-this.optimisticQueue.length>0&&this.rebuildCache()},removeOptimisticUpdate(e){const t=this.optimisticQueue.findIndex(t=>t.id===e);t>=0&&this.optimisticQueue.splice(t,1)},async rebuildCache(){if(!this.isSyncing){this.isSyncing=!0;try{const e=(await fetchMappingsFromServer({force:!0})).mappings||[];this.cache.clear(),e.forEach(e=>{const t=e.id||e.uuid;t&&!isImockCacheMapping(e)&&this.cache.set(t,e)});for(const t of this.optimisticQueue)"delete"===t.op?this.cache.delete(t.id):this.cache.set(t.id,t.payload);window.originalMappings=Array.from(this.cache.values()),refreshMappingTabSnapshot(),window.allMappings=window.originalMappings,rebuildMappingIndex(window.originalMappings),"function"==typeof window.fetchAndRenderMappings&&window.fetchAndRenderMappings(window.allMappings)}catch(e){}finally{this.isSyncing=!1}}},async syncWithServer(){0!==this.optimisticQueue.length&&await this.rebuildCache()},getMapping(e){return this.cache.get(e)},hasMapping(e){return this.cache.has(e)},clear(){this.cache.clear(),this.optimisticQueue.length=0,this.version=0}},window.cacheManager.init(),window.connectToWireMock=async()=>{const e=document.getElementById("wiremock-host")||document.getElementById(SELECTORS.CONNECTION.HOST),t=document.getElementById("wiremock-port")||document.getElementById(SELECTORS.CONNECTION.PORT);if(!e||!t)return void NotificationManager.error("Error: connection fields not found");const n=e.value.trim()||"localhost",a=t.value.trim()||"8080";if("function"==typeof window.normalizeWiremockBaseUrl)window.wiremockBaseUrl=window.normalizeWiremockBaseUrl(n,a);else{const e=/^(https?:)\/\//i.test(n),t=e?n.split(":")[0]:"http",i=e?n.replace(/^(https?:)\/\//i,""):n,s=String(a).trim()||("https"===t?"443":"8080");window.wiremockBaseUrl=`${t}://${i}:${s}/__admin`}try{await checkHealthAndStartUptime();const e=document.getElementById(SELECTORS.CONNECTION.STATUS_DOT),t=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT),n=document.getElementById(SELECTORS.CONNECTION.SETUP),a=document.getElementById(SELECTORS.BUTTONS.ADD_MAPPING);e&&(e.className="status-dot connected"),t&&(window.lastWiremockSuccess||(window.lastWiremockSuccess=Date.now()),"function"==typeof window.updateLastSuccessUI&&window.updateLastSuccessUI()),n&&(n.style.display="none"),a&&(a.disabled=!1);const i=document.getElementById(SELECTORS.UI.STATS),o=document.getElementById("stats-spacer"),r=document.getElementById(SELECTORS.UI.SEARCH_FILTERS);i&&(i.style.display="flex"),o&&(o.style.display="none"),r&&(r.style.display="block"),startHealthMonitoring();const c=s(),[d,p]=await Promise.all([fetchAndRenderMappings(null,{useCache:c}),fetchAndRenderRequests()]);await loadScenarios(),d&&p&&NotificationManager.success("Connected to WireMock successfully!")}catch(i){NotificationManager.error(`Connection error: ${i.message}`),stopUptime();const e=document.getElementById(SELECTORS.CONNECTION.STATUS_DOT),t=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT);e&&(e.className="status-dot disconnected"),t&&(t.textContent="Disconnected")}};let o,r=null;function c({maintainFilters:e=!0}={}){try{const t=buildCacheSnapshot();window.originalMappings=t,refreshMappingTabSnapshot(),window.allMappings=t,rebuildMappingIndex(window.originalMappings);const n=document.getElementById(SELECTORS.MAPPING_FILTERS.METHOD)?.value||"",a=document.getElementById(SELECTORS.MAPPING_FILTERS.URL)?.value||"",i=document.getElementById(SELECTORS.MAPPING_FILTERS.STATUS)?.value||"";e&&Boolean(n||a||i)&&"undefined"!=typeof FilterManager&&"function"==typeof FilterManager.applyMappingFilters?(FilterManager.applyMappingFilters(),"function"==typeof FilterManager.flushMappingFilters&&FilterManager.flushMappingFilters()):"function"==typeof fetchAndRenderMappings&&fetchAndRenderMappings(window.allMappings),"function"==typeof updateDataSourceIndicator&&updateDataSourceIndicator("cache")}catch(t){}}window.checkHealthAndStartUptime=async()=>{try{const n=performance.now();let a=0,i=!1;try{const e=await apiFetch(ENDPOINTS.HEALTH);a=Math.round(performance.now()-n),i="object"==typeof e&&("string"==typeof e.status&&["up","healthy","ok"].includes(e.status.toLowerCase())||!0===e.healthy)}catch(e){const t=await fetchMappingsFromServer();a=Math.round(performance.now()-n),i="object"==typeof t}if(!i)throw new Error("WireMock is not healthy");{if(window.startTime=Date.now(),window.uptimeInterval&&window.LifecycleManager.clearInterval(window.uptimeInterval),window.uptimeInterval=window.LifecycleManager.setInterval(updateUptime,1e3),"function"==typeof window.applyHealthUI)try{window.applyHealthUI(!0,a)}catch(t){}if("function"==typeof window.applyHealthUI)try{window.applyHealthUI(i,i?a:null)}catch(t){}const e=document.getElementById(SELECTORS.HEALTH.INDICATOR);e&&(e.style.display="inline",e.innerHTML=`<span>Response Time: </span><span class="healthy">${a}ms</span>`)}}catch(n){throw n}},window.startHealthMonitoring=()=>{r&&window.LifecycleManager.clearInterval(r),r=window.LifecycleManager.setInterval(async()=>{try{const t=performance.now();let n=0,a=!1;try{const e=await apiFetch(ENDPOINTS.HEALTH);n=Math.round(performance.now()-t),a="object"==typeof e&&("string"==typeof e.status&&["up","healthy","ok"].includes(e.status.toLowerCase())||!0===e.healthy)}catch(e){const i=await fetchMappingsFromServer();n=Math.round(performance.now()-t),a="object"==typeof i}const i=document.getElementById(SELECTORS.HEALTH.INDICATOR);i&&(a?i.innerHTML=`<span>Response Time: </span><span class="healthy">${n}ms</span>`:(i.innerHTML='<span>Response Time: </span><span class="unhealthy">Unhealthy</span>',stopUptime(),window.LifecycleManager.clearInterval(r),NotificationManager.warning("WireMock health check failed, uptime stopped")))}catch(t){const e=document.getElementById(SELECTORS.HEALTH.INDICATOR);if("function"==typeof window.applyHealthUI)try{window.applyHealthUI(null,null)}catch{}else e&&(e.innerHTML='<span>Response Time: </span><span class="error">Error</span>');stopUptime(),window.LifecycleManager.clearInterval(r),NotificationManager.error("Health monitoring failed, uptime stopped")}},3e4)};let d=!1,p=0;function l(e){return e&&"object"==typeof e&&"function"==typeof e.forEach&&"number"==typeof e.size&&"[object Map]"===Object.prototype.toString.call(e)}window.cacheValidationInterval=window.LifecycleManager.setInterval(()=>{const e=Date.now()-(window.cacheLastUpdate||0),t=window.cacheOptimisticOperations||0;(e>3e5||t>20)&&async function(){try{if(!s())return;const e=await fetchExistingCacheMapping();if(e&&extractCacheJsonBody(e))return;const t=await fetchMappingsFromServer({force:!0});if(!t?.mappings)return;const n=await regenerateImockCache(t);window.imockCacheSnapshot=n,window.cacheOptimisticOperations=0,window.cacheLastUpdate=Date.now()}catch(e){}}()},6e4),window.refreshImockCache=async()=>{if(d&&!(p++>10))return new Promise(e=>{setTimeout(async()=>{await window.refreshImockCache(),e()},1e3)});p=0,d=!0;try{window.cacheRebuilding=!0;try{s()&&updateDataSourceIndicator("cache_rebuilding")}catch(e){}const n=await regenerateImockCache();window.imockCacheSnapshot=n,window.cacheManager.optimisticQueue.length=0;try{"function"==typeof window.fetchAndRenderMappings&&window.allMappings&&window.fetchAndRenderMappings(window.allMappings)}catch(t){}}catch(n){}finally{window.cacheRebuilding=!1,window.cacheLastUpdate=Date.now(),window.cacheOptimisticOperations=0,d=!1,p=0;try{s()&&updateDataSourceIndicator("cache")}catch(e){}}},window.refreshMappingsFromCache=c,window.updateOptimisticCache=function(e,t,n={}){try{const i=e?.id||e?.uuid;if(!i)return;if(!(window.cacheManager&&window.cacheManager.cache instanceof Map))return;const s=window.cacheManager.cache;seedCacheFromGlobals(s);const o=(t||"update").toLowerCase(),r="string"==typeof n.queueMode?n.queueMode:"confirm",d="confirm"===r;if("add"===r&&"function"==typeof window.cacheManager.addOptimisticUpdate)try{window.cacheManager.addOptimisticUpdate(e,o)}catch(a){}if("delete"===o){if(removeMappingFromIndex(i),s.delete(i),window.pendingDeletedIds instanceof Set&&window.pendingDeletedIds.add(i),window.deletionTimeouts instanceof Map){const e=window.deletionTimeouts.get(i);e&&clearTimeout(e);const t=setTimeout(()=>{try{window.pendingDeletedIds instanceof Set&&window.pendingDeletedIds.delete(i)}finally{window.deletionTimeouts instanceof Map&&window.deletionTimeouts.delete(i)}},15e3);window.deletionTimeouts.set(i,t)}d&&"function"==typeof window.cacheManager.removeOptimisticUpdate&&window.cacheManager.removeOptimisticUpdate(i)}else{const t=cloneMappingForCache(e);if(!t)return;if(!t.id&&i&&(t.id=i),t.uuid||!e.uuid&&!i||(t.uuid=e.uuid||i),addMappingToIndex(e),s.has(i)){const e=mergeMappingData(s.get(i),t);s.set(i,e)}else s.set(i,t);d&&"function"==typeof window.cacheManager.confirmOptimisticUpdate&&window.cacheManager.confirmOptimisticUpdate(i)}window.cacheLastUpdate=Date.now(),"number"==typeof window.cacheManager?.version&&(window.cacheManager.version+=1),c(),enqueueCacheSync(e,o)}catch(i){}},window.isCacheEnabled=s,window.scheduleCacheRebuild=function(){try{if(!s())return;const e="function"==typeof window.readWiremockSettings?window.readWiremockSettings():{},t=Number(e.cacheRebuildDelay)||1e3;clearTimeout(o),o=setTimeout(async()=>{try{const e=await fetchExistingCacheMapping();if(e&&extractCacheJsonBody(e))return;"function"==typeof window.refreshImockCache&&await window.refreshImockCache()}catch(e){}},t)}catch(e){}},window.mappingPreviewState instanceof Set||(window.mappingPreviewState=new Set),window.mappingPreviewToastState instanceof Map||(window.mappingPreviewToastState=new Map),l(window.optimisticShadowMappings)||(window.optimisticShadowMappings=new Map);const u={createCard:(e,t,n=[])=>{const{id:a,method:i,url:s,status:o,name:r,time:c,extras:d={},expanded:p=!1}=t;return`\n            <div class="${e}-card${p?" is-expanded":""}" data-id="${Utils.escapeHtml(a)}">\n                <div class="${e}-header" onclick="window.toggleDetails('${Utils.escapeHtml(a)}', '${e}')">\n                    <div class="${e}-info">\n                        <div class="${e}-top-line">\n                            <span class="method-badge ${i.toLowerCase()}">\n                                <span class="collapse-arrow" id="arrow-${Utils.escapeHtml(a)}">${p?"▼":"▶"}</span> ${i}\n                            </span>\n                            ${r?`<span class="${e}-name">${Utils.escapeHtml(r)}</span>`:""}\n                            ${c?`<span class="${e}-time">${c}</span>`:""}\n                        </div>\n                        <div class="${e}-url-line">\n                            <span class="status-badge ${Utils.getStatusClass(o)}">${o}</span>\n                            <span class="${e}-url">${Utils.escapeHtml(s)}</span>\n                            ${d.badges||""}\n                        </div>\n                    </div>\n                    <div class="${e}-actions" onclick="event.stopPropagation()">\n                        ${n.map(e=>`\n                            <button class="btn btn-sm btn-${e.class}"\n                                    onclick="${e.handler}('${Utils.escapeHtml(a)}')"\n                                    title="${Utils.escapeHtml(e.title)}">\n                                ${e.icon?Icons.render(e.icon,{className:"action-icon"}):""}\n                                <span class="sr-only">${Utils.escapeHtml(e.title)}</span>\n                            </button>\n                        `).join("")}\n                    </div>\n                </div>\n                <div class="${e}-preview" id="preview-${Utils.escapeHtml(a)}" style="display: ${p?"block":"none"};">\n                    ${d.preview||""}\n                </div>\n            </div>`},getCardElement(e,t){const n=document.querySelectorAll(`.${e}-card`),a=String(t??"");for(const i of n)if((i.dataset?.id||"")===a)return i;return null},setCardState(e,t,n,a=!0){const i=this.getCardElement(e,t);i&&i.classList.toggle(n,Boolean(a))},clearCardState(e,t){document.querySelectorAll(`.${e}-card.${t}`).forEach(e=>{e.classList.remove(t)})},createPreviewSection:(e,t)=>`\n        <div class="preview-section">\n            <h4>${e}</h4>\n            ${Object.entries(t).map(([e,t])=>{if(!t)return"";if("object"==typeof t){if(JSON.stringify(t).length>500){const n=Utils.formatJson(t,"Invalid JSON",200),a=`full-${Math.random().toString(36).substr(2,9)}`;return`<div class="preview-value">\n                            <strong>${e}:</strong>\n                            <pre>${n}</pre>\n                            <button class="btn btn-secondary btn-small" onclick="toggleFullContent('${a}')" data-json="${Utils.escapeHtml(JSON.stringify(t))}" style="margin-top: 0.5rem; font-size: 0.8rem;">\n                                Show Full Content\n                            </button>\n                            <div id="${a}" style="display: none;"></div>\n                        </div>`}return`<div class="preview-value"><strong>${e}:</strong><pre>${Utils.formatJson(t)}</pre></div>`}if("string"==typeof t){const a=t.trim();if(a.startsWith("{")&&a.endsWith("}"))try{const t=JSON.parse(a);if(JSON.stringify(t).length>500){const n=Utils.formatJson(t,"Invalid JSON",200),a=`full-${Math.random().toString(36).substr(2,9)}`;return`<div class="preview-value">\n                                    <strong>${e}:</strong>\n                                    <pre>${n}</pre>\n                                    <button class="btn btn-secondary btn-small" onclick="toggleFullContent('${a}')" data-json="${Utils.escapeHtml(JSON.stringify(t))}" style="margin-top: 0.5rem; font-size: 0.8rem;">\n                                        Show Full Content\n                                    </button>\n                                    <div id="${a}" style="display: none;"></div>\n                                </div>`}return`<div class="preview-value"><strong>${e}:</strong><pre>${Utils.formatJson(t)}</pre></div>`}catch(n){}const i=Utils.escapeHtml(t);return`<div class="preview-value"><strong>${e}:</strong> ${i.includes("\n")?`<pre>${i}</pre>`:i}</div>`}return`<div class="preview-value"><strong>${e}:</strong> ${Utils.escapeHtml(String(t))}</div>`}).join("")}\n        </div>`,toggleDetails:(e,t)=>{const n=String(e??""),a=document.getElementById(`preview-${e}`),i=document.getElementById(`arrow-${e}`),s=!!a&&"none"===a.style.display;if(a&&(a.style.display=s?"block":"none"),i&&(i.textContent=s?"▼":"▶"),"mapping"===t){const e=a?a.closest(`.${t}-card`):null;e&&e.classList.toggle("is-expanded",s),window.mappingPreviewState instanceof Set&&(s?window.mappingPreviewState.add(n):window.mappingPreviewState.delete(n))}u.setCardState(t,e,"is-expanded",s)},toggleFullContent:e=>{const t=document.getElementById(e),n=t.previousElementSibling;if("none"===t.style.display)try{const e=n.getAttribute("data-json"),a=JSON.parse(e);t.innerHTML=`<pre style="max-height: 300px; overflow-y: auto; background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-sm); margin-top: 0.5rem;">${Utils.escapeHtml(JSON.stringify(a,null,2))}</pre>`,t.style.display="block",n.textContent="Hide Full Content"}catch(a){t.innerHTML=`<div class="preview-value warning">Error parsing JSON: ${Utils.escapeHtml(a.message)}</div>`,t.style.display="block",n.textContent="Hide"}else t.style.display="none",n.textContent="Show Full Content"}};function m(e,t){if(l(window.optimisticShadowMappings)||(window.optimisticShadowMappings=new Map),!e||"object"!=typeof e)return;const n=e.id||e.uuid;if(!n)return;const a="string"==typeof t?t.toLowerCase():"update";if("delete"===a)return void window.optimisticShadowMappings.delete(String(n));const i=function(e){if(!e||"object"!=typeof e)return null;try{if("function"==typeof structuredClone)return structuredClone(e)}catch{}try{return JSON.parse(JSON.stringify(e))}catch{}return{...e}}(e);i&&("number"!=typeof i.__optimisticTs&&Object.defineProperty(i,"__optimisticTs",{value:Date.now(),writable:!1,enumerable:!1,configurable:!0}),window.optimisticShadowMappings.set(String(n),{ts:Date.now(),op:"create"===a?"create":"update",mapping:i}))}function g(e){if(!e||"object"!=typeof e)return Number.NaN;const t=e.metadata||{},n=[t.edited,t.updated,t.updatedAt,t.created,t.timestamp];for(const a of n){if(!a)continue;if(a instanceof Date){const e=a.getTime();if(Number.isFinite(e))return e}const e=Date.parse(a);if(Number.isFinite(e))return e;const t=Number(a);if(Number.isFinite(t))return t}return"number"==typeof e.__optimisticTs?e.__optimisticTs:Number.NaN}function w(e){if(!Array.isArray(e))return e;if(!l(window.optimisticShadowMappings)||0===window.optimisticShadowMappings.size)return e;const t=Date.now(),n=function(){const e=Number(window.cacheManager?.optimisticTTL);if(Number.isFinite(e)&&e>0)return Math.max(e,45e3);const t=Number(window.DEFAULT_SETTINGS?.optimisticCacheAgeLimit);return Number.isFinite(t)&&t>0?Math.max(t,45e3):6e4}(),a=[...e];for(const[i,s]of Array.from(window.optimisticShadowMappings.entries())){const e=String(i||"");if(!s||"object"!=typeof s){window.optimisticShadowMappings.delete(e);continue}if(null==s.mapping){const t=a.findIndex(t=>String(t?.id||t?.uuid||"")===e);-1!==t&&a.splice(t,1),window.optimisticShadowMappings.delete(e);continue}if(!Number.isFinite(s.ts)||t-s.ts>n){window.optimisticShadowMappings.delete(e);continue}const o=a.findIndex(t=>String(t?.id||t?.uuid||"")===e);if(-1!==o){let n=!1,i=!0;if("function"==typeof getMappingRenderSignature)try{const t=getMappingRenderSignature(a[o]);if(t===getMappingRenderSignature(s.mapping)){window.optimisticShadowMappings.delete(e);continue}}catch{}if("create"===(s.op||"update"))i=!1;else{const e=g(a[o]),t=g(s.mapping);Number.isFinite(t)&&(!Number.isFinite(e)||t>e)?n=!0:i=!1}n?(s.ts=t,a[o]=s.mapping):i?s.ts=t:window.optimisticShadowMappings.delete(e)}else a.unshift(s.mapping),Number.isFinite(s.ts)||(s.ts=t)}return a}function f(e){if(!l(window.optimisticShadowMappings)||0===window.optimisticShadowMappings.size)return;if(!Array.isArray(e)||0===e.length)return;const t=new Map;e.forEach(e=>{if(e&&"object"==typeof e){const n=String(e.id||e.uuid||"");n&&t.set(n,e)}});for(const[n,a]of Array.from(window.optimisticShadowMappings.entries())){if(!t.has(n))continue;if(!a||"object"!=typeof a){window.optimisticShadowMappings.delete(n);continue}if("create"===(a.op||"update"))continue;if(!a.mapping||"object"!=typeof a.mapping){window.optimisticShadowMappings.delete(n);continue}const e=t.get(n);if(!e){window.optimisticShadowMappings.delete(n);continue}try{if("function"==typeof getMappingRenderSignature&&a.mapping){const t=getMappingRenderSignature(e);if(t===getMappingRenderSignature(a.mapping)){window.optimisticShadowMappings.delete(n);continue}}}catch{}const i=g(e),s=g(a.mapping);Number.isFinite(i)&&(!Number.isFinite(s)||i>=s)&&window.optimisticShadowMappings.delete(n)}}function h(){const e=window.mappingTabTotals||computeMappingTabTotals(window.originalMappings),t={all:document.getElementById("mapping-tab-all"),get:document.getElementById("mapping-tab-get"),post:document.getElementById("mapping-tab-post"),put:document.getElementById("mapping-tab-put"),patch:document.getElementById("mapping-tab-patch"),delete:document.getElementById("mapping-tab-delete")};Object.entries(t).forEach(([t,n])=>{n&&(n.textContent=e?.[t]??0)})}function y(e){const t=document.getElementById("data-source-indicator");if(!t)return;let n="Source: direct",a="badge badge-secondary";switch(e){case"cache":n="Source: cache",a="badge badge-success";break;case"cache_rebuilding":n="Source: cache (rebuilding…)",a="badge badge-success";break;case"demo":n="Source: demo data",a="badge badge-info";break;case"custom":n="Source: custom",a="badge badge-secondary";break;case"remote":n="Source: remote",a="badge badge-warning";break;case"remote_error":n="Source: remote (error/CORS)",a="badge badge-danger";break;default:n="Source: direct",a="badge badge-secondary"}t.textContent=n,t.className=a}function S(e,t){const n=String(e||"");if(!(window.mappingPreviewState instanceof Set&&window.mappingPreviewState.has(n)))return;if(window.mappingPreviewToastState instanceof Map){const e=Date.now();if(e-(window.mappingPreviewToastState.get(n)||0)<4e3)return;window.mappingPreviewToastState.set(n,e)}const a=t?.name||t?.metadata?.name||n;window.NotificationManager&&"function"==typeof window.NotificationManager.info&&window.NotificationManager.info(`Mapping "${a}" refreshed with latest data.`)}function E(e){const t=String(e||"");window.mappingPreviewState instanceof Set&&window.mappingPreviewState.delete(t),window.mappingPreviewToastState instanceof Map&&window.mappingPreviewToastState.delete(t),l(window.optimisticShadowMappings)&&window.optimisticShadowMappings.delete(t)}function M(){const e=document.getElementById(SELECTORS.COUNTERS.REQUESTS);e&&(e.textContent=Array.isArray(window.allRequests)?window.allRequests.length:0),T()}function T(){const e=window.requestTabTotals||computeRequestTabTotals(window.originalRequests),t={all:document.getElementById("requests-tab-all"),matched:document.getElementById("requests-tab-matched"),unmatched:document.getElementById("requests-tab-unmatched")};Object.entries(t).forEach(([t,n])=>{n&&(n.textContent=e?.[t]??0)})}function I(e){if(!e)return;const t=e.dataset.filterGroup;t&&document.querySelectorAll(`.filter-tab[data-filter-group="${t}"]`).forEach(t=>{t.classList.toggle("active",t===e)})}function R(e,t){const n=(t||"").toString().toLowerCase(),a=document.querySelectorAll(`.filter-tab[data-filter-group="${e}"]`);let i=!1;a.forEach(e=>{const t=(e.dataset.filterValue||"").toLowerCase();t===n||!t&&!n?(e.classList.add("active"),i=!0):e.classList.remove("active")}),!i&&a.length>0&&a[0].classList.add("active")}window.toggleFullContent=u.toggleFullContent,window.toggleDetails=u.toggleDetails,window.fetchAndRenderMappings=async(e=null,t={})=>{const n=document.getElementById(SELECTORS.LISTS.MAPPINGS),a=document.getElementById(SELECTORS.EMPTY.MAPPINGS),i=document.getElementById(SELECTORS.LOADING.MAPPINGS);if(!n||!a||!i)return!1;let s=null;try{if(null===e){let e;i.classList.remove("hidden"),n.style.display="none",a.classList.add("hidden");let r="direct";if(t&&t.useCache){const t=await loadImockCacheBestOf3();if(t&&t.data&&Array.isArray(t.data.mappings))r="cache",(async()=>{try{await new Promise(e=>setTimeout(e,200));const e=await fetchMappingsFromServer({force:!0});if(e&&e.mappings){const t=e.mappings.filter(e=>!isImockCacheMapping(e)),n=(new Set(window.allMappings.map(e=>e.id||e.uuid)),new Set(t.map(e=>e.id||e.uuid))),a=[];t.forEach(e=>{const t=e.id||e.uuid,n=window.cacheManager.optimisticQueue.find(e=>e.id===t);n&&"delete"===n.op||a.push(e)}),window.allMappings.forEach(e=>{const t=e.id||e.uuid;n.has(t)||a.push(e)}),window.allMappings=a,window.originalMappings=a,refreshMappingTabSnapshot(),syncCacheWithMappings(window.originalMappings),rebuildMappingIndex(window.originalMappings),fetchAndRenderMappings(window.allMappings,{source:"direct"})}}catch(e){}})(),e=t.data;else{e=await fetchMappingsFromServer({force:!0}),r="direct";try{regenerateImockCache()}catch{}}}else e=await fetchMappingsFromServer({force:!0}),r="direct";if(e&&e.__source){r=e.__source,"demo"===r&&markDemoModeActive("mappings-fallback");try{delete e.__source}catch(o){}}let c=e.mappings||[];window.cacheManager.optimisticQueue.length>0&&(c=c.map(e=>{const t=window.cacheManager.optimisticQueue.find(t=>t.id===(e.id||e.uuid));return t?"delete"===t.op?null:t.payload:e}).filter(e=>null!==e),window.cacheManager.optimisticQueue.forEach(e=>{"delete"===e.op||c.some(t=>(t.id||t.uuid)===e.id)||c.unshift(e.payload)})),c=w(c);try{if(window.pendingDeletedIds&&window.pendingDeletedIds.size>0){c.length;c=c.filter(e=>!window.pendingDeletedIds.has(e.id||e.uuid)),c.length}}catch{}window.originalMappings=Array.isArray(c)?c.filter(e=>!isImockCacheMapping(e)):[],refreshMappingTabSnapshot(),syncCacheWithMappings(window.originalMappings),window.allMappings=window.originalMappings,rebuildMappingIndex(window.originalMappings),f(window.originalMappings),s=r}else{const n="string"==typeof t?.source?t.source:null;window.allMappings=Array.isArray(e)?[...e]:[],window.originalMappings=[...window.allMappings],refreshMappingTabSnapshot(),rebuildMappingIndex(window.originalMappings),f(window.originalMappings),s=n,"demo"===s&&markDemoModeActive("manual-mappings")}if(i.classList.add("hidden"),0===window.allMappings.length)return a.classList.remove("hidden"),n.style.display="none",updateMappingsCounter(),!0;a.classList.add("hidden"),n.style.display="block",window.invalidateElementCache(SELECTORS.LISTS.MAPPINGS);const r=[...window.allMappings].sort((e,t)=>{const n=e.priority||1,a=t.priority||1;if(n!==a)return n-a;const i={GET:1,POST:2,PUT:3,PATCH:4,DELETE:5},s=i[e.request?.method]||999,o=i[t.request?.method]||999;if(s!==o)return s-o;const r=e.request?.url||e.request?.urlPattern||e.request?.urlPath||"",c=t.request?.url||t.request?.urlPattern||t.request?.urlPath||"";return r.localeCompare(c)});renderList(n,r,{renderItem:renderMappingMarkup,getKey:getMappingRenderKey,getSignature:getMappingRenderSignature,onItemChanged:S,onItemRemoved:E}),updateMappingsCounter(),s&&y(s);try{(document.getElementById(SELECTORS.MAPPING_FILTERS.METHOD)?.value||document.getElementById(SELECTORS.MAPPING_FILTERS.URL)?.value||""||document.getElementById(SELECTORS.MAPPING_FILTERS.STATUS)?.value||"")&&"undefined"!=typeof FilterManager&&FilterManager.applyMappingFilters&&(FilterManager.applyMappingFilters(),"function"==typeof FilterManager.flushMappingFilters&&FilterManager.flushMappingFilters())}catch{}return!0}catch(r){return NotificationManager.error(`Failed to load mappings: ${r.message}`),i.classList.add("hidden"),a.classList.remove("hidden"),n.style.display="none",!1}},window.getMappingById=async e=>{try{if(!e)throw new Error("Mapping ID is required");let t=null;if(window.mappingIndex instanceof Map&&(t=window.mappingIndex.get(e)||null),t||(t=window.allMappings?.find(t=>t.id===e)||null),t)return t;const n=await apiFetch(`/mappings/${e}`),a=n&&"object"==typeof n&&n.mapping?n.mapping:n;if(!a||"object"!=typeof a)throw new Error(`Mapping with ID ${e} not found or invalid response`);return addMappingToIndex(a),a}catch(t){throw t}},window.applyOptimisticMappingUpdate=e=>{try{if(!e)return;const n=e.mapping||e,a=n?.id||n?.uuid;if(!n||!a)return;if(isImockCacheMapping(n))return;const i=window.cacheManager&&window.cacheManager.cache instanceof Map,s=i&&window.cacheManager.cache.has(a)?"update":"create";if(m(n,s),"function"==typeof updateOptimisticCache)updateOptimisticCache(n,s,{queueMode:"add"});else{if(i){if("function"==typeof window.cacheManager?.addOptimisticUpdate)try{window.cacheManager.addOptimisticUpdate(n,s)}catch(t){}seedCacheFromGlobals(window.cacheManager.cache);const e=cloneMappingForCache(n);if(e)if(!e.id&&a&&(e.id=a),e.uuid||!n.uuid&&!a||(e.uuid=n.uuid||a),window.cacheManager.cache.has(a)){const t=mergeMappingData(window.cacheManager.cache.get(a),e);window.cacheManager.cache.set(a,t)}else window.cacheManager.cache.set(a,e);else;}window.cacheLastUpdate=Date.now(),refreshMappingsFromCache()}}catch(n){}},window.backgroundRefreshMappings=async(e=!1)=>{try{let n,a="direct";if(e){const e=await loadImockCacheBestOf3();e&&e.data&&Array.isArray(e.data.mappings)?(n=e.data,a="cache"):(n=await fetchMappingsFromServer({force:!0}),a="direct")}else n=await fetchMappingsFromServer({force:!0}),a="direct";let i=n.mappings||[];i=w(i);try{if(window.pendingDeletedIds instanceof Set&&window.pendingDeletedIds.size>0){i.length;i=i.filter(e=>{if(!e||"object"!=typeof e)return!0;const t=e.id||e.uuid;return!window.pendingDeletedIds.has(t)}),i.length}}catch(t){}window.originalMappings=Array.isArray(i)?i.filter(e=>!isImockCacheMapping(e)):[],refreshMappingTabSnapshot(),syncCacheWithMappings(window.originalMappings),window.allMappings=window.originalMappings,rebuildMappingIndex(window.originalMappings),f(window.originalMappings),y(a),fetchAndRenderMappings(window.allMappings)}catch(n){}},window.renderMappingCard=function(e){if(!e||!e.id)return"";const t=String(e.id||e.uuid||""),n=window.mappingPreviewState instanceof Set&&window.mappingPreviewState.has(t),a={id:e.id,method:e.request?.method||"GET",url:e.request?.urlPath||e.request?.urlPathPattern||e.request?.urlPattern||e.request?.url||"N/A",status:e.response?.status||200,name:e.name||e.metadata?.name||`Mapping ${e.id.substring(0,8)}`,expanded:n,extras:{preview:u.createPreviewSection(`${Icons.render("request-in",{className:"icon-inline"})} Request`,{Method:e.request?.method||"GET",URL:e.request?.url||e.request?.urlPattern||e.request?.urlPath||e.request?.urlPathPattern,Headers:e.request?.headers,Body:e.request?.bodyPatterns||e.request?.body,"Query Parameters":e.request?.queryParameters})+u.createPreviewSection(`${Icons.render("response-out",{className:"icon-inline"})} Response`,{Status:e.response?.status,Headers:e.response?.headers,Body:e.response?.jsonBody||e.response?.body,Delay:e.response?.fixedDelayMilliseconds?`${e.response.fixedDelayMilliseconds}ms`:null})+u.createPreviewSection(`${Icons.render("info",{className:"icon-inline"})} Overview`,{ID:e.id||e.uuid,Name:e.name||e.metadata?.name,Priority:e.priority,Persistent:e.persistent,Scenario:e.scenarioName,"Required State":e.requiredScenarioState,"New State":e.newScenarioState,Created:!1!==window.showMetaTimestamps&&e.metadata?.created?new Date(e.metadata.created).toLocaleString():null,Edited:!1!==window.showMetaTimestamps&&e.metadata?.edited?new Date(e.metadata.edited).toLocaleString():null,Source:e.metadata?.source?`Edited from ${e.metadata.source}`:null}),badges:[e.id||e.uuid?`<span class="badge badge-secondary" title="Mapping ID">${Utils.escapeHtml((e.id||e.uuid).length>12?(e.id||e.uuid).slice(0,8)+"…"+(e.id||e.uuid).slice(-4):e.id||e.uuid)}</span>`:"","number"==typeof e.priority?`<span class="badge badge-secondary" title="Priority">P${e.priority}</span>`:"",e.scenarioName?`<span class="badge badge-secondary" title="Scenario">${Utils.escapeHtml(e.scenarioName)}</span>`:"",!1!==window.showMetaTimestamps&&e.metadata?.created?`<span class="badge badge-secondary" title="Created">C: ${new Date(e.metadata.created).toLocaleString()}</span>`:"",!1!==window.showMetaTimestamps&&e.metadata?.edited?`<span class="badge badge-secondary" title="Edited">E: ${new Date(e.metadata.edited).toLocaleString()}</span>`:"",e.metadata?.source?`<span class="badge badge-info" title="Last edited from">${e.metadata.source.toUpperCase()}</span>`:""].filter(Boolean).join(" ")}};return u.createCard("mapping",a,[{class:"secondary",handler:"editMapping",title:"Edit in Editor",icon:"open-external"},{class:"primary",handler:"openEditModal",title:"Edit",icon:"pencil"},{class:"danger",handler:"deleteMapping",title:"Delete",icon:"trash"}])},window.updateMappingsCounter=function(){const e=document.getElementById(SELECTORS.COUNTERS.MAPPINGS);e&&(e.textContent=Array.isArray(window.allMappings)?window.allMappings.length:0),h()},window.toggleMappingDetails=e=>u.toggleDetails(e,"mapping"),window.toggleRequestDetails=e=>u.toggleDetails(e,"request"),window.UIComponents=u,window.updateMappingTabCounts=h,window.updateDataSourceIndicator=y,window.updateRequestsSourceIndicator=function(e){const t=document.getElementById("requests-source-indicator");if(!t)return;let n="Requests: direct",a="badge badge-secondary";switch(e){case"custom":n="Requests: custom",a="badge badge-secondary";break;case"demo":n="Requests: demo data",a="badge badge-info";break;case"remote":n="Requests: remote",a="badge badge-warning";break;case"remote_error":n="Requests: remote (error/CORS)",a="badge badge-danger";break;default:n="Requests: direct",a="badge badge-secondary"}t.textContent=n,t.className=a},window.fetchAndRenderRequests=async(e=null,t={})=>{const n=document.getElementById(SELECTORS.LISTS.REQUESTS),a=document.getElementById(SELECTORS.EMPTY.REQUESTS),i=document.getElementById(SELECTORS.LOADING.REQUESTS);if(!n||!a||!i)return!1;try{let r="direct";if(null===e){let e;i.classList.remove("hidden"),n.style.display="none",a.classList.add("hidden");try{e=await apiFetch(ENDPOINTS.REQUESTS)}catch(s){if(!window.DemoData?.isAvailable?.()||!window.DemoData?.getRequestsPayload)throw s;window.demoModeLastError=s,markDemoModeActive("requests-fallback"),e=window.DemoData.getRequestsPayload()}if(e&&e.__source){r=e.__source,"demo"===r&&markDemoModeActive("requests-fallback");try{delete e.__source}catch(o){}}window.originalRequests=e.requests||[],refreshRequestTabSnapshot(),window.allRequests=[...window.originalRequests]}else{const n=t?.source;window.allRequests=Array.isArray(e)?[...e]:[],window.originalRequests=[...window.allRequests],refreshRequestTabSnapshot(),r=n||"custom","demo"===r&&markDemoModeActive("manual-requests")}return i.classList.add("hidden"),0===window.allRequests.length?(a.classList.remove("hidden"),n.style.display="none",M(),!0):(a.classList.add("hidden"),n.style.display="block",window.invalidateElementCache(SELECTORS.LISTS.REQUESTS),renderList(n,window.allRequests,{renderItem:renderRequestMarkup,getKey:getRequestRenderKey,getSignature:getRequestRenderSignature}),M(),"function"==typeof updateRequestsSourceIndicator&&updateRequestsSourceIndicator(r),!0)}catch(s){return NotificationManager.error(`Failed to load requests: ${s.message}`),i.classList.add("hidden"),a.classList.remove("hidden"),n.style.display="none",!1}},window.renderRequestCard=function(e){if(!e)return"";const t=!1!==e.wasMatched,n=e.request?.clientIp||"Unknown",a={id:e.id||"",method:e.request?.method||"GET",url:e.request?.url||e.request?.urlPath||"N/A",status:e.responseDefinition?.status||(t?200:404),time:`${Utils.parseRequestTime(e.request.loggedDate)} <span class="request-ip">IP: ${Utils.escapeHtml(n)}</span>`,extras:{badges:`\n                ${t?`<span class="badge badge-success">${Icons.render("check-circle",{className:"badge-icon"})}<span>Matched</span></span>`:`<span class="badge badge-danger">${Icons.render("x-circle",{className:"badge-icon"})}<span>Unmatched</span></span>`}\n            `,preview:UIComponents.createPreviewSection(`${Icons.render("request-in",{className:"icon-inline"})} Request`,{Method:e.request?.method,URL:e.request?.url||e.request?.urlPath,"Client IP":n,Headers:e.request?.headers,Body:e.request?.body})+UIComponents.createPreviewSection(`${Icons.render("response-out",{className:"icon-inline"})} Response`,{Status:e.responseDefinition?.status,Matched:t?"Yes":"No",Headers:e.responseDefinition?.headers,Body:e.responseDefinition?.jsonBody||e.responseDefinition?.body})}};return UIComponents.createCard("request",a,[])},window.updateRequestsCounter=M,window.handleMappingTabClick=(e,t)=>{I(e);const n=document.getElementById("filter-method");n&&(n.value=t||"","function"==typeof applyFilters&&applyFilters())},window.handleRequestTabClick=(e,t)=>{I(e);const n=document.getElementById("req-filter-status");n&&(n.value=t||"","function"==typeof applyRequestFilters&&applyRequestFilters())},window.initializeFilterTabs=()=>{const e=document.getElementById("filter-method");e&&(e.addEventListener("change",()=>{R("mapping",e.value)}),R("mapping",e.value));const t=document.getElementById("req-filter-status");t&&(t.addEventListener("change",()=>{R("requests",t.value)}),R("requests",t.value)),updateMappingTabCounts(),T()},window.openEditModal=async e=>{if(!window.allMappings||!Array.isArray(window.allMappings))return void NotificationManager.show("Mappings are not loaded",NotificationManager.TYPES.ERROR);const t=e=>"string"==typeof e?e.trim():null==e?"":String(e).trim(),n=e=>e&&"object"==typeof e?[e.id,e.uuid,e.stubMappingId,e.stubId,e.mappingId,e.metadata?.id].map(t).filter(Boolean):[],a=t(e);let i=null;if(window.mappingIndex instanceof Map&&a&&(i=window.mappingIndex.get(a)||null),i||(i=window.allMappings.find(e=>n(e).includes(a))),!i)return void NotificationManager.show("Mapping not found",NotificationManager.TYPES.ERROR);"function"==typeof UIComponents?.clearCardState&&UIComponents.clearCardState("mapping","is-editing");const s=i?.id||a;if(s&&"function"==typeof UIComponents?.setCardState&&UIComponents.setCardState("mapping",s,"is-editing",!0),"function"!=typeof window.showModal)return;if(window.showModal("edit-mapping-modal"),"function"!=typeof window.populateEditMappingForm)return;window.populateEditMappingForm(i);try{"function"==typeof window.setMappingEditorBusyState&&window.setMappingEditorBusyState(!0,"Loading…");const e=t(i.id)||t(i.uuid)||a,s=await apiFetch(`/mappings/${encodeURIComponent(e)}`),o=s?.mapping||s;if(o&&o.id){window.populateEditMappingForm(o);const e=window.allMappings.findIndex(e=>e===i);if(-1!==e)window.allMappings[e]=o,addMappingToIndex(o);else{const e=window.allMappings.findIndex(e=>n(e).includes(a));-1!==e&&(window.allMappings[e]=o,addMappingToIndex(o))}}}catch(r){}finally{"function"==typeof window.setMappingEditorBusyState&&window.setMappingEditorBusyState(!1)}const o=document.getElementById(SELECTORS.MODAL.TITLE);o&&(o.textContent="Edit Mapping")},window.deleteMapping=async e=>{if(confirm("Delete this mapping?"))try{await apiFetch(`/mappings/${e}`,{method:"DELETE"}),NotificationManager.success("Mapping deleted!"),removeMappingFromIndex(e),updateOptimisticCache({id:e},"delete")}catch(t){t.message.includes("404")?(removeMappingFromIndex(e),updateOptimisticCache({id:e},"delete"),NotificationManager.success("Mapping was already deleted")):NotificationManager.error(`Delete failed: ${t.message}`)}},window.clearRequests=async()=>{if(confirm("Clear all requests?"))try{await apiFetch("/requests",{method:"DELETE"}),NotificationManager.success("Requests cleared!"),await fetchAndRenderRequests()}catch(e){NotificationManager.error(`Clear failed: ${e.message}`)}},Array.isArray(window.allScenarios)||(window.allScenarios=[]);let b=window.allScenarios,v=!1;window.scenarioExpansionState&&"object"==typeof window.scenarioExpansionState||(window.scenarioExpansionState={});let C=window.scenarioExpansionState;function N(e){if("string"!=typeof e)return"";const t=e.trim();if(!t)return"";if(!/%[0-9a-fA-F]{2}/.test(t))return t;try{return decodeURIComponent(t)}catch(n){return t}}function O(e){if("string"!=typeof e)return"";let t=e.trim();if(!t)return"";if(/^https?:\/\//i.test(t))try{t=new URL(t).pathname}catch(a){}const n="/__admin";return t.startsWith(n)&&(t=t.slice(8)||"/"),t=t.replace(/^\/+/,""),t?`/${t}`:""}function L(e){return Array.isArray(e)?e.map((e,t)=>function(e,t){if(!e||"object"!=typeof e)return null;const n="string"==typeof e.id?e.id:"",a="string"==typeof e.name?e.name:"",i=N(n),s=N(a),o=i||s||n||a||"",r=s||i||a||n||`Scenario ${t+1}`,c=N(e.state)||e.state||"Started",d=Array.isArray(e.possibleStates)?e.possibleStates.map(e=>N(e)||e).filter(Boolean):[],p=Array.isArray(e.mappings)?e.mappings.map(e=>e&&"object"==typeof e?{...e,requiredScenarioState:N(e.requiredScenarioState)||e.requiredScenarioState||"",newScenarioState:N(e.newScenarioState)||e.newScenarioState||""}:e):[],l=O(e.stateEndpoint||e?._links?.["update-state"]?.href||e?._links?.updateState?.href||e?._links?.state?.href),u=O(e.resetEndpoint||e?._links?.["reset-state"]?.href||e?._links?.resetState?.href||e?._links?.reset?.href);return{...e,id:o||i||n,name:r,displayName:r,identifier:o,originalId:n,originalName:a||s,decodedId:i,decodedName:s,state:c,possibleStates:d,mappings:p,stateEndpoint:l,resetEndpoint:u}}(e,t)).filter(Boolean):[]}function A(e){if("string"!=typeof e)return null;const t=e.trim();if(!t)return null;return(Array.isArray(b)?b:[]).find(e=>[e?.identifier,e?.id,e?.name,e?.decodedId,e?.decodedName,e?.originalId,e?.originalName].some(e=>"string"==typeof e&&e.trim()===t))||null}function $(e){const t=document.getElementById("scenarios-loading");if(t&&t.classList.toggle("hidden",!e),e){const e=document.getElementById(SELECTORS.LISTS.SCENARIOS);e&&(e.style.display="none")}}function D(e){const t=document.getElementById("scenario-state-options"),n=document.getElementById("scenario-state");if(!t)return;const a=Array.isArray(b)?b:[],i=A(e),s=new Set,o=e=>{if("string"!=typeof e)return;const t=e.trim();t&&s.add(t)};o("Started");const r=e=>{e&&(o(e.state),(e.possibleStates||[]).forEach(o),(e.mappings||[]).forEach(e=>{o(e?.requiredScenarioState),o(e?.newScenarioState)}))};i&&r(i),0===s.size&&a.forEach(r);const c=Array.from(s).sort((e,t)=>e.localeCompare(t));t.innerHTML=c.map(e=>`\n        <option value="${escapeHtml(e)}"></option>\n    `).join(""),n&&(c.length>0?n.setAttribute("placeholder",`Enter state (e.g. ${c[0]})`):n.setAttribute("placeholder","Enter state name"))}window.loadScenarios=async()=>{const e=document.getElementById("scenarios-empty");e&&e.classList.add("hidden"),$(!0);try{const e=await apiFetch(ENDPOINTS.SCENARIOS),t=Array.isArray(e?.scenarios)?e.scenarios:[];b=L(t),window.allScenarios=b}catch(t){b=[],window.allScenarios=b,NotificationManager.error(`Failed to load scenarios: ${t.message}`)}finally{$(!1),renderScenarios()}},window.refreshScenarios=async()=>{await TabManager.refresh("scenarios")},window.resetAllScenarios=async()=>{if(confirm("Reset all scenarios to the initial state?")){$(!0);try{await apiFetch(ENDPOINTS.SCENARIOS_RESET,{method:"POST"}),NotificationManager.success("All scenarios have been reset!"),await loadScenarios()}catch(e){NotificationManager.error(`Scenario reset failed: ${e.message}`),$(!1)}}},window.setScenarioState=async(e,t)=>{const n=document.getElementById("scenario-select"),a=document.getElementById("scenario-state"),i="string"==typeof e?e:"",s="string"==typeof t?t.trim():"";let o=i;!o&&n&&(o=n.value||"");const r=A(o),c=r?.identifier||r?.decodedId||r?.decodedName||o,d=N(c)||c,p=r?.displayName||r?.decodedName||r?.name||r?.decodedId||r?.id||N(o)||o,l=s||a?.value?.trim()||"";if(!d||!d.trim()||!l)return NotificationManager.warning("Please select scenario and enter state"),!1;const u="string"==typeof r?.stateEndpoint?r.stateEndpoint:"",m="function"==typeof window.buildScenarioStateEndpoint?window.buildScenarioStateEndpoint:e=>`${ENDPOINTS.SCENARIOS}/${encodeURIComponent(e)}/state`,g=u||(d?m(d):"");if(!g)return NotificationManager.error("Unable to determine the scenario state endpoint."),!1;if(r&&Array.isArray(r.possibleStates)&&0===r.possibleStates.length)return NotificationManager.warning(`Scenario "${p}" does not expose any states to switch to.`),!1;if(n){const e=r?.identifier||r?.decodedId||r?.decodedName||d;n.value=e,D(e)}else D(d);$(!0);const w=!!r;try{return await apiFetch(g,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:l})}),NotificationManager.success(`Scenario "${p}" switched to state "${l}"`),!s&&a&&(a.value=""),D(d),await loadScenarios(),!0}catch(f){const e=/HTTP\s+404/.test(f?.message||""),t=/does not support state/i.test(f?.message||"");return e&&!w?NotificationManager.error(`Scenario "${p}" was not found on the server.`):t?NotificationManager.error(`Scenario "${p}" does not allow state changes.`):NotificationManager.error(`Scenario state change failed: ${f.message}`),$(!1),!1}},window.renderScenarios=()=>{const e=document.getElementById(SELECTORS.LISTS.SCENARIOS),t=document.getElementById("scenarios-empty"),n=document.getElementById("scenarios-count"),a=document.getElementById("scenario-select"),i=document.getElementById("scenario-state-options");if(!e)return;n&&(n.textContent=Array.isArray(b)?b.length:0);const s=Array.isArray(b)?b:[];if(0===s.length)return e.innerHTML="",e.style.display="none",t&&t.classList.remove("hidden"),a&&(a.innerHTML='<option value="">Select Scenario</option>'),i&&(i.innerHTML=""),void D("");t&&t.classList.add("hidden");const o=a?.value||"";if(a){const e=['<option value="">Select Scenario</option>'].concat(s.map(e=>{const t="string"==typeof e?.identifier?e.identifier:"string"==typeof e?.decodedId?e.decodedId:"string"==typeof e?.id?e.id:"",n="string"==typeof e?.displayName?e.displayName:"string"==typeof e?.name?e.name:"string"==typeof e?.decodedName?e.decodedName:"Unnamed scenario";return`\n                <option value="${escapeHtml(t)}">${escapeHtml(n)}</option>\n            `}));if(a.innerHTML=e.join(""),o){const e=A(o);e&&(a.value=e.identifier||e.decodedId||e.decodedName||e.id||e.name||"")}}i&&D(a?.value||o||""),a&&!a.dataset.scenarioHandlerAttached&&(a.addEventListener("change",e=>{D(e.target.value)}),a.dataset.scenarioHandlerAttached="1"),e.style.display="",e.innerHTML=s.map((e,t)=>{const n="string"==typeof e?.identifier?e.identifier:"string"==typeof e?.decodedId?e.decodedId:"string"==typeof e?.id?e.id:"",a=escapeHtml(n),i="string"==typeof e?.displayName?e.displayName:"string"==typeof e?.name?e.name:"string"==typeof e?.decodedName?e.decodedName:"Unnamed scenario",s=escapeHtml(i),o=escapeHtml(e.state||"Started"),r=Array.isArray(e.possibleStates)?e.possibleStates.filter(Boolean):[],c=n||e?.decodedId||e?.decodedName||e?.id||e?.name||`scenario-${t}`,d="string"==typeof c&&c.trim()?c.trim():`scenario-${t}`;Object.prototype.hasOwnProperty.call(C,d)||(C[d]=!1);const p=!1!==C[d],l=escapeHtml(d),u="string"==typeof n&&n.trim().length>0,m=new Set,g=[],w=e=>{if("string"!=typeof e)return;const t=e.trim();t&&!m.has(t)&&(m.add(t),g.push(t))};w(e.state||""),r.forEach(w);const f=g.map(t=>{const n=escapeHtml(t),i="scenario-state-pill";return t===e.state?`<span class="${i} is-active" data-current="true">${n}</span>`:u?`\n                <button\n                    type="button"\n                    class="${i}"\n                    data-scenario-action="transition"\n                    data-scenario="${a}"\n                    data-state="${n}"\n                >\n                    ${n}\n                </button>\n            `:`<span class="${i}">${n}</span>`}).join(""),h=u?`\n            <button\n                type="button"\n                class="scenario-reset-btn"\n                data-scenario-action="reset"\n                data-scenario="${a}"\n            >\n                🔄 Reset\n            </button>\n        `:"",y=f||h?`\n            <div class="scenario-summary-controls">\n                <div class="scenario-state-pill-list">${f}</div>\n                ${h}\n            </div>\n        `:"",S=e.description?`\n            <div class="scenario-info">\n                <div class="scenario-description">${escapeHtml(e.description)}</div>\n            </div>\n        `:"",E=Array.isArray(e.mappings)?e.mappings:[],M=E.length?`\n            <ul class="scenario-mapping-list">\n                ${E.map(e=>{const t=e?.id||e?.uuid||e?.stubMappingId||e?.stubId||e?.mappingId||"",n=t?escapeHtml(t):"",a=escapeHtml(e?.name||t||"Unnamed mapping"),i=e?.request?.method||e?.method||e?.requestMethod||"",s=e?.request?.urlPattern||e?.request?.urlPath||e?.request?.url||e?.url||e?.requestUrl||"",o=i?`<span class="scenario-mapping-method">${escapeHtml(i)}</span>`:"",r=s?`<span class="scenario-mapping-url">${escapeHtml(s)}</span>`:"",c=o||r?`\n                        <div class="scenario-mapping-meta">\n                            ${[o,r].filter(Boolean).join(" · ")}\n                        </div>\n                    `:"",d=e?.requiredScenarioState||e?.requiredState||"",p=e?.newScenarioState||e?.newState||"",l=[d?`<span class="badge badge-warning" title="Required scenario state">Requires: ${escapeHtml(d)}</span>`:"",p?`<span class="badge badge-info" title="Next scenario state">→ ${escapeHtml(p)}</span>`:""].filter(Boolean).join(" ");return`\n                        <li class="scenario-mapping-item">\n                            <div class="scenario-mapping-name">${a}</div>\n                            ${c}\n                            ${l?`\n                        <div class="scenario-mapping-states">${l}</div>\n                    `:""}\n                            ${t?`\n                        <div class="scenario-mapping-actions">\n                            <button\n                                class="btn btn-sm btn-secondary"\n                                data-scenario-action="edit-mapping"\n                                data-mapping-id="${n}"\n                            >\n                                📝 Edit mapping\n                            </button>\n                        </div>\n                    `:""}\n                        </li>\n                    `}).join("")}\n            </ul>\n        `:'\n            <div class="scenario-mapping-empty">No stub mappings are bound to this scenario yet.</div>\n        ',T=p?"▾":"▸";return`\n            <div class="scenario-item ${p?"expanded":"collapsed"}" data-scenario="${a}" data-scenario-key="${l}">\n                <div class="scenario-summary">\n                    <button\n                        type="button"\n                        class="scenario-toggle-btn"\n                        data-scenario-action="toggle"\n                        data-scenario-key="${l}"\n                        aria-expanded="${p?"true":"false"}"\n                        aria-label="${escapeHtml(`${p?"Collapse":"Expand"} scenario ${i}`)}"\n                    >\n                        <span class="scenario-toggle-icon">${T}</span>\n                    </button>\n                    <div class="scenario-summary-main">\n                        <div class="scenario-summary-header">\n                            <div class="scenario-name">${s}</div>\n                            <div class="scenario-state">State: ${o}</div>\n                        </div>\n                        ${y}\n                    </div>\n                </div>\n                <div class="scenario-body">\n                    ${S}\n                    <div class="scenario-mappings">\n                        <div class="scenario-section-title">Stub mappings</div>\n                        ${M}\n                    </div>\n                </div>\n            </div>\n        `}).join(""),v||(e.addEventListener("click",async e=>{const t=e.target.closest("button[data-scenario-action]");if(!t)return;const n=t.dataset.scenarioAction;if("toggle"===n){e.preventDefault();const n=t.dataset.scenarioKey||t.dataset.scenario||"";if(!n.trim())return;const a=!1!==C[n];C[n]=!a,renderScenarios()}else if("transition"===n){const e=t.dataset.scenario||"",n=t.dataset.state||"";if(!e.trim()||!n.trim())return;t.disabled=!0;try{await setScenarioState(e,n)}finally{t.disabled=!1}}else if("reset"===n){const e=t.dataset.scenario||"";if(!e.trim())return;t.disabled=!0;try{await async function(e){if("string"!=typeof e||!e.trim())return NotificationManager.warning("Unable to determine which scenario to reset."),!1;const t=e.trim(),n=A(t);if(!n)return NotificationManager.error("Scenario not found. Please refresh the list."),!1;const a=n?.identifier||n?.decodedId||n?.decodedName||t,i=N(a)||a,s=n?.displayName||n?.decodedName||n?.name||n?.decodedId||n?.id||N(t)||t,o="string"==typeof n?.resetEndpoint?n.resetEndpoint:"",r="string"==typeof n?.stateEndpoint?n.stateEndpoint:"",c="function"==typeof window.buildScenarioStateEndpoint?window.buildScenarioStateEndpoint:e=>`${ENDPOINTS.SCENARIOS}/${encodeURIComponent(e)}/state`,d=o||r||(i?c(i):"");if(!d)return NotificationManager.error("Unable to determine the scenario reset endpoint."),!1;$(!0);try{const e=o?{method:"POST"}:{method:"PUT"};return await apiFetch(d,e),NotificationManager.success(`Scenario "${s}" has been reset to its initial state.`),await loadScenarios(),!0}catch(p){return NotificationManager.error(`Scenario reset failed: ${p.message}`),$(!1),!1}}(e)}finally{t.disabled=!1}}else if("edit-mapping"===n){const e=t.dataset.mappingId;e&&"function"==typeof window.openEditModal&&window.openEditModal(e)}}),v=!0)},window.startRecording=async(e={})=>{try{const t={...{targetBaseUrl:"https://example.com",filters:{urlPathPatterns:[".*"],method:"ANY",headers:{}},captureHeaders:{},requestBodyPattern:{},persist:!0,repeatsAsScenarios:!1,transformers:["response-template"],transformerParameters:{}},...e};await apiFetch(ENDPOINTS.RECORDINGS_START,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),NotificationManager.success("Recording started!"),window.isRecording=!0;const n=document.getElementById(SELECTORS.RECORDING.INDICATOR);n&&(n.style.display="block")}catch(t){NotificationManager.error(`Failed to start recording: ${t.message}`)}},window.stopRecording=async()=>{try{const e=await apiFetch(ENDPOINTS.RECORDINGS_STOP,{method:"POST"});window.isRecording=!1,window.recordedCount=0;const t=document.getElementById(SELECTORS.RECORDING.INDICATOR);t&&(t.style.display="none");const n=e.mappings?e.mappings.length:0;return NotificationManager.success(`Recording stopped! Captured ${n} mappings`),await fetchAndRenderMappings(),e.mappings||[]}catch(e){return NotificationManager.error(`Failed to stop recording: ${e.message}`),[]}},window.getRecordingStatus=async()=>{try{return(await apiFetch(ENDPOINTS.RECORDINGS_STATUS)).status||"Unknown"}catch(e){return"Unknown"}},window.takeRecordingSnapshot=async(e={})=>{try{const t=await apiFetch(ENDPOINTS.RECORDINGS_SNAPSHOT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=t.mappings?t.mappings.length:0;return NotificationManager.success(`Snapshot created! Captured ${n} mappings`),t.mappings||[]}catch(t){return NotificationManager.error(`Snapshot failed: ${t.message}`),[]}},window.clearRecordings=async()=>{if(confirm("Clear all recorded requests?"))try{await apiFetch(ENDPOINTS.REQUESTS,{method:"DELETE"}),window.recordedCount=0;const e=document.getElementById("recordings-list");e&&(e.innerHTML=""),"function"==typeof fetchAndRenderRequests&&await fetchAndRenderRequests(),NotificationManager.success("Recording log cleared.")}catch(e){NotificationManager.error(`Failed to clear recordings: ${e.message}`)}},window.clearFilters=()=>{window.clearMappingFilters()},window.refreshRequests=async()=>{await fetchAndRenderRequests();(document.getElementById(SELECTORS.REQUEST_FILTERS.METHOD)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.URL)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.STATUS)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO)?.value)&&FilterManager.applyRequestFilters()},window.applyQuickTimeFilter=()=>{const e=new Date,t=new Date(e.getTime()-864e5),n=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM),a=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO),i=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}T${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`;n&&(n.value=i(t)),a&&(a.value=i(e)),FilterManager.applyRequestFilters()},window.cleanupPendingDeletions=()=>{for(const[e,t]of window.deletionTimeouts)clearTimeout(t);window.deletionTimeouts.clear(),window.pendingDeletedIds.clear()},window.addEventListener("beforeunload",window.cleanupPendingDeletions),window.togglePreview=e=>{const t=document.getElementById(`preview-${e}`);"none"===t.style.display?t.style.display="block":t.style.display="none"},window.toggleRequestPreview=e=>{const t=document.getElementById(`request-preview-${e}`);"none"===t.style.display?t.style.display="block":t.style.display="none"},window.getRequestCount=async(e={})=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_COUNT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).count||0}catch(t){return NotificationManager.error(`Request count failed: ${t.message}`),0}},window.findRequests=async e=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_FIND,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).requests||[]}catch(t){return NotificationManager.error(`Request search failed: ${t.message}`),[]}},window.getUnmatchedRequests=async()=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_UNMATCHED)).requests||[]}catch(e){return[]}},window.findNearMissesForRequest=async e=>{try{return(await apiFetch(ENDPOINTS.NEAR_MISSES_REQUEST,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).nearMisses||[]}catch(t){return[]}},window.findNearMissesForPattern=async e=>{try{return(await apiFetch(ENDPOINTS.NEAR_MISSES_PATTERN,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).nearMisses||[]}catch(t){return[]}},window.getNearMissesForUnmatched=async()=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_UNMATCHED_NEAR_MISSES)).nearMisses||[]}catch(e){return[]}},window.getUnmatchedMappings=async()=>{try{return(await apiFetch(ENDPOINTS.MAPPINGS_UNMATCHED)).mappings||[]}catch(e){return[]}},window.removeUnmatchedMappings=async()=>{try{const e=await apiFetch(ENDPOINTS.MAPPINGS_UNMATCHED,{method:"DELETE"}),t=e.mappings?e.mappings.length:0;return NotificationManager.success(`Removed ${t} unused mappings`),await fetchAndRenderMappings(),e.mappings||[]}catch(e){return NotificationManager.error(`Failed to remove unused mappings: ${e.message}`),[]}},window.findMappingsByMetadata=async e=>{try{return(await apiFetch(ENDPOINTS.MAPPINGS_FIND_BY_METADATA,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).mappings||[]}catch(t){return[]}},window.handleEditSuccess=async e=>{const t=e.id||e.uuid;window.cacheManager.addOptimisticUpdate(e,"update"),window.applyOptimisticMappingUpdate(e),setTimeout(()=>{window.cacheManager.confirmOptimisticUpdate(t)},1e3)},window.updateLastSuccessUI=()=>{try{const e=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT);if(!e)return;const t=window.lastWiremockSuccess||Date.now(),n=new Date(t).toLocaleTimeString();e.textContent=`Last OK: ${n}`}catch(e){}},window.applyHealthUI=(e,t)=>{try{window.healthState=window.healthState||{isHealthy:null,lastCheckAt:null,lastOkAt:null,lastLatencyMs:null},window.healthState.lastCheckAt=Date.now(),!0===e?(window.healthState.isHealthy=!0,window.healthState.lastOkAt=Date.now(),window.healthState.lastLatencyMs="number"==typeof t?t:null):!1===e&&(window.healthState.isHealthy=!1,window.healthState.lastLatencyMs=null);const n=document.getElementById(SELECTORS.HEALTH.INDICATOR);if(n)if(n.style.display="inline",!0===e){const e="number"==typeof t?`${t}ms`:"OK";n.innerHTML=`<span>Response Time: </span><span class="healthy">${e}</span>`}else n.innerHTML=!1===e?'<span>Response Time: </span><span class="unhealthy">Unhealthy</span>':'<span>Response Time: </span><span class="error">Error</span>';!0===e&&(window.lastWiremockSuccess=Date.now(),"function"==typeof window.updateLastSuccessUI&&window.updateLastSuccessUI())}catch(n){}};try{const e=localStorage.getItem("imock-show-meta-timestamps");null!==e&&(window.showMetaTimestamps="1"===e)}catch{}window.toggleMetaTimestamps=()=>{try{window.showMetaTimestamps=!1===window.showMetaTimestamps,localStorage.setItem("imock-show-meta-timestamps",window.showMetaTimestamps?"1":"0"),Array.isArray(window.allMappings)&&fetchAndRenderMappings(window.allMappings)}catch(e){}};const F="00000000-0000-0000-0000-00000000cace";function q(e){try{const t=(e?.id||e?.uuid)===F,n="cache"===e?.metadata?.imock?.type,a="imock cache"===(e?.name||"").toLowerCase();return!!(t||n||a||"/__imock/cache"===(e?.request?.url||e?.request?.urlPath))}catch{return!1}}"undefined"!=typeof window&&(window.isImockCacheMapping=window.isImockCacheMapping||q),"undefined"!=typeof window&&(window.loadImockCacheBestOf3=window.loadImockCacheBestOf3||async function(){const e=await async function(){try{const e=await apiFetch(`/mappings/${F}`);if(e&&q(e))return e}catch{}return null}();if(e&&e.response?.jsonBody)return{source:"cache",data:e.response.jsonBody};const t=await async function(){try{const t=[{matchesJsonPath:"$[?(@.metadata.imock.type == 'cache')]"},{matchesJsonPath:{expression:"$[?(@.metadata.imock.type == 'cache')]"}}];for(const n of t)try{const e=await apiFetch(ENDPOINTS.MAPPINGS_FIND_BY_METADATA,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=(e?.mappings||e?.items||[]).find(q);if(t)return t}catch(e){}}catch{}return null}();return t&&t.response?.jsonBody?{source:"cache",data:t.response.jsonBody}:null},window.syncCacheWithMappings=window.syncCacheWithMappings||function(e){try{const t=window.cacheManager;if(!(t&&t.cache instanceof Map&&Array.isArray(e)))return;const n=t.cache,a=new Set;e.forEach(e=>{if(!e||q(e))return;const t=e.id||e.uuid;if(!t)return;a.add(t);const i=function(e){if(!e)return null;try{if("function"==typeof structuredClone)return structuredClone(e)}catch(t){}try{return JSON.parse(JSON.stringify(e))}catch(t){}return{...e}}(e)||{...e};var s,o;n.has(t)?n.set(t,(s=n.get(t),o=i,s?o?{...s,...o,request:{...s.request,...o.request},response:{...s.response,...o.response},metadata:{...s.metadata,...o.metadata}}:s:o)):n.set(t,i)});const i=Array.isArray(t.optimisticQueue)?t.optimisticQueue:[],s=new Set;for(const e of i)e&&"delete"!==e.op&&e.id&&s.add(e.id);Array.from(n.keys()).forEach(e=>{a.has(e)||s.has(e)||n.delete(e)}),window.cacheLastUpdate=Date.now()}catch(t){}}),Promise.resolve(),function(e){function t(e,t,n){return e&&"function"==typeof t?t.bind(e):e&&"function"==typeof n?n.bind(e):"function"==typeof n?n:e=>{}}e.DemoMode={createLoader:function(e={}){const{markDemoModeActive:n,notificationManager:a,fetchAndRenderMappings:i,fetchAndRenderRequests:s,isDatasetAvailable:o,getDataset:r}=e;if("function"!=typeof n)throw new Error("Demo loader requires markDemoModeActive callback");if(!a||"function"==typeof a)throw new Error("Demo loader requires a notification manager object");if("function"!=typeof i)throw new Error("Demo loader requires fetchAndRenderMappings function");if("function"!=typeof s)throw new Error("Demo loader requires fetchAndRenderRequests function");const c=t(a,a.success,a.info),d=t(a,a.error,a.warning),p=t(a,a.warning,a.info);return async function(){if(!("function"!=typeof o||o()))return d("Demo dataset is not available in this build."),{status:"unavailable",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};const e="function"==typeof r?r():null;if(!e)return d("Unable to load the demo dataset."),{status:"missing",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};const t=Array.isArray(e.mappings)?e.mappings:[],a=Array.isArray(e.requests)?e.requests:[];n("manual-trigger");const[l,u]=await Promise.allSettled([i(t,{source:"demo"}),s(a,{source:"demo"})]),m="fulfilled"===l.status&&!1!==l.value,g="fulfilled"===u.status&&!1!==u.value,w=[];"rejected"===l.status&&w.push(l.reason),"rejected"===u.status&&w.push(u.reason);const f=m&&g?"success":m||g?"partial":"failed";return"success"===f?c("Demo data loaded locally. Explore the interface freely."):(p("Demo data only loaded partially. Check the console for details."),w.length&&d("Some demo data failed to load. Inspect console for details.")),{status:f,mappingsLoaded:m,requestsLoaded:g,errors:w}}}}}("undefined"!=typeof window?window:globalThis),function(e){let t=!1;function n(n){if(t)return!0;if(!n)return!1;t=!0;const a=e,i=n,{markDemoModeActive:s,addMappingToIndex:o,rebuildMappingIndex:r,computeMappingTabTotals:c,refreshMappingTabSnapshot:d,computeRequestTabTotals:p,refreshRequestTabSnapshot:l,removeMappingFromIndex:u,fetchMappingsFromServer:m}=i;a.updateUptime=function(){if(!a.startTime)return;const e=Math.floor((Date.now()-a.startTime)/1e3),t=Math.floor(e/3600),n=Math.floor(e%3600/60),i=e%60,s=document.getElementById("uptime");s&&(s.textContent=t>0?`${t}h ${n}m ${i}s`:n>0?`${n}m ${i}s`:`${i}s`)},a.stopUptime=function(){a.uptimeInterval&&(a.LifecycleManager.clearInterval(a.uptimeInterval),a.uptimeInterval=null),a.startTime=null;const e=document.getElementById("uptime");e&&(e.textContent="0s")},a.checkHealth=async()=>{try{const e=document.getElementById("wiremock-host"),t=document.getElementById("wiremock-port");if(e&&t&&(e.value.trim()||t.value.trim())){const n=e.value.trim()||"localhost",i=t.value.trim()||"8080";"function"==typeof a.normalizeWiremockBaseUrl?a.wiremockBaseUrl=a.normalizeWiremockBaseUrl(n,i):a.wiremockBaseUrl=`http://${n}:${i}/__admin`}await checkHealthAndStartUptime(),NotificationManager.success("Health check passed!")}catch(e){NotificationManager.error(`Health check failed: ${e.message}`)}},a.refreshMappings=async()=>{try{"function"==typeof a.readWiremockSettings&&a.readWiremockSettings();const e=isCacheEnabled();await fetchAndRenderMappings(null,{useCache:e})&&NotificationManager.success("Mappings refreshed!")}catch(e){NotificationManager.error(`Failed to refresh mappings: ${e.message}`)}},a.forceRefreshCache=async()=>{try{if(!isCacheEnabled())return void NotificationManager.warning("Cache is not enabled. Enable it in Settings first.");if("function"!=typeof a.refreshImockCache)return void NotificationManager.error("Cache service not available");const e=document.querySelector('[onclick="forceRefreshCache()"]');e&&(e.classList.add("is-loading"),e.disabled=!0);const t=await a.refreshImockCache();let n=!0;t&&"object"==typeof t&&(t.cacheMessage&&w(SELECTORS.IMPORT.RESULT,"info",t.cacheMessage),"boolean"==typeof t.useCache&&(n=t.useCache));await fetchAndRenderMappings(null,{useCache:n})&&NotificationManager.success("Cache rebuilt and mappings refreshed!")}catch(e){NotificationManager.error(`Failed to rebuild cache: ${e.message}`)}finally{const e=document.querySelector('[onclick="forceRefreshCache()"]');e&&(e.classList.remove("is-loading"),e.disabled=!1)}};const g=a.DemoMode&&"function"==typeof a.DemoMode.createLoader?a.DemoMode.createLoader({markDemoModeActive:s,notificationManager:NotificationManager,fetchAndRenderMappings:fetchAndRenderMappings,fetchAndRenderRequests:fetchAndRenderRequests,isDatasetAvailable:()=>a.DemoData?.isAvailable?.(),getDataset:()=>a.DemoData?.getDataset?.()}):null;function w(e,t,n){const a=document.getElementById(e);if(!a)return;const i="success"===t?"✅":"error"===t?"❌":"ℹ️";a.textContent=`${i} ${n}`}function f(e,t,n){const a=new Blob([t],{type:n}),i=URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(i),0)}function h(e){const t=function(){if(a.elementCache?.has(SELECTORS.IMPORT.ACTIONS)){const e=a.elementCache.get(SELECTORS.IMPORT.ACTIONS);if(e){const t=e.querySelector("button");if(t)return t}}const e=document.getElementById(SELECTORS.IMPORT.ACTIONS);if(!e)return null;const t=e.querySelector("button");return t&&a.elementCache&&a.elementCache.set(SELECTORS.IMPORT.ACTIONS,e),t}();t&&(t.classList.toggle("is-loading",e),t.disabled=e)}function y(e){if(a.jsyaml?.dump)return a.jsyaml.dump(e,{noRefs:!0});if("function"==typeof convertJSONToYAML)return convertJSONToYAML(e);throw new Error("YAML serializer is not available.")}async function S(e=null){try{h(!0),w(SELECTORS.IMPORT.RESULT,"info","Processing import file...");const n=await async function(){const e=document.getElementById(SELECTORS.IMPORT.FILE);if(!e?.files?.length)throw new Error("Please select a file to import.");const t=e.files[0],n=await t.text(),i=t.name.split(".").pop()?.toLowerCase();if("yaml"===i||"yml"===i){if(a.jsyaml?.load)return a.jsyaml.load(n);throw new Error("YAML parser is not available.")}try{return JSON.parse(n)}catch(s){throw new Error("Failed to parse JSON import file.")}}(),i=function(e=null){if(e)return e;const t=document.getElementById(SELECTORS.IMPORT.MODE);return t&&t.value||"MERGE"}(e),s=function(e,t){if(!e||"object"!=typeof e)throw new Error("Import file is empty or malformed.");const n=JSON.parse(JSON.stringify(e)),a={};if(["meta","globalSettings","requestJournal","importSettings"].forEach(e=>{n&&Object.prototype.hasOwnProperty.call(n,e)&&(a[e]=n[e])}),Array.isArray(n))a.mappings=n;else if(Array.isArray(n.mappings))a.mappings=n.mappings;else if(n.mappings&&"object"==typeof n.mappings){if(Array.isArray(n.mappings.mappings))a.mappings=n.mappings.mappings;else if(Array.isArray(n.mappings.items))a.mappings=n.mappings.items;else{const e=Object.values(n.mappings).filter(Boolean).filter(e=>"object"==typeof e&&(e.request||e.response));e.length>0&&(a.mappings=e)}a.mappings||!n.mappings.request&&!n.mappings.response||(a.mappings=[n.mappings])}else n.mappings?a.mappings=[n.mappings]:Array.isArray(n.mapping)?a.mappings=n.mapping:n.mapping?a.mappings=[n.mapping]:Array.isArray(n.stubs)?a.mappings=n.stubs:n.stubs&&"object"==typeof n.stubs?a.mappings=Object.values(n.stubs).filter(Boolean):(n.request||n.response)&&(a.mappings=[n]);if(!Array.isArray(a.mappings))throw new Error("No mappings array found in the import file.");if(a.mappings=a.mappings.filter(Boolean),0===a.mappings.length)throw new Error("The import file does not contain any mappings.");Object.keys(n).forEach(e=>{["mappings","mapping","importMode"].includes(e)||Object.prototype.hasOwnProperty.call(a,e)||(a[e]=n[e])});const i=t||n.importMode||"MERGE";return a.importMode=i,a}(n,i);s.importMode=i,await apiFetch(ENDPOINTS.MAPPINGS_IMPORT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),NotificationManager.success(`Imported ${s.mappings.length} mapping(s).`);const o=document.getElementById(SELECTORS.IMPORT.FILE);o&&(o.value="",a.updateFileDisplay());try{await a.refreshMappings()}catch(t){}w(SELECTORS.IMPORT.RESULT,"success",`Imported ${s.mappings.length} mapping(s) using mode ${i}.`)}catch(n){throw w(SELECTORS.IMPORT.RESULT,"error",n.message||"Import failed."),NotificationManager.error(`Import failed: ${n.message}`),n}finally{h(!1)}}return a.loadMockData=async()=>{if(!g)return NotificationManager.error("Demo mode is not available in this build."),{status:"unavailable",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};a.demoModeLastError=null;const e=await g();if(e&&"success"!==e.status){const[t]=Array.isArray(e.errors)?e.errors:[];a.demoModeLastError=t||e.status}return a.demoModeLastResult=e,e},a.updateScenarioState=async()=>{const e=document.getElementById("scenario-select"),t=document.getElementById("scenario-state"),n=document.getElementById("scenario-update-btn");if(e?.value&&t?.value){n&&(n.disabled=!0);try{await a.setScenarioState()}finally{n&&(n.disabled=!1)}}else NotificationManager.warning("Please select scenario and enter state")},a.updateFileDisplay=()=>{const e=document.getElementById(SELECTORS.IMPORT.FILE),t=document.getElementById(SELECTORS.IMPORT.DISPLAY),n=document.getElementById(SELECTORS.IMPORT.ACTIONS);if(e&&t)if(e.files?.length>0){const a=e.files[0],i=a.size?` (${Math.round(a.size/1024)} KB)`:"";t.innerHTML=`<strong>${a.name}</strong>${i}`,n&&(n.style.display="block")}else t.innerHTML='<span class="file-placeholder">No file selected</span>',n&&(n.style.display="none")},a.updateRecorderLink=(e,t)=>{try{const n=document.getElementById("recorder-link");if(!n)return;const a=(e||"").trim();if(!a)return n.removeAttribute("href"),n.setAttribute("title","Configure host in Settings to enable recorder link"),void(n.textContent="Recorder UI (configure host first)");let i=a;/^https?:\/\//i.test(i)||(i=function(e){const t=e.trim();return t?/^https?:\/\//i.test(t)?t:`http://${t}`:"http://localhost"}(i));const s=new URL(i);t&&String(t).trim()&&(s.port=String(t).trim()),s.pathname="/__admin/recorder/",n.href=s.toString(),n.textContent=s.toString(),n.removeAttribute("title")}catch(n){}},a.executeImportFromUi=async()=>{try{await S()}catch(e){}},a.exportMappings=async()=>{const e=document.getElementById(SELECTORS.EXPORT.FORMAT),t=e?.value||"json";w(SELECTORS.EXPORT.RESULT,"info","Preparing mappings export...");try{const e=await apiFetch(ENDPOINTS.MAPPINGS),n=e?.mappings||[],a=`wiremock-mappings-${(new Date).toISOString().replace(/[:.]/g,"-")}`;if("yaml"===t){const e=y({mappings:n});f(`${a}.yaml`,e.endsWith("\n")?e:`${e}\n`,"text/yaml")}else{f(`${a}.json`,`${JSON.stringify({mappings:n},null,2)}\n`,"application/json")}w(SELECTORS.EXPORT.RESULT,"success",`Exported ${n.length} mapping(s) as ${t.toUpperCase()}.`),NotificationManager.success(`Exported ${n.length} mapping(s).`)}catch(n){w(SELECTORS.EXPORT.RESULT,"error",n.message||"Failed to export mappings."),NotificationManager.error(`Failed to export mappings: ${n.message}`)}},a.exportRequests=async()=>{const e=document.getElementById(SELECTORS.EXPORT.FORMAT),t=e?.value||"json";w(SELECTORS.EXPORT.RESULT,"info","Preparing request log export...");try{const e=await apiFetch(ENDPOINTS.REQUESTS),n=e?.requests||[],a=`wiremock-requests-${(new Date).toISOString().replace(/[:.]/g,"-")}`;if("yaml"===t){const e=y({requests:n});f(`${a}.yaml`,e.endsWith("\n")?e:`${e}\n`,"text/yaml")}else{f(`${a}.json`,`${JSON.stringify({requests:n},null,2)}\n`,"application/json")}w(SELECTORS.EXPORT.RESULT,"success",`Exported ${n.length} request(s) as ${t.toUpperCase()}.`),NotificationManager.success(`Exported ${n.length} request(s).`)}catch(n){w(SELECTORS.EXPORT.RESULT,"error",n.message||"Failed to export request log."),NotificationManager.error(`Failed to export request log: ${n.message}`)}},!0}if(!n(e.FeaturesState)){let t=null;const a=i=>!!n(i&&i.detail&&i.detail.state||e.FeaturesState)&&("function"==typeof e.removeEventListener&&e.removeEventListener("features:state-ready",a),null!==t&&(e.clearInterval(t),t=null),!0);if("function"==typeof e.addEventListener&&e.addEventListener("features:state-ready",a),"function"==typeof e.setInterval){let n=0;t=e.setInterval(()=>{n+=1,a()||n>=200&&(e.clearInterval(t),t=null,"undefined"!=typeof console&&console.error)},50)}}}("undefined"!=typeof window?window:globalThis);
