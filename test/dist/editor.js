"use strict";var an=n=>{throw TypeError(n)};var _t=(n,e,t)=>e.has(n)||an("Cannot "+t);var Le=(n,e,t)=>(_t(n,e,"read from private field"),t?t.call(n):e.get(n)),ht=(n,e,t)=>e.has(n)?an("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),gt=(n,e,t,i)=>(_t(n,e,"write to private field"),i?i.call(n,t):e.set(n,t),t),Rt=(n,e,t)=>(_t(n,e,"access private method"),t);var Ht,We,Ye,st,It,Ge,sn,cn,jt;class VirtualizedJSONRenderer{constructor(e){this.editor=e,this.fullContent="",this.isVirtualized=!1}setContent(e){typeof e!="string"&&(e=""),this.fullContent=e;const t=e.split(`
`).length;this.isVirtualized=!1,this.editor.getValue()!==e&&this.editor.setValue(e),t>5e3&&console.log(`\u{1F4C4} Loaded large document (${t} lines) without manual virtualization.`)}updateVisibleRange(){}getFullContent(){return this.isVirtualized?this.fullContent:this.editor.getValue()}dispose(){this.fullContent="",this.isVirtualized=!1}}class IndexedSearch{constructor(){this.keyIndex=new Map,this.valueIndex=new Map,this.lineIndex=[],this.isIndexed=!1,this.lastBuildTime=0}buildIndex(e){const t=performance.now(),i=e.split(`
`);this.keyIndex.clear(),this.valueIndex.clear(),this.lineIndex=[],i.forEach((r,o)=>{this.lineIndex.push(r);const s=r.trim(),c=s.match(/"([^"]+)":/);if(c){const d=c[1].toLowerCase();this.keyIndex.has(d)||this.keyIndex.set(d,[]),this.keyIndex.get(d).push({line:o,column:r.indexOf(c[0]),text:r,key:c[1]})}const l=s.match(/:\s*"([^"]+)"/);if(l){const d=l[1].toLowerCase();this.valueIndex.has(d)||this.valueIndex.set(d,[]),this.valueIndex.get(d).push({line:o,column:r.indexOf(l[1]),text:r,value:l[1]})}}),this.isIndexed=!0,this.lastBuildTime=performance.now()-t,console.log(`\u{1F50D} Search index built in ${this.lastBuildTime.toFixed(2)}ms for ${i.length} lines`)}searchKeys(e,t={}){if(!this.isIndexed)return[];const i=t.matchCase?e:e.toLowerCase(),r=[];for(const[o,s]of this.keyIndex)this.matches(o,i,t)&&r.push(...s.map(c=>({...c,type:"key"})));return r.slice(0,1e3)}searchValues(e,t={}){if(!this.isIndexed)return[];const i=t.matchCase?e:e.toLowerCase(),r=[];for(const[o,s]of this.valueIndex)this.matches(o,i,t)&&r.push(...s.map(c=>({...c,type:"value"})));return r.slice(0,1e3)}searchAll(e,t={}){const i=this.searchKeys(e,t),r=this.searchValues(e,t);return[...i,...r].sort((o,s)=>o.line-s.line).slice(0,1e3)}matches(e,t,i){return i.wholeWord?new RegExp(`\\b${this.escapeRegex(t)}\\b`,i.matchCase?"":"i").test(e):e.includes(t)}escapeRegex(e){return e.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}getStats(){return{indexed:this.isIndexed,keys:this.keyIndex.size,values:this.valueIndex.size,lines:this.lineIndex.length,buildTime:this.lastBuildTime}}clear(){this.keyIndex.clear(),this.valueIndex.clear(),this.lineIndex=[],this.isIndexed=!1,this.lastBuildTime=0}}class WorkerPool{constructor(e,t=4){if(this.workers=[],this.queue=[],this.busyWorkers=new Set,this.taskIdCounter=0,this.pendingTasks=new Map,location.protocol==="file:"){console.log("\u{1F6A7} Skipping worker pool creation due to file:// protocol limitations"),console.log("\u{1F465} Worker pool initialized with 0 workers (file:// mode)");return}for(let i=0;i<t;i++)try{const r=new Worker(e);r.id=i,r.onmessage=o=>this.handleMessage(r,o),r.onerror=o=>this.handleError(r,o),this.workers.push(r)}catch(r){console.warn(`Failed to create worker ${i}:`,r)}console.log(`\u{1F465} Worker pool initialized with ${this.workers.length} workers`)}execute(e,t,i=0,r=1e4){return new Promise((o,s)=>{const c=++this.taskIdCounter,l={id:c,operation:e,payload:t,resolve:o,reject:s,priority:i,timestamp:Date.now(),timeout:setTimeout(()=>{this.cancelTask(c,"timeout")},r)};this.pendingTasks.set(c,l);const d=this.getAvailableWorker();d?this.runTask(d,l):(this.queue.push(l),this.queue.sort((m,h)=>h.priority-m.priority))})}getAvailableWorker(){return this.workers.find(e=>!this.busyWorkers.has(e.id))}runTask(e,t){this.busyWorkers.add(e.id),e.currentTask=t,e.postMessage({type:t.operation,payload:t.payload,taskId:t.id})}handleMessage(e,t){const i=e.currentTask;i&&(clearTimeout(i.timeout),this.pendingTasks.delete(i.id),t.data.error?i.reject(new Error(t.data.error)):i.resolve(t.data.result||t.data)),this.releaseWorker(e)}handleError(e,t){const i=e.currentTask;i&&(clearTimeout(i.timeout),this.pendingTasks.delete(i.id),i.reject(t)),this.releaseWorker(e)}releaseWorker(e){if(this.busyWorkers.delete(e.id),e.currentTask=null,this.queue.length>0){const t=this.queue.shift();this.runTask(e,t)}}cancelTask(e,t="cancelled"){const i=this.pendingTasks.get(e);if(i){clearTimeout(i.timeout),this.pendingTasks.delete(e),i.reject(new Error(`Task ${t}`));const r=this.queue.findIndex(o=>o.id===e);r!==-1&&this.queue.splice(r,1)}}getStats(){return{workers:this.workers.length,busy:this.busyWorkers.size,queued:this.queue.length,pending:this.pendingTasks.size}}terminate(){for(const[e]of this.pendingTasks)this.cancelTask(e,"pool_terminated");this.workers.forEach(e=>e.terminate()),this.workers=[],this.queue=[],this.busyWorkers.clear(),this.pendingTasks.clear()}}class PerformanceController{constructor(){this.debounceTimers=new Map,this.throttleTimestamps=new Map,this.measurements=new Map}debounce(e,t,i){clearTimeout(this.debounceTimers.get(e)),this.debounceTimers.set(e,setTimeout(()=>{t(),this.debounceTimers.delete(e)},i))}throttle(e,t,i){const r=Date.now(),o=this.throttleTimestamps.get(e)||0;return r-o>=i?(this.throttleTimestamps.set(e,r),t(),!0):!1}measurePerformance(e,t){const i=performance.now(),r=t(),o=performance.now()-i;return this.measurements.has(e)||this.measurements.set(e,[]),this.measurements.get(e).push(o),o>100?console.warn(`\u{1F40C} Slow operation [${e}]: ${o.toFixed(2)}ms`):o>50&&console.log(`\u26A1 Operation [${e}]: ${o.toFixed(2)}ms`),r}async measureAsync(e,t){const i=performance.now(),r=await t(),o=performance.now()-i;return this.measurements.has(e)||this.measurements.set(e,[]),this.measurements.get(e).push(o),o>100&&console.warn(`\u{1F40C} Async operation [${e}]: ${o.toFixed(2)}ms`),r}getStats(e){const t=this.measurements.get(e);if(!t||t.length===0)return null;const i=[...t].sort((r,o)=>r-o);return{count:t.length,min:i[0],max:i[i.length-1],avg:t.reduce((r,o)=>r+o,0)/t.length,median:i[Math.floor(i.length/2)]}}clearStats(){this.measurements.clear()}}class ResultCache{constructor(e=100,t=3e5){this.cache=new Map,this.maxSize=e,this.ttl=t,this.hits=0,this.misses=0}generateKey(e,t){const i=this.simpleHash(t);return`${e}:${i}:${t.length}`}simpleHash(e){let t=0;for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);t=(t<<5)-t+r,t=t&t}return Math.abs(t).toString(36)}get(e,t){const i=this.generateKey(e,t),r=this.cache.get(i);return r&&Date.now()-r.timestamp<this.ttl?(this.hits++,r.result):(r&&this.cache.delete(i),this.misses++,null)}set(e,t,i){const r=this.generateKey(e,t);if(this.cache.size>=this.maxSize){const o=this.cache.keys().next().value;this.cache.delete(o)}this.cache.set(r,{result:i,timestamp:Date.now()})}clear(){this.cache.clear(),this.hits=0,this.misses=0}getStats(){const e=this.hits+this.misses;return{size:this.cache.size,maxSize:this.maxSize,hits:this.hits,misses:this.misses,hitRate:e>0?(this.hits/e*100).toFixed(1)+"%":"0%"}}}typeof window<"u"&&(window.VirtualizedJSONRenderer=VirtualizedJSONRenderer,window.IndexedSearch=IndexedSearch,window.WorkerPool=WorkerPool,window.PerformanceController=PerformanceController,window.ResultCache=ResultCache),typeof module<"u"&&module.exports&&(module.exports={VirtualizedJSONRenderer,IndexedSearch,WorkerPool,PerformanceController,ResultCache});const Logger=(function(){const n={DEBUG:0,INFO:1,WARN:2,ERROR:3,SILENT:4};let e=n.WARN;const t={API:"\u{1F517}",CACHE:"\u{1F9E9}",DEMO:"\u{1F9EA}",EDITOR:"\u{1F4DD}",EVENTS:"\u{1F4E2}",FEATURES:"\u{1F9E0}",FILTERS:"\u{1F50D}",HEALTH:"\u{1F493}",MANAGERS:"\u{1F9ED}",METADATA:"\u{1F4C5}",OPS:"\u{1F6E0}\uFE0F",OPTIMISTIC:"\u{1F3AF}",PAGINATION:"\u2194\uFE0F",QUERY:"\u2753",RECORDING:"\u23FA\uFE0F",REQUESTS:"\u{1F4E1}",SCENARIOS:"\u{1F3AC}",STATE:"\u{1F310}",STORE:"\u{1F5C2}\uFE0F",SYNC:"\u{1F504}",TEMPLATES:"\u{1F9FE}",UI:"\u{1F5A5}\uFE0F",DEFAULT:"\u{1F4CB}"};function i(){try{const c=localStorage.getItem("imock-log-level");c&&n[c.toUpperCase()]!==void 0&&(e=n[c.toUpperCase()])}catch{}}function r(c,...l){const d=t[c]||t.DEFAULT;return[`[${new Date().toISOString().substring(11,23)}] ${d} [${c}]`,...l]}function o(c){const l=(c||"").toUpperCase();if(n[l]!==void 0){e=n[l];try{localStorage.setItem("imock-log-level",l)}catch{}}}const s={LEVELS:n,setLevel:o,debug:(c,...l)=>{e<=n.DEBUG&&console.log(...r(c,...l))},info:(c,...l)=>{e<=n.INFO&&console.info(...r(c,...l))},warn:(c,...l)=>{e<=n.WARN&&console.warn(...r(c,...l))},error:(c,...l)=>{e<=n.ERROR&&console.error(...r(c,...l))},api:(...c)=>s.debug("API",...c),cache:(...c)=>s.debug("CACHE",...c),ui:(...c)=>s.debug("UI",...c)};return i(),s})();window.Logger=Logger;class MonacoLoader{static async load(){return Le(this,st)?(console.log("\u2705 [Monaco Lazy Loader] Already loaded"),Promise.resolve()):Le(this,We)?(console.log("\u23F3 [Monaco Lazy Loader] Already loading, returning existing promise"),Le(this,We)):(console.log("\u{1F680} [Monaco Lazy Loader] Starting lazy load..."),gt(this,Ye,!0),gt(this,We,Rt(this,Ge,sn).call(this).then(()=>{gt(this,st,!0),gt(this,Ye,!1),console.log("\u2705 [Monaco Lazy Loader] Monaco loaded successfully"),window.dispatchEvent(new CustomEvent("monaco:loaded"))}).catch(e=>{throw gt(this,Ye,!1),gt(this,We,null),console.error("\u274C [Monaco Lazy Loader] Failed to load Monaco:",e),e})),Le(this,We))}static prefetch(){Le(this,st)||Le(this,Ye)||(console.log("\u26A1 [Monaco Lazy Loader] Prefetching Monaco..."),this.load().catch(e=>{console.warn("\u26A0\uFE0F [Monaco Lazy Loader] Prefetch failed:",e)}))}static isLoaded(){return Le(this,st)}static isLoading(){return Le(this,Ye)}static getStatus(){return{isLoaded:Le(this,st),isLoading:Le(this,Ye),hasPromise:Le(this,We)!==null}}}Ht=new WeakMap,We=new WeakMap,Ye=new WeakMap,st=new WeakMap,It=new WeakMap,Ge=new WeakSet,sn=async function(){const e=Le(this,It)[0];try{return console.log(`\u{1F4E6} [Monaco Lazy Loader] Loading from ${e.label}...`),await Rt(this,Ge,jt).call(this,`${e.baseUrl}/loader.js`,"monaco-loader-script"),typeof window.require<"u"&&typeof window.require.config=="function"?window.require.config({paths:{vs:e.baseUrl}}):(window.require=window.require||{},window.require.paths=Object.assign({},window.require.paths||{},{vs:e.baseUrl})),new Promise((t,i)=>{const r=setTimeout(()=>{i(new Error("Monaco loading timeout (30s)"))},3e4);window.require(["vs/editor/editor.main"],()=>{clearTimeout(r),console.log("\u2705 [Monaco Lazy Loader] Monaco editor.main loaded"),t()},o=>{clearTimeout(r),console.error("\u274C [Monaco Lazy Loader] AMD require failed:",o),i(o)})})}catch(t){console.error(`\u274C [Monaco Lazy Loader] Primary source (${e.label}) failed:`,t);for(let i=1;i<Le(this,It).length;i++){const r=Le(this,It)[i];try{return console.log(`\u{1F504} [Monaco Lazy Loader] Trying fallback: ${r.label}...`),await Rt(this,Ge,cn).call(this,r)}catch(o){console.warn(`\u26A0\uFE0F [Monaco Lazy Loader] Fallback ${r.label} failed:`,o)}}throw new Error("All Monaco CDN sources failed")}},cn=async function(e){return await Rt(this,Ge,jt).call(this,`${e.baseUrl}/loader.js`,`monaco-loader-fallback-${e.label}`),typeof window.require<"u"&&typeof window.require.config=="function"?window.require.config({paths:{vs:e.baseUrl}}):window.require.paths=Object.assign({},window.require.paths||{},{vs:e.baseUrl}),new Promise((t,i)=>{const r=setTimeout(()=>{i(new Error(`Fallback ${e.label} timeout`))},3e4);window.require(["vs/editor/editor.main"],()=>{clearTimeout(r),t()},o=>{clearTimeout(r),i(o)})})},jt=function(e,t){return new Promise((i,r)=>{if(document.getElementById(t)){console.log(`\u2705 [Monaco Lazy Loader] Script ${t} already loaded`),i();return}const o=document.createElement("script");o.id=t,o.src=e,o.async=!1,o.onload=()=>{console.log(`\u2705 [Monaco Lazy Loader] Script loaded: ${e}`),i()},o.onerror=s=>{console.error(`\u274C [Monaco Lazy Loader] Script failed: ${e}`,s),document.head.removeChild(o),r(new Error(`Failed to load script: ${e}`))},document.head.appendChild(o)})},ht(MonacoLoader,Ge),ht(MonacoLoader,Ht,null),ht(MonacoLoader,We,null),ht(MonacoLoader,Ye,!1),ht(MonacoLoader,st,!1),ht(MonacoLoader,It,[{label:"jsDelivr",baseUrl:"https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs"},{label:"cdnjs",baseUrl:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs"},{label:"unpkg",baseUrl:"https://unpkg.com/monaco-editor@0.44.0/min/vs"}]),window.MonacoLoader=MonacoLoader,console.log("\u{1F4E6} Monaco Lazy Loader initialized"),console.log("\u{1F4A1} Usage: await MonacoLoader.load() or MonacoLoader.prefetch()"),(function(e){const t=[{id:"happy-get-resource",title:"GET Resource",description:"Return a resource by id with templated fields.",category:"happy-path",highlight:"GET \xB7 /api/resources/{id}",feature:{path:["response","jsonBody","id"],label:"response.jsonBody.id"},content:{request:{method:"GET",urlPathPattern:"/api/resources/[a-f0-9-]+"},response:{status:200,headers:{"Content-Type":"application/json"},jsonBody:{id:"{{request.pathSegments.[2]}}",name:"Example Resource",createdAt:"{{now}}"},transformers:["response-template"]}}},{id:"happy-post-create",title:"POST Create (201)",description:"Create a new resource with Location header.",category:"happy-path",highlight:"POST \xB7 /api/resources",feature:{path:["response","headers","Location"],label:"response.headers.Location"},popular:!0,content:{request:{method:"POST",urlPath:"/api/resources",headers:{"Content-Type":{equalTo:"application/json"}}},response:{status:201,headers:{"Content-Type":"application/json",Location:"/api/resources/{{randomValue type='UUID'}}"},jsonBody:{id:"{{randomValue type='UUID'}}",message:"Resource created"},transformers:["response-template"]}}},{id:"error-400-validation",title:"400 Bad Request",description:"Validation error example for POST payloads.",category:"errors",highlight:"POST \xB7 /api/resources \xB7 400",content:{request:{method:"POST",urlPath:"/api/resources",bodyPatterns:[{matchesJsonPath:"$[?(!@.name)]"}]},response:{status:400,jsonBody:{error:"Bad Request",details:[{field:"name",error:"required"}]}}}},{id:"error-401-unauthorized",title:"401 Unauthorized",description:"Missing or invalid auth header.",category:"errors",highlight:"ANY \xB7 /api/* \xB7 401",content:{request:{method:"ANY",urlPathPattern:"/api/.*",headers:{Authorization:{absent:!0}}},response:{status:401,headers:{"WWW-Authenticate":'Bearer realm="api"'},jsonBody:{error:"Unauthorized"}}}},{id:"error-404-not-found",title:"404 Not Found",description:"Simple not-found stub for missing resources.",category:"errors",highlight:"GET \xB7 /api/resources/non-existent",content:{request:{method:"GET",urlPath:"/api/resources/non-existent"},response:{status:404,jsonBody:{error:"Not Found"}}}},{id:"error-429-rate-limit",title:"429 Rate Limit",description:"Throttle response with retry guidance.",category:"errors",highlight:"ANY \xB7 429 Too Many Requests",popular:!0,content:{request:{method:"ANY",urlPattern:"/api/.*"},response:{status:429,headers:{"Retry-After":"60","X-RateLimit-Remaining":"0"},jsonBody:{error:"Too Many Requests"}}}},{id:"fault-fixed-delay",title:"Fixed Delay",description:"Deterministic slow response.",category:"faults",highlight:"GET \xB7 /api/slow \xB7 delay",feature:{path:["response","fixedDelayMilliseconds"],label:"response.fixedDelayMilliseconds"},content:{request:{method:"GET",urlPath:"/api/slow"},response:{status:200,fixedDelayMilliseconds:5e3,jsonBody:{message:"Delayed"}}}},{id:"fault-random-delay-uniform",title:"Random Delay (Uniform)",description:"Variable latency within bounds.",category:"faults",highlight:"ANY \xB7 delayDistribution.uniform",content:{request:{method:"GET",urlPath:"/api/variable-latency"},response:{status:200,delayDistribution:{type:"uniform",lower:500,upper:2e3}}}},{id:"fault-random-delay-lognormal",title:"Random Delay (Lognormal)",description:"Realistic latency distribution.",category:"faults",highlight:"ANY \xB7 delayDistribution.lognormal",content:{request:{method:"GET",urlPath:"/api/realistic-latency"},response:{status:200,delayDistribution:{type:"lognormal",median:100,sigma:.4}}}},{id:"fault-chunked-dribble",title:"Chunked Dribble",description:"Slow streaming response.",category:"faults",highlight:"GET \xB7 /api/slow-download",content:{request:{method:"GET",urlPath:"/api/slow-download"},response:{status:200,body:"Slow response...",chunkedDribbleDelay:{numberOfChunks:10,totalDuration:5e3}}}},{id:"fault-connection-reset",title:"Connection Reset",description:"Simulate TCP reset failure.",category:"faults",highlight:"GET \xB7 /api/reset \xB7 fault",popular:!0,content:{request:{method:"GET",urlPath:"/api/reset"},response:{fault:"CONNECTION_RESET_BY_PEER"}}},{id:"fault-empty-response",title:"Empty Response",description:"Return no body to mimic dropped payloads.",category:"faults",highlight:"ANY \xB7 fault: EMPTY_RESPONSE",content:{request:{method:"GET",urlPath:"/api/empty"},response:{status:200,fault:"EMPTY_RESPONSE"}}},{id:"fault-malformed-response",title:"Malformed Response",description:"Corrupted chunk fault.",category:"faults",highlight:"ANY \xB7 fault: MALFORMED_RESPONSE_CHUNK",content:{request:{method:"GET",urlPath:"/api/corrupt"},response:{status:200,fault:"MALFORMED_RESPONSE_CHUNK"}}},{id:"scenario-retry-500-200",title:"Retry: 500 \u2192 200",description:"First call fails, retry succeeds.",category:"scenarios",highlight:"Scenario \xB7 /api/flaky",popular:!0,content:{mappings:[{scenarioName:"Retry_Scenario",requiredScenarioState:"Started",newScenarioState:"Recovered",request:{method:"GET",urlPath:"/api/flaky"},response:{status:500,jsonBody:{error:"Temporary failure"}}},{scenarioName:"Retry_Scenario",requiredScenarioState:"Recovered",request:{method:"GET",urlPath:"/api/flaky"},response:{status:200,jsonBody:{message:"Success"}}}]}},{id:"scenario-todo-workflow",title:"Todo List Workflow",description:"Create \u2192 Read \u2192 Update lifecycle.",category:"scenarios",highlight:"Scenario \xB7 /todo/items",content:{mappings:[{scenarioName:"todo_list",requiredScenarioState:"Started",request:{method:"GET",url:"/todo/items"},response:{status:200,jsonBody:{items:["Buy milk"]}}},{scenarioName:"todo_list",requiredScenarioState:"Started",newScenarioState:"Item added",request:{method:"POST",url:"/todo/items",bodyPatterns:[{contains:"Cancel subscription"}]},response:{status:201}},{scenarioName:"todo_list",requiredScenarioState:"Item added",request:{method:"GET",url:"/todo/items"},response:{status:200,jsonBody:{items:["Buy milk","Cancel subscription"]}}}]}},{id:"scenario-order-lifecycle",title:"Order Lifecycle",description:"Order status across states.",category:"scenarios",highlight:"Scenario \xB7 /orders/123/status",content:{mappings:[{scenarioName:"Order_Status",requiredScenarioState:"Started",newScenarioState:"Processing",request:{method:"GET",urlPath:"/orders/123/status"},response:{status:200,jsonBody:{status:"pending"}}},{scenarioName:"Order_Status",requiredScenarioState:"Processing",newScenarioState:"Shipped",request:{method:"GET",urlPath:"/orders/123/status"},response:{status:200,jsonBody:{status:"processing"}}},{scenarioName:"Order_Status",requiredScenarioState:"Shipped",request:{method:"GET",urlPath:"/orders/123/status"},response:{status:200,jsonBody:{status:"shipped"}}}]}},{id:"dynamic-echo-request",title:"Echo Request",description:"Reflect request values in the response.",category:"dynamic",highlight:"ANY \xB7 /api/echo/*",feature:{path:["response","jsonBody","path"],label:"response.jsonBody.*"},popular:!0,content:{request:{method:"ANY",urlPathPattern:"/api/echo/.*"},response:{status:200,jsonBody:{path:"{{request.path}}",query:"{{request.query.q}}",header:"{{request.headers.X-Custom}}",timestamp:"{{now}}"},transformers:["response-template"]}}},{id:"dynamic-jsonpath-extract",title:"JSONPath Extract",description:"Use JSONPath to pull fields from the request body.",category:"dynamic",highlight:"POST \xB7 /api/process",content:{request:{method:"POST",urlPath:"/api/process"},response:{status:200,body:`{"name": "{{jsonPath request.body '$.name'}}"}`,transformers:["response-template"]}}},{id:"dynamic-random-values",title:"Random Values",description:"Generate UUIDs, codes, and numbers in the response.",category:"dynamic",highlight:"ANY \xB7 response-template random values",content:{request:{method:"GET",urlPath:"/api/generate"},response:{status:200,jsonBody:{uuid:"{{randomValue type='UUID'}}",code:"{{randomValue length=8 type='ALPHANUMERIC'}}",number:"{{randomInt lower=1 upper=100}}",type:"ORDER_ACCEPTED",orderId:"{{jsonPath request.body '$.orderId'}}",occurredAt:`{{now offset='0' pattern=\\"yyyy-MM-dd'T'HH:mm:ssXXX\\"}}`},transformers:["response-template"]}}},{id:"match-url-regex",title:"URL Pattern (Regex)",description:"Regex path matcher for numeric IDs.",category:"matching",highlight:"GET \xB7 /api/users/{id}/orders/{orderId}",content:{request:{method:"GET",urlPathPattern:"/api/users/[0-9]+/orders/[a-f0-9-]+"}}},{id:"match-query-params",title:"Query Parameters",description:"Match search params with combinations.",category:"matching",highlight:"GET \xB7 /api/search?q=\u2026",popular:!0,content:{request:{method:"GET",urlPath:"/api/search",queryParameters:{q:{matches:".+"},page:{equalTo:"1"},limit:{or:[{equalTo:"10"},{equalTo:"20"}]}}},response:{status:200}}},{id:"match-headers",title:"Headers",description:"Match requests by required headers.",category:"matching",highlight:"ANY \xB7 header matchers",content:{request:{method:"ANY",urlPath:"/api/data",headers:{Accept:{contains:"application/json"},Authorization:{matches:"Bearer .+"}}},response:{status:200}}},{id:"match-json-equal",title:"JSON Body (equalToJson)",description:"Semantic JSON comparison with json-unit helpers.",category:"matching",highlight:"POST \xB7 equalToJson",content:{request:{method:"POST",urlPath:"/api/orders",bodyPatterns:[{equalToJson:{customerId:"${json-unit.any-string}",total:"${json-unit.any-number}"},ignoreArrayOrder:!0,ignoreExtraElements:!0}]},response:{status:201}}},{id:"match-jsonpath",title:"JSONPath",description:"Multiple JSONPath checks in one stub.",category:"matching",highlight:"POST \xB7 matchesJsonPath",content:{request:{method:"POST",urlPath:"/api/events",bodyPatterns:[{matchesJsonPath:"$.type"},{matchesJsonPath:"$[?(@.priority > 5)]"},{matchesJsonPath:{expression:"$.email",contains:"@example.com"}}]},response:{status:200}}},{id:"match-basic-auth",title:"Basic Auth",description:"Protect endpoints with HTTP Basic Auth.",category:"matching",highlight:"ANY \xB7 basicAuthCredentials",content:{request:{method:"GET",urlPath:"/api/secure",basicAuthCredentials:{username:"admin",password:"secret"}},response:{status:200}}},{id:"webhook-simple",title:"Simple Webhook",description:"Send a POST callback after accepting a request.",category:"webhooks",highlight:"POST \xB7 /api/trigger \xB7 webhook",popular:!0,content:{request:{method:"POST",urlPath:"/api/trigger"},response:{status:202},serveEventListeners:[{name:"webhook",parameters:{method:"POST",url:"http://callback-service/webhook",headers:{"Content-Type":"application/json"},body:'{"status": "complete"}'}}]}},{id:"webhook-templated",title:"Templated Webhook",description:"Populate webhook payload from the original request.",category:"webhooks",highlight:"POST \xB7 templated callback",content:{request:{method:"POST",urlPath:"/api/orders"},response:{status:202},serveEventListeners:[{name:"webhook",parameters:{url:"{{jsonPath originalRequest.body '$.callbackUrl'}}",body:`{"orderId": "{{jsonPath originalRequest.body '$.orderId'}}"}`}}]}},{id:"webhook-delayed",title:"Delayed Webhook",description:"Schedule a callback after a fixed delay.",category:"webhooks",highlight:"POST \xB7 delay \u2192 webhook",content:{request:{method:"POST",urlPath:"/api/async-job"},response:{status:202},serveEventListeners:[{name:"webhook",parameters:{url:"http://service/callback",delay:{type:"fixed",milliseconds:5e3}}}]}},{id:"proxy-full",title:"Full Proxy",description:"Pass all traffic through to an upstream API.",category:"proxy",highlight:"ANY \xB7 /api/* \u2192 proxy",popular:!0,content:{priority:10,request:{method:"ANY",urlPattern:"/api/.*"},response:{status:200,proxyBaseUrl:"https://api.example.com"}}},{id:"proxy-override",title:"Proxy + Override",description:"Forward with extra headers or overrides.",category:"proxy",highlight:"ANY \xB7 proxy with headers",content:{priority:100,request:{method:"ANY",urlPattern:"/api/.*"},response:{status:200,proxyBaseUrl:"https://api.example.com",additionalProxyRequestHeaders:{"X-Forwarded-By":"WireMock"}}}},{id:"proxy-start-recording",title:"Start Recording",description:"Record traffic for snapshotting stubs.",category:"proxy",highlight:"ADMIN \xB7 recording",content:{request:{method:"POST",urlPath:"/__admin/recordings/start"},response:{status:200},targetBaseUrl:"https://api.example.com",captureHeaders:{Accept:{},Authorization:{caseInsensitive:!0}},requestBodyPattern:{matcher:"equalToJson",ignoreArrayOrder:!0},persist:!0,repeatsAsScenarios:!0}}];function i(s){return JSON.parse(JSON.stringify(s))}function r(s){if(!s||typeof s!="object")throw new Error("Template must be an object");if(!s.id)throw new Error("Template requires an id");return JSON.parse(JSON.stringify(s))}const o={getAll(){return t.map(i)},findById(s){return t.find(c=>c.id===s)||null},register(s){const c=r(s),l=t.findIndex(d=>d.id===c.id);return l>=0?t[l]=c:t.push(c),this.getAll()},replaceAll(s){if(!Array.isArray(s))throw new Error("replaceAll expects an array of templates");t.length=0;for(const c of s)t.push(JSON.parse(JSON.stringify(c)));return this.getAll()}};Object.freeze(o),e.MonacoTemplateLibrary||Object.defineProperty(e,"MonacoTemplateLibrary",{value:o,configurable:!1,enumerable:!0,writable:!1})})(typeof window<"u"?window:globalThis);/*! js-yaml 4.1.0 https://github.com/nodeca/js-yaml @license MIT */(function(n,e){typeof exports=="object"&&typeof module<"u"?e(exports):typeof define=="function"&&define.amd?define(["exports"],e):e((n=typeof globalThis<"u"?globalThis:n||self).jsyaml={})})(this,(function(n){"use strict";function e(a){return a==null}var t={isNothing:e,isObject:function(a){return typeof a=="object"&&a!==null},toArray:function(a){return Array.isArray(a)?a:e(a)?[]:[a]},repeat:function(a,p){var y,M="";for(y=0;y<p;y+=1)M+=a;return M},isNegativeZero:function(a){return a===0&&Number.NEGATIVE_INFINITY===1/a},extend:function(a,p){var y,M,b,R;if(p)for(y=0,M=(R=Object.keys(p)).length;y<M;y+=1)a[b=R[y]]=p[b];return a}};function i(a,p){var y="",M=a.reason||"(unknown reason)";return a.mark?(a.mark.name&&(y+='in "'+a.mark.name+'" '),y+="("+(a.mark.line+1)+":"+(a.mark.column+1)+")",!p&&a.mark.snippet&&(y+=`

`+a.mark.snippet),M+" "+y):M}function r(a,p){Error.call(this),this.name="YAMLException",this.reason=a,this.mark=p,this.message=i(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r.prototype.toString=function(a){return this.name+": "+i(this,a)};var o=r;function s(a,p,y,M,b){var R="",L="",P=Math.floor(b/2)-1;return M-p>P&&(p=M-P+(R=" ... ").length),y-M>P&&(y=M+P-(L=" ...").length),{str:R+a.slice(p,y).replace(/\t/g,"\u2192")+L,pos:M-p+R.length}}function c(a,p){return t.repeat(" ",p-a.length)+a}var l=function(a,p){if(p=Object.create(p||null),!a.buffer)return null;p.maxLength||(p.maxLength=79),typeof p.indent!="number"&&(p.indent=1),typeof p.linesBefore!="number"&&(p.linesBefore=3),typeof p.linesAfter!="number"&&(p.linesAfter=2);for(var y,M=/\r?\n|\r|\0/g,b=[0],R=[],L=-1;y=M.exec(a.buffer);)R.push(y.index),b.push(y.index+y[0].length),a.position<=y.index&&L<0&&(L=b.length-2);L<0&&(L=b.length-1);var P,$,z="",K=Math.min(a.line+p.linesAfter,R.length).toString().length,Z=p.maxLength-(p.indent+K+3);for(P=1;P<=p.linesBefore&&!(L-P<0);P++)$=s(a.buffer,b[L-P],R[L-P],a.position-(b[L]-b[L-P]),Z),z=t.repeat(" ",p.indent)+c((a.line-P+1).toString(),K)+" | "+$.str+`
`+z;for($=s(a.buffer,b[L],R[L],a.position,Z),z+=t.repeat(" ",p.indent)+c((a.line+1).toString(),K)+" | "+$.str+`
`,z+=t.repeat("-",p.indent+K+3+$.pos)+`^
`,P=1;P<=p.linesAfter&&!(L+P>=R.length);P++)$=s(a.buffer,b[L+P],R[L+P],a.position-(b[L]-b[L+P]),Z),z+=t.repeat(" ",p.indent)+c((a.line+P+1).toString(),K)+" | "+$.str+`
`;return z.replace(/\n$/,"")},d=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],m=["scalar","sequence","mapping"],h=function(a,p){if(p=p||{},Object.keys(p).forEach((function(y){if(d.indexOf(y)===-1)throw new o('Unknown option "'+y+'" is met in definition of "'+a+'" YAML type.')})),this.options=p,this.tag=a,this.kind=p.kind||null,this.resolve=p.resolve||function(){return!0},this.construct=p.construct||function(y){return y},this.instanceOf=p.instanceOf||null,this.predicate=p.predicate||null,this.represent=p.represent||null,this.representName=p.representName||null,this.defaultStyle=p.defaultStyle||null,this.multi=p.multi||!1,this.styleAliases=(function(y){var M={};return y!==null&&Object.keys(y).forEach((function(b){y[b].forEach((function(R){M[String(R)]=b}))})),M})(p.styleAliases||null),m.indexOf(this.kind)===-1)throw new o('Unknown kind "'+this.kind+'" is specified for "'+a+'" YAML type.')};function S(a,p){var y=[];return a[p].forEach((function(M){var b=y.length;y.forEach((function(R,L){R.tag===M.tag&&R.kind===M.kind&&R.multi===M.multi&&(b=L)})),y[b]=M})),y}function I(a){return this.extend(a)}I.prototype.extend=function(a){var p=[],y=[];if(a instanceof h)y.push(a);else if(Array.isArray(a))y=y.concat(a);else{if(!a||!Array.isArray(a.implicit)&&!Array.isArray(a.explicit))throw new o("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");a.implicit&&(p=p.concat(a.implicit)),a.explicit&&(y=y.concat(a.explicit))}p.forEach((function(b){if(!(b instanceof h))throw new o("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(b.loadKind&&b.loadKind!=="scalar")throw new o("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(b.multi)throw new o("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")})),y.forEach((function(b){if(!(b instanceof h))throw new o("Specified list of YAML types (or a single Type object) contains a non-Type object.")}));var M=Object.create(I.prototype);return M.implicit=(this.implicit||[]).concat(p),M.explicit=(this.explicit||[]).concat(y),M.compiledImplicit=S(M,"implicit"),M.compiledExplicit=S(M,"explicit"),M.compiledTypeMap=(function(){var b,R,L={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}};function P($){$.multi?(L.multi[$.kind].push($),L.multi.fallback.push($)):L[$.kind][$.tag]=L.fallback[$.tag]=$}for(b=0,R=arguments.length;b<R;b+=1)arguments[b].forEach(P);return L})(M.compiledImplicit,M.compiledExplicit),M};var T=I,v=new h("tag:yaml.org,2002:str",{kind:"scalar",construct:function(a){return a!==null?a:""}}),g=new h("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(a){return a!==null?a:[]}}),w=new h("tag:yaml.org,2002:map",{kind:"mapping",construct:function(a){return a!==null?a:{}}}),A=new T({explicit:[v,g,w]}),N=new h("tag:yaml.org,2002:null",{kind:"scalar",resolve:function(a){if(a===null)return!0;var p=a.length;return p===1&&a==="~"||p===4&&(a==="null"||a==="Null"||a==="NULL")},construct:function(){return null},predicate:function(a){return a===null},represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"}),D=new h("tag:yaml.org,2002:bool",{kind:"scalar",resolve:function(a){if(a===null)return!1;var p=a.length;return p===4&&(a==="true"||a==="True"||a==="TRUE")||p===5&&(a==="false"||a==="False"||a==="FALSE")},construct:function(a){return a==="true"||a==="True"||a==="TRUE"},predicate:function(a){return Object.prototype.toString.call(a)==="[object Boolean]"},represent:{lowercase:function(a){return a?"true":"false"},uppercase:function(a){return a?"TRUE":"FALSE"},camelcase:function(a){return a?"True":"False"}},defaultStyle:"lowercase"});function V(a){return 48<=a&&a<=55}function H(a){return 48<=a&&a<=57}var de=new h("tag:yaml.org,2002:int",{kind:"scalar",resolve:function(a){if(a===null)return!1;var p,y,M=a.length,b=0,R=!1;if(!M)return!1;if((p=a[b])!=="-"&&p!=="+"||(p=a[++b]),p==="0"){if(b+1===M)return!0;if((p=a[++b])==="b"){for(b++;b<M;b++)if((p=a[b])!=="_"){if(p!=="0"&&p!=="1")return!1;R=!0}return R&&p!=="_"}if(p==="x"){for(b++;b<M;b++)if((p=a[b])!=="_"){if(!(48<=(y=a.charCodeAt(b))&&y<=57||65<=y&&y<=70||97<=y&&y<=102))return!1;R=!0}return R&&p!=="_"}if(p==="o"){for(b++;b<M;b++)if((p=a[b])!=="_"){if(!V(a.charCodeAt(b)))return!1;R=!0}return R&&p!=="_"}}if(p==="_")return!1;for(;b<M;b++)if((p=a[b])!=="_"){if(!H(a.charCodeAt(b)))return!1;R=!0}return!(!R||p==="_")},construct:function(a){var p,y=a,M=1;if(y.indexOf("_")!==-1&&(y=y.replace(/_/g,"")),(p=y[0])!=="-"&&p!=="+"||(p==="-"&&(M=-1),p=(y=y.slice(1))[0]),y==="0")return 0;if(p==="0"){if(y[1]==="b")return M*parseInt(y.slice(2),2);if(y[1]==="x")return M*parseInt(y.slice(2),16);if(y[1]==="o")return M*parseInt(y.slice(2),8)}return M*parseInt(y,10)},predicate:function(a){return Object.prototype.toString.call(a)==="[object Number]"&&a%1==0&&!t.isNegativeZero(a)},represent:{binary:function(a){return a>=0?"0b"+a.toString(2):"-0b"+a.toString(2).slice(1)},octal:function(a){return a>=0?"0o"+a.toString(8):"-0o"+a.toString(8).slice(1)},decimal:function(a){return a.toString(10)},hexadecimal:function(a){return a>=0?"0x"+a.toString(16).toUpperCase():"-0x"+a.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),be=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$"),x=/^[-+]?[0-9]+e/,j=new h("tag:yaml.org,2002:float",{kind:"scalar",resolve:function(a){return a!==null&&!(!be.test(a)||a[a.length-1]==="_")},construct:function(a){var p,y;return y=(p=a.replace(/_/g,"").toLowerCase())[0]==="-"?-1:1,"+-".indexOf(p[0])>=0&&(p=p.slice(1)),p===".inf"?y===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:p===".nan"?NaN:y*parseFloat(p,10)},predicate:function(a){return Object.prototype.toString.call(a)==="[object Number]"&&(a%1!=0||t.isNegativeZero(a))},represent:function(a,p){var y;if(isNaN(a))switch(p){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===a)switch(p){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===a)switch(p){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(t.isNegativeZero(a))return"-0.0";return y=a.toString(10),x.test(y)?y.replace("e",".e"):y},defaultStyle:"lowercase"}),F=A.extend({implicit:[N,D,de,j]}),U=F,re=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),J=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$"),se=new h("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:function(a){return a!==null&&(re.exec(a)!==null||J.exec(a)!==null)},construct:function(a){var p,y,M,b,R,L,P,$,z=0,K=null;if((p=re.exec(a))===null&&(p=J.exec(a)),p===null)throw new Error("Date resolve error");if(y=+p[1],M=+p[2]-1,b=+p[3],!p[4])return new Date(Date.UTC(y,M,b));if(R=+p[4],L=+p[5],P=+p[6],p[7]){for(z=p[7].slice(0,3);z.length<3;)z+="0";z=+z}return p[9]&&(K=6e4*(60*+p[10]+ +(p[11]||0)),p[9]==="-"&&(K=-K)),$=new Date(Date.UTC(y,M,b,R,L,P,z)),K&&$.setTime($.getTime()-K),$},instanceOf:Date,represent:function(a){return a.toISOString()}}),ye=new h("tag:yaml.org,2002:merge",{kind:"scalar",resolve:function(a){return a==="<<"||a===null}}),we=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`,_e=new h("tag:yaml.org,2002:binary",{kind:"scalar",resolve:function(a){if(a===null)return!1;var p,y,M=0,b=a.length,R=we;for(y=0;y<b;y++)if(!((p=R.indexOf(a.charAt(y)))>64)){if(p<0)return!1;M+=6}return M%8==0},construct:function(a){var p,y,M=a.replace(/[\r\n=]/g,""),b=M.length,R=we,L=0,P=[];for(p=0;p<b;p++)p%4==0&&p&&(P.push(L>>16&255),P.push(L>>8&255),P.push(255&L)),L=L<<6|R.indexOf(M.charAt(p));return(y=b%4*6)===0?(P.push(L>>16&255),P.push(L>>8&255),P.push(255&L)):y===18?(P.push(L>>10&255),P.push(L>>2&255)):y===12&&P.push(L>>4&255),new Uint8Array(P)},predicate:function(a){return Object.prototype.toString.call(a)==="[object Uint8Array]"},represent:function(a){var p,y,M="",b=0,R=a.length,L=we;for(p=0;p<R;p++)p%3==0&&p&&(M+=L[b>>18&63],M+=L[b>>12&63],M+=L[b>>6&63],M+=L[63&b]),b=(b<<8)+a[p];return(y=R%3)===0?(M+=L[b>>18&63],M+=L[b>>12&63],M+=L[b>>6&63],M+=L[63&b]):y===2?(M+=L[b>>10&63],M+=L[b>>4&63],M+=L[b<<2&63],M+=L[64]):y===1&&(M+=L[b>>2&63],M+=L[b<<4&63],M+=L[64],M+=L[64]),M}}),je=Object.prototype.hasOwnProperty,ct=Object.prototype.toString,Ke=new h("tag:yaml.org,2002:omap",{kind:"sequence",resolve:function(a){if(a===null)return!0;var p,y,M,b,R,L=[],P=a;for(p=0,y=P.length;p<y;p+=1){if(M=P[p],R=!1,ct.call(M)!=="[object Object]")return!1;for(b in M)if(je.call(M,b)){if(R)return!1;R=!0}if(!R||L.indexOf(b)!==-1)return!1;L.push(b)}return!0},construct:function(a){return a!==null?a:[]}}),Ot=Object.prototype.toString,lt=new h("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:function(a){if(a===null)return!0;var p,y,M,b,R,L=a;for(R=new Array(L.length),p=0,y=L.length;p<y;p+=1){if(M=L[p],Ot.call(M)!=="[object Object]"||(b=Object.keys(M)).length!==1)return!1;R[p]=[b[0],M[b[0]]]}return!0},construct:function(a){if(a===null)return[];var p,y,M,b,R,L=a;for(R=new Array(L.length),p=0,y=L.length;p<y;p+=1)M=L[p],b=Object.keys(M),R[p]=[b[0],M[b[0]]];return R}}),vt=Object.prototype.hasOwnProperty,yt=new h("tag:yaml.org,2002:set",{kind:"mapping",resolve:function(a){if(a===null)return!0;var p,y=a;for(p in y)if(vt.call(y,p)&&y[p]!==null)return!1;return!0},construct:function(a){return a!==null?a:{}}}),dt=U.extend({implicit:[se,ye],explicit:[_e,Ke,lt,yt]}),oe=Object.prototype.hasOwnProperty,Ce=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Pe=/[\x85\u2028\u2029]/,He=/[,\[\]\{\}]/,Ve=/^(?:!|!!|![a-z\-]+!)$/i,ut=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function Qe(a){return Object.prototype.toString.call(a)}function ve(a){return a===10||a===13}function Fe(a){return a===9||a===32}function Ie(a){return a===9||a===32||a===10||a===13}function qe(a){return a===44||a===91||a===93||a===123||a===125}function Xe(a){var p;return 48<=a&&a<=57?a-48:97<=(p=32|a)&&p<=102?p-97+10:-1}function Ze(a){return a===48?"\0":a===97?"\x07":a===98?"\b":a===116||a===9?"	":a===110?`
`:a===118?"\v":a===102?"\f":a===114?"\r":a===101?"\x1B":a===32?" ":a===34?'"':a===47?"/":a===92?"\\":a===78?"\x85":a===95?"\xA0":a===76?"\u2028":a===80?"\u2029":""}function pt(a){return a<=65535?String.fromCharCode(a):String.fromCharCode(55296+(a-65536>>10),56320+(a-65536&1023))}for(var wt=new Array(256),St=new Array(256),Ue=0;Ue<256;Ue++)wt[Ue]=Ze(Ue)?1:0,St[Ue]=Ze(Ue);function Lt(a,p){this.input=a,this.filename=p.filename||null,this.schema=p.schema||dt,this.onWarning=p.onWarning||null,this.legacy=p.legacy||!1,this.json=p.json||!1,this.listener=p.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=a.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function Pt(a,p){var y={name:a.filename,buffer:a.input.slice(0,-1),position:a.position,line:a.line,column:a.position-a.lineStart};return y.snippet=l(y),new o(p,y)}function G(a,p){throw Pt(a,p)}function et(a,p){a.onWarning&&a.onWarning.call(null,Pt(a,p))}var bt={YAML:function(a,p,y){var M,b,R;a.version!==null&&G(a,"duplication of %YAML directive"),y.length!==1&&G(a,"YAML directive accepts exactly one argument"),(M=/^([0-9]+)\.([0-9]+)$/.exec(y[0]))===null&&G(a,"ill-formed argument of the YAML directive"),b=parseInt(M[1],10),R=parseInt(M[2],10),b!==1&&G(a,"unacceptable YAML version of the document"),a.version=y[0],a.checkLineBreaks=R<2,R!==1&&R!==2&&et(a,"unsupported YAML version of the document")},TAG:function(a,p,y){var M,b;y.length!==2&&G(a,"TAG directive accepts exactly two arguments"),M=y[0],b=y[1],Ve.test(M)||G(a,"ill-formed tag handle (first argument) of the TAG directive"),oe.call(a.tagMap,M)&&G(a,'there is a previously declared suffix for "'+M+'" tag handle'),ut.test(b)||G(a,"ill-formed tag prefix (second argument) of the TAG directive");try{b=decodeURIComponent(b)}catch{G(a,"tag prefix is malformed: "+b)}a.tagMap[M]=b}};function Be(a,p,y,M){var b,R,L,P;if(p<y){if(P=a.input.slice(p,y),M)for(b=0,R=P.length;b<R;b+=1)(L=P.charCodeAt(b))===9||32<=L&&L<=1114111||G(a,"expected valid JSON character");else Ce.test(P)&&G(a,"the stream contains non-printable characters");a.result+=P}}function Tt(a,p,y,M){var b,R,L,P;for(t.isObject(y)||G(a,"cannot merge mappings; the provided source object is unacceptable"),L=0,P=(b=Object.keys(y)).length;L<P;L+=1)R=b[L],oe.call(p,R)||(p[R]=y[R],M[R]=!0)}function tt(a,p,y,M,b,R,L,P,$){var z,K;if(Array.isArray(b))for(z=0,K=(b=Array.prototype.slice.call(b)).length;z<K;z+=1)Array.isArray(b[z])&&G(a,"nested arrays are not supported inside keys"),typeof b=="object"&&Qe(b[z])==="[object Object]"&&(b[z]="[object Object]");if(typeof b=="object"&&Qe(b)==="[object Object]"&&(b="[object Object]"),b=String(b),p===null&&(p={}),M==="tag:yaml.org,2002:merge")if(Array.isArray(R))for(z=0,K=R.length;z<K;z+=1)Tt(a,p,R[z],y);else Tt(a,p,R,y);else a.json||oe.call(y,b)||!oe.call(p,b)||(a.line=L||a.line,a.lineStart=P||a.lineStart,a.position=$||a.position,G(a,"duplicated mapping key")),b==="__proto__"?Object.defineProperty(p,b,{configurable:!0,enumerable:!0,writable:!0,value:R}):p[b]=R,delete y[b];return p}function nt(a){var p;(p=a.input.charCodeAt(a.position))===10?a.position++:p===13?(a.position++,a.input.charCodeAt(a.position)===10&&a.position++):G(a,"a line break is expected"),a.line+=1,a.lineStart=a.position,a.firstTabInLine=-1}function Ee(a,p,y){for(var M=0,b=a.input.charCodeAt(a.position);b!==0;){for(;Fe(b);)b===9&&a.firstTabInLine===-1&&(a.firstTabInLine=a.position),b=a.input.charCodeAt(++a.position);if(p&&b===35)do b=a.input.charCodeAt(++a.position);while(b!==10&&b!==13&&b!==0);if(!ve(b))break;for(nt(a),b=a.input.charCodeAt(a.position),M++,a.lineIndent=0;b===32;)a.lineIndent++,b=a.input.charCodeAt(++a.position)}return y!==-1&&M!==0&&a.lineIndent<y&&et(a,"deficient indentation"),M}function ft(a){var p,y=a.position;return!((p=a.input.charCodeAt(y))!==45&&p!==46||p!==a.input.charCodeAt(y+1)||p!==a.input.charCodeAt(y+2)||(y+=3,(p=a.input.charCodeAt(y))!==0&&!Ie(p)))}function Ct(a,p){p===1?a.result+=" ":p>1&&(a.result+=t.repeat(`
`,p-1))}function kt(a,p){var y,M,b=a.tag,R=a.anchor,L=[],P=!1;if(a.firstTabInLine!==-1)return!1;for(a.anchor!==null&&(a.anchorMap[a.anchor]=L),M=a.input.charCodeAt(a.position);M!==0&&(a.firstTabInLine!==-1&&(a.position=a.firstTabInLine,G(a,"tab characters must not be used in indentation")),M===45)&&Ie(a.input.charCodeAt(a.position+1));)if(P=!0,a.position++,Ee(a,!0,-1)&&a.lineIndent<=p)L.push(null),M=a.input.charCodeAt(a.position);else if(y=a.line,it(a,p,3,!1,!0),L.push(a.result),Ee(a,!0,-1),M=a.input.charCodeAt(a.position),(a.line===y||a.lineIndent>p)&&M!==0)G(a,"bad indentation of a sequence entry");else if(a.lineIndent<p)break;return!!P&&(a.tag=b,a.anchor=R,a.kind="sequence",a.result=L,!0)}function $t(a){var p,y,M,b,R=!1,L=!1;if((b=a.input.charCodeAt(a.position))!==33)return!1;if(a.tag!==null&&G(a,"duplication of a tag property"),(b=a.input.charCodeAt(++a.position))===60?(R=!0,b=a.input.charCodeAt(++a.position)):b===33?(L=!0,y="!!",b=a.input.charCodeAt(++a.position)):y="!",p=a.position,R){do b=a.input.charCodeAt(++a.position);while(b!==0&&b!==62);a.position<a.length?(M=a.input.slice(p,a.position),b=a.input.charCodeAt(++a.position)):G(a,"unexpected end of the stream within a verbatim tag")}else{for(;b!==0&&!Ie(b);)b===33&&(L?G(a,"tag suffix cannot contain exclamation marks"):(y=a.input.slice(p-1,a.position+1),Ve.test(y)||G(a,"named tag handle cannot contain such characters"),L=!0,p=a.position+1)),b=a.input.charCodeAt(++a.position);M=a.input.slice(p,a.position),He.test(M)&&G(a,"tag suffix cannot contain flow indicator characters")}M&&!ut.test(M)&&G(a,"tag name cannot contain such characters: "+M);try{M=decodeURIComponent(M)}catch{G(a,"tag name is malformed: "+M)}return R?a.tag=M:oe.call(a.tagMap,y)?a.tag=a.tagMap[y]+M:y==="!"?a.tag="!"+M:y==="!!"?a.tag="tag:yaml.org,2002:"+M:G(a,'undeclared tag handle "'+y+'"'),!0}function xt(a){var p,y;if((y=a.input.charCodeAt(a.position))!==38)return!1;for(a.anchor!==null&&G(a,"duplication of an anchor property"),y=a.input.charCodeAt(++a.position),p=a.position;y!==0&&!Ie(y)&&!qe(y);)y=a.input.charCodeAt(++a.position);return a.position===p&&G(a,"name of an anchor node must contain at least one character"),a.anchor=a.input.slice(p,a.position),!0}function it(a,p,y,M,b){var R,L,P,$,z,K,Z,Se,W,me=1,fe=!1,he=!1;if(a.listener!==null&&a.listener("open",a),a.tag=null,a.anchor=null,a.kind=null,a.result=null,R=L=P=y===4||y===3,M&&Ee(a,!0,-1)&&(fe=!0,a.lineIndent>p?me=1:a.lineIndent===p?me=0:a.lineIndent<p&&(me=-1)),me===1)for(;$t(a)||xt(a);)Ee(a,!0,-1)?(fe=!0,P=R,a.lineIndent>p?me=1:a.lineIndent===p?me=0:a.lineIndent<p&&(me=-1)):P=!1;if(P&&(P=fe||b),me!==1&&y!==4||(Se=y===1||y===2?p:p+1,W=a.position-a.lineStart,me===1?P&&(kt(a,W)||(function(f,te,ee){var Q,ae,Y,ue,ce,pe,ge,ie=f.tag,Me=f.anchor,Ae={},Ne=Object.create(null),xe=null,De=null,mt=null,ke=!1,Mt=!1;if(f.firstTabInLine!==-1)return!1;for(f.anchor!==null&&(f.anchorMap[f.anchor]=Ae),ge=f.input.charCodeAt(f.position);ge!==0;){if(ke||f.firstTabInLine===-1||(f.position=f.firstTabInLine,G(f,"tab characters must not be used in indentation")),Q=f.input.charCodeAt(f.position+1),Y=f.line,ge!==63&&ge!==58||!Ie(Q)){if(ue=f.line,ce=f.lineStart,pe=f.position,!it(f,ee,2,!1,!0))break;if(f.line===Y){for(ge=f.input.charCodeAt(f.position);Fe(ge);)ge=f.input.charCodeAt(++f.position);if(ge===58)Ie(ge=f.input.charCodeAt(++f.position))||G(f,"a whitespace character is expected after the key-value separator within a block mapping"),ke&&(tt(f,Ae,Ne,xe,De,null,ue,ce,pe),xe=De=mt=null),Mt=!0,ke=!1,ae=!1,xe=f.tag,De=f.result;else{if(!Mt)return f.tag=ie,f.anchor=Me,!0;G(f,"can not read an implicit mapping pair; a colon is missed")}}else{if(!Mt)return f.tag=ie,f.anchor=Me,!0;G(f,"can not read a block mapping entry; a multiline key may not be an implicit key")}}else ge===63?(ke&&(tt(f,Ae,Ne,xe,De,null,ue,ce,pe),xe=De=mt=null),Mt=!0,ke=!0,ae=!0):ke?(ke=!1,ae=!0):G(f,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),f.position+=1,ge=Q;if((f.line===Y||f.lineIndent>te)&&(ke&&(ue=f.line,ce=f.lineStart,pe=f.position),it(f,te,4,!0,ae)&&(ke?De=f.result:mt=f.result),ke||(tt(f,Ae,Ne,xe,De,mt,ue,ce,pe),xe=De=mt=null),Ee(f,!0,-1),ge=f.input.charCodeAt(f.position)),(f.line===Y||f.lineIndent>te)&&ge!==0)G(f,"bad indentation of a mapping entry");else if(f.lineIndent<te)break}return ke&&tt(f,Ae,Ne,xe,De,null,ue,ce,pe),Mt&&(f.tag=ie,f.anchor=Me,f.kind="mapping",f.result=Ae),Mt})(a,W,Se))||(function(f,te){var ee,Q,ae,Y,ue,ce,pe,ge,ie,Me,Ae,Ne,xe=!0,De=f.tag,mt=f.anchor,ke=Object.create(null);if((Ne=f.input.charCodeAt(f.position))===91)ue=93,ge=!1,Y=[];else{if(Ne!==123)return!1;ue=125,ge=!0,Y={}}for(f.anchor!==null&&(f.anchorMap[f.anchor]=Y),Ne=f.input.charCodeAt(++f.position);Ne!==0;){if(Ee(f,!0,te),(Ne=f.input.charCodeAt(f.position))===ue)return f.position++,f.tag=De,f.anchor=mt,f.kind=ge?"mapping":"sequence",f.result=Y,!0;xe?Ne===44&&G(f,"expected the node content, but found ','"):G(f,"missed comma between flow collection entries"),Ae=null,ce=pe=!1,Ne===63&&Ie(f.input.charCodeAt(f.position+1))&&(ce=pe=!0,f.position++,Ee(f,!0,te)),ee=f.line,Q=f.lineStart,ae=f.position,it(f,te,1,!1,!0),Me=f.tag,ie=f.result,Ee(f,!0,te),Ne=f.input.charCodeAt(f.position),!pe&&f.line!==ee||Ne!==58||(ce=!0,Ne=f.input.charCodeAt(++f.position),Ee(f,!0,te),it(f,te,1,!1,!0),Ae=f.result),ge?tt(f,Y,ke,Me,ie,Ae,ee,Q,ae):ce?Y.push(tt(f,null,ke,Me,ie,Ae,ee,Q,ae)):Y.push(ie),Ee(f,!0,te),(Ne=f.input.charCodeAt(f.position))===44?(xe=!0,Ne=f.input.charCodeAt(++f.position)):xe=!1}G(f,"unexpected end of the stream within a flow collection")})(a,Se)?he=!0:(L&&(function(f,te){var ee,Q,ae,Y,ue,ce=1,pe=!1,ge=!1,ie=te,Me=0,Ae=!1;if((Y=f.input.charCodeAt(f.position))===124)Q=!1;else{if(Y!==62)return!1;Q=!0}for(f.kind="scalar",f.result="";Y!==0;)if((Y=f.input.charCodeAt(++f.position))===43||Y===45)ce===1?ce=Y===43?3:2:G(f,"repeat of a chomping mode identifier");else{if(!((ae=48<=(ue=Y)&&ue<=57?ue-48:-1)>=0))break;ae===0?G(f,"bad explicit indentation width of a block scalar; it cannot be less than one"):ge?G(f,"repeat of an indentation width identifier"):(ie=te+ae-1,ge=!0)}if(Fe(Y)){do Y=f.input.charCodeAt(++f.position);while(Fe(Y));if(Y===35)do Y=f.input.charCodeAt(++f.position);while(!ve(Y)&&Y!==0)}for(;Y!==0;){for(nt(f),f.lineIndent=0,Y=f.input.charCodeAt(f.position);(!ge||f.lineIndent<ie)&&Y===32;)f.lineIndent++,Y=f.input.charCodeAt(++f.position);if(!ge&&f.lineIndent>ie&&(ie=f.lineIndent),ve(Y))Me++;else{if(f.lineIndent<ie){ce===3?f.result+=t.repeat(`
`,pe?1+Me:Me):ce===1&&pe&&(f.result+=`
`);break}for(Q?Fe(Y)?(Ae=!0,f.result+=t.repeat(`
`,pe?1+Me:Me)):Ae?(Ae=!1,f.result+=t.repeat(`
`,Me+1)):Me===0?pe&&(f.result+=" "):f.result+=t.repeat(`
`,Me):f.result+=t.repeat(`
`,pe?1+Me:Me),pe=!0,ge=!0,Me=0,ee=f.position;!ve(Y)&&Y!==0;)Y=f.input.charCodeAt(++f.position);Be(f,ee,f.position,!1)}}return!0})(a,Se)||(function(f,te){var ee,Q,ae;if((ee=f.input.charCodeAt(f.position))!==39)return!1;for(f.kind="scalar",f.result="",f.position++,Q=ae=f.position;(ee=f.input.charCodeAt(f.position))!==0;)if(ee===39){if(Be(f,Q,f.position,!0),(ee=f.input.charCodeAt(++f.position))!==39)return!0;Q=f.position,f.position++,ae=f.position}else ve(ee)?(Be(f,Q,ae,!0),Ct(f,Ee(f,!1,te)),Q=ae=f.position):f.position===f.lineStart&&ft(f)?G(f,"unexpected end of the document within a single quoted scalar"):(f.position++,ae=f.position);G(f,"unexpected end of the stream within a single quoted scalar")})(a,Se)||(function(f,te){var ee,Q,ae,Y,ue,ce,pe;if((ce=f.input.charCodeAt(f.position))!==34)return!1;for(f.kind="scalar",f.result="",f.position++,ee=Q=f.position;(ce=f.input.charCodeAt(f.position))!==0;){if(ce===34)return Be(f,ee,f.position,!0),f.position++,!0;if(ce===92){if(Be(f,ee,f.position,!0),ve(ce=f.input.charCodeAt(++f.position)))Ee(f,!1,te);else if(ce<256&&wt[ce])f.result+=St[ce],f.position++;else if((ue=(pe=ce)===120?2:pe===117?4:pe===85?8:0)>0){for(ae=ue,Y=0;ae>0;ae--)(ue=Xe(ce=f.input.charCodeAt(++f.position)))>=0?Y=(Y<<4)+ue:G(f,"expected hexadecimal character");f.result+=pt(Y),f.position++}else G(f,"unknown escape sequence");ee=Q=f.position}else ve(ce)?(Be(f,ee,Q,!0),Ct(f,Ee(f,!1,te)),ee=Q=f.position):f.position===f.lineStart&&ft(f)?G(f,"unexpected end of the document within a double quoted scalar"):(f.position++,Q=f.position)}G(f,"unexpected end of the stream within a double quoted scalar")})(a,Se)?he=!0:(function(f){var te,ee,Q;if((Q=f.input.charCodeAt(f.position))!==42)return!1;for(Q=f.input.charCodeAt(++f.position),te=f.position;Q!==0&&!Ie(Q)&&!qe(Q);)Q=f.input.charCodeAt(++f.position);return f.position===te&&G(f,"name of an alias node must contain at least one character"),ee=f.input.slice(te,f.position),oe.call(f.anchorMap,ee)||G(f,'unidentified alias "'+ee+'"'),f.result=f.anchorMap[ee],Ee(f,!0,-1),!0})(a)?(he=!0,a.tag===null&&a.anchor===null||G(a,"alias node should not have any properties")):(function(f,te,ee){var Q,ae,Y,ue,ce,pe,ge,ie,Me=f.kind,Ae=f.result;if(Ie(ie=f.input.charCodeAt(f.position))||qe(ie)||ie===35||ie===38||ie===42||ie===33||ie===124||ie===62||ie===39||ie===34||ie===37||ie===64||ie===96||(ie===63||ie===45)&&(Ie(Q=f.input.charCodeAt(f.position+1))||ee&&qe(Q)))return!1;for(f.kind="scalar",f.result="",ae=Y=f.position,ue=!1;ie!==0;){if(ie===58){if(Ie(Q=f.input.charCodeAt(f.position+1))||ee&&qe(Q))break}else if(ie===35){if(Ie(f.input.charCodeAt(f.position-1)))break}else{if(f.position===f.lineStart&&ft(f)||ee&&qe(ie))break;if(ve(ie)){if(ce=f.line,pe=f.lineStart,ge=f.lineIndent,Ee(f,!1,-1),f.lineIndent>=te){ue=!0,ie=f.input.charCodeAt(f.position);continue}f.position=Y,f.line=ce,f.lineStart=pe,f.lineIndent=ge;break}}ue&&(Be(f,ae,Y,!1),Ct(f,f.line-ce),ae=Y=f.position,ue=!1),Fe(ie)||(Y=f.position+1),ie=f.input.charCodeAt(++f.position)}return Be(f,ae,Y,!1),!!f.result||(f.kind=Me,f.result=Ae,!1)})(a,Se,y===1)&&(he=!0,a.tag===null&&(a.tag="?")),a.anchor!==null&&(a.anchorMap[a.anchor]=a.result)):me===0&&(he=P&&kt(a,W))),a.tag===null)a.anchor!==null&&(a.anchorMap[a.anchor]=a.result);else if(a.tag==="?"){for(a.result!==null&&a.kind!=="scalar"&&G(a,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+a.kind+'"'),$=0,z=a.implicitTypes.length;$<z;$+=1)if((Z=a.implicitTypes[$]).resolve(a.result)){a.result=Z.construct(a.result),a.tag=Z.tag,a.anchor!==null&&(a.anchorMap[a.anchor]=a.result);break}}else if(a.tag!=="!"){if(oe.call(a.typeMap[a.kind||"fallback"],a.tag))Z=a.typeMap[a.kind||"fallback"][a.tag];else for(Z=null,$=0,z=(K=a.typeMap.multi[a.kind||"fallback"]).length;$<z;$+=1)if(a.tag.slice(0,K[$].tag.length)===K[$].tag){Z=K[$];break}Z||G(a,"unknown tag !<"+a.tag+">"),a.result!==null&&Z.kind!==a.kind&&G(a,"unacceptable node kind for !<"+a.tag+'> tag; it should be "'+Z.kind+'", not "'+a.kind+'"'),Z.resolve(a.result,a.tag)?(a.result=Z.construct(a.result,a.tag),a.anchor!==null&&(a.anchorMap[a.anchor]=a.result)):G(a,"cannot resolve a node with !<"+a.tag+"> explicit tag")}return a.listener!==null&&a.listener("close",a),a.tag!==null||a.anchor!==null||he}function Dt(a){var p,y,M,b,R=a.position,L=!1;for(a.version=null,a.checkLineBreaks=a.legacy,a.tagMap=Object.create(null),a.anchorMap=Object.create(null);(b=a.input.charCodeAt(a.position))!==0&&(Ee(a,!0,-1),b=a.input.charCodeAt(a.position),!(a.lineIndent>0||b!==37));){for(L=!0,b=a.input.charCodeAt(++a.position),p=a.position;b!==0&&!Ie(b);)b=a.input.charCodeAt(++a.position);for(M=[],(y=a.input.slice(p,a.position)).length<1&&G(a,"directive name must not be less than one character in length");b!==0;){for(;Fe(b);)b=a.input.charCodeAt(++a.position);if(b===35){do b=a.input.charCodeAt(++a.position);while(b!==0&&!ve(b));break}if(ve(b))break;for(p=a.position;b!==0&&!Ie(b);)b=a.input.charCodeAt(++a.position);M.push(a.input.slice(p,a.position))}b!==0&&nt(a),oe.call(bt,y)?bt[y](a,y,M):et(a,'unknown document directive "'+y+'"')}Ee(a,!0,-1),a.lineIndent===0&&a.input.charCodeAt(a.position)===45&&a.input.charCodeAt(a.position+1)===45&&a.input.charCodeAt(a.position+2)===45?(a.position+=3,Ee(a,!0,-1)):L&&G(a,"directives end mark is expected"),it(a,a.lineIndent-1,4,!1,!0),Ee(a,!0,-1),a.checkLineBreaks&&Pe.test(a.input.slice(R,a.position))&&et(a,"non-ASCII line breaks are interpreted as content"),a.documents.push(a.result),a.position===a.lineStart&&ft(a)?a.input.charCodeAt(a.position)===46&&(a.position+=3,Ee(a,!0,-1)):a.position<a.length-1&&G(a,"end of the stream or a document separator is expected")}function Te(a,p){p=p||{},(a=String(a)).length!==0&&(a.charCodeAt(a.length-1)!==10&&a.charCodeAt(a.length-1)!==13&&(a+=`
`),a.charCodeAt(0)===65279&&(a=a.slice(1)));var y=new Lt(a,p),M=a.indexOf("\0");for(M!==-1&&(y.position=M,G(y,"null byte is not allowed in input")),y.input+="\0";y.input.charCodeAt(y.position)===32;)y.lineIndent+=1,y.position+=1;for(;y.position<y.length-1;)Dt(y);return y.documents}var At={loadAll:function(a,p,y){p!==null&&typeof p=="object"&&y===void 0&&(y=p,p=null);var M=Te(a,y);if(typeof p!="function")return M;for(var b=0,R=M.length;b<R;b+=1)p(M[b])},load:function(a,p){var y=Te(a,p);if(y.length!==0){if(y.length===1)return y[0];throw new o("expected a single document in the stream, but found more")}}},Ft=Object.prototype.toString,Nt=Object.prototype.hasOwnProperty,u=65279,E={0:"\\0",7:"\\a",8:"\\b",9:"\\t",10:"\\n",11:"\\v",12:"\\f",13:"\\r",27:"\\e",34:'\\"',92:"\\\\",133:"\\N",160:"\\_",8232:"\\L",8233:"\\P"},C=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],O=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function k(a){var p,y,M;if(p=a.toString(16).toUpperCase(),a<=255)y="x",M=2;else if(a<=65535)y="u",M=4;else{if(!(a<=4294967295))throw new o("code point within a string may not be greater than 0xFFFFFFFF");y="U",M=8}return"\\"+y+t.repeat("0",M-p.length)+p}function q(a){this.schema=a.schema||dt,this.indent=Math.max(1,a.indent||2),this.noArrayIndent=a.noArrayIndent||!1,this.skipInvalid=a.skipInvalid||!1,this.flowLevel=t.isNothing(a.flowLevel)?-1:a.flowLevel,this.styleMap=(function(p,y){var M,b,R,L,P,$,z;if(y===null)return{};for(M={},R=0,L=(b=Object.keys(y)).length;R<L;R+=1)P=b[R],$=String(y[P]),P.slice(0,2)==="!!"&&(P="tag:yaml.org,2002:"+P.slice(2)),(z=p.compiledTypeMap.fallback[P])&&Nt.call(z.styleAliases,$)&&($=z.styleAliases[$]),M[P]=$;return M})(this.schema,a.styles||null),this.sortKeys=a.sortKeys||!1,this.lineWidth=a.lineWidth||80,this.noRefs=a.noRefs||!1,this.noCompatMode=a.noCompatMode||!1,this.condenseFlow=a.condenseFlow||!1,this.quotingType=a.quotingType==='"'?2:1,this.forceQuotes=a.forceQuotes||!1,this.replacer=typeof a.replacer=="function"?a.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function _(a,p){for(var y,M=t.repeat(" ",p),b=0,R=-1,L="",P=a.length;b<P;)(R=a.indexOf(`
`,b))===-1?(y=a.slice(b),b=P):(y=a.slice(b,R+1),b=R+1),y.length&&y!==`
`&&(L+=M),L+=y;return L}function X(a,p){return`
`+t.repeat(" ",a.indent*p)}function le(a){return a===32||a===9}function B(a){return 32<=a&&a<=126||161<=a&&a<=55295&&a!==8232&&a!==8233||57344<=a&&a<=65533&&a!==u||65536<=a&&a<=1114111}function ne(a){return B(a)&&a!==u&&a!==13&&a!==10}function Re(a,p,y){var M=ne(a),b=M&&!le(a);return(y?M:M&&a!==44&&a!==91&&a!==93&&a!==123&&a!==125)&&a!==35&&!(p===58&&!b)||ne(p)&&!le(p)&&a===35||p===58&&b}function $e(a,p){var y,M=a.charCodeAt(p);return M>=55296&&M<=56319&&p+1<a.length&&(y=a.charCodeAt(p+1))>=56320&&y<=57343?1024*(M-55296)+y-56320+65536:M}function rt(a){return/^\n* /.test(a)}function Oe(a,p,y,M,b,R,L,P){var $,z,K=0,Z=null,Se=!1,W=!1,me=M!==-1,fe=-1,he=B(z=$e(a,0))&&z!==u&&!le(z)&&z!==45&&z!==63&&z!==58&&z!==44&&z!==91&&z!==93&&z!==123&&z!==125&&z!==35&&z!==38&&z!==42&&z!==33&&z!==124&&z!==61&&z!==62&&z!==39&&z!==34&&z!==37&&z!==64&&z!==96&&(function(f){return!le(f)&&f!==58})($e(a,a.length-1));if(p||L)for($=0;$<a.length;K>=65536?$+=2:$++){if(!B(K=$e(a,$)))return 5;he=he&&Re(K,Z,P),Z=K}else{for($=0;$<a.length;K>=65536?$+=2:$++){if((K=$e(a,$))===10)Se=!0,me&&(W=W||$-fe-1>M&&a[fe+1]!==" ",fe=$);else if(!B(K))return 5;he=he&&Re(K,Z,P),Z=K}W=W||me&&$-fe-1>M&&a[fe+1]!==" "}return Se||W?y>9&&rt(a)?5:L?R===2?5:2:W?4:3:!he||L||b(a)?R===2?5:2:1}function Et(a,p,y,M,b){a.dump=(function(){if(p.length===0)return a.quotingType===2?'""':"''";if(!a.noCompatMode&&(C.indexOf(p)!==-1||O.test(p)))return a.quotingType===2?'"'+p+'"':"'"+p+"'";var R=a.indent*Math.max(1,y),L=a.lineWidth===-1?-1:Math.max(Math.min(a.lineWidth,40),a.lineWidth-R),P=M||a.flowLevel>-1&&y>=a.flowLevel;switch(Oe(p,P,a.indent,L,(function($){return(function(z,K){var Z,Se;for(Z=0,Se=z.implicitTypes.length;Z<Se;Z+=1)if(z.implicitTypes[Z].resolve(K))return!0;return!1})(a,$)}),a.quotingType,a.forceQuotes&&!M,b)){case 1:return p;case 2:return"'"+p.replace(/'/g,"''")+"'";case 3:return"|"+ze(p,a.indent)+ot(_(p,R));case 4:return">"+ze(p,a.indent)+ot(_((function($,z){for(var K,Z,Se=/(\n+)([^\n]*)/g,W=(fe=$.indexOf(`
`),fe=fe!==-1?fe:$.length,Se.lastIndex=fe,at($.slice(0,fe),z)),me=$[0]===`
`||$[0]===" ",fe;Z=Se.exec($);){var he=Z[1],f=Z[2];K=f[0]===" ",W+=he+(me||K||f===""?"":`
`)+at(f,z),me=K}return W})(p,L),R));case 5:return'"'+(function($){for(var z,K="",Z=0,Se=0;Se<$.length;Z>=65536?Se+=2:Se++)Z=$e($,Se),!(z=E[Z])&&B(Z)?(K+=$[Se],Z>=65536&&(K+=$[Se+1])):K+=z||k(Z);return K})(p)+'"';default:throw new o("impossible error: invalid scalar style")}})()}function ze(a,p){var y=rt(a)?String(p):"",M=a[a.length-1]===`
`;return y+(M&&(a[a.length-2]===`
`||a===`
`)?"+":M?"":"-")+`
`}function ot(a){return a[a.length-1]===`
`?a.slice(0,-1):a}function at(a,p){if(a===""||a[0]===" ")return a;for(var y,M,b=/ [^ ]/g,R=0,L=0,P=0,$="";y=b.exec(a);)(P=y.index)-R>p&&(M=L>R?L:P,$+=`
`+a.slice(R,M),R=M+1),L=P;return $+=`
`,a.length-R>p&&L>R?$+=a.slice(R,L)+`
`+a.slice(L+1):$+=a.slice(R),$.slice(1)}function qt(a,p,y,M){var b,R,L,P="",$=a.tag;for(b=0,R=y.length;b<R;b+=1)L=y[b],a.replacer&&(L=a.replacer.call(y,String(b),L)),(Je(a,p+1,L,!0,!0,!1,!0)||L===void 0&&Je(a,p+1,null,!0,!0,!1,!0))&&(M&&P===""||(P+=X(a,p)),a.dump&&a.dump.charCodeAt(0)===10?P+="-":P+="- ",P+=a.dump);a.tag=$,a.dump=P||"[]"}function zt(a,p,y){var M,b,R,L,P,$;for(R=0,L=(b=y?a.explicitTypes:a.implicitTypes).length;R<L;R+=1)if(((P=b[R]).instanceOf||P.predicate)&&(!P.instanceOf||typeof p=="object"&&p instanceof P.instanceOf)&&(!P.predicate||P.predicate(p))){if(y?P.multi&&P.representName?a.tag=P.representName(p):a.tag=P.tag:a.tag="?",P.represent){if($=a.styleMap[P.tag]||P.defaultStyle,Ft.call(P.represent)==="[object Function]")M=P.represent(p,$);else{if(!Nt.call(P.represent,$))throw new o("!<"+P.tag+'> tag resolver accepts not "'+$+'" style');M=P.represent[$](p,$)}a.dump=M}return!0}return!1}function Je(a,p,y,M,b,R,L){a.tag=null,a.dump=y,zt(a,y,!1)||zt(a,y,!0);var P,$=Ft.call(a.dump),z=M;M&&(M=a.flowLevel<0||a.flowLevel>p);var K,Z,Se=$==="[object Object]"||$==="[object Array]";if(Se&&(Z=(K=a.duplicates.indexOf(y))!==-1),(a.tag!==null&&a.tag!=="?"||Z||a.indent!==2&&p>0)&&(b=!1),Z&&a.usedDuplicates[K])a.dump="*ref_"+K;else{if(Se&&Z&&!a.usedDuplicates[K]&&(a.usedDuplicates[K]=!0),$==="[object Object]")M&&Object.keys(a.dump).length!==0?((function(W,me,fe,he){var f,te,ee,Q,ae,Y,ue="",ce=W.tag,pe=Object.keys(fe);if(W.sortKeys===!0)pe.sort();else if(typeof W.sortKeys=="function")pe.sort(W.sortKeys);else if(W.sortKeys)throw new o("sortKeys must be a boolean or a function");for(f=0,te=pe.length;f<te;f+=1)Y="",he&&ue===""||(Y+=X(W,me)),Q=fe[ee=pe[f]],W.replacer&&(Q=W.replacer.call(fe,ee,Q)),Je(W,me+1,ee,!0,!0,!0)&&((ae=W.tag!==null&&W.tag!=="?"||W.dump&&W.dump.length>1024)&&(W.dump&&W.dump.charCodeAt(0)===10?Y+="?":Y+="? "),Y+=W.dump,ae&&(Y+=X(W,me)),Je(W,me+1,Q,!0,ae)&&(W.dump&&W.dump.charCodeAt(0)===10?Y+=":":Y+=": ",ue+=Y+=W.dump));W.tag=ce,W.dump=ue||"{}"})(a,p,a.dump,b),Z&&(a.dump="&ref_"+K+a.dump)):((function(W,me,fe){var he,f,te,ee,Q,ae="",Y=W.tag,ue=Object.keys(fe);for(he=0,f=ue.length;he<f;he+=1)Q="",ae!==""&&(Q+=", "),W.condenseFlow&&(Q+='"'),ee=fe[te=ue[he]],W.replacer&&(ee=W.replacer.call(fe,te,ee)),Je(W,me,te,!1,!1)&&(W.dump.length>1024&&(Q+="? "),Q+=W.dump+(W.condenseFlow?'"':"")+":"+(W.condenseFlow?"":" "),Je(W,me,ee,!1,!1)&&(ae+=Q+=W.dump));W.tag=Y,W.dump="{"+ae+"}"})(a,p,a.dump),Z&&(a.dump="&ref_"+K+" "+a.dump));else if($==="[object Array]")M&&a.dump.length!==0?(a.noArrayIndent&&!L&&p>0?qt(a,p-1,a.dump,b):qt(a,p,a.dump,b),Z&&(a.dump="&ref_"+K+a.dump)):((function(W,me,fe){var he,f,te,ee="",Q=W.tag;for(he=0,f=fe.length;he<f;he+=1)te=fe[he],W.replacer&&(te=W.replacer.call(fe,String(he),te)),(Je(W,me,te,!1,!1)||te===void 0&&Je(W,me,null,!1,!1))&&(ee!==""&&(ee+=","+(W.condenseFlow?"":" ")),ee+=W.dump);W.tag=Q,W.dump="["+ee+"]"})(a,p,a.dump),Z&&(a.dump="&ref_"+K+" "+a.dump));else{if($!=="[object String]"){if($==="[object Undefined]"||a.skipInvalid)return!1;throw new o("unacceptable kind of an object to dump "+$)}a.tag!=="?"&&Et(a,a.dump,p,R,z)}a.tag!==null&&a.tag!=="?"&&(P=encodeURI(a.tag[0]==="!"?a.tag.slice(1):a.tag).replace(/!/g,"%21"),P=a.tag[0]==="!"?"!"+P:P.slice(0,18)==="tag:yaml.org,2002:"?"!!"+P.slice(18):"!<"+P+">",a.dump=P+" "+a.dump)}return!0}function ln(a,p){var y,M,b=[],R=[];for(Ut(a,b,R),y=0,M=R.length;y<M;y+=1)p.duplicates.push(b[R[y]]);p.usedDuplicates=new Array(M)}function Ut(a,p,y){var M,b,R;if(a!==null&&typeof a=="object")if((b=p.indexOf(a))!==-1)y.indexOf(b)===-1&&y.push(b);else if(p.push(a),Array.isArray(a))for(b=0,R=a.length;b<R;b+=1)Ut(a[b],p,y);else for(b=0,R=(M=Object.keys(a)).length;b<R;b+=1)Ut(a[M[b]],p,y)}function Bt(a,p){return function(){throw new Error("Function yaml."+a+" is removed in js-yaml 4. Use yaml."+p+" instead, which is now safe by default.")}}var Jt=h,Wt=T,Yt=A,Gt=F,Kt=U,Vt=dt,Qt=At.load,Xt=At.loadAll,Zt=function(a,p){var y=new q(p=p||{});y.noRefs||ln(a,y);var M=a;return y.replacer&&(M=y.replacer.call({"":M},"",M)),Je(y,0,M,!0,!0)?y.dump+`
`:""},en=o,tn={binary:_e,float:j,map:w,null:N,pairs:lt,set:yt,timestamp:se,bool:D,int:de,merge:ye,omap:Ke,seq:g,str:v},nn=Bt("safeLoad","load"),rn=Bt("safeLoadAll","loadAll"),on=Bt("safeDump","dump"),dn={Type:Jt,Schema:Wt,FAILSAFE_SCHEMA:Yt,JSON_SCHEMA:Gt,CORE_SCHEMA:Kt,DEFAULT_SCHEMA:Vt,load:Qt,loadAll:Xt,dump:Zt,YAMLException:en,types:tn,safeLoad:nn,safeLoadAll:rn,safeDump:on};n.CORE_SCHEMA=Kt,n.DEFAULT_SCHEMA=Vt,n.FAILSAFE_SCHEMA=Yt,n.JSON_SCHEMA=Gt,n.Schema=Wt,n.Type=Jt,n.YAMLException=en,n.default=dn,n.dump=Zt,n.load=Qt,n.loadAll=Xt,n.safeDump=on,n.safeLoad=nn,n.safeLoadAll=rn,n.types=tn,Object.defineProperty(n,"__esModule",{value:!0})})),window.SELECTORS={PAGES:{MAPPINGS:"mappings-page",REQUESTS:"requests-page",SCENARIOS:"scenarios-page","IMPORT-EXPORT":"import-export-page",RECORDING:"recording-page",SETTINGS:"settings-page"},REQUEST_FILTERS:{METHOD:"req-filter-method",STATUS:"req-filter-status",URL:"req-filter-url",DATE_FROM:"req-filter-from",DATE_TO:"req-filter-to",QUICK:"req-filter-quick"},MAPPING_FILTERS:{QUERY:"filter-query"},LISTS:{MAPPINGS:"mappings-list",REQUESTS:"requests-list",SCENARIOS:"scenarios-list"},EMPTY:{MAPPINGS:"mappings-empty",REQUESTS:"requests-empty"},UI:{STATS:"stats",SEARCH_FILTERS:"search-filters",UPTIME:"uptime",DATA_SOURCE_INDICATOR:"data-source-indicator",REQUESTS_SOURCE_INDICATOR:"requests-source-indicator"},LOADING:{MAPPINGS:"mappings-loading",REQUESTS:"requests-loading"},COUNTERS:{MAPPINGS:"mappings-count",REQUESTS:"requests-count"},CONNECTION:{SETUP:"connection-setup",HOST:"wiremock-host",PORT:"wiremock-port",CONNECT_BTN:"connect-btn",STATUS_DOT:"status-dot",STATUS_TEXT:"status-text",UPTIME:"uptime"},MODAL:{FORM:"mapping-form",ID:"mapping-id",TITLE:"modal-title"},FORM_FIELDS:{METHOD:"mapping-method",URL:"mapping-url",STATUS:"mapping-status",HEADERS:"mapping-headers",BODY:"mapping-body",PRIORITY:"mapping-priority",NAME:"mapping-name"},BUTTONS:{ADD_MAPPING:"add-mapping-btn",START_RECORDING:"start-recording-btn"},RECORDING:{URL:"recording-url",CAPTURE_HEADERS:"capture-headers",CAPTURE_BODY:"capture-body",URL_FILTER:"url-filter",INDICATOR:"recording-indicator",TARGET:"recording-target",COUNT:"recording-count",STOP_BTN:"stop-recording-btn"},SETTINGS:{HOST:"settings-host",PORT:"settings-port",TIMEOUT:"settings-timeout",AUTO_REFRESH:"auto-refresh",THEME:"theme-select",CUSTOM_HEADERS:"custom-headers",CACHE_ENABLED:"cache-enabled"},IMPORT:{FILE:"import-file",DISPLAY:"file-display",ACTIONS:"import-actions",RESULT:"import-result",MODE:"import-mode"},EXPORT:{FORMAT:"export-format",RESULT:"export-result"},STATS:{TOTAL_MAPPINGS:"total-mappings",TOTAL_REQUESTS:"total-requests"},HEALTH:{INDICATOR:"health-indicator"}},window.Icons={render(n,e={}){if(!n)return"";const t=["icon",`icon-${n}`];return e.className&&t.push(e.className),`<svg class="${t.join(" ")}" aria-hidden="true" focusable="false"><use href="#icon-${n}"></use></svg>`}},window.ENDPOINTS={HEALTH:"/health",MAPPINGS:"/mappings",MAPPINGS_RESET:"/mappings/reset",MAPPINGS_SAVE:"/mappings/save",MAPPINGS_IMPORT:"/mappings/import",MAPPINGS_FIND_BY_METADATA:"/mappings/find-by-metadata",MAPPINGS_REMOVE_BY_METADATA:"/mappings/remove-by-metadata",MAPPINGS_UNMATCHED:"/mappings/unmatched",REQUESTS:"/requests",REQUESTS_COUNT:"/requests/count",REQUESTS_REMOVE:"/requests/remove",REQUESTS_FIND:"/requests/find",REQUESTS_UNMATCHED:"/requests/unmatched",REQUESTS_UNMATCHED_NEAR_MISSES:"/requests/unmatched/near-misses",RECORDINGS_START:"/recordings/start",RECORDINGS_STOP:"/recordings/stop",RECORDINGS_STATUS:"/recordings/status",RECORDINGS_SNAPSHOT:"/recordings/snapshot",SCENARIOS:"/scenarios",SCENARIOS_RESET:"/scenarios/reset"},(function(){const e=new Map,t=new Map,i=new Set,r=new Map,o=(l,d,m)=>e.set(l,{name:d,delay:m,createdAt:Date.now()}),s=(l,d,m)=>t.set(l,{name:d,delay:m,createdAt:Date.now()}),c={setInterval(l,d,m){const h=window.setInterval(l,d);return o(h,m,d),h},setNamedInterval(l,d,m){return this.setInterval(d,m,l)},clearInterval(l){l!=null&&(window.clearInterval(l),e.delete(l))},setTimeout(l,d,m){const h=window.setTimeout(()=>{t.delete(h),l()},d);return s(h,m,d),h},clearTimeout(l){l!=null&&(window.clearTimeout(l),t.delete(l))},requestAnimationFrame(l){const d=window.requestAnimationFrame(l);return i.add(d),d},cancelAnimationFrame(l){l!=null&&(window.cancelAnimationFrame(l),i.delete(l))},addEventListener(l,d,m,h){!l||!d||!m||(l.addEventListener(d,m,h),r.has(l)||r.set(l,new Set),r.get(l).add({type:d,handler:m,options:h}))},removeEventListener(l,d,m,h){if(!l||!d||!m)return;l.removeEventListener(d,m,h);const S=r.get(l);if(S){for(const I of S)if(I.type===d&&I.handler===m&&JSON.stringify(I.options)===JSON.stringify(h)){S.delete(I);break}S.size===0&&r.delete(l)}},clearAll(){e.forEach((l,d)=>window.clearInterval(d)),e.clear(),t.forEach((l,d)=>window.clearTimeout(d)),t.clear(),i.forEach(l=>window.cancelAnimationFrame(l)),i.clear(),r.forEach((l,d)=>{l.forEach(({type:m,handler:h,options:S})=>{d.removeEventListener(m,h,S)})}),r.clear()},getStats(){return{intervals:e.size,timeouts:t.size,rafs:i.size,eventTargets:r.size,details:{intervals:Array.from(e.entries()),timeouts:Array.from(t.entries())}}}};window.LifecycleManager=c,window.addEventListener("beforeunload",()=>c.clearAll())})(),(function(){if(window.AppEvents&&typeof window.AppEvents.emit=="function")return;const e=new Map,t=(r,o)=>{e.has(r)||e.set(r,new Set),e.get(r).add(o)},i=(r,o)=>{const s=e.get(r);s&&(s.delete(o),s.size===0&&e.delete(r))};window.AppEvents={on(r,o){return!r||typeof o!="function"?()=>{}:(t(r,o),()=>i(r,o))},off(r,o){!r||typeof o!="function"||i(r,o)},emit(r,o={}){const s=e.get(r);if(!s||s.size===0)return!1;const c={type:r,detail:o};return[...s].forEach(l=>{try{l(c)}catch(d){Logger.warn("CORE",`AppEvents handler failed for "${r}":`,d)}}),!0},listenerCount(r){return e.get(r)?.size||0}}})(),window.debounce=function(e,t=150,i={}){let r,o,s,c;const{leading:l=!1,trailing:d=!0}=i,m=()=>{r=void 0,d&&o&&(c=e.apply(s,o),o=s=void 0)};return Object.assign(function(...S){return o=S,s=this,r===void 0?(l&&(c=e.apply(s,o),o=s=void 0),r=window.setTimeout(m,t)):(window.clearTimeout(r),r=window.setTimeout(m,t)),c},{cancel(){r!==void 0&&window.clearTimeout(r),r=void 0,o=s=void 0},flush(){return r!==void 0&&(window.clearTimeout(r),m()),c}})},(function(){const e=new WeakMap;function t(i){if(typeof i!="string"||!i.trim())return null;const r=document.createElement("template");return r.innerHTML=i.trim(),r.content.firstElementChild}window.renderList=function(r,o,s={}){if(!(r instanceof Element)||!Array.isArray(o))return;const{renderItem:c,getKey:l,getSignature:d,onItemChanged:m,onItemRemoved:h}=s;if(typeof c!="function")return;const S=new Map;Array.from(r.children).forEach(v=>{v instanceof HTMLElement&&v.dataset&&v.dataset.id&&S.set(v.dataset.id,v)});const I=document.createDocumentFragment();o.forEach(v=>{const g=typeof l=="function"?l(v):v&&(v.id||v.uuid);if(!g)return;const w=String(g),A=typeof d=="function"?d(v):w,N=S.get(w);if(N&&N.dataset.renderSignature===A){N.dataset.renderSignature=A,I.appendChild(N),S.delete(w);return}const D=N&&N.dataset.renderSignature||null;if(N&&typeof m=="function"&&D!==A)try{m(w,v,A)}catch(de){Logger.warn("UI","renderList onItemChanged failed:",de)}const V=c(v),H=t(V);if(!H){S.delete(w);return}H.dataset.id=w,H.dataset.renderSignature=A,I.appendChild(H),S.delete(w)}),S.forEach((v,g)=>{if(v.remove(),typeof h=="function")try{h(String(g),v)}catch(w){Logger.warn("UI","renderList onItemRemoved failed:",w)}});const T=()=>{r.replaceChildren(I)};if(window.LifecycleManager&&typeof window.LifecycleManager.requestAnimationFrame=="function"){const v=e.get(r);v&&window.LifecycleManager.cancelAnimationFrame(v);const g=window.LifecycleManager.requestAnimationFrame(()=>{T(),e.delete(r)});g!==null&&e.set(r,g)}else if(typeof window.requestAnimationFrame=="function"){const v=window.requestAnimationFrame(T);e.set(r,v)}else T()}})();const ensureCustomHeaderObject=n=>!n||typeof n!="object"||Array.isArray(n)?{}:Object.keys(n).reduce((e,t)=>{const i=String(t).trim();return i&&(e[i]=n[t]),e},{}),migrateLegacySettings=n=>{if(!n||typeof n!="object"||Array.isArray(n))return{};const e={...n},t=ensureCustomHeaderObject(e.customHeaders);if(typeof e.authHeader=="string"&&e.authHeader.trim()){const i=e.authHeader.trim();if(Object.prototype.hasOwnProperty.call(t,"Authorization")||(t.Authorization=i),delete e.authHeader,!e.customHeadersRaw||typeof e.customHeadersRaw!="string"||!e.customHeadersRaw.trim())try{e.customHeadersRaw=JSON.stringify(t,null,2)}catch(r){Logger.warn("API","Failed to serialize migrated custom headers:",r),e.customHeadersRaw=""}}return e.customHeaders=t,typeof e.customHeadersRaw!="string"&&(e.customHeadersRaw=""),e.autoConnect=e.autoConnect!==!1,e};window.normalizeWiremockSettings=n=>migrateLegacySettings(n),window.readWiremockSettings=()=>{try{const n=localStorage.getItem("wiremock-settings");if(!n)return{};const e=JSON.parse(n);return migrateLegacySettings(e)}catch(n){return Logger.warn("UI","Failed to read stored settings, returning empty object:",n),{}}},window.buildScenarioStateEndpoint=n=>{const e=typeof n=="string"?n:"";return e.trim()?`${ENDPOINTS.SCENARIOS}/${encodeURIComponent(e)}/state`:""};let wiremockBaseUrl="",requestTimeout=window.DEFAULT_SETTINGS?.requestTimeout?parseInt(window.DEFAULT_SETTINGS.requestTimeout):69e3;window.customHeaders=ensureCustomHeaderObject(window.DEFAULT_SETTINGS?.customHeaders||{}),window.startTime=null,window.uptimeInterval=null;let autoRefreshInterval=null;window.allRequests=[],window.allScenarios=[],window.isRecording=!1,window.recordedCount=0,window.normalizeWiremockBaseUrl=(n,e)=>{let t=(n||"").trim()||"localhost",i=(e||"").trim(),r="http",o="";try{const s=new URL(t.includes("://")?t:`http://${t}`);r=s.protocol.replace(":","")||"http",o=s.hostname,i||(i=s.port)}catch{const c=t.match(/^([^:/]+)(?::(\d+))?$/);o=c?c[1]:t,i||(i=c?.[2])}return`${r}://${o||"localhost"}:${i||(r==="https"?"443":"8080")}/__admin`},window.apiFetch=async(n,e={})=>{const t=new AbortController,i=Utils.safeCall(window.readWiremockSettings)||{},r=i.requestTimeout?parseInt(i.requestTimeout):window.DEFAULT_SETTINGS?.requestTimeout?parseInt(window.DEFAULT_SETTINGS.requestTimeout):69e3,o=setTimeout(()=>t.abort(),r),s=`${window.wiremockBaseUrl}${n}`,c=e.method||"GET",l={"Content-Type":"application/json",...ensureCustomHeaderObject(i.customHeaders||window.customHeaders),...e.headers},m=!(n===window.ENDPOINTS?.HEALTH||n===window.ENDPOINTS?.MAPPINGS);m&&Logger.api(`${c} ${n}`);try{const h=await fetch(s,{...e,signal:t.signal,headers:l});if(clearTimeout(o),!h.ok){const I=await h.text();m&&Logger.error("API",`HTTP ${h.status}: ${I||h.statusText}`,{endpoint:n,method:c});const T=new Error(`HTTP ${h.status}: ${I||h.statusText}`);throw T.status=h.status,T.statusText=h.statusText,T}const S=h.headers.get("content-type")?.includes("application/json")?await h.json():await h.text();m&&Logger.api(`${c} ${n} - OK`);try{if(n===window.ENDPOINTS?.HEALTH||n===window.ENDPOINTS?.MAPPINGS){const I=Date.now();window.lastWiremockSuccess=I,window.AppEvents&&typeof window.AppEvents.emit=="function"&&window.AppEvents.emit("wiremock:success",{endpoint:n,method:c,timestamp:I})}}catch{}return S}catch(h){throw clearTimeout(o),m&&Logger.error("API",`${c} ${n} - ${h.name}: ${h.message}`),h.name==="AbortError"?new Error(`Request timeout after ${r}ms`):h}},window.showPage=(n,e)=>{Logger.info("UI",`Switching to tab: ${n}`),document.querySelectorAll('.main-content > div[id$="-page"]').forEach(i=>i.classList.add("hidden"));const t=document.getElementById(SELECTORS.PAGES[n.toUpperCase()]);if(!t){Logger.warn("UI",`Page not found: ${n}`);return}if(t.classList.remove("hidden"),document.querySelectorAll(".sidebar .nav-item").forEach(i=>i.classList.remove("active")),e&&e.classList.add("active"),window.history&&window.history.replaceState){const i=new URL(window.location.href),r=i.searchParams.get("tab");i.searchParams.set("tab",n);const o=i.toString();Logger.api(`showPage: ${r} \u2192 ${n}`),Logger.api(`showPage URL: ${o}`),window.history.replaceState({},"",o)}else Logger.warn("UI","history.replaceState not available")};const SIDEBAR_COLLAPSED_CLASS="sidebar-collapsed",SIDEBAR_STATE_STORAGE_KEY="imock-sidebar-state",applySidebarState=(n,{persist:e=!0}={})=>{if(!document.body)return;document.body.classList.toggle(SIDEBAR_COLLAPSED_CLASS,n);const t=document.querySelector(".sidebar-toggle");if(t){const i=n?"Expand sidebar":"Collapse sidebar";t.setAttribute("aria-expanded",String(!n)),t.setAttribute("aria-label",i),t.setAttribute("title",i),t.querySelector("use")?.setAttribute("href",n?"#icon-sidebar-expand":"#icon-sidebar-collapse")}if(e)try{localStorage.setItem(SIDEBAR_STATE_STORAGE_KEY,n?"collapsed":"expanded")}catch(i){Logger.warn("UI","Unable to persist sidebar state:",i)}};window.toggleSidebar=()=>{const n=document.body?.classList.contains(SIDEBAR_COLLAPSED_CLASS);applySidebarState(!n)},window.initializeSidebarPreference=()=>{let n=null;try{n=localStorage.getItem(SIDEBAR_STATE_STORAGE_KEY)}catch(e){Logger.warn("UI","Unable to read sidebar state from storage:",e)}applySidebarState(n==="collapsed",{persist:!1})};const resolveModalElement=n=>{if(!n)return Logger.warn("UI","Modal ID is required to resolve modal element"),null;const e=document.getElementById(n);return e||Logger.warn("UI",`Modal element not found for id: ${n}`),e};window.showModal=n=>{const e=resolveModalElement(n);if(!e)return;e.classList.remove("hidden"),e.style.display="flex";const t=e.querySelector("input, select, textarea");t&&LifecycleManager.requestAnimationFrame(()=>t.focus())},window.openAddMappingModal=()=>{if(window.TemplateManager?.openGalleryForTarget){window.TemplateManager.openGalleryForTarget("create-inline");return}const n=document.querySelector('[data-template-trigger][data-template-target="create-inline"]');n?n.click():window.showModal("template-gallery-modal")},window.hideModal=n=>{const e=typeof n=="string"?resolveModalElement(n):n;if(e&&(e.classList.add("hidden"),e.style.display="none",e.querySelector("form")?.reset(),e.id==="edit-mapping-modal"&&(typeof UIComponents?.clearCardState=="function"&&UIComponents.clearCardState("mapping","is-editing"),window.editor&&typeof window.editor.setValue=="function")))try{window.editor.setValue("")}catch(t){Logger.warn("UI","Failed to clear editor:",t)}},window.showTab=(n,e)=>{if(document.querySelectorAll(".tab-content").forEach(t=>t.classList.add("hidden")),document.querySelectorAll(".tab-button").forEach(t=>t.classList.remove("active")),document.getElementById(`${n}-tab`).classList.remove("hidden"),e.classList.add("active"),window.history&&window.history.replaceState){const t=new URL(window.location.href);t.searchParams.set("tab",n),window.history.replaceState({},"",t.toString())}};const applyThemeToDom=n=>{if(!document.body)return;document.body.setAttribute("data-theme",n);const e=[document.getElementById("theme-icon"),document.getElementById("editor-theme-icon")].filter(Boolean);if(e.length){const t=n==="dark"?"#icon-sun":"#icon-moon";e.forEach(i=>{i.setAttribute("href",t),i.setAttribute("xlink:href",t)})}},persistThemePreference=n=>{localStorage.setItem("theme",n);try{localStorage.setItem("wiremock-settings",JSON.stringify({...Utils.safeCall(window.readWiremockSettings)||{},theme:n}))}catch{}};window.toggleTheme=()=>{if(!document.body)return;const n=(document.body.getAttribute("data-theme")||"dark")==="dark"?"light":"dark";applyThemeToDom(n),persistThemePreference(n),window.NotificationManager&&NotificationManager.show(`Switched to ${n} theme`,"success")},window.changeTheme=()=>{const n=document.getElementById("theme-select");if(!n)return;const e=n.value,t=e==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;applyThemeToDom(t),persistThemePreference(e),window.NotificationManager&&NotificationManager.show(`Theme changed to ${e}`,"success")},window.initializeTheme=()=>{const n=localStorage.getItem("theme")||"dark",e=n==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":n;applyThemeToDom(e);const t=document.getElementById("theme-select");t&&(t.value=n)},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initializeTheme):initializeTheme(),LifecycleManager.addEventListener(document,"click",n=>{n.target.classList.contains("modal")&&hideModal(n.target)}),LifecycleManager.addEventListener(document,"keydown",n=>{if(n.key==="Escape"){const e=document.querySelector(".modal:not(.hidden)");e&&hideModal(e)}}),window.elementCache=new Map,window.invalidateElementCache=n=>n?window.elementCache.delete(n):window.elementCache.clear(),Logger.info("UI","Core.js loaded - Constants, API client, basic UI functions"),window.NotificationManager||(window.NotificationManager={TYPES:{INFO:"info",SUCCESS:"success",ERROR:"error",WARNING:"warning"},ICONS:{info:"\u2139\uFE0F",success:"\u2705",warning:"\u26A0\uFE0F",error:"\u26D4"},queue:[],visibleToasts:[],dedupeMap:new Map,toastContainer:null,cooldownTimer:null,lastShownAt:0,maxVisible:3,cooldownMs:650,dedupeWindowMs:4e3,defaultDuration:4e3,motionQuery:null,_boundHandleKeydown:null,init(){this.toastContainer||(this.toastContainer=document.getElementById("toast-container"),this.toastContainer||(this.toastContainer=document.createElement("div"),this.toastContainer.id="toast-container",this.toastContainer.setAttribute("aria-live","polite"),this.toastContainer.setAttribute("aria-atomic","false"),document.body.appendChild(this.toastContainer))),!this.motionQuery&&window.matchMedia&&(this.motionQuery=window.matchMedia("(prefers-reduced-motion: reduce)")),this._boundHandleKeydown||(this._boundHandleKeydown=this.handleKeydown.bind(this),window.LifecycleManager?window.LifecycleManager.addEventListener(document,"keydown",this._boundHandleKeydown):document.addEventListener("keydown",this._boundHandleKeydown))},cleanup(){this._boundHandleKeydown&&(window.LifecycleManager?window.LifecycleManager.removeEventListener(document,"keydown",this._boundHandleKeydown):document.removeEventListener("keydown",this._boundHandleKeydown),this._boundHandleKeydown=null)},normalizePayload(n,e=this.TYPES.INFO,t=void 0){if(n==null)return null;const i={message:String(n).trim(),type:this.TYPES.INFO,duration:this.defaultDuration,action:null};return typeof e=="object"&&e!==null?Object.assign(i,e):(i.type=typeof e=="string"?e:this.TYPES.INFO,typeof t=="number"?i.duration=t:typeof t=="object"&&t!==null&&Object.assign(i,t)),i.message?(Object.values(this.TYPES).includes(i.type)||(i.type=this.TYPES.INFO),i.action&&typeof i.action!="object"&&(i.action=null),i.action&&typeof i.action?.label!="string"&&(i.action=null),i.action&&typeof i.action?.handler!="function"&&(i.action.handler=()=>{}),i.action?i.duration=null:(typeof i.duration!="number"||i.duration<=0)&&(i.duration=this.defaultDuration),i.createdAt=Date.now(),i.count=i.count&&Number.isInteger(i.count)?i.count:1,i.dedupeKey=this.getDedupeKey(i),i):null},show(n,e=this.TYPES.INFO,t=void 0){this.init();const i=this.normalizePayload(n,e,t);if(!i)return;const r=this.dedupeMap.get(i.dedupeKey);if(r&&Date.now()-r.timestamp<=this.dedupeWindowMs){r.count+=1,r.timestamp=Date.now(),r.payload.count=r.count,this.updateToastCount(r),clearTimeout(r.cleanupTimer),r.cleanupTimer=setTimeout(()=>{this.dedupeMap.delete(i.dedupeKey)},this.dedupeWindowMs);return}this.queue.push(i),this.dedupeMap.set(i.dedupeKey,{count:i.count,timestamp:Date.now(),payload:i,toastEl:null,cleanupTimer:setTimeout(()=>{this.dedupeMap.delete(i.dedupeKey)},this.dedupeWindowMs)}),this.processQueue()},success(n,e){this.show(n,{type:this.TYPES.SUCCESS,...typeof e=="object"?e:{duration:e}})},error(n,e){this.show(n,{type:this.TYPES.ERROR,...typeof e=="object"?e:{duration:e}})},warning(n,e){this.show(n,{type:this.TYPES.WARNING,...typeof e=="object"?e:{duration:e}})},info(n,e){this.show(n,{type:this.TYPES.INFO,...typeof e=="object"?e:{duration:e}})},handleKeydown(n){if(n.key!=="Escape"||!this.visibleToasts.length)return;const e=this.visibleToasts[this.visibleToasts.length-1];e&&this.dismissToast(e.toastEl,e.payload,"escape")},processQueue(){if(!this.queue.length||this.visibleToasts.length>=this.maxVisible)return;const e=Date.now()-this.lastShownAt;if(e<this.cooldownMs){this.cooldownTimer||(this.cooldownTimer=setTimeout(()=>{this.cooldownTimer=null,this.processQueue()},this.cooldownMs-e));return}const t=this.getNextToastIndex();if(t===-1)return;const i=this.queue.splice(t,1)[0];this.displayToast(i)},getNextToastIndex(){if(!this.queue.length)return-1;const n={[this.TYPES.ERROR]:3,[this.TYPES.WARNING]:2,[this.TYPES.INFO]:1,[this.TYPES.SUCCESS]:1};let e=0,t=-1/0,i=1/0;for(let r=0;r<this.queue.length;r+=1){const o=this.queue[r],s=n[o.type]||0;(s>t||s===t&&o.createdAt<i)&&(t=s,i=o.createdAt,e=r)}return e},displayToast(n){const e=document.createElement("div");e.className=`toast toast-${n.type}`,e.setAttribute("role",n.type===this.TYPES.ERROR?"alert":"status"),e.setAttribute("aria-live",n.type===this.TYPES.ERROR?"assertive":"polite"),e.setAttribute("aria-atomic","true"),e.dataset.key=n.dedupeKey;const t=document.createElement("span");t.className="toast-icon",t.setAttribute("aria-hidden","true"),t.textContent=this.ICONS[n.type]||this.ICONS.info;const i=document.createElement("div");i.className="toast-content";const r=document.createElement("p");r.className="toast-message",r.textContent=n.message;const o=document.createElement("span");o.className="toast-count",n.count>1&&(o.textContent=`\xD7${n.count}`,o.setAttribute("aria-label",`${n.count} occurrences`));const s=document.createElement("div");s.className="toast-actions";const c=document.createElement("button");if(c.type="button",c.className="toast-close",c.setAttribute("aria-label","Dismiss notification"),c.textContent="\u2715",c.addEventListener("click",()=>this.dismissToast(e,n,"close")),n.action){const S=document.createElement("button");S.type="button",S.className="toast-action",S.textContent=n.action.label,S.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation();try{n.action.handler()}finally{this.dismissToast(e,n,"action")}}),s.appendChild(S)}s.appendChild(c),i.appendChild(r),n.count>1&&i.appendChild(o),e.appendChild(t),e.appendChild(i),e.appendChild(s),this.toastContainer.firstChild?this.toastContainer.insertBefore(e,this.toastContainer.firstChild):this.toastContainer.appendChild(e);const l=this.dedupeMap.get(n.dedupeKey);l&&(l.toastEl=e,l.payload=n);const d={toastEl:e,payload:n,remaining:n.duration,hideTimer:null,startedAt:null};this.visibleToasts.push(d),this.lastShownAt=Date.now(),requestAnimationFrame(()=>{e.classList.add("show")});const m=()=>{d.hideTimer&&(clearTimeout(d.hideTimer),d.hideTimer=null,d.startedAt&&d.remaining&&(d.remaining-=Date.now()-d.startedAt))},h=()=>{d.hideTimer||n.duration===null||((typeof d.remaining!="number"||d.remaining<=0)&&(d.remaining=this.defaultDuration),d.startedAt=Date.now(),d.hideTimer=setTimeout(()=>{this.dismissToast(e,n,"timeout")},d.remaining))};e.addEventListener("mouseenter",m),e.addEventListener("focusin",m),e.addEventListener("mouseleave",h),e.addEventListener("focusout",h),n.duration!==null&&(d.remaining=n.duration,h()),this.motionQuery&&this.motionQuery.matches&&e.classList.add("toast-reduced-motion"),this.processQueue()},dismissToast(n,e,t){if(!n||n.dataset.dismissed==="true")return;n.dataset.dismissed="true",n.classList.remove("show");const i=this.visibleToasts.findIndex(o=>o.toastEl===n);if(i!==-1){const o=this.visibleToasts[i];o.hideTimer&&clearTimeout(o.hideTimer),this.visibleToasts.splice(i,1)}const r=this.dedupeMap.get(e.dedupeKey);r&&r.toastEl===n&&(r.toastEl=null),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n),this.processQueue()},this.motionQuery&&this.motionQuery.matches?0:250)},updateToastCount(n){if(n)if(n.toastEl){const e=n.toastEl.querySelector(".toast-count"),t=n.toastEl.querySelector(".toast-content");if(n.count>1){if(e)e.textContent=`\xD7${n.count}`,e.setAttribute("aria-label",`${n.count} occurrences`);else if(t){const r=document.createElement("span");r.className="toast-count",r.textContent=`\xD7${n.count}`,r.setAttribute("aria-label",`${n.count} occurrences`),t.appendChild(r)}}else e&&e.parentNode&&e.parentNode.removeChild(e);const i=this.visibleToasts.find(r=>r.toastEl===n.toastEl);i&&i.payload.duration!==null&&(i.hideTimer&&clearTimeout(i.hideTimer),i.remaining=Math.max(i.payload.duration,this.defaultDuration),i.startedAt=Date.now(),i.hideTimer=setTimeout(()=>{this.dismissToast(i.toastEl,i.payload,"timeout")},i.remaining))}else n.payload&&(n.payload.count=n.count)},getDedupeKey(n){return`${n.type}::${n.message}::${n.action?n.action.label:""}`}}),window.NotificationManager||Logger.warn("MANAGERS","NotificationManager is not loaded before managers.js"),window.TabManager={configs:{mappings:{name:"Mappings",loadFunction:"loadMappings",clearFunction:"clearMappingFilters"},requests:{name:"Requests",loadFunction:"loadRequests",clearFunction:"clearRequestFilters"},scenarios:{name:"Scenarios",loadFunction:"loadScenarios",clearFunction:null}},getCurrentTab(){const n=document.querySelector(".tab-link.active");if(n){const e=n.getAttribute("onclick");if(e){const t=e.match(/showTab\(['"](\w+)['"]\)/);if(t)return t[1]}}return"mappings"},async refresh(n){const e=this.configs[n];if(!e){Logger.warn("MANAGERS",`Tab config not found: ${n}`);return}try{const t=window[e.loadFunction];typeof t=="function"?(await t(),Logger.info("MANAGERS",`${e.name} refreshed`)):Logger.warn("MANAGERS",`Load function not found: ${e.loadFunction}`)}catch(t){Logger.error("MANAGERS",`Error refreshing ${e.name}:`,t),NotificationManager.error(`Failed to refresh ${e.name}: ${t.message}`)}},clearFilters(n){const e=this.configs[n];if(!(!e||!e.clearFunction))try{const t=window[e.clearFunction];typeof t=="function"&&(t(),Logger.info("MANAGERS",`${e.name} filters cleared`))}catch(t){Logger.error("MANAGERS",`Error clearing ${e.name} filters:`,t)}}},window.FilterManager={saveFilterState(n,e){try{const t=`imock-filters-${n}`;localStorage.setItem(t,JSON.stringify(e))}catch(t){Logger.warn("MANAGERS","Failed to save filter state:",t)}},loadFilterState(n){try{const e=`imock-filters-${n}`,t=localStorage.getItem(e);return t?JSON.parse(t):{}}catch(e){return Logger.warn("MANAGERS","Failed to load filter state:",e),{}}},applyMappingFilters(){typeof this._applyMappingFilters=="function"&&this._applyMappingFilters()},flushMappingFilters(){this._applyMappingFilters&&typeof this._applyMappingFilters.flush=="function"&&this._applyMappingFilters.flush()},applyRequestFilters(){typeof this._applyRequestFilters=="function"&&this._applyRequestFilters()},flushRequestFilters(){this._applyRequestFilters&&typeof this._applyRequestFilters.flush=="function"&&this._applyRequestFilters.flush()},restoreFilters(n){if(n==="mappings"){const e=getFilterFromURL("mappings");if(e){const t=document.getElementById("filter-query");return t&&(t.value=e),{query:e}}else{const t=this.loadFilterState(n);if(t.query){const i=document.getElementById("filter-query");i&&(i.value=t.query)}return t}}else if(n==="requests"){const e=getFilterFromURL("requests");if(e){const s=document.getElementById("req-filter-query");if(s)return s.value=e,{query:e}}const t=this.loadFilterState(n),i=document.getElementById("req-filter-query");i&&t.query&&(i.value=t.query);const r=document.getElementById("req-filter-from"),o=document.getElementById("req-filter-to");return r&&(r.value=t.from||""),o&&(o.value=t.to||""),t}return{}},hasURLFilters(n){const e=this.getFiltersFromURL(n);return Object.values(e).some(t=>t!=="")}},window.FilterPresetsManager={getAllPresets(){try{const n=localStorage.getItem("imock-filter-presets-custom");return n?JSON.parse(n):{}}catch(n){return Logger.warn("MANAGERS","Failed to load custom presets:",n),{}}},applyPreset(n,e="mappings"){const i=this.getAllPresets()[n];if(!i){Logger.warn("MANAGERS",`Preset not found: ${n}`);return}if(e==="mappings"){const r=document.getElementById("filter-method"),o=document.getElementById("filter-url"),s=document.getElementById("filter-status");r&&(r.value=i.filters.method||""),o&&(o.value=i.filters.query||""),s&&(s.value=i.filters.status||""),typeof window.applyFilters=="function"&&window.applyFilters(),i.filters.method&&typeof window.syncFilterTabsFromSelect=="function"&&window.syncFilterTabsFromSelect("mapping",i.filters.method),typeof NotificationManager<"u"&&NotificationManager.info(`Applied preset: ${i.name}`)}},saveCustomPreset(n,e){try{const t=this.getCustomPresets();t[n]=e,localStorage.setItem("imock-filter-presets-custom",JSON.stringify(t)),typeof NotificationManager<"u"&&NotificationManager.success(`Preset "${e.name}" saved`),typeof window.renderFilterPresets=="function"&&window.renderFilterPresets()}catch(t){Logger.error("MANAGERS","Failed to save preset:",t),typeof NotificationManager<"u"&&NotificationManager.error("Failed to save preset")}},getCustomPresets(){try{const n=localStorage.getItem("imock-filter-presets-custom");return n?JSON.parse(n):{}}catch(n){return Logger.warn("MANAGERS","Failed to load custom presets:",n),{}}},deleteCustomPreset(n){try{const e=this.getCustomPresets();delete e[n],localStorage.setItem("imock-filter-presets-custom",JSON.stringify(e)),typeof NotificationManager<"u"&&NotificationManager.success("Preset deleted"),typeof window.renderFilterPresets=="function"&&window.renderFilterPresets()}catch(e){Logger.error("MANAGERS","Failed to delete preset:",e),typeof NotificationManager<"u"&&NotificationManager.error("Failed to delete preset")}},getCurrentFiltersAsPreset(n="mappings"){return n==="mappings"?{method:document.getElementById("filter-method")?.value||"",query:document.getElementById("filter-url")?.value||"",status:document.getElementById("filter-status")?.value||""}:{}}};function updateURLFilterParams(n,e="mappings"){if(!window.history||!window.history.replaceState)return;const t=new URL(window.location.href),i=`${e}_filter`;n?t.searchParams.set(i,n):t.searchParams.delete(i),window.history.replaceState({},"",t.toString())}function getFilterFromURL(n="mappings"){const e=new URLSearchParams(window.location.search),t=`${n}_filter`;return e.get(t)}function getActiveTabFromURL(){return new URLSearchParams(window.location.search).get("tab")}window.updateURLFilterParams=updateURLFilterParams,window.getFilterFromURL=getFilterFromURL,window.getActiveTabFromURL=getActiveTabFromURL,Logger.info("MANAGERS","Managers.js loaded - NotificationManager, TabManager, FilterManager"),(function(){const n=Date.now(),e=(s=0)=>new Date(n-s).toISOString(),t=[{id:"demo-mapping-products-list",name:"List products",priority:1,request:{method:"GET",urlPath:"/api/products",headers:{Accept:"application/json"}},response:{status:200,headers:{"Content-Type":"application/json"},jsonBody:{items:[{id:"sku-1000",name:"Demo Sneakers",price:129.99},{id:"sku-1001",name:"Demo Backpack",price:89.5}]}},metadata:{created:e(1e3*60*60*6),edited:e(1e3*60*60*2),source:"demo-seed",tags:["catalog","demo"]}},{id:"demo-mapping-create-order",name:"Create order",priority:2,persistent:!0,request:{method:"POST",urlPath:"/api/orders",bodyPatterns:[{matchesJsonPath:"$.items[*].sku"}]},response:{status:201,fixedDelayMilliseconds:120,headers:{"Content-Type":"application/json",Location:"/api/orders/90001"},jsonBody:{orderId:"90001",status:"processing",estimatedDelivery:e(-1e3*60*15)}},metadata:{created:e(1e3*60*60*12),edited:e(1e3*60*45),scenarioName:"checkout-flow",source:"demo-seed"}},{id:"demo-mapping-update-profile",name:"Update profile",priority:3,request:{method:"PUT",urlPattern:"/api/users/\\d+",headers:{"X-Demo-Auth":"Bearer ***"}},response:{status:204,headers:{"X-Demo-Trace":"profile-update"}},metadata:{created:e(1e3*60*30),edited:e(1e3*60*15),source:"demo-seed",tags:["profile"]}},{id:"demo-mapping-delete-session",name:"Delete session",priority:4,request:{method:"DELETE",urlPathPattern:"/api/sessions/.*"},response:{status:202,headers:{"Retry-After":"30"},jsonBody:{status:"scheduled"}},metadata:{created:e(1e3*60*60*3),source:"demo-seed"}}],i=[{id:"demo-request-001",wasMatched:!0,request:{method:"GET",url:"/api/products",urlPath:"/api/products",loggedDate:e(1e3*60*8),headers:{Accept:["application/json"],Host:["demo.wiremock.local"]},clientIp:"192.168.10.14"},responseDefinition:{status:200,headers:{"Content-Type":"application/json"},body:JSON.stringify({items:[{id:"sku-1000"},{id:"sku-1001"}]})}},{id:"demo-request-002",wasMatched:!1,request:{method:"POST",url:"/api/orders",loggedDate:e(1e3*60*5),body:JSON.stringify({items:[]}),headers:{"Content-Type":["application/json"],Host:["demo.wiremock.local"]},clientIp:"192.168.10.18"},responseDefinition:{status:404,body:"No matching mapping found",headers:{"Content-Type":"text/plain"}}},{id:"demo-request-003",wasMatched:!0,request:{method:"PATCH",url:"/api/orders/90001",loggedDate:e(1e3*60*3),body:JSON.stringify({status:"cancelled"}),headers:{"Content-Type":["application/json"],"X-Demo-Auth":["Bearer demo-token"]},clientIp:"192.168.10.20"},responseDefinition:{status:409,body:JSON.stringify({message:"Order already fulfilled"}),headers:{"Content-Type":"application/json"}}},{id:"demo-request-004",wasMatched:!0,request:{method:"DELETE",url:"/api/sessions/abc123",loggedDate:e(1e3*60*2),headers:{"X-Demo-Auth":["Bearer demo-token"],Host:["demo.wiremock.local"]},clientIp:"192.168.10.22"},responseDefinition:{status:202,body:"Session deletion scheduled",headers:{"Retry-After":"30"}}}],r={generatedAt:e()},o=s=>JSON.parse(JSON.stringify(s));window.DemoData={isAvailable(){return t.length>0||i.length>0},getMappingsPayload(){return{mappings:o(t),meta:{...r},__source:"demo"}},getRequestsPayload(){return{requests:o(i),meta:{...r},__source:"demo"}},getDataset(){return{mappings:o(t),requests:o(i),meta:{...r},__source:"demo"}}}})(),(function(e){const t=e,i=t.FeaturesState||{},r=1e3;t.mappingIndex instanceof Map||(t.mappingIndex=new Map),t.mappingTabTotals??(t.mappingTabTotals={all:0,get:0,post:0,put:0,patch:0,delete:0}),t.requestTabTotals??(t.requestTabTotals={all:0,matched:0,unmatched:0}),t.pendingDeletedIds instanceof Set||(t.pendingDeletedIds=new Set),t.deletionTimeouts instanceof Map||(t.deletionTimeouts=new Map),t.isDemoMode??(t.isDemoMode=!1),t.demoModeAnnounced??(t.demoModeAnnounced=!1),t.demoModeLastError??(t.demoModeLastError=null);let o=null;function s(g="automatic"){t.isDemoMode=!0,t.demoModeReason=g,!t.demoModeAnnounced&&t.NotificationManager?.info&&(t.NotificationManager.info("WireMock API unreachable. Showing demo data so the interface stays interactive."),t.demoModeAnnounced=!0)}function c(g){if(!g||typeof g!="object")return;t.mappingIndex instanceof Map||(t.mappingIndex=new Map);const w=new Set;["id","uuid","stubMappingId","stubId","mappingId"].forEach(A=>{g[A]&&w.add(String(g[A]).trim())}),g.metadata?.id&&w.add(String(g.metadata.id).trim()),w.forEach(A=>{A&&t.mappingIndex.set(A,g)})}function l(g){t.mappingIndex instanceof Map?t.mappingIndex.clear():t.mappingIndex=new Map,Array.isArray(g)&&g.forEach(c)}function d(g=[]){const w={all:0,get:0,post:0,put:0,patch:0,delete:0};return(!Array.isArray(g)||g.length===0)&&(g=t.MappingsStore?.getAll?t.MappingsStore.getAll():[]),!Array.isArray(g)||g.length===0||(w.all=g.length,g.forEach(A=>{const N=(A?.request?.method||"").toLowerCase();Object.prototype.hasOwnProperty.call(w,N)&&(w[N]+=1)})),w}function m(){const g=t.MappingsStore?.getAll?t.MappingsStore.getAll():[];t.mappingTabTotals=d(g)}function h(g=[]){const w={all:0,matched:0,unmatched:0};return!Array.isArray(g)||g.length===0||(w.all=g.length,g.forEach(A=>{A?.wasMatched!==!1?w.matched+=1:w.unmatched+=1})),w}function S(){const g=t.MappingsStore?.getAllRequests?t.MappingsStore.getAllRequests():[];t.requestTabTotals=h(g),typeof t.updateRequestTabCounts=="function"&&t.updateRequestTabCounts()}function I(g){if(!(t.mappingIndex instanceof Map))return;const w=typeof g=="object"?g:t.mappingIndex.get(g);if(w)for(const[A,N]of t.mappingIndex.entries())(N===w||A===g)&&t.mappingIndex.delete(A)}async function T({force:g=!1}={}){if(o){if(!g)return Logger.debug("STATE","fetchMappingsFromServer: reusing in-flight request"),o;try{Logger.debug("STATE","fetchMappingsFromServer: waiting for in-flight request before force refresh");const A=await o;if(Date.now()-(t._lastMappingsFetchTime||0)<r)return Logger.debug("STATE","fetchMappingsFromServer: reusing just-completed result"),A}catch(A){Logger.warn("STATE","fetchMappingsFromServer: previous request failed, starting a new one",A)}}const w=(async()=>{try{const A=await t.apiFetch(t.ENDPOINTS.MAPPINGS);return t._lastMappingsFetchTime=Date.now(),A}catch(A){throw t.demoModeLastError=A,A}finally{o===w&&(o=null)}})();return o=w,w}function v(g,w,A={}){try{if(!g){Logger.warn("STATE","updateOptimisticCache: no mapping provided");return}const N=g.id||g.uuid;if(w==="delete"){if(!N){Logger.warn("STATE","updateOptimisticCache: delete operation requires mapping ID");return}t.MappingsStore?.items instanceof Map&&(t.MappingsStore.items.delete(N),typeof t.MappingsStore?.addPending=="function"&&t.MappingsStore.addPending({id:N,type:"delete",payload:null,optimisticMapping:null}),typeof t.MappingsStore.rebuildIndexes=="function"&&t.MappingsStore.rebuildIndexes()),t.cacheLastUpdate=Date.now(),typeof t.refreshMappingsFromCache=="function"&&t.refreshMappingsFromCache(),Logger.info("STATE","Deleted mapping from optimistic cache:",N);return}if(!N){Logger.warn("STATE","updateOptimisticCache: mapping must have an id or uuid");return}if(t.MappingsStore?.items instanceof Map){const D=t.MappingsStore.items.get(N),V=D&&w==="update"?{...D,...g}:g;t.MappingsStore.items.set(N,V),A.queueMode==="add"&&typeof t.MappingsStore?.addPending=="function"?t.MappingsStore.addPending({id:N,type:w,payload:g,optimisticMapping:V}):A.queueMode==="confirm"&&typeof t.MappingsStore?.confirmPending=="function"&&t.MappingsStore.confirmPending(N),typeof t.MappingsStore.rebuildIndexes=="function"&&t.MappingsStore.rebuildIndexes()}t.cacheLastUpdate=Date.now(),typeof t.refreshMappingsFromCache=="function"&&t.refreshMappingsFromCache(),Logger.info("STATE",`[updateOptimisticCache] ${w} mapping:`,N)}catch(N){Logger.error("STATE","updateOptimisticCache failed:",N)}}if(i.markDemoModeActive=s,i.addMappingToIndex=c,i.rebuildMappingIndex=l,i.computeMappingTabTotals=d,i.refreshMappingTabSnapshot=m,i.computeRequestTabTotals=h,i.refreshRequestTabSnapshot=S,i.removeMappingFromIndex=I,i.fetchMappingsFromServer=T,i.updateOptimisticCache=v,t.markDemoModeActive=s,t.addMappingToIndex=c,t.rebuildMappingIndex=l,t.computeMappingTabTotals=d,t.refreshMappingTabSnapshot=m,t.computeRequestTabTotals=h,t.refreshRequestTabSnapshot=S,t.removeMappingFromIndex=I,t.fetchMappingsFromServer=T,t.updateOptimisticCache=v,t.FeaturesState=i,Logger.info("STATE","state.js loaded - State management functions registered"),typeof t.dispatchEvent=="function"){let g;typeof t.CustomEvent=="function"?g=new CustomEvent("features:state-ready",{detail:{state:i}}):typeof document<"u"&&document.createEvent&&(g=document.createEvent("Event"),g.initEvent("features:state-ready",!1,!1),g.detail={state:i}),g&&t.dispatchEvent(g)}})(typeof window<"u"?window:globalThis);const Utils={escapeHtml:n=>typeof n!="string"?String(n):n.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[e]),normalizeScenarioName:(n,e="_")=>{if(n==null)return{original:n,normalized:n,changed:!1,cleared:!1,hadWhitespace:!1};const t=typeof n=="string"?n:String(n),i=/\s/.test(t),r=t.trim().replace(/\s+/g,e);return{original:t,normalized:r,changed:r!==t,cleared:!!t&&!r,hadWhitespace:i}},formatJson:(n,e="Invalid JSON",t=1e3)=>{try{const i=JSON.stringify(n,null,2);return i.length>t?i.substring(0,t)+`
... (truncated - `+(i.length-t)+" more characters)":i}catch{return e}},parseRequestTime:n=>{if(!n)return new Date().toLocaleString("en-US");try{const e=new Date(typeof n=="number"?n>1e12?n:n*1e3:n);return isNaN(e.getTime())?`Invalid: ${n}`:e.toLocaleString("en-US")}catch{return`Invalid: ${n}`}},getStatusClass:n=>{const e=parseInt(n)||0;return e>=200&&e<300?"success":e>=300&&e<400?"redirect":e>=400&&e<500?"client-error":e>=500?"server-error":"unknown"},formatDateTime:n=>{const e=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getDate()).padStart(2,"0"),r=String(n.getHours()).padStart(2,"0"),o=String(n.getMinutes()).padStart(2,"0");return`${e}-${t}-${i}T${r}:${o}`},isFunction:n=>typeof n=="function",safeCall:(n,...e)=>{if(typeof n=="function")return n(...e)},toggleElement:(n,e)=>{n&&(e?n.classList.remove("hidden"):n.classList.add("hidden"))},showElement:n=>{n&&n.classList.remove("hidden")},hideElement:n=>{n&&n.classList.add("hidden")}},escapeHtml=Utils.escapeHtml;window.Utils=Utils,window.escapeHtml=escapeHtml,(function(){if(window.SettingsStore)return;const e=()=>{const o=window.Utils?.safeCall?.(window.readWiremockSettings);if(o)return o;try{const s=localStorage.getItem("wiremock-settings");if(!s)return{};const c=JSON.parse(s),l=window.Utils?.safeCall?.(window.normalizeWiremockSettings,c);return l||(c&&typeof c=="object"?c:{})}catch(s){return Logger.warn("UI","Failed to parse stored settings, falling back to defaults:",s),{}}},t=o=>{const s=(o||"").trim();if(!s)return{headers:{},raw:""};try{const c=JSON.parse(s);if(!c||typeof c!="object"||Array.isArray(c))throw new Error("Custom headers must be a JSON object.");return{headers:c,raw:s}}catch{const l=s.split(/\n+/),d={};let m=!0;for(const h of l){if(!h.trim())continue;const S=h.indexOf(":");if(S===-1){m=!1;break}const I=h.slice(0,S).trim(),T=h.slice(S+1).trim();if(!I){m=!1;break}d[I]=T}if(m&&Object.keys(d).length>0)return{headers:d,raw:s};throw new Error('Custom headers must be valid JSON or "Key: Value" pairs.')}},i=o=>{if(!o)return"";if(o.customHeadersRaw)return o.customHeadersRaw;if(o.customHeaders&&typeof o.customHeaders=="object"&&!Array.isArray(o.customHeaders))try{return JSON.stringify(o.customHeaders,null,2)}catch(s){Logger.warn("UI","Failed to serialize custom headers:",s)}return""},r=o=>!!(o&&o.host&&o.port&&o.autoConnect!==!1);window.SettingsStore={getStoredSettings:e,parseCustomHeadersInput:t,serializeCustomHeaders:i,shouldAutoConnect:r}})(),(function(e){const t="imock-custom-templates",i={FORM:"template-selector",EDITOR:"editor-template-selector"},r={GALLERY:"template-gallery-modal",PREVIEW:"template-preview-modal"},o=[{id:"happy-path",icon:"\u2713",title:"Happy path",subtitle:"Client flows succeed",color:"#10b981",description:"Standard successful API responses"},{id:"errors",icon:"\u26A0",title:"Errors",subtitle:"Client handles failures correctly",color:"#f59e0b",description:"HTTP errors and validation cases"},{id:"faults",icon:"\u26A1",title:"Network issues",subtitle:"Timeouts, disconnects, slow responses",color:"#ef4444",description:"Network fault simulation"},{id:"scenarios",icon:"\u21BB",title:"Scenarios",subtitle:"Stateful steps and retries",color:"#8b5cf6",description:"Changing service behaviour"},{id:"dynamic",icon:"\u2387",title:"Dynamic response",subtitle:"Response templating and conditions",color:"#3b82f6",description:"Response depends on request"},{id:"matching",icon:"\u{1F3AF}",title:"Request Matching",subtitle:"URL, headers, body, JSONPath",color:"#06b6d4",description:"Advanced request matching"},{id:"webhooks",icon:"\u{1F4E4}",title:"Webhooks",subtitle:"Asynchronous callbacks",color:"#ec4899",description:"Outgoing HTTP callbacks"},{id:"proxy",icon:"\u21C4",title:"Proxy & Record",subtitle:"Proxying and recording",color:"#14b8a6",description:"Working against real APIs"},{id:"custom",icon:"\u2605",title:"My templates",subtitle:"Saved by you",color:"#0ea5e9",description:"Personal templates you created"}],s="empty-mapping-skeleton",c={step:"goals",goalId:null,selectedTemplateId:null,searchQuery:"",activeTags:[],showPopularOnly:!1};let l="form";const d={templateId:null,target:null};let m="",h=null;const S={handler:null,label:null,mode:"mapping"};function I(){const u=document.getElementById("method"),E=document.getElementById("url-pattern"),C=document.getElementById("editor-method"),O=document.getElementById("editor-url"),k=u?.value||C?.value,q=E?.value||O?.value;return{method:(k||"GET").toUpperCase(),urlPath:q||"/api/example"}}function T(u=I()){const E={method:(u?.method||"GET").toUpperCase(),urlPath:u?.urlPath||"/api/example"};return{name:"Empty mapping",request:{method:E.method,urlPath:E.urlPath},response:{status:200}}}function v(u){return A(T(u))}function g(){const u=I(),E=v(u);return{id:s,title:"Empty mapping",description:"Create a minimal stub and fill in the request/response yourself.",category:"happy-path",highlight:`${E.request.method} \xB7 ${E.request.urlPath}`,feature:{path:["response","status"],label:"response.status"},content:E}}function w(u,E="info"){const C=e.NotificationManager;if(C&&typeof C[E]=="function"){C[E](u);return}console[E==="error"?"error":"log"](`[TEMPLATES] ${u}`)}function A(u){try{if(typeof structuredClone=="function")return structuredClone(u)}catch(E){Logger.warn("TEMPLATES","Failed to structuredClone, falling back to JSON:",E)}try{return JSON.parse(JSON.stringify(u))}catch(E){if(Logger.warn("TEMPLATES","Failed to JSON clone value, returning shallow copy:",E),u&&typeof u=="object")return Array.isArray(u)?[...u]:{...u}}return u}function N(u,E){d.templateId=u||null,d.target=u?E:null,V()}function D(){return!!d.templateId&&(!d.target||d.target==="editor")}function V(){H(D())}function H(u){const E=document.getElementById("update-mapping-btn");if(!E)return;const C=E.querySelector?.(".btn-label")||E;if(u){if(S.mode==="template-save")return;S.handler||(S.handler=E.onclick||(typeof e.updateMapping=="function"?O=>e.updateMapping(O):null)),!S.label&&C&&(S.label=C.textContent||"Update Mapping"),E.onclick=O=>(O?.preventDefault?.(),qe({skipNamePrompt:!0,reuseExistingMetadata:!0})),C&&(C.textContent="Save template"),E.setAttribute("data-template-edit-mode","true"),S.mode="template-save";return}S.mode==="template-save"&&(E.onclick=S.handler||E.onclick,C&&S.label&&(C.textContent=S.label),E.removeAttribute("data-template-edit-mode"),S.mode="mapping")}function de(u){["id","uuid","stubMappingId","stubId","mappingId"].forEach(E=>delete u[E]),u.metadata&&delete u.metadata.id}function be(u){if(!u||typeof u!="object"||!Object.prototype.hasOwnProperty.call(u,"scenarioName"))return null;const E=k=>{if(k==null)return{original:k,normalized:k,changed:!1,cleared:!1,hadWhitespace:!1};const q=typeof k=="string"?k:String(k),_=/\s/.test(q),X=q.trim().replace(/\s+/g,"_");return{original:q,normalized:X,changed:X!==q,cleared:!!q&&!X,hadWhitespace:_}},O=(typeof e?.Utils?.normalizeScenarioName=="function"?e.Utils.normalizeScenarioName:E)(u.scenarioName);return!O?.changed||!O?.hadWhitespace?null:(O.cleared?delete u.scenarioName:u.scenarioName=O.normalized,{original:O.original,normalized:O.normalized,cleared:O.cleared})}function x(u,E={}){if(!u||typeof u!="object")return null;const{source:C="ui",seed:O=I(),scenarioFixes:k}=E,q=new Date().toISOString(),_=A(u);de(_),bt(_,O);const X=be(_);return X&&k instanceof Map&&!k.has(X.original)&&k.set(X.original,X),_.metadata={..._.metadata||{},created:_.metadata?.created||q,edited:q,source:_.metadata?.source||C},_}async function j(u,E={}){const{openMode:C="inline",source:O="ui",successMessageFactory:k}=E,q=Array.isArray(u)?u:[u],_=new Map,X=q.map(B=>x(B,{source:O,scenarioFixes:_})).filter(Boolean);if(_.size){const B=Array.from(_.values()).slice(0,3).map(ne=>ne.cleared?"cleared":`"${ne.original}" \u2192 "${ne.normalized}"`).join(", ");w(`Scenario name cannot contain spaces. Normalized: ${B}`,"warning")}if(!X.length)return w("No valid mapping payloads to create","warning"),{success:!1,createdIds:[]};const le=X.map((B,ne)=>({index:ne,error:Tt(B)})).filter(B=>!!B.error);if(le.length){const B=le[0];return w(`Mapping payload is missing required fields (entry ${B.index+1}): ${B.error}`,"error"),{success:!1,createdIds:[]}}try{const B=[],ne=[];for(let Oe=0;Oe<X.length;Oe+=1){const Et=X[Oe];try{const ze=await apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Et)}),ot=ze?.mapping||ze,at=ot?.id;if(at&&typeof updateOptimisticCache=="function")try{updateOptimisticCache(ot,"create")}catch(qt){Logger.warn("TEMPLATES","Failed to update optimistic cache after create:",qt)}at&&B.push(at)}catch(ze){ne.push({index:Oe,error:ze});break}}if(ne.length){const Oe=[];for(const ot of B)try{await apiFetch(`/mappings/${ot}`,{method:"DELETE"}),typeof updateOptimisticCache=="function"&&updateOptimisticCache({id:ot},"delete")}catch(at){Oe.push(at)}const Et=ne[0],ze=Oe.length?` Rollback issues: ${Oe.length} delete${Oe.length===1?"":"s"} failed.`:"";return w(`Failed to create mapping ${Et.index+1}/${X.length}: ${Et.error.message}.${ze}`,"error"),Logger.error("TEMPLATES","Mapping create failed",{errors:ne,rollbackErrors:Oe}),{success:!1,createdIds:[]}}const Re=B.length||X.length,$e=typeof k=="function"?k(Re):`Created ${Re} mapping${Re===1?"":"s"}`;w($e,"success");const rt=B[0];return rt&&(C==="studio"&&typeof e.editMapping=="function"?e.editMapping(rt):typeof e.openEditModal=="function"&&e.openEditModal(rt)),{success:!0,createdIds:B}}catch(B){return w(`Failed to create mapping: ${B.message}`,"error"),Logger.error("TEMPLATES","Failed to create mapping from payloads",B),{success:!1,createdIds:[]}}}function F(){let u=document.getElementById("template-name-modal");if(u)return u;u=document.createElement("div"),u.id="template-name-modal",u.className="modal hidden",u.innerHTML=`
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="template-name-title">
                <div class="modal-header">
                    <div class="modal-header-main">
                        <h3 id="template-name-title" class="modal-title">Save as template</h3>
                        <p class="modal-subtitle">Name your template to reuse it later.</p>
                    </div>
                    <button type="button" class="modal-close" aria-label="Close" data-action="close-template-name">\xD7</button>
                </div>
                <div class="modal-body">
                    <label class="form-label" for="template-name-input">Template name</label>
                    <input id="template-name-input" class="form-control" type="text" name="template-name" placeholder="My template" />
                    <p class="form-hint">Titles help you find templates quickly in the gallery.</p>
                </div>
                <div class="modal-footer">
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" data-action="cancel-template-name">Cancel</button>
                        <button type="button" class="btn btn-primary" data-action="confirm-template-name">Save template</button>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(u),u.addEventListener("click",O=>{O.target===u&&U(null)}),u.querySelectorAll('[data-action="close-template-name"], [data-action="cancel-template-name"]').forEach(O=>O.addEventListener("click",()=>U(null))),u.querySelector('[data-action="confirm-template-name"]').addEventListener("click",()=>{const k=u.querySelector("#template-name-input")?.value?.trim();U(k||null)});const C=u.querySelector("#template-name-input");return C?.addEventListener("keydown",O=>{O.key==="Enter"&&(O.preventDefault(),U(C.value.trim()||null))}),u}function U(u){document.getElementById("template-name-modal")?.classList.add("hidden"),typeof h=="function"&&(h(u),h=null)}function re(u=""){const E=F(),C=E.querySelector("#template-name-input");return C&&(C.value=u||"",setTimeout(()=>C.focus(),0)),E.classList.remove("hidden"),h&&U(null),new Promise(O=>{h=O})}const J={builtIn:null,user:null,userSignature:"",merged:null,mergedSignature:"",enriched:null,enrichedSignature:""};function se(u="all"){(u==="all"||u==="user")&&(J.user=null),J.merged=null,J.mergedSignature="",J.enriched=null,J.enrichedSignature=""}function ye(){if(J.builtIn)return[...J.builtIn];try{const u=e.MonacoTemplateLibrary?.getAll?.();return Array.isArray(u)?(J.builtIn=u.map(E=>({...E,source:"built-in"})),[...J.builtIn]):[]}catch(u){return Logger.warn("TEMPLATES","Unable to read Monaco template library:",u),[]}}function we(){const u=localStorage.getItem(t);if(J.user&&J.userSignature===u)return[...J.user];try{const E=u?JSON.parse(u):[];return J.user=Array.isArray(E)?E.map(C=>_e(C)):[],J.userSignature=u||"",[...J.user]}catch(E){return Logger.warn("TEMPLATES","Failed to read user templates from storage:",E),[]}}function _e(u){return{category:"custom",source:"user",...u,category:u?.category||"custom",source:u?.source||"user"}}function je(u){try{const E=(u||[]).filter(Boolean).map(O=>_e(O)),C=JSON.stringify(E);localStorage.setItem(t,C),J.user=[...E],J.userSignature=C,se("user")}catch(E){Logger.warn("TEMPLATES","Failed to persist user templates:",E)}}function ct(){const u=[...ye(),...we()],E=g();u.some(O=>O.id===E.id)||u.unshift(E);const C=u.map(O=>`${O.id}:${O.source||""}:${O.title||""}`).join("|");return J.merged&&J.mergedSignature===C?J.merged:(J.merged=u,J.mergedSignature=C,J.enriched=null,J.enrichedSignature="",u)}function Ke(){return ct()}function Ot(u){return Ke().find(E=>E.id===u)||null}function lt(u){const E=new Set,C=u.content||{},O=C.request||{},k=C.response||{},q=O.method||"ANY";return E.add(q),C.category&&E.add(C.category),u.category&&E.add(u.category),u.source==="user"&&E.add("custom"),(O.bodyPatterns||O.multipartPatterns)&&E.add("matching"),O.headers&&E.add("headers"),O.queryParameters&&E.add("query"),O.cookies&&E.add("cookies"),(O.urlPathPattern||O.urlPattern||O.urlPathTemplate)&&E.add("pattern"),Array.isArray(O.bodyPatterns)&&O.bodyPatterns.some(X=>X.matchesJsonPath||X.matchesXPath)&&E.add("jsonpath"),(k.proxyBaseUrl||C.proxyBaseUrl)&&E.add("proxy"),(k.serveEventListeners||C.serveEventListeners||k.postServeActions)&&E.add("webhook"),(k.transformers||C.transformers)&&E.add("templating"),(k.fixedDelayMilliseconds||k.delayDistribution||k.chunkedDribbleDelay)&&E.add("delay"),k.fault&&E.add("fault"),C.mappings&&E.add("scenario"),u.popular&&E.add("popular"),Array.from(E)}function vt(u){const E=u.content||{},C=E.response||{};return C.proxyBaseUrl||E.proxyBaseUrl?"proxy":C.fault?"fault":C.status?`${C.status}`:Array.isArray(E.mappings)&&E.mappings.length?"scenario":"200"}function yt(u){const E=u.content||{},C=E.request||{};return C.method?C.method:Array.isArray(E.mappings)&&E.mappings[0]?.request?.method?E.mappings[0].request.method:"ANY"}function dt(u){const E=yt(u),C=vt(u),O=lt(u),k=!!u.popular||["basic","integration","proxy"].includes(u.category),q=Array.isArray(u.content?.mappings)&&u.content.mappings.length>0;return{...u,method:E,outcome:C,tags:O,popular:k,isScenario:q}}function oe(){const u=ct();return J.enriched&&J.enrichedSignature===J.mergedSignature||(J.enriched=u.map(dt),J.enrichedSignature=J.mergedSignature),J.enriched}function Ce(u){const E=document.createElement("option");E.value=u.id;const C=u.title||u.name||u.id;return E.textContent=u.source==="user"?`${C} (yours)`:C,E.dataset.source=u.source||"built-in",E}function Pe(){const u=Ke();[i.FORM,i.EDITOR].forEach(E=>{const C=document.getElementById(E);if(!C)return;const O=C.value;C.innerHTML='<option value="">Select a template</option>',u.forEach(k=>C.appendChild(Ce(k))),O&&u.some(k=>k.id===O)&&(C.value=O)})}function He(u){if(u==null||u==="")return null;if(typeof u=="object")return{jsonBody:u};try{return{jsonBody:JSON.parse(u)}}catch{return{body:u}}}function Ve(u){if(!u){w("Select a template first","warning");return}const E=u.content||{},C=E.request||{},O=E.response||{},k=document.getElementById("mapping-name"),q=document.getElementById("method"),_=document.getElementById("url-pattern"),X=document.getElementById("response-status"),le=document.getElementById("response-body");k&&(k.value=E.name||u.title||u.id||""),q&&C.method&&(q.value=C.method),_&&(_.value=C.url||C.urlPath||""),X&&typeof O.status<"u"&&(X.value=O.status);const B=O.jsonBody??O.body;if(le&&typeof B<"u"){const ne=typeof B=="object"?JSON.stringify(B,null,2):String(B);le.value=ne}w(`Template "${u.title||u.id}" applied to form`,"success")}async function ut(){if(e.monacoInitializer?.isInitialized)return e.monacoInitializer;if(e.monacoInitializationPromise?.then)try{if(await e.monacoInitializationPromise,e.monacoInitializer?.isInitialized)return e.monacoInitializer}catch(u){Logger.warn("TEMPLATES","Monaco initializer failed to load in time",u)}return e.monacoInitializer}async function Qe(u){if(!u){w("Select a template first","warning");return}const E=u.content??{},C=await ut();if(C&&(typeof C.applyTemplate=="function"||typeof C.applyTemplateById=="function")){let q=!1;typeof C.applyTemplate=="function"?q=C.applyTemplate(u):q=C.applyTemplateById?.(u.id),w(q?`Template "${u.title||u.id}" applied to editor`:"Template could not be applied",q?"success":"error");return}const O=typeof E=="string"?E:JSON.stringify(E,null,2),k=document.getElementById("json-editor");if(k){k.value=O;try{const _=JSON.parse(typeof E=="string"?E:JSON.stringify(E));e.editorState&&(e.editorState.currentMapping=_,e.editorState.isDirty=!0)}catch(_){Logger.warn("TEMPLATES","Failed to parse template content into editorState:",_)}const q=document.getElementById("editor-dirty-indicator");q&&(q.style.display="inline")}w(`Template "${u.title||u.id}" applied to editor`,"success")}async function ve(u,E={}){const{openMode:C="inline"}=E;if(!u){w("Select a template first","warning");return}const O=Be(u);if(!O){w("Template content is not available","error");return}const k=Array.isArray(O)?O:[O],q=k.map((_,X)=>({index:X,error:Tt(_)})).filter(_=>!!_.error);if(q.length){const _=q[0];w(`Template is missing required fields (entry ${_.index+1}): ${_.error}`,"error");return}try{await j(k,{openMode:C,source:"template",successMessageFactory:_=>`Created ${_} mapping${_===1?"":"s"} from template`})}catch(_){w(`Failed to create mapping: ${_.message}`,"error"),Logger.error("TEMPLATES","Failed to create mapping from template",_)}finally{e.hideModal?.(r.GALLERY),e.hideModal?.(r.PREVIEW)}}function Fe(){const u=g();if(et()){ve(u,{openMode:l==="create-studio"?"studio":"inline"});return}nt(u,l)}async function Ie(){const u=await re(document.getElementById("mapping-name")?.value||"")||"";if(!u.trim()){w("Template name is required","warning");return}const E=document.getElementById("method")?.value||"GET",C=document.getElementById("url-pattern")?.value||"/api/example",O=parseInt(document.getElementById("response-status")?.value,10)||200,k=document.getElementById("response-body")?.value||"",q=!!d.templateId&&(!d.target||d.target==="form"),_=q?we().find(le=>le.id===d.templateId):null,X={id:q&&_?_.id:`user-${Date.now()}`,title:u.trim(),description:_?.description||"User template saved from mapping form",category:"custom",source:"user",content:{name:u.trim(),request:{method:E,urlPath:C},response:{status:O,...He(k)||{}}}};if(q&&_)Xe(_.id,X),N(null),w(`Template "${u.trim()}" updated`,"success");else{const le=we();le.push(X),je(le),Te({force:!0}),Pe(),w(`Template "${u.trim()}" saved`,"success"),N(null)}}async function qe(u={}){const{skipNamePrompt:E=!1,reuseExistingMetadata:C=!1}=u,O=document.getElementById("json-editor");if(!O){w("Editor not available","warning");return}const k=!!d.templateId&&(!d.target||d.target==="editor"),q=k?we().find(B=>B.id===d.templateId):null;let _="";if(k&&q&&(E||C)?_=q.title||"":_=await re(q?.title||"")||"",!_.trim()){w("Template name is required","warning");return}let X;try{X=JSON.parse(O.value)}catch{w("Cannot save template: current JSON is invalid","error");return}const le={id:k&&q?q.id:`user-${Date.now()}`,title:_.trim(),description:C&&q?.description||q?.description||"User template saved from JSON editor",category:"custom",source:"user",content:X};if(k&&q)Xe(q.id,le),N(null),w(`Template "${_.trim()}" updated`,"success");else{const B=we();B.push(le),je(B),Te({force:!0}),Pe(),w(`Template "${_.trim()}" saved`,"success"),N(null)}}function Xe(u,E={}){if(!u)return null;const C=we(),O=C.findIndex(_=>_.id===u);if(O===-1)return null;const k=C[O],q=_e({...k,...E.title?{title:E.title}:{},...E.description?{description:E.description}:{},...E.content?{content:E.content}:{}});return C[O]=q,je(C),Te({force:!0}),Pe(),q}async function Ze(u,E={}){const C=we().find(k=>k.id===u);if(!C)return w("Template not found","warning"),!1;const O=E.target||(document.getElementById("json-editor")?"editor":"form");return N(u,O),O==="editor"?(nt(C,"editor"),w("Template loaded into JSON Studio. Save to keep changes.","info"),document.getElementById("update-mapping-btn")?.focus?.()):(nt(C,"form"),w("Template loaded into mapping form. Update and save to keep changes.","info"),document.getElementById("save-template-btn")?.focus?.()),!0}function pt(u,E={}){const{skipConfirm:C=!1}=E;if(!u)return!1;const O=we(),k=O.find(_=>_.id===u);if(!k||!C&&typeof e.confirm=="function"&&!e.confirm(`Delete template "${k.title||k.id}"? This cannot be undone.`))return!1;const q=O.filter(_=>_.id!==u);return je(q),Te({force:!0}),Pe(),w(`Template "${k.title||k.id}" deleted`,"info"),d.templateId===u&&N(null),!0}function wt(u,E){return E?(Array.isArray(E)?E:String(E).split(".").map(O=>O.match(/^\d+$/)?Number(O):O)).reduce((O,k)=>O&&typeof O=="object"?O[k]:void 0,u):void 0}function St(u){if(u===null)return"null";if(typeof u>"u")return"";if(typeof u=="string")return u.length>64?`${u.slice(0,61)}\u2026`:u;if(typeof u=="number"||typeof u=="boolean")return String(u);try{const E=JSON.stringify(u);return E.length>80?`${E.slice(0,77)}\u2026`:E}catch(E){return Logger.warn("TEMPLATES","Failed to serialise feature value",E),""}}function Ue(u){if(!u||!u.feature)return null;const E=u.feature.path||u.feature,C=u.feature.label||(Array.isArray(E)?E.join("."):String(E)),O=wt(u.content,E);return typeof O>"u"?null:{label:C,value:St(O)}}function Lt(u){if(!u)return"";if(u.highlight)return u.highlight;const E=[];return u.content?.request?.method&&E.push(u.content.request.method),(u.content?.request?.url||u.content?.request?.urlPath)&&E.push(u.content.request.url||u.content.request.urlPath),E.join(" \xB7 ")}function Pt(u){try{const E=u.content?u.content:{};if(typeof E=="string")return E;const k=JSON.stringify(E,null,2).split(`
`).slice(0,24).join(`
`);return k.length>1280?`${k.slice(0,1279)}\u2026`:k}catch{return"[unavailable template preview]"}}function G(u){const E=typeof u=="string"?u:String(u??"");if(typeof navigator<"u"&&navigator.clipboard?.writeText)return navigator.clipboard.writeText(E).then(()=>!0).catch(()=>C(E));return Promise.resolve(C(E));function C(O){try{const k=document.createElement("textarea");return k.value=O,k.setAttribute("readonly",""),k.style.position="absolute",k.style.left="-9999px",document.body.appendChild(k),k.select(),document.execCommand("copy"),document.body.removeChild(k),!0}catch(k){return Logger.warn("TEMPLATES","Clipboard fallback failed:",k),!1}}}function et(u=l){return typeof u=="string"&&u.startsWith("create")}function bt(u,E){u.request||(u.request={}),u.response||(u.response={}),u.request.method||(u.request.method=E.method||"ANY"),u.request.url||u.request.urlPath||u.request.urlPattern||u.request.urlPathPattern||u.request.urlPathTemplate||(u.request.urlPath=E.urlPath||E.url||"/api/example"),typeof u.response.status!="number"&&!("fault"in u.response)&&(u.response.status=200)}function Be(u){if(!u)return null;let E=u.content??{};if(typeof E=="string")try{E=JSON.parse(E)}catch(_){Logger.warn("TEMPLATES","Failed to parse string template content:",_),E={}}const C=new Date().toISOString(),O=_=>{["id","uuid","stubMappingId","stubId","mappingId"].forEach(X=>delete _[X])},k=I();if(Array.isArray(E?.mappings))return E.mappings.map((X,le)=>{const B=JSON.parse(JSON.stringify(X||{}));return O(B),B.name=B.name||`${u.title||u.id||"Scenario mapping"} #${le+1}`,bt(B,k),be(B),B.metadata={...B.metadata||{},created:B.metadata?.created||C,edited:C,source:B.metadata?.source||"template"},B});const q=JSON.parse(JSON.stringify(E||{}));return O(q),q.name||(q.name=u.title||u.id||"New mapping"),bt(q,k),be(q),q.metadata={...q.metadata||{},created:q.metadata?.created||C,edited:C,source:q.metadata?.source||"template"},q}function Tt(u){if(!u||typeof u!="object")return"Mapping payload is empty";const E=u.request||{},C=u.response||{};if(!E.method)return"request.method is required";if(!!!(E.url||E.urlPath||E.urlPattern||E.urlPathPattern||E.urlPathTemplate))return"request URL or pattern is required";const k=typeof C.status=="number",q=!!C.fault;return!k&&!q?"response.status is required":null}function tt(){const u=document.getElementById("edit-mapping-modal");return u?(typeof e.showModal=="function"?e.showModal("edit-mapping-modal"):(u.classList.remove?.("hidden"),u.style.display="flex"),!0):!1}function nt(u,E=l){if(u){if(E==="create-inline"){ve(u,{openMode:"inline"});return}if(E==="create-studio"){ve(u,{openMode:"studio"});return}E==="editor"?(tt(),Qe(u)):Ve(u),e.hideModal?.(r.GALLERY),e.hideModal?.(r.PREVIEW)}}function Ee(u){const E=u.map(C=>`${C.id}:${C.source||""}:${C.title||""}:${C.method}:${C.outcome}`).join("|");return[l,c.goalId||"none",c.searchQuery,c.activeTags.join(","),c.showPopularOnly,E].join("|")}function ft(u,E){return E?E==="happy-path"?u.outcome.startsWith("2"):E==="errors"?["4","5"].includes(u.outcome.charAt(0)):E==="faults"?u.tags.includes("fault")||u.tags.includes("delay"):E==="scenarios"?u.isScenario:E==="dynamic"?u.tags.includes("templating"):E==="matching"?u.tags.includes("matching")||u.tags.includes("pattern")||u.tags.includes("jsonpath"):E==="webhooks"?u.tags.includes("webhook"):E==="proxy"?u.tags.includes("proxy"):E==="custom"?u.source==="user":!0:!0}function Ct(u){return oe().filter(E=>ft(E,u))}function kt(u,E){u.innerHTML=`
            <div class="template-wizard__grid template-wizard__goals"></div>
            <div class="template-wizard__actions">
                <button type="button" class="btn btn-ghost" data-action="show-all">Show all templates</button>
                <div class="template-wizard__actions-right">
                    <button type="button" class="btn btn-primary" data-action="create-empty">Create empty</button>
                </div>
            </div>
        `;const C=u.querySelector(".template-wizard__grid");o.forEach(O=>{const k=E.filter(_=>ft(_,O.id)).length,q=document.createElement("button");q.type="button",q.className="template-goal",q.dataset.goalId=O.id,q.innerHTML=`
                <span class="template-goal__icon" aria-hidden="true">${O.icon}</span>
                <span class="template-goal__title">${O.title}</span>
                <span class="template-goal__subtitle">${O.subtitle}</span>
                <span class="template-goal__count">${k} templates</span>
            `,q.style.setProperty("--goal-color",O.color),q.disabled=k===0,q.addEventListener("click",()=>{c.goalId=O.id,c.step="templates",c.activeTags=[],c.searchQuery="",c.showPopularOnly=!1,Te({force:!0})}),C.appendChild(q)}),u.querySelectorAll('[data-action="show-all"]').forEach(O=>{O.addEventListener("click",()=>{c.goalId=null,c.step="templates",Te({force:!0})})}),u.querySelectorAll('[data-action="create-empty"]').forEach(O=>{O.addEventListener("click",()=>{Fe()})})}function $t(u,E){const C=u.outcome==="proxy"?"proxy":u.outcome==="fault"?"fault":u.outcome,O=et(l),k=document.createElement("div");return k.className="template-card template-card--wizard",k.dataset.templateId=u.id,k.setAttribute("role","button"),k.tabIndex=0,k.innerHTML=`
            <div class="template-card__header">
                <span class="badge badge-soft" data-method="${u.method}">${u.method}</span>
                <span class="badge badge-soft" data-outcome="${u.outcome}">${C}</span>
                ${u.isScenario?`<span class="badge badge-soft badge-scenario">${u.content?.mappings?.length||0} steps</span>`:""}
                ${u.popular?'<span class="template-card__star" aria-hidden="true">\u2B50</span>':""}
            </div>
            <div class="template-card__title">${u.title||u.name||u.id}</div>
            <div class="template-card__desc">${u.description||"WireMock template"}</div>
            <div class="template-card__meta">${Lt(u)}</div>
            <div class="template-card__tags">
                ${u.tags.slice(0,4).map(q=>`<span class="chip">${q}</span>`).join("")}
            </div>
            <div class="template-card__actions">
                <button class="btn btn-primary btn-sm" type="button" data-card-action="select">${O?"Create":"Select"}</button>
                <button class="btn btn-secondary btn-sm" type="button" data-card-action="details">Details</button>
                ${u.source==="user"?'<button class="btn btn-ghost btn-sm" type="button" data-card-action="edit-template">Edit</button>':""}
                ${u.source==="user"?'<button class="btn btn-ghost btn-sm" type="button" data-card-action="delete-template">Delete</button>':""}
            </div>
        `,k.addEventListener("click",q=>{const _=q.target instanceof HTMLElement?q.target.closest("[data-card-action]"):null;if(_){q.stopPropagation();const X=_.dataset.cardAction;if(X==="edit-template"){Ze(u.id);return}if(X==="delete-template"){pt(u.id);return}}E(u)}),k.addEventListener("keydown",q=>{(q.key==="Enter"||q.key===" ")&&(q.preventDefault(),E(u))}),k}function xt(u,E){const C=Ct(c.goalId),O=Array.from(new Set(C.flatMap(B=>B.tags))).sort(),k=!c.goalId;let q=C.filter(B=>{if(c.showPopularOnly&&!B.popular||c.activeTags.length&&!c.activeTags.every(Re=>B.tags.includes(Re)))return!1;if(!c.searchQuery)return!0;const ne=c.searchQuery.toLowerCase();return(B.title||B.id).toLowerCase().includes(ne)||(B.description||"").toLowerCase().includes(ne)||B.tags.some(Re=>Re.toLowerCase().includes(ne))});u.innerHTML=`
            <div class="template-toolbar template-toolbar--wizard">
                <div class="template-toolbar__search">
                    <svg class="icon icon-16" aria-hidden="true" focusable="false"><use href="#icon-search"></use></svg>
                    <input type="search" placeholder="Search templates..." value="${c.searchQuery}" aria-label="Search templates" />
                </div>
                <div class="template-toolbar__actions">
                    <button type="button" class="btn btn-ghost btn-sm" data-action="show-all" ${k?"disabled":""}>Show all</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-action="toggle-popular" aria-pressed="${c.showPopularOnly}">\u2B50 Popular</button>
                    <button type="button" class="btn btn-primary btn-sm" data-action="create-empty">Create empty</button>
                </div>
            </div>
            <div class="template-tags" aria-label="Tags">
                ${O.map(B=>`<button type="button" class="chip chip--toggle ${c.activeTags.includes(B)?"is-active":""}" data-tag="${B}">${B}</button>`).join("")}
            </div>
            <div class="template-wizard__grid template-wizard__cards" id="template-wizard-cards"></div>
            <div class="template-info template-info--inline">
                <p class="template-info__lead">Need more examples? Visit the <a href="https://library.wiremock.org/" target="_blank" rel="noopener">official WireMock Template Library</a> and import JSON via Import/Export \u2192 Import Data.</p>
            </div>
        `;const _=u.querySelector("#template-wizard-cards"),X=document.createElement("div");X.className="history-empty",X.innerHTML="<p>No templates found</p><small>Adjust filters or import JSON from the WireMock Template Library.</small>",q.length?q.forEach(B=>{_.appendChild($t(B,ne=>{c.selectedTemplateId=ne.id,c.step="preview",Te({force:!0})}))}):_.replaceWith(X);const le=u.querySelector('input[type="search"]');le&&le.addEventListener("input",B=>{c.searchQuery=B.target.value,Te({force:!0})}),u.querySelectorAll('[data-action="toggle-popular"]').forEach(B=>{B.addEventListener("click",()=>{c.showPopularOnly=!c.showPopularOnly,Te({force:!0})})}),u.querySelectorAll('[data-action="show-all"]').forEach(B=>{B.addEventListener("click",()=>{c.goalId=null,c.step="templates",Te({force:!0})})}),u.querySelectorAll('[data-action="create-empty"]').forEach(B=>{B.addEventListener("click",()=>{Fe()})}),u.querySelectorAll("[data-tag]").forEach(B=>{B.addEventListener("click",()=>{const ne=B.dataset.tag;c.activeTags.includes(ne)?c.activeTags=c.activeTags.filter(Re=>Re!==ne):c.activeTags=[...c.activeTags,ne],Te({force:!0})})})}function it(u,E){const C=E.find(ne=>ne.id===c.selectedTemplateId);if(!C){c.step="templates",Te({force:!0});return}const O=et(l),k=Lt(C),q=Ue(C),_=Pt(C),X=C.tags||[];u.innerHTML=`
            <div class="template-preview-card">
                <div class="template-preview-card__meta">
                    <div class="template-preview-card__badges">
                        <span class="badge badge-soft" data-method="${C.method}">${C.method}</span>
                        <span class="badge badge-soft" data-outcome="${C.outcome}">${C.outcome==="proxy"?"proxy":C.outcome}</span>
                        ${C.isScenario?`<span class="badge badge-soft badge-scenario">${C.content?.mappings?.length||0} steps</span>`:""}
                    </div>
                    <h4 class="template-preview-card__title">${C.title||C.name||C.id}</h4>
                    <p class="template-preview-card__desc">${C.description||""}</p>
                    <div class="template-preview-card__summary">${k||"\u2014"}</div>
                    ${q?`<div class="template-preview-meta__row"><span class="template-preview-meta__label">${q.label}</span><code class="template-preview-meta__code">${q.value}</code></div>`:""}
                    <div class="template-preview-card__tags">${X.map(ne=>`<span class="chip">${ne}</span>`).join("")}</div>
                </div>
                <pre class="template-preview-card__code" id="template-preview-code-inline"></pre>
            </div>
            <div class="template-preview-actions template-preview-actions--wizard" id="template-preview-actions">
                <div class="template-preview-actions__primary">
                    ${O?'<button class="btn btn-primary btn-sm" type="button" data-template-action="apply">Create and open editor</button>':'<button class="btn btn-primary btn-sm" type="button" data-template-action="apply">Use template</button>'}
                    ${O?'<button class="btn btn-secondary btn-sm" type="button" data-template-action="create-studio">Create in JSON Studio</button>':""}
                    <button class="btn btn-secondary btn-sm" type="button" data-template-action="copy">Copy JSON</button>
                </div>
                ${C.source==="user"?`<div class="template-preview-actions__secondary">
                        <button class="btn btn-ghost btn-sm" type="button" data-template-action="edit-template">Edit template</button>
                        <button class="btn btn-ghost btn-sm" type="button" data-template-action="delete-template">Delete</button>
                    </div>`:""}
            </div>
        `;const le=u.querySelector("#template-preview-code-inline");le&&(le.textContent=_);const B=u.querySelector("#template-preview-actions");B&&B.addEventListener("click",async ne=>{const Re=ne.target instanceof HTMLElement?ne.target.closest("[data-template-action]"):null;if(!Re)return;const $e=Re.dataset.templateAction;if($e==="apply"){nt(C,l);return}if($e==="create-studio"){ve(C,{openMode:"studio"});return}if($e==="copy"){const rt=typeof C.content=="string"?C.content:JSON.stringify(C.content,null,2),Oe=await G(rt);w(Oe?`Template "${C.title}" copied`:"Clipboard copy failed",Oe?"success":"error")}if($e==="edit-template"){await Ze(C.id);return}$e==="delete-template"&&pt(C.id)})}function Dt(){if(c.step==="preview"){c.step="templates";return}c.step="goals",c.goalId=null,c.selectedTemplateId=null}function Te(u={}){const{force:E=!1}=u,C=document.getElementById("template-gallery-shell");if(C)try{const O=oe(),k=Ee(O);if(!E&&k===m)return;m=k;const q=c.step==="goals"?1:c.step==="templates"?2:3,_=o.find(ne=>ne.id===c.goalId),X=c.step!=="goals";C.innerHTML=`
                <div class="template-wizard">
                    <div class="template-wizard__header">
                        <div>
                            <p class="template-wizard__eyebrow">Step ${q}/3</p>
                            <h3 class="template-wizard__title">${c.step==="goals"?"Create a mapping":_?.title||"Pick a template"}</h3>
                            <p class="template-wizard__subtitle">${c.step==="goals"?"Choose the scenario that fits your testing goal":_?.description||""}</p>
                        </div>
                        <div class="template-wizard__header-actions">
                            <div class="template-wizard__progress" role="progressbar" aria-label="Wizard progress" aria-valuemin="1" aria-valuemax="3" aria-valuenow="${q}">
                                <span class="sr-only">Step ${q} of 3</span>
                                ${[1,2,3].map(ne=>`<span class="template-wizard__dot ${ne<=q?"is-active":""}" aria-current="${ne===q?"step":"false"}" aria-label="Step ${ne}"></span>`).join("")}
                            </div>
                            ${X?'<button type="button" class="btn btn-ghost btn-sm" id="template-wizard-back">\u2190 Back</button>':""}
                        </div>
                    </div>
                    <div class="template-wizard__body" id="template-wizard-body"></div>
                </div>
            `;const le=C.querySelector("#template-wizard-body");if(!le)return;O.length?c.step==="goals"?kt(le,O):c.step==="templates"?xt(le,O):it(le,O):le.innerHTML='<div class="history-empty"><p>No templates available</p><small>Add or import templates to populate this view.</small></div>';const B=C.querySelector("#template-wizard-back");B&&B.addEventListener("click",()=>{Dt(),Te({force:!0})})}catch(O){Logger.error("TEMPLATES","Failed to render template wizard",O),C.innerHTML='<div class="history-empty"><p>Templates unavailable</p><small>Reload the page or try again later.</small></div>'}}function At(u="form"){l=u,c.step="goals",c.goalId=null,c.selectedTemplateId=null,c.searchQuery="",c.activeTags=[],c.showPopularOnly=!1;try{Te({force:!0})}catch(O){Logger.error("TEMPLATES","Unable to prepare template gallery",O);const k=document.getElementById("template-gallery-shell");k&&(k.innerHTML='<div class="history-empty"><p>Templates unavailable</p><small>Reload the page or try again later.</small></div>')}if(typeof e.showModal=="function"){e.showModal(r.GALLERY);return}const C=document.getElementById(r.GALLERY);C&&(C.classList.remove("hidden"),C.style.display="flex")}function Ft(){document.querySelectorAll("[data-template-trigger]").forEach(u=>{u.addEventListener("click",E=>{E.preventDefault(),At(u.dataset.templateTarget||"form")})})}function Nt(){try{Pe(),Te()}catch(u){Logger.error("TEMPLATES","Template manager failed to initialize",u);const E=document.getElementById("template-gallery-shell");E&&(E.innerHTML='<div class="history-empty"><p>Templates unavailable</p><small>Reload the page or try again later.</small></div>')}Ft(),document.getElementById("save-template-btn")?.addEventListener("click",u=>{u.preventDefault(),Ie()}),document.getElementById("editor-save-template")?.addEventListener("click",u=>{u.preventDefault(),qe()})}e.TemplateManager={getTemplates:Ke,refresh:Pe,openGallery:Te,openGalleryForTarget:At,getTemplatesWithMeta:oe,getEmptyTemplateSeed:I,getEmptyMappingContent:v,applyTemplateToForm:Ve,applyTemplateToEditor:Qe,createMappingFromTemplate:ve,createMappingsFromPayloads:j,prepareMappingForCreation:x,createEmptyMapping:Fe,saveFormAsTemplate:Ie,saveEditorAsTemplate:qe,updateUserTemplate:Xe,editUserTemplate:Ze,deleteUserTemplate:pt},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Nt):Nt()})(typeof window<"u"?window:globalThis),(function(){const e={GET:1,POST:2,PUT:3,PATCH:4,DELETE:5},t=(S,...I)=>{if(!S||typeof S!="object")return"";for(const T of I){const v=T.includes(".")?T.split(".").reduce((g,w)=>g?.[w],S):S[T];if(v!=null)return String(v)}return""},i=S=>{if(S==null)return"";try{const I=typeof S=="string"?S:JSON.stringify(S);return I.length>300?`${I.slice(0,300)}\u2026`:I}catch{return""}},r=S=>t(S,"id","uuid","stubId"),o=S=>t(S,"id","requestId","mappingUuid","request.id","request.loggedDate","loggedDate"),s=S=>{if(!S||typeof S!="object")return"";const I=S.request||{},T=S.response||{},v=S.metadata||{};return[I.method||"",I.url||I.urlPattern||I.urlPath||I.urlPathPattern||"",T.status||"",T.fixedDelayMilliseconds||"",S.name||v.name||"",S.priority??"",S.scenarioName||"",v.edited||v.created||"",v.source||"",i(I.headers),i(I.bodyPatterns||I.body||""),i(I.queryParameters),i(T.headers),i(T.jsonBody!==void 0?T.jsonBody:T.body||""),i(v.additionalMetadata||v.tags||v.description||"")].join("|")},c=S=>{if(!S||typeof S!="object")return"";const I=S.request||{},T=S.responseDefinition||{};return[I.method||"",I.url||I.urlPath||"",I.loggedDate||S.loggedDate||"",S.wasMatched===!1?"unmatched":"matched",T.status??"",(T.body||T.jsonBody||"").length,(I.body||"").length].join("|")},l=S=>[...Array.isArray(S)?S:[]].sort((T,v)=>{const g=T?.priority??1,w=v?.priority??1;if(g!==w)return g-w;const A=e[T?.request?.method]||999,N=e[v?.request?.method]||999;if(A!==N)return A-N;const D=T?.request?.url||T?.request?.urlPattern||T?.request?.urlPath||"",V=v?.request?.url||v?.request?.urlPattern||v?.request?.urlPath||"";return D.localeCompare(V)}),d=S=>typeof window.renderMappingCard=="function"?window.renderMappingCard(S):"",m=S=>typeof window.renderRequestCard=="function"?window.renderRequestCard(S):"",h=(S,I,T={})=>{if(!S||typeof window.renderList!="function")return[];const v=T.preSorted===!0?[...I||[]]:l(I),g=T.onItemChanged,w=T.onItemRemoved;if(window.PaginationManager){window.PaginationManager.updateState(v.length);const A=window.PaginationManager.getCurrentPageItems(v);window.renderList(S,A,{renderItem:d,getKey:r,getSignature:s,onItemChanged:g,onItemRemoved:w});const N=document.getElementById(T.paginationContainerId||"mappings-pagination");return N&&(N.innerHTML=window.PaginationManager.renderControls()),v}return window.renderList(S,v,{renderItem:d,getKey:r,getSignature:s,onItemChanged:g,onItemRemoved:w}),v};window.getRenderKey=t,window.getMappingRenderKey=r,window.getRequestRenderKey=o,window.getMappingRenderSignature=s,window.getRequestRenderSignature=c,window.renderMappingMarkup=d,window.renderRequestMarkup=m,window.sortMappingsForDisplay=l,window.renderMappingsCollection=h})();function executeMappingFilters(){const e=document.getElementById("filter-query")?.value?.trim()||"";window.FilterManager.saveFilterState("mappings",{query:e}),updateURLFilterParams(e,"mappings");const t=window.originalMappings;if(!Array.isArray(t)||t.length===0){const l=document.getElementById(SELECTORS.EMPTY.MAPPINGS),d=document.getElementById(SELECTORS.LISTS.MAPPINGS);l&&(l.classList.remove("hidden"),l.removeAttribute("aria-hidden")),d&&(d.style.display="none"),typeof updateMappingsCounter=="function"&&updateMappingsCounter();return}let i;e?window.QueryParser&&typeof window.QueryParser.filterMappingsByQuery=="function"?i=window.QueryParser.filterMappingsByQuery(t,e):(Logger.warn("MANAGERS","[Mapping Filter] QueryParser or filterMappingsByQuery is not available. Showing all mappings."),i=t):i=t,window._filteredMappings=i;const r=document.getElementById(SELECTORS.LISTS.MAPPINGS),o=document.getElementById(SELECTORS.EMPTY.MAPPINGS),s=document.getElementById(SELECTORS.LOADING.MAPPINGS);if(!r)return;if(window.MappingsStore?.metadata?.isRendering){window.MappingsStore.metadata.pendingFilterRender=!0;return}const c=typeof window.sortMappingsForDisplay=="function"?window.sortMappingsForDisplay(i):[...i];if(typeof window.renderMappingsCollection=="function")window.renderMappingsCollection(r,c,{preSorted:!0});else if(window.PaginationManager){window.PaginationManager.updateState(c.length);const l=window.PaginationManager.getCurrentPageItems(c);renderList(r,l,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature});const d=document.getElementById("mappings-pagination");d&&(d.innerHTML=window.PaginationManager.renderControls())}else renderList(r,c,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature});s&&s.classList.add("hidden"),c.length===0?(o&&(o.classList.remove("hidden"),o.removeAttribute("aria-hidden")),r.style.display="none"):(o&&(o.classList.add("hidden"),o.setAttribute("aria-hidden","true")),r.style.display="block"),typeof updateMappingsCounter=="function"&&updateMappingsCounter()}function executeRequestFilters(){const e=document.getElementById("req-filter-query")?.value?.trim()||"",t=document.getElementById("req-filter-from"),i=document.getElementById("req-filter-to"),r=t?.value||"",o=i?.value||"";if(window.FilterManager.saveFilterState("requests",{query:e,from:r,to:o}),updateURLFilterParams(e,"requests"),!Array.isArray(window.originalRequests)||window.originalRequests.length===0){window.allRequests=[];const S=document.getElementById(SELECTORS.EMPTY.REQUESTS),I=document.getElementById(SELECTORS.LISTS.REQUESTS);S&&S.classList.remove("hidden"),I&&(I.style.display="none"),typeof updateRequestsCounter=="function"&&updateRequestsCounter();return}let s=e&&window.QueryParser?window.QueryParser.filterRequestsByQuery(window.originalRequests,e):window.originalRequests;const c=r?new Date(r).getTime():null,l=o?new Date(o).getTime():null;(c!==null||l!==null)&&(s=s.filter(S=>{if(!S)return!1;const I=new Date(S.request?.loggedDate||S.loggedDate).getTime();return!(c!==null&&Number.isFinite(c)&&(!Number.isFinite(I)||I<c)||l!==null&&Number.isFinite(l)&&(!Number.isFinite(I)||I>l))})),window.allRequests=s;const d=document.getElementById(SELECTORS.LISTS.REQUESTS),m=document.getElementById(SELECTORS.EMPTY.REQUESTS),h=document.getElementById(SELECTORS.LOADING.REQUESTS);d&&(renderList(d,window.allRequests,{renderItem:window.renderRequestMarkup,getKey:window.getRequestRenderKey,getSignature:window.getRequestRenderSignature}),h&&h.classList.add("hidden"),window.allRequests.length===0?(m&&m.classList.remove("hidden"),d.style.display="none"):(m&&m.classList.add("hidden"),d.style.display="block"),typeof updateRequestsCounter=="function"&&updateRequestsCounter(),Logger.debug("MANAGERS",`Filtered requests: ${window.allRequests.length} items`))}window.FilterManager._applyMappingFilters=window.debounce(executeMappingFilters,180),window.FilterManager._applyRequestFilters=window.debounce(executeRequestFilters,180),window.applyFilters=()=>{FilterManager.applyMappingFilters(),typeof window._updateActiveFiltersDisplayDebounced=="function"?window._updateActiveFiltersDisplayDebounced():typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay()},window.clearMappingFilters=()=>{const n=document.getElementById("filter-query");n&&(n.value=""),FilterManager.applyMappingFilters(),typeof FilterManager.flushMappingFilters=="function"&&FilterManager.flushMappingFilters(),typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay(),typeof window.updateURLFilterParams=="function"&&window.updateURLFilterParams("","mappings")},window.toggleQueryHelp=(n="mappings")=>{const e=n==="requests"?"req-query-help":"query-help",t=document.getElementById(e);if(!t)return;const i=t.classList.contains("hidden"),r=document.querySelector(`[aria-controls="${e}"]`);i?(t.classList.remove("hidden"),r&&(r.textContent="\xD7",r.setAttribute("aria-expanded","true"))):(t.classList.add("hidden"),r&&(r.textContent="?",r.setAttribute("aria-expanded","false")))},window.applyQuickMethodFilter=n=>{const e=document.getElementById("filter-query");if(!e)return;const t=e.value.trim(),i=/method:[^\s]+/;i.test(t)?e.value=t.replace(i,`method:${n}`):e.value=t?`method:${n} ${t}`:`method:${n}`,applyFilters(),updateActiveFiltersDisplay()},window.updateActiveFiltersDisplay=()=>{const n=document.getElementById("filter-query"),e=document.getElementById("active-filters"),t=document.getElementById("active-filters-list");if(!n||!e||!t)return;const i=n.value.trim();if(!i){e.classList.add("filter-hidden");return}const r=window.QueryParser?window.QueryParser.parseQuery(i):null;if(!r||Object.keys(r).length===0){e.classList.add("filter-hidden");return}const o=[];for(const[s,c]of Object.entries(r)){if(s==="text")continue;let l="";if(typeof c=="object"&&c.exclude){const d=Array.isArray(c.exclude)?c.exclude.join(","):c.exclude;l=`-${s}:${d}`}else typeof c=="object"&&c.from&&c.to?l=`${s}:${c.from}-${c.to}`:Array.isArray(c)?l=`${s}:${c.join(",")}`:l=`${s}:${c}`;o.push(`
            <button type="button"
                    class="filter-chip filter-chip-active"
                    data-action="remove-active-filter"
                    data-filter-key="${Utils.escapeHtml(s)}"
                    title="Click to remove">
                ${Utils.escapeHtml(l)}
                <span class="filter-chip-remove" aria-hidden="true">\xD7</span>
            </button>
        `)}t.innerHTML=o.join(""),o.length>0?e.classList.remove("filter-hidden"):e.classList.add("filter-hidden")},window._updateActiveFiltersDisplayDebounced=window.debounce?window.debounce(window.updateActiveFiltersDisplay,200):window.updateActiveFiltersDisplay,window.removeActiveFilter=n=>{const e=document.getElementById("filter-query");if(!e)return;const t=e.value.trim(),i=[new RegExp(`-?${n}:[^\\s]+`,"g"),new RegExp(`\\s+${n}:[^\\s]+`,"g"),new RegExp(`${n}:[^\\s]+\\s+`,"g")];let r=t;for(const o of i)r=r.replace(o," ");r=r.replace(/\s+/g," ").trim(),e.value=r,applyFilters(),updateActiveFiltersDisplay()},window.applyRequestFilters=()=>FilterManager.applyRequestFilters();function applyDateRange(n,e,t,i){n&&(n.value=Utils.formatDateTime(t)),e&&(e.value=Utils.formatDateTime(i)),FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters()}window.applyQuickFilter=()=>{const n=document.getElementById(SELECTORS.REQUEST_FILTERS.QUICK);if(!n)return;const e=n.value,t=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM),i=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO);if(!e){t&&(t.value=""),i&&(i.value=""),FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters();return}const r=new Date,o=new Date(r),s=e.match(/^(\d+)([mhd])$/);if(!s)return;const c=parseInt(s[1]);switch(s[2]){case"m":o.setMinutes(o.getMinutes()-c);break;case"h":o.setHours(o.getHours()-c);break;case"d":o.setDate(o.getDate()-c);break;default:return}applyDateRange(t,i,o,r)},window.clearQuickTimeFilter=()=>{const n=document.getElementById("req-filter-quick");n&&(n.value="")},window.applyQuickTimeFilter=()=>{const n=document.getElementById("req-filter-quick"),e=document.getElementById("req-filter-from"),t=document.getElementById("req-filter-to");if(!n||!e||!t)return;const i=n.value;if(!i){e.value="",t.value="",FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters();return}const r=new Date;let o=new Date(r);const s=i.match(/^(\d+)([mhd])$/);if(s){const c=parseInt(s[1],10);switch(s[2]){case"m":o.setMinutes(o.getMinutes()-c);break;case"h":o.setHours(o.getHours()-c);break;case"d":o.setDate(o.getDate()-c);break}}applyDateRange(e,t,o,r)},window.clearRequestFilters=()=>{const n=document.getElementById("req-filter-query");n&&(n.value="");const e=document.getElementById("req-filter-from"),t=document.getElementById("req-filter-to"),i=document.getElementById("req-filter-quick");e&&(e.value=""),t&&(t.value=""),i&&(i.value=""),FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters(),typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay(),typeof window.updateURLFilterParams=="function"&&window.updateURLFilterParams("","requests")},window.applyQuickRequestFilter=n=>{const e=document.getElementById("req-filter-query");if(!e)return;const t=e.value.trim();if(/^[A-Z]+$/.test(n)){const i=/method:[\w,]+/i;i.test(t)?e.value=t.replace(i,`method:${n}`):e.value=t?`method:${n} ${t}`:`method:${n}`}else{const i=n.match(/^(\w+):/);if(i){const r=i[1],o=new RegExp(`${r}:[^\\s]+`,"i");o.test(t)?e.value=t.replace(o,n):e.value=t?`${n} ${t}`:n}else e.value=t?`${n} ${t}`:n}FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters(),typeof window._updateRequestActiveFiltersDisplayDebounced=="function"?window._updateRequestActiveFiltersDisplayDebounced():typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay()},window.updateRequestActiveFiltersDisplay=()=>{const n=document.getElementById("req-active-filters"),e=document.getElementById("req-filter-query");if(!n||!e)return;const t=e.value.trim();if(!t||!window.QueryParser){n.innerHTML="",n.classList.add("filter-hidden");return}const i=window.QueryParser.parseQuery(t);if(!i){n.innerHTML="",n.classList.add("filter-hidden");return}const r=[];for(const[o,s]of Object.entries(i)){if(o==="text")continue;let c="";if(o==="matched"){const l=Array.isArray(s)?s:[s],d=String(l[0]).toLowerCase();d==="true"||d==="yes"||d==="1"?c="Matched":c="Unmatched"}else if(Array.isArray(s))c=`${o}: ${s.join(", ")}`;else if(typeof s=="object"&&s.exclude){const l=Array.isArray(s.exclude)?s.exclude:[s.exclude];c=`NOT ${o}: ${l.join(", ")}`}else c=`${o}: ${s}`;r.push(`<button type="button" class="filter-chip filter-chip-active" data-action="remove-request-active-filter" data-filter-key="${Utils.escapeHtml(o)}" title="Remove filter">${Utils.escapeHtml(c)} \xD7</button>`)}n.innerHTML=r.join(""),r.length>0?n.classList.remove("filter-hidden"):n.classList.add("filter-hidden")},window._updateRequestActiveFiltersDisplayDebounced=window.debounce?window.debounce(window.updateRequestActiveFiltersDisplay,200):window.updateRequestActiveFiltersDisplay,window.removeRequestActiveFilter=n=>{const e=document.getElementById("req-filter-query");if(!e)return;const t=e.value.trim();if(!t)return;const i=new RegExp(`-?${n}:[\\w\\/\\*.,\\-]+(\\s+|$)`,"gi"),r=t.replace(i,"").replace(/\s+/g," ").trim();e.value=r,FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters(),typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay()};function getSavedFilters(n){const e=`saved-filters-${n}`;try{const t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(t){return Logger.warn("FILTERS",`Failed to load saved filters for ${n}:`,t),[]}}function setSavedFilters(n,e){const t=`saved-filters-${n}`;try{localStorage.setItem(t,JSON.stringify(e))}catch(i){Logger.error("FILTERS",`Failed to save filters for ${n}:`,i)}}window.saveCurrentMappingFilter=()=>{const n=document.getElementById("filter-query");if(!n)return;const e=n.value.trim();if(!e){typeof NotificationManager<"u"&&NotificationManager.warning("No filter to save");return}const t=prompt("Enter a name for this filter:",e.substring(0,30));if(!t)return;const i=getSavedFilters("mappings"),r=i.findIndex(o=>o.name===t);if(r>=0){if(!confirm(`Filter "${t}" already exists. Overwrite?`))return;i[r]={name:t,query:e}}else i.push({name:t,query:e});setSavedFilters("mappings",i),updateSavedFiltersDisplay("mappings"),typeof NotificationManager<"u"&&NotificationManager.success(`Filter "${t}" saved`)},window.saveCurrentRequestFilter=()=>{const n=document.getElementById("req-filter-query");if(!n)return;const e=n.value.trim();if(!e){typeof NotificationManager<"u"&&NotificationManager.warning("No filter to save");return}const t=prompt("Enter a name for this filter:",e.substring(0,30));if(!t)return;const i=getSavedFilters("requests"),r=i.findIndex(o=>o.name===t);if(r>=0){if(!confirm(`Filter "${t}" already exists. Overwrite?`))return;i[r]={name:t,query:e}}else i.push({name:t,query:e});setSavedFilters("requests",i),updateSavedFiltersDisplay("requests"),typeof NotificationManager<"u"&&NotificationManager.success(`Filter "${t}" saved`)},window.applySavedFilter=(n,e)=>{const i=getSavedFilters(n).find(r=>r.name===e);if(!i){Logger.warn("FILTERS",`Saved filter "${e}" not found`);return}if(n==="mappings"){const r=document.getElementById("filter-query");r&&(r.value=i.query,applyFilters(),updateActiveFiltersDisplay())}else if(n==="requests"){const r=document.getElementById("req-filter-query");r&&(r.value=i.query,FilterManager.applyRequestFilters(),updateRequestActiveFiltersDisplay())}},window.deleteSavedFilter=(n,e)=>{const i=getSavedFilters(n).filter(r=>r.name!==e);setSavedFilters(n,i),updateSavedFiltersDisplay(n),typeof NotificationManager<"u"&&NotificationManager.info(`Filter "${e}" deleted`)};function updateSavedFiltersDisplay(n){const e=getSavedFilters(n);let t,i;if(n==="mappings")t="saved-filters-list",i="saved-filters-separator";else if(n==="requests")t="req-saved-filters-list",i="req-saved-filters-separator";else return;const r=document.getElementById(t),o=document.getElementById(i);if(!r)return;if(e.length===0){r.classList.add("filter-hidden"),o&&o.classList.add("filter-hidden");return}const s=e.map(c=>`
        <button type="button"
                class="filter-chip filter-chip-saved"
                data-action="apply-saved-filter"
                data-filter-tab="${Utils.escapeHtml(n)}"
                data-filter-name="${Utils.escapeHtml(c.name)}"
                title="${Utils.escapeHtml(c.query)}">
            <span class="filter-chip-text">${Utils.escapeHtml(c.name)}</span>
            <span class="filter-chip-remove"
                  data-action="delete-saved-filter"
                  data-filter-tab="${Utils.escapeHtml(n)}"
                  data-filter-name="${Utils.escapeHtml(c.name)}"
                  title="Delete filter"
                  aria-label="Delete filter">\xD7</span>
        </button>
    `);r.innerHTML=s.join(""),r.classList.remove("filter-hidden"),o&&o.classList.remove("filter-hidden")}if(window.loadAllSavedFilters=()=>{updateSavedFiltersDisplay("mappings"),updateSavedFiltersDisplay("requests")},!window._filterChipDelegationInitialized){let n=function(t){const i=t.target.closest('[data-action="delete-saved-filter"]');if(i){t.stopPropagation();const c=i.dataset.filterTab,l=i.dataset.filterName;c&&l&&window.deleteSavedFilter(c,l);return}const r=t.target.closest('[data-action="apply-saved-filter"]');if(r){const c=r.dataset.filterTab,l=r.dataset.filterName;c&&l&&window.applySavedFilter(c,l);return}const o=t.target.closest('[data-action="remove-active-filter"]');if(o){const c=o.dataset.filterKey;c&&window.removeActiveFilter(c);return}const s=t.target.closest('[data-action="remove-request-active-filter"]');if(s){const c=s.dataset.filterKey;c&&window.removeRequestActiveFilter(c);return}};window._filterChipDelegationInitialized=!0,["active-filters-list","req-active-filters","saved-filters-list","req-saved-filters-list"].forEach(t=>{const i=document.getElementById(t);i&&i.addEventListener("click",n)})}function isCacheEnabled(){try{const n=document.getElementById("cache-enabled"),e=typeof window.readWiremockSettings=="function"?window.readWiremockSettings():{},t=n&&typeof n.checked=="boolean"?n.checked:!0;return e.cacheEnabled!==!1&&t}catch(n){return Logger.warn("CACHE","Failed to resolve cache enabled state. Defaulting to cache disabled. Check settings configuration.",n),!1}}window.isCacheEnabled=isCacheEnabled,window.connectToWireMock=async()=>{const n=document.getElementById("wiremock-host")||document.getElementById(SELECTORS.CONNECTION.HOST),e=document.getElementById("wiremock-port")||document.getElementById(SELECTORS.CONNECTION.PORT);let t,i;if(n&&e)t=n.value.trim()||"localhost",i=e.value.trim()||"8080";else if(window.wiremockBaseUrl)Logger.api("Using existing wiremockBaseUrl for connection"),t="localhost",i="8080";else{const c=typeof window.readWiremockSettings=="function"?window.readWiremockSettings():{};t=c.host||"localhost",i=c.port||"8080",Logger.api("Using settings for connection:",{host:t,port:i})}Logger.api("Connecting with:",{host:t,port:i});const r=document.getElementById(SELECTORS.CONNECTION.STATUS_DOT),o=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT),s=document.getElementById(SELECTORS.LOADING.MAPPINGS);if(r&&(r.className="status-dot connecting"),o&&(o.textContent="Connecting..."),s&&s.classList.remove("hidden"),!window.wiremockBaseUrl||n){if(typeof window.normalizeWiremockBaseUrl=="function")window.wiremockBaseUrl=window.normalizeWiremockBaseUrl(t,i);else{const c=/^(https?:)\/\//i.test(t),l=c?t.split(":")[0]:"http",d=c?t.replace(/^(https?:)\/\//i,""):t,m=i&&String(i).trim()||(l==="https"?"443":"8080");window.wiremockBaseUrl=`${l}://${d}:${m}/__admin`}Logger.api("Updated wiremockBaseUrl:",window.wiremockBaseUrl)}else Logger.api("Using pre-configured wiremockBaseUrl:",window.wiremockBaseUrl);try{await checkHealthAndStartUptime(),Logger.info("API","Online mode - proceeding with data loading");const c=document.getElementById(SELECTORS.CONNECTION.SETUP),l=document.getElementById(SELECTORS.BUTTONS.ADD_MAPPING);r&&(r.className="status-dot connected"),o&&(window.lastWiremockSuccess||(window.lastWiremockSuccess=Date.now()),typeof window.updateLastSuccessUI=="function"&&window.updateLastSuccessUI()),c&&(c.style.display="none"),l&&(l.disabled=!1);const d=document.getElementById(SELECTORS.UI.STATS),m=document.getElementById("stats-spacer"),h=document.getElementById(SELECTORS.UI.SEARCH_FILTERS);d&&(d.style.display="flex"),m&&(m.style.display="none"),h&&(h.style.display="block"),startHealthCheck(),Logger.info("API","Using new optimized sync engine");const S=isCacheEnabled();Logger.info("CACHE",`Service cache is ${S?"enabled":"disabled"} for this session`),window.SyncEngine.stop(),await window.SyncEngine.coldStart({useCache:S}),window.SyncEngine.start(),await loadScenarios(),typeof window.hideOnboardingOverlay=="function"&&window.hideOnboardingOverlay(),typeof window.FilterManager?.restoreFilters=="function"&&window.FilterManager.restoreFilters("mappings")?.query&&typeof window.FilterManager.applyMappingFilters=="function"&&(window.FilterManager.applyMappingFilters(),typeof window.FilterManager.flushMappingFilters=="function"&&window.FilterManager.flushMappingFilters()),NotificationManager.success("Connected to WireMock successfully!")}catch(c){Logger.error("API","Connection error - entering offline mode:",c),Logger.warn("API","Offline mode - no server requests will be made"),stopUptime(),r&&(r.className="status-dot disconnected"),o&&(o.textContent="Offline"),s&&s.classList.add("hidden"),NotificationManager.warning("WireMock server is offline. Retrying connection in background..."),startHealthCheck()}};let healthCheckTimeout=null,healthCheckFailureCount=0;window.startHealthCheck=()=>{healthCheckTimeout&&(clearTimeout(healthCheckTimeout),healthCheckTimeout=null);let n;window.isOnline?n=3e4:n=Math.min(2e3*Math.pow(2,healthCheckFailureCount),6e4),Logger.info("HEALTH",`Scheduling next check in ${n}ms (${window.isOnline?"online":`offline, attempt ${healthCheckFailureCount+1}`})`),healthCheckTimeout=setTimeout(async()=>{try{const e=performance.now();let t=!1,i=0;try{const o=await apiFetch(ENDPOINTS.HEALTH);i=Math.round(performance.now()-e),t=typeof o=="object"&&(typeof o.status=="string"&&["up","healthy","ok"].includes(o.status.toLowerCase())||o.healthy===!0)}catch(o){if(o?.message?.includes("404")||o?.status===404){Logger.warn("HEALTH","/health not found (404), trying /mappings fallback for older WireMock");try{const c=await window.apiFetch(window.ENDPOINTS.MAPPINGS);i=Math.round(performance.now()-e),t=typeof c=="object"&&c!==null&&!c.__isDemo}catch{t=!1}}else t=!1}const r=window.isOnline;if(window.isOnline=t,t){healthCheckFailureCount=0;const o=document.getElementById(SELECTORS.HEALTH.INDICATOR);o&&(o.innerHTML=`<span>Response Time: </span><span class="healthy">${i}ms</span>`),r?Logger.info("HEALTH",`Server is healthy (${i}ms)`):(Logger.info("HEALTH",`Server is back online (${i}ms)`),NotificationManager.success("WireMock server is back online! Reconnecting..."),await window.connectToWireMock())}else{healthCheckFailureCount++;const o=document.getElementById(SELECTORS.HEALTH.INDICATOR);if(o&&(o.innerHTML='<span>Response Time: </span><span class="unhealthy">Offline</span>'),r){Logger.warn("HEALTH","Server went offline"),stopUptime();const s=document.getElementById(SELECTORS.CONNECTION.STATUS_DOT),c=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT);s&&(s.className="status-dot disconnected"),c&&(c.textContent="Offline"),NotificationManager.warning("WireMock server went offline. Retrying in background...")}else Logger.warn("HEALTH",`Server still offline (attempt ${healthCheckFailureCount})`)}startHealthCheck()}catch(e){Logger.error("HEALTH","Check error:",e),window.isOnline=!1,healthCheckFailureCount++,startHealthCheck()}},n)},window.stopHealthCheck=()=>{healthCheckTimeout&&(clearTimeout(healthCheckTimeout),healthCheckTimeout=null,healthCheckFailureCount=0,Logger.info("HEALTH","Health check stopped"))},window.checkHealthAndStartUptime=async()=>{try{const n=performance.now();let e=0,t=!1;try{const i=await apiFetch(ENDPOINTS.HEALTH);e=Math.round(performance.now()-n),t=typeof i=="object"&&(typeof i.status=="string"&&["up","healthy","ok"].includes(i.status.toLowerCase())||i.healthy===!0),Logger.info("HEALTH","initial check:",{rawStatus:i?.status,healthyFlag:i?.healthy,isHealthy:t})}catch(i){if(i?.message?.includes("404")||i?.status===404){Logger.warn("HEALTH","/health not found (404), trying /mappings fallback for older WireMock");try{const o=await window.apiFetch(window.ENDPOINTS.MAPPINGS);e=Math.round(performance.now()-n),t=typeof o=="object"&&o!==null&&!o.__isDemo,Logger.info("HEALTH","fallback check (mappings):",{isHealthy:t,responseTime:e})}catch{Logger.warn("HEALTH","fallback failed - offline mode"),t=!1}}else Logger.warn("HEALTH","connection failed - offline mode"),t=!1}if(t){if(window.isOnline=!0,window.startTime=Date.now(),window.uptimeInterval&&window.LifecycleManager.clearInterval(window.uptimeInterval),window.uptimeInterval=window.LifecycleManager.setNamedInterval("uptime-display",updateUptime,1e3),typeof window.applyHealthUI=="function")try{window.applyHealthUI(!0,e)}catch(r){Logger.warn("HEALTH","applyHealthUI failed:",r)}const i=document.getElementById(SELECTORS.HEALTH.INDICATOR);i&&(i.style.display="inline",i.innerHTML=`<span>Response Time: </span><span class="healthy">${e}ms</span>`),Logger.info("HEALTH",`WireMock health check passed (${e}ms), uptime started, online mode`)}else throw window.isOnline=!1,new Error("WireMock is not reachable - offline mode")}catch(n){throw window.isOnline=!1,Logger.error("HEALTH","Health check failed - entering offline mode:",n),n}},(function(){const e=new Map,t=new Map,i=new Set,r=new Map,o={setInterval(s,c){const l=window.setInterval(s,c);return e.set(l,{delay:c,createdAt:Date.now()}),Logger.debug("LIFECYCLE",`Interval created: ${l} (${c}ms)`),l},clearInterval(s){if(s!=null){window.clearInterval(s);const c=e.get(s);e.delete(s),Logger.debug("LIFECYCLE",`Interval cleared: ${s}${c?` (${c.delay}ms, ${Date.now()-c.createdAt}ms ago)`:""}`)}},setTimeout(s,c){const l=window.setTimeout(s,c);return t.set(l,{delay:c,createdAt:Date.now()}),Logger.debug("LIFECYCLE",`Timeout created: ${l} (${c}ms)`),l},clearTimeout(s){if(s!=null){window.clearTimeout(s);const c=t.get(s);t.delete(s),Logger.debug("LIFECYCLE",`Timeout cleared: ${s}${c?` (${c.delay}ms, ${Date.now()-c.createdAt}ms ago)`:""}`)}},requestAnimationFrame(s){const l=(window.requestAnimationFrame||function(d){return setTimeout(d,16)})(s);return i.add(l),Logger.debug("LIFECYCLE",`Animation frame requested: ${l}`),l},cancelAnimationFrame(s){s!=null&&((window.cancelAnimationFrame||clearTimeout)(s),i.delete(s),Logger.debug("LIFECYCLE",`Animation frame cancelled: ${s}`))},addEventListener(s,c,l,d){if(!s||!c||!l){Logger.warn("LIFECYCLE","addEventListener called with missing parameters",{target:s,type:c,handler:!!l});return}s.addEventListener(c,l,d),r.has(s)||r.set(s,new Set),r.get(s).add({type:c,handler:l,options:d});const m=s.id||s.className||s.tagName||"unknown";Logger.debug("LIFECYCLE",`Event listener added: ${c} on ${m}`)},removeEventListener(s,c,l,d){if(!s||!c||!l){Logger.warn("LIFECYCLE","removeEventListener called with missing parameters",{target:s,type:c,handler:!!l});return}s.removeEventListener(c,l,d);const m=r.get(s);if(m){for(const S of m)if(S.type===c&&S.handler===l&&JSON.stringify(S.options)===JSON.stringify(d)){m.delete(S);break}m.size===0&&r.delete(s)}const h=s.id||s.className||s.tagName||"unknown";Logger.debug("LIFECYCLE",`Event listener removed: ${c} on ${h}`)},setNamedInterval(s,c,l){const d=window.setInterval(c,l);return e.set(d,{name:s,delay:l,createdAt:Date.now()}),Logger.debug("LIFECYCLE",`Named interval created: ${s||d} (${l}ms)`),d},getStats(){const s=Array.from(e.entries()).map(([d,m])=>({id:d,name:m.name||`interval-${d}`,delay:m.delay,age:Date.now()-m.createdAt})),c=Array.from(t.entries()).map(([d,m])=>({id:d,name:m.name||`timeout-${d}`,delay:m.delay,age:Date.now()-m.createdAt})),l=Array.from(r.entries()).map(([d,m])=>({target:d.id||d.className||d.tagName||"unknown",eventTypes:Array.from(m).map(S=>S.type),count:m.size}));return{activeIntervals:e.size,activeTimeouts:t.size,activeAnimationFrames:i.size,activeEventListeners:r.size,details:{intervals:s,timeouts:c,animationFrames:Array.from(i),eventListeners:l}}},clearAll(){Logger.debug("LIFECYCLE","Clearing all lifecycle resources");const s=e.size,c=t.size,l=i.size,d=r.size;e.forEach((m,h)=>window.clearInterval(h)),e.clear(),t.forEach((m,h)=>window.clearTimeout(h)),t.clear(),i.forEach(m=>window.cancelAnimationFrame(m)),i.clear(),r.forEach((m,h)=>{m.forEach(({type:S,handler:I,options:T})=>{h.removeEventListener(S,I,T)})}),r.clear(),Logger.debug("LIFECYCLE",`Cleared ${s} intervals, ${c} timeouts, ${l} animation frames, ${d} event listeners`)}};window.LifecycleManager=o,window.addEventListener("beforeunload",()=>{Logger.info("LIFECYCLE","Page unloading, cleaning up resources");try{if(o.clearAll(),window.CacheIntervals&&typeof window.CacheIntervals.stop=="function"&&(Logger.info("LIFECYCLE","Stopping cache intervals"),window.CacheIntervals.stop()),window.SyncEngine&&typeof window.SyncEngine.stop=="function"&&(Logger.info("LIFECYCLE","Stopping sync engine"),window.SyncEngine.stop()),typeof window.cleanupPendingDeletions=="function"&&(Logger.info("LIFECYCLE","Cleaning up pending deletions"),window.cleanupPendingDeletions()),window.deletionTimeouts instanceof Map){Logger.info("LIFECYCLE","Cleaning up deletion timeouts");for(const s of window.deletionTimeouts.values())clearTimeout(s);window.deletionTimeouts.clear()}if(window.pendingDeletedIds instanceof Set&&(Logger.info("LIFECYCLE","Clearing pending deleted IDs"),window.pendingDeletedIds.clear()),typeof window.stopUptime=="function"&&(Logger.info("LIFECYCLE","Stopping uptime tracking"),window.stopUptime()),typeof window.stopHealthCheck=="function"&&(Logger.info("LIFECYCLE","Stopping health check"),window.stopHealthCheck()),window.optimisticShadowMappings&&window.optimisticShadowMappings.clear&&(Logger.info("LIFECYCLE","Clearing optimistic shadow mappings"),window.optimisticShadowMappings.clear()),window.CacheService&&typeof window.CacheService.clear=="function"&&(Logger.info("LIFECYCLE","Clearing CacheService"),window.CacheService.clear()),window.elementCache&&window.elementCache.clear&&(Logger.info("LIFECYCLE","Clearing element cache"),window.elementCache.clear()),window.autoRefreshInterval&&(Logger.info("LIFECYCLE","Clearing auto-refresh interval"),clearInterval(window.autoRefreshInterval),window.autoRefreshInterval=null),typeof window.cacheRefreshChannel<"u"&&window.cacheRefreshChannel){Logger.info("LIFECYCLE","Closing cache refresh BroadcastChannel");try{window.cacheRefreshChannel.close()}catch(s){Logger.warn("LIFECYCLE","Failed to close cache refresh BroadcastChannel:",s)}}if(typeof window.optimisticUpdateChannel<"u"&&window.optimisticUpdateChannel){Logger.info("LIFECYCLE","Closing optimistic update BroadcastChannel");try{window.optimisticUpdateChannel.close()}catch(s){Logger.warn("LIFECYCLE","Failed to close optimistic update BroadcastChannel:",s)}}Logger.info("LIFECYCLE","Cleanup completed successfully")}catch(s){Logger.error("LIFECYCLE","Error during cleanup:",s)}})})(),window.debounce=function(e,t=150,i={}){let r,o,s,c;const{leading:l=!1,trailing:d=!0}=i,m=()=>{r=void 0,d&&o&&(c=e.apply(s,o),o=s=void 0)};return Object.assign(function(...S){return o=S,s=this,r===void 0?(l&&(c=e.apply(s,o),o=s=void 0),r=window.setTimeout(m,t)):(window.clearTimeout(r),r=window.setTimeout(m,t)),c},{cancel(){r!==void 0&&window.clearTimeout(r),r=void 0,o=s=void 0},flush(){return r!==void 0&&(window.clearTimeout(r),m()),c}})},Logger.debug("LIFECYCLE","Lifecycle module loaded"),window.MappingsStore={items:new Map,metadata:{serverVersion:null,lastFullSync:null,lastIncrementalSync:null,isSyncing:!1,syncError:null},pending:new Map,indexes:{byMethod:new Map,byUrl:new Map,byPriority:new Map,byScenario:new Map},stats:{totalMappings:0,pendingOperations:0,lastSyncDuration:0},requests:new Map,getAllRequests(){return Array.from(this.requests.values())},setRequests(n){this.requests.clear(),Array.isArray(n)&&n.forEach(e=>{const t=e.id||e.uuid||e.request&&e.request.url||Date.now().toString();t&&this.requests.set(t,e)})},init(){Logger.info("STORE","Initializing MappingsStore"),this.clear(),Logger.info("STORE","MappingsStore initialized")},get(n){if(!n)return null;const e=this.pending.get(n);return e&&e.type!=="delete"?e.optimisticMapping:this.items.get(n)||null},getAll(){const n=[];return this.items.forEach((e,t)=>{const i=this.pending.get(t);i&&i.type==="delete"||(i&&i.type==="update"?n.push(i.optimisticMapping):n.push(e))}),this.pending.forEach((e,t)=>{e.type==="create"&&!this.items.has(t)&&n.push(e.optimisticMapping)}),n},setFromServer(n,e={}){Logger.info("STORE",`Setting ${n.length} mappings from server`),this.items.clear(),n.forEach(t=>{const i=t.id||t.uuid;i&&this.items.set(i,t)}),this.metadata.serverVersion=e.version||e.etag||null,this.metadata.lastFullSync=Date.now(),this.rebuildIndexes(),this._updateStats(),Logger.info("STORE",`Loaded ${this.items.size} mappings`)},applyChanges({added:n=[],updated:e=[],deleted:t=[]}){Logger.info("STORE",`Applying changes: +${n.length} ~${e.length} -${t.length}`);const i=[];return e.forEach(r=>{const o=r.id||r.uuid,s=this.pending.get(o);if(s&&s.type==="update"){i.push({id:o,type:"update",local:s.optimisticMapping,server:r,localTimestamp:s.timestamp});return}this.items.set(o,r),this._addToIndexes(o,r)}),t.forEach(r=>{this.pending.has(r)&&i.push({id:r,type:"delete",local:this.pending.get(r).optimisticMapping,server:null}),this.items.delete(r),this._removeFromIndexes(r)}),n.forEach(r=>{const o=r.id||r.uuid;this.items.set(o,r),this._addToIndexes(o,r)}),this.metadata.lastIncrementalSync=Date.now(),this._updateStats(),i},addPending(n){const{id:e,type:t,payload:i,optimisticMapping:r}=n;this.pending.set(e,{id:e,type:t,payload:i,optimisticMapping:r,timestamp:Date.now(),retries:0}),Logger.debug("STORE",`Added pending ${t}: ${e}`),this._updateStats()},confirmPending(n,e=null){const t=this.pending.get(n);if(t){if(Logger.info("STORE",`Confirmed pending ${t.type}: ${n}`),t.type==="create"&&e){const i=e.id||e.uuid;this.items.set(i,e),this._addToIndexes(i,e)}else t.type==="update"&&e?(this.items.set(n,e),this._addToIndexes(n,e)):t.type==="delete"&&(this.items.delete(n),this._removeFromIndexes(n));this.pending.delete(n),this._updateStats()}},rollbackPending(n,e=null){const t=this.pending.get(n);t&&(Logger.warn("STORE",`Rolling back pending ${t.type}: ${n}`),t.type==="create"?this.items.delete(n):t.type==="update"&&e?(this.items.set(n,e),this._addToIndexes(n,e)):t.type==="delete"&&e&&(this.items.set(n,e),this._addToIndexes(n,e)),this.pending.delete(n),this._updateStats())},rebuildIndexes(){Object.values(this.indexes).forEach(n=>n.clear()),this.items.forEach((n,e)=>{this._addToIndexes(e,n)}),Logger.debug("STORE",`Rebuilt indexes for ${this.items.size} mappings`)},filter({method:n,url:e,priority:t,scenario:i}){let r=new Set(this.items.keys());if(n){const o=this.indexes.byMethod.get(n.toUpperCase());if(o)r=this._intersect(r,o);else return[]}if(e){const o=this.indexes.byUrl.get(e);o?r=this._intersect(r,o):r=new Set([...r].filter(s=>{const c=this.items.get(s);return this._matchesUrl(c,e)}))}if(t!==void 0){const o=this.indexes.byPriority.get(t);if(o)r=this._intersect(r,o);else return[]}if(i){const o=this.indexes.byScenario.get(i);if(o)r=this._intersect(r,o);else return[]}return Array.from(r).map(o=>this.get(o)).filter(Boolean)},clear(){this.items.clear(),this.pending.clear(),Object.values(this.indexes).forEach(n=>n.clear()),this.metadata={serverVersion:null,lastFullSync:null,lastIncrementalSync:null,isSyncing:!1,syncError:null},this._updateStats(),Logger.info("STORE","Cleared all data")},_addToIndexes(n,e){const t=e.request?.method||"GET";this.indexes.byMethod.has(t)||this.indexes.byMethod.set(t,new Set),this.indexes.byMethod.get(t).add(n);const i=e.request?.urlPattern||e.request?.url||e.request?.urlPath;i&&(this.indexes.byUrl.has(i)||this.indexes.byUrl.set(i,new Set),this.indexes.byUrl.get(i).add(n));const r=e.priority||1;this.indexes.byPriority.has(r)||this.indexes.byPriority.set(r,new Set),this.indexes.byPriority.get(r).add(n),e.scenarioName&&(this.indexes.byScenario.has(e.scenarioName)||this.indexes.byScenario.set(e.scenarioName,new Set),this.indexes.byScenario.get(e.scenarioName).add(n))},_removeFromIndexes(n){Object.values(this.indexes).forEach(e=>{e.forEach((t,i)=>{t.delete(n),t.size===0&&e.delete(i)})})},_intersect(n,e){const t=new Set;return n.forEach(i=>{e.has(i)&&t.add(i)}),t},_matchesUrl(n,e){const t=n.request?.urlPattern||n.request?.url||n.request?.urlPath||"";if(t===e)return!0;try{return new RegExp(e).test(t)}catch{return t.includes(e)}},_updateStats(){this.stats.totalMappings=this.items.size,this.stats.pendingOperations=this.pending.size}},typeof window<"u"&&(window.MappingsStore.init(),Object.defineProperty(window,"originalMappings",{get:function(){return window.MappingsStore?window.MappingsStore.getAll():[]},configurable:!0,enumerable:!0}),Object.defineProperty(window,"allMappings",{get:function(){return window._filteredMappings?window._filteredMappings:window.MappingsStore?window.MappingsStore.getAll():[]},configurable:!0,enumerable:!0}),Object.defineProperty(window,"originalRequests",{get:function(){return window.MappingsStore?window.MappingsStore.getAllRequests():[]},set:function(n){window.MappingsStore&&typeof window.MappingsStore.setRequests=="function"&&window.MappingsStore.setRequests(n);try{delete window._filteredRequests}catch{}},configurable:!0,enumerable:!0}),Object.defineProperty(window,"allRequests",{get:function(){return window._filteredRequests?window._filteredRequests:window.MappingsStore?window.MappingsStore.getAllRequests():[]},set:function(n){window._filteredRequests=Array.isArray(n)?n:[]},configurable:!0,enumerable:!0})),window.SyncEngine={config:{incrementalInterval:3e4,fullSyncInterval:3e5,fullSyncTimeout:6e4,cacheRebuildInterval:6e4,cacheMaxAge:36e5,maxRetries:3,retryDelay:2e3},timers:{incremental:null,fullSync:null,cacheRebuild:null},isStarted:!1,lastCacheHash:null,isIncrementalSyncing:!1,isFullSyncing:!1,useServiceCache:!0,init(){Logger.info("SYNC","Initializing SyncEngine"),this.stop(),Logger.info("SYNC","SyncEngine initialized")},start(){if(this.isStarted){Logger.debug("SYNC","Sync timers already running, skipping start");return}Logger.info("SYNC","Starting sync timers"),this.isStarted=!0,this.timers.incremental=window.LifecycleManager.setInterval(()=>this.incrementalSync(),this.config.incrementalInterval),this.timers.fullSync=window.LifecycleManager.setInterval(()=>this.fullSync({background:!0}),this.config.fullSyncInterval),this.useServiceCache&&(this.timers.cacheRebuild=window.LifecycleManager.setInterval(()=>this.rebuildServiceCache(),this.config.cacheRebuildInterval)),Logger.info("SYNC","Sync timers started")},stop(){Logger.info("SYNC","Stopping sync timers"),Object.keys(this.timers).forEach(n=>{this.timers[n]&&(window.LifecycleManager.clearInterval(this.timers[n]),this.timers[n]=null)}),this.isStarted=!1},async coldStart(n={}){const e=n.useCache===!0;this.useServiceCache=e,Logger.info("SYNC",`Cold start - loading from ${e?"cache or server":"server only"}`),this._showLoadingState();try{if(e){const t=await this.loadFromServiceCache();t&&t.items&&t.items.length>0&&(Logger.info("SYNC",`Loaded ${t.items.length} mappings from cache`),window.MappingsStore.setFromServer(t.items,{version:t.version}),this._renderMappings("cache"),this._applyMappingFilters(),this._updateDataSourceIndicator("cache"),Logger.info("SYNC","Initial UI rendered from cache"))}Logger.info("SYNC","Starting background full sync for latest data"),await this.fullSync({background:!0})}catch(t){Logger.error("SYNC","Cold start failed:",t);try{await this.fullSync({background:!1})}catch(i){throw Logger.error("SYNC","Fallback full sync also failed:",i),i}}},async fullSync({background:n=!1}={}){if(this.isFullSyncing){Logger.debug("SYNC","Full sync already in progress, skipping overlapping run");return}if(window.MappingsStore.metadata.isSyncing||window.MappingsStore.metadata.isOptimisticUpdate){Logger.debug("SYNC","Already syncing or optimistic update in progress, skipping full sync");return}this.isFullSyncing=!0,Logger.info("SYNC",`Starting full sync (background: ${n})`),n&&this._showSyncIndicator(),window.MappingsStore.metadata.isSyncing=!0,window.MappingsStore.metadata.syncStartTime=Date.now();const e=Date.now();try{const t=await this._fetchWithTimeout(typeof window.fetchMappingsFromServer=="function"?window.fetchMappingsFromServer({force:!0}):fetch(`${window.wiremockBaseUrl}/mappings`).then(c=>c.json()),this.config.fullSyncTimeout),i=t.mappings||[],r=t.meta?.version||t.meta?.etag||null;Logger.info("SYNC",`Received ${i.length} mappings from server`);const o=i.filter(c=>(c.id||c.uuid)!=="00000000-0000-0000-0000-00000000cace"&&!this._isServiceCacheMapping(c));window.MappingsStore.setFromServer(o,{version:r}),this._renderMappings("direct",{skipSyncCheck:!0}),this._applyMappingFilters(),this._updateDataSourceIndicator("synced");const s=Date.now()-e;window.MappingsStore.stats.lastSyncDuration=s,Logger.info("SYNC",`Full sync completed in ${s}ms`)}catch(t){if(Logger.error("SYNC","Full sync failed:",t),window.MappingsStore.metadata.syncError=t.message,!n)throw t}finally{this.isFullSyncing=!1,window.MappingsStore.metadata.isSyncing=!1,window.MappingsStore.metadata.syncStartTime=null,this._hideSyncIndicator()}},async incrementalSync(){if(this.isIncrementalSyncing){Logger.debug("SYNC","Incremental sync already in progress, skipping overlapping run");return}this.isIncrementalSyncing=!0;try{if(window.MappingsStore.metadata.isSyncing||window.MappingsStore.metadata.isOptimisticUpdate){Logger.debug("SYNC","Already syncing or optimistic update in progress, skipping incremental sync");return}if(this.isFullSyncing){Logger.debug("SYNC","Full sync in progress, skipping incremental");return}if(!window.MappingsStore.metadata.lastFullSync){Logger.debug("SYNC","No full sync yet, skipping incremental");return}Logger.debug("SYNC","Starting lightweight incremental sync check");const n=Date.now()-(window.MappingsStore.metadata.lastFullSync||0),e=this.config.fullSyncInterval/2;n>e?Logger.debug("SYNC",`Data approaching staleness (${Math.round(n/1e3)}s since last sync), will refresh on next full sync`):Logger.debug("SYNC",`Data is fresh (${Math.round(n/1e3)}s since last sync), skipping server check`)}finally{this.isIncrementalSyncing=!1}},async loadFromServiceCache(){if(!this.useServiceCache)return null;try{Logger.debug("SYNC","Attempting to load from Service Cache");let n;try{n=await window.apiFetch("/mappings/00000000-0000-0000-0000-00000000cace")}catch(o){if(o.status===404)return Logger.debug("SYNC","Service Cache not found"),null;throw o}const e=n.response?.jsonBody||n,t=e.items||e.mappings;if(!t||!Array.isArray(t))return Logger.warn("SYNC","Invalid cache format"),null;const i={...e,items:t},r=Date.now()-(i.timestamp||0);return r>this.config.cacheMaxAge?(Logger.info("SYNC",`Cache is stale (${Math.round(r/1e3)}s old), skipping`),null):(Logger.info("SYNC",`Service Cache loaded (${i.items.length} items, ${Math.round(r/1e3)}s old)`),i)}catch(n){return Logger.warn("SYNC","Failed to load Service Cache:",n),null}},async rebuildServiceCache(){if(!this.useServiceCache)return;if(window.MappingsStore.pending.size>0||window.MappingsStore.metadata.isOptimisticUpdate){Logger.debug("SYNC","Skipping cache rebuild - pending operations or optimistic updates exist");return}const n=this._hashMappings(window.MappingsStore.items);if(n===this.lastCacheHash){Logger.debug("SYNC","Skipping cache rebuild - no changes");return}Logger.info("SYNC","Rebuilding Service Cache");try{const e={timestamp:Date.now(),version:window.MappingsStore.metadata.serverVersion,items:Array.from(window.MappingsStore.items.values()),count:window.MappingsStore.items.size},t={...e,items:e.items.map(r=>{if(!r||typeof r!="object")return r;const o={...r};return delete o._pending,delete o._operation,delete o._deleted,delete o.__optimisticTs,o.request&&(delete o.request._pending,delete o.request._operation,delete o.request._deleted),o.response&&(delete o.response._pending,delete o.response._operation,delete o.response._deleted),o})},i={id:"00000000-0000-0000-0000-00000000cace",priority:1e3,request:{method:"GET",url:"/__imock/cache/v2"},response:{status:200,jsonBody:t}};try{await window.apiFetch(`/mappings/${i.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}catch(r){if(r.status===404)await window.apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});else throw r}this.lastCacheHash=n,Logger.info("SYNC",`Service Cache saved (${e.count} mappings)`)}catch(e){Logger.warn("SYNC","Failed to rebuild Service Cache:",e)}},_emit(n,e={}){return window.AppEvents&&typeof window.AppEvents.emit=="function"?window.AppEvents.emit(n,e):!1},_showLoadingState(){this._emit("sync:loading",{})||typeof window.showLoadingState=="function"&&window.showLoadingState()},_renderMappings(n,e={}){const t={source:n||"direct",skipSyncCheck:e.skipSyncCheck===!0,mappings:window.MappingsStore?.getAll?.()||[]};this._emit("sync:render-mappings",t)||typeof window.fetchAndRenderMappings=="function"&&window.fetchAndRenderMappings(t.mappings,{source:t.source,skipSyncCheck:t.skipSyncCheck})},_applyMappingFilters(){this._emit("sync:apply-mapping-filters",{})||window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function"&&window.FilterManager.applyMappingFilters()},_updateDataSourceIndicator(n){this._emit("sync:data-source",{source:n})||typeof window.updateDataSourceIndicator=="function"&&window.updateDataSourceIndicator(n)},_notifyWarning(n,e={}){this._emit("sync:notify",{level:"warning",message:n,...e})||window.NotificationManager&&typeof window.NotificationManager.warning=="function"&&window.NotificationManager.warning(n)},_detectChanges(n){const e=new Set(n.map(s=>s.id||s.uuid)),t=new Set(window.MappingsStore.items.keys()),i=[],r=[],o=[];return n.forEach(s=>{const c=s.id||s.uuid;if(!t.has(c))i.push(s);else{const l=window.MappingsStore.items.get(c);this._hasChanged(l,s)&&r.push(s)}}),t.forEach(s=>{e.has(s)||o.push(s)}),{added:i,updated:r,deleted:o,hasChanges:i.length>0||r.length>0||o.length>0}},_hasChanged(n,e){try{return JSON.stringify(n)!==JSON.stringify(e)}catch{return!0}},_handleConflicts(n){Logger.warn("SYNC",`Handling ${n.length} conflicts`),n.forEach(e=>{if(e.type==="delete"){Logger.warn("SYNC",`Conflict: mapping ${e.id} was deleted on server`);const t=e.local?.name||e.id;this._notifyWarning(`Mapping "${t}" was deleted by another user`,{type:"delete",mappingId:e.id,conflict:e}),window.MappingsStore.pending.delete(e.id)}else if(e.type==="update"){const t=this._getTimestamp(e.server),i=e.localTimestamp||Date.now();if(t>i){Logger.warn("SYNC",`Conflict: server version is newer for ${e.id}`);const r=e.server?.name||e.id;this._notifyWarning(`Your changes to "${r}" were overwritten by another user`,{type:"update",mappingId:e.id,conflict:e}),window.MappingsStore.rollbackPending(e.id,e.server)}else Logger.warn("SYNC",`Conflict: local version is newer for ${e.id}, keeping local`)}})},_getTimestamp(n){return n?.metadata?.edited||n?.metadata?.updated||n?.metadata?.created||0},_formatChangesSummary(n){const e=[];return n.added.length>0&&e.push(`+${n.added.length} added`),n.updated.length>0&&e.push(`~${n.updated.length} updated`),n.deleted.length>0&&e.push(`-${n.deleted.length} deleted`),e.join(", ")},_hashMappings(n){if(n.size===0)return"0:";const e=Array.from(n.keys());if(e.length>1e3){const t=e.slice(0,50).sort().join("|").substring(0,100),i=e.slice(-50).sort().join("|").substring(0,100),r=`${t}...${i}`;return`${n.size}:${this._simpleHash(r)}`}else{const t=e.sort().join(",");return`${n.size}:${t}`}},_simpleHash(n){let e=0;for(let t=0;t<n.length;t++){const i=n.charCodeAt(t);e=(e<<5)-e+i,e|=0}return Math.abs(e).toString(36)},_isServiceCacheMapping(n){return(n.id||n.uuid)==="00000000-0000-0000-0000-00000000cace"||n.request?.url?.includes("/__imock/cache")},_fetchWithTimeout(n,e){return Promise.race([n,new Promise((t,i)=>setTimeout(()=>i(new Error("Request timeout")),e))])},_showSyncIndicator(){if(this._emit("sync:indicator",{active:!0}))return;const n=document.getElementById("sync-indicator");n&&n.classList.add("is-active")},_hideSyncIndicator(){if(this._emit("sync:indicator",{active:!1}))return;const n=document.getElementById("sync-indicator");n&&n.classList.remove("is-active")}},typeof window<"u"&&window.SyncEngine.init(),(function(){if(window.__syncEngineUiBridgeReady)return;window.__syncEngineUiBridgeReady=!0;const e=(t,i)=>{!window.AppEvents||typeof window.AppEvents.on!="function"||window.AppEvents.on(t,i)};e("sync:loading",()=>{typeof window.showLoadingState=="function"&&window.showLoadingState()}),e("sync:render-mappings",t=>{if(typeof window.fetchAndRenderMappings!="function")return;const i=t?.detail||{},r=Array.isArray(i.mappings)?i.mappings:window.MappingsStore?.getAll?.()||[];window.fetchAndRenderMappings(r,{source:i.source||"direct",skipSyncCheck:i.skipSyncCheck===!0})}),e("sync:apply-mapping-filters",()=>{window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function"&&window.FilterManager.applyMappingFilters()}),e("sync:data-source",t=>{if(typeof window.updateDataSourceIndicator!="function")return;const i=t?.detail?.source;typeof i=="string"&&i.length>0&&window.updateDataSourceIndicator(i)}),e("sync:indicator",t=>{const i=document.getElementById("sync-indicator");if(!i)return;const r=t?.detail?.active===!0;i.classList.toggle("is-active",r)}),e("sync:notify",t=>{const i=t?.detail||{},r=i.level||"warning",o=i.message;!o||!window.NotificationManager||(typeof window.NotificationManager[r]=="function"?window.NotificationManager[r](o):typeof window.NotificationManager.warning=="function"&&window.NotificationManager.warning(o))}),e("wiremock:success",t=>{const i=t?.detail?.timestamp;if(typeof i=="number"&&(window.lastWiremockSuccess=i),window.Utils&&typeof window.Utils.safeCall=="function")window.Utils.safeCall(window.updateLastSuccessUI);else if(typeof window.updateLastSuccessUI=="function")try{window.updateLastSuccessUI()}catch{}})})();function normalizeScenarioNameValue(n){if(n==null)return{original:n,normalized:n,changed:!1,cleared:!1,hadWhitespace:!1};const e=typeof n=="string"?n:String(n),t=/\s/.test(e),i=e.trim().replace(/\s+/g,"_");return{original:e,normalized:i,changed:i!==e,cleared:!!e&&!i,hadWhitespace:t}}function normalizeScenarioNameField(n,{notify:e}={}){if(!n||typeof n!="object")return{changed:!1};if(!Object.prototype.hasOwnProperty.call(n,"scenarioName"))return{changed:!1};const i=(typeof window.Utils?.normalizeScenarioName=="function"?window.Utils.normalizeScenarioName:normalizeScenarioNameValue)(n.scenarioName);return!i?.changed||!i?.hadWhitespace?{changed:!1}:(i.cleared?(delete n.scenarioName,e?.("Scenario name contained only whitespace and was cleared")):(n.scenarioName=i.normalized,e?.(`Scenario name cannot contain spaces. Replaced with "${i.normalized}"`)),{changed:!0,original:i.original,normalized:i.normalized,cleared:i.cleared})}window.MappingsOperations={async create(n){const e={...n||{}};normalizeScenarioNameField(e,{notify:r=>window.NotificationManager?.warning?.(r)});const t=typeof crypto?.randomUUID=="function"?`temp-${crypto.randomUUID()}`:`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;Logger.info("OPS",`Creating mapping with temp ID: ${t}`);const i={...e,id:t,_pending:!0,_operation:"create"};try{window.MappingsStore.addPending({id:t,type:"create",payload:e,optimisticMapping:i}),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.info=="function"&&window.NotificationManager.info("Creating mapping...");const r=await this._sendCreateRequest(e),o=r.id||r.uuid;if(Logger.info("OPS",`Mapping created on server with ID: ${o}`),window.MappingsStore.confirmPending(t,r),this._refreshUI(),this._broadcastUpdate("created",r),window.NotificationManager&&typeof window.NotificationManager.success=="function"){const s=r.name||r.id.substring(0,8);window.NotificationManager.success(`Mapping "${s}" created successfully`)}return r}catch(r){throw Logger.error("OPS","Failed to create mapping:",r),window.MappingsStore.rollbackPending(t,null),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.error=="function"&&window.NotificationManager.error(`Failed to create mapping: ${r.message}`),r}},async update(n,e){Logger.info("OPS",`Updating mapping: ${n}`);const t=window.MappingsStore.get(n);if(!t)throw new Error(`Mapping ${n} not found`);if(window.MappingsStore.pending.has(n))throw Logger.warn("OPS",`Mapping ${n} already has pending operation`),new Error("Mapping has pending changes");const i={...e||{}},r={...t,...i,_pending:!0,_operation:"update",metadata:{...t.metadata,...i.metadata,edited:Date.now()}};normalizeScenarioNameField(r,{notify:o=>window.NotificationManager?.warning?.(o)});try{window.MappingsStore.addPending({id:n,type:"update",payload:i,optimisticMapping:r,original:t}),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.info=="function"&&window.NotificationManager.info("Saving changes...");const o=await this._sendUpdateRequest(n,r);if(Logger.info("OPS",`Mapping updated on server: ${n}`),window.MappingsStore.confirmPending(n,o),this._refreshUI(),this._broadcastUpdate("updated",o),window.NotificationManager&&typeof window.NotificationManager.success=="function"){const s=o.name||n.substring(0,8);window.NotificationManager.success(`Mapping "${s}" updated successfully`)}return o}catch(o){throw Logger.error("OPS","Failed to update mapping:",o),window.MappingsStore.rollbackPending(n,t),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.error=="function"&&window.NotificationManager.error(`Failed to update mapping: ${o.message}`),o}},async delete(n){Logger.info("OPS",`Deleting mapping: ${n}`);const e=window.MappingsStore.get(n);if(!e){Logger.warn("OPS",`Mapping ${n} not found, skipping delete`);return}const t={...e,_deleted:!0,_pending:!0,_operation:"delete"};try{if(window.MappingsStore.addPending({id:n,type:"delete",payload:null,optimisticMapping:t,original:e}),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.info=="function"){const i=e.name||n.substring(0,8);window.NotificationManager.info(`Deleting "${i}"...`)}if(await this._sendDeleteRequest(n),Logger.info("OPS",`Mapping deleted on server: ${n}`),window.MappingsStore.confirmPending(n,null),this._refreshUI(),this._broadcastUpdate("deleted",e),window.NotificationManager&&typeof window.NotificationManager.success=="function"){const i=e.name||n.substring(0,8);window.NotificationManager.success(`Mapping "${i}" deleted successfully`)}}catch(i){throw Logger.error("OPS","Failed to delete mapping:",i),window.MappingsStore.rollbackPending(n,e),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.error=="function"&&window.NotificationManager.error(`Failed to delete mapping: ${i.message}`),i}},async batchDelete(n){Logger.info("OPS",`Batch deleting ${n.length} mappings`);const e={success:[],failed:[]};for(const t of n)try{await this.delete(t),e.success.push(t)}catch(i){Logger.error("OPS",`Failed to delete ${t}:`,i),e.failed.push({id:t,error:i.message})}return Logger.info("OPS",`Batch delete complete: ${e.success.length} succeeded, ${e.failed.length} failed`),window.NotificationManager&&(e.failed.length===0?window.NotificationManager.success(`Deleted ${e.success.length} mappings`):window.NotificationManager.warning(`Deleted ${e.success.length} mappings, ${e.failed.length} failed`)),e},async _sendCreateRequest(n){const e=this._cleanMappingData(n);return await window.apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})},async _sendUpdateRequest(n,e){const t=this._cleanMappingData(e);return await window.apiFetch(`/mappings/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})||t},async _sendDeleteRequest(n){await window.apiFetch(`/mappings/${n}`,{method:"DELETE"})},_cleanMappingData(n){const e={...n};return delete e._pending,delete e._operation,delete e._deleted,e},_refreshUI(){if(!window.MappingsStore){Logger.warn("OPS","MappingsStore not available for UI refresh");return}if(typeof window.refreshMappingTabSnapshot=="function"&&window.refreshMappingTabSnapshot(),window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function")window.FilterManager.applyMappingFilters(),typeof window.FilterManager.flushMappingFilters=="function"&&window.FilterManager.flushMappingFilters();else{Logger.warn("OPS","FilterManager not available, rendering without filters");const n=window.MappingsStore.getAll();typeof window.fetchAndRenderMappings=="function"&&window.fetchAndRenderMappings(n,{source:"optimistic"})}},_broadcastUpdate(n,e){if(typeof BroadcastChannel<"u")try{new BroadcastChannel("imock-optimistic-updates").postMessage({type:"mapping-"+n,operation:n,mapping:e,source:"mappings-operations",timestamp:Date.now()}),Logger.debug("OPS",`Broadcasted ${n} update:`,e.id)}catch(t){Logger.warn("OPS","Failed to broadcast update:",t)}try{const t="imock-optimistic-update",i={type:"mapping-"+n,operation:n,mapping:e,source:"mappings-operations",timestamp:Date.now()};localStorage.setItem(t,JSON.stringify(i)),setTimeout(()=>{try{localStorage.removeItem(t)}catch{}},1e3)}catch(t){Logger.warn("OPS","Failed to update localStorage:",t)}}};function isOptimisticShadowMap(n){return n&&typeof n=="object"&&typeof n.forEach=="function"&&typeof n.size=="number"&&Object.prototype.toString.call(n)==="[object Map]"}window.mappingPreviewState instanceof Set||(window.mappingPreviewState=new Set),window.mappingPreviewToastState instanceof Map||(window.mappingPreviewToastState=new Map),isOptimisticShadowMap(window.optimisticShadowMappings)||(window.optimisticShadowMappings=new Map);const UIComponents={createCard:(n,e,t=[])=>{const{id:i,method:r,url:o,status:s,name:c,time:l,extras:d={},expanded:m=!1}=e,h={editMapping:"edit-external",openEditModal:"edit-mapping",deleteMapping:"delete-mapping",duplicateMapping:"duplicate-mapping",viewRequestDetails:"view-request"};return`
            <div class="${n}-card${m?" is-expanded":""}" data-id="${Utils.escapeHtml(i)}">
                <div class="${n}-header" data-action="toggle-details">
                    <div class="${n}-info">
                        <div class="${n}-top-line">
                            <span class="method-badge ${r.toLowerCase()}">
                                <span class="collapse-arrow" id="arrow-${Utils.escapeHtml(i)}">${m?"\u25BC":"\u25B6"}</span> ${r}
                            </span>
                            ${c?`<span class="${n}-name">${Utils.escapeHtml(c)}</span>`:""}
                            ${l?`<span class="${n}-time">${l}</span>`:""}
                        </div>
                        <div class="${n}-url-line">
                            <span class="status-badge ${Utils.getStatusClass(s)}">${s}</span>
                            <span class="${n}-url">${Utils.escapeHtml(o)}</span>
                            ${d.badges||""}
                        </div>
                    </div>
                    <div class="${n}-actions">
                        ${t.map(S=>{const I=h[S.handler]||S.handler;return`
                            <button class="btn btn-sm btn-${S.class}"
                                    data-action="${I}"
                                    data-${n}-id="${Utils.escapeHtml(i)}"
                                    title="${Utils.escapeHtml(S.title)}">
                                ${S.icon?Icons.render(S.icon,{className:"action-icon"}):""}
                                <span class="sr-only">${Utils.escapeHtml(S.title)}</span>
                            </button>
                        `}).join("")}
                    </div>
                </div>
                <div class="${n}-preview" id="preview-${Utils.escapeHtml(i)}" style="display: ${m?"block":"none"};">
                    ${d.preview||""}
                </div>
            </div>`},getCardElement(n,e){const t=document.querySelectorAll(`.${n}-card`),i=String(e??"");for(const r of t)if((r.dataset?.id||"")===i)return r;return null},setCardState(n,e,t,i=!0){const r=this.getCardElement(n,e);r&&r.classList.toggle(t,!!i)},clearCardState(n,e){document.querySelectorAll(`.${n}-card.${e}`).forEach(t=>{t.classList.remove(e)})},createPreviewSection:(n,e)=>`
        <div class="preview-section">
            <h4>${n}</h4>
            ${Object.entries(e).map(([t,i])=>{if(!i)return"";if(typeof i=="object")if(JSON.stringify(i).length>500){const o=Utils.formatJson(i,"Invalid JSON",200),s=`full-${Math.random().toString(36).substr(2,9)}`;return`<div class="preview-value">
                            <strong>${t}:</strong>
                            <pre>${o}</pre>
                            <button class="btn btn-secondary btn-small" data-action="show-full-content" data-target-id="${s}" data-json="${Utils.escapeHtml(JSON.stringify(i))}" style="margin-top: 0.5rem; font-size: 0.8rem;">
                                Show Full Content
                            </button>
                            <div id="${s}" style="display: none;"></div>
                        </div>`}else return`<div class="preview-value"><strong>${t}:</strong><pre>${Utils.formatJson(i)}</pre></div>`;else if(typeof i=="string"){const r=i.trim();if(r.startsWith("{")&&r.endsWith("}"))try{const c=JSON.parse(r);if(JSON.stringify(c).length>500){const d=Utils.formatJson(c,"Invalid JSON",200),m=`full-${Math.random().toString(36).substr(2,9)}`;return`<div class="preview-value">
                                    <strong>${t}:</strong>
                                    <pre>${d}</pre>
                                    <button class="btn btn-secondary btn-small" data-action="show-full-content" data-target-id="${m}" data-json="${Utils.escapeHtml(JSON.stringify(c))}" style="margin-top: 0.5rem; font-size: 0.8rem;">
                                        Show Full Content
                                    </button>
                                    <div id="${m}" style="display: none;"></div>
                                </div>`}return`<div class="preview-value"><strong>${t}:</strong><pre>${Utils.formatJson(c)}</pre></div>`}catch{}const o=Utils.escapeHtml(i),s=o.includes(`
`)?`<pre>${o}</pre>`:o;return`<div class="preview-value"><strong>${t}:</strong> ${s}</div>`}else{const r=Utils.escapeHtml(String(i));return`<div class="preview-value"><strong>${t}:</strong> ${r}</div>`}}).join("")}
        </div>`,toggleDetails:(n,e)=>{const t=String(n??""),i=document.getElementById(`preview-${n}`),r=document.getElementById(`arrow-${n}`),o=i?i.style.display==="none":!1;if(i&&(i.style.display=o?"block":"none"),r&&(r.textContent=o?"\u25BC":"\u25B6"),e==="mapping"){const s=i?i.closest(`.${e}-card`):null;s&&s.classList.toggle("is-expanded",o),window.mappingPreviewState instanceof Set&&(o?window.mappingPreviewState.add(t):window.mappingPreviewState.delete(t))}UIComponents.setCardState(e,n,"is-expanded",o)},toggleFullContent:n=>{const e=document.getElementById(n),t=e.previousElementSibling;if(e.style.display==="none")try{const i=t.getAttribute("data-json"),r=JSON.parse(i);e.innerHTML=`<pre style="max-height: 300px; overflow-y: auto; background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-sm); margin-top: 0.5rem;">${Utils.escapeHtml(JSON.stringify(r,null,2))}</pre>`,e.style.display="block",t.textContent="Hide Full Content"}catch(i){e.innerHTML=`<div class="preview-value warning">Error parsing JSON: ${Utils.escapeHtml(i.message)}</div>`,e.style.display="block",t.textContent="Hide"}else e.style.display="none",t.textContent="Show Full Content"}};window.toggleFullContent=UIComponents.toggleFullContent,window.toggleDetails=UIComponents.toggleDetails;function getOptimisticShadowTtl(){const n=Number(window.DEFAULT_SETTINGS?.optimisticCacheAgeLimit);return Number.isFinite(n)&&n>0?Math.max(n,45e3):6e4}function cloneMappingForOptimisticShadow(n){if(!n||typeof n!="object")return null;try{return typeof structuredClone=="function"?structuredClone(n):JSON.parse(JSON.stringify(n))}catch{return{...n}}}function rememberOptimisticShadowMapping(n,e){if(isOptimisticShadowMap(window.optimisticShadowMappings)||(window.optimisticShadowMappings=new Map),!n||typeof n!="object")return;const t=n.id||n.uuid;if(!t)return;const i=typeof e=="string"?e.toLowerCase():"update";if(i==="delete"){window.optimisticShadowMappings.delete(String(t));return}const r=cloneMappingForOptimisticShadow(n);r&&(typeof r.__optimisticTs!="number"&&Object.defineProperty(r,"__optimisticTs",{value:Date.now(),writable:!1,enumerable:!1,configurable:!0}),window.optimisticShadowMappings.set(String(t),{ts:Date.now(),op:i==="create"?"create":"update",mapping:r}))}function getOptimisticShadowTimestamp(n){if(!n||typeof n!="object")return Number.NaN;const e=n.metadata||{},t=[e.edited,e.updated,e.updatedAt,e.created,e.timestamp];for(const i of t){if(!i)continue;if(i instanceof Date){const s=i.getTime();if(Number.isFinite(s))return s}const r=Date.parse(i);if(Number.isFinite(r))return r;const o=Number(i);if(Number.isFinite(o))return o}return typeof n.__optimisticTs=="number"?n.__optimisticTs:Number.NaN}function applyOptimisticShadowMappings(n){if(!Array.isArray(n)||!isOptimisticShadowMap(window.optimisticShadowMappings)||window.optimisticShadowMappings.size===0)return n;const e=Date.now(),t=getOptimisticShadowTtl(),i=[...n];for(const[r,o]of Array.from(window.optimisticShadowMappings.entries())){const s=String(r||"");if(!o||typeof o!="object"){window.optimisticShadowMappings.delete(s);continue}if(o.mapping==null){const l=i.findIndex(d=>String(d?.id||d?.uuid||"")===s);l!==-1&&i.splice(l,1),window.optimisticShadowMappings.delete(s);continue}if(!Number.isFinite(o.ts)||e-o.ts>t){window.optimisticShadowMappings.delete(s);continue}const c=i.findIndex(l=>String(l?.id||l?.uuid||"")===s);if(c!==-1){let l=!1,d=!0;if(typeof window.getMappingRenderSignature=="function")try{const m=window.getMappingRenderSignature(i[c]),h=window.getMappingRenderSignature(o.mapping);if(m===h){window.optimisticShadowMappings.delete(s);continue}}catch{}if((o.op||"update")==="create")d=!1;else{const m=getOptimisticShadowTimestamp(i[c]),h=getOptimisticShadowTimestamp(o.mapping);Number.isFinite(h)&&(!Number.isFinite(m)||h>m)?l=!0:d=!1}l?(o.ts=e,i[c]=o.mapping):d?o.ts=e:window.optimisticShadowMappings.delete(s)}else i.unshift(o.mapping),Number.isFinite(o.ts)||(o.ts=e)}return i}function pruneOptimisticShadowMappings(n){if(!isOptimisticShadowMap(window.optimisticShadowMappings)||window.optimisticShadowMappings.size===0||!Array.isArray(n)||n.length===0)return;const e=new Map;n.forEach(t=>{if(t&&typeof t=="object"){const i=String(t.id||t.uuid||"");i&&e.set(i,t)}});for(const[t,i]of Array.from(window.optimisticShadowMappings.entries())){if(!e.has(t))continue;if(!i||typeof i!="object"){window.optimisticShadowMappings.delete(t);continue}if((i.op||"update")==="create")continue;if(!i.mapping||typeof i.mapping!="object"){window.optimisticShadowMappings.delete(t);continue}const r=e.get(t);if(!r){window.optimisticShadowMappings.delete(t);continue}try{if(typeof window.getMappingRenderSignature=="function"&&i.mapping){const c=window.getMappingRenderSignature(r),l=window.getMappingRenderSignature(i.mapping);if(c===l){window.optimisticShadowMappings.delete(t);continue}}}catch{}const o=getOptimisticShadowTimestamp(r),s=getOptimisticShadowTimestamp(i.mapping);Number.isFinite(o)&&(!Number.isFinite(s)||o>=s)&&window.optimisticShadowMappings.delete(t)}}window.fetchAndRenderMappings=async(n=null,e={})=>{const t=document.getElementById(SELECTORS.LISTS.MAPPINGS),i=document.getElementById(SELECTORS.EMPTY.MAPPINGS),r=document.getElementById(SELECTORS.LOADING.MAPPINGS);if(!t||!i||!r)return Logger.error("UI","Required DOM elements not found for mappings rendering"),!1;const o=e?.skipSyncCheck===!0;if(!o&&window.MappingsStore?.metadata?.isRendering)return window.MappingsStore.metadata.pendingRenderRequest={mappingsToRender:Array.isArray(n)?[...n]:null,options:{...e||{},skipSyncCheck:!0,_queuedRender:!0}},Logger.debug("UI","Render in progress, queued next render to avoid lost updates"),!0;if(!o&&window.MappingsStore?.metadata?.isSyncing)return Logger.debug("UI","Sync in progress, skipping render to avoid race condition"),!0;window.MappingsStore?.metadata&&(window.MappingsStore.metadata.isRendering=!0);let s=null;try{if(n===null){r.classList.remove("hidden"),t.style.display="none",i.classList.add("hidden"),i.setAttribute("aria-hidden","true");let S,I="direct";if(e&&e.useCache){const w=await loadImockCacheBestOf3();if(w&&w.data&&Array.isArray(w.data.mappings)){Logger.cache("Cache hit - using cached data for quick start"),I="cache";const A=typeof w.data.timestamp=="number"?w.data.timestamp:(w.data.mappings||[]).reduce((D,V)=>{const H=V?.metadata?.imock?.timestamp;return typeof H=="number"&&H>D?H:D},0);Date.now()-A>3e4&&(async()=>{try{const D=typeof window<"u"&&typeof window.optimisticUpdateDelayMs=="number"?window.optimisticUpdateDelayMs:500;await new Promise(H=>setTimeout(H,D));const V=await fetchMappingsFromServer({force:!0});if(V&&V.mappings){const H=V.mappings.filter(x=>!isImockCacheMapping(x)),de=(w.data.mappings||[]).filter(x=>!isImockCacheMapping(x));if(de.length!==H.length){if(window.MappingsStore&&window.MappingsStore.setFromServer(H),refreshMappingTabSnapshot(),syncCacheWithMappings(H),rebuildMappingIndex(H),typeof NotificationManager<"u"){const x=H.length-de.length;x>0?NotificationManager.info(`${x} new mapping${x===1?"":"s"} from server`,3e3):x<0&&NotificationManager.info(`${Math.abs(x)} mapping${Math.abs(x)===1?"":"s"} removed on server`,3e3),Logger.cache("Cache updated with server data:",{cachedCount:de.length,serverCount:H.length})}}else Logger.debug("CACHE","No changes detected, skipping cache update")}}catch(D){Logger.warn("CACHE","Background cache validation failed:",D)}})(),S=w.data}else{Logger.cache("Cache miss - loading from server"),typeof NotificationManager<"u"&&NotificationManager.info("Loading mappings from server...",2e3),S=await fetchMappingsFromServer({force:!0}),I="direct";try{Logger.cache("Async regenerate after cache miss"),regenerateImockCache()}catch{}}}else S=await fetchMappingsFromServer({force:!0}),I="direct";if(S&&S.__source){I=S.__source,I==="demo"&&markDemoModeActive("mappings-fallback");try{delete S.__source}catch{}}let T=S.mappings||[];const v=window.MappingsStore?.pending?Array.from(window.MappingsStore.pending.values()):[];v.length>0&&(Logger.debug("OPTIMISTIC","Applying optimistic updates to incoming data:",v.length,"updates"),T=T.map(w=>{const A=w.id||w.uuid,N=window.MappingsStore?.pending?window.MappingsStore.pending.get(A):null;return N?N.type==="delete"?(Logger.debug("OPTIMISTIC","Removing deleted mapping from results:",w.id),null):(Logger.debug("OPTIMISTIC","Using optimistic version for:",w.id),N.optimisticMapping):w}).filter(w=>w!==null),v.forEach(w=>{w.type!=="delete"&&!T.some(A=>(A.id||A.uuid)===w.id)&&(Logger.debug("OPTIMISTIC","Adding new optimistic mapping:",w.id),T.unshift(w.optimisticMapping))})),T=applyOptimisticShadowMappings(T);try{if(window.pendingDeletedIds&&window.pendingDeletedIds.size>0){const w=T.length;T=T.filter(A=>!window.pendingDeletedIds.has(A.id||A.uuid)),w!==T.length&&Logger.cache("filtered pending-deleted from render:",w-T.length)}}catch{}const g=Array.isArray(T)?T.filter(w=>!isImockCacheMapping(w)):[];window.MappingsStore&&window.MappingsStore.setFromServer(g),refreshMappingTabSnapshot(),syncCacheWithMappings(g),rebuildMappingIndex(g),pruneOptimisticShadowMappings(g),s=I}else{const S=typeof e?.source=="string"?e.source:null,I=Array.isArray(n)?[...n]:[];window.MappingsStore&&window.MappingsStore.setFromServer(I),refreshMappingTabSnapshot(),rebuildMappingIndex(I),pruneOptimisticShadowMappings(I),s=S,s==="demo"&&markDemoModeActive("manual-mappings")}r.classList.add("hidden");const c=document.getElementById(SELECTORS.MAPPING_FILTERS.QUERY)?.value?.trim()||"";let l=window.MappingsStore?window.MappingsStore.getAll():Array.isArray(n)?n:[];if(c&&window.QueryParser&&typeof window.QueryParser.filterMappingsByQuery=="function"&&(Logger.debug("UI","Applying filters before render:",c),l=window.QueryParser.filterMappingsByQuery(l,c)),window._filteredMappings=l,l.length===0)return i.classList.remove("hidden"),i.setAttribute("aria-hidden","false"),t.style.display="none",updateMappingsCounter(),s&&updateDataSourceIndicator(s),!0;i.classList.add("hidden"),i.setAttribute("aria-hidden","true"),t.style.display="block",window.invalidateElementCache(SELECTORS.LISTS.MAPPINGS);const d=l,m=typeof window.sortMappingsForDisplay=="function"?window.sortMappingsForDisplay(d):[...d],h=s||"previous";Logger.info("UI",`Mappings render from: ${h} \u2014 ${m.length} items`);try{if(t.style.willChange="contents",window.PaginationManager&&Logger.debug("UI",`Rendering page ${window.PaginationManager.currentPage}/${window.PaginationManager.totalPages}`),typeof window.renderMappingsCollection=="function")window.renderMappingsCollection(t,m,{preSorted:!0,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});else if(window.PaginationManager){window.PaginationManager.updateState(m.length);const I=window.PaginationManager.getCurrentPageItems(m);renderList(t,I,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const T=document.getElementById("mappings-pagination");T&&(T.innerHTML=window.PaginationManager.renderControls())}else renderList(t,m,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const S=()=>{updateMappingsCounter(),s&&updateDataSourceIndicator(s),t.style.willChange="auto";try{document.getElementById(SELECTORS.MAPPING_FILTERS.QUERY)?.value?.trim()&&typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay()}catch{}};typeof requestAnimationFrame=="function"?requestAnimationFrame(S):S()}catch(S){if(Logger.error("UI","DOM batch update failed:",S),typeof window.renderMappingsCollection=="function")window.renderMappingsCollection(t,m,{preSorted:!0,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});else if(window.PaginationManager){window.PaginationManager.updateState(m.length);const I=window.PaginationManager.getCurrentPageItems(m);renderList(t,I,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const T=document.getElementById("mappings-pagination");T&&(T.innerHTML=window.PaginationManager.renderControls())}else renderList(t,m,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});updateMappingsCounter(),s&&updateDataSourceIndicator(s)}return!0}catch(c){Logger.error("UI","Error in fetchAndRenderMappings:",c);let l="Failed to load mappings";return c.status===401||c.message&&c.message.includes("401")?l="Authorization error: Please check your credentials":c.status===403||c.message&&c.message.includes("403")?l="Access forbidden: Check your permissions":c.status===404||c.message&&c.message.includes("404")?l="Server endpoint not found":c.message&&c.message.includes("timeout")?l="Request timeout: Server not responding":c.message&&(l=`Failed to load mappings: ${c.message}`),NotificationManager.error(l),r.classList.add("hidden"),i.classList.remove("hidden"),t.style.display="none",!1}finally{if(window.MappingsStore?.metadata){window.MappingsStore.metadata.isRendering=!1;const c=window.MappingsStore.metadata.pendingRenderRequest;if(c&&!e?._queuedRender){window.MappingsStore.metadata.pendingRenderRequest=null;const l=()=>{window.fetchAndRenderMappings(c.mappingsToRender,c.options)};typeof requestAnimationFrame=="function"?requestAnimationFrame(l):setTimeout(l,0)}else window.MappingsStore.metadata.pendingFilterRender&&(window.MappingsStore.metadata.pendingFilterRender=!1,window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function"&&window.FilterManager.applyMappingFilters())}}},window.refreshMappingsFromCache=async(n="cache")=>{try{if(!window.MappingsStore)return Logger.warn("CACHE","MappingsStore not available"),!1;const t=window.MappingsStore.getAll().filter(r=>!isImockCacheMapping(r));window.MappingsStore.setFromServer(t),typeof refreshMappingTabSnapshot=="function"&&refreshMappingTabSnapshot(),typeof rebuildMappingIndex=="function"&&rebuildMappingIndex(t),typeof pruneOptimisticShadowMappings=="function"&&pruneOptimisticShadowMappings(t),typeof updateDataSourceIndicator=="function"&&updateDataSourceIndicator(n||"cache");const i=window.MappingsStore?window.MappingsStore.getAll():[];return await fetchAndRenderMappings(i,{source:n||"cache"})}catch(e){return Logger.warn("CACHE","refreshMappingsFromCache failed:",e),!1}},window.initMappingPagination=function(){if(!window.PaginationManager){Logger.warn("UI","PaginationManager not available");return}window.PaginationManager.init("#mappings-pagination",20),window.PaginationManager.attachListeners(n=>{Logger.debug("UI",`Page changed to: ${n}`);const e=document.getElementById(SELECTORS.LISTS.MAPPINGS),t=window.MappingsStore?window.MappingsStore.getAll():[];if(!e||!Array.isArray(t)){Logger.warn("UI","Cannot render page: container or data not available");return}const i=typeof window.sortMappingsForDisplay=="function"?window.sortMappingsForDisplay(t):[...t],r=window.PaginationManager.getCurrentPageItems(i);window.invalidateElementCache(SELECTORS.LISTS.MAPPINGS),renderList(e,r,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const o=document.getElementById("mappings-pagination");o&&(o.innerHTML=window.PaginationManager.renderControls());const s=document.getElementById("mappings-page");s&&s.scrollIntoView({behavior:"smooth",block:"start"})}),Logger.info("UI","Mapping pagination initialized")},window.getMappingById=async n=>{try{if(!n)throw new Error("Mapping ID is required");Logger.debug("CACHE",`Fetching mapping with ID: ${n}`),Logger.debug("CACHE","Current wiremockBaseUrl:",window.wiremockBaseUrl);const e=window.MappingsStore?window.MappingsStore.getAll():[];Logger.debug("CACHE","MappingsStore available:",!!window.MappingsStore),Logger.debug("CACHE","Cache size:",e?.length||0);let t=window.MappingsStore?window.MappingsStore.get(n):null;if(t||(t=e.find(o=>o.id===n||o.uuid===n)||null),t)return Logger.cache(`Found mapping in cache: ${n}`,t),t;Logger.cache("Mapping not found in cache, will fetch from API"),Logger.api(`Making API call to: /mappings/${n}`);const i=await apiFetch(`/mappings/${n}`);Logger.api("Raw API response:",i);const r=i&&typeof i=="object"&&i.mapping?i.mapping:i;if(Logger.debug("CACHE","Processed mapping:",r),!r||typeof r!="object")throw Logger.error("CACHE",`API returned invalid data for mapping ${n}`),new Error(`Mapping with ID ${n} not found or invalid response`);return Logger.info("CACHE",`Successfully fetched mapping: ${n}`,r),addMappingToIndex(r),r}catch(e){throw Logger.error("CACHE",`Error fetching mapping ${n}:`,e),Logger.error("CACHE","Error details:",{message:e.message,status:e.status,statusText:e.statusText,url:`${window.wiremockBaseUrl}/mappings/${n}`}),e}},window.duplicateMapping=async n=>{const e=(n??"").toString().trim();if(!e){NotificationManager.error("Invalid mapping identifier");return}if(!window.TemplateManager?.createMappingsFromPayloads){NotificationManager.error("Mapping duplication is not available");return}try{const t=await window.getMappingById(e);if(!t)throw new Error("Mapping not found");await window.TemplateManager.createMappingsFromPayloads([t],{openMode:"inline",source:"duplicate",successMessageFactory:i=>`Duplicated ${i} mapping${i===1?"":"s"}`})}catch(t){Logger.error("OPTIMISTIC","Failed to duplicate mapping:",t),NotificationManager.error(`Failed to duplicate mapping: ${t.message}`)}},window.applyOptimisticMappingUpdate=n=>{try{if(!n){Logger.warn("OPTIMISTIC","No mapping data provided");return}const e=n.mapping||n,t=e?.id||e?.uuid;if(!e||!t){Logger.warn("OPTIMISTIC","Invalid mapping data - missing id:",e);return}if(isImockCacheMapping(e)){Logger.debug("OPTIMISTIC","Skipping cache mapping update");return}const i=window.MappingsStore&&window.MappingsStore.items instanceof Map,r=i&&window.MappingsStore.items.has(t)?"update":"create";if(rememberOptimisticShadowMapping(e,r),typeof updateOptimisticCache=="function")updateOptimisticCache(e,r,{queueMode:"add"});else{if(i){try{window.MappingsStore.addPending({id:t,type:r,payload:e,optimisticMapping:e})}catch(s){Logger.warn("OPTIMISTIC","Failed to enqueue optimistic update:",s)}const o=cloneMappingForCache(e);if(!o)Logger.warn("OPTIMISTIC","Failed to clone mapping for store:",t);else{if(!o.id&&t&&(o.id=t),!o.uuid&&(e.uuid||t)&&(o.uuid=e.uuid||t),window.MappingsStore.items.has(t)){const s=mergeMappingData(window.MappingsStore.items.get(t),o);window.MappingsStore.items.set(t,s)}else window.MappingsStore.items.set(t,o);typeof window.MappingsStore.rebuildIndexes=="function"&&window.MappingsStore.rebuildIndexes()}}window.cacheLastUpdate=Date.now(),window.MappingsStore.metadata.isOptimisticUpdate||(window.MappingsStore.metadata.isOptimisticUpdate=!0,setTimeout(()=>{window.MappingsStore.metadata.isOptimisticUpdate=!1},1e3)),refreshMappingsFromCache()}Logger.debug("OPTIMISTIC","Applied update for mapping:",t)}catch(e){Logger.warn("OPTIMISTIC","Update failed:",e)}},window.backgroundRefreshMappings=async(n=!1)=>{try{if(!window.MappingsStore){Logger.warn("CACHE","MappingsStore not available for background refresh");return}let e,t="direct";if(n){const o=await loadImockCacheBestOf3();o&&o.data&&Array.isArray(o.data.mappings)?(e=o.data,t="cache"):(e=await fetchMappingsFromServer({force:!0}),t="direct")}else e=await fetchMappingsFromServer({force:!0}),t="direct";let i=e.mappings||[];i=applyOptimisticShadowMappings(i);try{if(window.pendingDeletedIds instanceof Set&&window.pendingDeletedIds.size>0){const o=i.length;i=i.filter(s=>{if(!s||typeof s!="object")return!0;const c=s.id||s.uuid;return!window.pendingDeletedIds.has(c)}),o!==i.length&&Logger.cache("background refresh filtered pending-deleted mappings:",o-i.length)}}catch(o){Logger.warn("CACHE","Failed to filter pending deletions during background refresh:",o)}const r=Array.isArray(i)?i.filter(o=>!isImockCacheMapping(o)):[];window.MappingsStore&&window.MappingsStore.setFromServer(r),refreshMappingTabSnapshot(),syncCacheWithMappings(r),rebuildMappingIndex(r),pruneOptimisticShadowMappings(r),updateDataSourceIndicator(t),setTimeout(()=>{const o=window.MappingsStore?window.MappingsStore.getAll():[];fetchAndRenderMappings(o)},0)}catch(e){Logger.warn("CACHE","Background refresh failed:",e)}},window.renderMappingCard=function(n){if(!n||!n.id)return Logger.warn("CACHE","Invalid mapping data:",n),"";const e=[{class:"secondary",handler:"duplicateMapping",title:"Duplicate",icon:"clipboard"},{class:"secondary",handler:"editMapping",title:"Edit in Editor",icon:"open-external"},{class:"primary",handler:"openEditModal",title:"Edit",icon:"pencil"},{class:"danger",handler:"deleteMapping",title:"Delete",icon:"trash"}],t=String(n.id||n.uuid||""),i=window.mappingPreviewState instanceof Set&&window.mappingPreviewState.has(t),r={id:n.id,method:n.request?.method||"GET",url:n.request?.urlPath||n.request?.urlPathPattern||n.request?.urlPattern||n.request?.url||"N/A",status:n.response?.status||200,name:n.name||n.metadata?.name||`Mapping ${n.id.substring(0,8)}`,expanded:i,extras:{preview:i?UIComponents.createPreviewSection(`${Icons.render("request-in",{className:"icon-inline"})} Request`,{Method:n.request?.method||"GET",URL:n.request?.url||n.request?.urlPattern||n.request?.urlPath||n.request?.urlPathPattern,Headers:n.request?.headers,Body:n.request?.bodyPatterns||n.request?.body,"Query Parameters":n.request?.queryParameters})+UIComponents.createPreviewSection(`${Icons.render("response-out",{className:"icon-inline"})} Response`,{Status:n.response?.status,Headers:n.response?.headers,Body:n.response?.jsonBody||n.response?.body,Delay:n.response?.fixedDelayMilliseconds?`${n.response.fixedDelayMilliseconds}ms`:null})+UIComponents.createPreviewSection(`${Icons.render("info",{className:"icon-inline"})} Overview`,{ID:n.id||n.uuid,Name:n.name||n.metadata?.name,Priority:n.priority,Persistent:n.persistent,Scenario:n.scenarioName,"Required State":n.requiredScenarioState,"New State":n.newScenarioState,Created:window.showMetaTimestamps!==!1&&n.metadata?.created?new Date(n.metadata.created).toLocaleString():null,Edited:window.showMetaTimestamps!==!1&&n.metadata?.edited?new Date(n.metadata.edited).toLocaleString():null,Source:n.metadata?.source?`Edited from ${n.metadata.source}`:null}):"",badges:[n.id||n.uuid?`<span class="badge badge-secondary" title="Mapping ID">${Utils.escapeHtml((n.id||n.uuid).length>12?(n.id||n.uuid).slice(0,8)+"\u2026"+(n.id||n.uuid).slice(-4):n.id||n.uuid)}</span>`:"",typeof n.priority=="number"?`<span class="badge badge-secondary" title="Priority">P${n.priority}</span>`:"",n.scenarioName?`<span class="badge badge-secondary" title="Scenario">${Utils.escapeHtml(n.scenarioName)}</span>`:"",window.showMetaTimestamps!==!1&&n.metadata?.created?`<span class="badge badge-secondary" title="Created">C: ${new Date(n.metadata.created).toLocaleString()}</span>`:"",window.showMetaTimestamps!==!1&&n.metadata?.edited?`<span class="badge badge-secondary" title="Edited">E: ${new Date(n.metadata.edited).toLocaleString()}</span>`:"",n.metadata?.source?`<span class="badge badge-info" title="Last edited from">${n.metadata.source.toUpperCase()}</span>`:""].filter(Boolean).join(" ")}};return UIComponents.createCard("mapping",r,e)},window.updateMappingsCounter=function(){const n=document.getElementById(SELECTORS.COUNTERS.MAPPINGS);if(n){const e=window.MappingsStore?window.MappingsStore.getAll():[];n.textContent=Array.isArray(e)?e.length:0}};function updateDataSourceIndicator(n){const e=document.getElementById("data-source-indicator");if(!e)return;let t="Source: direct",i="badge badge-secondary";switch(n){case"cache":t="Source: cache",i="badge badge-success";break;case"cache_rebuilding":t="Source: cache (rebuilding\u2026)",i="badge badge-success";break;case"synced":t="Source: synced",i="badge badge-success";break;case"demo":t="Source: demo data",i="badge badge-info";break;case"custom":t="Source: custom",i="badge badge-secondary";break;case"remote":t="Source: remote",i="badge badge-warning";break;case"remote_error":t="Source: remote (error/CORS)",i="badge badge-danger";break;default:t="Source: direct",i="badge badge-secondary"}e.textContent=t,e.className=i}function updateRequestsSourceIndicator(n){const e=document.getElementById("requests-source-indicator");if(!e)return;let t="Requests: direct",i="badge badge-secondary";switch(n){case"custom":t="Requests: custom",i="badge badge-secondary";break;case"demo":t="Requests: demo data",i="badge badge-info";break;case"remote":t="Requests: remote",i="badge badge-warning";break;case"remote_error":t="Requests: remote (error/CORS)",i="badge badge-danger";break;default:t="Requests: direct",i="badge badge-secondary"}e.textContent=t,e.className=i}function handleMappingItemChanged(n,e){const t=String(n||"");if(!(window.mappingPreviewState instanceof Set)||!window.mappingPreviewState.has(t))return;if(window.mappingPreviewToastState instanceof Map){const r=Date.now(),o=window.mappingPreviewToastState.get(t)||0;if(r-o<4e3)return;window.mappingPreviewToastState.set(t,r)}const i=e?.name||e?.metadata?.name||t;window.NotificationManager&&typeof window.NotificationManager.info=="function"&&window.NotificationManager.info(`Mapping "${i}" refreshed with latest data.`)}function handleMappingItemRemoved(n){const e=String(n||"");window.mappingPreviewState instanceof Set&&window.mappingPreviewState.delete(e),window.mappingPreviewToastState instanceof Map&&window.mappingPreviewToastState.delete(e),isOptimisticShadowMap(window.optimisticShadowMappings)&&window.optimisticShadowMappings.delete(e)}window.toggleMappingDetails=n=>UIComponents.toggleDetails(n,"mapping"),window.toggleRequestDetails=n=>UIComponents.toggleDetails(n,"request"),window.UIComponents=UIComponents,window.updateDataSourceIndicator=updateDataSourceIndicator,window.updateRequestsSourceIndicator=updateRequestsSourceIndicator,window.fetchAndRenderRequests=async(n=null,e={})=>{const t=document.getElementById(SELECTORS.LISTS.REQUESTS),i=document.getElementById(SELECTORS.EMPTY.REQUESTS),r=document.getElementById(SELECTORS.LOADING.REQUESTS);if(!t||!i||!r)return Logger.error("REQUESTS","Required DOM elements not found for requests rendering"),!1;try{let o="direct";if(n===null){r.classList.remove("hidden"),t.style.display="none",i.classList.add("hidden");let s;try{s=await apiFetch(ENDPOINTS.REQUESTS)}catch(l){const d=l?.message||"",m=/^HTTP\s+404\b/.test(d),h=l?.name==="SyntaxError"||/Unexpected end of JSON input/i.test(d);if(m||h)Logger.warn("REQUESTS","Requests endpoint returned no payload; treating as empty list.",l),s={requests:[],__source:"empty"};else throw window.demoModeLastError=l,l}if(s&&s.__source){o=s.__source,o==="demo"&&markDemoModeActive("requests-fallback");try{delete s.__source}catch{}}(!s||typeof s!="object")&&(s={requests:[]});const c=Array.isArray(s.requests)?s.requests:[];window.originalRequests=c,refreshRequestTabSnapshot(),window.allRequests=[...c]}else{const s=e?.source;window.allRequests=Array.isArray(n)?[...n]:[],window.originalRequests=[...window.allRequests],refreshRequestTabSnapshot(),o=s||"custom",o==="demo"&&markDemoModeActive("manual-requests")}return r.classList.add("hidden"),window.allRequests.length===0?(i.classList.remove("hidden"),t.style.display="none",updateRequestsCounter(),!0):(i.classList.add("hidden"),t.style.display="block",window.invalidateElementCache(SELECTORS.LISTS.REQUESTS),renderList(t,window.allRequests,{renderItem:window.renderRequestMarkup,getKey:window.getRequestRenderKey,getSignature:window.getRequestRenderSignature}),updateRequestsCounter(),typeof updateRequestsSourceIndicator=="function"&&updateRequestsSourceIndicator(o),Logger.info("REQUESTS",`Requests render from: ${o} \u2014 ${window.allRequests.length} items`),!0)}catch(o){return Logger.error("REQUESTS","Error in fetchAndRenderRequests:",o),NotificationManager.error(`Failed to load requests: ${o.message}`),r.classList.add("hidden"),i.classList.remove("hidden"),t.style.display="none",!1}},window.renderRequestCard=function(n){if(!n)return Logger.warn("REQUESTS","Invalid request data:",n),"";const e=n.wasMatched!==!1,t=n.request?.clientIp||"Unknown",i={id:n.id||"",method:n.request?.method||"GET",url:n.request?.url||n.request?.urlPath||"N/A",status:n.responseDefinition?.status||(e?200:404),time:`${Utils.parseRequestTime(n.request.loggedDate)} <span class="request-ip">IP: ${Utils.escapeHtml(t)}</span>`,extras:{badges:`
                ${e?`<span class="badge badge-success">${Icons.render("check-circle",{className:"badge-icon"})}<span>Matched</span></span>`:`<span class="badge badge-danger">${Icons.render("x-circle",{className:"badge-icon"})}<span>Unmatched</span></span>`}
            `,preview:UIComponents.createPreviewSection(`${Icons.render("request-in",{className:"icon-inline"})} Request`,{Method:n.request?.method,URL:n.request?.url||n.request?.urlPath,"Client IP":t,Headers:n.request?.headers,Body:n.request?.body})+UIComponents.createPreviewSection(`${Icons.render("response-out",{className:"icon-inline"})} Response`,{Status:n.responseDefinition?.status,Matched:e?"Yes":"No",Headers:n.responseDefinition?.headers,Body:n.responseDefinition?.jsonBody||n.responseDefinition?.body})}};return UIComponents.createCard("request",i,[])};function updateRequestsCounter(){const n=document.getElementById(SELECTORS.COUNTERS.REQUESTS);n&&(n.textContent=Array.isArray(window.allRequests)?window.allRequests.length:0),updateRequestTabCounts()}window.updateRequestsCounter=updateRequestsCounter;function updateRequestTabCounts(){const n=window.requestTabTotals||computeRequestTabTotals(window.originalRequests),e={all:document.getElementById("requests-tab-all"),matched:document.getElementById("requests-tab-matched"),unmatched:document.getElementById("requests-tab-unmatched")};Object.entries(e).forEach(([t,i])=>{i&&(i.textContent=n?.[t]??0)})}function setActiveFilterTab(n){if(!n)return;const e=n.dataset.filterGroup;e&&document.querySelectorAll(`.filter-tab[data-filter-group="${e}"]`).forEach(t=>{t.classList.toggle("active",t===n)})}window.syncFilterTabsFromSelect=function(e,t){const i=(t||"").toString().toLowerCase(),r=document.querySelectorAll(`.filter-tab[data-filter-group="${e}"]`);let o=!1;r.forEach(s=>{const c=(s.dataset.filterValue||"").toLowerCase();c===i||!c&&!i?(s.classList.add("active"),o=!0):s.classList.remove("active")}),!o&&r.length>0&&r[0].classList.add("active")},window.handleRequestTabClick=(n,e)=>{setActiveFilterTab(n);const t=document.getElementById("req-filter-status");t&&(t.value=e||"",typeof applyRequestFilters=="function"&&applyRequestFilters())},window.initializeFilterTabs=()=>{const n=document.getElementById("filter-method");n&&(n.addEventListener("change",()=>{syncFilterTabsFromSelect("mapping",n.value)}),syncFilterTabsFromSelect("mapping",n.value));const e=document.getElementById("req-filter-status");e&&(e.addEventListener("change",()=>{syncFilterTabsFromSelect("requests",e.value)}),syncFilterTabsFromSelect("requests",e.value)),updateRequestTabCounts()},window.openEditModal=async n=>{const t=(r=>typeof r=="string"?r.trim():r==null?"":String(r).trim())(n);if(!t){NotificationManager.show("Invalid mapping identifier",NotificationManager.TYPES.ERROR);return}if(typeof UIComponents?.clearCardState=="function"&&UIComponents.clearCardState("mapping","is-editing"),t&&typeof UIComponents?.setCardState=="function"&&UIComponents.setCardState("mapping",t,"is-editing",!0),typeof window.showModal=="function")window.showModal("edit-mapping-modal");else{Logger.warn("REQUESTS","showModal function not found");return}typeof window.setMappingEditorBusyState=="function"&&window.setMappingEditorBusyState(!0,"Loading\u2026");const i=document.getElementById(SELECTORS.MODAL.TITLE);i&&(i.textContent="Edit Mapping"),Logger.debug("REQUESTS","openEditModal called for mapping identifier:",n);try{const r=await apiFetch(`/mappings/${encodeURIComponent(t)}`),o=r?.mapping||r;if(!o||!o.id)throw new Error("Invalid mapping response from server");if(Logger.debug("REQUESTS","Loaded mapping from server:",o),typeof window.populateEditMappingForm=="function")window.populateEditMappingForm(o);else{Logger.error("REQUESTS","populateEditMappingForm function not found!");return}addMappingToIndex(o),Logger.debug("REQUESTS","openEditModal completed successfully")}catch(r){Logger.error("REQUESTS","Failed to load mapping:",r),NotificationManager.show("Failed to load mapping: "+r.message,NotificationManager.TYPES.ERROR),typeof window.hideModal=="function"&&window.hideModal("edit-mapping-modal")}finally{typeof window.setMappingEditorBusyState=="function"&&window.setMappingEditorBusyState(!1)}},window.deleteMapping=async n=>{if(confirm("Delete this mapping?"))try{await apiFetch(`/mappings/${n}`,{method:"DELETE"}),NotificationManager.success("Mapping deleted!"),removeMappingFromIndex(n),updateOptimisticCache({id:n},"delete")}catch(e){e.message.includes("404")?(Logger.info("REQUESTS","Mapping already deleted from server (404), updating cache locally"),removeMappingFromIndex(n),updateOptimisticCache({id:n},"delete"),NotificationManager.success("Mapping was already deleted")):NotificationManager.error(`Delete failed: ${e.message}`)}},window.clearRequests=async()=>{if(confirm("Clear all requests?"))try{await apiFetch("/requests",{method:"DELETE"}),NotificationManager.success("Requests cleared!"),await fetchAndRenderRequests()}catch(n){NotificationManager.error(`Clear failed: ${n.message}`)}},(function(){if(window.ScenarioModel)return;const e=c=>{if(typeof c!="string")return"";const l=c.trim();if(!l)return"";if(!/%[0-9a-fA-F]{2}/.test(l))return l;try{return decodeURIComponent(l)}catch(d){return Logger.warn("SCENARIOS","safeDecode failed, returning original value",{value:c,error:d}),l}},t=c=>{if(typeof c!="string")return"";let l=c.trim();if(!l)return"";if(/^https?:\/\//i.test(l))try{l=new URL(l).pathname}catch(m){Logger.warn("SCENARIOS","normalizeScenarioLink failed to parse absolute URL",{link:c,error:m})}const d="/__admin";return l.startsWith(d)&&(l=l.slice(d.length)||"/"),l=l.replace(/^\/+/,""),l?`/${l}`:""},i=(c,l)=>{if(!c||typeof c!="object")return null;const d=typeof c.id=="string"?c.id:"",m=typeof c.name=="string"?c.name:"",h=e(d),S=e(m),I=h||S||d||m||"",T=S||h||m||d||`Scenario ${l+1}`,v=e(c.state)||c.state||"Started",g=Array.isArray(c.possibleStates)?c.possibleStates.map(D=>e(D)||D).filter(Boolean):[],w=Array.isArray(c.mappings)?c.mappings.map(D=>!D||typeof D!="object"?D:{...D,requiredScenarioState:e(D.requiredScenarioState)||D.requiredScenarioState||"",newScenarioState:e(D.newScenarioState)||D.newScenarioState||""}):[],A=t(c.stateEndpoint||c?._links?.["update-state"]?.href||c?._links?.updateState?.href||c?._links?.state?.href),N=t(c.resetEndpoint||c?._links?.["reset-state"]?.href||c?._links?.resetState?.href||c?._links?.reset?.href);return{...c,id:I||h||d,name:T,displayName:T,identifier:I,originalId:d,originalName:m||S,decodedId:h,decodedName:S,state:v,possibleStates:g,mappings:w,stateEndpoint:A,resetEndpoint:N}},r=c=>Array.isArray(c)?c.map((l,d)=>i(l,d)).filter(Boolean):[],o=c=>typeof c!="string"?"":c.trim().toLowerCase(),s=(c,l)=>l?!c||typeof c!="object"?!1:[c.displayName,c.name,c.identifier,c.id,c.state,c.description].filter(h=>typeof h=="string"&&h.trim()).map(h=>h.toLowerCase()).some(h=>h.includes(l))?!0:(Array.isArray(c.mappings)?c.mappings:[]).some(h=>!h||typeof h!="object"?!1:[h.name,h.id,h.uuid,h.stubId,h.stubMappingId,h.requiredScenarioState,h.newScenarioState,h.request?.method,h.request?.url,h.request?.urlPattern,h.request?.urlPath,h.request?.urlPathPattern].filter(I=>typeof I=="string"&&I.trim()).map(I=>I.toLowerCase()).some(I=>I.includes(l))):!0;window.ScenarioModel={safeDecode:e,normalizeScenarioLink:t,normalizeScenario:i,normalizeScenarioList:r,normalizeSearchTerm:o,scenarioMatchesSearch:s}})(),Array.isArray(window.allScenarios)||(window.allScenarios=[]);let allScenarios=window.allScenarios,scenarioListHandlerAttached=!1;(!window.scenarioExpansionState||typeof window.scenarioExpansionState!="object")&&(window.scenarioExpansionState={});let scenarioExpansionState=window.scenarioExpansionState;(!window.scenarioUiState||typeof window.scenarioUiState!="object")&&(window.scenarioUiState={});const scenarioUiState=window.scenarioUiState;typeof scenarioUiState.searchTerm!="string"&&(scenarioUiState.searchTerm=""),scenarioUiState.selected instanceof Set||(scenarioUiState.selected=new Set),typeof scenarioUiState.bulkMenuOpen!="boolean"&&(scenarioUiState.bulkMenuOpen=!1),Array.isArray(scenarioUiState.lastVisibleSelectable)||(scenarioUiState.lastVisibleSelectable=[]);let scenarioToolbarHandlersAttached=!1;function renderIcon(n,e={}){return typeof window.Icons?.render=="function"?window.Icons.render(n,e):""}function downloadFile(n,e,t){const i=new Blob([e],{type:t}),r=URL.createObjectURL(i),o=document.createElement("a");o.href=r,o.download=n,document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(r),0)}function safeDecode(n){return window.ScenarioModel&&typeof window.ScenarioModel.safeDecode=="function"?window.ScenarioModel.safeDecode(n):typeof n=="string"?n.trim():""}function normalizeScenarioLink(n){return window.ScenarioModel&&typeof window.ScenarioModel.normalizeScenarioLink=="function"?window.ScenarioModel.normalizeScenarioLink(n):""}function normalizeScenario(n,e){return window.ScenarioModel&&typeof window.ScenarioModel.normalizeScenario=="function"?window.ScenarioModel.normalizeScenario(n,e):n||null}function normalizeScenarioList(n){return window.ScenarioModel&&typeof window.ScenarioModel.normalizeScenarioList=="function"?window.ScenarioModel.normalizeScenarioList(n):Array.isArray(n)?n.filter(Boolean):[]}function getScenarioByIdentifier(n){if(typeof n!="string")return null;const e=n.trim();return e&&(Array.isArray(allScenarios)?allScenarios:[]).find(i=>[i?.identifier,i?.id,i?.name,i?.decodedId,i?.decodedName,i?.originalId,i?.originalName].some(o=>typeof o!="string"?!1:o.trim()===e))||null}function resolveScenarioTarget(n){const e=typeof n=="string"?n.trim():"",t=e?getScenarioByIdentifier(e):null,i=t?.identifier||t?.decodedId||t?.decodedName||e,r=safeDecode(i)||i,o=t?.displayName||t?.decodedName||t?.name||t?.decodedId||t?.id||safeDecode(e)||e,s=typeof t?.stateEndpoint=="string"?t.stateEndpoint:"",c=typeof t?.resetEndpoint=="string"?t.resetEndpoint:"",l=typeof window.buildScenarioStateEndpoint=="function"?window.buildScenarioStateEndpoint:S=>`${ENDPOINTS.SCENARIOS}/${encodeURIComponent(S)}/state`,d=s||(r?l(r):"");return{rawCandidate:e,targetScenario:t,endpointIdentifier:r,displayName:o,stateEndpoint:d,resetEndpoint:c||d,resetMethod:c?"POST":"PUT"}}function setScenariosLoading(n){const e=document.getElementById("scenarios-loading");if(e&&e.classList.toggle("hidden",!n),n){const t=document.getElementById(SELECTORS.LISTS.SCENARIOS);t&&(t.style.display="none")}}window.loadScenarios=async()=>{const n=document.getElementById("scenarios-empty");n&&n.classList.add("hidden"),setScenariosLoading(!0);try{const e=await apiFetch(ENDPOINTS.SCENARIOS),t=Array.isArray(e?.scenarios)?e.scenarios:[];allScenarios=normalizeScenarioList(t),window.allScenarios=allScenarios}catch(e){allScenarios=[],window.allScenarios=allScenarios,Logger.error("SCENARIOS","Load scenarios error:",e),NotificationManager.error(`Failed to load scenarios: ${e.message}`)}finally{setScenariosLoading(!1),renderScenarios()}},window.refreshScenarios=async()=>{await TabManager.refresh("scenarios")},window.resetAllScenarios=async()=>{if(confirm("Reset all scenarios to the initial state?")){setScenariosLoading(!0);try{await apiFetch(ENDPOINTS.SCENARIOS_RESET,{method:"POST"}),NotificationManager.success("All scenarios have been reset!"),await loadScenarios()}catch(n){NotificationManager.error(`Scenario reset failed: ${n.message}`),setScenariosLoading(!1)}}};function updateScenarioStateSuggestions(n){const e=document.getElementById("scenario-state-options"),t=document.getElementById("scenario-state");if(!e)return;const i=Array.isArray(allScenarios)?allScenarios:[],r=getScenarioByIdentifier(n),o=new Set,s=d=>{if(typeof d!="string")return;const m=d.trim();m&&o.add(m)};s("Started");const c=d=>{d&&(s(d.state),(d.possibleStates||[]).forEach(s),(d.mappings||[]).forEach(m=>{s(m?.requiredScenarioState),s(m?.newScenarioState)}))};r&&c(r),o.size===0&&i.forEach(c);const l=Array.from(o).sort((d,m)=>d.localeCompare(m));e.innerHTML=l.map(d=>`
        <option value="${escapeHtml(d)}"></option>
    `).join(""),t&&(l.length>0?t.setAttribute("placeholder",`Enter state (e.g. ${l[0]})`):t.setAttribute("placeholder","Enter state name"))}window.setScenarioState=async(n,e,t={})=>{const i=document.getElementById("scenario-select"),r=document.getElementById("scenario-state"),o=typeof n=="string"?n:"",s=typeof e=="string"?e.trim():"",c=t&&typeof t=="object"?t:{},l=c.refresh!==!1,d=c.silent===!0,m=c.manageLoading!==!1,h=c.syncForm!==!1;let S=o;!S&&i&&(S=i.value||"");const I=resolveScenarioTarget(S),T=I.endpointIdentifier,v=I.displayName,g=s||r?.value?.trim()||"";if(!T||!T.trim()||!g)return d||NotificationManager.warning("Please select scenario and enter state"),!1;const w=I.stateEndpoint;if(!w)return d||NotificationManager.error("Unable to determine the scenario state endpoint."),!1;if(I.targetScenario&&Array.isArray(I.targetScenario.possibleStates)&&I.targetScenario.possibleStates.length===0)return d||NotificationManager.warning(`Scenario "${v}" does not expose any states to switch to.`),!1;if(h)if(i){const N=I.targetScenario?.identifier||I.targetScenario?.decodedId||I.targetScenario?.decodedName||T;i.value=N,updateScenarioStateSuggestions(N)}else updateScenarioStateSuggestions(T);m&&setScenariosLoading(!0);const A=!!I.targetScenario;try{return await apiFetch(w,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:g})}),d||NotificationManager.success(`Scenario "${v}" switched to state "${g}"`),h&&!s&&r&&(r.value=""),h&&updateScenarioStateSuggestions(T),l?await loadScenarios():m&&setScenariosLoading(!1),!0}catch(N){Logger.error("SCENARIOS","Change scenario state error:",N);const D=/HTTP\s+404/.test(N?.message||""),V=/does not support state/i.test(N?.message||"");return d||(D&&!A?NotificationManager.error(`Scenario "${v}" was not found on the server.`):V?NotificationManager.error(`Scenario "${v}" does not allow state changes.`):NotificationManager.error(`Scenario state change failed: ${N.message}`)),m&&setScenariosLoading(!1),!1}};async function resetScenarioState(n,e={}){const t=e&&typeof e=="object"?e:{},i=t.refresh!==!1,r=t.silent===!0,o=t.manageLoading!==!1;if(typeof n!="string"||!n.trim())return r||NotificationManager.warning("Unable to determine which scenario to reset."),!1;const s=resolveScenarioTarget(n),c=s.resetEndpoint,l=s.resetMethod,d=s.displayName;if(!c)return r||NotificationManager.error("Unable to determine the scenario reset endpoint."),!1;o&&setScenariosLoading(!0);try{return await apiFetch(c,{method:l}),r||NotificationManager.success(`Scenario "${d}" has been reset to its initial state.`),i?await loadScenarios():o&&setScenariosLoading(!1),!0}catch(m){if(l==="PUT"&&s.stateEndpoint)try{return await apiFetch(s.stateEndpoint,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:"Started"})}),r||NotificationManager.success(`Scenario "${d}" has been reset to its initial state.`),i?await loadScenarios():o&&setScenariosLoading(!1),!0}catch(h){return Logger.error("SCENARIOS","Reset scenario state error:",h),r||NotificationManager.error(`Scenario reset failed: ${h.message}`),o&&setScenariosLoading(!1),!1}return Logger.error("SCENARIOS","Reset scenario state error:",m),r||NotificationManager.error(`Scenario reset failed: ${m.message}`),o&&setScenariosLoading(!1),!1}}function normalizeSearchTerm(n){return window.ScenarioModel&&typeof window.ScenarioModel.normalizeSearchTerm=="function"?window.ScenarioModel.normalizeSearchTerm(n):""}function scenarioMatchesSearch(n,e){return window.ScenarioModel&&typeof window.ScenarioModel.scenarioMatchesSearch=="function"?window.ScenarioModel.scenarioMatchesSearch(n,e):!0}function setScenarioBulkMenuOpen(n){scenarioUiState.bulkMenuOpen=!!n;const e=document.getElementById("scenario-bulk-menu");e&&(e.classList.toggle("is-open",scenarioUiState.bulkMenuOpen),e.setAttribute("aria-hidden",scenarioUiState.bulkMenuOpen?"false":"true"))}function updateScenarioHeaderUI(n,e){const t=document.getElementById("scenario-stats");if(t){const d=Array.isArray(n)?n.reduce((h,S)=>h+(Array.isArray(S?.mappings)?S.mappings.length:0),0):0,m=Array.isArray(n)?n.length:0;t.textContent=`${m}/${e} scenarios \u2022 ${d} mappings`}const i=document.getElementById("scenario-select-all-row"),r=document.getElementById("scenario-select-all-btn"),o=Array.isArray(n)?n.map(d=>{const m=typeof d?.identifier=="string"?d.identifier:typeof d?.decodedId=="string"?d.decodedId:typeof d?.id=="string"?d.id:"";return(typeof m=="string"?m.trim():"")||""}).filter(Boolean):[];scenarioUiState.lastVisibleSelectable=o;const s=scenarioUiState.selected instanceof Set?scenarioUiState.selected.size:0,c=document.getElementById("scenario-bulk-wrap"),l=document.getElementById("scenario-bulk-count");if(l&&(l.textContent=String(s)),c&&c.classList.toggle("is-hidden",s===0),i&&(i.style.display=o.length>0?"":"none"),r){const d=o.length>0&&o.every(m=>scenarioUiState.selected.has(m));r.classList.toggle("is-selected",d),r.setAttribute("aria-checked",d?"true":"false")}s===0&&scenarioUiState.bulkMenuOpen&&setScenarioBulkMenuOpen(!1)}async function bulkResetSelectedScenarios(){const n=scenarioUiState.selected instanceof Set?Array.from(scenarioUiState.selected):[];if(n.length===0||!confirm(`Reset ${n.length} selected scenarios to their initial state?`))return;setScenarioBulkMenuOpen(!1),setScenariosLoading(!0);const e=[];for(const t of n)try{const i=resolveScenarioTarget(t);if(!i.resetEndpoint){e.push({id:t,name:i.displayName||t,error:"No reset endpoint resolved"});continue}try{await apiFetch(i.resetEndpoint,{method:i.resetMethod})}catch(r){if(i.resetMethod==="PUT"&&i.stateEndpoint)await apiFetch(i.stateEndpoint,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:"Started"})});else throw r}}catch(i){e.push({id:t,name:t,error:i?.message||String(i)})}if(e.length>0){scenarioUiState.selected=new Set(e.map(i=>i.id).filter(Boolean));const t=e.slice(0,3).map(i=>i.name||i.id).join(", ");NotificationManager.warning(`Bulk reset: ${e.length} failed${t?` (e.g. ${t})`:""}.`)}else scenarioUiState.selected.clear(),NotificationManager.success("Bulk reset complete.");await loadScenarios()}async function bulkSetScenarioState(){const n=scenarioUiState.selected instanceof Set?Array.from(scenarioUiState.selected):[];if(n.length===0)return;const e=n.length===1&&getScenarioByIdentifier(n[0])?.state||"Started",t=prompt(`Set state for ${n.length} selected scenarios:`,e);if(!t||!t.trim())return;setScenarioBulkMenuOpen(!1),setScenariosLoading(!0);const i=[],r=t.trim();for(const o of n)try{const s=resolveScenarioTarget(o);if(!s.stateEndpoint){i.push({id:o,name:s.displayName||o,error:"No state endpoint resolved"});continue}await apiFetch(s.stateEndpoint,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:r})})}catch(s){i.push({id:o,name:o,error:s?.message||String(s)})}if(i.length>0){scenarioUiState.selected=new Set(i.map(s=>s.id).filter(Boolean));const o=i.slice(0,3).map(s=>s.name||s.id).join(", ");NotificationManager.warning(`Bulk state update: ${i.length} failed${o?` (e.g. ${o})`:""}.`)}else scenarioUiState.selected.clear(),NotificationManager.success(`Bulk state updated: "${r}"`);await loadScenarios()}async function fetchFullMappingById(n){const e=(n??"").toString().trim();if(!e)return null;if(typeof window.getMappingById=="function")try{const o=await window.getMappingById(e);if(o&&typeof o=="object")return o}catch(o){Logger.warn("SCENARIOS","getMappingById failed, falling back to direct fetch",{mappingId:e,error:o})}const t=`/mappings/${encodeURIComponent(e)}`,i=await apiFetch(t),r=i&&typeof i=="object"&&i.mapping?i.mapping:i;return r&&typeof r=="object"?r:null}async function bulkExportSelectedMappings(){const n=scenarioUiState.selected instanceof Set?Array.from(scenarioUiState.selected):[];if(n.length===0)return;setScenarioBulkMenuOpen(!1);const e=[],t=new Set;if(n.forEach(c=>{const l=getScenarioByIdentifier(c);(Array.isArray(l?.mappings)?l.mappings:[]).forEach(m=>{const h=(m?.id||m?.uuid||m?.stubMappingId||m?.stubId||m?.mappingId||"").toString().trim();!h||t.has(h)||(t.add(h),e.push(h))})}),e.length===0){NotificationManager.warning("No mappings found for selected scenarios.");return}setScenariosLoading(!0);const i=[],r=[];for(const c of e)try{const l=await fetchFullMappingById(c);if(!l){r.push({id:c,error:"Empty mapping payload"});continue}i.push(l)}catch(l){r.push({id:c,error:l?.message||String(l)})}const s=`wiremock-mappings-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;if(downloadFile(s,`${JSON.stringify({mappings:i},null,2)}
`,"application/json"),r.length>0){const c=r.slice(0,3).map(l=>l.id).join(", ");NotificationManager.warning(`Exported ${i.length}/${e.length} mapping(s). Failed: ${r.length}${c?` (e.g. ${c})`:""}.`)}else NotificationManager.success(`Exported ${i.length} mapping(s).`);setScenariosLoading(!1)}function clearScenarioSelection(){scenarioUiState.selected instanceof Set&&scenarioUiState.selected.clear(),setScenarioBulkMenuOpen(!1),renderScenarios()}function toggleSelectAllVisibleScenarios(){const n=Array.isArray(scenarioUiState.lastVisibleSelectable)?scenarioUiState.lastVisibleSelectable:[];scenarioUiState.selected instanceof Set||(scenarioUiState.selected=new Set),n.length>0&&n.every(t=>scenarioUiState.selected.has(t))?n.forEach(t=>scenarioUiState.selected.delete(t)):n.forEach(t=>scenarioUiState.selected.add(t)),renderScenarios()}window.renderScenarios=()=>{const n=document.getElementById(SELECTORS.LISTS.SCENARIOS),e=document.getElementById("scenarios-empty"),t=document.getElementById("scenarios-count"),i=document.getElementById("scenario-select"),r=document.getElementById("scenario-state-options"),o=document.getElementById("scenario-search"),s=document.getElementById("scenario-bulk-btn"),c=document.getElementById("scenario-bulk-reset"),l=document.getElementById("scenario-bulk-set-state"),d=document.getElementById("scenario-bulk-export"),m=document.getElementById("scenario-bulk-clear"),h=document.getElementById("scenario-select-all-btn");if(!n)return;t&&(t.textContent=Array.isArray(allScenarios)?allScenarios.length:0);const S=Array.isArray(allScenarios)?allScenarios:[];if(S.length===0){n.innerHTML="",n.style.display="none",e&&e.classList.remove("hidden"),i&&(i.innerHTML='<option value="">Select Scenario</option>'),r&&(r.innerHTML=""),updateScenarioStateSuggestions(""),updateScenarioHeaderUI([],0);return}if(e&&e.classList.add("hidden"),scenarioUiState.selected instanceof Set&&scenarioUiState.selected.size>0){const g=new Set(S.map(w=>{const A=typeof w?.identifier=="string"?w.identifier:typeof w?.decodedId=="string"?w.decodedId:typeof w?.id=="string"?w.id:"";return typeof A=="string"?A.trim():""}).filter(Boolean));for(const w of Array.from(scenarioUiState.selected))g.has(w)||scenarioUiState.selected.delete(w)}o&&(o.value||"")!==scenarioUiState.searchTerm&&(o.value=scenarioUiState.searchTerm),scenarioToolbarHandlersAttached||(o&&o.addEventListener("input",g=>{scenarioUiState.searchTerm=typeof g.target?.value=="string"?g.target.value:"",renderScenarios()}),s&&s.addEventListener("click",g=>{g.stopPropagation(),setScenarioBulkMenuOpen(!scenarioUiState.bulkMenuOpen)}),c&&c.addEventListener("click",()=>{bulkResetSelectedScenarios()}),l&&l.addEventListener("click",()=>{bulkSetScenarioState()}),d&&d.addEventListener("click",()=>{bulkExportSelectedMappings()}),m&&m.addEventListener("click",clearScenarioSelection),h&&h.addEventListener("click",toggleSelectAllVisibleScenarios),document.addEventListener("click",g=>{const w=document.getElementById("scenario-bulk-wrap");w&&scenarioUiState.bulkMenuOpen&&(typeof w.contains=="function"&&w.contains(g.target)||setScenarioBulkMenuOpen(!1))}),document.addEventListener("keydown",g=>{scenarioUiState.bulkMenuOpen&&g.key==="Escape"&&setScenarioBulkMenuOpen(!1)}),scenarioToolbarHandlersAttached=!0);const I=i?.value||"";if(i){const g=['<option value="">Select Scenario</option>'].concat(S.map(w=>{const A=typeof w?.identifier=="string"?w.identifier:typeof w?.decodedId=="string"?w.decodedId:typeof w?.id=="string"?w.id:"",N=typeof w?.displayName=="string"?w.displayName:typeof w?.name=="string"?w.name:typeof w?.decodedName=="string"?w.decodedName:"Unnamed scenario";return`
                <option value="${escapeHtml(A)}">${escapeHtml(N)}</option>
            `}));if(i.innerHTML=g.join(""),I){const w=getScenarioByIdentifier(I);w&&(i.value=w.identifier||w.decodedId||w.decodedName||w.id||w.name||"")}}r&&updateScenarioStateSuggestions(i?.value||I||""),i&&!i.dataset.scenarioHandlerAttached&&(i.addEventListener("change",g=>{updateScenarioStateSuggestions(g.target.value)}),i.dataset.scenarioHandlerAttached="1"),n.style.display="";const T=normalizeSearchTerm(scenarioUiState.searchTerm),v=S.filter(g=>scenarioMatchesSearch(g,T));if(v.length===0){if(n.innerHTML="",n.style.display="none",e){e.classList.remove("hidden");const g=typeof e.querySelector=="function"?e.querySelector("h3"):null,w=typeof e.querySelector=="function"?e.querySelector("p"):null;g&&(g.textContent="No scenarios match your filter"),w&&(w.textContent="Try clearing the filter or searching by mapping URL/state.")}updateScenarioHeaderUI([],S.length);return}if(e){const g=typeof e.querySelector=="function"?e.querySelector("h3"):null,w=typeof e.querySelector=="function"?e.querySelector("p"):null;g&&(g.textContent="No scenarios found"),w&&(w.textContent="Create mappings with scenarios to manage state here."),e.classList.add("hidden")}updateScenarioHeaderUI(v,S.length),n.innerHTML=v.map((g,w)=>{const A=typeof g?.identifier=="string"?g.identifier:typeof g?.decodedId=="string"?g.decodedId:typeof g?.id=="string"?g.id:"",N=escapeHtml(A),D=typeof g?.displayName=="string"?g.displayName:typeof g?.name=="string"?g.name:typeof g?.decodedName=="string"?g.decodedName:"Unnamed scenario",V=escapeHtml(D),H=escapeHtml(g.state||"Started"),de=Array.isArray(g.possibleStates)?g.possibleStates.filter(Boolean):[],be=A||g?.decodedId||g?.decodedName||g?.id||g?.name||`scenario-${w}`,x=typeof be=="string"&&be.trim()?be.trim():`scenario-${w}`,j=scenarioExpansionState[x]===!0,F=escapeHtml(x),U=typeof A=="string"&&A.trim().length>0,re=U?A.trim():"",J=re&&scenarioUiState.selected instanceof Set?scenarioUiState.selected.has(re):!1,se=U?`
            <button
                type="button"
                class="scenario-select-btn${J?" is-selected":""}"
                data-scenario-action="select"
                data-scenario="${N}"
                role="checkbox"
                aria-checked="${J?"true":"false"}"
                aria-label="Select scenario ${V}"
                title="Select"
            >
                <span class="scenario-select-box" aria-hidden="true"></span>
            </button>
        `:`
            <span style="width:18px;height:18px;display:inline-block;"></span>
        `,ye=new Set,we=[],_e=oe=>{if(typeof oe!="string")return;const Ce=oe.trim();!Ce||ye.has(Ce)||(ye.add(Ce),we.push(Ce))};_e(g.state||""),de.forEach(_e);const je=we.map(oe=>{const Ce=escapeHtml(oe),Pe=oe===g.state,He="scenario-state-pill";return Pe?`<span class="${He} is-active" data-current="true">${Ce}</span>`:U?`
                <button
                    type="button"
                    class="${He}"
                    data-scenario-action="transition"
                    data-scenario="${N}"
                    data-state="${Ce}"
                >
                    ${Ce}
                </button>
            `:`<span class="${He}">${Ce}</span>`}).join(""),ct=U?`
            <button
                type="button"
                class="scenario-reset-btn"
                data-scenario-action="reset"
                data-scenario="${N}"
            >
                ${renderIcon("refresh",{className:"icon-inline"})} Reset
            </button>
        `:"",Ke=je||ct?`
            <div class="scenario-summary-controls">
                <div class="scenario-state-pill-list">${je}</div>
                ${ct}
            </div>
        `:"",Ot=g.description?`
            <div class="scenario-info">
                <div class="scenario-description">${escapeHtml(g.description)}</div>
            </div>
        `:"",lt=Array.isArray(g.mappings)?g.mappings:[],vt=lt.length?`
            <ul class="scenario-mapping-list">
                ${lt.map(oe=>{const Ce=oe?.id||oe?.uuid||oe?.stubMappingId||oe?.stubId||oe?.mappingId||"",Pe=Ce?escapeHtml(Ce):"",He=escapeHtml(oe?.name||Ce||"Unnamed mapping"),Ve=oe?.request?.method||oe?.method||oe?.requestMethod||"",ut=oe?.request?.urlPattern||oe?.request?.urlPath||oe?.request?.url||oe?.url||oe?.requestUrl||"",Qe=Ve?`<span class="scenario-mapping-method">${escapeHtml(Ve)}</span>`:"",ve=ut?`<span class="scenario-mapping-url">${escapeHtml(ut)}</span>`:"",Fe=Qe||ve?`
                        <div class="scenario-mapping-meta">
                            ${[Qe,ve].filter(Boolean).join(" \xB7 ")}
                        </div>
                    `:"",Ie=oe?.requiredScenarioState||oe?.requiredState||"",qe=oe?.newScenarioState||oe?.newState||"",Xe=[Ie?`<span class="badge badge-warning" title="Required scenario state">Requires: ${escapeHtml(Ie)}</span>`:"",qe?`<span class="badge badge-info" title="Next scenario state">\u2192 ${escapeHtml(qe)}</span>`:""].filter(Boolean).join(" "),Ze=Xe?`
                        <div class="scenario-mapping-states">${Xe}</div>
                    `:"",pt=renderIcon("pencil",{className:"action-icon"}),wt=renderIcon("clipboard",{className:"action-icon"}),St=renderIcon("trash",{className:"action-icon"}),Ue=Ce?`
                        <div class="scenario-mapping-actions">
                            <button
                                class="btn btn-sm btn-secondary"
                                data-scenario-action="edit-mapping"
                                data-mapping-id="${Pe}"
                                title="Edit mapping"
                            >
                                ${pt||""}<span>Edit</span>
                            </button>
                            <button
                                class="btn btn-sm btn-secondary"
                                data-scenario-action="duplicate-mapping"
                                data-mapping-id="${Pe}"
                                title="Duplicate mapping"
                            >
                                ${wt||""}<span>Duplicate</span>
                            </button>
                            <button
                                class="btn btn-sm btn-danger"
                                data-scenario-action="delete-mapping"
                                data-mapping-id="${Pe}"
                                title="Delete mapping"
                            >
                                ${St||""}<span>Delete</span>
                            </button>
                        </div>
                    `:"";return`
                        <li class="scenario-mapping-item">
                            <div class="scenario-mapping-name">${He}</div>
                            ${Fe}
                            ${Ze}
                            ${Ue}
                        </li>
                    `}).join("")}
            </ul>
        `:`
            <div class="scenario-mapping-empty">No stub mappings are bound to this scenario yet.</div>
        `,yt=`<span class="collapse-arrow" aria-hidden="true">${j?"\u25BC":"\u25B6"}</span>`,dt=`${j?"Collapse":"Expand"} scenario ${D}`;return`
            <div class="scenario-item ${j?"expanded":"collapsed"}${J?" is-selected":""}" data-scenario="${N}" data-scenario-key="${F}">
                <div class="scenario-summary">
                    ${se}
                    <button
                        type="button"
                        class="scenario-toggle-btn"
                        data-scenario-action="toggle"
                        data-scenario-key="${F}"
                        aria-expanded="${j?"true":"false"}"
                        aria-label="${escapeHtml(dt)}"
                    >
                        ${yt}
                    </button>
                    <div class="scenario-summary-main">
                        <div class="scenario-summary-header">
                            <div class="scenario-name">${V}</div>
                            <div class="scenario-state">State: ${H}</div>
                        </div>
                        ${Ke}
                    </div>
                </div>
                <div class="scenario-body">
                    ${Ot}
                    <div class="scenario-mappings">
                        <div class="scenario-section-title">Stub mappings</div>
                        ${vt}
                    </div>
                </div>
            </div>
        `}).join(""),scenarioListHandlerAttached||(n.addEventListener("click",async g=>{const w=g.target.closest("[data-scenario-action]");if(!w||typeof n.contains=="function"&&!n.contains(w))return;const A=w.dataset.scenarioAction;if(A==="toggle"){g.preventDefault();const N=w.dataset.scenarioKey||w.dataset.scenario||"";if(!N.trim())return;const D=scenarioExpansionState[N]===!0;scenarioExpansionState[N]=!D,renderScenarios()}else if(A==="select"){g.preventDefault();const N=w.dataset.scenario||"",D=typeof N=="string"?N.trim():"";if(!D)return;scenarioUiState.selected instanceof Set||(scenarioUiState.selected=new Set),scenarioUiState.selected.has(D)?scenarioUiState.selected.delete(D):scenarioUiState.selected.add(D),renderScenarios()}else if(A==="transition"){const N=w.dataset.scenario||"",D=w.dataset.state||"";if(!N.trim()||!D.trim())return;w.disabled=!0;try{await setScenarioState(N,D)}finally{w.disabled=!1}}else if(A==="reset"){const N=w.dataset.scenario||"";if(!N.trim())return;w.disabled=!0;try{await resetScenarioState(N)}finally{w.disabled=!1}}else if(A==="edit-mapping"){const N=w.dataset.mappingId;N&&typeof window.openEditModal=="function"&&window.openEditModal(N)}else if(A==="duplicate-mapping"){const N=w.dataset.mappingId;if(N&&typeof window.duplicateMapping=="function"){w.disabled=!0;try{await window.duplicateMapping(N),await loadScenarios()}finally{w.disabled=!1}}}else if(A==="delete-mapping"){const N=w.dataset.mappingId;if(N&&typeof window.deleteMapping=="function"){w.disabled=!0;try{await window.deleteMapping(N),await loadScenarios()}finally{w.disabled=!1}}}}),scenarioListHandlerAttached=!0)},window.startRecording=async(n={})=>{try{const t={...{targetBaseUrl:"https://example.com",filters:{urlPathPatterns:[".*"],method:"ANY",headers:{}},captureHeaders:{},requestBodyPattern:{},persist:!0,repeatsAsScenarios:!1,transformers:["response-template"],transformerParameters:{}},...n};await apiFetch(ENDPOINTS.RECORDINGS_START,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),NotificationManager.success("Recording started!"),window.isRecording=!0;const i=document.getElementById(SELECTORS.RECORDING.INDICATOR);i&&(i.style.display="block")}catch(e){Logger.error("RECORDING","Start recording error:",e),NotificationManager.error(`Failed to start recording: ${e.message}`)}},window.stopRecording=async()=>{try{const n=await apiFetch(ENDPOINTS.RECORDINGS_STOP,{method:"POST"});window.isRecording=!1,window.recordedCount=0;const e=document.getElementById(SELECTORS.RECORDING.INDICATOR);e&&(e.style.display="none");const t=n.mappings?n.mappings.length:0;NotificationManager.success(`Recording stopped! Captured ${t} mappings`);const i=window.MappingsStore.getAll();return await fetchAndRenderMappings(i),n.mappings||[]}catch(n){return Logger.error("RECORDING","Stop recording error:",n),NotificationManager.error(`Failed to stop recording: ${n.message}`),[]}},window.getRecordingStatus=async()=>{try{return(await apiFetch(ENDPOINTS.RECORDINGS_STATUS)).status||"Unknown"}catch(n){return Logger.error("RECORDING","Recording status error:",n),"Unknown"}},window.takeRecordingSnapshot=async(n={})=>{try{const e=await apiFetch(ENDPOINTS.RECORDINGS_SNAPSHOT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),t=e.mappings?e.mappings.length:0;return NotificationManager.success(`Snapshot created! Captured ${t} mappings`),e.mappings||[]}catch(e){return Logger.error("RECORDING","Recording snapshot error:",e),NotificationManager.error(`Snapshot failed: ${e.message}`),[]}},window.clearRecordings=async()=>{if(confirm("Clear all recorded requests?"))try{await apiFetch(ENDPOINTS.REQUESTS,{method:"DELETE"}),window.recordedCount=0;const n=document.getElementById("recordings-list");n&&(n.innerHTML=""),typeof fetchAndRenderRequests=="function"&&await fetchAndRenderRequests(),NotificationManager.success("Recording log cleared.")}catch(n){Logger.error("RECORDING","Clear recordings error:",n),NotificationManager.error(`Failed to clear recordings: ${n.message}`)}},window.refreshRequests=async()=>{await fetchAndRenderRequests(),(document.getElementById(SELECTORS.REQUEST_FILTERS.METHOD)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.URL)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.STATUS)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO)?.value)&&FilterManager.applyRequestFilters()},window.applyQuickTimeFilter=()=>{const n=new Date,e=new Date(n.getTime()-1440*60*1e3),t=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM),i=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO);t&&(t.value=Utils.formatDateTime(e)),i&&(i.value=Utils.formatDateTime(n)),FilterManager.applyRequestFilters()},window.cleanupPendingDeletions=()=>{for(const[n,e]of window.deletionTimeouts)clearTimeout(e);window.deletionTimeouts.clear(),window.pendingDeletedIds.clear()},window.addEventListener("beforeunload",window.cleanupPendingDeletions),window.toggleElementById=n=>document.getElementById(n)?.classList.toggle("hidden"),window.togglePreview=n=>window.toggleElementById(`preview-${n}`),window.toggleRequestPreview=n=>window.toggleElementById(`request-preview-${n}`),window.getRequestCount=async(n={})=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_COUNT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).count||0}catch(e){return Logger.error("REQUESTS","Request count error:",e),NotificationManager.error(`Request count failed: ${e.message}`),0}},window.findRequests=async n=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_FIND,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).requests||[]}catch(e){return Logger.error("REQUESTS","Find requests error:",e),NotificationManager.error(`Request search failed: ${e.message}`),[]}},window.getUnmatchedRequests=async()=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_UNMATCHED)).requests||[]}catch(n){return Logger.error("REQUESTS","Unmatched requests error:",n),[]}},window.findMappingsByMetadata=async n=>{try{return(await apiFetch(ENDPOINTS.MAPPINGS_FIND_BY_METADATA,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).mappings||[]}catch(e){return Logger.error("METADATA","Find mappings by metadata error:",e),[]}},Logger.info("UI","Features.js loaded - Business functions for mappings, requests, scenarios + WireMock 3.9.1+ API fixes"),window.updateLastSuccessUI=()=>{try{const n=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT);if(!n)return;const e=window.lastWiremockSuccess||Date.now(),t=new Date(e).toLocaleTimeString();n.textContent=`Last OK: ${t}`,Logger.info("HEALTH","last success UI updated:",{ts:e,time:t})}catch{}},window.applyHealthUI=(n,e)=>{try{window.healthState=window.healthState||{isHealthy:null,lastCheckAt:null,lastOkAt:null,lastLatencyMs:null},window.healthState.lastCheckAt=Date.now(),n===!0?(window.healthState.isHealthy=!0,window.healthState.lastOkAt=Date.now(),window.healthState.lastLatencyMs=typeof e=="number"?e:null):n===!1&&(window.healthState.isHealthy=!1,window.healthState.lastLatencyMs=null);const t=document.getElementById(SELECTORS.HEALTH.INDICATOR);if(t)if(t.style.display="inline",n===!0){const i=typeof e=="number"?`${e}ms`:"OK";t.innerHTML=`<span>Response Time: </span><span class="healthy">${i}</span>`}else n===!1?t.innerHTML='<span>Response Time: </span><span class="unhealthy">Unhealthy</span>':t.innerHTML='<span>Response Time: </span><span class="error">Error</span>';n===!0&&(window.lastWiremockSuccess=Date.now(),typeof window.updateLastSuccessUI=="function"&&window.updateLastSuccessUI())}catch(t){Logger.warn("HEALTH","applyHealthUI failed:",t)}};try{const n=localStorage.getItem("imock-show-meta-timestamps");n!==null&&(window.showMetaTimestamps=n==="1")}catch{}window.toggleMetaTimestamps=()=>{try{window.showMetaTimestamps=window.showMetaTimestamps===!1,localStorage.setItem("imock-show-meta-timestamps",window.showMetaTimestamps?"1":"0");const n=window.MappingsStore.getAll();Array.isArray(n)&&fetchAndRenderMappings(n)}catch(n){Logger.warn("METADATA","toggleMetaTimestamps failed:",n)}};const IMOCK_CACHE_ID="00000000-0000-0000-0000-00000000cace",IMOCK_CACHE_URL="/__imock/cache";function isImockCacheMapping(n){try{const e=(n?.id||n?.uuid)===IMOCK_CACHE_ID,t=n?.metadata?.imock?.type==="cache",i=(n?.name||"").toLowerCase()==="imock cache",r=(n?.request?.url||n?.request?.urlPath)===IMOCK_CACHE_URL;return!!(e||t||i||r)}catch{return!1}}function slimMapping(n){return{id:n.id||n.uuid,name:n.name||n.metadata?.name,priority:n.priority,persistent:n.persistent,scenarioName:n.scenarioName,requiredScenarioState:n.requiredScenarioState,newScenarioState:n.newScenarioState,request:{method:n.request?.method,url:n.request?.urlPath||n.request?.urlPathPattern||n.request?.urlPattern||n.request?.url||"N/A"},response:{status:n.response?.status},metadata:{created:n.metadata?.created,edited:n.metadata?.edited,source:n.metadata?.source}}}function buildSlimList(n){return{mappings:(n||[]).filter(t=>!isImockCacheMapping(t)).map(slimMapping)}}async function getCacheByFixedId(){try{Logger.cache("Trying fixed ID lookup...");const n=await apiFetch(`/mappings/${IMOCK_CACHE_ID}`);if(n&&isImockCacheMapping(n))return n;Logger.cache("Fixed ID miss")}catch(n){n.status===401||n.message&&n.message.includes("401")?Logger.warn("CACHE","Authorization error loading cache by fixed ID - check credentials"):n.status===404||n.message&&n.message.includes("404")?Logger.debug("CACHE","Cache mapping not found by fixed ID (404)"):Logger.debug("CACHE","Error loading cache by fixed ID:",n.message)}return null}async function upsertImockCacheMapping(n){Logger.cache("Upsert cache mapping start");const e=JSON.stringify(n||{});let t=0;for(let s=0;s<e.length;s++)t=t*31+e.charCodeAt(s)|0;const i=(t>>>0).toString(16),r={imock:{type:"cache",version:1,timestamp:Date.now(),count:(n?.mappings||[]).length,hash:i}},o={id:IMOCK_CACHE_ID,name:"iMock Cache",priority:1,persistent:!1,request:{method:"GET",url:IMOCK_CACHE_URL},response:{status:200,jsonBody:n,headers:{"Content-Type":"application/json; charset=utf-8"}},metadata:r};try{Logger.cache("PUT /mappings/{id}");const s=await apiFetch(`/mappings/${IMOCK_CACHE_ID}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});return Logger.cache("Upsert done (PUT)"),s}catch{Logger.cache("PUT failed, POST /mappings");const s=await apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});return Logger.cache("Upsert done (POST)"),s}}async function regenerateImockCache(n=null){Logger.cache("Regenerate cache start");const e=performance.now();let t=n;t||(t=await fetchMappingsFromServer({force:!0}));const i=t?.mappings||[];Logger.cache("Using fresh server data for cache regeneration");const r=buildSlimList(i);let o=r;try{const c=await upsertImockCacheMapping(r),l=extractCacheJsonBody(c);l&&(o=l)}catch(c){Logger.warn("CACHE","Upsert cache failed:",c)}const s=Math.round(performance.now()-e);return Logger.cache(`Regenerate cache done (${(o?.mappings||[]).length} items) in ${s}ms`),o}async function refreshImockCache(){Logger.cache("Refresh cache requested");try{const n=await regenerateImockCache();return typeof window.refreshMappingsFromCache=="function"&&window.refreshMappingsFromCache(),Logger.cache("Refresh cache completed"),n}catch(n){throw Logger.error("CACHE","Refresh cache failed:",n),n}}window.refreshImockCache=refreshImockCache;async function loadImockCacheBestOf3(){Logger.cache("loadImockCacheBestOf3 start (fixed-id only)");const n=await getCacheByFixedId();return n&&n.response?.jsonBody?(Logger.cache("Using cache: fixed id"),{source:"cache",data:n.response.jsonBody}):(Logger.cache("No cache found - will load from server"),null)}function cloneMappingForCache(n){if(!n)return null;try{if(typeof structuredClone=="function")return structuredClone(n)}catch(e){Logger.warn("CACHE","structuredClone failed for mapping cache clone:",e)}try{return JSON.parse(JSON.stringify(n))}catch(e){Logger.warn("CACHE","JSON clone failed for mapping cache clone:",e)}return{...n}}function mergeMappingData(n,e){return n?e?{...n,...e,request:{...n.request,...e.request},response:{...n.response,...e.response},metadata:{...n.metadata,...e.metadata}}:n:e}function syncCacheWithMappings(n){try{const e=window.MappingsStore;if(!e||!(e.items instanceof Map)||!Array.isArray(n))return;const t=e.items,i=new Set;n.forEach(s=>{if(!s||isImockCacheMapping(s))return;const c=s.id||s.uuid;if(!c)return;i.add(c);const l=cloneMappingForCache(s)||{...s};t.has(c)?t.set(c,mergeMappingData(t.get(c),l)):t.set(c,l)});const r=e.pending instanceof Map?Array.from(e.pending.values()):[],o=new Set;for(const s of r)!s||s.type==="delete"||s.id&&o.add(s.id);Array.from(t.keys()).forEach(s=>{!i.has(s)&&!o.has(s)&&t.delete(s)}),window.cacheLastUpdate=Date.now()}catch(e){Logger.warn("CACHE","syncCacheWithMappings failed:",e)}}function extractCacheJsonBody(n){try{if(!n||typeof n!="object")return null;if(n.response?.jsonBody)return n.response.jsonBody;if(n.mapping?.response?.jsonBody)return n.mapping.response.jsonBody;if(n.jsonBody?.mappings||Array.isArray(n.mappings))return{mappings:(Array.isArray(n.jsonBody?.mappings)?n.jsonBody.mappings:Array.isArray(n.mappings)?n.mappings:[]).map(t=>({...t}))}}catch(e){Logger.warn("CACHE","extractCacheJsonBody failed:",e)}return null}(function(e){function t(i={}){const{markDemoModeActive:r,notificationManager:o,fetchAndRenderMappings:s,fetchAndRenderRequests:c,isDatasetAvailable:l,getDataset:d}=i;if(typeof r!="function")throw new Error("Demo loader requires markDemoModeActive callback");if(!o||typeof o=="function")throw new Error("Demo loader requires a notification manager object");if(typeof s!="function")throw new Error("Demo loader requires fetchAndRenderMappings function");if(typeof c!="function")throw new Error("Demo loader requires fetchAndRenderRequests function");const m=o?.success?.bind(o)||o?.info?.bind(o)||(I=>Logger.warn("DEMO",I)),h=o?.error?.bind(o)||o?.warning?.bind(o)||(I=>Logger.warn("DEMO",I)),S=o?.warning?.bind(o)||o?.info?.bind(o)||(I=>Logger.warn("DEMO",I));return async function(){if(!(typeof l=="function"?l():!0))return h("Demo dataset is not available in this build."),{status:"unavailable",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};const v=typeof d=="function"?d():null;if(!v)return h("Unable to load the demo dataset."),{status:"missing",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};const g=Array.isArray(v.mappings)?v.mappings:[],w=Array.isArray(v.requests)?v.requests:[];r("manual-trigger");const[A,N]=await Promise.allSettled([s(g,{source:"demo"}),c(w,{source:"demo"})]),D=A.status==="fulfilled"?A.value!==!1:!1,V=N.status==="fulfilled"?N.value!==!1:!1,H=[];A.status==="rejected"&&H.push(A.reason),N.status==="rejected"&&H.push(N.reason);const de=D&&V?"success":D||V?"partial":"failed";return de==="success"?m("Demo data loaded locally. Explore the interface freely."):(S("Demo data only loaded partially. Check the console for details."),H.length&&h("Some demo data failed to load. Inspect console for details.")),{status:de,mappingsLoaded:D,requestsLoaded:V,errors:H}}}e.DemoMode={createLoader:t}})(typeof window<"u"?window:globalThis),(function(e){let t=!1;function i(r){if(t)return!0;if(!r)return!1;t=!0;const o=e,s=r,{markDemoModeActive:c,addMappingToIndex:l,rebuildMappingIndex:d,computeMappingTabTotals:m,refreshMappingTabSnapshot:h,computeRequestTabTotals:S,refreshRequestTabSnapshot:I,removeMappingFromIndex:T,fetchMappingsFromServer:v}=s;o.updateUptime=function(){if(!o.startTime)return;const x=Math.floor((Date.now()-o.startTime)/1e3),j=Math.floor(x/3600),F=Math.floor(x%3600/60),U=x%60,re=document.getElementById("uptime");re&&(j>0?re.textContent=`${j}h ${F}m ${U}s`:F>0?re.textContent=`${F}m ${U}s`:re.textContent=`${U}s`)},o.stopUptime=function(){o.uptimeInterval&&(o.LifecycleManager.clearInterval(o.uptimeInterval),o.uptimeInterval=null),o.startTime=null;const x=document.getElementById("uptime");x&&(x.textContent="0s")},o.checkHealth=async()=>{try{const x=document.getElementById("wiremock-host"),j=document.getElementById("wiremock-port");if(x&&j&&(x.value.trim()||j.value.trim())){const F=x.value.trim()||"localhost",U=j.value.trim()||"8080";typeof o.normalizeWiremockBaseUrl=="function"?o.wiremockBaseUrl=o.normalizeWiremockBaseUrl(F,U):o.wiremockBaseUrl=`http://${F}:${U}/__admin`,Logger.info("FEATURES","Updated WireMock URL from form:",o.wiremockBaseUrl)}await checkHealthAndStartUptime(),NotificationManager.success("Health check passed!")}catch(x){NotificationManager.error(`Health check failed: ${x.message}`)}},o.refreshMappings=async()=>{try{const x=typeof o.readWiremockSettings=="function"?o.readWiremockSettings():{},j=isCacheEnabled();await fetchAndRenderMappings(null,{useCache:j})&&NotificationManager.success("Mappings refreshed!")}catch(x){NotificationManager.error(`Failed to refresh mappings: ${x.message}`)}},o.forceRefreshCache=async()=>{try{if(!isCacheEnabled()){NotificationManager.warning("Cache is not enabled. Enable it in Settings first.");return}if(typeof o.refreshImockCache!="function"){NotificationManager.error("Cache service not available");return}const x=document.querySelector('[onclick="forceRefreshCache()"]');x&&(x.classList.add("is-loading"),x.disabled=!0);const j=await o.refreshImockCache();let F=!0;j&&typeof j=="object"&&(j.cacheMessage&&w(SELECTORS.IMPORT.RESULT,"info",j.cacheMessage),typeof j.useCache=="boolean"&&(F=j.useCache)),await fetchAndRenderMappings(null,{useCache:F})&&NotificationManager.success("Cache rebuilt and mappings refreshed!")}catch(x){NotificationManager.error(`Failed to rebuild cache: ${x.message}`)}finally{const x=document.querySelector('[onclick="forceRefreshCache()"]');x&&(x.classList.remove("is-loading"),x.disabled=!1)}};const g=o.DemoMode&&typeof o.DemoMode.createLoader=="function"?o.DemoMode.createLoader({markDemoModeActive:c,notificationManager:NotificationManager,fetchAndRenderMappings,fetchAndRenderRequests,isDatasetAvailable:()=>o.DemoData?.isAvailable?.(),getDataset:()=>o.DemoData?.getDataset?.()}):null;o.loadMockData=async()=>{if(!g)return NotificationManager.error("Demo mode is not available in this build."),{status:"unavailable",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};o.demoModeLastError=null;const x=await g();if(x&&x.status!=="success"){const[j]=Array.isArray(x.errors)?x.errors:[];o.demoModeLastError=j||x.status}return o.demoModeLastResult=x,x},o.updateScenarioState=async()=>{const x=document.getElementById("scenario-select"),j=document.getElementById("scenario-state"),F=document.getElementById("scenario-update-btn");if(!x?.value||!j?.value){NotificationManager.warning("Please select scenario and enter state");return}F&&(F.disabled=!0);try{await o.setScenarioState()}finally{F&&(F.disabled=!1)}},o.updateFileDisplay=()=>{const x=document.getElementById(SELECTORS.IMPORT.FILE),j=document.getElementById(SELECTORS.IMPORT.DISPLAY),F=document.getElementById(SELECTORS.IMPORT.ACTIONS);if(!x||!j){Logger.warn("FEATURES","Import file elements not found.");return}if(x.files?.length>0){const U=x.files[0],re=U.size?` (${Math.round(U.size/1024)} KB)`:"";j.innerHTML=`<strong>${U.name}</strong>${re}`,F&&(F.style.display="block")}else j.innerHTML='<span class="file-placeholder">No file selected</span>',F&&(F.style.display="none")},o.updateRecorderLink=(x,j)=>{try{const F=document.getElementById("recorder-link");if(!F)return;const U=(x||"").trim();if(!U){F.removeAttribute("href"),F.setAttribute("title","Configure host in Settings to enable recorder link"),F.textContent="Recorder UI (configure host first)";return}let re=U;/^https?:\/\//i.test(re)||(re=`http://${re}`);const J=new URL(re);j&&String(j).trim()&&(J.port=String(j).trim()),J.pathname="/__admin/recorder/",F.href=J.toString(),F.textContent=J.toString(),F.removeAttribute("title")}catch(F){Logger.warn("FEATURES","Failed to update recorder link:",F)}};function w(x,j,F){const U=document.getElementById(x);if(!U)return;const re=j==="success"?"\u2705":j==="error"?"\u274C":"\u2139\uFE0F";U.textContent=`${re} ${F}`}function A(x,j,F){const U=new Blob([j],{type:F}),re=URL.createObjectURL(U),J=document.createElement("a");J.href=re,J.download=x,document.body.appendChild(J),J.click(),document.body.removeChild(J),setTimeout(()=>URL.revokeObjectURL(re),0)}function N(){if(o.elementCache?.has(SELECTORS.IMPORT.ACTIONS)){const F=o.elementCache.get(SELECTORS.IMPORT.ACTIONS);if(F){const U=F.querySelector("button");if(U)return U}}const x=document.getElementById(SELECTORS.IMPORT.ACTIONS);if(!x)return null;const j=x.querySelector("button");return j&&o.elementCache&&o.elementCache.set(SELECTORS.IMPORT.ACTIONS,x),j}function D(x){const j=N();j&&(j.classList.toggle("is-loading",x),j.disabled=x)}function V(x=null){if(x)return x;const j=document.getElementById(SELECTORS.IMPORT.MODE);return j&&j.value||"MERGE"}async function H(){const x=document.getElementById(SELECTORS.IMPORT.FILE);if(!x?.files?.length)throw new Error("Please select a file to import.");const j=x.files[0],F=await j.text(),U=j.name.split(".").pop()?.toLowerCase();if(U==="yaml"||U==="yml"){if(o.jsyaml?.load)return o.jsyaml.load(F);throw new Error("YAML parser is not available.")}try{return JSON.parse(F)}catch{throw new Error("Failed to parse JSON import file.")}}function de(x,j){if(!x||typeof x!="object")throw new Error("Import file is empty or malformed.");const F=JSON.parse(JSON.stringify(x)),U={};if(["meta","globalSettings","requestJournal","importSettings"].forEach(se=>{F&&Object.prototype.hasOwnProperty.call(F,se)&&(U[se]=F[se])}),Array.isArray(F))U.mappings=F;else if(Array.isArray(F.mappings))U.mappings=F.mappings;else if(F.mappings&&typeof F.mappings=="object"){if(Array.isArray(F.mappings.mappings))U.mappings=F.mappings.mappings;else if(Array.isArray(F.mappings.items))U.mappings=F.mappings.items;else{const ye=Object.values(F.mappings).filter(Boolean).filter(we=>typeof we=="object"&&(we.request||we.response));ye.length>0&&(U.mappings=ye)}!U.mappings&&(F.mappings.request||F.mappings.response)&&(U.mappings=[F.mappings])}else F.mappings?U.mappings=[F.mappings]:Array.isArray(F.mapping)?U.mappings=F.mapping:F.mapping?U.mappings=[F.mapping]:Array.isArray(F.stubs)?U.mappings=F.stubs:F.stubs&&typeof F.stubs=="object"?U.mappings=Object.values(F.stubs).filter(Boolean):(F.request||F.response)&&(U.mappings=[F]);if(!Array.isArray(U.mappings))throw new Error("No mappings array found in the import file.");if(U.mappings=U.mappings.filter(Boolean),U.mappings.length===0)throw new Error("The import file does not contain any mappings.");Object.keys(F).forEach(se=>{["mappings","mapping","importMode"].includes(se)||Object.prototype.hasOwnProperty.call(U,se)||(U[se]=F[se])});const J=j||F.importMode||"MERGE";return U.importMode=J,U}async function be(x=null){try{D(!0),w(SELECTORS.IMPORT.RESULT,"info","Processing import file...");const j=await H(),F=V(x),U=de(j,F);U.importMode=F,await apiFetch(ENDPOINTS.MAPPINGS_IMPORT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(U)}),NotificationManager.success(`Imported ${U.mappings.length} mapping(s).`);const re=document.getElementById(SELECTORS.IMPORT.FILE);re&&(re.value="",o.updateFileDisplay());try{typeof o.refreshImockCache=="function"&&await o.refreshImockCache(),await fetchAndRenderMappings(null,{useCache:!1})}catch(J){Logger.warn("FEATURES","Failed to refresh mappings after import:",J)}w(SELECTORS.IMPORT.RESULT,"success",`Imported ${U.mappings.length} mapping(s) using mode ${F}.`)}catch(j){throw Logger.error("FEATURES","Import failed:",j),w(SELECTORS.IMPORT.RESULT,"error",j.message||"Import failed."),NotificationManager.error(`Import failed: ${j.message}`),j}finally{D(!1)}}return o.executeImport=be,o.exportMappings=async()=>{const j=document.getElementById(SELECTORS.EXPORT.FORMAT)?.value||"json";w(SELECTORS.EXPORT.RESULT,"info","Preparing mappings export...");try{const U=(await apiFetch(ENDPOINTS.MAPPINGS))?.mappings||[],J=`wiremock-mappings-${new Date().toISOString().replace(/[:.]/g,"-")}`;if(j==="yaml"){if(!o.jsyaml?.dump)throw new Error("YAML serializer is not available.");const se=o.jsyaml.dump({mappings:U},{noRefs:!0});A(`${J}.yaml`,se.endsWith(`
`)?se:`${se}
`,"text/yaml")}else{const se=JSON.stringify({mappings:U},null,2);A(`${J}.json`,`${se}
`,"application/json")}w(SELECTORS.EXPORT.RESULT,"success",`Exported ${U.length} mapping(s) as ${j.toUpperCase()}.`),NotificationManager.success(`Exported ${U.length} mapping(s).`)}catch(F){Logger.error("FEATURES","Export mappings failed:",F),w(SELECTORS.EXPORT.RESULT,"error",F.message||"Failed to export mappings."),NotificationManager.error(`Failed to export mappings: ${F.message}`)}},o.exportRequests=async()=>{const j=document.getElementById(SELECTORS.EXPORT.FORMAT)?.value||"json";w(SELECTORS.EXPORT.RESULT,"info","Preparing request log export...");try{const U=(await apiFetch(ENDPOINTS.REQUESTS))?.requests||[],J=`wiremock-requests-${new Date().toISOString().replace(/[:.]/g,"-")}`;if(j==="yaml"){if(!o.jsyaml?.dump)throw new Error("YAML serializer is not available.");const se=o.jsyaml.dump({requests:U},{noRefs:!0});A(`${J}.yaml`,se.endsWith(`
`)?se:`${se}
`,"text/yaml")}else{const se=JSON.stringify({requests:U},null,2);A(`${J}.json`,`${se}
`,"application/json")}w(SELECTORS.EXPORT.RESULT,"success",`Exported ${U.length} request(s) as ${j.toUpperCase()}.`),NotificationManager.success(`Exported ${U.length} request(s).`)}catch(F){Logger.error("FEATURES","Export requests failed:",F),w(SELECTORS.EXPORT.RESULT,"error",F.message||"Failed to export request log."),NotificationManager.error(`Failed to export request log: ${F.message}`)}},!0}if(!i(e.FeaturesState)){let r=null;const o=s=>{const c=s&&s.detail&&s.detail.state||e.FeaturesState;return i(c)?(typeof e.removeEventListener=="function"&&e.removeEventListener("features:state-ready",o),r!==null&&(e.clearInterval(r),r=null),!0):!1};if(typeof e.addEventListener=="function"&&e.addEventListener("features:state-ready",o),typeof e.setInterval=="function"){let s=0;r=e.setInterval(()=>{s+=1,!o()&&s>=200&&(e.clearInterval(r),r=null,t||Logger.error("FEATURES","features.js could not find FeaturesState after waiting for 10 seconds."))},50)}}})(typeof window<"u"?window:globalThis),Logger.info("UI","\u2705 All required modules loaded successfully"),window.DEFAULT_SETTINGS={host:"localhost",port:"8080",requestTimeout:"69000",customHeaders:{},customHeadersRaw:"",cacheEnabled:!0,autoRefreshEnabled:!1,refreshInterval:"0",autoConnect:!0,cacheRebuildDelay:"1000",cacheValidationDelay:"1500",optimisticCacheAgeLimit:"30000",cacheCountDiffThreshold:"2",backgroundFetchDelay:"200"};const DEFAULT_SETTINGS=window.DEFAULT_SETTINGS;window.customHeaders={...DEFAULT_SETTINGS.customHeaders||{}};let autoConnectInitiated=!1;function getStoredSettings(){return window.SettingsStore&&typeof window.SettingsStore.getStoredSettings=="function"?window.SettingsStore.getStoredSettings():{}}function parseCustomHeadersInput(n){return window.SettingsStore&&typeof window.SettingsStore.parseCustomHeadersInput=="function"?window.SettingsStore.parseCustomHeadersInput(n):{headers:{},raw:""}}function serializeCustomHeaders(n){return window.SettingsStore&&typeof window.SettingsStore.serializeCustomHeaders=="function"?window.SettingsStore.serializeCustomHeaders(n):""}function shouldAutoConnect(n){return window.SettingsStore&&typeof window.SettingsStore.shouldAutoConnect=="function"?window.SettingsStore.shouldAutoConnect(n):!1}function showOnboardingOverlay(){const n=document.getElementById("onboarding-overlay");if(!n)return;n.classList.remove("hidden"),requestAnimationFrame(()=>{n.classList.add("visible")}),document.body&&document.body.classList.add("onboarding-active");const e=n.querySelector("#onboarding-host");e&&e.focus()}function hideOnboardingOverlay(){const n=document.getElementById("onboarding-overlay");n&&(n.classList.remove("visible"),setTimeout(()=>{n.classList.add("hidden")},220),document.body&&document.body.classList.remove("onboarding-active"))}function attemptAutoConnect(n,e={}){if(Logger.info("UI","\u{1F50C} [attemptAutoConnect] Called with settings:",n),Logger.info("UI","\u{1F50C} [attemptAutoConnect] Options:",e),Logger.info("UI","\u{1F50C} [attemptAutoConnect] shouldAutoConnect:",shouldAutoConnect(n)),Logger.info("UI","\u{1F50C} [attemptAutoConnect] autoConnectInitiated:",autoConnectInitiated),!shouldAutoConnect(n)){Logger.info("UI","\u26A0\uFE0F [attemptAutoConnect] Skipping - shouldAutoConnect returned false");return}if(autoConnectInitiated&&!e.force){Logger.info("UI","\u26A0\uFE0F [attemptAutoConnect] Skipping - already initiated and not forced");return}autoConnectInitiated=!0,Logger.info("UI","\u2705 [attemptAutoConnect] Proceeding with autoconnect");const t=()=>{try{Logger.info("UI","\u{1F50C} [attemptAutoConnect] Triggering connection...");const i=typeof window.connectToWireMock=="function"?window.connectToWireMock():null;i&&typeof i.catch=="function"&&i.catch(r=>{Logger.error("UI","\u274C Auto-connect failed:",r),autoConnectInitiated=!1})}catch(i){Logger.error("UI","\u274C Auto-connect encountered an error:",i),autoConnectInitiated=!1}};e.immediate?(Logger.info("UI","\u{1F50C} [attemptAutoConnect] Immediate mode - connecting now"),t()):(Logger.info("UI","\u{1F50C} [attemptAutoConnect] Delayed mode - connecting in 150ms"),setTimeout(t,150))}function initializeOnboardingFlow(){const n=document.getElementById("onboarding-overlay"),e=document.getElementById("onboarding-form"),t=document.getElementById("onboarding-host"),i=document.getElementById("onboarding-port"),r=document.getElementById("onboarding-headers"),o=document.getElementById("onboarding-auto-connect"),s=getStoredSettings(),c=!!(s.host&&s.port);Logger.info("UI","\u{1F527} [initializeOnboardingFlow] Settings:",s),Logger.info("UI","\u{1F527} [initializeOnboardingFlow] Has configuration:",c),Logger.info("UI","\u{1F527} [initializeOnboardingFlow] autoConnect setting:",s.autoConnect),t&&(t.value=s.host||DEFAULT_SETTINGS.host||""),i&&(i.value=s.port||DEFAULT_SETTINGS.port||""),r&&(r.value=serializeCustomHeaders(s)),o&&(o.checked=s.autoConnect!==!1),c?(Logger.info("UI","\u2705 [initializeOnboardingFlow] Configuration found - attempting autoconnect"),attemptAutoConnect(s)):(Logger.info("UI","\u26A0\uFE0F [initializeOnboardingFlow] No configuration - showing onboarding overlay"),showOnboardingOverlay()),e&&e.addEventListener("submit",l=>{l.preventDefault();const d=t?.value.trim(),m=i?.value.trim();if(!d){typeof NotificationManager<"u"&&NotificationManager.error("Host is required."),t?.focus();return}let h;try{h=parseCustomHeadersInput(r?.value??"")}catch(I){Logger.error("UI","Failed to parse onboarding headers:",I),typeof NotificationManager<"u"&&NotificationManager.error(I.message),r?.focus();return}const S={...DEFAULT_SETTINGS,...getStoredSettings(),host:d,port:m||DEFAULT_SETTINGS.port,customHeaders:h.headers,customHeadersRaw:h.raw,autoConnect:o?o.checked:DEFAULT_SETTINGS.autoConnect};localStorage.setItem("wiremock-settings",JSON.stringify(S)),window.customHeaders={...S.customHeaders||{}},loadSettings(),loadConnectionSettings(),hideOnboardingOverlay(),shouldAutoConnect(S)?attemptAutoConnect(S,{immediate:!0,force:!0}):typeof NotificationManager<"u"&&NotificationManager.info("Connection saved. You can connect from the dashboard when you are ready.")},{once:!1})}window.initializeOnboardingFlow=initializeOnboardingFlow,window.attemptAutoConnect=attemptAutoConnect,window.hideOnboardingOverlay=hideOnboardingOverlay,window.editMapping=n=>{Logger.info("UI","\u{1F527} Opening editor for mapping:",n);const e=getStoredSettings(),t=encodeURIComponent(JSON.stringify(e)),i=`editor/json-editor.html?mappingId=${n}&mode=edit&settings=${t}`,r=window.open(i,`editor_${n}`,"width=1200,height=800,scrollbars=yes,resizable=yes,status=yes");if(!r){NotificationManager.error("Popup blocked. Please allow popups for this site.");return}NotificationManager.info(`Editor opened for mapping ${n}`);const o=window.LifecycleManager.setNamedInterval("editor-close-watch",()=>{r.closed&&(window.LifecycleManager.clearInterval(o),Logger.info("UI","\u{1F504} Editor closed, updating counters only"),Utils.safeCall(window.updateMappingsCounter),Utils.safeCall(window.updateRequestsCounter))},1e3);window.LifecycleManager.setTimeout(()=>{r.closed||(window.LifecycleManager.clearInterval(o),Logger.info("UI","\u{1F504} Editor interval cleaned up after timeout"))},300*1e3)};function computeSwaggerUiUrl(n,e){const t=(n??"").toString().trim(),i=(e??"").toString().trim();if(!t&&!i)return null;try{const r=typeof window.normalizeWiremockBaseUrl=="function"?window.normalizeWiremockBaseUrl(t,i):`http://${t||"localhost"}:${i||"8080"}/__admin`;return r?`${r.replace(/\/?$/,"")}/swagger-ui/`:null}catch(r){return Logger.warn("UI","Failed to compute Swagger UI URL:",r),null}}window.updateSwaggerUILink=(n,e)=>{const t=document.getElementById("swagger-ui-link"),i=document.getElementById("swagger-ui-link-hint");if(!t)return;const r=n??document.getElementById("default-host")?.value??"",o=e??document.getElementById("default-port")?.value??"",s=computeSwaggerUiUrl(r,o);s?(t.href=s,t.textContent=s,t.classList.remove("is-disabled"),t.removeAttribute("aria-disabled"),i&&(i.textContent="Opens the WireMock Admin Swagger UI in a new tab.")):(t.removeAttribute("href"),t.textContent="Define host and port to enable Swagger UI link",t.classList.add("is-disabled"),t.setAttribute("aria-disabled","true"),i&&(i.textContent="We build this link from your saved connection details."))},window.saveSettings=()=>{try{const n=document.getElementById("cache-enabled"),e=document.getElementById("auto-refresh-enabled"),t=document.getElementById("auto-connect-enabled"),i=document.getElementById("custom-headers");let r;try{r=parseCustomHeadersInput(i?.value??"")}catch(l){Logger.error("UI","Failed to parse custom headers:",l),typeof NotificationManager<"u"&&NotificationManager.error(l.message),i?.focus();return}const o={...DEFAULT_SETTINGS,...getStoredSettings(),host:document.getElementById("default-host")?.value||DEFAULT_SETTINGS.host,port:document.getElementById("default-port")?.value||DEFAULT_SETTINGS.port,requestTimeout:document.getElementById("request-timeout")?.value||DEFAULT_SETTINGS.requestTimeout,cacheEnabled:n?.checked??DEFAULT_SETTINGS.cacheEnabled,autoRefreshEnabled:e?.checked??DEFAULT_SETTINGS.autoRefreshEnabled,refreshInterval:document.getElementById("refresh-interval")?.value||DEFAULT_SETTINGS.refreshInterval,cacheRebuildDelay:document.getElementById("cache-rebuild-delay")?.value||DEFAULT_SETTINGS.cacheRebuildDelay,cacheValidationDelay:document.getElementById("cache-validation-delay")?.value||DEFAULT_SETTINGS.cacheValidationDelay,optimisticCacheAgeLimit:document.getElementById("optimistic-cache-age-limit")?.value||DEFAULT_SETTINGS.optimisticCacheAgeLimit,cacheCountDiffThreshold:document.getElementById("cache-count-diff-threshold")?.value||DEFAULT_SETTINGS.cacheCountDiffThreshold,backgroundFetchDelay:document.getElementById("background-fetch-delay")?.value||DEFAULT_SETTINGS.backgroundFetchDelay,autoConnect:t?.checked??DEFAULT_SETTINGS.autoConnect,customHeaders:r.headers,customHeadersRaw:r.raw},s=document.getElementById("wiremock-host"),c=document.getElementById("wiremock-port");s&&(s.value=o.host),c&&(c.value=o.port),localStorage.setItem("wiremock-settings",JSON.stringify(o)),Logger.info("UI","\u{1F527} [main.js] Settings saved to localStorage:",o),Logger.info("UI","\u{1F527} [main.js] Request timeout field value:",document.getElementById("request-timeout")?.value),typeof window.normalizeWiremockBaseUrl=="function"?window.wiremockBaseUrl=window.normalizeWiremockBaseUrl(o.host,o.port):window.wiremockBaseUrl=`http://${o.host}:${o.port}/__admin`,window.customHeaders={...o.customHeaders||{}},broadcastSettingsUpdate(o),NotificationManager.success("Settings saved successfully!"),Logger.info("UI","\u{1F4BE} Settings saved:",o),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(o.host,o.port)}catch(n){Logger.error("UI","Error saving settings:",n),NotificationManager.error("Failed to save settings")}},window.resetSettings=()=>{if(confirm("Reset all settings to defaults?"))try{const n={host:document.getElementById("default-host"),port:document.getElementById("default-port"),timeout:document.getElementById("request-timeout"),cacheEnabled:document.getElementById("cache-enabled"),autoRefresh:document.getElementById("auto-refresh-enabled"),refreshInterval:document.getElementById("refresh-interval"),customHeaders:document.getElementById("custom-headers"),autoConnect:document.getElementById("auto-connect-enabled")};n.host&&(n.host.value=DEFAULT_SETTINGS.host),n.port&&(n.port.value=DEFAULT_SETTINGS.port),n.timeout&&(n.timeout.value=DEFAULT_SETTINGS.requestTimeout),n.cacheEnabled&&(n.cacheEnabled.checked=DEFAULT_SETTINGS.cacheEnabled),n.autoRefresh&&(n.autoRefresh.checked=DEFAULT_SETTINGS.autoRefreshEnabled),n.refreshInterval&&(n.refreshInterval.value=DEFAULT_SETTINGS.refreshInterval),n.customHeaders&&(n.customHeaders.value=DEFAULT_SETTINGS.customHeadersRaw||""),n.autoConnect&&(n.autoConnect.checked=DEFAULT_SETTINGS.autoConnect),localStorage.setItem("wiremock-settings",JSON.stringify(DEFAULT_SETTINGS)),window.wiremockBaseUrl=`http://${DEFAULT_SETTINGS.host}:${DEFAULT_SETTINGS.port}/__admin`,window.customHeaders={...DEFAULT_SETTINGS.customHeaders||{}},broadcastSettingsUpdate(DEFAULT_SETTINGS),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(DEFAULT_SETTINGS.host,DEFAULT_SETTINGS.port),NotificationManager.success("Settings reset to defaults!"),Logger.info("UI","\u{1F504} Settings reset to defaults")}catch(n){Logger.error("UI","Error resetting settings:",n),NotificationManager.error("Failed to reset settings")}},window.loadSettings=()=>{try{const n=getStoredSettings();Logger.info("UI","\u{1F527} [main.js] Loading settings from localStorage:",n);const e={host:document.getElementById("default-host"),port:document.getElementById("default-port"),timeout:document.getElementById("request-timeout"),cacheEnabled:document.getElementById("cache-enabled"),autoRefresh:document.getElementById("auto-refresh-enabled"),refreshInterval:document.getElementById("refresh-interval"),cacheRebuildDelay:document.getElementById("cache-rebuild-delay"),cacheValidationDelay:document.getElementById("cache-validation-delay"),optimisticCacheAgeLimit:document.getElementById("optimistic-cache-age-limit"),cacheCountDiffThreshold:document.getElementById("cache-count-diff-threshold"),backgroundFetchDelay:document.getElementById("background-fetch-delay"),customHeaders:document.getElementById("custom-headers"),autoConnect:document.getElementById("auto-connect-enabled")};if(e.host&&(e.host.value=n.host||DEFAULT_SETTINGS.host),e.port&&(e.port.value=n.port||DEFAULT_SETTINGS.port),e.timeout&&(e.timeout.value=n.requestTimeout||DEFAULT_SETTINGS.requestTimeout),e.cacheEnabled&&(e.cacheEnabled.checked=n.cacheEnabled!==void 0?n.cacheEnabled:DEFAULT_SETTINGS.cacheEnabled),e.autoRefresh&&(e.autoRefresh.checked=n.autoRefreshEnabled!==void 0?n.autoRefreshEnabled:DEFAULT_SETTINGS.autoRefreshEnabled),e.refreshInterval&&(e.refreshInterval.value=n.refreshInterval||DEFAULT_SETTINGS.refreshInterval),e.cacheRebuildDelay&&(e.cacheRebuildDelay.value=n.cacheRebuildDelay||DEFAULT_SETTINGS.cacheRebuildDelay),e.cacheValidationDelay&&(e.cacheValidationDelay.value=n.cacheValidationDelay||DEFAULT_SETTINGS.cacheValidationDelay),e.optimisticCacheAgeLimit&&(e.optimisticCacheAgeLimit.value=n.optimisticCacheAgeLimit||DEFAULT_SETTINGS.optimisticCacheAgeLimit),e.cacheCountDiffThreshold&&(e.cacheCountDiffThreshold.value=n.cacheCountDiffThreshold||DEFAULT_SETTINGS.cacheCountDiffThreshold),e.backgroundFetchDelay&&(e.backgroundFetchDelay.value=n.backgroundFetchDelay||DEFAULT_SETTINGS.backgroundFetchDelay),e.customHeaders&&(e.customHeaders.value=serializeCustomHeaders(n)),e.autoConnect&&(e.autoConnect.checked=n.autoConnect!==!1),window.customHeaders=n.customHeaders&&typeof n.customHeaders=="object"&&!Array.isArray(n.customHeaders)?{...n.customHeaders}:{...DEFAULT_SETTINGS.customHeaders||{}},Logger.info("UI","\u{1F4CB} Settings loaded into settings form"),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(n.host,n.port),typeof window.updateRecorderLink=="function")try{window.updateRecorderLink(n.host,n.port)}catch(t){Logger.warn("UI","Failed to update recorder link:",t)}}catch(n){Logger.error("UI","Error loading settings:",n)}};function broadcastSettingsUpdate(n){try{localStorage.setItem("wiremock-settings-broadcast",JSON.stringify({timestamp:Date.now(),settings:n})),Logger.info("UI","\u{1F4E1} Broadcasting settings update to editor windows")}catch(e){Logger.warn("UI","Failed to broadcast settings update:",e)}}if(window.wiremockBaseUrl||(window.wiremockBaseUrl=`http://${DEFAULT_SETTINGS.host}:${DEFAULT_SETTINGS.port}/__admin`,Logger.info("UI","\u{1F527} [main.js] Initialized default WireMock URL:",window.wiremockBaseUrl)),window.applyDefaultsToForm=()=>{Logger.info("UI","\u{1F527} [applyDefaultsToForm] Setting form defaults from DEFAULT_SETTINGS");const n=document.getElementById("default-host"),e=document.getElementById("default-port"),t=document.getElementById("request-timeout"),i=document.getElementById("cache-enabled"),r=document.getElementById("auto-refresh-enabled"),o=document.getElementById("refresh-interval"),s=document.getElementById("custom-headers"),c=document.getElementById("auto-connect-enabled");n&&!n.value&&(n.value=DEFAULT_SETTINGS.host),e&&!e.value&&(e.value=DEFAULT_SETTINGS.port),t&&!t.value&&(t.value=DEFAULT_SETTINGS.requestTimeout),i&&(i.checked=DEFAULT_SETTINGS.cacheEnabled),r&&(r.checked=DEFAULT_SETTINGS.autoRefreshEnabled),o&&!o.value&&(o.value=DEFAULT_SETTINGS.refreshInterval),s&&!s.value&&(s.value=DEFAULT_SETTINGS.customHeadersRaw||""),c&&(c.checked=DEFAULT_SETTINGS.autoConnect),Logger.info("UI","\u{1F527} [applyDefaultsToForm] Form defaults applied")},document.addEventListener("DOMContentLoaded",async()=>{if(await new Promise(s=>requestAnimationFrame(s)),window.location.pathname.includes("json-editor.html")||window.location.search.includes("mappingId=")||window.location.search.includes("mode=edit")||window.location.search.includes("mode=create")){Logger.info("UI","\u{1F4DD} JSON Editor page detected - skipping main app initialization");return}typeof window.initializeSidebarPreference=="function"&&window.initializeSidebarPreference(),applyDefaultsToForm(),loadSettings(),loadConnectionSettings(),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink();const e=document.getElementById("default-host"),t=document.getElementById("default-port"),i=()=>{typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink()};e?.addEventListener("input",i),t?.addEventListener("input",i),e?.addEventListener("change",i),t?.addEventListener("change",i),Logger.info("UI","\u{1F527} [main.js] Page loaded, defaults applied, settings initialized, ready for user interaction"),typeof window.initializeFilterTabs=="function"&&window.initializeFilterTabs(),typeof window.initMappingPagination=="function"&&window.initMappingPagination(),typeof window.FilterManager?.restoreFilters=="function"&&(window.FilterManager.restoreFilters("mappings"),typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay(),window.FilterManager.restoreFilters("requests"),typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay()),typeof window.loadAllSavedFilters=="function"&&window.loadAllSavedFilters();const r=typeof window.getActiveTabFromURL=="function"?window.getActiveTabFromURL():null;r&&["mappings","requests","scenarios","import-export","recording","settings"].includes(r)&&typeof window.showPage=="function"&&(Logger.info("UI",`\u{1F517} Switching to tab from URL: ${r}`),window.showPage(r,document.querySelector(`[onclick*="showPage('${r}')"]`))),initializeOnboardingFlow()}),window.addEventListener("popstate",()=>{if(Logger.info("UI","\u2B05\uFE0F Browser navigation detected, syncing filters from URL"),typeof window.URLStateManager>"u")return;const n=window.TabManager?.getCurrentTab();n==="mappings"?(window.URLStateManager.syncUIFromURL("mappings"),typeof window.FilterManager<"u"&&window.FilterManager.flushMappingFilters()):n==="requests"&&(window.URLStateManager.syncUIFromURL("requests"),typeof window.FilterManager<"u"&&window.FilterManager.flushRequestFilters())}),window.addEventListener("storage",n=>{if(n.key==="wiremock-settings"&&n.newValue)try{const e=JSON.parse(n.newValue);Logger.info("UI","\u{1F527} [main.js] Settings updated from external source:",e);const t=document.getElementById("wiremock-host"),i=document.getElementById("wiremock-port");t&&e.host&&(t.value=e.host),i&&e.port&&(i.value=e.port),e.host&&e.port&&(typeof window.normalizeWiremockBaseUrl=="function"?window.wiremockBaseUrl=window.normalizeWiremockBaseUrl(e.host,e.port):window.wiremockBaseUrl=`http://${e.host}:${e.port}/__admin`,Logger.info("UI","\u{1F527} [main.js] URL updated from settings change:",window.wiremockBaseUrl)),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(e.host,e.port),e.customHeaders&&typeof e.customHeaders=="object"&&!Array.isArray(e.customHeaders)?window.customHeaders={...e.customHeaders}:window.customHeaders={}}catch(e){Logger.error("UI","\u{1F527} [main.js] Error processing settings update:",e)}}),window.addEventListener("message",n=>{if(n.origin===window.location.origin){if(n.data&&n.data.type==="imock-cache-refresh"&&(Logger.info("UI","\u{1F4E8} [main.js] Received cache refresh request from:",n.data.source),typeof window.refreshImockCache=="function"&&window.refreshImockCache().catch(e=>{Logger.warn("UI","Failed to refresh cache from message:",e)})),n.data&&n.data.type==="imock-optimistic-mapping-update"&&(Logger.info("UI","\u{1F3AF} [main.js] Received optimistic mapping update from:",n.data.source,n.data.mapping.id),typeof window.applyOptimisticMappingUpdate=="function"&&(window.applyOptimisticMappingUpdate(n.data.mapping),typeof window.fetchAndRenderMappings=="function"))){Logger.info("UI","\u{1F3AF} [main.js] Triggering UI refresh after optimistic update");const e=window.MappingsStore.getAll();window.fetchAndRenderMappings(e)}n.data&&n.data.type==="imock-optimistic-cache-update"&&(Logger.info("UI","\u{1F9E9} [main.js] Received optimistic cache update from:",n.data.source,n.data.operation,n.data.mapping?.id),typeof window.updateOptimisticCache=="function"&&window.updateOptimisticCache(n.data.mapping,n.data.operation))}}),window.addEventListener("storage",n=>{if(n.key==="imock-cache-refresh-trigger"&&n.newValue&&(Logger.info("UI","\u{1F4BE} [main.js] Received localStorage cache refresh trigger"),typeof window.refreshImockCache=="function"&&window.refreshImockCache().catch(e=>{Logger.warn("UI","Failed to refresh cache from localStorage trigger:",e)})),n.key==="imock-optimistic-update"&&n.newValue)try{const e=JSON.parse(n.newValue);if(Logger.info("UI","\u{1F3AF} [main.js] Received localStorage optimistic update from:",e.source,"for mapping:",e.mapping?.id),e.mapping&&typeof window.applyOptimisticMappingUpdate=="function"){if(window.applyOptimisticMappingUpdate(e.mapping),typeof window.fetchAndRenderMappings=="function"){Logger.info("UI","\u{1F3AF} [main.js] Triggering UI refresh after localStorage optimistic update");const t=window.MappingsStore.getAll();window.fetchAndRenderMappings(t)}typeof window.updateMappingsCounter=="function"&&window.updateMappingsCounter()}}catch(e){Logger.warn("UI","Failed to process optimistic update from localStorage:",e)}}),typeof BroadcastChannel<"u")try{const n=new BroadcastChannel("imock-cache-refresh"),e=new BroadcastChannel("imock-optimistic-updates");n.addEventListener("message",t=>{t.data&&t.data.type==="cache-refresh"&&(Logger.info("UI","\u{1F4E1} [main.js] Received BroadcastChannel cache refresh from:",t.data.source),typeof window.refreshImockCache=="function"&&window.refreshImockCache().catch(i=>{Logger.warn("UI","Failed to refresh cache from BroadcastChannel:",i)}))}),e.addEventListener("message",t=>{if(t.data&&t.data.type==="optimistic-mapping-update"&&(Logger.info("UI","\u{1F3AF} [main.js] Received BroadcastChannel optimistic update from:",t.data.source,t.data.mapping.id),typeof window.applyOptimisticMappingUpdate=="function"&&(window.applyOptimisticMappingUpdate(t.data.mapping),typeof window.fetchAndRenderMappings=="function"))){Logger.info("UI","\u{1F3AF} [main.js] Triggering UI refresh after BroadcastChannel optimistic update");const i=window.MappingsStore.getAll();window.fetchAndRenderMappings(i)}}),window.addEventListener("beforeunload",()=>{n.close(),e.close()})}catch(n){Logger.warn("UI","BroadcastChannel setup failed:",n)}function loadConnectionSettings(){try{const n=getStoredSettings();Logger.info("UI","\u{1F527} [loadConnectionSettings] Loading settings:",n);const e=document.getElementById("wiremock-host"),t=document.getElementById("wiremock-port");e&&n.host&&(e.value=n.host,Logger.info("UI","\u{1F527} [loadConnectionSettings] Set host input:",n.host)),t&&n.port&&(t.value=n.port,Logger.info("UI","\u{1F527} [loadConnectionSettings] Set port input:",n.port)),Logger.info("UI","\u{1F527} [loadConnectionSettings] Form fields updated, URL will be set by connectToWireMock()")}catch(n){Logger.error("UI","Error loading connection settings:",n),Logger.info("UI","\u{1F527} [loadConnectionSettings] Error loading settings, form fields may remain empty")}}function convertJSONToYAML(n,e=0){const t="  ".repeat(e);if(Array.isArray(n))return n.length===0?`${t}[]`:n.map(i=>{if(isPlainObject(i)||Array.isArray(i)){const r=convertJSONToYAML(i,e+1).split(`
`),o=r.shift()||"";let s=`${t}- ${o.trimStart()}`;return r.length>0&&(s+=`
${r.join(`
`)}`),s}return`${t}- ${formatYAMLScalar(i)}`}).join(`
`);if(isPlainObject(n)){const i=Object.keys(n);return i.length===0?`${t}{}`:i.map(r=>{const o=formatYAMLKey(r),s=n[r];if(isPlainObject(s)||Array.isArray(s)){const c=convertJSONToYAML(s,e+1);return`${t}${o}:
${c}`}return`${t}${o}: ${formatYAMLScalar(s)}`}).join(`
`)}return`${t}${formatYAMLScalar(n)}`}function formatYAMLScalar(n){if(n==null)return"null";if(typeof n=="number"||typeof n=="boolean")return String(n);if(n instanceof Date)return JSON.stringify(n.toISOString());if(typeof n=="string"){if(n==="")return'""';const e=/^[A-Za-z0-9_\-]+$/,t=/^(?:true|false|null|yes|no|on|off|~)$/i;return e.test(n)&&!t.test(n)||!/[\n\r]/.test(n)&&!/^\s|\s$/.test(n)&&!/[#:>{}\[\],&*?]|!/.test(n)?n:JSON.stringify(n)}return JSON.stringify(n)}function formatYAMLKey(n){return typeof n=="string"&&/^[A-Za-z0-9_\-]+$/.test(n)?n:JSON.stringify(n)}function isPlainObject(n){return Object.prototype.toString.call(n)==="[object Object]"}function convertPathArrayToJSONPath(n){if(!Array.isArray(n)||n.length===0)return"$";let e="$";for(let t=1;t<n.length;t++){const i=n[t];if(typeof i=="number")e+=`[${i}]`;else if(typeof i=="string")if(isSimpleJsonPathSegment(i))e+=`.${i}`;else{const r=i.replace(/'/g,"\\'");e+=`['${r}']`}else i!=null&&(e+=`[${String(i)}]`)}return e}function convertPathArrayToPointer(n){if(!Array.isArray(n)||n.length===0)return"$";let e="$";for(let t=1;t<n.length;t++){const i=n[t];e=appendPointerSegment(e,i)}return e}function appendPointerSegment(n,e){return typeof e=="number"?`${n}/${e}`:`${n}/${escapeJsonPointerSegment(e)}`}function escapeJsonPointerSegment(n){return String(n).replace(/~/g,"~0").replace(/\//g,"~1")}function isSimpleJsonPathSegment(n){return/^[A-Za-z_][A-Za-z0-9_]*$/.test(n)}function buildJSONPointerLocator(n){if(typeof n!="string"||n.length===0)return null;try{const e=new Map,t=n.length,i=[0];for(let v=0;v<t;v++)n[v]===`
`&&i.push(v+1);let r=0;const o=v=>{v<0&&(v=0),v>t&&(v=t);let g=0,w=i.length-1;for(;g<=w;){const D=Math.floor((g+w)/2),V=i[D],H=D+1<i.length?i[D+1]:t+1;if(v<V)w=D-1;else if(v>=H)g=D+1;else return{lineNumber:D+1,column:v-V+1}}const A=i.length-1,N=i[A]||0;return{lineNumber:A+1,column:v-N+1}},s=()=>{for(;r<t;){const v=n[r];if(v===" "||v==="	"||v===`
`||v==="\r")r++;else break}},c=(v,g,w)=>{v&&g<=w&&e.set(v,{start:g,end:w})},l=v=>{if(s(),r>=t)throw new Error("Unexpected end of JSON input");const g=n[r];if(g==="{"){d(v);return}if(g==="["){m(v);return}if(g==='"'){const{start:w,end:A}=h();c(v,w,A);return}if(g==="-"||T(g)){const{start:w,end:A}=S();c(v,w,A);return}if(n.startsWith("true",r)){const{start:w,end:A}=I("true");c(v,w,A);return}if(n.startsWith("false",r)){const{start:w,end:A}=I("false");c(v,w,A);return}if(n.startsWith("null",r)){const{start:w,end:A}=I("null");c(v,w,A);return}throw new Error(`Unexpected token ${g} at position ${r}`)},d=v=>{const g=r;if(r++,s(),r<t&&n[r]==="}"){r++,c(v,g,r);return}for(;r<t;){if(n[r]!=='"')throw new Error("Expected string for object key");const{value:w}=h();if(s(),n[r]!==":")throw new Error("Expected colon after object key");r++;const A=appendPointerSegment(v,w);l(A),s();const N=n[r];if(N===","){r++,s();continue}if(N==="}"){r++,c(v,g,r);return}throw new Error("Expected comma or closing brace in object")}throw new Error("Unterminated object literal")},m=v=>{const g=r;if(r++,s(),r<t&&n[r]==="]"){r++,c(v,g,r);return}let w=0;for(;r<t;){const A=appendPointerSegment(v,w);l(A),w++,s();const N=n[r];if(N===","){r++,s();continue}if(N==="]"){r++,c(v,g,r);return}throw new Error("Expected comma or closing bracket in array")}throw new Error("Unterminated array literal")},h=()=>{const v=r;r++;let g="";for(;r<t;){const w=n[r];if(w==='"')return r++,{value:g,start:v,end:r};if(w==="\\"){if(r++,r>=t)throw new Error("Unterminated string literal");const A=n[r];switch(A){case'"':case"\\":case"/":g+=A;break;case"b":g+="\b";break;case"f":g+="\f";break;case"n":g+=`
`;break;case"r":g+="\r";break;case"t":g+="	";break;case"u":const N=n.slice(r+1,r+5);if(!/^[0-9a-fA-F]{4}$/.test(N))throw new Error("Invalid Unicode escape sequence");g+=String.fromCharCode(parseInt(N,16)),r+=4;break;default:g+=A;break}}else g+=w;r++}throw new Error("Unterminated string literal")},S=()=>{const v=r;if(n[r]==="-"&&r++,n[r]==="0")r++;else{if(!T(n[r]))throw new Error("Invalid number literal");for(;r<t&&T(n[r]);)r++}if(n[r]==="."){if(r++,!T(n[r]))throw new Error("Invalid number literal");for(;r<t&&T(n[r]);)r++}if(n[r]==="e"||n[r]==="E"){if(r++,(n[r]==="+"||n[r]==="-")&&r++,!T(n[r]))throw new Error("Invalid number literal");for(;r<t&&T(n[r]);)r++}return{start:v,end:r}},I=v=>{const g=r;if(n.slice(r,r+v.length)!==v)throw new Error(`Expected literal ${v}`);return r+=v.length,{start:g,end:r}},T=v=>v>="0"&&v<="9";return l("$"),s(),{getRange(v){if(!e.has(v))return null;const g=e.get(v),w=o(g.start),A=o(g.end);return{startLineNumber:w.lineNumber,startColumn:w.column,endLineNumber:A.lineNumber,endColumn:A.column}}}}catch(e){return console.warn("Failed to build JSON pointer locator:",e),null}}const TEMPLATE_CATEGORY_LABELS={basic:"Basic",advanced:"Advanced",testing:"Testing",integration:"Integration",proxy:"Proxy"};function getTemplateLibrarySnapshot(){return window.MonacoTemplateLibrary&&typeof window.MonacoTemplateLibrary.getAll=="function"?window.MonacoTemplateLibrary.getAll():[]}function formatRelativeTime(n){if(!n)return"\u2014";const e=Date.now(),t=n-e,i=Math.abs(t),r=[{limit:60*1e3,divisor:1e3,unit:"second"},{limit:3600*1e3,divisor:60*1e3,unit:"minute"},{limit:1440*60*1e3,divisor:3600*1e3,unit:"hour"},{limit:10080*60*1e3,divisor:1440*60*1e3,unit:"day"},{limit:720*60*60*1e3,divisor:10080*60*1e3,unit:"week"},{limit:1/0,divisor:720*60*60*1e3,unit:"month"}],o=typeof Intl<"u"&&Intl.RelativeTimeFormat?new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}):null;for(const{limit:s,divisor:c,unit:l}of r)if(i<s){const d=Math.round(t/c);if(o)return o.format(d,l);const m=d<0?"ago":"from now";return`${Math.abs(d)} ${l}${Math.abs(d)!==1?"s":""} ${m}`}return new Date(n).toLocaleString()}function formatBytes(n){if(!Number.isFinite(n)||n<=0)return"0 B";const e=[{limit:1024,suffix:"B",divisor:1},{limit:1024*1024,suffix:"KB",divisor:1024},{limit:1024*1024*1024,suffix:"MB",divisor:1024*1024}];for(const{limit:i,suffix:r,divisor:o}of e)if(n<i){const s=n/o;return r==="B"?`${Math.round(s)} ${r}`:`${s>=100?Math.round(s):s.toFixed(1)} ${r}`}return`${(n/(1024*1024*1024)).toFixed(2)} GB`}const HISTORY_DB_NAME="imock-history-ak",HISTORY_DB_VERSION=1,HISTORY_FRAMES_STORE="frames",HISTORY_SHA_STORE="shaIndex",HISTORY_LOCK_KEY="imock-history-lock",HISTORY_LOCK_TTL=3e3,DEBOUNCE_MS=1e4,MIN_DELTA_LEN=200,DEFAULT_HISTORY_BUDGET=50*1024*1024,IOS_HISTORY_BUDGET=30*1024*1024,LARGE_DIGEST_THRESHOLD=1e6,HEADER_PARENT_KEYS=new Set(["headers"]),IGNORED_KEYS=new Set(["id","uuid","updatedAt","insertionIndex"]);function isInsideJsonBody(n){return!n||!Array.isArray(n.path)?!1:n.path.includes("jsonBody")}function detectHistoryBudget(){if(typeof navigator>"u")return DEFAULT_HISTORY_BUDGET;const n=navigator.userAgent||"";return/iphone|ipad|ipod/i.test(n)?IOS_HISTORY_BUDGET:DEFAULT_HISTORY_BUDGET}function promisifyRequest(n){return new Promise((e,t)=>{n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}function waitForTransaction(n){return new Promise((e,t)=>{n.oncomplete=()=>e(),n.onabort=()=>t(n.error||new Error("Transaction aborted")),n.onerror=()=>t(n.error||new Error("Transaction error"))})}function openHistoryDatabase(){if(typeof indexedDB>"u")throw new Error("IndexedDB is not available");return new Promise((n,e)=>{const t=indexedDB.open(HISTORY_DB_NAME,HISTORY_DB_VERSION);t.onupgradeneeded=()=>{const i=t.result;if(!i.objectStoreNames.contains(HISTORY_FRAMES_STORE)){const r=i.createObjectStore(HISTORY_FRAMES_STORE,{keyPath:"seq",autoIncrement:!0});r.createIndex("id","id",{unique:!0}),r.createIndex("ts","ts")}i.objectStoreNames.contains(HISTORY_SHA_STORE)||i.createObjectStore(HISTORY_SHA_STORE,{keyPath:"sha256"})},t.onsuccess=()=>{const i=t.result;i.onversionchange=()=>{i.close()},n(i)},t.onerror=()=>e(t.error)})}function mappingSortKey(n){if(!n||typeof n!="object")return"";if(n.name)return String(n.name).toLowerCase();const e=n.request||{},t=e.method?String(e.method):"",i=e.url||e.urlPath||e.urlPattern||e.urlPathPattern||"";return[t,i].filter(Boolean).join(" ").toLowerCase()}function normalizeLineEndings(n){return typeof n=="string"?n.replace(/\r\n/g,`
`):n}function canonicalizeValue(n,e={path:[]}){if(Array.isArray(n)){const t=e.path[e.path.length-1],i=n.map(r=>canonicalizeValue(r,{path:[...e.path,null]}));return t==="mappings"?i.map(r=>({key:mappingSortKey(r),item:r})).sort((r,o)=>r.key.localeCompare(o.key)).map(({item:r})=>r):i}if(n&&typeof n=="object"){const t=[],i=isInsideJsonBody(e);for(const[s,c]of Object.entries(n)){if(IGNORED_KEYS.has(s)&&!i)continue;const l=e.path[e.path.length-1],m=l&&HEADER_PARENT_KEYS.has(l)&&!i?s.toLowerCase():s,h={path:[...e.path,m]},S=canonicalizeValue(c,h);t.push([m,S])}const r={},o=i?t:t.sort((s,c)=>s[0].localeCompare(c[0]));for(const[s,c]of o)r[s]=c;return r}return typeof n=="string"?normalizeLineEndings(n):n}function stableStringifyWireMock(n){if(typeof n=="string"){if(!n.trim())return"";try{const t=JSON.parse(normalizeLineEndings(n)),i=canonicalizeValue(t,{path:[]});return JSON.stringify(i,null,2)}catch{return normalizeLineEndings(n)}}if(n&&typeof n=="object"){const e=canonicalizeValue(n,{path:[]});return JSON.stringify(e,null,2)}return typeof n>"u"?"":String(n)}function crc32(n){let e=-1;for(let t=0;t<n.length;t+=1){e^=n[t];for(let i=0;i<8;i+=1){const r=-(e&1);e=e>>>1^3988292384&r}}return(e^-1)>>>0}let digestWorker=null;async function digestInWorker(n){if(typeof Worker>"u")return null;if(!digestWorker){const t=`self.onmessage = async (event) => {
    try {
        const buffer = event.data;
        const digest = await crypto.subtle.digest('SHA-256', buffer);
        self.postMessage(digest, [digest]);
    } catch (error) {
        self.postMessage({ error: error.message });
    }
};`,i=new Blob([t],{type:"application/javascript"});digestWorker=new Worker(URL.createObjectURL(i))}const e=n.buffer.slice(0);return new Promise((t,i)=>{const r=s=>{digestWorker.removeEventListener("message",r),digestWorker.removeEventListener("error",o);const{data:c}=s;c&&c.error?i(new Error(c.error)):t(c)},o=s=>{digestWorker.removeEventListener("message",r),digestWorker.removeEventListener("error",o),i(s)};digestWorker.addEventListener("message",r),digestWorker.addEventListener("error",o),digestWorker.postMessage(e,[e])})}async function sha256Hex(n){if(typeof crypto<"u"&&crypto.subtle)try{if(n.byteLength>LARGE_DIGEST_THRESHOLD){const r=await digestInWorker(n);if(r instanceof ArrayBuffer)return{algorithm:"sha256",hash:Array.from(new Uint8Array(r)).map(s=>s.toString(16).padStart(2,"0")).join("")}}const t=await crypto.subtle.digest("SHA-256",n);return{algorithm:"sha256",hash:Array.from(new Uint8Array(t)).map(r=>r.toString(16).padStart(2,"0")).join("")}}catch(t){console.warn("[HISTORY] Failed to compute SHA-256, falling back to CRC32",t)}return{algorithm:"crc32",hash:crc32(n).toString(16).padStart(8,"0")}}function delay(n){return new Promise(e=>setTimeout(e,n))}class EditorHistory{constructor(e=50){this.limit=Math.max(5,e),this.dbPromise=openHistoryDatabase(),this.cache=new Map,this.cacheLimit=5,this.currentId=null,this.lastEntry=null,this.budgetBytes=detectHistoryBudget(),this.stats={count:0,byteSize:0,latestTimestamp:null,latestLabel:null},this.ready=this.initialiseState()}async initialiseState(){try{const e=await this.dbPromise,t=await this.readAllFrames(e);if(t.length){const s=t[t.length-1];this.currentId=s.id,this.lastEntry={seq:s.seq,length:s.json.length,timestamp:s.ts,manual:!!s.manual}}let i=0,r=null,o=null;for(const s of t)i+=s.byteSize||0,(!r||s.ts>=r)&&(r=s.ts,o=s.label);this.stats={count:t.length,byteSize:i,latestTimestamp:r,latestLabel:o},this.scheduleCleanup()}catch(e){console.warn("[HISTORY] Failed to initialise history",e)}}async reset(e="",t={}){await this.ready;const i=typeof e=="string"?e:"";await this.withLock(async()=>{const o=(await this.dbPromise).transaction([HISTORY_FRAMES_STORE,HISTORY_SHA_STORE],"readwrite");o.objectStore(HISTORY_FRAMES_STORE).clear(),o.objectStore(HISTORY_SHA_STORE).clear(),await waitForTransaction(o),this.cache.clear(),this.currentId=null,this.lastEntry=null,this.stats={count:0,byteSize:0,latestTimestamp:null,latestLabel:null}}),(i.length>0||t.forceInitial)&&await this.record(i,{...t,reason:t.reason||"Initial snapshot",label:t.label||"Initial document",force:!0})}async readAllFrames(e){return new Promise((t,i)=>{const o=e.transaction(HISTORY_FRAMES_STORE,"readonly").objectStore(HISTORY_FRAMES_STORE),s=[],c=o.openCursor();c.onsuccess=l=>{const d=l.target.result;d?(s.push(d.value),d.continue()):t(s)},c.onerror=()=>i(c.error)})}updateCache(e,t){if(e)for(this.cache.has(e)&&this.cache.delete(e),this.cache.set(e,t);this.cache.size>this.cacheLimit;){const i=this.cache.keys().next().value;this.cache.delete(i)}}async withLock(e){if(typeof localStorage>"u")return e();const t=Date.now()+HISTORY_LOCK_TTL;let i=!1;for(let r=0;r<10;r+=1){const o=localStorage.getItem(HISTORY_LOCK_KEY);if(!o||Number(o)<Date.now())try{localStorage.setItem(HISTORY_LOCK_KEY,String(t)),i=!0;break}catch(s){console.warn("[HISTORY] Failed to acquire lock",s)}await delay(100)}if(!i)return e();try{return await e()}finally{localStorage.getItem(HISTORY_LOCK_KEY)===String(t)&&localStorage.removeItem(HISTORY_LOCK_KEY)}}cleanMeta(e){if(!e||typeof e!="object")return{};const t={...e};return delete t.force,delete t.contentOverride,delete t.editor,delete t.labelGenerated,t}deriveLabel(e,t={}){const i=t&&t.action?t.action:"Snapshot",r=typeof e=="string"?e.trim():"";if(!r)return i;try{const s=JSON.parse(r);if(s&&typeof s=="object"){if(s.name)return s.name;const c=s.request||{},l=c.method||"",d=c.url||c.urlPath||c.urlPattern||c.urlPathPattern||"",m=[];if(l&&m.push(l),d&&m.push(d),m.length)return m.join(" \xB7 ")}}catch{}const o=r.split(`
`)[0];return o.length>60?`${o.slice(0,57)}\u2026`:o||i}buildPreview(e){if(typeof e!="string"||e.trim().length===0)return"(empty document)";try{const t=JSON.parse(e),i=JSON.stringify(t,null,2);return this.truncatePreview(i)}catch{const i=e.split(`
`).slice(0,12).join(`
`);return this.truncatePreview(i)}}truncatePreview(e){return e.length<=480?e:`${e.slice(0,479)}\u2026`}async record(e,t={}){await this.ready;const i=typeof e=="string"?e:"",r=Date.now(),o=!!t.manual,s=this.cleanMeta(t),c=stableStringifyWireMock(i),l=typeof TextEncoder<"u"?new TextEncoder:null,d=l?l.encode(c):new Uint8Array(Array.from(c,I=>I.charCodeAt(0)&255)),{hash:m,algorithm:h}=await sha256Hex(d),S=this.lastEntry;if(!o&&S&&!t.force){const I=Math.abs(c.length-S.length),T=r-S.timestamp;if(I<MIN_DELTA_LEN&&T<DEBOUNCE_MS)return{recorded:!1,reason:"debounced",entry:null}}return this.withLock(async()=>{const I=await this.dbPromise,T=I.transaction([HISTORY_FRAMES_STORE,HISTORY_SHA_STORE],"readwrite"),v=T.objectStore(HISTORY_FRAMES_STORE),g=T.objectStore(HISTORY_SHA_STORE),w=await promisifyRequest(g.get(m));if(w!=null){const V=typeof w=="object"&&w.lastSeq?w.lastSeq:w,H=V!=null?await promisifyRequest(v.get(V)):null;if(H&&H.json===c)return H.occurrences=(H.occurrences||1)+1,H.lastAt=r,o&&!H.manual&&(H.manual=!0),H.meta={...H.meta||{},...s,manual:o||H.meta?.manual||H.manual,occurrences:H.occurrences,lastRecordedAt:new Date(r).toISOString(),hashAlgorithm:h},await promisifyRequest(v.put(H)),await waitForTransaction(T),this.stats.latestTimestamp=r,this.stats.latestLabel=H.label,this.currentId=H.id,this.lastEntry={seq:H.seq,length:c.length,timestamp:r,manual:H.manual},this.updateCache(H.seq,c),{recorded:!1,reason:"duplicate",entry:this.normalizeEntry(H)}}const A=s.label||this.deriveLabel(c,s),N={id:typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`hist-${r}-${Math.random().toString(36).slice(2,8)}`,ts:r,kind:"full",sha256:m,shaAlgorithm:h,byteSize:d.byteLength,label:A,occurrences:1,json:c,manual:o,meta:{...s,label:A,reason:s.reason||s.action||"Edit",occurrences:1,firstRecordedAt:new Date(r).toISOString(),lastRecordedAt:new Date(r).toISOString(),hashAlgorithm:h}},D=await promisifyRequest(v.add(N));return N.seq=D,await promisifyRequest(g.put({sha256:m,lastSeq:D})),await waitForTransaction(T),this.updateCache(D,c),this.currentId=N.id,this.lastEntry={seq:D,length:c.length,timestamp:r,manual:o},this.stats.count+=1,this.stats.byteSize+=N.byteSize,this.stats.latestTimestamp=r,this.stats.latestLabel=A,await this.enforceBudget({withinLock:!0,db:I}),{recorded:!0,entry:this.normalizeEntry(N)}})}normalizeEntry(e){const t=typeof e.json=="string"?e.json:"";return{id:e.id,seq:e.seq,timestamp:e.ts,content:t,label:e.label,preview:this.buildPreview(t),byteSize:e.byteSize,sizeLabel:formatBytes(e.byteSize||0),meta:{...e.meta||{},occurrences:e.occurrences||1,recordedAt:new Date(e.ts).toISOString()}}}async getEntries(e={}){await this.ready;const t=e.newestFirst===!0,i=await this.dbPromise,o=(await this.readAllFrames(i)).map(s=>this.normalizeEntry(s));return o.sort((s,c)=>t?c.timestamp-s.timestamp:s.timestamp-c.timestamp),e.limit?o.slice(0,e.limit):o}async getStats(){return await this.ready,{...this.stats}}getCurrentId(){return this.currentId}async getEntryById(e){await this.ready;const t=await this.dbPromise;return new Promise((i,r)=>{const l=t.transaction(HISTORY_FRAMES_STORE,"readonly").objectStore(HISTORY_FRAMES_STORE).index("id").get(e);l.onsuccess=()=>{i(l.result?this.normalizeEntry(l.result):null)},l.onerror=()=>r(l.error)})}markCurrent(e){this.currentId=e}async clear(e={}){await this.ready;const t=e.keepLatest!==!1,i=e.latestContent||"",r=e.label||"Current document";let o=null;t&&(o=(await this.getEntries({newestFirst:!0,limit:1}))[0]||null),await this.withLock(async()=>{const c=(await this.dbPromise).transaction([HISTORY_FRAMES_STORE,HISTORY_SHA_STORE],"readwrite");c.objectStore(HISTORY_FRAMES_STORE).clear(),c.objectStore(HISTORY_SHA_STORE).clear(),await waitForTransaction(c)}),this.cache.clear(),this.currentId=null,this.lastEntry=null,this.stats={count:0,byteSize:0,latestTimestamp:null,latestLabel:null},o?await this.record(o.content,{...o.meta,label:o.label,reason:"Preserved latest snapshot",manual:!!o.meta?.manual,force:!0}):t&&i&&await this.record(i,{label:r,reason:"Current document",force:!0})}async enforceBudget(e={}){if(await this.ready,this.stats.byteSize<=this.budgetBytes)return;const t=async i=>{const r=await this.readAllFrames(i);if(!r.length)return;const o=r[r.length-1].seq,s=new Set(r.filter(T=>T.manual).map(T=>T.seq)),c=new Set([o]),l=new Map,d=Date.now();for(const T of r){if(s.has(T.seq)){c.add(T.seq);continue}const v=d-T.ts;let g;v<=3600*1e3?g=60*1e3:v<=1440*60*1e3?g=600*1e3:v<=10080*60*1e3?g=3600*1e3:g=1440*60*1e3;const w=`${g}:${Math.floor(T.ts/g)}`,A=l.get(w);(!A||A.ts<T.ts)&&l.set(w,{seq:T.seq,ts:T.ts})}for(const T of l.values())c.add(T.seq);const m=r.filter(T=>!c.has(T.seq)&&!s.has(T.seq)).sort((T,v)=>T.ts-v.ts);if(!m.length)return;const h=i.transaction([HISTORY_FRAMES_STORE,HISTORY_SHA_STORE],"readwrite"),S=h.objectStore(HISTORY_FRAMES_STORE),I=h.objectStore(HISTORY_SHA_STORE);for(const T of m){await promisifyRequest(S.delete(T.seq)),this.stats.byteSize-=T.byteSize||0,this.stats.count-=1;const v=await promisifyRequest(I.get(T.sha256));if(v&&(v.lastSeq===T.seq||v===T.seq)){const g=r.filter(w=>w.sha256===T.sha256&&w.seq!==T.seq).sort((w,A)=>A.seq-w.seq)[0];g?await promisifyRequest(I.put({sha256:T.sha256,lastSeq:g.seq})):await promisifyRequest(I.delete(T.sha256))}if(this.stats.byteSize<=this.budgetBytes)break}if(await waitForTransaction(h),this.stats.byteSize<=0||this.stats.count<=0)this.stats={count:0,byteSize:0,latestTimestamp:null,latestLabel:null},this.currentId=null,this.lastEntry=null;else{const T=await this.readAllFrames(i);if(T.length){this.stats.count=T.length,this.stats.byteSize=T.reduce((g,w)=>g+(w.byteSize||0),0);const v=T[T.length-1];this.currentId=v.id,this.lastEntry={seq:v.seq,length:v.json.length,timestamp:v.ts,manual:!!v.manual},this.stats.latestTimestamp=v.ts,this.stats.latestLabel=v.label}else this.stats={count:0,byteSize:0,latestTimestamp:null,latestLabel:null},this.currentId=null,this.lastEntry=null}};if(e.withinLock&&e.db){await t(e.db);return}await this.withLock(async()=>{const i=await this.dbPromise;await t(i)})}async cleanup(e={}){const t=e.maxAgeMs||2592e6,i=e.maxEntries||50;await this.ready,await this.withLock(async()=>{const r=await this.dbPromise,o=r.transaction(HISTORY_FRAMES_STORE,"readwrite"),c=o.objectStore(HISTORY_FRAMES_STORE).index("ts"),l=Date.now()-t,d=IDBKeyRange.upperBound(l);let m=0;const h=c.openCursor(d);await new Promise((A,N)=>{h.onsuccess=D=>{const V=D.target.result;V?(V.delete(),m++,V.continue()):A()},h.onerror=()=>N(h.error)}),await waitForTransaction(o);const S=r.transaction(HISTORY_FRAMES_STORE,"readwrite"),I=S.objectStore(HISTORY_FRAMES_STORE),T=I.count(),v=await promisifyRequest(T);let g=0;if(v>i){const A=v-i,N=I.openCursor();await new Promise((D,V)=>{let H=0;N.onsuccess=de=>{const be=de.target.result;be&&H<A?(be.delete(),H++,g++,be.continue()):D()},N.onerror=()=>V(N.error)})}if(await waitForTransaction(S),m+g>0){console.log(`\u2705 [HISTORY] Cleanup completed: deleted ${m} old entries (>${Math.round(t/864e5)}d) + ${g} excess entries`);const A=await this.readAllFrames(r);if(this.stats.count=A.length,this.stats.byteSize=A.reduce((N,D)=>N+(D.byteSize||0),0),A.length>0){const N=A[A.length-1];this.stats.latestTimestamp=N.ts,this.stats.latestLabel=N.label}else this.stats.latestTimestamp=null,this.stats.latestLabel=null,this.currentId=null,this.lastEntry=null;console.log(`\u{1F4CA} [HISTORY] Stats after cleanup: ${this.stats.count} entries, ${(this.stats.byteSize/1024/1024).toFixed(2)} MB`)}})}scheduleCleanup(e=1440*60*1e3,t={}){const i=async()=>{try{await this.cleanup(t)}catch(o){console.error("[HISTORY] Cleanup failed:",o)}};setTimeout(i,1e4);const r=setInterval(i,e);return console.log(`\u2705 [HISTORY] Cleanup scheduled: every ${Math.round(e/36e5)}h, max age ${Math.round((t.maxAgeMs||720*60*60*1e3)/864e5)}d, max ${t.maxEntries||50} entries`),r}}function resolveTemplatePath(n,e){return!n||!e?void 0:(Array.isArray(e)?e:String(e).replace(/\[(\d+)\]/g,".$1").split(".")).reduce((i,r)=>{if(i!=null){if(Array.isArray(i)){const o=Number(r);return Number.isInteger(o)?i[o]:void 0}return i[r]}},n)}function formatFeatureValue(n){if(n==null)return"";if(typeof n=="string")return n.length>80?`${n.slice(0,77)}\u2026`:n;if(typeof n=="number"||typeof n=="boolean")return String(n);try{const e=JSON.stringify(n);return e.length>80?`${e.slice(0,77)}\u2026`:e}catch(e){return console.warn("Failed to serialise feature value",e),""}}function getTemplateFeature(n){if(!n||!n.feature)return null;const e=n.feature.path||n.feature,t=n.feature.label||(Array.isArray(e)?e.join("."):String(e)),i=resolveTemplatePath(n.content,e);return typeof i>"u"?null:{label:t,value:formatFeatureValue(i)}}function getTemplateHeadline(n){if(!n)return"";if(n.highlight)return n.highlight;const e=[];return n.content?.request?.method&&e.push(n.content.request.method),(n.content?.request?.url||n.content?.request?.urlPath)&&e.push(n.content.request.url||n.content.request.urlPath),e.join(" \xB7 ")}function buildTemplatePreview(n){try{const e=n&&n.content?n.content:{};if(typeof e=="string")return e;const r=JSON.stringify(e,null,2).split(`
`).slice(0,8).join(`
`);return r.length>320?`${r.slice(0,319)}\u2026`:r}catch{return"[unavailable template preview]"}}function copyTextToClipboard(n){if(typeof n!="string"&&(n=String(n??"")),typeof navigator<"u"&&navigator.clipboard&&typeof navigator.clipboard.writeText=="function")return navigator.clipboard.writeText(n).then(()=>!0).catch(()=>e(n));return Promise.resolve(e(n));function e(t){try{const i=document.createElement("textarea");return i.value=t,i.setAttribute("readonly",""),i.style.position="absolute",i.style.left="-9999px",document.body.appendChild(i),i.select(),document.execCommand("copy"),document.body.removeChild(i),!0}catch(i){return console.warn("Clipboard fallback failed:",i),!1}}}const HISTORY_SUMMARY_MAX_CHANGES=8,HISTORY_SUMMARY_MODAL_CHANGES=20,HISTORY_SUMMARY_MAX_DEPTH=4,HISTORY_SUMMARY_BRANCH_LIMIT=20;function safeParseSnapshot(n){if(typeof n!="string")return null;try{return JSON.parse(n)}catch{return null}}function formatHistoryLeafValue(n){if(n===void 0)return"\u2014";if(n===null)return"null";if(typeof n=="string")return`"${n.length>80?`${n.slice(0,77)}\u2026`:n}"`;if(typeof n=="number"||typeof n=="boolean")return String(n);if(Array.isArray(n))return n.length===0?"[]":n.every(t=>t==null||["string","number","boolean"].includes(typeof t))&&n.length<=5?`[${n.map(t=>formatHistoryLeafValue(t)).join(", ")}]`:`[${n.length} items]`;if(typeof n=="object"){const e=Object.keys(n||{});return e.length?`{${e.slice(0,5).join(", ")}${e.length>5?", \u2026":""}}`:"{}"}return String(n)}function flattenSnapshotForSummary(n,e,t="",i=0){if(i>=HISTORY_SUMMARY_MAX_DEPTH||n==null||typeof n!="object"){e.set(t||"(root)",formatHistoryLeafValue(n));return}if(Array.isArray(n)){if(n.length===0){e.set(t||"(root)","[]");return}const s=Math.min(n.length,HISTORY_SUMMARY_BRANCH_LIMIT);for(let c=0;c<s;c+=1){const l=t?`${t}[${c}]`:`[${c}]`;flattenSnapshotForSummary(n[c],e,l,i+1)}return}const r=Object.keys(n);if(!r.length){e.set(t||"(root)","{}");return}const o=r.sort((s,c)=>s.localeCompare(c)).slice(0,HISTORY_SUMMARY_BRANCH_LIMIT);for(const s of o){const c=t?`${t}.${s}`:s;flattenSnapshotForSummary(n[s],e,c,i+1)}}function summarizeHistoryChanges(n,e,t={}){const i=typeof t.limit=="number"?t.limit:HISTORY_SUMMARY_MAX_CHANGES,r=safeParseSnapshot(n),o=safeParseSnapshot(e);if(!r){const S=typeof n=="string"?n.length:0;if(o)return`Snapshot replaced with non-JSON content (${S} chars)`;const I=typeof e=="string"?e.length:0;return e==null?`Snapshot captured (non-JSON, ${S} chars)`:typeof e=="string"&&e===n?"No textual changes detected":`Content changed (${I} \u2192 ${S} chars)`}const s=new Map;flattenSnapshotForSummary(r,s);const c=new Map;o&&flattenSnapshotForSummary(o,c);const l=new Set([...s.keys(),...c.keys()]),d=Array.from(l).sort((S,I)=>S.localeCompare(I)),m=[];let h=0;for(const S of d){const I=c.has(S)?c.get(S):void 0,T=s.has(S)?s.get(S):void 0;if(I===T)continue;const v=S||"(root)";let g;typeof I>"u"?g=`${v}: ++ ${T}`:typeof T>"u"?g=`${v}: -- ${I}`:g=`${v}: ${I} \u2192 ${T}`,m.length<i?m.push(g):h+=1}return m.length?(h>0&&m.push(`\u2026and ${h} more change${h===1?"":"s"}`),m.join(`
`)):e==null?"Snapshot captured":"No field-level changes detected"}function formatHistoryFullContent(n){if(typeof n!="string")return"";const e=safeParseSnapshot(n);if(e!=null)try{return JSON.stringify(e,null,2)}catch{}return n}function renderHistoryPreviewMeta(n,e){n&&(n.innerHTML="",e.forEach(([t,i])=>{const r=document.createElement("div");r.className="history-preview-meta__row";const o=document.createElement("span");o.className="history-preview-meta__label",o.textContent=t;const s=document.createElement("span");s.className="history-preview-meta__value",s.textContent=i,r.appendChild(o),r.appendChild(s),n.appendChild(r)}))}function openHistoryPreview(n,e){const t=document.getElementById("historyPreviewModal");if(!t||!n)return;const i=window.monacoInitializer,r=t.querySelector("#modal-title-history-preview");r&&(r.textContent=n.label||"Snapshot preview");const o=t.querySelector("#historyPreviewMeta"),s=n.meta?.occurrences||1;renderHistoryPreviewMeta(o,[["Saved",`${formatRelativeTime(n.timestamp)} \xB7 ${new Date(n.timestamp).toLocaleString()}`],["Reason",n.meta?.reason||"edit"],["Size",n.sizeLabel||formatBytes(n.byteSize||(n.content?n.content.length:0))],["Occurrences",`${s}\xD7`]]);const c=t.querySelector("#historyPreviewSummary");c&&(c.textContent=summarizeHistoryChanges(n.content,e?e.content:null,{limit:HISTORY_SUMMARY_MODAL_CHANGES}));const l=t.querySelector("#historyPreviewContent");l&&(l.textContent=formatHistoryFullContent(n.content));const d=t.querySelector("#historyPreviewActions");if(d){d.dataset.currentContent=n.content||"",d.dataset.entryId=n.id||"";const m=d.querySelector('[data-history-preview-action="restore"]');if(m){const h=i&&typeof i.getCurrentHistoryEntryId=="function"?i.getCurrentHistoryEntryId():null,S=h&&n.id===h;m.disabled=!!S,m.textContent=S?"Current version":"Restore"}d.dataset.bound||(d.dataset.bound="true",d.addEventListener("click",async h=>{const S=h.target instanceof HTMLElement?h.target.closest("[data-history-preview-action]"):null;if(S){if(h.preventDefault(),S.dataset.historyPreviewAction==="copy"){const I=d.dataset.currentContent||"",T=await copyTextToClipboard(I);i&&typeof i.showNotification=="function"&&i.showNotification(T?"Snapshot copied to clipboard":"Failed to copy snapshot",T?"success":"error");return}if(S.dataset.historyPreviewAction==="restore"){if(!i||typeof i.restoreHistoryEntry!="function")return;const I=d.dataset.entryId;if(!I||S.disabled)return;const T=S.textContent;S.disabled=!0;try{await i.restoreHistoryEntry(I,{forceRestore:!1,requireConfirm:!0})}catch(w){console.error("[HISTORY] Failed to restore entry from preview",w),S.disabled=!1,S.textContent=T;return}const v=typeof i.getCurrentHistoryEntryId=="function"?i.getCurrentHistoryEntryId():null;v&&I===v?S.textContent="Current version":(S.disabled=!1,S.textContent=T)}}}))}window.openModal("historyPreviewModal")}async function renderHistoryModal(n={}){const e=document.getElementById("historyModal");if(!e)return;const t=window.monacoInitializer;if(t)try{const i=e.querySelector(".modal-body"),r=i?i.querySelector("#historyList"):null;if(!i||!r)return;let o=i.querySelector("#historyStats");o||(o=document.createElement("div"),o.id="historyStats",o.className="history-stats",i.insertBefore(o,i.firstChild));const s=await t.getHistoryStats(),c=formatBytes(s.byteSize),l=s.latestTimestamp?`${formatRelativeTime(s.latestTimestamp)} (${new Date(s.latestTimestamp).toLocaleString()})`:"\u2014",d=s.latestLabel||"\u2014",m=window.Utils.escapeHtml(c),h=window.Utils.escapeHtml(l),S=window.Utils.escapeHtml(d),I=typeof s.count=="number"?s.count:window.Utils.escapeHtml(String(s.count||"\u2014"));if(o.innerHTML=`
            <div class="history-meta">
                <span class="history-meta__label">Snapshots</span>
                <span>${I}</span>
            </div>
            <div class="history-meta">
                <span class="history-meta__label">Approx size</span>
                <span>${m}</span>
            </div>
            <div class="history-meta">
                <span class="history-meta__label">Last save</span>
                <span>${h}</span>
            </div>
            <div class="history-meta">
                <span class="history-meta__label">Latest label</span>
                <span>${S}</span>
            </div>
            <div class="history-actions-row">
                <button class="btn btn-secondary btn-sm" data-history-action="snapshot">Manual snapshot</button>
                <button class="btn btn-secondary btn-sm" data-history-action="export">Copy history JSON</button>
                <button class="btn btn-danger btn-sm" data-history-action="clear">Clear history</button>
            </div>
        `,o.dataset.bound||(o.dataset.bound="true",o.addEventListener("click",async g=>{const w=g.target instanceof HTMLElement?g.target.closest("[data-history-action]"):null;if(!w)return;g.preventDefault();const A=w.dataset.historyAction;if(A==="snapshot"){await t.recordHistorySnapshot("Manual snapshot",{label:"Manual snapshot",manual:!0,force:!0}),await t.refreshHistoryUI({force:!0});return}if(A==="export"){const N=await t.getHistoryEntries({newestFirst:!1}),D={exportedAt:new Date().toISOString(),count:s.count,entries:N.map(H=>({id:H.id,timestamp:H.timestamp,label:H.label,reason:H.meta?.reason,occurrences:H.meta?.occurrences||1,firstRecordedAt:H.meta?.firstRecordedAt,lastRecordedAt:H.meta?.lastRecordedAt,size:H.byteSize,content:H.content}))},V=await copyTextToClipboard(JSON.stringify(D,null,2));t.showNotification(V?"History copied to clipboard":"Failed to copy history",V?"success":"error");return}A==="clear"&&(typeof window.confirm!="function"||window.confirm("Clear history snapshots? The current document will remain as the first entry."))&&await t.clearHistory({keepLatest:!0,label:"Current document"})})),n.statsOnly){t.markHistoryRendered();return}const T=await t.getHistoryEntries({newestFirst:!0}),v=t.getCurrentHistoryEntryId();if(r.innerHTML="",!T.length){const g=document.createElement("div");g.className="history-empty",g.innerHTML="<p>No history yet</p><small>Changes are tracked automatically \u2013 edit the document or create a manual snapshot.</small>",r.appendChild(g),t.markHistoryRendered();return}T.forEach((g,w)=>{const A=document.createElement("article");A.className="history-item",A.dataset.entryId=g.id,g.id===v&&A.classList.add("current");const N=T[w+1]||null,D=document.createElement("div");D.className="history-header";const V=document.createElement("div");V.className="history-title",V.textContent=g.label||"Snapshot";const H=document.createElement("div");H.className="history-time",H.textContent=`${formatRelativeTime(g.timestamp)} \xB7 ${new Date(g.timestamp).toLocaleString()}`,D.appendChild(V),D.appendChild(H);const de=document.createElement("pre");de.className="history-preview is-clickable",de.textContent=summarizeHistoryChanges(g.content,N?N.content:null),de.title="View full snapshot",de.setAttribute("role","button"),de.tabIndex=0,de.addEventListener("click",ye=>{ye.stopPropagation(),openHistoryPreview(g,N)}),de.addEventListener("keydown",ye=>{(ye.key==="Enter"||ye.key===" ")&&(ye.preventDefault(),ye.stopPropagation(),openHistoryPreview(g,N))});const be=document.createElement("div");be.className="history-meta";const x=g.meta?.reason||"edit",j=document.createElement("span");j.textContent=`Reason: ${x}`,be.appendChild(j);const F=g.meta?.occurrences||1;if(F>1){const ye=document.createElement("span");ye.className="history-meta__occurrences";const we=g.meta?.lastRecordedAt?new Date(g.meta.lastRecordedAt).toLocaleString():new Date(g.timestamp).toLocaleString();ye.textContent=`Saved ${F}\xD7`,ye.title=`Captured ${F} times (last at ${we})`,be.appendChild(ye)}const U=document.createElement("span");U.textContent=g.sizeLabel,be.appendChild(U);const re=document.createElement("div");re.className="history-action-buttons";const J=document.createElement("button");J.type="button",J.className=g.id===v?"btn btn-secondary btn-sm":"btn btn-primary btn-sm",J.textContent=g.id===v?"Current version":"Restore",J.disabled=g.id===v,J.addEventListener("click",ye=>{ye.stopPropagation(),t.restoreHistoryEntry(g.id,{forceRestore:!1,requireConfirm:!0}).catch(we=>console.error("[HISTORY] Failed to restore entry",we))});const se=document.createElement("button");se.type="button",se.className="btn btn-secondary btn-sm",se.textContent="Copy JSON",se.addEventListener("click",async ye=>{ye.stopPropagation();const we=await copyTextToClipboard(g.content);t.showNotification(we?"Snapshot copied to clipboard":"Failed to copy snapshot",we?"success":"error")}),re.appendChild(J),re.appendChild(se),A.appendChild(D),A.appendChild(de),A.appendChild(be),A.appendChild(re),r.appendChild(A)}),t.markHistoryRendered()}catch(i){console.error("[HISTORY] Failed to render history modal",i)}}class MonacoInitializer{constructor(){this.isInitialized=!1,this.editors=new Map,this.performanceController=typeof PerformanceController<"u"?new PerformanceController:null,this.searchIndex=typeof IndexedSearch<"u"?new IndexedSearch:{updateIndex:()=>{},searchAll:()=>[],buildIndex:()=>{}},this.resultCache=typeof ResultCache<"u"?new ResultCache:{get:()=>null,set:()=>{}},this.workerPool=null,this.diffEditor=null,this.virtualRenderer=null,this.healthMonitoring={enabled:!1,interval:null,stats:{}},this.lastJSONPathResults=[],this.lastJSONPathPointerLocator=null,this.lastJSONPathMeta={totalCount:0,truncated:!1},this.currentJSONPathIndex=-1,this.lastJSONPathQuery="",this.jsonPathSearchRequestId=0,this.findWidgetIntegration=null,this.history=new EditorHistory(60),this.historyDebounce=null,this.suspendHistoryRecording=!1,this.historyNeedsRender=!0,this.monacoSources=this.resolveMonacoSources(),this.activeMonacoSource=null,this.pendingReadOnlyRestore=null,this.editorReadOnlyLocked=!1,this.pendingMappingLoadId=null}resolveMonacoSources(){const e=[{label:"jsDelivr",baseUrl:"https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs"},{label:"cdnjs",baseUrl:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs"},{label:"unpkg",baseUrl:"https://unpkg.com/monaco-editor@0.44.0/min/vs"}],t=typeof window<"u"&&Array.isArray(window.MONACO_CDN_SOURCES)&&window.MONACO_CDN_SOURCES.length?window.MONACO_CDN_SOURCES:e,i=c=>c?typeof c=="string"?{label:c,baseUrl:c}:c.baseUrl?{label:c.label||c.baseUrl,baseUrl:c.baseUrl}:c.url?{label:c.label||c.url,baseUrl:c.url}:null:null,r=t.map(i).filter(c=>c&&c.baseUrl),o=[],s=new Set;for(const c of r){const l=c.baseUrl.replace(/\/+$/,"");s.has(l)||(s.add(l),o.push({label:c.label||l,baseUrl:l}))}return o.length?o:e.map(c=>({label:c.label,baseUrl:c.baseUrl.replace(/\/+$/,"")}))}async initialize(){if(!this.isInitialized)try{await this.loadMonaco(),this.setupWireMockSchema(),this.setupOptimizations(),await this.createEditors(),this.setupEventHandlers(),this.isInitialized=!0,console.log("\u2705 Monaco Editor initialized with WireMock integration")}catch(e){throw console.error("\u274C Monaco Editor initialization failed:",e),e}}async loadMonaco(){if(typeof MonacoLoader<"u"&&MonacoLoader.load){console.log("\u{1F680} [Lazy Loading] Loading Monaco via MonacoLoader..."),await MonacoLoader.load(),console.log("\u2705 [Lazy Loading] Monaco loaded successfully");return}console.warn("\u26A0\uFE0F [Lazy Loading] MonacoLoader not available, using fallback"),await this.waitForMonacoLoader();const e=[];for(const r of this.monacoSources){this.configureMonacoLoader(r);try{await this.requireMonacoModule(),this.activeMonacoSource=r.baseUrl,console.log(`\u{1F3AF} Monaco loaded from ${r.label||r.baseUrl}`);return}catch(o){const s=this.normalizeMonacoLoadError(o,r);e.push({source:r,error:s}),console.warn(s.message),this.invalidateFailedMonacoLoad(r)}}const t=e.map(({error:r})=>r.message).join("; "),i=new Error(`Monaco Editor could not be loaded from any configured source. Attempts: ${t||"none"}`);throw i.attempts=e,i}async waitForMonacoLoader(e=1e4){const t=Date.now();for(;!this.isMonacoLoaderAvailable();){if(Date.now()-t>e)throw new Error("Monaco AMD loader did not become available");await MonacoInitializer.sleep(50)}}isMonacoLoaderAvailable(){const e=typeof require=="function"?require:typeof window<"u"?window.require:void 0;return typeof e=="function"&&typeof e.config=="function"}configureMonacoLoader(e){const t=e.baseUrl.replace(/\/+$/,""),i=typeof require=="function"?require:typeof window<"u"?window.require:void 0;i&&typeof i.config=="function"?i.config({paths:{vs:t}}):typeof window<"u"&&(window.require=window.require||{},window.require.paths=Object.assign({},window.require.paths||{},{vs:t})),typeof window<"u"&&(window.MONACO_BASE_URL=t)}requireMonacoModule(){const e=typeof require=="function"?require:typeof window<"u"?window.require:void 0;return new Promise((t,i)=>{try{if(typeof e!="function"){i(new Error("Monaco AMD loader is not available"));return}e(["vs/editor/editor.main"],t,r=>i(r))}catch(r){i(r)}})}normalizeMonacoLoadError(e,t){const i=t.label||t.baseUrl;if(!e)return new Error(`[${i}] Unknown error while loading Monaco Editor`);if(e instanceof Event){const o=e.target,s=o&&o.src?o.src:null,c=s?`[${i}] Network error while loading ${s}`:`[${i}] Network error while loading Monaco Editor`,l=new Error(c);return l.cause=e,l.script=s,l}if(typeof e=="string")return new Error(`[${i}] ${e}`);if(e&&e.message){const o=new Error(`[${i}] ${e.message}`);return o.cause=e,o}const r=new Error(`[${i}] ${String(e)}`);return r.cause=e,r}invalidateFailedMonacoLoad(e){const t=e.baseUrl.replace(/\/+$/,""),i=typeof require=="function"?require:typeof window<"u"?window.require:void 0;if(i&&typeof i.undef=="function")try{i.undef("vs/editor/editor.main")}catch(o){console&&typeof console.debug=="function"&&console.debug("Monaco loader undef failed",o)}const r=i&&i.s&&i.s.contexts&&i.s.contexts._;if(r){if(r.urlFetched)for(const o of Object.keys(r.urlFetched))o&&o.startsWith(t)&&delete r.urlFetched[o];if(r.defined)for(const o of Object.keys(r.defined))o&&o.startsWith("vs/")&&delete r.defined[o]}typeof document<"u"&&document.querySelectorAll("script[src]").forEach(s=>{const c=s.getAttribute("src");c&&c.startsWith(`${t}/`)&&/\/vs\//.test(c)&&!/loader\.js$/i.test(c)&&s.remove()})}static sleep(e){return new Promise(t=>setTimeout(t,e))}setupWireMockSchema(){const e={type:"object",properties:{id:{type:"string",description:"Unique identifier for the mapping"},name:{type:"string",description:"Human-readable name for the mapping"},request:{type:"object",description:"Request matching criteria",properties:{method:{enum:["GET","POST","PUT","DELETE","PATCH","HEAD","OPTIONS","ANY"],description:"HTTP method to match"},url:{type:"string",description:"Exact URL to match"},urlPath:{type:"string",description:"URL path to match"},urlPathPattern:{type:"string",description:"URL path pattern (regex)"},urlPattern:{type:"string",description:"Full URL pattern (regex)"},queryParameters:{type:"object",description:"Query parameter matching"},headers:{type:"object",description:"HTTP headers matching"},bodyPatterns:{type:"array",description:"Request body matching patterns",items:{type:"object"}}}},response:{type:"object",description:"Response configuration",properties:{status:{type:"number",minimum:100,maximum:599,description:"HTTP status code"},body:{type:"string",description:"Response body as string"},jsonBody:{type:["object","array"],description:"Response body as JSON"},headers:{type:"object",description:"Response headers"},fixedDelayMilliseconds:{type:"number",description:"Fixed delay in milliseconds"}}},priority:{type:"number",description:"Mapping priority"},scenarioName:{type:"string",description:"Scenario this mapping belongs to"},metadata:{type:"object",description:"Custom metadata"}},required:["request","response"]};monaco.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!0,schemas:[{uri:"http://wiremock.org/schemas/mapping.json",fileMatch:["*"],schema:e}]})}setupOptimizations(){try{typeof WorkerPool<"u"?(this.workerPool=new WorkerPool("json-worker.js",2),this.startHealthMonitoring(),console.log("\u26A1 Real WorkerPool initialized with health monitoring")):(this.workerPool={execute:async(e,t,i)=>{switch(e){case"format":const r=JSON.parse(t.text);return JSON.stringify(r,null,2);case"minify":const o=JSON.parse(t.text);return JSON.stringify(o);case"validate":try{return JSON.parse(t.text),{valid:!0}}catch(d){return{valid:!1,error:d.message}}case"sort_keys":const s=t&&typeof t.indent=="number"&&t.indent>=0?t.indent:2,c=JSON.parse(t.text),l=this.sortKeysDeep(c);return JSON.stringify(l,null,s);default:return t}},terminate:()=>{},getStats:()=>({workers:0,busy:0,queued:0,pending:0})},console.log("\u26A1 Fallback WorkerPool initialized")),typeof VirtualizedJSONRenderer<"u"&&(this.virtualRenderer=null,console.log("\u{1F4C4} VirtualizedJSONRenderer available"))}catch(e){console.warn("Performance optimizations initialization failed:",e)}}async createEditors(){const e=document.body.dataset.theme==="dark"?"vs-dark":"vs",r=new URLSearchParams(window.location.search).get("mappingId")?"":this.getDefaultStub(),o=document.getElementById("jsonEditor");o&&(window.editor=this.createEditor(o,{language:"json",theme:e,value:r,automaticLayout:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,wordWrap:"on",formatOnPaste:!0,formatOnType:!0,folding:!0,foldingMaximumRegions:1e5}),this.editors.set("main",window.editor),await this.initializeHistory(r))}prepareEditorForMappingLoad(e){const t=this.getActiveEditor();if(!t)return;let i=!1;try{if(typeof monaco<"u"&&monaco.editor&&monaco.editor.EditorOption)i=!!t.getOption(monaco.editor.EditorOption.readOnly);else if(typeof t.getRawOptions=="function"){const r=t.getRawOptions();i=!!(r&&r.readOnly)}}catch(r){console.debug("[EDITOR] Unable to detect current readOnly state",r)}if(this.pendingReadOnlyRestore=i,i)this.editorReadOnlyLocked=!1;else try{t.updateOptions({readOnly:!0}),this.editorReadOnlyLocked=!0}catch(r){console.debug("[EDITOR] Failed to toggle readOnly before load",r),this.editorReadOnlyLocked=!1}this.suspendHistoryRecording=!0;try{t&&typeof t.setSelection=="function"&&t.setSelection(new monaco.Range(1,1,t.getModel().getLineCount(),1)),t&&typeof t.trigger=="function"&&t.trigger("source","editor.action.selectAll"),t&&typeof t.executeCommand=="function"&&t.executeCommand("editor.action.deleteAll"),t.setValue("")}finally{this.suspendHistoryRecording=!1}this.historyDebounce&&(clearTimeout(this.historyDebounce),this.historyDebounce=null),e&&(this.pendingMappingLoadId=e)}finalizeEditorMappingLoad(){const e=this.getActiveEditor();if(e){if(this.editorReadOnlyLocked)try{e.updateOptions({readOnly:!1})}catch(t){console.debug("[EDITOR] Failed to restore readOnly after load",t)}else if(typeof this.pendingReadOnlyRestore=="boolean")try{e.updateOptions({readOnly:this.pendingReadOnlyRestore})}catch(t){console.debug("[EDITOR] Failed to reset readOnly flag",t)}}this.editorReadOnlyLocked=!1,this.pendingReadOnlyRestore=null,this.pendingMappingLoadId=null}createEditor(e,t){const i=monaco.editor.create(e,t);if(this.setupFindWidgetIntegration(i),typeof VirtualizedJSONRenderer<"u"){const r=new VirtualizedJSONRenderer(i);i.virtualRenderer=r,t.value&&r.setContent(t.value)}return i.onDidChangeModelContent(()=>{this.changeTimeout&&clearTimeout(this.changeTimeout),this.changeTimeout=setTimeout(()=>{this.onContentChange(i)},500)}),i}async initializeHistory(e=""){const t=typeof e=="string"?e:"";this.history||(this.history=new EditorHistory(60)),await this.history.reset(t,{label:"Initial document",reason:"Initial snapshot"}),this.historyNeedsRender=!0,await this.refreshHistoryUI({statsOnly:!0})}markHistoryRendered(){this.historyNeedsRender=!1}getHistoryEntries(e={}){return this.history?this.history.getEntries(e):Promise.resolve([])}getHistoryStats(){return this.history?this.history.getStats():Promise.resolve({count:0,byteSize:0,latestTimestamp:null})}getCurrentHistoryEntryId(){return this.history?this.history.getCurrentId():null}async recordHistorySnapshot(e="Edit",t={}){if(!this.history)return null;const i=t.editor||this.getActiveEditor();if(!i)return null;let r;if(typeof t.contentOverride=="string"?r=t.contentOverride:i.virtualRenderer&&typeof i.virtualRenderer.getFullContent=="function"?r=i.virtualRenderer.getFullContent():typeof i.getValue=="function"?r=i.getValue():r="",!(t.allowInvalid??!!t.manual))try{JSON.parse(r)}catch(l){return t.silent||console.debug("[HISTORY] Skipped snapshot \u2013 invalid JSON",l),{recorded:!1,skipped:!0,reason:"invalid-json"}}const s={reason:e,label:t.label,manual:!!t.manual,action:e,force:!!t.force},c=await this.history.record(r,s);return c&&c.recorded&&(this.historyNeedsRender=!0,await this.refreshHistoryUI({statsOnly:t.statsOnly===!0})),c}async refreshHistoryUI(e={}){if(typeof window.renderHistoryModal!="function")return;const t=document.getElementById("historyModal"),i=t&&(t.classList.contains("show")||t.getAttribute("aria-hidden")==="false");if(e.force||i){await window.renderHistoryModal({statsOnly:!!e.statsOnly}),this.historyNeedsRender=!1;return}e.statsOnly&&document.getElementById("historyStats")&&(await window.renderHistoryModal({statsOnly:!0}),this.historyNeedsRender=!1)}shouldRenderHistory(){return this.historyNeedsRender}async restoreHistoryEntry(e,t={}){if(!this.history)return this.showNotification("History is unavailable","warning"),!1;const i=await this.history.getEntryById(e);if(!i)return this.showNotification("History entry not found","warning"),!1;const r=this.getActiveEditor();if(!r)return this.showNotification("No active editor to restore into","warning"),!1;if((r.getValue?r.getValue():"")===i.content&&!t.forceRestore)return this.history.markCurrent(i.id),await this.refreshHistoryUI({force:!0}),this.showNotification("Already on this version","info"),!0;if(!t.forceRestore&&t.requireConfirm!==!1){const s=i.label||"snapshot",c=`Restore snapshot "${s.length>80?`${s.slice(0,77)}\u2026`:s}"? Current editor content will be replaced.`;if(!(typeof window.confirm=="function"?window.confirm(c):!0))return!1}if(this.suspendHistoryRecording=!0,r.setValue(i.content),this.suspendHistoryRecording=!1,this.history.markCurrent(i.id),this.historyNeedsRender=!0,await this.refreshHistoryUI({force:!0}),this.showNotification(`Restored snapshot: ${i.label}`,"success"),typeof document<"u"){const s=Array.from(document.querySelectorAll('.modal.show, .modal[aria-hidden="false"]'));if(s.length)for(const c of s)!(typeof HTMLElement>"u"||c instanceof HTMLElement)||!c||!c.id||(typeof window.closeModal=="function"?window.closeModal(c.id):(c.classList.remove("show"),c.classList.add("hidden"),c.style.display="none",c.setAttribute("aria-hidden","true")))}return!0}async clearHistory(e={}){if(!this.history)return;const t=this.getActiveEditor(),i=t&&typeof t.getValue=="function"?t.getValue():"";await this.history.clear({keepLatest:e.keepLatest!==!1,latestContent:i,label:e.label||"Current document"}),this.historyNeedsRender=!0,await this.refreshHistoryUI({force:!0})}getTemplateLibrary(){return getTemplateLibrarySnapshot()}applyTemplateById(e,t={}){const i=this.getTemplateLibrary().find(r=>r.id===e);return i?this.applyTemplate(i,t):(this.showNotification("Template not found","error"),!1)}applyTemplate(e,t={}){const i=this.getActiveEditor();if(!i)return this.showNotification("No active editor to apply template","warning"),!1;const r=e&&e.content?e.content:{};let o=typeof r=="string"?r:JSON.stringify(r,null,2);typeof t.transform=="function"&&(o=t.transform(o,e)||o);const s=i.getValue?i.getValue():"",c=t.replace!==!1;let l=o;return!c&&s&&(l=`${s.trimEnd()}

${o}`),c&&s&&!t.silent&&t.confirm!==!1&&!(typeof window.confirm=="function"?window.confirm(`Replace current document with "${e.title}" template?`):!0)?!1:(this.suspendHistoryRecording=!0,i.setValue(l),this.suspendHistoryRecording=!1,this.recordHistorySnapshot("Template applied",{label:e.title,manual:!0,force:!0,statsOnly:!1}).catch(d=>{console.debug("[HISTORY] Failed to record template snapshot",d)}),this.showNotification(`Template "${e.title}" applied`,"success"),!0)}setupEventHandlers(){this.setupKeyboardShortcuts(),this.setupThemeHandler()}setupKeyboardShortcuts(){if(!window.editor)return;[{key:monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyN,action:()=>this.newDocument()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyO,action:()=>this.loadFile()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyS,action:()=>this.saveFile()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.KeyF,action:()=>this.formatJSON()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyM,action:()=>this.minifyJSON()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyT,action:()=>this.validateJSON()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.BracketLeft,action:()=>this.collapseAllFolds({focus:!0})},{key:monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.BracketRight,action:()=>this.expandAllFolds({focus:!0})},{key:monaco.KeyMod.CtrlCmd|monaco.KeyMod.Alt|monaco.KeyCode.KeyS,action:()=>this.sortJSONKeys()},{key:monaco.KeyMod.Alt|monaco.KeyCode.KeyN,action:()=>this.navigateJSONPathMatches(1)},{key:monaco.KeyMod.Alt|monaco.KeyCode.KeyP,action:()=>this.navigateJSONPathMatches(-1)},{key:monaco.KeyMod.Alt|monaco.KeyCode.KeyJ,action:()=>this.toggleFindWidgetJSONPathMode()}].forEach(({key:t,action:i})=>{window.editor.addCommand(t,i)})}setupThemeHandler(){new MutationObserver(t=>{t.forEach(i=>{if(i.type==="attributes"&&i.attributeName==="data-theme"){const r=document.body.dataset.theme==="dark"?"vs-dark":"vs";monaco.editor.setTheme(r),this.diffEditor&&this.diffEditor.updateOptions({theme:r})}})}).observe(document.body,{attributes:!0,attributeFilter:["data-theme"]})}onContentChange(e){const t=e.virtualRenderer?e.virtualRenderer.getFullContent():e.getValue();this.searchIndex&&typeof this.searchIndex.buildIndex=="function"?this.searchIndex.buildIndex(t):this.searchIndex&&typeof this.searchIndex.updateIndex=="function"&&this.searchIndex.updateIndex(t),e.virtualRenderer&&t.split(`
`).length>5e3&&e.virtualRenderer.setContent(t),!this.suspendHistoryRecording&&(this.historyNeedsRender=!0,this.historyDebounce&&clearTimeout(this.historyDebounce),this.historyDebounce=setTimeout(()=>{this.recordHistorySnapshot("Auto snapshot",{statsOnly:!0,allowInvalid:!1}).catch(i=>{console.debug("[HISTORY] Failed to record auto snapshot",i)})},1500))}getDefaultStub(){const e=()=>JSON.stringify({name:"Example WireMock Mapping",request:{method:"GET",urlPath:"/api/example"},response:{status:200,jsonBody:{message:"Hello from WireMock!",timestamp:"2024-01-01T00:00:00Z"},headers:{"Content-Type":"application/json"}}},null,2);try{if(window.TemplateManager?.getEmptyMappingContent){const t=window.TemplateManager.getEmptyMappingContent();return JSON.stringify(t,null,2)}}catch(t){console.warn("Unable to get empty mapping content from TemplateManager, falling back to default stub",t)}return e()}async formatJSON(){const e=this.getActiveEditor(),t=e.getValue();e&&typeof e.setValue=="function"&&e.setValue("");try{if(this.workerPool){const i=await this.workerPool.execute("format",{text:t},1);e.setValue(i)}else{const i=JSON.parse(t),r=JSON.stringify(i,null,2);e.setValue(r)}this.showNotification("JSON formatted","success")}catch(i){this.showNotification("Format error: "+i.message,"error")}}async minifyJSON(){const e=this.getActiveEditor(),t=e.getValue();try{if(this.workerPool){const i=await this.workerPool.execute("minify",{text:t},1);e.setValue(i)}else{const i=JSON.parse(t),r=JSON.stringify(i);e.setValue(r)}this.showNotification("JSON minified","success")}catch(i){this.showNotification("Minify error: "+i.message,"error")}}async validateJSON(){const t=this.getActiveEditor().getValue();try{if(this.workerPool){const i=await this.workerPool.execute("validate",{text:t},1);i.valid?this.showNotification("JSON is valid","success"):this.showNotification(`JSON invalid: ${i.error}`,"error")}else JSON.parse(t),this.showNotification("JSON is valid","success")}catch(i){this.showNotification("JSON invalid: "+i.message,"error")}}getActiveEditor(){return window.editor||this.editors.get("main")}resolveTargetEditors(e={}){if(e&&e.editor)return e.editor?[e.editor]:[];if(e&&Array.isArray(e.editors)&&e.editors.length)return e.editors.filter(Boolean);const t=new Set,i=document.getElementById("editorContainer");if(!i||i.style.display!=="none"){const o=this.editors.get("main");o&&t.add(o)}const r=document.getElementById("compareContainer");if(r&&r.style.display!=="none")if(this.diffEditor){const o=typeof this.diffEditor.getOriginalEditor=="function"?this.diffEditor.getOriginalEditor():null,s=typeof this.diffEditor.getModifiedEditor=="function"?this.diffEditor.getModifiedEditor():null;o&&t.add(o),s&&t.add(s)}else{const o=this.editors.get("compareEditorLeft"),s=this.editors.get("compareEditorRight");o&&t.add(o),s&&t.add(s)}if(!t.size){const o=this.getActiveEditor();o&&t.add(o)}return Array.from(t).filter(Boolean)}runEditorCommand(e,t,i=null){if(!e)return!1;try{if(typeof e.getAction=="function"){const r=e.getAction(t);if(r&&typeof r.run=="function"&&(!r.isSupported||r.isSupported())){const o=r.run();return o&&typeof o.then=="function"&&o.catch(s=>console.warn(`Command ${t} failed:`,s)),!0}}if(typeof e.trigger=="function")return e.trigger("json-tools",t,i),!0}catch(r){console.warn(`Command ${t} failed:`,r)}return!1}executeCommandOnEditors(e,t={}){const i=this.resolveTargetEditors(t);let r=0;return i.forEach(o=>{this.runEditorCommand(o,e,t.payload)&&r++}),t.focus&&i[0]&&typeof i[0].focus=="function"&&i[0].focus(),{executed:r,editors:i}}collapseAllFolds(e={}){const{executed:t}=this.executeCommandOnEditors("editor.foldAll",e);if(t>0){const i=t>1?"Collapsed JSON structures in all visible editors":"Collapsed JSON structures";this.showNotification(i,"success")}else this.showNotification("Unable to collapse JSON structures","warning")}expandAllFolds(e={}){const{executed:t}=this.executeCommandOnEditors("editor.unfoldAll",e);if(t>0){const i=t>1?"Expanded JSON structures in all visible editors":"Expanded JSON structures";this.showNotification(i,"success")}else this.showNotification("Unable to expand JSON structures","warning")}async sortJSONKeys(e={}){const t=this.getActiveEditor();if(!t){this.showNotification("No active editor","warning");return}const i=t.getValue(),r=t.getModel&&t.getModel(),o=e&&typeof e.indent=="number"&&e.indent>=0?e.indent:r&&typeof r.getOptions=="function"?r.getOptions().tabSize:2,s=Number.isFinite(o)?o:2;try{let c;if(this.workerPool&&typeof this.workerPool.execute=="function")c=await this.workerPool.execute("sort_keys",{text:i,indent:s},1);else{const l=JSON.parse(i),d=this.sortKeysDeep(l);c=JSON.stringify(d,null,s)}typeof c!="string"&&(c=JSON.stringify(c)),c!==i&&t.setValue(c),this.showNotification("JSON keys sorted alphabetically","success")}catch(c){console.error("Sort keys error:",c),this.showNotification("Sort keys error: "+c.message,"error")}}sortKeysDeep(e){if(Array.isArray(e))return e.map(t=>this.sortKeysDeep(t));if(e&&typeof e=="object"){const t=Object.keys(e).sort((r,o)=>r.localeCompare(o)),i={};return t.forEach(r=>{i[r]=this.sortKeysDeep(e[r])}),i}return e}showNotification(e,t){typeof showNotification<"u"?showNotification(e,t):console.log(`[${t.toUpperCase()}] ${e}`)}loadMappingIntoEditor(e,t={}){const i=this.getActiveEditor();if(i&&e){const r=typeof t=="boolean"?{notify:t}:t&&typeof t=="object"?t:{},o=JSON.stringify(e,null,2);i.setValue(o),this.finalizeEditorMappingLoad();const s=e&&(e.mapping||e),c=s&&(s.id||s.uuid);if(typeof window<"u"&&typeof window.rememberEditorMappingId=="function"&&window.rememberEditorMappingId(c),r.notify){const l=s&&(s.name||c),m=(typeof r.message=="string"?r.message.trim():"")||(l?`Mapping "${l}" loaded`:"Mapping loaded");this.showNotification(m,"success")}}}getMappingFromEditor(){const e=this.getActiveEditor();if(!e)return null;try{const t=e.getValue(),i=JSON.parse(t);if(typeof window<"u"&&typeof window.rememberEditorMappingId=="function"){const r=i&&(i.id||i.uuid);window.rememberEditorMappingId(r)}return i}catch{return this.showNotification("Invalid JSON in editor","error"),null}}search(e){const t=this.getActiveEditor();if(!t){this.showNotification("No active editor","warning");return}try{t.trigger("search","actions.find",{searchString:e,replaceString:"",isRegex:!1,matchCase:!1,matchWholeWord:!1,preserveCase:!1}),this.showNotification(`Searching for "${e}"`,"success")}catch(i){console.error("Search error:",i),this.showNotification("Search error: "+i.message,"error")}}loadCompareContent(e,t){try{if(this.diffEditor||this.initializeDiffEditor(),this.diffEditor){const i=JSON.parse(t),r=JSON.stringify(i,null,2),o=this.diffEditor.getModel();let s,c;o?(s=o.original,c=o.modified):(s=monaco.editor.createModel("","json"),c=monaco.editor.createModel("","json")),e==="left"||e==="original"?s.setValue(r):c.setValue(r),this.diffEditor.setModel({original:s,modified:c}),this.showNotification(`Content loaded to ${e} panel with diff highlighting`,"success")}else this.loadCompareContentFallback(e,t)}catch(i){console.error("Error loading compare content:",i),this.showNotification(`Error loading ${e} content: `+i.message,"error")}}initializeDiffEditor(){const e=document.getElementById("compareContainer");if(!e){console.warn("Compare container not found, cannot initialize diff editor");return}try{const t=document.body.dataset.theme==="dark"?"vs-dark":"vs";this.diffEditor=monaco.editor.createDiffEditor(e,{theme:t,readOnly:!1,automaticLayout:!0,renderSideBySide:!0,ignoreTrimWhitespace:!1,renderWhitespace:"boundary",diffWordWrap:"on",originalEditable:!0,scrollBeyondLastLine:!1,minimap:{enabled:!1},enableSplitViewResizing:!0,renderOverviewRuler:!0,diffCodeLens:!0,folding:!0,foldingMaximumRegions:1e5,scrollbar:{verticalScrollbarSize:8,horizontalScrollbarSize:8,useShadows:!1}});const i=monaco.editor.createModel("","json"),r=monaco.editor.createModel("","json");this.diffEditor.setModel({original:i,modified:r}),this.setupDiffEditorEnhancements(),this.editors.set("diffEditor",this.diffEditor),console.log("\u2705 Enhanced Monaco DiffEditor initialized with lock-step scrolling")}catch(t){console.error("Failed to initialize diff editor:",t)}}setupDiffEditorEnhancements(){if(!this.diffEditor)return;const e=this.diffEditor.getOriginalEditor(),t=this.diffEditor.getModifiedEditor();[{key:monaco.KeyMod.Alt|monaco.KeyCode.KeyN,action:()=>this.diffEditor.goToNextDiff()},{key:monaco.KeyMod.Alt|monaco.KeyCode.KeyP,action:()=>this.diffEditor.goToPrevDiff()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyMod.Alt|monaco.KeyCode.KeyR,action:()=>this.resetDiffView()}].forEach(({key:r,action:o})=>{e.addCommand(r,o),t.addCommand(r,o)}),e.addAction({id:"diff-copy-to-modified",label:"Copy to Right Side",keybindings:[monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.RightArrow],run:()=>{const r=e.getValue();t.setValue(r),this.showNotification("Content copied to right side","success")}}),t.addAction({id:"diff-copy-to-original",label:"Copy to Left Side",keybindings:[monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.LeftArrow],run:()=>{const r=t.getValue();e.setValue(r),this.showNotification("Content copied to left side","success")}}),e.onDidChangeModelContent(()=>{this.onDiffContentChange("original")}),t.onDidChangeModelContent(()=>{this.onDiffContentChange("modified")})}onDiffContentChange(e){this.diffAnalysisTimeout&&clearTimeout(this.diffAnalysisTimeout),this.diffAnalysisTimeout=setTimeout(()=>{this.analyzeDiffChanges(e)},1e3)}analyzeDiffChanges(e){if(!this.diffEditor)return;const t=this.diffEditor.getModel();if(!t)return;const i=t.original.getValue(),r=t.modified.getValue();if(i&&r){const o=this.diffEditor.getDiffComputationResult();if(o&&o.changes){const s=o.changes.length;this.showNotification(`${s} difference${s!==1?"s":""} detected`,"info")}}}resetDiffView(){if(!this.diffEditor)return;const e=this.diffEditor.getModel();e&&(e.original.setValue(""),e.modified.setValue(""),this.showNotification("Diff view reset","success"))}loadCompareContentFallback(e,t){const i=e==="left"?"compareEditorLeft":"compareEditorRight";let r=this.editors.get(i);if(!r){const o=document.getElementById(i);if(o){const s=document.body.dataset.theme==="dark"?"vs-dark":"vs";r=this.createEditor(o,{language:"json",theme:s,readOnly:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,wordWrap:"on"}),this.editors.set(i,r)}}if(r){const o=JSON.parse(t),s=JSON.stringify(o,null,2);r.setValue(s),this.showNotification(`Content loaded to ${e} panel`,"success")}else throw new Error(`Cannot find container for ${e} compare editor`)}clearCompareContent(e){try{if(this.diffEditor){const t=this.diffEditor.getModel();t&&(e==="left"||e==="original"?t.original.setValue(""):e==="right"||e==="modified"?t.modified.setValue(""):e==="both"&&(t.original.setValue(""),t.modified.setValue(""))),this.showNotification(`${e.charAt(0).toUpperCase()+e.slice(1)} diff panel cleared`,"success")}else{const t=e==="left"?"compareEditorLeft":"compareEditorRight",i=this.editors.get(t);i?(i.setValue(""),this.showNotification(`${e.charAt(0).toUpperCase()+e.slice(1)} panel cleared`,"success")):this.showNotification(`${e} compare editor not found`,"warning")}}catch(t){console.error(`Error clearing ${e} panel:`,t),this.showNotification(`Error clearing ${e} panel: `+t.message,"error")}}evaluateJSONPath(e,t,i,r){const o=[],s=this.createPointerLocator(i),c="$",l=typeof t=="string"?t.trim():"";if(!l||l==="$"){const h=this.findValuePosition(e,i,r,"$",s,c);return o.push({value:e,path:"$",pointer:c,position:h}),o}const d=l.replace(/^\$\.?/,""),m=d?d.split(".").filter(Boolean):[];return this.traverseJSONPath(e,m,i,r,"$",o,s,c),o}traverseJSONPath(e,t,i,r,o,s,c,l){if(t.length===0){const h=this.findValuePosition(e,i,r,o,c,l);s.push({value:e,path:o,pointer:l,position:h});return}const[d,...m]=t;if(d.includes("[")&&d.includes("]")){const[h,S]=d.split("["),I=S.replace("]","");let T=e,v=l;if(h){if(!e||typeof e!="object"||!Object.prototype.hasOwnProperty.call(e,h))return;T=e[h],v=appendPointerSegment(v,h)}if(Array.isArray(T))if(I==="*")T.forEach((g,w)=>{const A=o+(h?`.${h}`:"")+`[${w}]`,N=appendPointerSegment(v,w);this.traverseJSONPath(g,m,i,r,A,s,c,N)});else{const g=parseInt(I,10);if(!Number.isNaN(g)&&g>=0&&g<T.length){const w=o+(h?`.${h}`:"")+`[${g}]`,A=appendPointerSegment(v,g);this.traverseJSONPath(T[g],m,i,r,w,s,c,A)}}}else if(d==="*")e&&typeof e=="object"&&!Array.isArray(e)&&Object.keys(e).forEach(h=>{const S=o+`.${h}`,I=appendPointerSegment(l,h);this.traverseJSONPath(e[h],m,i,r,S,s,c,I)});else if(e&&typeof e=="object"&&Object.prototype.hasOwnProperty.call(e,d)){const h=o+`.${d}`,S=appendPointerSegment(l,d);this.traverseJSONPath(e[d],m,i,r,h,s,c,S)}}findValuePosition(e,t,i,r,o=null,s=null){try{let c=o||null,l=s;if(typeof l=="string"&&l.startsWith("$.")){const h=this.convertJSONPathToPointer(l);h&&(l=h)}if(!l&&typeof r=="string"&&r.length>0&&(l=this.convertJSONPathToPointer(r)),l&&(c||(c=this.createPointerLocator(t)),c)){const h=c.getRange(l);if(h)return h}const d=i&&typeof i.getModel=="function"?i.getModel():null;if(!d)return null;let m;if(typeof e=="string"?m=`"${e}"`:m=JSON.stringify(e),m){const h=d.findMatches(m,!1,!1,!0,null,!1);if(h.length>0){const{range:S}=h[0];return{startLineNumber:S.startLineNumber,startColumn:S.startColumn,endLineNumber:S.endLineNumber,endColumn:S.endColumn}}}if(e&&typeof e=="object"){const h=JSON.stringify(e,null,2);if(h&&h!==m){const S=d.findMatches(h,!1,!1,!0,null,!1);if(S.length>0){const{range:I}=S[0];return{startLineNumber:I.startLineNumber,startColumn:I.startColumn,endLineNumber:I.endLineNumber,endColumn:I.endColumn}}}}}catch(c){console.warn("Could not find position for value:",c)}return null}formatValuePreview(e){if(e===null)return"null";if(e===void 0)return"undefined";let t=JSON.stringify(e);return t.length>100&&(t=t.slice(0,97)+"..."),t}newDocument(){try{const e=this.getActiveEditor();e&&(e.setValue(this.getDefaultStub()),this.showNotification("New document created","success"))}catch(e){this.showNotification("Error creating new document: "+e.message,"error")}}loadFile(){try{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=t=>{const i=t.target.files[0];if(i){const r=new FileReader;r.onload=o=>{try{const s=o.target.result,c=this.getActiveEditor();c&&(c.setValue(s),this.showNotification("File loaded successfully","success"))}catch(s){this.showNotification("Error loading file: "+s.message,"error")}},r.readAsText(i)}},e.click()}catch(e){this.showNotification("Error opening file dialog: "+e.message,"error")}}saveFile(){try{const e=this.getActiveEditor();if(e){const t=e.getValue(),i=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(i),o=document.createElement("a");o.href=r,o.download="wiremock-mapping.json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r),this.showNotification("File saved successfully","success")}}catch(e){this.showNotification("Error saving file: "+e.message,"error")}}exportAsYAML(){const e=this.getActiveEditor();if(!e){this.showNotification("No active editor","warning");return}let t;try{t=JSON.parse(e.getValue())}catch(i){this.showNotification("Cannot export YAML: "+i.message,"error");return}try{const i=convertJSONToYAML(t),r=i.endsWith(`
`)?i:`${i}
`,o=new Blob([r],{type:"text/yaml"}),s=URL.createObjectURL(o),c=document.createElement("a");c.href=s,c.download="wiremock-mapping.yaml",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(s),this.showNotification("YAML exported","success")}catch(i){this.showNotification("YAML export failed: "+i.message,"error")}}async searchJSONPath(e,t={}){if(!this.getActiveEditor())return t.notify!==!1&&this.showNotification("No active editor","warning"),[];const o=(typeof e=="string"?e:"").trim(),s=o.length>0,c=t.allowEmpty===!0;if(!s&&!c)return t.notify!==!1&&this.showNotification("Please enter a search term","warning"),[];const l=typeof t.jsonPathMode=="boolean"?t.jsonPathMode:null,d=s&&this.isJSONPathQuery(o),m=l!==null?l:d;return await this.openFindWidget({query:s?o:void 0,jsonPathMode:m,focus:t.focus!==!1,select:typeof t.select=="boolean"?t.select:!1,notify:t.notify===!0})?s?m?Array.isArray(this.lastJSONPathResults)?this.lastJSONPathResults:[]:[]:[]:(t.notify!==!1&&this.showNotification("Find widget is not available","error"),[])}async searchWithJSONPath(e,t,i={}){const{notify:r=!0,revealFirst:o=!0,fromWidget:s=!1}=i||{},c=++this.jsonPathSearchRequestId,l=t.getValue();if(!l||!l.trim())return this.resetJSONPathResults({keepQuery:!0}),this.lastJSONPathQuery=e,s&&this.updateFindWidgetMatchesCount(0,!1,-1,{noContent:!0}),r&&this.showNotification("No content to search","warning"),[];let d=null;if(this.canUseWorkerForJSONPath())try{d=await this.workerPool.execute("jsonpath",{text:l,path:e},5,1e4)}catch(m){console.warn("JSONPath worker execution failed, falling back to local parser:",m)}if(d&&typeof d=="object"&&Array.isArray(d.values)){const{matches:m,pointerLocator:h}=this.convertWorkerResultToMatches(d,e,l,t),S=typeof d.count=="number"?d.count:m.length,I=!!d.truncated;return c!==this.jsonPathSearchRequestId?m:(this.lastJSONPathPointerLocator=h,this.handleJSONPathMatches(e,m,t,S,I,{notify:r,revealFirst:o,fromWidget:s}))}try{const m=JSON.parse(l),h=this.evaluateJSONPath(m,e,l,t)||[];return c!==this.jsonPathSearchRequestId?h:(this.lastJSONPathPointerLocator=null,this.handleJSONPathMatches(e,h,t,h.length,!1,{notify:r,revealFirst:o,fromWidget:s}))}catch(m){return this.resetJSONPathResults({keepQuery:!0}),this.lastJSONPathPointerLocator=null,this.lastJSONPathQuery=e,s&&this.updateFindWidgetMatchesCount(0,!1,-1,{error:m.message}),r&&this.showNotification("Invalid JSON or JSONPath: "+m.message,"error"),[]}}isJSONPathQuery(e){return e?e.trim().startsWith("$"):!1}canUseWorkerForJSONPath(){return!this.workerPool||typeof this.workerPool.execute!="function"?!1:Array.isArray(this.workerPool.workers)?this.workerPool.workers.length>0:!1}convertWorkerResultToMatches(e,t,i,r){const o=Array.isArray(e.values)?e.values:[],s=this.extractJSONPathStrings(e,t,o.length),c=this.extractPointerPaths(e,o.length),d=c.some(h=>typeof h=="string"&&h.length>0)?this.createPointerLocator(i):null;return{matches:o.map((h,S)=>{const I=s[S]||t,T=c[S]||null;let v=null;if(T&&d){const g=d.getRange(T);g&&(v=g)}return v||(v=this.findValuePosition(h,i,r,I,d,T)),{value:h,path:I,pointer:T,position:v}}),pointerLocator:d,pointerPaths:c}}extractJSONPathStrings(e,t,i=0){return e?Array.isArray(e.jsonPaths)&&e.jsonPaths.length>0?e.jsonPaths:Array.isArray(e.paths)&&e.paths.length>0?e.paths.map(r=>Array.isArray(r)?convertPathArrayToJSONPath(r):String(r)):i>0?new Array(i).fill(t):[]:[]}extractPointerPaths(e,t=0){return e?Array.isArray(e.pointerPaths)&&e.pointerPaths.length>0?e.pointerPaths:Array.isArray(e.paths)&&e.paths.length>0?e.paths.map(i=>Array.isArray(i)?convertPathArrayToPointer(i):null):t>0?new Array(t).fill(null):[]:[]}createPointerLocator(e){return buildJSONPointerLocator(e)}convertJSONPathToPointer(e){if(typeof e!="string")return null;const t=e.trim();if(!t)return null;if(t==="$")return"$";if(!t.startsWith("$"))return null;let i="$",r=1;for(;r<t.length;){const o=t[r];if(o==="."){if(r++,r>=t.length)break;if(t[r]===".")return null;if(t[r]==="[")continue;let s=r;for(;r<t.length&&t[r]!=="."&&t[r]!=="[";)r++;const c=t.slice(s,r);c&&(i=appendPointerSegment(i,c));continue}if(o==="["){if(r++,r>=t.length)break;if(t[r]==="'"||t[r]==='"'){const s=t[r];r++;let c="";for(;r<t.length;){const l=t[r];if(l==="\\"&&r+1<t.length){c+=t[r+1],r+=2;continue}if(l===s)break;c+=l,r++}if(r<t.length&&t[r]===s&&r++,r<t.length&&t[r]==="]"&&r++,!c)return null;i=appendPointerSegment(i,c)}else{let s=r;for(;r<t.length&&t[r]!=="]";)r++;const c=t.slice(s,r);if(r<t.length&&t[r]==="]"&&r++,!c||c==="*")return null;const l=Number(c);Number.isNaN(l)?i=appendPointerSegment(i,c):i=appendPointerSegment(i,l)}continue}r++}return i}handleJSONPathMatches(e,t,i,r,o,s={}){const{notify:c=!0,revealFirst:l=!0,fromWidget:d=!1}=s||{};if(!Array.isArray(t)||t.length===0)return this.resetJSONPathResults({keepQuery:!0}),this.lastJSONPathQuery=e,this.lastJSONPathMeta={totalCount:0,truncated:!1},d&&this.updateFindWidgetMatchesCount(0,o,-1,{query:e}),c&&this.showNotification(`JSONPath "${e}" not found`,"info"),[];if(this.lastJSONPathResults=t,this.lastJSONPathMeta={totalCount:r,truncated:o},this.lastJSONPathQuery=e,l?this.focusJSONPathMatch(0,i,{fromWidget:d,reveal:!0}):(this.currentJSONPathIndex<0||this.currentJSONPathIndex>=t.length)&&(this.currentJSONPathIndex=0),d&&this.updateFindWidgetMatchesCount(r,o,this.currentJSONPathIndex),c){const m=Math.max(0,this.currentJSONPathIndex),h=t[m]||t[0];let S=`JSONPath "${e}" found ${r} match${r===1?"":"es"}`;o&&t.length<r&&(S+=` (showing first ${t.length})`),h&&Object.prototype.hasOwnProperty.call(h,"value")&&(S+=`: ${this.formatValuePreview(h.value)}`),this.showNotification(S,"success"),r>1&&this.showNotification(`Use Alt+N/Alt+P to navigate between ${r} matches`,"info")}return t}resetJSONPathResults(e={}){const{keepQuery:t=!1}=e||{};this.lastJSONPathResults=[],this.lastJSONPathMeta={totalCount:0,truncated:!1},this.lastJSONPathPointerLocator=null,this.currentJSONPathIndex=-1,t||(this.lastJSONPathQuery="")}focusJSONPathMatch(e,t=this.getActiveEditor(),i={}){const{reveal:r=!0,fromWidget:o=!1}=i||{};if(!t)return!1;const s=Array.isArray(this.lastJSONPathResults)?this.lastJSONPathResults:[];if(s.length===0)return this.currentJSONPathIndex=-1,o&&this.updateFindWidgetMatchesCount(0,!1,-1),!1;const c=Number(e);if(Number.isNaN(c)||c<0||c>=s.length)return!1;const l=s[c];if(!l)return!1;const d=t.getValue();let m=l.position,h=this.lastJSONPathPointerLocator;if(h||(h=this.createPointerLocator(d),this.lastJSONPathPointerLocator=h),(!m||typeof m.startLineNumber!="number")&&h){const I=l.pointer||this.convertJSONPathToPointer(l.path);if(I){const T=h.getRange(I);T&&(m=T,l.position=T)}}if(!m||typeof m.startLineNumber!="number"){const I=l.pointer||null,T=this.findValuePosition(l.value,d,t,l.path,h,I);T&&(m=T,l.position=T)}if(!m||typeof m.startLineNumber!="number")return!1;const S=new monaco.Range(m.startLineNumber,m.startColumn,m.endLineNumber,m.endColumn);if(t.setSelection(S),r&&(monaco?.editor?.ScrollType?t.revealRangeInCenter(S,monaco.editor.ScrollType.Smooth):t.revealRangeInCenter(S)),this.currentJSONPathIndex=c,o||this.findWidgetIntegration&&this.findWidgetIntegration.enabled){const I=this.lastJSONPathMeta||{},T=typeof I.totalCount=="number"&&I.totalCount>0?I.totalCount:s.length;this.updateFindWidgetMatchesCount(T,!!I.truncated,c)}return!0}navigateJSONPathMatches(e=1,t=this.getActiveEditor(),i={}){const r=Array.isArray(this.lastJSONPathResults)?this.lastJSONPathResults:[];if(!t||r.length===0)return i.notify!==!1&&this.showNotification("No JSONPath matches to navigate","warning"),!1;let o=Number(e);(Number.isNaN(o)||o===0)&&(o=1);const s=r.length;let c=typeof this.currentJSONPathIndex=="number"?this.currentJSONPathIndex:-1;c<0||c>=s?c=o>0?0:s-1:c=(c+o+s)%s;const l=this.focusJSONPathMatch(c,t,{fromWidget:i.fromWidget,reveal:i.reveal!==!1});return!l&&i.notify!==!1&&this.showNotification("Unable to navigate to JSONPath match","warning"),l}updateFindWidgetMatchesCount(e,t,i=this.currentJSONPathIndex,r={}){const o=this.findWidgetIntegration;if(!o||!o.matchesElement)return;const s=o.matchesElement;if(r.reset){typeof o.originalMatchesText=="string"&&(s.textContent=o.originalMatchesText),s.removeAttribute("data-jsonpath"),s.removeAttribute("data-jsonpath-state"),s.removeAttribute("data-jsonpath-partial"),s.removeAttribute("title");return}if(!o.enabled&&!r.force)return;const c=(S,I="status",T={})=>{s.dataset.jsonpath="true",s.dataset.jsonpathState=I,T.partial?s.dataset.jsonpathPartial="true":s.removeAttribute("data-jsonpath-partial"),s.innerHTML="";const v=document.createElement("span");if(v.className="jsonpath-chip",v.textContent="JSONPath",s.appendChild(v),S){const g=document.createElement("span");g.className="jsonpath-status",g.textContent=S,s.appendChild(g)}T.title?s.title=T.title:S?s.title=`JSONPath \xB7 ${S}`:s.removeAttribute("title")};if(r.searching){c("searching\u2026");return}if(r.emptyQuery){c("enter path");return}if(r.noContent){c("no content");return}if(r.error){c("error","error");return}if(!e||e<=0){c("no results");return}const l=typeof i=="number"&&i>=0?i+1:1,d=`${l}/${e}`,m=t&&Array.isArray(this.lastJSONPathResults)&&this.lastJSONPathResults.length<e,h=m?`JSONPath results \xB7 ${l}/${e} (partial)`:`JSONPath results \xB7 ${l}/${e}`;c(d,"count",{partial:m,title:h})}performFindWidgetJSONPathSearch(e,t={}){const i=this.findWidgetIntegration;if(!i||!i.enabled)return;const r=typeof e=="string"?e.trim():"",o=!!t.immediate,s=typeof t.delay=="number"?t.delay:150;if(i.searchDebounce&&(clearTimeout(i.searchDebounce),i.searchDebounce=null),!r){this.resetJSONPathResults({keepQuery:!1}),this.lastJSONPathQuery="",this.updateFindWidgetMatchesCount(0,!1,-1,{emptyQuery:!0});return}const c=()=>{i.searchDebounce=null;const l=i.editor||this.getActiveEditor();l&&this.searchWithJSONPath(r,l,{notify:!1,revealFirst:t.revealFirst!==!1,fromWidget:!0})};if(this.updateFindWidgetMatchesCount(null,!1,-1,{searching:!0,force:!0}),o){c();return}i.searchDebounce=setTimeout(c,s)}setupFindWidgetIntegration(e){if(typeof document>"u")return;this.findWidgetIntegration?(this.findWidgetIntegration.editor=e,"resizeHandler"in this.findWidgetIntegration||(this.findWidgetIntegration.resizeHandler=null),"resizeObserver"in this.findWidgetIntegration||(this.findWidgetIntegration.resizeObserver=null),"layoutRaf"in this.findWidgetIntegration||(this.findWidgetIntegration.layoutRaf=null),"layoutScheduler"in this.findWidgetIntegration||(this.findWidgetIntegration.layoutScheduler="raf"),"lastLayoutWidth"in this.findWidgetIntegration||(this.findWidgetIntegration.lastLayoutWidth=null),"lastReservedPadding"in this.findWidgetIntegration||(this.findWidgetIntegration.lastReservedPadding=null)):this.findWidgetIntegration={editor:e,widget:null,toggleElement:null,matchesElement:null,inputElement:null,nextButton:null,prevButton:null,closeButton:null,enabled:!1,observer:null,searchDebounce:null,originalMatchesText:"",resizeHandler:null,resizeObserver:null,layoutRaf:null,layoutScheduler:"raf",lastLayoutWidth:null,lastReservedPadding:null};const t=this.findWidgetIntegration;(()=>{const r=document.querySelector(".editor-widget.find-widget");return r?(this.decorateFindWidget(r,t),!0):!1})()||t.observer||(t.observer=new MutationObserver(r=>{for(const o of r){if(o.addedNodes)for(const s of o.addedNodes){if(!s||s.nodeType!==1)continue;const c=s;if(c.classList.contains("find-widget")){this.decorateFindWidget(c,t);continue}const l=c.querySelector?c.querySelector(".editor-widget.find-widget, .find-widget"):null;if(l){const d=l.classList&&l.classList.contains("find-widget")?l:l.querySelector(".find-widget");d&&this.decorateFindWidget(d,t)}}if(o.removedNodes&&t.widget)for(const s of o.removedNodes)!s||s.nodeType!==1||(s===t.widget||s.contains&&s.contains(t.widget))&&this.handleFindWidgetRemoval()}}),t.observer.observe(document.body,{childList:!0,subtree:!0}))}async openFindWidget(e={}){const t=this.getActiveEditor();if(!t)return null;this.setupFindWidgetIntegration(t);const i=t.getAction&&t.getAction("actions.find");try{i&&typeof i.run=="function"?await i.run():t.trigger("keyboard","actions.find",null)}catch(s){console.warn("Find widget command failed, triggering fallback:",s),t.trigger("keyboard","actions.find",null)}const r=Date.now(),o=typeof requestAnimationFrame=="function"?requestAnimationFrame:s=>setTimeout(s,30);return new Promise(s=>{const c=()=>{const l=this.findWidgetIntegration;if(l&&l.widget&&l.inputElement){const d=l.inputElement,m=e.focus!==!1,h=e.select!==!1,S=e.notify===!0,I=typeof e.jsonPathMode=="boolean",T=I?e.jsonPathMode:null,v=typeof e.query=="string",w=(v?e.query:"").trim();v&&d.value!==w&&(d.value=w),I&&this.setFindWidgetJSONPathMode(T,{notify:S,focusInput:!1}),(!I||T!==!0)&&v&&d.dispatchEvent(new Event("input",{bubbles:!0})),m&&(d.focus(),h&&d.select()),s(l);return}if(Date.now()-r>1200){s(null);return}o(c)};c()})}decorateFindWidget(e,t=this.findWidgetIntegration){if(!t||!e||typeof e.querySelector!="function")return;e.dataset&&(e.dataset.jsonpathDecorated="true"),e.classList.add("jsonpath-extended"),t.widget=e,typeof window<"u"&&(t.resizeHandler&&window.removeEventListener("resize",t.resizeHandler),t.resizeHandler=window.debounce?window.debounce(()=>this.refreshFindWidgetLayout(),150):()=>this.refreshFindWidgetLayout(),window.addEventListener("resize",t.resizeHandler,{passive:!0})),typeof ResizeObserver<"u"&&(t.resizeObserver?t.resizeObserver.disconnect():t.resizeObserver=new ResizeObserver(()=>{this.refreshFindWidgetLayout()}),t.resizeObserver.observe(e));const i=e.querySelector(".matchesCount");i&&(t.matchesElement=i,t.originalMatchesText||(t.originalMatchesText=i.textContent||""));const r=e.querySelector(".controls");if(r&&r.classList.add("jsonpath-widget-controls"),r&&!e.querySelector("[data-jsonpath-toggle]")){const d=document.createElement("div");d.className="monaco-custom-toggle codicon codicon-symbol-structure",d.setAttribute("role","checkbox"),d.setAttribute("tabindex","0"),d.setAttribute("aria-checked","false"),d.setAttribute("aria-label","Use JSONPath (Alt+J)"),d.setAttribute("title","Use JSONPath (Alt+J)"),d.dataset.jsonpathToggle="true",d.classList.add("monaco-jsonpath-toggle");const m=h=>{h.preventDefault(),h.stopPropagation(),this.setFindWidgetJSONPathMode(!t.enabled,{notify:!0,focusInput:!0})};d.addEventListener("click",m),d.addEventListener("keydown",h=>{(h.key===" "||h.key==="Enter")&&m(h)}),r.firstChild?r.insertBefore(d,r.firstChild):r.appendChild(d),t.toggleElement=d}else r&&(t.toggleElement||(t.toggleElement=r.querySelector("[data-jsonpath-toggle]")),t.toggleElement&&t.toggleElement.classList.add("monaco-jsonpath-toggle"));const o=e.querySelector(".find-part .input");o&&(t.inputElement=o,o.dataset.jsonpathBound||(o.dataset.jsonpathBound="true",o.addEventListener("input",()=>{t.enabled&&this.performFindWidgetJSONPathSearch(o.value)}),o.addEventListener("keydown",d=>{if(t.enabled&&d.key==="Enter"){d.preventDefault(),d.stopPropagation();const m=o.value.trim();if(!m){this.updateFindWidgetMatchesCount(0,!1,-1,{emptyQuery:!0});return}if(m!==this.lastJSONPathQuery){this.performFindWidgetJSONPathSearch(m,{immediate:!0});return}const h=d.shiftKey?-1:1;this.navigateJSONPathMatches(h,t.editor,{fromWidget:!0,notify:!1})}})));const s=e.querySelector(".codicon-find-next-match");s&&(t.nextButton=s,s.dataset.jsonpathBound||(s.dataset.jsonpathBound="true",s.addEventListener("mousedown",d=>{t.enabled&&(d.preventDefault(),d.stopPropagation())}),s.addEventListener("click",d=>{if(!t.enabled)return;d.preventDefault(),d.stopPropagation();const m=t.inputElement?t.inputElement.value.trim():"";if(m&&m!==this.lastJSONPathQuery){this.performFindWidgetJSONPathSearch(m,{immediate:!0});return}this.navigateJSONPathMatches(1,t.editor,{fromWidget:!0,notify:!1})})));const c=e.querySelector(".codicon-find-previous-match");c&&(t.prevButton=c,c.dataset.jsonpathBound||(c.dataset.jsonpathBound="true",c.addEventListener("mousedown",d=>{t.enabled&&(d.preventDefault(),d.stopPropagation())}),c.addEventListener("click",d=>{if(!t.enabled)return;d.preventDefault(),d.stopPropagation();const m=t.inputElement?t.inputElement.value.trim():"";if(m&&m!==this.lastJSONPathQuery){this.performFindWidgetJSONPathSearch(m,{immediate:!0});return}this.navigateJSONPathMatches(-1,t.editor,{fromWidget:!0,notify:!1})})));const l=e.querySelector(".codicon-widget-close");if(l&&(t.closeButton=l,l.dataset.jsonpathBound||(l.dataset.jsonpathBound="true",l.addEventListener("click",()=>{t.enabled&&this.setFindWidgetJSONPathMode(!1,{notify:!1})}))),t.enabled){const d=this.lastJSONPathMeta||{},m=typeof d.totalCount=="number"&&d.totalCount>0?d.totalCount:Array.isArray(this.lastJSONPathResults)?this.lastJSONPathResults.length:0;m>0?this.updateFindWidgetMatchesCount(m,!!d.truncated,this.currentJSONPathIndex,{force:!0}):this.updateFindWidgetMatchesCount(0,!1,-1,{emptyQuery:!this.lastJSONPathQuery})}this.refreshFindWidgetLayout({immediate:!0})}refreshFindWidgetLayout(e={}){const t=this.findWidgetIntegration;if(!t||!t.widget)return;const i=t.widget;i.classList.add("jsonpath-extended");const r=typeof requestAnimationFrame=="function"?"raf":"timeout",o=r==="raf"?requestAnimationFrame:c=>setTimeout(c,20);t.layoutRaf!==null&&(t.layoutScheduler==="raf"&&typeof cancelAnimationFrame=="function"?cancelAnimationFrame(t.layoutRaf):clearTimeout(t.layoutRaf),t.layoutRaf=null),t.layoutScheduler=r;const s=()=>{t.layoutRaf=null;const c=typeof window<"u"&&window.innerWidth||0;let l=460;if(c>0){const g=c<600?24:48,w=c<1280?.62:.5,A=Math.round(c*w);l=Math.max(380,Math.min(720,c-g,A)),c<=520&&(l=Math.max(320,c-20))}let d=l;if(c>0){const g=Math.max(320,c-32);d=Math.min(l,g)}t.lastLayoutWidth!==d&&(i.style.width=`${d}px`,i.style.maxWidth="calc(100vw - 32px)",i.style.minWidth=`${Math.min(Math.max(d,320),420)}px`,t.lastLayoutWidth=d);const m=i.querySelector(".find-part");m&&(m.style.flex="1 1 auto",m.style.minWidth="0");const h=i.querySelector(".find-part .monaco-findInput");h&&(h.style.flex="1 1 auto",h.style.minWidth="0");const S=i.querySelector(".replace-part");S&&(S.style.flex="1 1 auto",S.style.minWidth="0");const I=i.querySelector(".find-part .controls");let T=88;if(I){I.classList.add("jsonpath-widget-controls");const g=I.getBoundingClientRect();g&&g.width?T=Math.max(72,Math.round(g.width)+12):I.children&&I.children.length&&(T=Math.max(72,I.children.length*24+12))}if(t.lastReservedPadding!==T){const g=(w,A,N)=>{const D=i.querySelector(w);if(!D)return;const V=D.querySelector(".input"),H=D.querySelector(".mirror"),de=Math.max(N,T-A);V&&(V.style.width=`calc(100% - ${de}px)`),H&&(H.style.paddingRight=`${de}px`)};g(".find-part .monaco-findInput",0,72),g(".replace-part .monaco-findInput",24,56),t.lastReservedPadding=T}const v=i.querySelector(".matchesCount");v&&(v.style.minWidth="96px",v.style.textAlign="right")};e.immediate&&s(),t.layoutRaf=o(()=>{s()})}toggleFindWidgetJSONPathMode(e){const t=this.getActiveEditor();if(!t)return;const i=this.findWidgetIntegration,r=typeof e=="boolean"?e:!(i&&i.enabled),o=()=>{this.setupFindWidgetIntegration(t);const s=this.findWidgetIntegration;s&&s.widget&&this.setFindWidgetJSONPathMode(r,{notify:!0,focusInput:!0})};if(!i||!i.widget){const s=t.getAction&&t.getAction("actions.find");s&&typeof s.run=="function"?s.run().then(()=>{setTimeout(o,0)}).catch(()=>{setTimeout(o,0)}):(t.trigger("keyboard","actions.find",null),setTimeout(o,0))}else o()}setFindWidgetJSONPathMode(e,t={}){const i=this.findWidgetIntegration;if(!i)return;const r=i.enabled;if(i.enabled=!!e,i.toggleElement){i.toggleElement.setAttribute("aria-checked",i.enabled?"true":"false"),i.toggleElement.classList.toggle("checked",i.enabled);const c=i.enabled?"Disable JSONPath (Alt+J)":"Use JSONPath (Alt+J)";i.toggleElement.setAttribute("aria-label",c),i.toggleElement.setAttribute("title",c)}if(i.widget&&i.widget.classList.toggle("jsonpath-mode",i.enabled),this.refreshFindWidgetLayout(),!i.enabled){i.searchDebounce&&(clearTimeout(i.searchDebounce),i.searchDebounce=null),this.updateFindWidgetMatchesCount(null,!1,-1,{reset:!0}),t.notify&&r!==i.enabled&&this.showNotification("JSONPath mode disabled in find widget","info");return}t.notify&&r!==i.enabled&&this.showNotification("JSONPath mode enabled in find widget","info");const o=i.inputElement;t.focusInput&&o&&(o.focus(),o.select());const s=o?o.value.trim():"";s?this.performFindWidgetJSONPathSearch(s,{immediate:!0}):this.updateFindWidgetMatchesCount(0,!1,-1,{emptyQuery:!0})}handleFindWidgetRemoval(){const e=this.findWidgetIntegration;if(e){if(e.searchDebounce&&(clearTimeout(e.searchDebounce),e.searchDebounce=null),e.layoutRaf!==null&&(e.layoutScheduler==="raf"&&typeof cancelAnimationFrame=="function"?cancelAnimationFrame(e.layoutRaf):clearTimeout(e.layoutRaf),e.layoutRaf=null),e.resizeObserver&&typeof e.resizeObserver.disconnect=="function"&&(e.resizeObserver.disconnect(),e.resizeObserver=null),e.resizeHandler&&typeof window<"u"&&(window.removeEventListener("resize",e.resizeHandler),e.resizeHandler=null),e.widget){e.widget.classList.remove("jsonpath-extended","jsonpath-mode"),e.widget.style.removeProperty("width"),e.widget.style.removeProperty("maxWidth"),e.widget.style.removeProperty("minWidth");const t=e.widget.querySelector(".find-part .input"),i=e.widget.querySelector(".find-part .mirror");t&&t.style.removeProperty("width"),i&&i.style.removeProperty("padding-right");const r=e.widget.querySelector(".replace-part .input"),o=e.widget.querySelector(".replace-part .mirror");r&&r.style.removeProperty("width"),o&&o.style.removeProperty("padding-right")}e.lastLayoutWidth=null,e.lastReservedPadding=null,e.widget=null,e.toggleElement=null,e.matchesElement=null,e.inputElement=null,e.nextButton=null,e.prevButton=null,e.closeButton=null,e.enabled=!1}}startHealthMonitoring(){this.healthMonitoring.enabled||(this.healthMonitoring.enabled=!0,this.healthMonitoring.interval=setInterval(()=>{this.updateHealthStats()},5e3),console.log("\u{1F48A} Health monitoring started"))}updateHealthStats(){try{const e={timestamp:Date.now(),workerPool:this.workerPool?this.workerPool.getStats():null,searchIndex:this.searchIndex&&typeof this.searchIndex.getStats=="function"?this.searchIndex.getStats():null,performance:this.performanceController&&typeof this.performanceController.getStats=="function"?this.performanceController.getStats():null,memory:performance.memory?{used:Math.round(performance.memory.usedJSHeapSize/1024/1024),total:Math.round(performance.memory.totalJSHeapSize/1024/1024),limit:Math.round(performance.memory.jsHeapSizeLimit/1024/1024)}:null};this.healthMonitoring.stats=e,e.workerPool&&e.workerPool.queued>10&&console.warn("\u26A0\uFE0F Worker pool queue is growing:",e.workerPool.queued),e.memory&&e.memory.used>e.memory.limit*.8&&console.warn("\u26A0\uFE0F Memory usage high:",e.memory)}catch(e){console.error("Health monitoring error:",e)}}getHealthStats(){return this.healthMonitoring.stats}showPerformanceBadge(){const e=this.getHealthStats();if(!e)return;let t=document.getElementById("performanceBadge");t||(t=document.createElement("div"),t.id="performanceBadge",t.className="perf-monitor",document.body.appendChild(t));const i=[];e.workerPool&&(i.push(`Workers: ${e.workerPool.busy}/${e.workerPool.workers}`),e.workerPool.queued>0&&i.push(`Queue: ${e.workerPool.queued}`)),e.memory&&i.push(`RAM: ${e.memory.used}MB`),t.textContent=i.join(" | "),t.classList.add("show")}dispose(){this.healthMonitoring.interval&&(clearInterval(this.healthMonitoring.interval),this.healthMonitoring.interval=null,this.healthMonitoring.enabled=!1),this.editors.forEach(e=>{e.virtualRenderer&&e.virtualRenderer.dispose(),e.dispose()}),this.editors.clear(),this.diffEditor&&(this.diffEditor.dispose(),this.diffEditor=null),this.workerPool&&this.workerPool.terminate(),this.searchIndex&&typeof this.searchIndex.clear=="function"&&this.searchIndex.clear(),this.findWidgetIntegration&&(this.handleFindWidgetRemoval(),this.findWidgetIntegration.observer&&(this.findWidgetIntegration.observer.disconnect(),this.findWidgetIntegration.observer=null),this.findWidgetIntegration.searchDebounce&&(clearTimeout(this.findWidgetIntegration.searchDebounce),this.findWidgetIntegration.searchDebounce=null),this.findWidgetIntegration=null),this.isInitialized=!1}}const monacoInitializer=new MonacoInitializer;let monacoInitializationPromise=null,monacoReadyEventDispatched=!1;function dispatchMonacoReadyEvent(){if(monacoReadyEventDispatched||(monacoReadyEventDispatched=!0,typeof window>"u"||typeof window.dispatchEvent!="function"))return;let n=null;typeof window.CustomEvent=="function"?n=new CustomEvent("monaco:ready",{detail:{initializer:monacoInitializer}}):typeof document<"u"&&typeof document.createEvent=="function"&&(n=document.createEvent("Event"),n.initEvent("monaco:ready",!1,!1),n.detail={initializer:monacoInitializer}),n&&window.dispatchEvent(n)}function bootstrapMonacoInitializer(){if(!monacoInitializationPromise){try{monacoInitializationPromise=monacoInitializer.initialize()}catch(n){console.error(n),monacoInitializationPromise=Promise.reject(n)}monacoInitializationPromise.then(dispatchMonacoReadyEvent).catch(n=>{console.error(n)})}return monacoInitializationPromise}window.addEventListener("monaco:loaded",()=>{console.log("\u{1F680} [Lazy Init] monaco:loaded event received, initializing editor..."),bootstrapMonacoInitializer()}),window.bootstrapMonacoInitializer=bootstrapMonacoInitializer,typeof window<"u"&&(window.monacoInitializer=monacoInitializer,window.renderHistoryModal=renderHistoryModal);
