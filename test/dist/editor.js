"use strict";var an=t=>{throw TypeError(t)};var jt=(t,e,n)=>e.has(t)||an("Cannot "+n);var Le=(t,e,n)=>(jt(t,e,"read from private field"),n?n.call(t):e.get(t)),ht=(t,e,n)=>e.has(t)?an("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),gt=(t,e,n,i)=>(jt(t,e,"write to private field"),i?i.call(t,n):e.set(t,n),n),Ot=(t,e,n)=>(jt(t,e,"access private method"),n);var Ht,We,Ye,st,Mt,Ge,sn,cn,_t;class VirtualizedJSONRenderer{constructor(e){this.editor=e,this.fullContent="",this.isVirtualized=!1}setContent(e){typeof e!="string"&&(e=""),this.fullContent=e;const n=e.split(`
`).length;this.isVirtualized=!1,this.editor.getValue()!==e&&this.editor.setValue(e),n>5e3&&console.log(`\u{1F4C4} Loaded large document (${n} lines) without manual virtualization.`)}updateVisibleRange(){}getFullContent(){return this.isVirtualized?this.fullContent:this.editor.getValue()}dispose(){this.fullContent="",this.isVirtualized=!1}}class IndexedSearch{constructor(){this.keyIndex=new Map,this.valueIndex=new Map,this.lineIndex=[],this.isIndexed=!1,this.lastBuildTime=0}buildIndex(e){const n=performance.now(),i=e.split(`
`);this.keyIndex.clear(),this.valueIndex.clear(),this.lineIndex=[],i.forEach((r,a)=>{this.lineIndex.push(r);const s=r.trim(),c=s.match(/"([^"]+)":/);if(c){const d=c[1].toLowerCase();this.keyIndex.has(d)||this.keyIndex.set(d,[]),this.keyIndex.get(d).push({line:a,column:r.indexOf(c[0]),text:r,key:c[1]})}const l=s.match(/:\s*"([^"]+)"/);if(l){const d=l[1].toLowerCase();this.valueIndex.has(d)||this.valueIndex.set(d,[]),this.valueIndex.get(d).push({line:a,column:r.indexOf(l[1]),text:r,value:l[1]})}}),this.isIndexed=!0,this.lastBuildTime=performance.now()-n,console.log(`\u{1F50D} Search index built in ${this.lastBuildTime.toFixed(2)}ms for ${i.length} lines`)}searchKeys(e,n={}){if(!this.isIndexed)return[];const i=n.matchCase?e:e.toLowerCase(),r=[];for(const[a,s]of this.keyIndex)this.matches(a,i,n)&&r.push(...s.map(c=>({...c,type:"key"})));return r.slice(0,1e3)}searchValues(e,n={}){if(!this.isIndexed)return[];const i=n.matchCase?e:e.toLowerCase(),r=[];for(const[a,s]of this.valueIndex)this.matches(a,i,n)&&r.push(...s.map(c=>({...c,type:"value"})));return r.slice(0,1e3)}searchAll(e,n={}){const i=this.searchKeys(e,n),r=this.searchValues(e,n);return[...i,...r].sort((a,s)=>a.line-s.line).slice(0,1e3)}matches(e,n,i){return i.wholeWord?new RegExp(`\\b${this.escapeRegex(n)}\\b`,i.matchCase?"":"i").test(e):e.includes(n)}escapeRegex(e){return e.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}getStats(){return{indexed:this.isIndexed,keys:this.keyIndex.size,values:this.valueIndex.size,lines:this.lineIndex.length,buildTime:this.lastBuildTime}}clear(){this.keyIndex.clear(),this.valueIndex.clear(),this.lineIndex=[],this.isIndexed=!1,this.lastBuildTime=0}}class WorkerPool{constructor(e,n=4){if(this.workers=[],this.queue=[],this.busyWorkers=new Set,this.taskIdCounter=0,this.pendingTasks=new Map,location.protocol==="file:"){console.log("\u{1F6A7} Skipping worker pool creation due to file:// protocol limitations"),console.log("\u{1F465} Worker pool initialized with 0 workers (file:// mode)");return}for(let i=0;i<n;i++)try{const r=new Worker(e);r.id=i,r.onmessage=a=>this.handleMessage(r,a),r.onerror=a=>this.handleError(r,a),this.workers.push(r)}catch(r){console.warn(`Failed to create worker ${i}:`,r)}console.log(`\u{1F465} Worker pool initialized with ${this.workers.length} workers`)}execute(e,n,i=0,r=1e4){return new Promise((a,s)=>{const c=++this.taskIdCounter,l={id:c,operation:e,payload:n,resolve:a,reject:s,priority:i,timestamp:Date.now(),timeout:setTimeout(()=>{this.cancelTask(c,"timeout")},r)};this.pendingTasks.set(c,l);const d=this.getAvailableWorker();d?this.runTask(d,l):(this.queue.push(l),this.queue.sort((m,w)=>w.priority-m.priority))})}getAvailableWorker(){return this.workers.find(e=>!this.busyWorkers.has(e.id))}runTask(e,n){this.busyWorkers.add(e.id),e.currentTask=n,e.postMessage({type:n.operation,payload:n.payload,taskId:n.id})}handleMessage(e,n){const i=e.currentTask;i&&(clearTimeout(i.timeout),this.pendingTasks.delete(i.id),n.data.error?i.reject(new Error(n.data.error)):i.resolve(n.data.result||n.data)),this.releaseWorker(e)}handleError(e,n){const i=e.currentTask;i&&(clearTimeout(i.timeout),this.pendingTasks.delete(i.id),i.reject(n)),this.releaseWorker(e)}releaseWorker(e){if(this.busyWorkers.delete(e.id),e.currentTask=null,this.queue.length>0){const n=this.queue.shift();this.runTask(e,n)}}cancelTask(e,n="cancelled"){const i=this.pendingTasks.get(e);if(i){clearTimeout(i.timeout),this.pendingTasks.delete(e),i.reject(new Error(`Task ${n}`));const r=this.queue.findIndex(a=>a.id===e);r!==-1&&this.queue.splice(r,1)}}getStats(){return{workers:this.workers.length,busy:this.busyWorkers.size,queued:this.queue.length,pending:this.pendingTasks.size}}terminate(){for(const[e]of this.pendingTasks)this.cancelTask(e,"pool_terminated");this.workers.forEach(e=>e.terminate()),this.workers=[],this.queue=[],this.busyWorkers.clear(),this.pendingTasks.clear()}}class PerformanceController{constructor(){this.debounceTimers=new Map,this.throttleTimestamps=new Map,this.measurements=new Map}debounce(e,n,i){clearTimeout(this.debounceTimers.get(e)),this.debounceTimers.set(e,setTimeout(()=>{n(),this.debounceTimers.delete(e)},i))}throttle(e,n,i){const r=Date.now(),a=this.throttleTimestamps.get(e)||0;return r-a>=i?(this.throttleTimestamps.set(e,r),n(),!0):!1}measurePerformance(e,n){const i=performance.now(),r=n(),a=performance.now()-i;return this.measurements.has(e)||this.measurements.set(e,[]),this.measurements.get(e).push(a),a>100?console.warn(`\u{1F40C} Slow operation [${e}]: ${a.toFixed(2)}ms`):a>50&&console.log(`\u26A1 Operation [${e}]: ${a.toFixed(2)}ms`),r}async measureAsync(e,n){const i=performance.now(),r=await n(),a=performance.now()-i;return this.measurements.has(e)||this.measurements.set(e,[]),this.measurements.get(e).push(a),a>100&&console.warn(`\u{1F40C} Async operation [${e}]: ${a.toFixed(2)}ms`),r}getStats(e){const n=this.measurements.get(e);if(!n||n.length===0)return null;const i=[...n].sort((r,a)=>r-a);return{count:n.length,min:i[0],max:i[i.length-1],avg:n.reduce((r,a)=>r+a,0)/n.length,median:i[Math.floor(i.length/2)]}}clearStats(){this.measurements.clear()}}class ResultCache{constructor(e=100,n=3e5){this.cache=new Map,this.maxSize=e,this.ttl=n,this.hits=0,this.misses=0}generateKey(e,n){const i=this.simpleHash(n);return`${e}:${i}:${n.length}`}simpleHash(e){let n=0;for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);n=(n<<5)-n+r,n=n&n}return Math.abs(n).toString(36)}get(e,n){const i=this.generateKey(e,n),r=this.cache.get(i);return r&&Date.now()-r.timestamp<this.ttl?(this.hits++,r.result):(r&&this.cache.delete(i),this.misses++,null)}set(e,n,i){const r=this.generateKey(e,n);if(this.cache.size>=this.maxSize){const a=this.cache.keys().next().value;this.cache.delete(a)}this.cache.set(r,{result:i,timestamp:Date.now()})}clear(){this.cache.clear(),this.hits=0,this.misses=0}getStats(){const e=this.hits+this.misses;return{size:this.cache.size,maxSize:this.maxSize,hits:this.hits,misses:this.misses,hitRate:e>0?(this.hits/e*100).toFixed(1)+"%":"0%"}}}typeof window<"u"&&(window.VirtualizedJSONRenderer=VirtualizedJSONRenderer,window.IndexedSearch=IndexedSearch,window.WorkerPool=WorkerPool,window.PerformanceController=PerformanceController,window.ResultCache=ResultCache),typeof module<"u"&&module.exports&&(module.exports={VirtualizedJSONRenderer,IndexedSearch,WorkerPool,PerformanceController,ResultCache});const Logger=(function(){const t={DEBUG:0,INFO:1,WARN:2,ERROR:3,SILENT:4};let e=t.WARN;const n={API:"\u{1F517}",CACHE:"\u{1F9E9}",DEMO:"\u{1F9EA}",EDITOR:"\u{1F4DD}",EVENTS:"\u{1F4E2}",FEATURES:"\u{1F9E0}",FILTERS:"\u{1F50D}",HEALTH:"\u{1F493}",MANAGERS:"\u{1F9ED}",METADATA:"\u{1F4C5}",OPS:"\u{1F6E0}\uFE0F",OPTIMISTIC:"\u{1F3AF}",PAGINATION:"\u2194\uFE0F",QUERY:"\u2753",RECORDING:"\u23FA\uFE0F",REQUESTS:"\u{1F4E1}",SCENARIOS:"\u{1F3AC}",STATE:"\u{1F310}",STORE:"\u{1F5C2}\uFE0F",SYNC:"\u{1F504}",TEMPLATES:"\u{1F9FE}",UI:"\u{1F5A5}\uFE0F",DEFAULT:"\u{1F4CB}"};function i(){try{const c=localStorage.getItem("imock-log-level");c&&t[c.toUpperCase()]!==void 0&&(e=t[c.toUpperCase()])}catch{}}function r(c,...l){const d=n[c]||n.DEFAULT;return[`[${new Date().toISOString().substring(11,23)}] ${d} [${c}]`,...l]}function a(c){const l=(c||"").toUpperCase();if(t[l]!==void 0){e=t[l];try{localStorage.setItem("imock-log-level",l)}catch{}}}const s={LEVELS:t,setLevel:a,debug:(c,...l)=>{e<=t.DEBUG&&console.log(...r(c,...l))},info:(c,...l)=>{e<=t.INFO&&console.info(...r(c,...l))},warn:(c,...l)=>{e<=t.WARN&&console.warn(...r(c,...l))},error:(c,...l)=>{e<=t.ERROR&&console.error(...r(c,...l))},api:(...c)=>s.debug("API",...c),cache:(...c)=>s.debug("CACHE",...c),ui:(...c)=>s.debug("UI",...c)};return i(),s})();window.Logger=Logger;class MonacoLoader{static async load(){return Le(this,st)?(console.log("\u2705 [Monaco Lazy Loader] Already loaded"),Promise.resolve()):Le(this,We)?(console.log("\u23F3 [Monaco Lazy Loader] Already loading, returning existing promise"),Le(this,We)):(console.log("\u{1F680} [Monaco Lazy Loader] Starting lazy load..."),gt(this,Ye,!0),gt(this,We,Ot(this,Ge,sn).call(this).then(()=>{gt(this,st,!0),gt(this,Ye,!1),console.log("\u2705 [Monaco Lazy Loader] Monaco loaded successfully"),window.dispatchEvent(new CustomEvent("monaco:loaded"))}).catch(e=>{throw gt(this,Ye,!1),gt(this,We,null),console.error("\u274C [Monaco Lazy Loader] Failed to load Monaco:",e),e})),Le(this,We))}static prefetch(){Le(this,st)||Le(this,Ye)||(console.log("\u26A1 [Monaco Lazy Loader] Prefetching Monaco..."),this.load().catch(e=>{console.warn("\u26A0\uFE0F [Monaco Lazy Loader] Prefetch failed:",e)}))}static isLoaded(){return Le(this,st)}static isLoading(){return Le(this,Ye)}static getStatus(){return{isLoaded:Le(this,st),isLoading:Le(this,Ye),hasPromise:Le(this,We)!==null}}}Ht=new WeakMap,We=new WeakMap,Ye=new WeakMap,st=new WeakMap,Mt=new WeakMap,Ge=new WeakSet,sn=async function(){const e=Le(this,Mt)[0];try{return console.log(`\u{1F4E6} [Monaco Lazy Loader] Loading from ${e.label}...`),await Ot(this,Ge,_t).call(this,`${e.baseUrl}/loader.js`,"monaco-loader-script"),typeof window.require<"u"&&typeof window.require.config=="function"?window.require.config({paths:{vs:e.baseUrl}}):(window.require=window.require||{},window.require.paths=Object.assign({},window.require.paths||{},{vs:e.baseUrl})),new Promise((n,i)=>{const r=setTimeout(()=>{i(new Error("Monaco loading timeout (30s)"))},3e4);window.require(["vs/editor/editor.main"],()=>{clearTimeout(r),console.log("\u2705 [Monaco Lazy Loader] Monaco editor.main loaded"),n()},a=>{clearTimeout(r),console.error("\u274C [Monaco Lazy Loader] AMD require failed:",a),i(a)})})}catch(n){console.error(`\u274C [Monaco Lazy Loader] Primary source (${e.label}) failed:`,n);for(let i=1;i<Le(this,Mt).length;i++){const r=Le(this,Mt)[i];try{return console.log(`\u{1F504} [Monaco Lazy Loader] Trying fallback: ${r.label}...`),await Ot(this,Ge,cn).call(this,r)}catch(a){console.warn(`\u26A0\uFE0F [Monaco Lazy Loader] Fallback ${r.label} failed:`,a)}}throw new Error("All Monaco CDN sources failed")}},cn=async function(e){return await Ot(this,Ge,_t).call(this,`${e.baseUrl}/loader.js`,`monaco-loader-fallback-${e.label}`),typeof window.require<"u"&&typeof window.require.config=="function"?window.require.config({paths:{vs:e.baseUrl}}):window.require.paths=Object.assign({},window.require.paths||{},{vs:e.baseUrl}),new Promise((n,i)=>{const r=setTimeout(()=>{i(new Error(`Fallback ${e.label} timeout`))},3e4);window.require(["vs/editor/editor.main"],()=>{clearTimeout(r),n()},a=>{clearTimeout(r),i(a)})})},_t=function(e,n){return new Promise((i,r)=>{if(document.getElementById(n)){console.log(`\u2705 [Monaco Lazy Loader] Script ${n} already loaded`),i();return}const a=document.createElement("script");a.id=n,a.src=e,a.async=!1,a.onload=()=>{console.log(`\u2705 [Monaco Lazy Loader] Script loaded: ${e}`),i()},a.onerror=s=>{console.error(`\u274C [Monaco Lazy Loader] Script failed: ${e}`,s),document.head.removeChild(a),r(new Error(`Failed to load script: ${e}`))},document.head.appendChild(a)})},ht(MonacoLoader,Ge),ht(MonacoLoader,Ht,null),ht(MonacoLoader,We,null),ht(MonacoLoader,Ye,!1),ht(MonacoLoader,st,!1),ht(MonacoLoader,Mt,[{label:"jsDelivr",baseUrl:"https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs"},{label:"cdnjs",baseUrl:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs"},{label:"unpkg",baseUrl:"https://unpkg.com/monaco-editor@0.44.0/min/vs"}]),window.MonacoLoader=MonacoLoader,console.log("\u{1F4E6} Monaco Lazy Loader initialized"),console.log("\u{1F4A1} Usage: await MonacoLoader.load() or MonacoLoader.prefetch()"),(function(e){const n=[{id:"happy-get-resource",title:"GET Resource",description:"Return a resource by id with templated fields.",category:"happy-path",highlight:"GET \xB7 /api/resources/{id}",feature:{path:["response","jsonBody","id"],label:"response.jsonBody.id"},content:{request:{method:"GET",urlPathPattern:"/api/resources/[a-f0-9-]+"},response:{status:200,headers:{"Content-Type":"application/json"},jsonBody:{id:"{{request.pathSegments.[2]}}",name:"Example Resource",createdAt:"{{now}}"},transformers:["response-template"]}}},{id:"happy-post-create",title:"POST Create (201)",description:"Create a new resource with Location header.",category:"happy-path",highlight:"POST \xB7 /api/resources",feature:{path:["response","headers","Location"],label:"response.headers.Location"},popular:!0,content:{request:{method:"POST",urlPath:"/api/resources",headers:{"Content-Type":{equalTo:"application/json"}}},response:{status:201,headers:{"Content-Type":"application/json",Location:"/api/resources/{{randomValue type='UUID'}}"},jsonBody:{id:"{{randomValue type='UUID'}}",message:"Resource created"},transformers:["response-template"]}}},{id:"error-400-validation",title:"400 Bad Request",description:"Validation error example for POST payloads.",category:"errors",highlight:"POST \xB7 /api/resources \xB7 400",content:{request:{method:"POST",urlPath:"/api/resources",bodyPatterns:[{matchesJsonPath:"$[?(!@.name)]"}]},response:{status:400,jsonBody:{error:"Bad Request",details:[{field:"name",error:"required"}]}}}},{id:"error-401-unauthorized",title:"401 Unauthorized",description:"Missing or invalid auth header.",category:"errors",highlight:"ANY \xB7 /api/* \xB7 401",content:{request:{method:"ANY",urlPathPattern:"/api/.*",headers:{Authorization:{absent:!0}}},response:{status:401,headers:{"WWW-Authenticate":'Bearer realm="api"'},jsonBody:{error:"Unauthorized"}}}},{id:"error-404-not-found",title:"404 Not Found",description:"Simple not-found stub for missing resources.",category:"errors",highlight:"GET \xB7 /api/resources/non-existent",content:{request:{method:"GET",urlPath:"/api/resources/non-existent"},response:{status:404,jsonBody:{error:"Not Found"}}}},{id:"error-429-rate-limit",title:"429 Rate Limit",description:"Throttle response with retry guidance.",category:"errors",highlight:"ANY \xB7 429 Too Many Requests",popular:!0,content:{request:{method:"ANY",urlPattern:"/api/.*"},response:{status:429,headers:{"Retry-After":"60","X-RateLimit-Remaining":"0"},jsonBody:{error:"Too Many Requests"}}}},{id:"fault-fixed-delay",title:"Fixed Delay",description:"Deterministic slow response.",category:"faults",highlight:"GET \xB7 /api/slow \xB7 delay",feature:{path:["response","fixedDelayMilliseconds"],label:"response.fixedDelayMilliseconds"},content:{request:{method:"GET",urlPath:"/api/slow"},response:{status:200,fixedDelayMilliseconds:5e3,jsonBody:{message:"Delayed"}}}},{id:"fault-random-delay-uniform",title:"Random Delay (Uniform)",description:"Variable latency within bounds.",category:"faults",highlight:"ANY \xB7 delayDistribution.uniform",content:{request:{method:"GET",urlPath:"/api/variable-latency"},response:{status:200,delayDistribution:{type:"uniform",lower:500,upper:2e3}}}},{id:"fault-random-delay-lognormal",title:"Random Delay (Lognormal)",description:"Realistic latency distribution.",category:"faults",highlight:"ANY \xB7 delayDistribution.lognormal",content:{request:{method:"GET",urlPath:"/api/realistic-latency"},response:{status:200,delayDistribution:{type:"lognormal",median:100,sigma:.4}}}},{id:"fault-chunked-dribble",title:"Chunked Dribble",description:"Slow streaming response.",category:"faults",highlight:"GET \xB7 /api/slow-download",content:{request:{method:"GET",urlPath:"/api/slow-download"},response:{status:200,body:"Slow response...",chunkedDribbleDelay:{numberOfChunks:10,totalDuration:5e3}}}},{id:"fault-connection-reset",title:"Connection Reset",description:"Simulate TCP reset failure.",category:"faults",highlight:"GET \xB7 /api/reset \xB7 fault",popular:!0,content:{request:{method:"GET",urlPath:"/api/reset"},response:{fault:"CONNECTION_RESET_BY_PEER"}}},{id:"fault-empty-response",title:"Empty Response",description:"Return no body to mimic dropped payloads.",category:"faults",highlight:"ANY \xB7 fault: EMPTY_RESPONSE",content:{request:{method:"GET",urlPath:"/api/empty"},response:{status:200,fault:"EMPTY_RESPONSE"}}},{id:"fault-malformed-response",title:"Malformed Response",description:"Corrupted chunk fault.",category:"faults",highlight:"ANY \xB7 fault: MALFORMED_RESPONSE_CHUNK",content:{request:{method:"GET",urlPath:"/api/corrupt"},response:{status:200,fault:"MALFORMED_RESPONSE_CHUNK"}}},{id:"scenario-retry-500-200",title:"Retry: 500 \u2192 200",description:"First call fails, retry succeeds.",category:"scenarios",highlight:"Scenario \xB7 /api/flaky",popular:!0,content:{mappings:[{scenarioName:"Retry_Scenario",requiredScenarioState:"Started",newScenarioState:"Recovered",request:{method:"GET",urlPath:"/api/flaky"},response:{status:500,jsonBody:{error:"Temporary failure"}}},{scenarioName:"Retry_Scenario",requiredScenarioState:"Recovered",request:{method:"GET",urlPath:"/api/flaky"},response:{status:200,jsonBody:{message:"Success"}}}]}},{id:"scenario-todo-workflow",title:"Todo List Workflow",description:"Create \u2192 Read \u2192 Update lifecycle.",category:"scenarios",highlight:"Scenario \xB7 /todo/items",content:{mappings:[{scenarioName:"todo_list",requiredScenarioState:"Started",request:{method:"GET",url:"/todo/items"},response:{status:200,jsonBody:{items:["Buy milk"]}}},{scenarioName:"todo_list",requiredScenarioState:"Started",newScenarioState:"Item added",request:{method:"POST",url:"/todo/items",bodyPatterns:[{contains:"Cancel subscription"}]},response:{status:201}},{scenarioName:"todo_list",requiredScenarioState:"Item added",request:{method:"GET",url:"/todo/items"},response:{status:200,jsonBody:{items:["Buy milk","Cancel subscription"]}}}]}},{id:"scenario-order-lifecycle",title:"Order Lifecycle",description:"Order status across states.",category:"scenarios",highlight:"Scenario \xB7 /orders/123/status",content:{mappings:[{scenarioName:"Order_Status",requiredScenarioState:"Started",newScenarioState:"Processing",request:{method:"GET",urlPath:"/orders/123/status"},response:{status:200,jsonBody:{status:"pending"}}},{scenarioName:"Order_Status",requiredScenarioState:"Processing",newScenarioState:"Shipped",request:{method:"GET",urlPath:"/orders/123/status"},response:{status:200,jsonBody:{status:"processing"}}},{scenarioName:"Order_Status",requiredScenarioState:"Shipped",request:{method:"GET",urlPath:"/orders/123/status"},response:{status:200,jsonBody:{status:"shipped"}}}]}},{id:"dynamic-echo-request",title:"Echo Request",description:"Reflect request values in the response.",category:"dynamic",highlight:"ANY \xB7 /api/echo/*",feature:{path:["response","jsonBody","path"],label:"response.jsonBody.*"},popular:!0,content:{request:{method:"ANY",urlPathPattern:"/api/echo/.*"},response:{status:200,jsonBody:{path:"{{request.path}}",query:"{{request.query.q}}",header:"{{request.headers.X-Custom}}",timestamp:"{{now}}"},transformers:["response-template"]}}},{id:"dynamic-jsonpath-extract",title:"JSONPath Extract",description:"Use JSONPath to pull fields from the request body.",category:"dynamic",highlight:"POST \xB7 /api/process",content:{request:{method:"POST",urlPath:"/api/process"},response:{status:200,body:`{"name": "{{jsonPath request.body '$.name'}}"}`,transformers:["response-template"]}}},{id:"dynamic-random-values",title:"Random Values",description:"Generate UUIDs, codes, and numbers in the response.",category:"dynamic",highlight:"ANY \xB7 response-template random values",content:{request:{method:"GET",urlPath:"/api/generate"},response:{status:200,jsonBody:{uuid:"{{randomValue type='UUID'}}",code:"{{randomValue length=8 type='ALPHANUMERIC'}}",number:"{{randomInt lower=1 upper=100}}",type:"ORDER_ACCEPTED",orderId:"{{jsonPath request.body '$.orderId'}}",occurredAt:`{{now offset='0' pattern=\\"yyyy-MM-dd'T'HH:mm:ssXXX\\"}}`},transformers:["response-template"]}}},{id:"match-url-regex",title:"URL Pattern (Regex)",description:"Regex path matcher for numeric IDs.",category:"matching",highlight:"GET \xB7 /api/users/{id}/orders/{orderId}",content:{request:{method:"GET",urlPathPattern:"/api/users/[0-9]+/orders/[a-f0-9-]+"}}},{id:"match-query-params",title:"Query Parameters",description:"Match search params with combinations.",category:"matching",highlight:"GET \xB7 /api/search?q=\u2026",popular:!0,content:{request:{method:"GET",urlPath:"/api/search",queryParameters:{q:{matches:".+"},page:{equalTo:"1"},limit:{or:[{equalTo:"10"},{equalTo:"20"}]}}},response:{status:200}}},{id:"match-headers",title:"Headers",description:"Match requests by required headers.",category:"matching",highlight:"ANY \xB7 header matchers",content:{request:{method:"ANY",urlPath:"/api/data",headers:{Accept:{contains:"application/json"},Authorization:{matches:"Bearer .+"}}},response:{status:200}}},{id:"match-json-equal",title:"JSON Body (equalToJson)",description:"Semantic JSON comparison with json-unit helpers.",category:"matching",highlight:"POST \xB7 equalToJson",content:{request:{method:"POST",urlPath:"/api/orders",bodyPatterns:[{equalToJson:{customerId:"${json-unit.any-string}",total:"${json-unit.any-number}"},ignoreArrayOrder:!0,ignoreExtraElements:!0}]},response:{status:201}}},{id:"match-jsonpath",title:"JSONPath",description:"Multiple JSONPath checks in one stub.",category:"matching",highlight:"POST \xB7 matchesJsonPath",content:{request:{method:"POST",urlPath:"/api/events",bodyPatterns:[{matchesJsonPath:"$.type"},{matchesJsonPath:"$[?(@.priority > 5)]"},{matchesJsonPath:{expression:"$.email",contains:"@example.com"}}]},response:{status:200}}},{id:"match-basic-auth",title:"Basic Auth",description:"Protect endpoints with HTTP Basic Auth.",category:"matching",highlight:"ANY \xB7 basicAuthCredentials",content:{request:{method:"GET",urlPath:"/api/secure",basicAuthCredentials:{username:"admin",password:"secret"}},response:{status:200}}},{id:"webhook-simple",title:"Simple Webhook",description:"Send a POST callback after accepting a request.",category:"webhooks",highlight:"POST \xB7 /api/trigger \xB7 webhook",popular:!0,content:{request:{method:"POST",urlPath:"/api/trigger"},response:{status:202},serveEventListeners:[{name:"webhook",parameters:{method:"POST",url:"http://callback-service/webhook",headers:{"Content-Type":"application/json"},body:'{"status": "complete"}'}}]}},{id:"webhook-templated",title:"Templated Webhook",description:"Populate webhook payload from the original request.",category:"webhooks",highlight:"POST \xB7 templated callback",content:{request:{method:"POST",urlPath:"/api/orders"},response:{status:202},serveEventListeners:[{name:"webhook",parameters:{url:"{{jsonPath originalRequest.body '$.callbackUrl'}}",body:`{"orderId": "{{jsonPath originalRequest.body '$.orderId'}}"}`}}]}},{id:"webhook-delayed",title:"Delayed Webhook",description:"Schedule a callback after a fixed delay.",category:"webhooks",highlight:"POST \xB7 delay \u2192 webhook",content:{request:{method:"POST",urlPath:"/api/async-job"},response:{status:202},serveEventListeners:[{name:"webhook",parameters:{url:"http://service/callback",delay:{type:"fixed",milliseconds:5e3}}}]}},{id:"proxy-full",title:"Full Proxy",description:"Pass all traffic through to an upstream API.",category:"proxy",highlight:"ANY \xB7 /api/* \u2192 proxy",popular:!0,content:{priority:10,request:{method:"ANY",urlPattern:"/api/.*"},response:{status:200,proxyBaseUrl:"https://api.example.com"}}},{id:"proxy-override",title:"Proxy + Override",description:"Forward with extra headers or overrides.",category:"proxy",highlight:"ANY \xB7 proxy with headers",content:{priority:100,request:{method:"ANY",urlPattern:"/api/.*"},response:{status:200,proxyBaseUrl:"https://api.example.com",additionalProxyRequestHeaders:{"X-Forwarded-By":"WireMock"}}}},{id:"proxy-start-recording",title:"Start Recording",description:"Record traffic for snapshotting stubs.",category:"proxy",highlight:"ADMIN \xB7 recording",content:{request:{method:"POST",urlPath:"/__admin/recordings/start"},response:{status:200},targetBaseUrl:"https://api.example.com",captureHeaders:{Accept:{},Authorization:{caseInsensitive:!0}},requestBodyPattern:{matcher:"equalToJson",ignoreArrayOrder:!0},persist:!0,repeatsAsScenarios:!0}}];function i(s){return JSON.parse(JSON.stringify(s))}function r(s){if(!s||typeof s!="object")throw new Error("Template must be an object");if(!s.id)throw new Error("Template requires an id");return JSON.parse(JSON.stringify(s))}const a={getAll(){return n.map(i)},findById(s){return n.find(c=>c.id===s)||null},register(s){const c=r(s),l=n.findIndex(d=>d.id===c.id);return l>=0?n[l]=c:n.push(c),this.getAll()},replaceAll(s){if(!Array.isArray(s))throw new Error("replaceAll expects an array of templates");n.length=0;for(const c of s)n.push(JSON.parse(JSON.stringify(c)));return this.getAll()}};Object.freeze(a),e.MonacoTemplateLibrary||Object.defineProperty(e,"MonacoTemplateLibrary",{value:a,configurable:!1,enumerable:!0,writable:!1})})(typeof window<"u"?window:globalThis);/*! js-yaml 4.1.0 https://github.com/nodeca/js-yaml @license MIT */(function(t,e){typeof exports=="object"&&typeof module<"u"?e(exports):typeof define=="function"&&define.amd?define(["exports"],e):e((t=typeof globalThis<"u"?globalThis:t||self).jsyaml={})})(this,(function(t){"use strict";function e(o){return o==null}var n={isNothing:e,isObject:function(o){return typeof o=="object"&&o!==null},toArray:function(o){return Array.isArray(o)?o:e(o)?[]:[o]},repeat:function(o,p){var g,I="";for(g=0;g<p;g+=1)I+=o;return I},isNegativeZero:function(o){return o===0&&Number.NEGATIVE_INFINITY===1/o},extend:function(o,p){var g,I,S,N;if(p)for(g=0,I=(N=Object.keys(p)).length;g<I;g+=1)o[S=N[g]]=p[S];return o}};function i(o,p){var g="",I=o.reason||"(unknown reason)";return o.mark?(o.mark.name&&(g+='in "'+o.mark.name+'" '),g+="("+(o.mark.line+1)+":"+(o.mark.column+1)+")",!p&&o.mark.snippet&&(g+=`

`+o.mark.snippet),I+" "+g):I}function r(o,p){Error.call(this),this.name="YAMLException",this.reason=o,this.mark=p,this.message=i(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r.prototype.toString=function(o){return this.name+": "+i(this,o)};var a=r;function s(o,p,g,I,S){var N="",L="",P=Math.floor(S/2)-1;return I-p>P&&(p=I-P+(N=" ... ").length),g-I>P&&(g=I+P-(L=" ...").length),{str:N+o.slice(p,g).replace(/\t/g,"\u2192")+L,pos:I-p+N.length}}function c(o,p){return n.repeat(" ",p-o.length)+o}var l=function(o,p){if(p=Object.create(p||null),!o.buffer)return null;p.maxLength||(p.maxLength=79),typeof p.indent!="number"&&(p.indent=1),typeof p.linesBefore!="number"&&(p.linesBefore=3),typeof p.linesAfter!="number"&&(p.linesAfter=2);for(var g,I=/\r?\n|\r|\0/g,S=[0],N=[],L=-1;g=I.exec(o.buffer);)N.push(g.index),S.push(g.index+g[0].length),o.position<=g.index&&L<0&&(L=S.length-2);L<0&&(L=S.length-1);var P,$,z="",V=Math.min(o.line+p.linesAfter,N.length).toString().length,Z=p.maxLength-(p.indent+V+3);for(P=1;P<=p.linesBefore&&!(L-P<0);P++)$=s(o.buffer,S[L-P],N[L-P],o.position-(S[L]-S[L-P]),Z),z=n.repeat(" ",p.indent)+c((o.line-P+1).toString(),V)+" | "+$.str+`
`+z;for($=s(o.buffer,S[L],N[L],o.position,Z),z+=n.repeat(" ",p.indent)+c((o.line+1).toString(),V)+" | "+$.str+`
`,z+=n.repeat("-",p.indent+V+3+$.pos)+`^
`,P=1;P<=p.linesAfter&&!(L+P>=N.length);P++)$=s(o.buffer,S[L+P],N[L+P],o.position-(S[L]-S[L+P]),Z),z+=n.repeat(" ",p.indent)+c((o.line+P+1).toString(),V)+" | "+$.str+`
`;return z.replace(/\n$/,"")},d=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],m=["scalar","sequence","mapping"],w=function(o,p){if(p=p||{},Object.keys(p).forEach((function(g){if(d.indexOf(g)===-1)throw new a('Unknown option "'+g+'" is met in definition of "'+o+'" YAML type.')})),this.options=p,this.tag=o,this.kind=p.kind||null,this.resolve=p.resolve||function(){return!0},this.construct=p.construct||function(g){return g},this.instanceOf=p.instanceOf||null,this.predicate=p.predicate||null,this.represent=p.represent||null,this.representName=p.representName||null,this.defaultStyle=p.defaultStyle||null,this.multi=p.multi||!1,this.styleAliases=(function(g){var I={};return g!==null&&Object.keys(g).forEach((function(S){g[S].forEach((function(N){I[String(N)]=S}))})),I})(p.styleAliases||null),m.indexOf(this.kind)===-1)throw new a('Unknown kind "'+this.kind+'" is specified for "'+o+'" YAML type.')};function E(o,p){var g=[];return o[p].forEach((function(I){var S=g.length;g.forEach((function(N,L){N.tag===I.tag&&N.kind===I.kind&&N.multi===I.multi&&(S=L)})),g[S]=I})),g}function M(o){return this.extend(o)}M.prototype.extend=function(o){var p=[],g=[];if(o instanceof w)g.push(o);else if(Array.isArray(o))g=g.concat(o);else{if(!o||!Array.isArray(o.implicit)&&!Array.isArray(o.explicit))throw new a("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");o.implicit&&(p=p.concat(o.implicit)),o.explicit&&(g=g.concat(o.explicit))}p.forEach((function(S){if(!(S instanceof w))throw new a("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(S.loadKind&&S.loadKind!=="scalar")throw new a("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(S.multi)throw new a("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")})),g.forEach((function(S){if(!(S instanceof w))throw new a("Specified list of YAML types (or a single Type object) contains a non-Type object.")}));var I=Object.create(M.prototype);return I.implicit=(this.implicit||[]).concat(p),I.explicit=(this.explicit||[]).concat(g),I.compiledImplicit=E(I,"implicit"),I.compiledExplicit=E(I,"explicit"),I.compiledTypeMap=(function(){var S,N,L={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}};function P($){$.multi?(L.multi[$.kind].push($),L.multi.fallback.push($)):L[$.kind][$.tag]=L.fallback[$.tag]=$}for(S=0,N=arguments.length;S<N;S+=1)arguments[S].forEach(P);return L})(I.compiledImplicit,I.compiledExplicit),I};var C=M,v=new w("tag:yaml.org,2002:str",{kind:"scalar",construct:function(o){return o!==null?o:""}}),h=new w("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(o){return o!==null?o:[]}}),y=new w("tag:yaml.org,2002:map",{kind:"mapping",construct:function(o){return o!==null?o:{}}}),A=new C({explicit:[v,h,y]}),R=new w("tag:yaml.org,2002:null",{kind:"scalar",resolve:function(o){if(o===null)return!0;var p=o.length;return p===1&&o==="~"||p===4&&(o==="null"||o==="Null"||o==="NULL")},construct:function(){return null},predicate:function(o){return o===null},represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"}),H=new w("tag:yaml.org,2002:bool",{kind:"scalar",resolve:function(o){if(o===null)return!1;var p=o.length;return p===4&&(o==="true"||o==="True"||o==="TRUE")||p===5&&(o==="false"||o==="False"||o==="FALSE")},construct:function(o){return o==="true"||o==="True"||o==="TRUE"},predicate:function(o){return Object.prototype.toString.call(o)==="[object Boolean]"},represent:{lowercase:function(o){return o?"true":"false"},uppercase:function(o){return o?"TRUE":"FALSE"},camelcase:function(o){return o?"True":"False"}},defaultStyle:"lowercase"});function X(o){return 48<=o&&o<=55}function _(o){return 48<=o&&o<=57}var de=new w("tag:yaml.org,2002:int",{kind:"scalar",resolve:function(o){if(o===null)return!1;var p,g,I=o.length,S=0,N=!1;if(!I)return!1;if((p=o[S])!=="-"&&p!=="+"||(p=o[++S]),p==="0"){if(S+1===I)return!0;if((p=o[++S])==="b"){for(S++;S<I;S++)if((p=o[S])!=="_"){if(p!=="0"&&p!=="1")return!1;N=!0}return N&&p!=="_"}if(p==="x"){for(S++;S<I;S++)if((p=o[S])!=="_"){if(!(48<=(g=o.charCodeAt(S))&&g<=57||65<=g&&g<=70||97<=g&&g<=102))return!1;N=!0}return N&&p!=="_"}if(p==="o"){for(S++;S<I;S++)if((p=o[S])!=="_"){if(!X(o.charCodeAt(S)))return!1;N=!0}return N&&p!=="_"}}if(p==="_")return!1;for(;S<I;S++)if((p=o[S])!=="_"){if(!_(o.charCodeAt(S)))return!1;N=!0}return!(!N||p==="_")},construct:function(o){var p,g=o,I=1;if(g.indexOf("_")!==-1&&(g=g.replace(/_/g,"")),(p=g[0])!=="-"&&p!=="+"||(p==="-"&&(I=-1),p=(g=g.slice(1))[0]),g==="0")return 0;if(p==="0"){if(g[1]==="b")return I*parseInt(g.slice(2),2);if(g[1]==="x")return I*parseInt(g.slice(2),16);if(g[1]==="o")return I*parseInt(g.slice(2),8)}return I*parseInt(g,10)},predicate:function(o){return Object.prototype.toString.call(o)==="[object Number]"&&o%1==0&&!n.isNegativeZero(o)},represent:{binary:function(o){return o>=0?"0b"+o.toString(2):"-0b"+o.toString(2).slice(1)},octal:function(o){return o>=0?"0o"+o.toString(8):"-0o"+o.toString(8).slice(1)},decimal:function(o){return o.toString(10)},hexadecimal:function(o){return o>=0?"0x"+o.toString(16).toUpperCase():"-0x"+o.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),be=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$"),x=/^[-+]?[0-9]+e/,j=new w("tag:yaml.org,2002:float",{kind:"scalar",resolve:function(o){return o!==null&&!(!be.test(o)||o[o.length-1]==="_")},construct:function(o){var p,g;return g=(p=o.replace(/_/g,"").toLowerCase())[0]==="-"?-1:1,"+-".indexOf(p[0])>=0&&(p=p.slice(1)),p===".inf"?g===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:p===".nan"?NaN:g*parseFloat(p,10)},predicate:function(o){return Object.prototype.toString.call(o)==="[object Number]"&&(o%1!=0||n.isNegativeZero(o))},represent:function(o,p){var g;if(isNaN(o))switch(p){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===o)switch(p){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===o)switch(p){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(n.isNegativeZero(o))return"-0.0";return g=o.toString(10),x.test(g)?g.replace("e",".e"):g},defaultStyle:"lowercase"}),F=A.extend({implicit:[R,H,de,j]}),D=F,re=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),J=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$"),se=new w("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:function(o){return o!==null&&(re.exec(o)!==null||J.exec(o)!==null)},construct:function(o){var p,g,I,S,N,L,P,$,z=0,V=null;if((p=re.exec(o))===null&&(p=J.exec(o)),p===null)throw new Error("Date resolve error");if(g=+p[1],I=+p[2]-1,S=+p[3],!p[4])return new Date(Date.UTC(g,I,S));if(N=+p[4],L=+p[5],P=+p[6],p[7]){for(z=p[7].slice(0,3);z.length<3;)z+="0";z=+z}return p[9]&&(V=6e4*(60*+p[10]+ +(p[11]||0)),p[9]==="-"&&(V=-V)),$=new Date(Date.UTC(g,I,S,N,L,P,z)),V&&$.setTime($.getTime()-V),$},instanceOf:Date,represent:function(o){return o.toISOString()}}),ye=new w("tag:yaml.org,2002:merge",{kind:"scalar",resolve:function(o){return o==="<<"||o===null}}),we=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`,je=new w("tag:yaml.org,2002:binary",{kind:"scalar",resolve:function(o){if(o===null)return!1;var p,g,I=0,S=o.length,N=we;for(g=0;g<S;g++)if(!((p=N.indexOf(o.charAt(g)))>64)){if(p<0)return!1;I+=6}return I%8==0},construct:function(o){var p,g,I=o.replace(/[\r\n=]/g,""),S=I.length,N=we,L=0,P=[];for(p=0;p<S;p++)p%4==0&&p&&(P.push(L>>16&255),P.push(L>>8&255),P.push(255&L)),L=L<<6|N.indexOf(I.charAt(p));return(g=S%4*6)===0?(P.push(L>>16&255),P.push(L>>8&255),P.push(255&L)):g===18?(P.push(L>>10&255),P.push(L>>2&255)):g===12&&P.push(L>>4&255),new Uint8Array(P)},predicate:function(o){return Object.prototype.toString.call(o)==="[object Uint8Array]"},represent:function(o){var p,g,I="",S=0,N=o.length,L=we;for(p=0;p<N;p++)p%3==0&&p&&(I+=L[S>>18&63],I+=L[S>>12&63],I+=L[S>>6&63],I+=L[63&S]),S=(S<<8)+o[p];return(g=N%3)===0?(I+=L[S>>18&63],I+=L[S>>12&63],I+=L[S>>6&63],I+=L[63&S]):g===2?(I+=L[S>>10&63],I+=L[S>>4&63],I+=L[S<<2&63],I+=L[64]):g===1&&(I+=L[S>>2&63],I+=L[S<<4&63],I+=L[64],I+=L[64]),I}}),_e=Object.prototype.hasOwnProperty,ct=Object.prototype.toString,Ve=new w("tag:yaml.org,2002:omap",{kind:"sequence",resolve:function(o){if(o===null)return!0;var p,g,I,S,N,L=[],P=o;for(p=0,g=P.length;p<g;p+=1){if(I=P[p],N=!1,ct.call(I)!=="[object Object]")return!1;for(S in I)if(_e.call(I,S)){if(N)return!1;N=!0}if(!N||L.indexOf(S)!==-1)return!1;L.push(S)}return!0},construct:function(o){return o!==null?o:[]}}),Rt=Object.prototype.toString,lt=new w("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:function(o){if(o===null)return!0;var p,g,I,S,N,L=o;for(N=new Array(L.length),p=0,g=L.length;p<g;p+=1){if(I=L[p],Rt.call(I)!=="[object Object]"||(S=Object.keys(I)).length!==1)return!1;N[p]=[S[0],I[S[0]]]}return!0},construct:function(o){if(o===null)return[];var p,g,I,S,N,L=o;for(N=new Array(L.length),p=0,g=L.length;p<g;p+=1)I=L[p],S=Object.keys(I),N[p]=[S[0],I[S[0]]];return N}}),vt=Object.prototype.hasOwnProperty,yt=new w("tag:yaml.org,2002:set",{kind:"mapping",resolve:function(o){if(o===null)return!0;var p,g=o;for(p in g)if(vt.call(g,p)&&g[p]!==null)return!1;return!0},construct:function(o){return o!==null?o:{}}}),dt=D.extend({implicit:[se,ye],explicit:[je,Ve,lt,yt]}),oe=Object.prototype.hasOwnProperty,Ce=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Pe=/[\x85\u2028\u2029]/,He=/[,\[\]\{\}]/,Ke=/^(?:!|!!|![a-z\-]+!)$/i,ut=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function Qe(o){return Object.prototype.toString.call(o)}function ve(o){return o===10||o===13}function Fe(o){return o===9||o===32}function Me(o){return o===9||o===32||o===10||o===13}function qe(o){return o===44||o===91||o===93||o===123||o===125}function Xe(o){var p;return 48<=o&&o<=57?o-48:97<=(p=32|o)&&p<=102?p-97+10:-1}function Ze(o){return o===48?"\0":o===97?"\x07":o===98?"\b":o===116||o===9?"	":o===110?`
`:o===118?"\v":o===102?"\f":o===114?"\r":o===101?"\x1B":o===32?" ":o===34?'"':o===47?"/":o===92?"\\":o===78?"\x85":o===95?"\xA0":o===76?"\u2028":o===80?"\u2029":""}function pt(o){return o<=65535?String.fromCharCode(o):String.fromCharCode(55296+(o-65536>>10),56320+(o-65536&1023))}for(var wt=new Array(256),St=new Array(256),Ue=0;Ue<256;Ue++)wt[Ue]=Ze(Ue)?1:0,St[Ue]=Ze(Ue);function Lt(o,p){this.input=o,this.filename=p.filename||null,this.schema=p.schema||dt,this.onWarning=p.onWarning||null,this.legacy=p.legacy||!1,this.json=p.json||!1,this.listener=p.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=o.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function Pt(o,p){var g={name:o.filename,buffer:o.input.slice(0,-1),position:o.position,line:o.line,column:o.position-o.lineStart};return g.snippet=l(g),new a(p,g)}function G(o,p){throw Pt(o,p)}function et(o,p){o.onWarning&&o.onWarning.call(null,Pt(o,p))}var bt={YAML:function(o,p,g){var I,S,N;o.version!==null&&G(o,"duplication of %YAML directive"),g.length!==1&&G(o,"YAML directive accepts exactly one argument"),(I=/^([0-9]+)\.([0-9]+)$/.exec(g[0]))===null&&G(o,"ill-formed argument of the YAML directive"),S=parseInt(I[1],10),N=parseInt(I[2],10),S!==1&&G(o,"unacceptable YAML version of the document"),o.version=g[0],o.checkLineBreaks=N<2,N!==1&&N!==2&&et(o,"unsupported YAML version of the document")},TAG:function(o,p,g){var I,S;g.length!==2&&G(o,"TAG directive accepts exactly two arguments"),I=g[0],S=g[1],Ke.test(I)||G(o,"ill-formed tag handle (first argument) of the TAG directive"),oe.call(o.tagMap,I)&&G(o,'there is a previously declared suffix for "'+I+'" tag handle'),ut.test(S)||G(o,"ill-formed tag prefix (second argument) of the TAG directive");try{S=decodeURIComponent(S)}catch{G(o,"tag prefix is malformed: "+S)}o.tagMap[I]=S}};function Be(o,p,g,I){var S,N,L,P;if(p<g){if(P=o.input.slice(p,g),I)for(S=0,N=P.length;S<N;S+=1)(L=P.charCodeAt(S))===9||32<=L&&L<=1114111||G(o,"expected valid JSON character");else Ce.test(P)&&G(o,"the stream contains non-printable characters");o.result+=P}}function Tt(o,p,g,I){var S,N,L,P;for(n.isObject(g)||G(o,"cannot merge mappings; the provided source object is unacceptable"),L=0,P=(S=Object.keys(g)).length;L<P;L+=1)N=S[L],oe.call(p,N)||(p[N]=g[N],I[N]=!0)}function tt(o,p,g,I,S,N,L,P,$){var z,V;if(Array.isArray(S))for(z=0,V=(S=Array.prototype.slice.call(S)).length;z<V;z+=1)Array.isArray(S[z])&&G(o,"nested arrays are not supported inside keys"),typeof S=="object"&&Qe(S[z])==="[object Object]"&&(S[z]="[object Object]");if(typeof S=="object"&&Qe(S)==="[object Object]"&&(S="[object Object]"),S=String(S),p===null&&(p={}),I==="tag:yaml.org,2002:merge")if(Array.isArray(N))for(z=0,V=N.length;z<V;z+=1)Tt(o,p,N[z],g);else Tt(o,p,N,g);else o.json||oe.call(g,S)||!oe.call(p,S)||(o.line=L||o.line,o.lineStart=P||o.lineStart,o.position=$||o.position,G(o,"duplicated mapping key")),S==="__proto__"?Object.defineProperty(p,S,{configurable:!0,enumerable:!0,writable:!0,value:N}):p[S]=N,delete g[S];return p}function nt(o){var p;(p=o.input.charCodeAt(o.position))===10?o.position++:p===13?(o.position++,o.input.charCodeAt(o.position)===10&&o.position++):G(o,"a line break is expected"),o.line+=1,o.lineStart=o.position,o.firstTabInLine=-1}function Ee(o,p,g){for(var I=0,S=o.input.charCodeAt(o.position);S!==0;){for(;Fe(S);)S===9&&o.firstTabInLine===-1&&(o.firstTabInLine=o.position),S=o.input.charCodeAt(++o.position);if(p&&S===35)do S=o.input.charCodeAt(++o.position);while(S!==10&&S!==13&&S!==0);if(!ve(S))break;for(nt(o),S=o.input.charCodeAt(o.position),I++,o.lineIndent=0;S===32;)o.lineIndent++,S=o.input.charCodeAt(++o.position)}return g!==-1&&I!==0&&o.lineIndent<g&&et(o,"deficient indentation"),I}function ft(o){var p,g=o.position;return!((p=o.input.charCodeAt(g))!==45&&p!==46||p!==o.input.charCodeAt(g+1)||p!==o.input.charCodeAt(g+2)||(g+=3,(p=o.input.charCodeAt(g))!==0&&!Me(p)))}function Ct(o,p){p===1?o.result+=" ":p>1&&(o.result+=n.repeat(`
`,p-1))}function kt(o,p){var g,I,S=o.tag,N=o.anchor,L=[],P=!1;if(o.firstTabInLine!==-1)return!1;for(o.anchor!==null&&(o.anchorMap[o.anchor]=L),I=o.input.charCodeAt(o.position);I!==0&&(o.firstTabInLine!==-1&&(o.position=o.firstTabInLine,G(o,"tab characters must not be used in indentation")),I===45)&&Me(o.input.charCodeAt(o.position+1));)if(P=!0,o.position++,Ee(o,!0,-1)&&o.lineIndent<=p)L.push(null),I=o.input.charCodeAt(o.position);else if(g=o.line,it(o,p,3,!1,!0),L.push(o.result),Ee(o,!0,-1),I=o.input.charCodeAt(o.position),(o.line===g||o.lineIndent>p)&&I!==0)G(o,"bad indentation of a sequence entry");else if(o.lineIndent<p)break;return!!P&&(o.tag=S,o.anchor=N,o.kind="sequence",o.result=L,!0)}function $t(o){var p,g,I,S,N=!1,L=!1;if((S=o.input.charCodeAt(o.position))!==33)return!1;if(o.tag!==null&&G(o,"duplication of a tag property"),(S=o.input.charCodeAt(++o.position))===60?(N=!0,S=o.input.charCodeAt(++o.position)):S===33?(L=!0,g="!!",S=o.input.charCodeAt(++o.position)):g="!",p=o.position,N){do S=o.input.charCodeAt(++o.position);while(S!==0&&S!==62);o.position<o.length?(I=o.input.slice(p,o.position),S=o.input.charCodeAt(++o.position)):G(o,"unexpected end of the stream within a verbatim tag")}else{for(;S!==0&&!Me(S);)S===33&&(L?G(o,"tag suffix cannot contain exclamation marks"):(g=o.input.slice(p-1,o.position+1),Ke.test(g)||G(o,"named tag handle cannot contain such characters"),L=!0,p=o.position+1)),S=o.input.charCodeAt(++o.position);I=o.input.slice(p,o.position),He.test(I)&&G(o,"tag suffix cannot contain flow indicator characters")}I&&!ut.test(I)&&G(o,"tag name cannot contain such characters: "+I);try{I=decodeURIComponent(I)}catch{G(o,"tag name is malformed: "+I)}return N?o.tag=I:oe.call(o.tagMap,g)?o.tag=o.tagMap[g]+I:g==="!"?o.tag="!"+I:g==="!!"?o.tag="tag:yaml.org,2002:"+I:G(o,'undeclared tag handle "'+g+'"'),!0}function xt(o){var p,g;if((g=o.input.charCodeAt(o.position))!==38)return!1;for(o.anchor!==null&&G(o,"duplication of an anchor property"),g=o.input.charCodeAt(++o.position),p=o.position;g!==0&&!Me(g)&&!qe(g);)g=o.input.charCodeAt(++o.position);return o.position===p&&G(o,"name of an anchor node must contain at least one character"),o.anchor=o.input.slice(p,o.position),!0}function it(o,p,g,I,S){var N,L,P,$,z,V,Z,Se,W,me=1,fe=!1,he=!1;if(o.listener!==null&&o.listener("open",o),o.tag=null,o.anchor=null,o.kind=null,o.result=null,N=L=P=g===4||g===3,I&&Ee(o,!0,-1)&&(fe=!0,o.lineIndent>p?me=1:o.lineIndent===p?me=0:o.lineIndent<p&&(me=-1)),me===1)for(;$t(o)||xt(o);)Ee(o,!0,-1)?(fe=!0,P=N,o.lineIndent>p?me=1:o.lineIndent===p?me=0:o.lineIndent<p&&(me=-1)):P=!1;if(P&&(P=fe||S),me!==1&&g!==4||(Se=g===1||g===2?p:p+1,W=o.position-o.lineStart,me===1?P&&(kt(o,W)||(function(f,te,ee){var K,ae,Y,ue,ce,pe,ge,ie=f.tag,Ie=f.anchor,Ae={},Ne=Object.create(null),xe=null,De=null,mt=null,ke=!1,It=!1;if(f.firstTabInLine!==-1)return!1;for(f.anchor!==null&&(f.anchorMap[f.anchor]=Ae),ge=f.input.charCodeAt(f.position);ge!==0;){if(ke||f.firstTabInLine===-1||(f.position=f.firstTabInLine,G(f,"tab characters must not be used in indentation")),K=f.input.charCodeAt(f.position+1),Y=f.line,ge!==63&&ge!==58||!Me(K)){if(ue=f.line,ce=f.lineStart,pe=f.position,!it(f,ee,2,!1,!0))break;if(f.line===Y){for(ge=f.input.charCodeAt(f.position);Fe(ge);)ge=f.input.charCodeAt(++f.position);if(ge===58)Me(ge=f.input.charCodeAt(++f.position))||G(f,"a whitespace character is expected after the key-value separator within a block mapping"),ke&&(tt(f,Ae,Ne,xe,De,null,ue,ce,pe),xe=De=mt=null),It=!0,ke=!1,ae=!1,xe=f.tag,De=f.result;else{if(!It)return f.tag=ie,f.anchor=Ie,!0;G(f,"can not read an implicit mapping pair; a colon is missed")}}else{if(!It)return f.tag=ie,f.anchor=Ie,!0;G(f,"can not read a block mapping entry; a multiline key may not be an implicit key")}}else ge===63?(ke&&(tt(f,Ae,Ne,xe,De,null,ue,ce,pe),xe=De=mt=null),It=!0,ke=!0,ae=!0):ke?(ke=!1,ae=!0):G(f,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),f.position+=1,ge=K;if((f.line===Y||f.lineIndent>te)&&(ke&&(ue=f.line,ce=f.lineStart,pe=f.position),it(f,te,4,!0,ae)&&(ke?De=f.result:mt=f.result),ke||(tt(f,Ae,Ne,xe,De,mt,ue,ce,pe),xe=De=mt=null),Ee(f,!0,-1),ge=f.input.charCodeAt(f.position)),(f.line===Y||f.lineIndent>te)&&ge!==0)G(f,"bad indentation of a mapping entry");else if(f.lineIndent<te)break}return ke&&tt(f,Ae,Ne,xe,De,null,ue,ce,pe),It&&(f.tag=ie,f.anchor=Ie,f.kind="mapping",f.result=Ae),It})(o,W,Se))||(function(f,te){var ee,K,ae,Y,ue,ce,pe,ge,ie,Ie,Ae,Ne,xe=!0,De=f.tag,mt=f.anchor,ke=Object.create(null);if((Ne=f.input.charCodeAt(f.position))===91)ue=93,ge=!1,Y=[];else{if(Ne!==123)return!1;ue=125,ge=!0,Y={}}for(f.anchor!==null&&(f.anchorMap[f.anchor]=Y),Ne=f.input.charCodeAt(++f.position);Ne!==0;){if(Ee(f,!0,te),(Ne=f.input.charCodeAt(f.position))===ue)return f.position++,f.tag=De,f.anchor=mt,f.kind=ge?"mapping":"sequence",f.result=Y,!0;xe?Ne===44&&G(f,"expected the node content, but found ','"):G(f,"missed comma between flow collection entries"),Ae=null,ce=pe=!1,Ne===63&&Me(f.input.charCodeAt(f.position+1))&&(ce=pe=!0,f.position++,Ee(f,!0,te)),ee=f.line,K=f.lineStart,ae=f.position,it(f,te,1,!1,!0),Ie=f.tag,ie=f.result,Ee(f,!0,te),Ne=f.input.charCodeAt(f.position),!pe&&f.line!==ee||Ne!==58||(ce=!0,Ne=f.input.charCodeAt(++f.position),Ee(f,!0,te),it(f,te,1,!1,!0),Ae=f.result),ge?tt(f,Y,ke,Ie,ie,Ae,ee,K,ae):ce?Y.push(tt(f,null,ke,Ie,ie,Ae,ee,K,ae)):Y.push(ie),Ee(f,!0,te),(Ne=f.input.charCodeAt(f.position))===44?(xe=!0,Ne=f.input.charCodeAt(++f.position)):xe=!1}G(f,"unexpected end of the stream within a flow collection")})(o,Se)?he=!0:(L&&(function(f,te){var ee,K,ae,Y,ue,ce=1,pe=!1,ge=!1,ie=te,Ie=0,Ae=!1;if((Y=f.input.charCodeAt(f.position))===124)K=!1;else{if(Y!==62)return!1;K=!0}for(f.kind="scalar",f.result="";Y!==0;)if((Y=f.input.charCodeAt(++f.position))===43||Y===45)ce===1?ce=Y===43?3:2:G(f,"repeat of a chomping mode identifier");else{if(!((ae=48<=(ue=Y)&&ue<=57?ue-48:-1)>=0))break;ae===0?G(f,"bad explicit indentation width of a block scalar; it cannot be less than one"):ge?G(f,"repeat of an indentation width identifier"):(ie=te+ae-1,ge=!0)}if(Fe(Y)){do Y=f.input.charCodeAt(++f.position);while(Fe(Y));if(Y===35)do Y=f.input.charCodeAt(++f.position);while(!ve(Y)&&Y!==0)}for(;Y!==0;){for(nt(f),f.lineIndent=0,Y=f.input.charCodeAt(f.position);(!ge||f.lineIndent<ie)&&Y===32;)f.lineIndent++,Y=f.input.charCodeAt(++f.position);if(!ge&&f.lineIndent>ie&&(ie=f.lineIndent),ve(Y))Ie++;else{if(f.lineIndent<ie){ce===3?f.result+=n.repeat(`
`,pe?1+Ie:Ie):ce===1&&pe&&(f.result+=`
`);break}for(K?Fe(Y)?(Ae=!0,f.result+=n.repeat(`
`,pe?1+Ie:Ie)):Ae?(Ae=!1,f.result+=n.repeat(`
`,Ie+1)):Ie===0?pe&&(f.result+=" "):f.result+=n.repeat(`
`,Ie):f.result+=n.repeat(`
`,pe?1+Ie:Ie),pe=!0,ge=!0,Ie=0,ee=f.position;!ve(Y)&&Y!==0;)Y=f.input.charCodeAt(++f.position);Be(f,ee,f.position,!1)}}return!0})(o,Se)||(function(f,te){var ee,K,ae;if((ee=f.input.charCodeAt(f.position))!==39)return!1;for(f.kind="scalar",f.result="",f.position++,K=ae=f.position;(ee=f.input.charCodeAt(f.position))!==0;)if(ee===39){if(Be(f,K,f.position,!0),(ee=f.input.charCodeAt(++f.position))!==39)return!0;K=f.position,f.position++,ae=f.position}else ve(ee)?(Be(f,K,ae,!0),Ct(f,Ee(f,!1,te)),K=ae=f.position):f.position===f.lineStart&&ft(f)?G(f,"unexpected end of the document within a single quoted scalar"):(f.position++,ae=f.position);G(f,"unexpected end of the stream within a single quoted scalar")})(o,Se)||(function(f,te){var ee,K,ae,Y,ue,ce,pe;if((ce=f.input.charCodeAt(f.position))!==34)return!1;for(f.kind="scalar",f.result="",f.position++,ee=K=f.position;(ce=f.input.charCodeAt(f.position))!==0;){if(ce===34)return Be(f,ee,f.position,!0),f.position++,!0;if(ce===92){if(Be(f,ee,f.position,!0),ve(ce=f.input.charCodeAt(++f.position)))Ee(f,!1,te);else if(ce<256&&wt[ce])f.result+=St[ce],f.position++;else if((ue=(pe=ce)===120?2:pe===117?4:pe===85?8:0)>0){for(ae=ue,Y=0;ae>0;ae--)(ue=Xe(ce=f.input.charCodeAt(++f.position)))>=0?Y=(Y<<4)+ue:G(f,"expected hexadecimal character");f.result+=pt(Y),f.position++}else G(f,"unknown escape sequence");ee=K=f.position}else ve(ce)?(Be(f,ee,K,!0),Ct(f,Ee(f,!1,te)),ee=K=f.position):f.position===f.lineStart&&ft(f)?G(f,"unexpected end of the document within a double quoted scalar"):(f.position++,K=f.position)}G(f,"unexpected end of the stream within a double quoted scalar")})(o,Se)?he=!0:(function(f){var te,ee,K;if((K=f.input.charCodeAt(f.position))!==42)return!1;for(K=f.input.charCodeAt(++f.position),te=f.position;K!==0&&!Me(K)&&!qe(K);)K=f.input.charCodeAt(++f.position);return f.position===te&&G(f,"name of an alias node must contain at least one character"),ee=f.input.slice(te,f.position),oe.call(f.anchorMap,ee)||G(f,'unidentified alias "'+ee+'"'),f.result=f.anchorMap[ee],Ee(f,!0,-1),!0})(o)?(he=!0,o.tag===null&&o.anchor===null||G(o,"alias node should not have any properties")):(function(f,te,ee){var K,ae,Y,ue,ce,pe,ge,ie,Ie=f.kind,Ae=f.result;if(Me(ie=f.input.charCodeAt(f.position))||qe(ie)||ie===35||ie===38||ie===42||ie===33||ie===124||ie===62||ie===39||ie===34||ie===37||ie===64||ie===96||(ie===63||ie===45)&&(Me(K=f.input.charCodeAt(f.position+1))||ee&&qe(K)))return!1;for(f.kind="scalar",f.result="",ae=Y=f.position,ue=!1;ie!==0;){if(ie===58){if(Me(K=f.input.charCodeAt(f.position+1))||ee&&qe(K))break}else if(ie===35){if(Me(f.input.charCodeAt(f.position-1)))break}else{if(f.position===f.lineStart&&ft(f)||ee&&qe(ie))break;if(ve(ie)){if(ce=f.line,pe=f.lineStart,ge=f.lineIndent,Ee(f,!1,-1),f.lineIndent>=te){ue=!0,ie=f.input.charCodeAt(f.position);continue}f.position=Y,f.line=ce,f.lineStart=pe,f.lineIndent=ge;break}}ue&&(Be(f,ae,Y,!1),Ct(f,f.line-ce),ae=Y=f.position,ue=!1),Fe(ie)||(Y=f.position+1),ie=f.input.charCodeAt(++f.position)}return Be(f,ae,Y,!1),!!f.result||(f.kind=Ie,f.result=Ae,!1)})(o,Se,g===1)&&(he=!0,o.tag===null&&(o.tag="?")),o.anchor!==null&&(o.anchorMap[o.anchor]=o.result)):me===0&&(he=P&&kt(o,W))),o.tag===null)o.anchor!==null&&(o.anchorMap[o.anchor]=o.result);else if(o.tag==="?"){for(o.result!==null&&o.kind!=="scalar"&&G(o,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+o.kind+'"'),$=0,z=o.implicitTypes.length;$<z;$+=1)if((Z=o.implicitTypes[$]).resolve(o.result)){o.result=Z.construct(o.result),o.tag=Z.tag,o.anchor!==null&&(o.anchorMap[o.anchor]=o.result);break}}else if(o.tag!=="!"){if(oe.call(o.typeMap[o.kind||"fallback"],o.tag))Z=o.typeMap[o.kind||"fallback"][o.tag];else for(Z=null,$=0,z=(V=o.typeMap.multi[o.kind||"fallback"]).length;$<z;$+=1)if(o.tag.slice(0,V[$].tag.length)===V[$].tag){Z=V[$];break}Z||G(o,"unknown tag !<"+o.tag+">"),o.result!==null&&Z.kind!==o.kind&&G(o,"unacceptable node kind for !<"+o.tag+'> tag; it should be "'+Z.kind+'", not "'+o.kind+'"'),Z.resolve(o.result,o.tag)?(o.result=Z.construct(o.result,o.tag),o.anchor!==null&&(o.anchorMap[o.anchor]=o.result)):G(o,"cannot resolve a node with !<"+o.tag+"> explicit tag")}return o.listener!==null&&o.listener("close",o),o.tag!==null||o.anchor!==null||he}function Dt(o){var p,g,I,S,N=o.position,L=!1;for(o.version=null,o.checkLineBreaks=o.legacy,o.tagMap=Object.create(null),o.anchorMap=Object.create(null);(S=o.input.charCodeAt(o.position))!==0&&(Ee(o,!0,-1),S=o.input.charCodeAt(o.position),!(o.lineIndent>0||S!==37));){for(L=!0,S=o.input.charCodeAt(++o.position),p=o.position;S!==0&&!Me(S);)S=o.input.charCodeAt(++o.position);for(I=[],(g=o.input.slice(p,o.position)).length<1&&G(o,"directive name must not be less than one character in length");S!==0;){for(;Fe(S);)S=o.input.charCodeAt(++o.position);if(S===35){do S=o.input.charCodeAt(++o.position);while(S!==0&&!ve(S));break}if(ve(S))break;for(p=o.position;S!==0&&!Me(S);)S=o.input.charCodeAt(++o.position);I.push(o.input.slice(p,o.position))}S!==0&&nt(o),oe.call(bt,g)?bt[g](o,g,I):et(o,'unknown document directive "'+g+'"')}Ee(o,!0,-1),o.lineIndent===0&&o.input.charCodeAt(o.position)===45&&o.input.charCodeAt(o.position+1)===45&&o.input.charCodeAt(o.position+2)===45?(o.position+=3,Ee(o,!0,-1)):L&&G(o,"directives end mark is expected"),it(o,o.lineIndent-1,4,!1,!0),Ee(o,!0,-1),o.checkLineBreaks&&Pe.test(o.input.slice(N,o.position))&&et(o,"non-ASCII line breaks are interpreted as content"),o.documents.push(o.result),o.position===o.lineStart&&ft(o)?o.input.charCodeAt(o.position)===46&&(o.position+=3,Ee(o,!0,-1)):o.position<o.length-1&&G(o,"end of the stream or a document separator is expected")}function Te(o,p){p=p||{},(o=String(o)).length!==0&&(o.charCodeAt(o.length-1)!==10&&o.charCodeAt(o.length-1)!==13&&(o+=`
`),o.charCodeAt(0)===65279&&(o=o.slice(1)));var g=new Lt(o,p),I=o.indexOf("\0");for(I!==-1&&(g.position=I,G(g,"null byte is not allowed in input")),g.input+="\0";g.input.charCodeAt(g.position)===32;)g.lineIndent+=1,g.position+=1;for(;g.position<g.length-1;)Dt(g);return g.documents}var At={loadAll:function(o,p,g){p!==null&&typeof p=="object"&&g===void 0&&(g=p,p=null);var I=Te(o,g);if(typeof p!="function")return I;for(var S=0,N=I.length;S<N;S+=1)p(I[S])},load:function(o,p){var g=Te(o,p);if(g.length!==0){if(g.length===1)return g[0];throw new a("expected a single document in the stream, but found more")}}},Ft=Object.prototype.toString,Nt=Object.prototype.hasOwnProperty,u=65279,b={0:"\\0",7:"\\a",8:"\\b",9:"\\t",10:"\\n",11:"\\v",12:"\\f",13:"\\r",27:"\\e",34:'\\"',92:"\\\\",133:"\\N",160:"\\_",8232:"\\L",8233:"\\P"},T=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],O=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function k(o){var p,g,I;if(p=o.toString(16).toUpperCase(),o<=255)g="x",I=2;else if(o<=65535)g="u",I=4;else{if(!(o<=4294967295))throw new a("code point within a string may not be greater than 0xFFFFFFFF");g="U",I=8}return"\\"+g+n.repeat("0",I-p.length)+p}function q(o){this.schema=o.schema||dt,this.indent=Math.max(1,o.indent||2),this.noArrayIndent=o.noArrayIndent||!1,this.skipInvalid=o.skipInvalid||!1,this.flowLevel=n.isNothing(o.flowLevel)?-1:o.flowLevel,this.styleMap=(function(p,g){var I,S,N,L,P,$,z;if(g===null)return{};for(I={},N=0,L=(S=Object.keys(g)).length;N<L;N+=1)P=S[N],$=String(g[P]),P.slice(0,2)==="!!"&&(P="tag:yaml.org,2002:"+P.slice(2)),(z=p.compiledTypeMap.fallback[P])&&Nt.call(z.styleAliases,$)&&($=z.styleAliases[$]),I[P]=$;return I})(this.schema,o.styles||null),this.sortKeys=o.sortKeys||!1,this.lineWidth=o.lineWidth||80,this.noRefs=o.noRefs||!1,this.noCompatMode=o.noCompatMode||!1,this.condenseFlow=o.condenseFlow||!1,this.quotingType=o.quotingType==='"'?2:1,this.forceQuotes=o.forceQuotes||!1,this.replacer=typeof o.replacer=="function"?o.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function B(o,p){for(var g,I=n.repeat(" ",p),S=0,N=-1,L="",P=o.length;S<P;)(N=o.indexOf(`
`,S))===-1?(g=o.slice(S),S=P):(g=o.slice(S,N+1),S=N+1),g.length&&g!==`
`&&(L+=I),L+=g;return L}function Q(o,p){return`
`+n.repeat(" ",o.indent*p)}function le(o){return o===32||o===9}function U(o){return 32<=o&&o<=126||161<=o&&o<=55295&&o!==8232&&o!==8233||57344<=o&&o<=65533&&o!==u||65536<=o&&o<=1114111}function ne(o){return U(o)&&o!==u&&o!==13&&o!==10}function Oe(o,p,g){var I=ne(o),S=I&&!le(o);return(g?I:I&&o!==44&&o!==91&&o!==93&&o!==123&&o!==125)&&o!==35&&!(p===58&&!S)||ne(p)&&!le(p)&&o===35||p===58&&S}function $e(o,p){var g,I=o.charCodeAt(p);return I>=55296&&I<=56319&&p+1<o.length&&(g=o.charCodeAt(p+1))>=56320&&g<=57343?1024*(I-55296)+g-56320+65536:I}function rt(o){return/^\n* /.test(o)}function Re(o,p,g,I,S,N,L,P){var $,z,V=0,Z=null,Se=!1,W=!1,me=I!==-1,fe=-1,he=U(z=$e(o,0))&&z!==u&&!le(z)&&z!==45&&z!==63&&z!==58&&z!==44&&z!==91&&z!==93&&z!==123&&z!==125&&z!==35&&z!==38&&z!==42&&z!==33&&z!==124&&z!==61&&z!==62&&z!==39&&z!==34&&z!==37&&z!==64&&z!==96&&(function(f){return!le(f)&&f!==58})($e(o,o.length-1));if(p||L)for($=0;$<o.length;V>=65536?$+=2:$++){if(!U(V=$e(o,$)))return 5;he=he&&Oe(V,Z,P),Z=V}else{for($=0;$<o.length;V>=65536?$+=2:$++){if((V=$e(o,$))===10)Se=!0,me&&(W=W||$-fe-1>I&&o[fe+1]!==" ",fe=$);else if(!U(V))return 5;he=he&&Oe(V,Z,P),Z=V}W=W||me&&$-fe-1>I&&o[fe+1]!==" "}return Se||W?g>9&&rt(o)?5:L?N===2?5:2:W?4:3:!he||L||S(o)?N===2?5:2:1}function Et(o,p,g,I,S){o.dump=(function(){if(p.length===0)return o.quotingType===2?'""':"''";if(!o.noCompatMode&&(T.indexOf(p)!==-1||O.test(p)))return o.quotingType===2?'"'+p+'"':"'"+p+"'";var N=o.indent*Math.max(1,g),L=o.lineWidth===-1?-1:Math.max(Math.min(o.lineWidth,40),o.lineWidth-N),P=I||o.flowLevel>-1&&g>=o.flowLevel;switch(Re(p,P,o.indent,L,(function($){return(function(z,V){var Z,Se;for(Z=0,Se=z.implicitTypes.length;Z<Se;Z+=1)if(z.implicitTypes[Z].resolve(V))return!0;return!1})(o,$)}),o.quotingType,o.forceQuotes&&!I,S)){case 1:return p;case 2:return"'"+p.replace(/'/g,"''")+"'";case 3:return"|"+ze(p,o.indent)+ot(B(p,N));case 4:return">"+ze(p,o.indent)+ot(B((function($,z){for(var V,Z,Se=/(\n+)([^\n]*)/g,W=(fe=$.indexOf(`
`),fe=fe!==-1?fe:$.length,Se.lastIndex=fe,at($.slice(0,fe),z)),me=$[0]===`
`||$[0]===" ",fe;Z=Se.exec($);){var he=Z[1],f=Z[2];V=f[0]===" ",W+=he+(me||V||f===""?"":`
`)+at(f,z),me=V}return W})(p,L),N));case 5:return'"'+(function($){for(var z,V="",Z=0,Se=0;Se<$.length;Z>=65536?Se+=2:Se++)Z=$e($,Se),!(z=b[Z])&&U(Z)?(V+=$[Se],Z>=65536&&(V+=$[Se+1])):V+=z||k(Z);return V})(p)+'"';default:throw new a("impossible error: invalid scalar style")}})()}function ze(o,p){var g=rt(o)?String(p):"",I=o[o.length-1]===`
`;return g+(I&&(o[o.length-2]===`
`||o===`
`)?"+":I?"":"-")+`
`}function ot(o){return o[o.length-1]===`
`?o.slice(0,-1):o}function at(o,p){if(o===""||o[0]===" ")return o;for(var g,I,S=/ [^ ]/g,N=0,L=0,P=0,$="";g=S.exec(o);)(P=g.index)-N>p&&(I=L>N?L:P,$+=`
`+o.slice(N,I),N=I+1),L=P;return $+=`
`,o.length-N>p&&L>N?$+=o.slice(N,L)+`
`+o.slice(L+1):$+=o.slice(N),$.slice(1)}function qt(o,p,g,I){var S,N,L,P="",$=o.tag;for(S=0,N=g.length;S<N;S+=1)L=g[S],o.replacer&&(L=o.replacer.call(g,String(S),L)),(Je(o,p+1,L,!0,!0,!1,!0)||L===void 0&&Je(o,p+1,null,!0,!0,!1,!0))&&(I&&P===""||(P+=Q(o,p)),o.dump&&o.dump.charCodeAt(0)===10?P+="-":P+="- ",P+=o.dump);o.tag=$,o.dump=P||"[]"}function zt(o,p,g){var I,S,N,L,P,$;for(N=0,L=(S=g?o.explicitTypes:o.implicitTypes).length;N<L;N+=1)if(((P=S[N]).instanceOf||P.predicate)&&(!P.instanceOf||typeof p=="object"&&p instanceof P.instanceOf)&&(!P.predicate||P.predicate(p))){if(g?P.multi&&P.representName?o.tag=P.representName(p):o.tag=P.tag:o.tag="?",P.represent){if($=o.styleMap[P.tag]||P.defaultStyle,Ft.call(P.represent)==="[object Function]")I=P.represent(p,$);else{if(!Nt.call(P.represent,$))throw new a("!<"+P.tag+'> tag resolver accepts not "'+$+'" style');I=P.represent[$](p,$)}o.dump=I}return!0}return!1}function Je(o,p,g,I,S,N,L){o.tag=null,o.dump=g,zt(o,g,!1)||zt(o,g,!0);var P,$=Ft.call(o.dump),z=I;I&&(I=o.flowLevel<0||o.flowLevel>p);var V,Z,Se=$==="[object Object]"||$==="[object Array]";if(Se&&(Z=(V=o.duplicates.indexOf(g))!==-1),(o.tag!==null&&o.tag!=="?"||Z||o.indent!==2&&p>0)&&(S=!1),Z&&o.usedDuplicates[V])o.dump="*ref_"+V;else{if(Se&&Z&&!o.usedDuplicates[V]&&(o.usedDuplicates[V]=!0),$==="[object Object]")I&&Object.keys(o.dump).length!==0?((function(W,me,fe,he){var f,te,ee,K,ae,Y,ue="",ce=W.tag,pe=Object.keys(fe);if(W.sortKeys===!0)pe.sort();else if(typeof W.sortKeys=="function")pe.sort(W.sortKeys);else if(W.sortKeys)throw new a("sortKeys must be a boolean or a function");for(f=0,te=pe.length;f<te;f+=1)Y="",he&&ue===""||(Y+=Q(W,me)),K=fe[ee=pe[f]],W.replacer&&(K=W.replacer.call(fe,ee,K)),Je(W,me+1,ee,!0,!0,!0)&&((ae=W.tag!==null&&W.tag!=="?"||W.dump&&W.dump.length>1024)&&(W.dump&&W.dump.charCodeAt(0)===10?Y+="?":Y+="? "),Y+=W.dump,ae&&(Y+=Q(W,me)),Je(W,me+1,K,!0,ae)&&(W.dump&&W.dump.charCodeAt(0)===10?Y+=":":Y+=": ",ue+=Y+=W.dump));W.tag=ce,W.dump=ue||"{}"})(o,p,o.dump,S),Z&&(o.dump="&ref_"+V+o.dump)):((function(W,me,fe){var he,f,te,ee,K,ae="",Y=W.tag,ue=Object.keys(fe);for(he=0,f=ue.length;he<f;he+=1)K="",ae!==""&&(K+=", "),W.condenseFlow&&(K+='"'),ee=fe[te=ue[he]],W.replacer&&(ee=W.replacer.call(fe,te,ee)),Je(W,me,te,!1,!1)&&(W.dump.length>1024&&(K+="? "),K+=W.dump+(W.condenseFlow?'"':"")+":"+(W.condenseFlow?"":" "),Je(W,me,ee,!1,!1)&&(ae+=K+=W.dump));W.tag=Y,W.dump="{"+ae+"}"})(o,p,o.dump),Z&&(o.dump="&ref_"+V+" "+o.dump));else if($==="[object Array]")I&&o.dump.length!==0?(o.noArrayIndent&&!L&&p>0?qt(o,p-1,o.dump,S):qt(o,p,o.dump,S),Z&&(o.dump="&ref_"+V+o.dump)):((function(W,me,fe){var he,f,te,ee="",K=W.tag;for(he=0,f=fe.length;he<f;he+=1)te=fe[he],W.replacer&&(te=W.replacer.call(fe,String(he),te)),(Je(W,me,te,!1,!1)||te===void 0&&Je(W,me,null,!1,!1))&&(ee!==""&&(ee+=","+(W.condenseFlow?"":" ")),ee+=W.dump);W.tag=K,W.dump="["+ee+"]"})(o,p,o.dump),Z&&(o.dump="&ref_"+V+" "+o.dump));else{if($!=="[object String]"){if($==="[object Undefined]"||o.skipInvalid)return!1;throw new a("unacceptable kind of an object to dump "+$)}o.tag!=="?"&&Et(o,o.dump,p,N,z)}o.tag!==null&&o.tag!=="?"&&(P=encodeURI(o.tag[0]==="!"?o.tag.slice(1):o.tag).replace(/!/g,"%21"),P=o.tag[0]==="!"?"!"+P:P.slice(0,18)==="tag:yaml.org,2002:"?"!!"+P.slice(18):"!<"+P+">",o.dump=P+" "+o.dump)}return!0}function ln(o,p){var g,I,S=[],N=[];for(Ut(o,S,N),g=0,I=N.length;g<I;g+=1)p.duplicates.push(S[N[g]]);p.usedDuplicates=new Array(I)}function Ut(o,p,g){var I,S,N;if(o!==null&&typeof o=="object")if((S=p.indexOf(o))!==-1)g.indexOf(S)===-1&&g.push(S);else if(p.push(o),Array.isArray(o))for(S=0,N=o.length;S<N;S+=1)Ut(o[S],p,g);else for(S=0,N=(I=Object.keys(o)).length;S<N;S+=1)Ut(o[I[S]],p,g)}function Bt(o,p){return function(){throw new Error("Function yaml."+o+" is removed in js-yaml 4. Use yaml."+p+" instead, which is now safe by default.")}}var Jt=w,Wt=C,Yt=A,Gt=F,Vt=D,Kt=dt,Qt=At.load,Xt=At.loadAll,Zt=function(o,p){var g=new q(p=p||{});g.noRefs||ln(o,g);var I=o;return g.replacer&&(I=g.replacer.call({"":I},"",I)),Je(g,0,I,!0,!0)?g.dump+`
`:""},en=a,tn={binary:je,float:j,map:y,null:R,pairs:lt,set:yt,timestamp:se,bool:H,int:de,merge:ye,omap:Ve,seq:h,str:v},nn=Bt("safeLoad","load"),rn=Bt("safeLoadAll","loadAll"),on=Bt("safeDump","dump"),dn={Type:Jt,Schema:Wt,FAILSAFE_SCHEMA:Yt,JSON_SCHEMA:Gt,CORE_SCHEMA:Vt,DEFAULT_SCHEMA:Kt,load:Qt,loadAll:Xt,dump:Zt,YAMLException:en,types:tn,safeLoad:nn,safeLoadAll:rn,safeDump:on};t.CORE_SCHEMA=Vt,t.DEFAULT_SCHEMA=Kt,t.FAILSAFE_SCHEMA=Yt,t.JSON_SCHEMA=Gt,t.Schema=Wt,t.Type=Jt,t.YAMLException=en,t.default=dn,t.dump=Zt,t.load=Qt,t.loadAll=Xt,t.safeDump=on,t.safeLoad=nn,t.safeLoadAll=rn,t.types=tn,Object.defineProperty(t,"__esModule",{value:!0})})),window.SELECTORS={PAGES:{MAPPINGS:"mappings-page",REQUESTS:"requests-page",SCENARIOS:"scenarios-page","IMPORT-EXPORT":"import-export-page",RECORDING:"recording-page",SETTINGS:"settings-page"},REQUEST_FILTERS:{METHOD:"req-filter-method",STATUS:"req-filter-status",URL:"req-filter-url",DATE_FROM:"req-filter-from",DATE_TO:"req-filter-to",QUICK:"req-filter-quick"},MAPPING_FILTERS:{QUERY:"filter-query"},LISTS:{MAPPINGS:"mappings-list",REQUESTS:"requests-list",SCENARIOS:"scenarios-list"},EMPTY:{MAPPINGS:"mappings-empty",REQUESTS:"requests-empty"},UI:{STATS:"stats",SEARCH_FILTERS:"search-filters",UPTIME:"uptime",DATA_SOURCE_INDICATOR:"data-source-indicator",REQUESTS_SOURCE_INDICATOR:"requests-source-indicator"},LOADING:{MAPPINGS:"mappings-loading",REQUESTS:"requests-loading"},COUNTERS:{MAPPINGS:"mappings-count",REQUESTS:"requests-count"},CONNECTION:{SETUP:"connection-setup",HOST:"wiremock-host",PORT:"wiremock-port",CONNECT_BTN:"connect-btn",STATUS_DOT:"status-dot",STATUS_TEXT:"status-text",UPTIME:"uptime"},MODAL:{FORM:"mapping-form",ID:"mapping-id",TITLE:"modal-title"},FORM_FIELDS:{METHOD:"mapping-method",URL:"mapping-url",STATUS:"mapping-status",HEADERS:"mapping-headers",BODY:"mapping-body",PRIORITY:"mapping-priority",NAME:"mapping-name"},BUTTONS:{ADD_MAPPING:"add-mapping-btn",START_RECORDING:"start-recording-btn"},RECORDING:{URL:"recording-url",CAPTURE_HEADERS:"capture-headers",CAPTURE_BODY:"capture-body",URL_FILTER:"url-filter",INDICATOR:"recording-indicator",TARGET:"recording-target",COUNT:"recording-count",STOP_BTN:"stop-recording-btn"},SETTINGS:{HOST:"settings-host",PORT:"settings-port",TIMEOUT:"settings-timeout",AUTO_REFRESH:"auto-refresh",THEME:"theme-select",CUSTOM_HEADERS:"custom-headers",CACHE_ENABLED:"cache-enabled"},IMPORT:{FILE:"import-file",DISPLAY:"file-display",ACTIONS:"import-actions",RESULT:"import-result",MODE:"import-mode"},EXPORT:{FORMAT:"export-format",RESULT:"export-result"},STATS:{TOTAL_MAPPINGS:"total-mappings",TOTAL_REQUESTS:"total-requests"},HEALTH:{INDICATOR:"health-indicator"}},window.Icons={render(t,e={}){if(!t)return"";const n=["icon",`icon-${t}`];return e.className&&n.push(e.className),`<svg class="${n.join(" ")}" aria-hidden="true" focusable="false"><use href="#icon-${t}"></use></svg>`}},window.ENDPOINTS={HEALTH:"/health",MAPPINGS:"/mappings",MAPPINGS_RESET:"/mappings/reset",MAPPINGS_SAVE:"/mappings/save",MAPPINGS_IMPORT:"/mappings/import",MAPPINGS_FIND_BY_METADATA:"/mappings/find-by-metadata",MAPPINGS_REMOVE_BY_METADATA:"/mappings/remove-by-metadata",MAPPINGS_UNMATCHED:"/mappings/unmatched",REQUESTS:"/requests",REQUESTS_COUNT:"/requests/count",REQUESTS_REMOVE:"/requests/remove",REQUESTS_FIND:"/requests/find",REQUESTS_UNMATCHED:"/requests/unmatched",REQUESTS_UNMATCHED_NEAR_MISSES:"/requests/unmatched/near-misses",RECORDINGS_START:"/recordings/start",RECORDINGS_STOP:"/recordings/stop",RECORDINGS_STATUS:"/recordings/status",RECORDINGS_SNAPSHOT:"/recordings/snapshot",SCENARIOS:"/scenarios",SCENARIOS_RESET:"/scenarios/reset"},(function(){const e=new Map,n=new Map,i=new Set,r=new Map,a=(l,d,m)=>e.set(l,{name:d,delay:m,createdAt:Date.now()}),s=(l,d,m)=>n.set(l,{name:d,delay:m,createdAt:Date.now()}),c={setInterval(l,d,m){const w=window.setInterval(l,d);return a(w,m,d),w},setNamedInterval(l,d,m){return this.setInterval(d,m,l)},clearInterval(l){l!=null&&(window.clearInterval(l),e.delete(l))},setTimeout(l,d,m){const w=window.setTimeout(()=>{n.delete(w),l()},d);return s(w,m,d),w},clearTimeout(l){l!=null&&(window.clearTimeout(l),n.delete(l))},requestAnimationFrame(l){const d=window.requestAnimationFrame(l);return i.add(d),d},cancelAnimationFrame(l){l!=null&&(window.cancelAnimationFrame(l),i.delete(l))},addEventListener(l,d,m,w){!l||!d||!m||(l.addEventListener(d,m,w),r.has(l)||r.set(l,new Set),r.get(l).add({type:d,handler:m,options:w}))},removeEventListener(l,d,m,w){if(!l||!d||!m)return;l.removeEventListener(d,m,w);const E=r.get(l);if(E){for(const M of E)if(M.type===d&&M.handler===m&&JSON.stringify(M.options)===JSON.stringify(w)){E.delete(M);break}E.size===0&&r.delete(l)}},clearAll(){e.forEach((l,d)=>window.clearInterval(d)),e.clear(),n.forEach((l,d)=>window.clearTimeout(d)),n.clear(),i.forEach(l=>window.cancelAnimationFrame(l)),i.clear(),r.forEach((l,d)=>{l.forEach(({type:m,handler:w,options:E})=>{d.removeEventListener(m,w,E)})}),r.clear()},getStats(){return{intervals:e.size,timeouts:n.size,rafs:i.size,eventTargets:r.size,details:{intervals:Array.from(e.entries()),timeouts:Array.from(n.entries())}}}};window.LifecycleManager=c,window.addEventListener("beforeunload",()=>c.clearAll())})(),window.debounce=function(e,n=150,i={}){let r,a,s,c;const{leading:l=!1,trailing:d=!0}=i,m=()=>{r=void 0,d&&a&&(c=e.apply(s,a),a=s=void 0)};return Object.assign(function(...E){return a=E,s=this,r===void 0?(l&&(c=e.apply(s,a),a=s=void 0),r=window.setTimeout(m,n)):(window.clearTimeout(r),r=window.setTimeout(m,n)),c},{cancel(){r!==void 0&&window.clearTimeout(r),r=void 0,a=s=void 0},flush(){return r!==void 0&&(window.clearTimeout(r),m()),c}})},(function(){const e=new WeakMap;function n(i){if(typeof i!="string"||!i.trim())return null;const r=document.createElement("template");return r.innerHTML=i.trim(),r.content.firstElementChild}window.renderList=function(r,a,s={}){if(!(r instanceof Element)||!Array.isArray(a))return;const{renderItem:c,getKey:l,getSignature:d,onItemChanged:m,onItemRemoved:w}=s;if(typeof c!="function")return;const E=new Map;Array.from(r.children).forEach(v=>{v instanceof HTMLElement&&v.dataset&&v.dataset.id&&E.set(v.dataset.id,v)});const M=document.createDocumentFragment();a.forEach(v=>{const h=typeof l=="function"?l(v):v&&(v.id||v.uuid);if(!h)return;const y=String(h),A=typeof d=="function"?d(v):y,R=E.get(y);if(R&&R.dataset.renderSignature===A){R.dataset.renderSignature=A,M.appendChild(R),E.delete(y);return}const H=R&&R.dataset.renderSignature||null;if(R&&typeof m=="function"&&H!==A)try{m(y,v,A)}catch(de){Logger.warn("UI","renderList onItemChanged failed:",de)}const X=c(v),_=n(X);if(!_){E.delete(y);return}_.dataset.id=y,_.dataset.renderSignature=A,M.appendChild(_),E.delete(y)}),E.forEach((v,h)=>{if(v.remove(),typeof w=="function")try{w(String(h),v)}catch(y){Logger.warn("UI","renderList onItemRemoved failed:",y)}});const C=()=>{r.replaceChildren(M)};if(window.LifecycleManager&&typeof window.LifecycleManager.requestAnimationFrame=="function"){const v=e.get(r);v&&window.LifecycleManager.cancelAnimationFrame(v);const h=window.LifecycleManager.requestAnimationFrame(()=>{C(),e.delete(r)});h!==null&&e.set(r,h)}else if(typeof window.requestAnimationFrame=="function"){const v=window.requestAnimationFrame(C);e.set(r,v)}else C()}})();const ensureCustomHeaderObject=t=>!t||typeof t!="object"||Array.isArray(t)?{}:Object.keys(t).reduce((e,n)=>{const i=String(n).trim();return i&&(e[i]=t[n]),e},{}),migrateLegacySettings=t=>{if(!t||typeof t!="object"||Array.isArray(t))return{};const e={...t},n=ensureCustomHeaderObject(e.customHeaders);if(typeof e.authHeader=="string"&&e.authHeader.trim()){const i=e.authHeader.trim();if(Object.prototype.hasOwnProperty.call(n,"Authorization")||(n.Authorization=i),delete e.authHeader,!e.customHeadersRaw||typeof e.customHeadersRaw!="string"||!e.customHeadersRaw.trim())try{e.customHeadersRaw=JSON.stringify(n,null,2)}catch(r){Logger.warn("API","Failed to serialize migrated custom headers:",r),e.customHeadersRaw=""}}return e.customHeaders=n,typeof e.customHeadersRaw!="string"&&(e.customHeadersRaw=""),e.autoConnect=e.autoConnect!==!1,e};window.normalizeWiremockSettings=t=>migrateLegacySettings(t),window.readWiremockSettings=()=>{try{const t=localStorage.getItem("wiremock-settings");if(!t)return{};const e=JSON.parse(t);return migrateLegacySettings(e)}catch(t){return Logger.warn("UI","Failed to read stored settings, returning empty object:",t),{}}},window.buildScenarioStateEndpoint=t=>{const e=typeof t=="string"?t:"";return e.trim()?`${ENDPOINTS.SCENARIOS}/${encodeURIComponent(e)}/state`:""};let wiremockBaseUrl="",requestTimeout=window.DEFAULT_SETTINGS?.requestTimeout?parseInt(window.DEFAULT_SETTINGS.requestTimeout):69e3;window.customHeaders=ensureCustomHeaderObject(window.DEFAULT_SETTINGS?.customHeaders||{}),window.startTime=null,window.uptimeInterval=null;let autoRefreshInterval=null;window.allRequests=[],window.allScenarios=[],window.isRecording=!1,window.recordedCount=0,window.normalizeWiremockBaseUrl=(t,e)=>{let n=(t||"").trim()||"localhost",i=(e||"").trim(),r="http",a="";try{const s=new URL(n.includes("://")?n:`http://${n}`);r=s.protocol.replace(":","")||"http",a=s.hostname,i||(i=s.port)}catch{const c=n.match(/^([^:/]+)(?::(\d+))?$/);a=c?c[1]:n,i||(i=c?.[2])}return`${r}://${a||"localhost"}:${i||(r==="https"?"443":"8080")}/__admin`},window.apiFetch=async(t,e={})=>{const n=new AbortController,i=Utils.safeCall(window.readWiremockSettings)||{},r=i.requestTimeout?parseInt(i.requestTimeout):window.DEFAULT_SETTINGS?.requestTimeout?parseInt(window.DEFAULT_SETTINGS.requestTimeout):69e3,a=setTimeout(()=>n.abort(),r),s=`${window.wiremockBaseUrl}${t}`,c=e.method||"GET",l={"Content-Type":"application/json",...ensureCustomHeaderObject(i.customHeaders||window.customHeaders),...e.headers},m=!(t===window.ENDPOINTS?.HEALTH||t===window.ENDPOINTS?.MAPPINGS);m&&Logger.api(`${c} ${t}`);try{const w=await fetch(s,{...e,signal:n.signal,headers:l});if(clearTimeout(a),!w.ok){const M=await w.text();m&&Logger.error("API",`HTTP ${w.status}: ${M||w.statusText}`,{endpoint:t,method:c});const C=new Error(`HTTP ${w.status}: ${M||w.statusText}`);throw C.status=w.status,C.statusText=w.statusText,C}const E=w.headers.get("content-type")?.includes("application/json")?await w.json():await w.text();m&&Logger.api(`${c} ${t} - OK`);try{(t===window.ENDPOINTS?.HEALTH||t===window.ENDPOINTS?.MAPPINGS)&&(window.lastWiremockSuccess=Date.now(),Utils.safeCall(window.updateLastSuccessUI))}catch{}return E}catch(w){throw clearTimeout(a),m&&Logger.error("API",`${c} ${t} - ${w.name}: ${w.message}`),w.name==="AbortError"?new Error(`Request timeout after ${r}ms`):w}},window.showPage=(t,e)=>{Logger.info("UI",`Switching to tab: ${t}`),document.querySelectorAll('.main-content > div[id$="-page"]').forEach(i=>i.classList.add("hidden"));const n=document.getElementById(SELECTORS.PAGES[t.toUpperCase()]);if(!n){Logger.warn("UI",`Page not found: ${t}`);return}if(n.classList.remove("hidden"),document.querySelectorAll(".sidebar .nav-item").forEach(i=>i.classList.remove("active")),e&&e.classList.add("active"),window.history&&window.history.replaceState){const i=new URL(window.location.href),r=i.searchParams.get("tab");i.searchParams.set("tab",t);const a=i.toString();Logger.api(`showPage: ${r} \u2192 ${t}`),Logger.api(`showPage URL: ${a}`),window.history.replaceState({},"",a)}else Logger.warn("UI","history.replaceState not available")};const SIDEBAR_COLLAPSED_CLASS="sidebar-collapsed",SIDEBAR_STATE_STORAGE_KEY="imock-sidebar-state",applySidebarState=(t,{persist:e=!0}={})=>{if(!document.body)return;document.body.classList.toggle(SIDEBAR_COLLAPSED_CLASS,t);const n=document.querySelector(".sidebar-toggle");if(n){const i=t?"Expand sidebar":"Collapse sidebar";n.setAttribute("aria-expanded",String(!t)),n.setAttribute("aria-label",i),n.setAttribute("title",i),n.querySelector("use")?.setAttribute("href",t?"#icon-sidebar-expand":"#icon-sidebar-collapse")}if(e)try{localStorage.setItem(SIDEBAR_STATE_STORAGE_KEY,t?"collapsed":"expanded")}catch(i){Logger.warn("UI","Unable to persist sidebar state:",i)}};window.toggleSidebar=()=>{const t=document.body?.classList.contains(SIDEBAR_COLLAPSED_CLASS);applySidebarState(!t)},window.initializeSidebarPreference=()=>{let t=null;try{t=localStorage.getItem(SIDEBAR_STATE_STORAGE_KEY)}catch(e){Logger.warn("UI","Unable to read sidebar state from storage:",e)}applySidebarState(t==="collapsed",{persist:!1})};const resolveModalElement=t=>{if(!t)return Logger.warn("UI","Modal ID is required to resolve modal element"),null;const e=document.getElementById(t);return e||Logger.warn("UI",`Modal element not found for id: ${t}`),e};window.showModal=t=>{const e=resolveModalElement(t);if(!e)return;e.classList.remove("hidden"),e.style.display="flex";const n=e.querySelector("input, select, textarea");n&&LifecycleManager.requestAnimationFrame(()=>n.focus())},window.openAddMappingModal=()=>{if(window.TemplateManager?.openGalleryForTarget){window.TemplateManager.openGalleryForTarget("create-inline");return}const t=document.querySelector('[data-template-trigger][data-template-target="create-inline"]');t?t.click():window.showModal("template-gallery-modal")},window.hideModal=t=>{const e=typeof t=="string"?resolveModalElement(t):t;if(e&&(e.classList.add("hidden"),e.style.display="none",e.querySelector("form")?.reset(),e.id==="edit-mapping-modal"&&(typeof UIComponents?.clearCardState=="function"&&UIComponents.clearCardState("mapping","is-editing"),window.editor&&typeof window.editor.setValue=="function")))try{window.editor.setValue("")}catch(n){Logger.warn("UI","Failed to clear editor:",n)}},window.showTab=(t,e)=>{if(document.querySelectorAll(".tab-content").forEach(n=>n.classList.add("hidden")),document.querySelectorAll(".tab-button").forEach(n=>n.classList.remove("active")),document.getElementById(`${t}-tab`).classList.remove("hidden"),e.classList.add("active"),window.history&&window.history.replaceState){const n=new URL(window.location.href);n.searchParams.set("tab",t),window.history.replaceState({},"",n.toString())}};const applyThemeToDom=t=>{if(!document.body)return;document.body.setAttribute("data-theme",t);const e=[document.getElementById("theme-icon"),document.getElementById("editor-theme-icon")].filter(Boolean);if(e.length){const n=t==="dark"?"#icon-sun":"#icon-moon";e.forEach(i=>{i.setAttribute("href",n),i.setAttribute("xlink:href",n)})}},persistThemePreference=t=>{localStorage.setItem("theme",t);try{localStorage.setItem("wiremock-settings",JSON.stringify({...Utils.safeCall(window.readWiremockSettings)||{},theme:t}))}catch{}};window.toggleTheme=()=>{if(!document.body)return;const t=(document.body.getAttribute("data-theme")||"dark")==="dark"?"light":"dark";applyThemeToDom(t),persistThemePreference(t),window.NotificationManager&&NotificationManager.show(`Switched to ${t} theme`,"success")},window.changeTheme=()=>{const t=document.getElementById("theme-select");if(!t)return;const e=t.value,n=e==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;applyThemeToDom(n),persistThemePreference(e),window.NotificationManager&&NotificationManager.show(`Theme changed to ${e}`,"success")},window.initializeTheme=()=>{const t=localStorage.getItem("theme")||"dark",e=t==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":t;applyThemeToDom(e);const n=document.getElementById("theme-select");n&&(n.value=t)},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initializeTheme):initializeTheme(),LifecycleManager.addEventListener(document,"click",t=>{t.target.classList.contains("modal")&&hideModal(t.target)}),LifecycleManager.addEventListener(document,"keydown",t=>{if(t.key==="Escape"){const e=document.querySelector(".modal:not(.hidden)");e&&hideModal(e)}}),window.elementCache=new Map,window.invalidateElementCache=t=>t?window.elementCache.delete(t):window.elementCache.clear(),Logger.info("UI","Core.js loaded - Constants, API client, basic UI functions"),window.NotificationManager||(window.NotificationManager={TYPES:{INFO:"info",SUCCESS:"success",ERROR:"error",WARNING:"warning"},ICONS:{info:"\u2139\uFE0F",success:"\u2705",warning:"\u26A0\uFE0F",error:"\u26D4"},queue:[],visibleToasts:[],dedupeMap:new Map,toastContainer:null,cooldownTimer:null,lastShownAt:0,maxVisible:3,cooldownMs:650,dedupeWindowMs:4e3,defaultDuration:4e3,motionQuery:null,_boundHandleKeydown:null,init(){this.toastContainer||(this.toastContainer=document.getElementById("toast-container"),this.toastContainer||(this.toastContainer=document.createElement("div"),this.toastContainer.id="toast-container",this.toastContainer.setAttribute("aria-live","polite"),this.toastContainer.setAttribute("aria-atomic","false"),document.body.appendChild(this.toastContainer))),!this.motionQuery&&window.matchMedia&&(this.motionQuery=window.matchMedia("(prefers-reduced-motion: reduce)")),this._boundHandleKeydown||(this._boundHandleKeydown=this.handleKeydown.bind(this),window.LifecycleManager?window.LifecycleManager.addEventListener(document,"keydown",this._boundHandleKeydown):document.addEventListener("keydown",this._boundHandleKeydown))},cleanup(){this._boundHandleKeydown&&(window.LifecycleManager?window.LifecycleManager.removeEventListener(document,"keydown",this._boundHandleKeydown):document.removeEventListener("keydown",this._boundHandleKeydown),this._boundHandleKeydown=null)},normalizePayload(t,e=this.TYPES.INFO,n=void 0){if(t==null)return null;const i={message:String(t).trim(),type:this.TYPES.INFO,duration:this.defaultDuration,action:null};return typeof e=="object"&&e!==null?Object.assign(i,e):(i.type=typeof e=="string"?e:this.TYPES.INFO,typeof n=="number"?i.duration=n:typeof n=="object"&&n!==null&&Object.assign(i,n)),i.message?(Object.values(this.TYPES).includes(i.type)||(i.type=this.TYPES.INFO),i.action&&typeof i.action!="object"&&(i.action=null),i.action&&typeof i.action?.label!="string"&&(i.action=null),i.action&&typeof i.action?.handler!="function"&&(i.action.handler=()=>{}),i.action?i.duration=null:(typeof i.duration!="number"||i.duration<=0)&&(i.duration=this.defaultDuration),i.createdAt=Date.now(),i.count=i.count&&Number.isInteger(i.count)?i.count:1,i.dedupeKey=this.getDedupeKey(i),i):null},show(t,e=this.TYPES.INFO,n=void 0){this.init();const i=this.normalizePayload(t,e,n);if(!i)return;const r=this.dedupeMap.get(i.dedupeKey);if(r&&Date.now()-r.timestamp<=this.dedupeWindowMs){r.count+=1,r.timestamp=Date.now(),r.payload.count=r.count,this.updateToastCount(r),clearTimeout(r.cleanupTimer),r.cleanupTimer=setTimeout(()=>{this.dedupeMap.delete(i.dedupeKey)},this.dedupeWindowMs);return}this.queue.push(i),this.dedupeMap.set(i.dedupeKey,{count:i.count,timestamp:Date.now(),payload:i,toastEl:null,cleanupTimer:setTimeout(()=>{this.dedupeMap.delete(i.dedupeKey)},this.dedupeWindowMs)}),this.processQueue()},success(t,e){this.show(t,{type:this.TYPES.SUCCESS,...typeof e=="object"?e:{duration:e}})},error(t,e){this.show(t,{type:this.TYPES.ERROR,...typeof e=="object"?e:{duration:e}})},warning(t,e){this.show(t,{type:this.TYPES.WARNING,...typeof e=="object"?e:{duration:e}})},info(t,e){this.show(t,{type:this.TYPES.INFO,...typeof e=="object"?e:{duration:e}})},handleKeydown(t){if(t.key!=="Escape"||!this.visibleToasts.length)return;const e=this.visibleToasts[this.visibleToasts.length-1];e&&this.dismissToast(e.toastEl,e.payload,"escape")},processQueue(){if(!this.queue.length||this.visibleToasts.length>=this.maxVisible)return;const e=Date.now()-this.lastShownAt;if(e<this.cooldownMs){this.cooldownTimer||(this.cooldownTimer=setTimeout(()=>{this.cooldownTimer=null,this.processQueue()},this.cooldownMs-e));return}const n=this.getNextToastIndex();if(n===-1)return;const i=this.queue.splice(n,1)[0];this.displayToast(i)},getNextToastIndex(){if(!this.queue.length)return-1;const t={[this.TYPES.ERROR]:3,[this.TYPES.WARNING]:2,[this.TYPES.INFO]:1,[this.TYPES.SUCCESS]:1};let e=0,n=-1/0,i=1/0;for(let r=0;r<this.queue.length;r+=1){const a=this.queue[r],s=t[a.type]||0;(s>n||s===n&&a.createdAt<i)&&(n=s,i=a.createdAt,e=r)}return e},displayToast(t){const e=document.createElement("div");e.className=`toast toast-${t.type}`,e.setAttribute("role",t.type===this.TYPES.ERROR?"alert":"status"),e.setAttribute("aria-live",t.type===this.TYPES.ERROR?"assertive":"polite"),e.setAttribute("aria-atomic","true"),e.dataset.key=t.dedupeKey;const n=document.createElement("span");n.className="toast-icon",n.setAttribute("aria-hidden","true"),n.textContent=this.ICONS[t.type]||this.ICONS.info;const i=document.createElement("div");i.className="toast-content";const r=document.createElement("p");r.className="toast-message",r.textContent=t.message;const a=document.createElement("span");a.className="toast-count",t.count>1&&(a.textContent=`\xD7${t.count}`,a.setAttribute("aria-label",`${t.count} occurrences`));const s=document.createElement("div");s.className="toast-actions";const c=document.createElement("button");if(c.type="button",c.className="toast-close",c.setAttribute("aria-label","Dismiss notification"),c.textContent="\u2715",c.addEventListener("click",()=>this.dismissToast(e,t,"close")),t.action){const E=document.createElement("button");E.type="button",E.className="toast-action",E.textContent=t.action.label,E.addEventListener("click",M=>{M.preventDefault(),M.stopPropagation();try{t.action.handler()}finally{this.dismissToast(e,t,"action")}}),s.appendChild(E)}s.appendChild(c),i.appendChild(r),t.count>1&&i.appendChild(a),e.appendChild(n),e.appendChild(i),e.appendChild(s),this.toastContainer.firstChild?this.toastContainer.insertBefore(e,this.toastContainer.firstChild):this.toastContainer.appendChild(e);const l=this.dedupeMap.get(t.dedupeKey);l&&(l.toastEl=e,l.payload=t);const d={toastEl:e,payload:t,remaining:t.duration,hideTimer:null,startedAt:null};this.visibleToasts.push(d),this.lastShownAt=Date.now(),requestAnimationFrame(()=>{e.classList.add("show")});const m=()=>{d.hideTimer&&(clearTimeout(d.hideTimer),d.hideTimer=null,d.startedAt&&d.remaining&&(d.remaining-=Date.now()-d.startedAt))},w=()=>{d.hideTimer||t.duration===null||((typeof d.remaining!="number"||d.remaining<=0)&&(d.remaining=this.defaultDuration),d.startedAt=Date.now(),d.hideTimer=setTimeout(()=>{this.dismissToast(e,t,"timeout")},d.remaining))};e.addEventListener("mouseenter",m),e.addEventListener("focusin",m),e.addEventListener("mouseleave",w),e.addEventListener("focusout",w),t.duration!==null&&(d.remaining=t.duration,w()),this.motionQuery&&this.motionQuery.matches&&e.classList.add("toast-reduced-motion"),this.processQueue()},dismissToast(t,e,n){if(!t||t.dataset.dismissed==="true")return;t.dataset.dismissed="true",t.classList.remove("show");const i=this.visibleToasts.findIndex(a=>a.toastEl===t);if(i!==-1){const a=this.visibleToasts[i];a.hideTimer&&clearTimeout(a.hideTimer),this.visibleToasts.splice(i,1)}const r=this.dedupeMap.get(e.dedupeKey);r&&r.toastEl===t&&(r.toastEl=null),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),this.processQueue()},this.motionQuery&&this.motionQuery.matches?0:250)},updateToastCount(t){if(t)if(t.toastEl){const e=t.toastEl.querySelector(".toast-count"),n=t.toastEl.querySelector(".toast-content");if(t.count>1){if(e)e.textContent=`\xD7${t.count}`,e.setAttribute("aria-label",`${t.count} occurrences`);else if(n){const r=document.createElement("span");r.className="toast-count",r.textContent=`\xD7${t.count}`,r.setAttribute("aria-label",`${t.count} occurrences`),n.appendChild(r)}}else e&&e.parentNode&&e.parentNode.removeChild(e);const i=this.visibleToasts.find(r=>r.toastEl===t.toastEl);i&&i.payload.duration!==null&&(i.hideTimer&&clearTimeout(i.hideTimer),i.remaining=Math.max(i.payload.duration,this.defaultDuration),i.startedAt=Date.now(),i.hideTimer=setTimeout(()=>{this.dismissToast(i.toastEl,i.payload,"timeout")},i.remaining))}else t.payload&&(t.payload.count=t.count)},getDedupeKey(t){return`${t.type}::${t.message}::${t.action?t.action.label:""}`}}),window.TabManager={configs:{mappings:{name:"Mappings",loadFunction:"loadMappings",clearFunction:"clearMappingFilters"},requests:{name:"Requests",loadFunction:"loadRequests",clearFunction:"clearRequestFilters"},scenarios:{name:"Scenarios",loadFunction:"loadScenarios",clearFunction:null}},getCurrentTab(){const t=document.querySelector(".tab-link.active");if(t){const e=t.getAttribute("onclick");if(e){const n=e.match(/showTab\(['"](\w+)['"]\)/);if(n)return n[1]}}return"mappings"},async refresh(t){const e=this.configs[t];if(!e){Logger.warn("MANAGERS",`Tab config not found: ${t}`);return}try{const n=window[e.loadFunction];typeof n=="function"?(await n(),Logger.info("MANAGERS",`${e.name} refreshed`)):Logger.warn("MANAGERS",`Load function not found: ${e.loadFunction}`)}catch(n){Logger.error("MANAGERS",`Error refreshing ${e.name}:`,n),NotificationManager.error(`Failed to refresh ${e.name}: ${n.message}`)}},clearFilters(t){const e=this.configs[t];if(!(!e||!e.clearFunction))try{const n=window[e.clearFunction];typeof n=="function"&&(n(),Logger.info("MANAGERS",`${e.name} filters cleared`))}catch(n){Logger.error("MANAGERS",`Error clearing ${e.name} filters:`,n)}}},window.FilterManager={saveFilterState(t,e){try{const n=`imock-filters-${t}`;localStorage.setItem(n,JSON.stringify(e))}catch(n){Logger.warn("MANAGERS","Failed to save filter state:",n)}},loadFilterState(t){try{const e=`imock-filters-${t}`,n=localStorage.getItem(e);return n?JSON.parse(n):{}}catch(e){return Logger.warn("MANAGERS","Failed to load filter state:",e),{}}},applyMappingFilters(){typeof this._applyMappingFilters=="function"&&this._applyMappingFilters()},flushMappingFilters(){this._applyMappingFilters&&typeof this._applyMappingFilters.flush=="function"&&this._applyMappingFilters.flush()},applyRequestFilters(){typeof this._applyRequestFilters=="function"&&this._applyRequestFilters()},flushRequestFilters(){this._applyRequestFilters&&typeof this._applyRequestFilters.flush=="function"&&this._applyRequestFilters.flush()},restoreFilters(t){if(t==="mappings"){const e=getFilterFromURL("mappings");if(e){const n=document.getElementById("filter-query");return n&&(n.value=e),{query:e}}else{const n=this.loadFilterState(t);if(n.query){const i=document.getElementById("filter-query");i&&(i.value=n.query)}return n}}else if(t==="requests"){const e=getFilterFromURL("requests");if(e){const s=document.getElementById("req-filter-query");if(s)return s.value=e,{query:e}}const n=this.loadFilterState(t),i=document.getElementById("req-filter-query");i&&n.query&&(i.value=n.query);const r=document.getElementById("req-filter-from"),a=document.getElementById("req-filter-to");return r&&(r.value=n.from||""),a&&(a.value=n.to||""),n}return{}},hasURLFilters(t){const e=this.getFiltersFromURL(t);return Object.values(e).some(n=>n!=="")}},window.FilterPresetsManager={getAllPresets(){try{const t=localStorage.getItem("imock-filter-presets-custom");return t?JSON.parse(t):{}}catch(t){return Logger.warn("MANAGERS","Failed to load custom presets:",t),{}}},applyPreset(t,e="mappings"){const i=this.getAllPresets()[t];if(!i){Logger.warn("MANAGERS",`Preset not found: ${t}`);return}if(e==="mappings"){const r=document.getElementById("filter-method"),a=document.getElementById("filter-url"),s=document.getElementById("filter-status");r&&(r.value=i.filters.method||""),a&&(a.value=i.filters.query||""),s&&(s.value=i.filters.status||""),typeof window.applyFilters=="function"&&window.applyFilters(),i.filters.method&&typeof window.syncFilterTabsFromSelect=="function"&&window.syncFilterTabsFromSelect("mapping",i.filters.method),typeof NotificationManager<"u"&&NotificationManager.info(`Applied preset: ${i.name}`)}},saveCustomPreset(t,e){try{const n=this.getCustomPresets();n[t]=e,localStorage.setItem("imock-filter-presets-custom",JSON.stringify(n)),typeof NotificationManager<"u"&&NotificationManager.success(`Preset "${e.name}" saved`),typeof window.renderFilterPresets=="function"&&window.renderFilterPresets()}catch(n){Logger.error("MANAGERS","Failed to save preset:",n),typeof NotificationManager<"u"&&NotificationManager.error("Failed to save preset")}},getCustomPresets(){try{const t=localStorage.getItem("imock-filter-presets-custom");return t?JSON.parse(t):{}}catch(t){return Logger.warn("MANAGERS","Failed to load custom presets:",t),{}}},deleteCustomPreset(t){try{const e=this.getCustomPresets();delete e[t],localStorage.setItem("imock-filter-presets-custom",JSON.stringify(e)),typeof NotificationManager<"u"&&NotificationManager.success("Preset deleted"),typeof window.renderFilterPresets=="function"&&window.renderFilterPresets()}catch(e){Logger.error("MANAGERS","Failed to delete preset:",e),typeof NotificationManager<"u"&&NotificationManager.error("Failed to delete preset")}},getCurrentFiltersAsPreset(t="mappings"){return t==="mappings"?{method:document.getElementById("filter-method")?.value||"",query:document.getElementById("filter-url")?.value||"",status:document.getElementById("filter-status")?.value||""}:{}}};function updateURLFilterParams(t,e="mappings"){if(!window.history||!window.history.replaceState)return;const n=new URL(window.location.href),i=`${e}_filter`;t?n.searchParams.set(i,t):n.searchParams.delete(i),window.history.replaceState({},"",n.toString())}function getFilterFromURL(t="mappings"){const e=new URLSearchParams(window.location.search),n=`${t}_filter`;return e.get(n)}function getActiveTabFromURL(){return new URLSearchParams(window.location.search).get("tab")}window.updateURLFilterParams=updateURLFilterParams,window.getFilterFromURL=getFilterFromURL,window.getActiveTabFromURL=getActiveTabFromURL,Logger.info("MANAGERS","Managers.js loaded - NotificationManager, TabManager, FilterManager"),(function(){const t=Date.now(),e=(s=0)=>new Date(t-s).toISOString(),n=[{id:"demo-mapping-products-list",name:"List products",priority:1,request:{method:"GET",urlPath:"/api/products",headers:{Accept:"application/json"}},response:{status:200,headers:{"Content-Type":"application/json"},jsonBody:{items:[{id:"sku-1000",name:"Demo Sneakers",price:129.99},{id:"sku-1001",name:"Demo Backpack",price:89.5}]}},metadata:{created:e(1e3*60*60*6),edited:e(1e3*60*60*2),source:"demo-seed",tags:["catalog","demo"]}},{id:"demo-mapping-create-order",name:"Create order",priority:2,persistent:!0,request:{method:"POST",urlPath:"/api/orders",bodyPatterns:[{matchesJsonPath:"$.items[*].sku"}]},response:{status:201,fixedDelayMilliseconds:120,headers:{"Content-Type":"application/json",Location:"/api/orders/90001"},jsonBody:{orderId:"90001",status:"processing",estimatedDelivery:e(-1e3*60*15)}},metadata:{created:e(1e3*60*60*12),edited:e(1e3*60*45),scenarioName:"checkout-flow",source:"demo-seed"}},{id:"demo-mapping-update-profile",name:"Update profile",priority:3,request:{method:"PUT",urlPattern:"/api/users/\\d+",headers:{"X-Demo-Auth":"Bearer ***"}},response:{status:204,headers:{"X-Demo-Trace":"profile-update"}},metadata:{created:e(1e3*60*30),edited:e(1e3*60*15),source:"demo-seed",tags:["profile"]}},{id:"demo-mapping-delete-session",name:"Delete session",priority:4,request:{method:"DELETE",urlPathPattern:"/api/sessions/.*"},response:{status:202,headers:{"Retry-After":"30"},jsonBody:{status:"scheduled"}},metadata:{created:e(1e3*60*60*3),source:"demo-seed"}}],i=[{id:"demo-request-001",wasMatched:!0,request:{method:"GET",url:"/api/products",urlPath:"/api/products",loggedDate:e(1e3*60*8),headers:{Accept:["application/json"],Host:["demo.wiremock.local"]},clientIp:"192.168.10.14"},responseDefinition:{status:200,headers:{"Content-Type":"application/json"},body:JSON.stringify({items:[{id:"sku-1000"},{id:"sku-1001"}]})}},{id:"demo-request-002",wasMatched:!1,request:{method:"POST",url:"/api/orders",loggedDate:e(1e3*60*5),body:JSON.stringify({items:[]}),headers:{"Content-Type":["application/json"],Host:["demo.wiremock.local"]},clientIp:"192.168.10.18"},responseDefinition:{status:404,body:"No matching mapping found",headers:{"Content-Type":"text/plain"}}},{id:"demo-request-003",wasMatched:!0,request:{method:"PATCH",url:"/api/orders/90001",loggedDate:e(1e3*60*3),body:JSON.stringify({status:"cancelled"}),headers:{"Content-Type":["application/json"],"X-Demo-Auth":["Bearer demo-token"]},clientIp:"192.168.10.20"},responseDefinition:{status:409,body:JSON.stringify({message:"Order already fulfilled"}),headers:{"Content-Type":"application/json"}}},{id:"demo-request-004",wasMatched:!0,request:{method:"DELETE",url:"/api/sessions/abc123",loggedDate:e(1e3*60*2),headers:{"X-Demo-Auth":["Bearer demo-token"],Host:["demo.wiremock.local"]},clientIp:"192.168.10.22"},responseDefinition:{status:202,body:"Session deletion scheduled",headers:{"Retry-After":"30"}}}],r={generatedAt:e()},a=s=>JSON.parse(JSON.stringify(s));window.DemoData={isAvailable(){return n.length>0||i.length>0},getMappingsPayload(){return{mappings:a(n),meta:{...r},__source:"demo"}},getRequestsPayload(){return{requests:a(i),meta:{...r},__source:"demo"}},getDataset(){return{mappings:a(n),requests:a(i),meta:{...r},__source:"demo"}}}})(),(function(e){const n=e,i=n.FeaturesState||{},r=1e3;n.mappingIndex instanceof Map||(n.mappingIndex=new Map),n.mappingTabTotals??(n.mappingTabTotals={all:0,get:0,post:0,put:0,patch:0,delete:0}),n.requestTabTotals??(n.requestTabTotals={all:0,matched:0,unmatched:0}),n.pendingDeletedIds instanceof Set||(n.pendingDeletedIds=new Set),n.deletionTimeouts instanceof Map||(n.deletionTimeouts=new Map),n.isDemoMode??(n.isDemoMode=!1),n.demoModeAnnounced??(n.demoModeAnnounced=!1),n.demoModeLastError??(n.demoModeLastError=null);let a=null;function s(h="automatic"){n.isDemoMode=!0,n.demoModeReason=h,!n.demoModeAnnounced&&n.NotificationManager?.info&&(n.NotificationManager.info("WireMock API unreachable. Showing demo data so the interface stays interactive."),n.demoModeAnnounced=!0)}function c(h){if(!h||typeof h!="object")return;n.mappingIndex instanceof Map||(n.mappingIndex=new Map);const y=new Set;["id","uuid","stubMappingId","stubId","mappingId"].forEach(A=>{h[A]&&y.add(String(h[A]).trim())}),h.metadata?.id&&y.add(String(h.metadata.id).trim()),y.forEach(A=>{A&&n.mappingIndex.set(A,h)})}function l(h){n.mappingIndex instanceof Map?n.mappingIndex.clear():n.mappingIndex=new Map,Array.isArray(h)&&h.forEach(c)}function d(h=[]){const y={all:0,get:0,post:0,put:0,patch:0,delete:0};return(!Array.isArray(h)||h.length===0)&&(h=n.MappingsStore?.getAll?n.MappingsStore.getAll():[]),!Array.isArray(h)||h.length===0||(y.all=h.length,h.forEach(A=>{const R=(A?.request?.method||"").toLowerCase();Object.prototype.hasOwnProperty.call(y,R)&&(y[R]+=1)})),y}function m(){const h=n.MappingsStore?.getAll?n.MappingsStore.getAll():[];n.mappingTabTotals=d(h)}function w(h=[]){const y={all:0,matched:0,unmatched:0};return!Array.isArray(h)||h.length===0||(y.all=h.length,h.forEach(A=>{A?.wasMatched!==!1?y.matched+=1:y.unmatched+=1})),y}function E(){const h=n.MappingsStore?.getAllRequests?n.MappingsStore.getAllRequests():[];n.requestTabTotals=w(h),typeof n.updateRequestTabCounts=="function"&&n.updateRequestTabCounts()}function M(h){if(!(n.mappingIndex instanceof Map))return;const y=typeof h=="object"?h:n.mappingIndex.get(h);if(y)for(const[A,R]of n.mappingIndex.entries())(R===y||A===h)&&n.mappingIndex.delete(A)}async function C({force:h=!1}={}){if(a){if(!h)return Logger.debug("STATE","fetchMappingsFromServer: reusing in-flight request"),a;try{Logger.debug("STATE","fetchMappingsFromServer: waiting for in-flight request before force refresh");const A=await a;if(Date.now()-(n._lastMappingsFetchTime||0)<r)return Logger.debug("STATE","fetchMappingsFromServer: reusing just-completed result"),A}catch(A){Logger.warn("STATE","fetchMappingsFromServer: previous request failed, starting a new one",A)}}const y=(async()=>{try{const A=await n.apiFetch(n.ENDPOINTS.MAPPINGS);return n._lastMappingsFetchTime=Date.now(),A}catch(A){throw n.demoModeLastError=A,A}finally{a===y&&(a=null)}})();return a=y,y}function v(h,y,A={}){try{if(!h){Logger.warn("STATE","updateOptimisticCache: no mapping provided");return}const R=h.id||h.uuid;if(y==="delete"){if(!R){Logger.warn("STATE","updateOptimisticCache: delete operation requires mapping ID");return}n.MappingsStore?.items instanceof Map&&(n.MappingsStore.items.delete(R),typeof n.MappingsStore?.addPending=="function"&&n.MappingsStore.addPending({id:R,type:"delete",payload:null,optimisticMapping:null}),typeof n.MappingsStore.rebuildIndexes=="function"&&n.MappingsStore.rebuildIndexes()),n.cacheLastUpdate=Date.now(),typeof n.refreshMappingsFromCache=="function"&&n.refreshMappingsFromCache(),Logger.info("STATE","Deleted mapping from optimistic cache:",R);return}if(!R){Logger.warn("STATE","updateOptimisticCache: mapping must have an id or uuid");return}if(n.MappingsStore?.items instanceof Map){const H=n.MappingsStore.items.get(R),X=H&&y==="update"?{...H,...h}:h;n.MappingsStore.items.set(R,X),A.queueMode==="add"&&typeof n.MappingsStore?.addPending=="function"?n.MappingsStore.addPending({id:R,type:y,payload:h,optimisticMapping:X}):A.queueMode==="confirm"&&typeof n.MappingsStore?.confirmPending=="function"&&n.MappingsStore.confirmPending(R),typeof n.MappingsStore.rebuildIndexes=="function"&&n.MappingsStore.rebuildIndexes()}n.cacheLastUpdate=Date.now(),typeof n.refreshMappingsFromCache=="function"&&n.refreshMappingsFromCache(),Logger.info("STATE",`[updateOptimisticCache] ${y} mapping:`,R)}catch(R){Logger.error("STATE","updateOptimisticCache failed:",R)}}if(i.markDemoModeActive=s,i.addMappingToIndex=c,i.rebuildMappingIndex=l,i.computeMappingTabTotals=d,i.refreshMappingTabSnapshot=m,i.computeRequestTabTotals=w,i.refreshRequestTabSnapshot=E,i.removeMappingFromIndex=M,i.fetchMappingsFromServer=C,i.updateOptimisticCache=v,n.markDemoModeActive=s,n.addMappingToIndex=c,n.rebuildMappingIndex=l,n.computeMappingTabTotals=d,n.refreshMappingTabSnapshot=m,n.computeRequestTabTotals=w,n.refreshRequestTabSnapshot=E,n.removeMappingFromIndex=M,n.fetchMappingsFromServer=C,n.updateOptimisticCache=v,n.FeaturesState=i,Logger.info("STATE","state.js loaded - State management functions registered"),typeof n.dispatchEvent=="function"){let h;typeof n.CustomEvent=="function"?h=new CustomEvent("features:state-ready",{detail:{state:i}}):typeof document<"u"&&document.createEvent&&(h=document.createEvent("Event"),h.initEvent("features:state-ready",!1,!1),h.detail={state:i}),h&&n.dispatchEvent(h)}})(typeof window<"u"?window:globalThis);const Utils={escapeHtml:t=>typeof t!="string"?String(t):t.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[e]),normalizeScenarioName:(t,e="_")=>{if(t==null)return{original:t,normalized:t,changed:!1,cleared:!1,hadWhitespace:!1};const n=typeof t=="string"?t:String(t),i=/\s/.test(n),r=n.trim().replace(/\s+/g,e);return{original:n,normalized:r,changed:r!==n,cleared:!!n&&!r,hadWhitespace:i}},formatJson:(t,e="Invalid JSON",n=1e3)=>{try{const i=JSON.stringify(t,null,2);return i.length>n?i.substring(0,n)+`
... (truncated - `+(i.length-n)+" more characters)":i}catch{return e}},parseRequestTime:t=>{if(!t)return new Date().toLocaleString("en-US");try{const e=new Date(typeof t=="number"?t>1e12?t:t*1e3:t);return isNaN(e.getTime())?`Invalid: ${t}`:e.toLocaleString("en-US")}catch{return`Invalid: ${t}`}},getStatusClass:t=>{const e=parseInt(t)||0;return e>=200&&e<300?"success":e>=300&&e<400?"redirect":e>=400&&e<500?"client-error":e>=500?"server-error":"unknown"},formatDateTime:t=>{const e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),a=String(t.getMinutes()).padStart(2,"0");return`${e}-${n}-${i}T${r}:${a}`},isFunction:t=>typeof t=="function",safeCall:(t,...e)=>{if(typeof t=="function")return t(...e)},toggleElement:(t,e)=>{t&&(e?t.classList.remove("hidden"):t.classList.add("hidden"))},showElement:t=>{t&&t.classList.remove("hidden")},hideElement:t=>{t&&t.classList.add("hidden")}},escapeHtml=Utils.escapeHtml;window.Utils=Utils,window.escapeHtml=escapeHtml,(function(e){const n="imock-custom-templates",i={FORM:"template-selector",EDITOR:"editor-template-selector"},r={GALLERY:"template-gallery-modal",PREVIEW:"template-preview-modal"},a=[{id:"happy-path",icon:"\u2713",title:"Happy path",subtitle:"Client flows succeed",color:"#10b981",description:"Standard successful API responses"},{id:"errors",icon:"\u26A0",title:"Errors",subtitle:"Client handles failures correctly",color:"#f59e0b",description:"HTTP errors and validation cases"},{id:"faults",icon:"\u26A1",title:"Network issues",subtitle:"Timeouts, disconnects, slow responses",color:"#ef4444",description:"Network fault simulation"},{id:"scenarios",icon:"\u21BB",title:"Scenarios",subtitle:"Stateful steps and retries",color:"#8b5cf6",description:"Changing service behaviour"},{id:"dynamic",icon:"\u2387",title:"Dynamic response",subtitle:"Response templating and conditions",color:"#3b82f6",description:"Response depends on request"},{id:"matching",icon:"\u{1F3AF}",title:"Request Matching",subtitle:"URL, headers, body, JSONPath",color:"#06b6d4",description:"Advanced request matching"},{id:"webhooks",icon:"\u{1F4E4}",title:"Webhooks",subtitle:"Asynchronous callbacks",color:"#ec4899",description:"Outgoing HTTP callbacks"},{id:"proxy",icon:"\u21C4",title:"Proxy & Record",subtitle:"Proxying and recording",color:"#14b8a6",description:"Working against real APIs"},{id:"custom",icon:"\u2605",title:"My templates",subtitle:"Saved by you",color:"#0ea5e9",description:"Personal templates you created"}],s="empty-mapping-skeleton",c={step:"goals",goalId:null,selectedTemplateId:null,searchQuery:"",activeTags:[],showPopularOnly:!1};let l="form";const d={templateId:null,target:null};let m="",w=null;const E={handler:null,label:null,mode:"mapping"};function M(){const u=document.getElementById("method"),b=document.getElementById("url-pattern"),T=document.getElementById("editor-method"),O=document.getElementById("editor-url"),k=u?.value||T?.value,q=b?.value||O?.value;return{method:(k||"GET").toUpperCase(),urlPath:q||"/api/example"}}function C(u=M()){const b={method:(u?.method||"GET").toUpperCase(),urlPath:u?.urlPath||"/api/example"};return{name:"Empty mapping",request:{method:b.method,urlPath:b.urlPath},response:{status:200}}}function v(u){return A(C(u))}function h(){const u=M(),b=v(u);return{id:s,title:"Empty mapping",description:"Create a minimal stub and fill in the request/response yourself.",category:"happy-path",highlight:`${b.request.method} \xB7 ${b.request.urlPath}`,feature:{path:["response","status"],label:"response.status"},content:b}}function y(u,b="info"){const T=e.NotificationManager;if(T&&typeof T[b]=="function"){T[b](u);return}console[b==="error"?"error":"log"](`[TEMPLATES] ${u}`)}function A(u){try{if(typeof structuredClone=="function")return structuredClone(u)}catch(b){Logger.warn("TEMPLATES","Failed to structuredClone, falling back to JSON:",b)}try{return JSON.parse(JSON.stringify(u))}catch(b){if(Logger.warn("TEMPLATES","Failed to JSON clone value, returning shallow copy:",b),u&&typeof u=="object")return Array.isArray(u)?[...u]:{...u}}return u}function R(u,b){d.templateId=u||null,d.target=u?b:null,X()}function H(){return!!d.templateId&&(!d.target||d.target==="editor")}function X(){_(H())}function _(u){const b=document.getElementById("update-mapping-btn");if(!b)return;const T=b.querySelector?.(".btn-label")||b;if(u){if(E.mode==="template-save")return;E.handler||(E.handler=b.onclick||(typeof e.updateMapping=="function"?O=>e.updateMapping(O):null)),!E.label&&T&&(E.label=T.textContent||"Update Mapping"),b.onclick=O=>(O?.preventDefault?.(),qe({skipNamePrompt:!0,reuseExistingMetadata:!0})),T&&(T.textContent="Save template"),b.setAttribute("data-template-edit-mode","true"),E.mode="template-save";return}E.mode==="template-save"&&(b.onclick=E.handler||b.onclick,T&&E.label&&(T.textContent=E.label),b.removeAttribute("data-template-edit-mode"),E.mode="mapping")}function de(u){["id","uuid","stubMappingId","stubId","mappingId"].forEach(b=>delete u[b]),u.metadata&&delete u.metadata.id}function be(u){if(!u||typeof u!="object"||!Object.prototype.hasOwnProperty.call(u,"scenarioName"))return null;const b=k=>{if(k==null)return{original:k,normalized:k,changed:!1,cleared:!1,hadWhitespace:!1};const q=typeof k=="string"?k:String(k),B=/\s/.test(q),Q=q.trim().replace(/\s+/g,"_");return{original:q,normalized:Q,changed:Q!==q,cleared:!!q&&!Q,hadWhitespace:B}},O=(typeof e?.Utils?.normalizeScenarioName=="function"?e.Utils.normalizeScenarioName:b)(u.scenarioName);return!O?.changed||!O?.hadWhitespace?null:(O.cleared?delete u.scenarioName:u.scenarioName=O.normalized,{original:O.original,normalized:O.normalized,cleared:O.cleared})}function x(u,b={}){if(!u||typeof u!="object")return null;const{source:T="ui",seed:O=M(),scenarioFixes:k}=b,q=new Date().toISOString(),B=A(u);de(B),bt(B,O);const Q=be(B);return Q&&k instanceof Map&&!k.has(Q.original)&&k.set(Q.original,Q),B.metadata={...B.metadata||{},created:B.metadata?.created||q,edited:q,source:B.metadata?.source||T},B}async function j(u,b={}){const{openMode:T="inline",source:O="ui",successMessageFactory:k}=b,q=Array.isArray(u)?u:[u],B=new Map,Q=q.map(U=>x(U,{source:O,scenarioFixes:B})).filter(Boolean);if(B.size){const U=Array.from(B.values()).slice(0,3).map(ne=>ne.cleared?"cleared":`"${ne.original}" \u2192 "${ne.normalized}"`).join(", ");y(`Scenario name cannot contain spaces. Normalized: ${U}`,"warning")}if(!Q.length)return y("No valid mapping payloads to create","warning"),{success:!1,createdIds:[]};const le=Q.map((U,ne)=>({index:ne,error:Tt(U)})).filter(U=>!!U.error);if(le.length){const U=le[0];return y(`Mapping payload is missing required fields (entry ${U.index+1}): ${U.error}`,"error"),{success:!1,createdIds:[]}}try{const U=[],ne=[];for(let Re=0;Re<Q.length;Re+=1){const Et=Q[Re];try{const ze=await apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Et)}),ot=ze?.mapping||ze,at=ot?.id;if(at&&typeof updateOptimisticCache=="function")try{updateOptimisticCache(ot,"create")}catch(qt){Logger.warn("TEMPLATES","Failed to update optimistic cache after create:",qt)}at&&U.push(at)}catch(ze){ne.push({index:Re,error:ze});break}}if(ne.length){const Re=[];for(const ot of U)try{await apiFetch(`/mappings/${ot}`,{method:"DELETE"}),typeof updateOptimisticCache=="function"&&updateOptimisticCache({id:ot},"delete")}catch(at){Re.push(at)}const Et=ne[0],ze=Re.length?` Rollback issues: ${Re.length} delete${Re.length===1?"":"s"} failed.`:"";return y(`Failed to create mapping ${Et.index+1}/${Q.length}: ${Et.error.message}.${ze}`,"error"),Logger.error("TEMPLATES","Mapping create failed",{errors:ne,rollbackErrors:Re}),{success:!1,createdIds:[]}}const Oe=U.length||Q.length,$e=typeof k=="function"?k(Oe):`Created ${Oe} mapping${Oe===1?"":"s"}`;y($e,"success");const rt=U[0];return rt&&(T==="studio"&&typeof e.editMapping=="function"?e.editMapping(rt):typeof e.openEditModal=="function"&&e.openEditModal(rt)),{success:!0,createdIds:U}}catch(U){return y(`Failed to create mapping: ${U.message}`,"error"),Logger.error("TEMPLATES","Failed to create mapping from payloads",U),{success:!1,createdIds:[]}}}function F(){let u=document.getElementById("template-name-modal");if(u)return u;u=document.createElement("div"),u.id="template-name-modal",u.className="modal hidden",u.innerHTML=`
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="template-name-title">
                <div class="modal-header">
                    <div class="modal-header-main">
                        <h3 id="template-name-title" class="modal-title">Save as template</h3>
                        <p class="modal-subtitle">Name your template to reuse it later.</p>
                    </div>
                    <button type="button" class="modal-close" aria-label="Close" data-action="close-template-name">\xD7</button>
                </div>
                <div class="modal-body">
                    <label class="form-label" for="template-name-input">Template name</label>
                    <input id="template-name-input" class="form-control" type="text" name="template-name" placeholder="My template" />
                    <p class="form-hint">Titles help you find templates quickly in the gallery.</p>
                </div>
                <div class="modal-footer">
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" data-action="cancel-template-name">Cancel</button>
                        <button type="button" class="btn btn-primary" data-action="confirm-template-name">Save template</button>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(u),u.addEventListener("click",O=>{O.target===u&&D(null)}),u.querySelectorAll('[data-action="close-template-name"], [data-action="cancel-template-name"]').forEach(O=>O.addEventListener("click",()=>D(null))),u.querySelector('[data-action="confirm-template-name"]').addEventListener("click",()=>{const k=u.querySelector("#template-name-input")?.value?.trim();D(k||null)});const T=u.querySelector("#template-name-input");return T?.addEventListener("keydown",O=>{O.key==="Enter"&&(O.preventDefault(),D(T.value.trim()||null))}),u}function D(u){document.getElementById("template-name-modal")?.classList.add("hidden"),typeof w=="function"&&(w(u),w=null)}function re(u=""){const b=F(),T=b.querySelector("#template-name-input");return T&&(T.value=u||"",setTimeout(()=>T.focus(),0)),b.classList.remove("hidden"),w&&D(null),new Promise(O=>{w=O})}const J={builtIn:null,user:null,userSignature:"",merged:null,mergedSignature:"",enriched:null,enrichedSignature:""};function se(u="all"){(u==="all"||u==="user")&&(J.user=null),J.merged=null,J.mergedSignature="",J.enriched=null,J.enrichedSignature=""}function ye(){if(J.builtIn)return[...J.builtIn];try{const u=e.MonacoTemplateLibrary?.getAll?.();return Array.isArray(u)?(J.builtIn=u.map(b=>({...b,source:"built-in"})),[...J.builtIn]):[]}catch(u){return Logger.warn("TEMPLATES","Unable to read Monaco template library:",u),[]}}function we(){const u=localStorage.getItem(n);if(J.user&&J.userSignature===u)return[...J.user];try{const b=u?JSON.parse(u):[];return J.user=Array.isArray(b)?b.map(T=>je(T)):[],J.userSignature=u||"",[...J.user]}catch(b){return Logger.warn("TEMPLATES","Failed to read user templates from storage:",b),[]}}function je(u){return{category:"custom",source:"user",...u,category:u?.category||"custom",source:u?.source||"user"}}function _e(u){try{const b=(u||[]).filter(Boolean).map(O=>je(O)),T=JSON.stringify(b);localStorage.setItem(n,T),J.user=[...b],J.userSignature=T,se("user")}catch(b){Logger.warn("TEMPLATES","Failed to persist user templates:",b)}}function ct(){const u=[...ye(),...we()],b=h();u.some(O=>O.id===b.id)||u.unshift(b);const T=u.map(O=>`${O.id}:${O.source||""}:${O.title||""}`).join("|");return J.merged&&J.mergedSignature===T?J.merged:(J.merged=u,J.mergedSignature=T,J.enriched=null,J.enrichedSignature="",u)}function Ve(){return ct()}function Rt(u){return Ve().find(b=>b.id===u)||null}function lt(u){const b=new Set,T=u.content||{},O=T.request||{},k=T.response||{},q=O.method||"ANY";return b.add(q),T.category&&b.add(T.category),u.category&&b.add(u.category),u.source==="user"&&b.add("custom"),(O.bodyPatterns||O.multipartPatterns)&&b.add("matching"),O.headers&&b.add("headers"),O.queryParameters&&b.add("query"),O.cookies&&b.add("cookies"),(O.urlPathPattern||O.urlPattern||O.urlPathTemplate)&&b.add("pattern"),Array.isArray(O.bodyPatterns)&&O.bodyPatterns.some(Q=>Q.matchesJsonPath||Q.matchesXPath)&&b.add("jsonpath"),(k.proxyBaseUrl||T.proxyBaseUrl)&&b.add("proxy"),(k.serveEventListeners||T.serveEventListeners||k.postServeActions)&&b.add("webhook"),(k.transformers||T.transformers)&&b.add("templating"),(k.fixedDelayMilliseconds||k.delayDistribution||k.chunkedDribbleDelay)&&b.add("delay"),k.fault&&b.add("fault"),T.mappings&&b.add("scenario"),u.popular&&b.add("popular"),Array.from(b)}function vt(u){const b=u.content||{},T=b.response||{};return T.proxyBaseUrl||b.proxyBaseUrl?"proxy":T.fault?"fault":T.status?`${T.status}`:Array.isArray(b.mappings)&&b.mappings.length?"scenario":"200"}function yt(u){const b=u.content||{},T=b.request||{};return T.method?T.method:Array.isArray(b.mappings)&&b.mappings[0]?.request?.method?b.mappings[0].request.method:"ANY"}function dt(u){const b=yt(u),T=vt(u),O=lt(u),k=!!u.popular||["basic","integration","proxy"].includes(u.category),q=Array.isArray(u.content?.mappings)&&u.content.mappings.length>0;return{...u,method:b,outcome:T,tags:O,popular:k,isScenario:q}}function oe(){const u=ct();return J.enriched&&J.enrichedSignature===J.mergedSignature||(J.enriched=u.map(dt),J.enrichedSignature=J.mergedSignature),J.enriched}function Ce(u){const b=document.createElement("option");b.value=u.id;const T=u.title||u.name||u.id;return b.textContent=u.source==="user"?`${T} (yours)`:T,b.dataset.source=u.source||"built-in",b}function Pe(){const u=Ve();[i.FORM,i.EDITOR].forEach(b=>{const T=document.getElementById(b);if(!T)return;const O=T.value;T.innerHTML='<option value="">Select a template</option>',u.forEach(k=>T.appendChild(Ce(k))),O&&u.some(k=>k.id===O)&&(T.value=O)})}function He(u){if(u==null||u==="")return null;if(typeof u=="object")return{jsonBody:u};try{return{jsonBody:JSON.parse(u)}}catch{return{body:u}}}function Ke(u){if(!u){y("Select a template first","warning");return}const b=u.content||{},T=b.request||{},O=b.response||{},k=document.getElementById("mapping-name"),q=document.getElementById("method"),B=document.getElementById("url-pattern"),Q=document.getElementById("response-status"),le=document.getElementById("response-body");k&&(k.value=b.name||u.title||u.id||""),q&&T.method&&(q.value=T.method),B&&(B.value=T.url||T.urlPath||""),Q&&typeof O.status<"u"&&(Q.value=O.status);const U=O.jsonBody??O.body;if(le&&typeof U<"u"){const ne=typeof U=="object"?JSON.stringify(U,null,2):String(U);le.value=ne}y(`Template "${u.title||u.id}" applied to form`,"success")}async function ut(){if(e.monacoInitializer?.isInitialized)return e.monacoInitializer;if(e.monacoInitializationPromise?.then)try{if(await e.monacoInitializationPromise,e.monacoInitializer?.isInitialized)return e.monacoInitializer}catch(u){Logger.warn("TEMPLATES","Monaco initializer failed to load in time",u)}return e.monacoInitializer}async function Qe(u){if(!u){y("Select a template first","warning");return}const b=u.content??{},T=await ut();if(T&&(typeof T.applyTemplate=="function"||typeof T.applyTemplateById=="function")){let q=!1;typeof T.applyTemplate=="function"?q=T.applyTemplate(u):q=T.applyTemplateById?.(u.id),y(q?`Template "${u.title||u.id}" applied to editor`:"Template could not be applied",q?"success":"error");return}const O=typeof b=="string"?b:JSON.stringify(b,null,2),k=document.getElementById("json-editor");if(k){k.value=O;try{const B=JSON.parse(typeof b=="string"?b:JSON.stringify(b));e.editorState&&(e.editorState.currentMapping=B,e.editorState.isDirty=!0)}catch(B){Logger.warn("TEMPLATES","Failed to parse template content into editorState:",B)}const q=document.getElementById("editor-dirty-indicator");q&&(q.style.display="inline")}y(`Template "${u.title||u.id}" applied to editor`,"success")}async function ve(u,b={}){const{openMode:T="inline"}=b;if(!u){y("Select a template first","warning");return}const O=Be(u);if(!O){y("Template content is not available","error");return}const k=Array.isArray(O)?O:[O],q=k.map((B,Q)=>({index:Q,error:Tt(B)})).filter(B=>!!B.error);if(q.length){const B=q[0];y(`Template is missing required fields (entry ${B.index+1}): ${B.error}`,"error");return}try{await j(k,{openMode:T,source:"template",successMessageFactory:B=>`Created ${B} mapping${B===1?"":"s"} from template`})}catch(B){y(`Failed to create mapping: ${B.message}`,"error"),Logger.error("TEMPLATES","Failed to create mapping from template",B)}finally{e.hideModal?.(r.GALLERY),e.hideModal?.(r.PREVIEW)}}function Fe(){const u=h();if(et()){ve(u,{openMode:l==="create-studio"?"studio":"inline"});return}nt(u,l)}async function Me(){const u=await re(document.getElementById("mapping-name")?.value||"")||"";if(!u.trim()){y("Template name is required","warning");return}const b=document.getElementById("method")?.value||"GET",T=document.getElementById("url-pattern")?.value||"/api/example",O=parseInt(document.getElementById("response-status")?.value,10)||200,k=document.getElementById("response-body")?.value||"",q=!!d.templateId&&(!d.target||d.target==="form"),B=q?we().find(le=>le.id===d.templateId):null,Q={id:q&&B?B.id:`user-${Date.now()}`,title:u.trim(),description:B?.description||"User template saved from mapping form",category:"custom",source:"user",content:{name:u.trim(),request:{method:b,urlPath:T},response:{status:O,...He(k)||{}}}};if(q&&B)Xe(B.id,Q),R(null),y(`Template "${u.trim()}" updated`,"success");else{const le=we();le.push(Q),_e(le),Te({force:!0}),Pe(),y(`Template "${u.trim()}" saved`,"success"),R(null)}}async function qe(u={}){const{skipNamePrompt:b=!1,reuseExistingMetadata:T=!1}=u,O=document.getElementById("json-editor");if(!O){y("Editor not available","warning");return}const k=!!d.templateId&&(!d.target||d.target==="editor"),q=k?we().find(U=>U.id===d.templateId):null;let B="";if(k&&q&&(b||T)?B=q.title||"":B=await re(q?.title||"")||"",!B.trim()){y("Template name is required","warning");return}let Q;try{Q=JSON.parse(O.value)}catch{y("Cannot save template: current JSON is invalid","error");return}const le={id:k&&q?q.id:`user-${Date.now()}`,title:B.trim(),description:T&&q?.description||q?.description||"User template saved from JSON editor",category:"custom",source:"user",content:Q};if(k&&q)Xe(q.id,le),R(null),y(`Template "${B.trim()}" updated`,"success");else{const U=we();U.push(le),_e(U),Te({force:!0}),Pe(),y(`Template "${B.trim()}" saved`,"success"),R(null)}}function Xe(u,b={}){if(!u)return null;const T=we(),O=T.findIndex(B=>B.id===u);if(O===-1)return null;const k=T[O],q=je({...k,...b.title?{title:b.title}:{},...b.description?{description:b.description}:{},...b.content?{content:b.content}:{}});return T[O]=q,_e(T),Te({force:!0}),Pe(),q}async function Ze(u,b={}){const T=we().find(k=>k.id===u);if(!T)return y("Template not found","warning"),!1;const O=b.target||(document.getElementById("json-editor")?"editor":"form");return R(u,O),O==="editor"?(nt(T,"editor"),y("Template loaded into JSON Studio. Save to keep changes.","info"),document.getElementById("update-mapping-btn")?.focus?.()):(nt(T,"form"),y("Template loaded into mapping form. Update and save to keep changes.","info"),document.getElementById("save-template-btn")?.focus?.()),!0}function pt(u,b={}){const{skipConfirm:T=!1}=b;if(!u)return!1;const O=we(),k=O.find(B=>B.id===u);if(!k||!T&&typeof e.confirm=="function"&&!e.confirm(`Delete template "${k.title||k.id}"? This cannot be undone.`))return!1;const q=O.filter(B=>B.id!==u);return _e(q),Te({force:!0}),Pe(),y(`Template "${k.title||k.id}" deleted`,"info"),d.templateId===u&&R(null),!0}function wt(u,b){return b?(Array.isArray(b)?b:String(b).split(".").map(O=>O.match(/^\d+$/)?Number(O):O)).reduce((O,k)=>O&&typeof O=="object"?O[k]:void 0,u):void 0}function St(u){if(u===null)return"null";if(typeof u>"u")return"";if(typeof u=="string")return u.length>64?`${u.slice(0,61)}\u2026`:u;if(typeof u=="number"||typeof u=="boolean")return String(u);try{const b=JSON.stringify(u);return b.length>80?`${b.slice(0,77)}\u2026`:b}catch(b){return Logger.warn("TEMPLATES","Failed to serialise feature value",b),""}}function Ue(u){if(!u||!u.feature)return null;const b=u.feature.path||u.feature,T=u.feature.label||(Array.isArray(b)?b.join("."):String(b)),O=wt(u.content,b);return typeof O>"u"?null:{label:T,value:St(O)}}function Lt(u){if(!u)return"";if(u.highlight)return u.highlight;const b=[];return u.content?.request?.method&&b.push(u.content.request.method),(u.content?.request?.url||u.content?.request?.urlPath)&&b.push(u.content.request.url||u.content.request.urlPath),b.join(" \xB7 ")}function Pt(u){try{const b=u.content?u.content:{};if(typeof b=="string")return b;const k=JSON.stringify(b,null,2).split(`
`).slice(0,24).join(`
`);return k.length>1280?`${k.slice(0,1279)}\u2026`:k}catch{return"[unavailable template preview]"}}function G(u){const b=typeof u=="string"?u:String(u??"");if(typeof navigator<"u"&&navigator.clipboard?.writeText)return navigator.clipboard.writeText(b).then(()=>!0).catch(()=>T(b));return Promise.resolve(T(b));function T(O){try{const k=document.createElement("textarea");return k.value=O,k.setAttribute("readonly",""),k.style.position="absolute",k.style.left="-9999px",document.body.appendChild(k),k.select(),document.execCommand("copy"),document.body.removeChild(k),!0}catch(k){return Logger.warn("TEMPLATES","Clipboard fallback failed:",k),!1}}}function et(u=l){return typeof u=="string"&&u.startsWith("create")}function bt(u,b){u.request||(u.request={}),u.response||(u.response={}),u.request.method||(u.request.method=b.method||"ANY"),u.request.url||u.request.urlPath||u.request.urlPattern||u.request.urlPathPattern||u.request.urlPathTemplate||(u.request.urlPath=b.urlPath||b.url||"/api/example"),typeof u.response.status!="number"&&!("fault"in u.response)&&(u.response.status=200)}function Be(u){if(!u)return null;let b=u.content??{};if(typeof b=="string")try{b=JSON.parse(b)}catch(B){Logger.warn("TEMPLATES","Failed to parse string template content:",B),b={}}const T=new Date().toISOString(),O=B=>{["id","uuid","stubMappingId","stubId","mappingId"].forEach(Q=>delete B[Q])},k=M();if(Array.isArray(b?.mappings))return b.mappings.map((Q,le)=>{const U=JSON.parse(JSON.stringify(Q||{}));return O(U),U.name=U.name||`${u.title||u.id||"Scenario mapping"} #${le+1}`,bt(U,k),be(U),U.metadata={...U.metadata||{},created:U.metadata?.created||T,edited:T,source:U.metadata?.source||"template"},U});const q=JSON.parse(JSON.stringify(b||{}));return O(q),q.name||(q.name=u.title||u.id||"New mapping"),bt(q,k),be(q),q.metadata={...q.metadata||{},created:q.metadata?.created||T,edited:T,source:q.metadata?.source||"template"},q}function Tt(u){if(!u||typeof u!="object")return"Mapping payload is empty";const b=u.request||{},T=u.response||{};if(!b.method)return"request.method is required";if(!!!(b.url||b.urlPath||b.urlPattern||b.urlPathPattern||b.urlPathTemplate))return"request URL or pattern is required";const k=typeof T.status=="number",q=!!T.fault;return!k&&!q?"response.status is required":null}function tt(){const u=document.getElementById("edit-mapping-modal");return u?(typeof e.showModal=="function"?e.showModal("edit-mapping-modal"):(u.classList.remove?.("hidden"),u.style.display="flex"),!0):!1}function nt(u,b=l){if(u){if(b==="create-inline"){ve(u,{openMode:"inline"});return}if(b==="create-studio"){ve(u,{openMode:"studio"});return}b==="editor"?(tt(),Qe(u)):Ke(u),e.hideModal?.(r.GALLERY),e.hideModal?.(r.PREVIEW)}}function Ee(u){const b=u.map(T=>`${T.id}:${T.source||""}:${T.title||""}:${T.method}:${T.outcome}`).join("|");return[l,c.goalId||"none",c.searchQuery,c.activeTags.join(","),c.showPopularOnly,b].join("|")}function ft(u,b){return b?b==="happy-path"?u.outcome.startsWith("2"):b==="errors"?["4","5"].includes(u.outcome.charAt(0)):b==="faults"?u.tags.includes("fault")||u.tags.includes("delay"):b==="scenarios"?u.isScenario:b==="dynamic"?u.tags.includes("templating"):b==="matching"?u.tags.includes("matching")||u.tags.includes("pattern")||u.tags.includes("jsonpath"):b==="webhooks"?u.tags.includes("webhook"):b==="proxy"?u.tags.includes("proxy"):b==="custom"?u.source==="user":!0:!0}function Ct(u){return oe().filter(b=>ft(b,u))}function kt(u,b){u.innerHTML=`
            <div class="template-wizard__grid template-wizard__goals"></div>
            <div class="template-wizard__actions">
                <button type="button" class="btn btn-ghost" data-action="show-all">Show all templates</button>
                <div class="template-wizard__actions-right">
                    <button type="button" class="btn btn-primary" data-action="create-empty">Create empty</button>
                </div>
            </div>
        `;const T=u.querySelector(".template-wizard__grid");a.forEach(O=>{const k=b.filter(B=>ft(B,O.id)).length,q=document.createElement("button");q.type="button",q.className="template-goal",q.dataset.goalId=O.id,q.innerHTML=`
                <span class="template-goal__icon" aria-hidden="true">${O.icon}</span>
                <span class="template-goal__title">${O.title}</span>
                <span class="template-goal__subtitle">${O.subtitle}</span>
                <span class="template-goal__count">${k} templates</span>
            `,q.style.setProperty("--goal-color",O.color),q.disabled=k===0,q.addEventListener("click",()=>{c.goalId=O.id,c.step="templates",c.activeTags=[],c.searchQuery="",c.showPopularOnly=!1,Te({force:!0})}),T.appendChild(q)}),u.querySelectorAll('[data-action="show-all"]').forEach(O=>{O.addEventListener("click",()=>{c.goalId=null,c.step="templates",Te({force:!0})})}),u.querySelectorAll('[data-action="create-empty"]').forEach(O=>{O.addEventListener("click",()=>{Fe()})})}function $t(u,b){const T=u.outcome==="proxy"?"proxy":u.outcome==="fault"?"fault":u.outcome,O=et(l),k=document.createElement("div");return k.className="template-card template-card--wizard",k.dataset.templateId=u.id,k.setAttribute("role","button"),k.tabIndex=0,k.innerHTML=`
            <div class="template-card__header">
                <span class="badge badge-soft" data-method="${u.method}">${u.method}</span>
                <span class="badge badge-soft" data-outcome="${u.outcome}">${T}</span>
                ${u.isScenario?`<span class="badge badge-soft badge-scenario">${u.content?.mappings?.length||0} steps</span>`:""}
                ${u.popular?'<span class="template-card__star" aria-hidden="true">\u2B50</span>':""}
            </div>
            <div class="template-card__title">${u.title||u.name||u.id}</div>
            <div class="template-card__desc">${u.description||"WireMock template"}</div>
            <div class="template-card__meta">${Lt(u)}</div>
            <div class="template-card__tags">
                ${u.tags.slice(0,4).map(q=>`<span class="chip">${q}</span>`).join("")}
            </div>
            <div class="template-card__actions">
                <button class="btn btn-primary btn-sm" type="button" data-card-action="select">${O?"Create":"Select"}</button>
                <button class="btn btn-secondary btn-sm" type="button" data-card-action="details">Details</button>
                ${u.source==="user"?'<button class="btn btn-ghost btn-sm" type="button" data-card-action="edit-template">Edit</button>':""}
                ${u.source==="user"?'<button class="btn btn-ghost btn-sm" type="button" data-card-action="delete-template">Delete</button>':""}
            </div>
        `,k.addEventListener("click",q=>{const B=q.target instanceof HTMLElement?q.target.closest("[data-card-action]"):null;if(B){q.stopPropagation();const Q=B.dataset.cardAction;if(Q==="edit-template"){Ze(u.id);return}if(Q==="delete-template"){pt(u.id);return}}b(u)}),k.addEventListener("keydown",q=>{(q.key==="Enter"||q.key===" ")&&(q.preventDefault(),b(u))}),k}function xt(u,b){const T=Ct(c.goalId),O=Array.from(new Set(T.flatMap(U=>U.tags))).sort(),k=!c.goalId;let q=T.filter(U=>{if(c.showPopularOnly&&!U.popular||c.activeTags.length&&!c.activeTags.every(Oe=>U.tags.includes(Oe)))return!1;if(!c.searchQuery)return!0;const ne=c.searchQuery.toLowerCase();return(U.title||U.id).toLowerCase().includes(ne)||(U.description||"").toLowerCase().includes(ne)||U.tags.some(Oe=>Oe.toLowerCase().includes(ne))});u.innerHTML=`
            <div class="template-toolbar template-toolbar--wizard">
                <div class="template-toolbar__search">
                    <svg class="icon icon-16" aria-hidden="true" focusable="false"><use href="#icon-search"></use></svg>
                    <input type="search" placeholder="Search templates..." value="${c.searchQuery}" aria-label="Search templates" />
                </div>
                <div class="template-toolbar__actions">
                    <button type="button" class="btn btn-ghost btn-sm" data-action="show-all" ${k?"disabled":""}>Show all</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-action="toggle-popular" aria-pressed="${c.showPopularOnly}">\u2B50 Popular</button>
                    <button type="button" class="btn btn-primary btn-sm" data-action="create-empty">Create empty</button>
                </div>
            </div>
            <div class="template-tags" aria-label="Tags">
                ${O.map(U=>`<button type="button" class="chip chip--toggle ${c.activeTags.includes(U)?"is-active":""}" data-tag="${U}">${U}</button>`).join("")}
            </div>
            <div class="template-wizard__grid template-wizard__cards" id="template-wizard-cards"></div>
            <div class="template-info template-info--inline">
                <p class="template-info__lead">Need more examples? Visit the <a href="https://library.wiremock.org/" target="_blank" rel="noopener">official WireMock Template Library</a> and import JSON via Import/Export \u2192 Import Data.</p>
            </div>
        `;const B=u.querySelector("#template-wizard-cards"),Q=document.createElement("div");Q.className="history-empty",Q.innerHTML="<p>No templates found</p><small>Adjust filters or import JSON from the WireMock Template Library.</small>",q.length?q.forEach(U=>{B.appendChild($t(U,ne=>{c.selectedTemplateId=ne.id,c.step="preview",Te({force:!0})}))}):B.replaceWith(Q);const le=u.querySelector('input[type="search"]');le&&le.addEventListener("input",U=>{c.searchQuery=U.target.value,Te({force:!0})}),u.querySelectorAll('[data-action="toggle-popular"]').forEach(U=>{U.addEventListener("click",()=>{c.showPopularOnly=!c.showPopularOnly,Te({force:!0})})}),u.querySelectorAll('[data-action="show-all"]').forEach(U=>{U.addEventListener("click",()=>{c.goalId=null,c.step="templates",Te({force:!0})})}),u.querySelectorAll('[data-action="create-empty"]').forEach(U=>{U.addEventListener("click",()=>{Fe()})}),u.querySelectorAll("[data-tag]").forEach(U=>{U.addEventListener("click",()=>{const ne=U.dataset.tag;c.activeTags.includes(ne)?c.activeTags=c.activeTags.filter(Oe=>Oe!==ne):c.activeTags=[...c.activeTags,ne],Te({force:!0})})})}function it(u,b){const T=b.find(ne=>ne.id===c.selectedTemplateId);if(!T){c.step="templates",Te({force:!0});return}const O=et(l),k=Lt(T),q=Ue(T),B=Pt(T),Q=T.tags||[];u.innerHTML=`
            <div class="template-preview-card">
                <div class="template-preview-card__meta">
                    <div class="template-preview-card__badges">
                        <span class="badge badge-soft" data-method="${T.method}">${T.method}</span>
                        <span class="badge badge-soft" data-outcome="${T.outcome}">${T.outcome==="proxy"?"proxy":T.outcome}</span>
                        ${T.isScenario?`<span class="badge badge-soft badge-scenario">${T.content?.mappings?.length||0} steps</span>`:""}
                    </div>
                    <h4 class="template-preview-card__title">${T.title||T.name||T.id}</h4>
                    <p class="template-preview-card__desc">${T.description||""}</p>
                    <div class="template-preview-card__summary">${k||"\u2014"}</div>
                    ${q?`<div class="template-preview-meta__row"><span class="template-preview-meta__label">${q.label}</span><code class="template-preview-meta__code">${q.value}</code></div>`:""}
                    <div class="template-preview-card__tags">${Q.map(ne=>`<span class="chip">${ne}</span>`).join("")}</div>
                </div>
                <pre class="template-preview-card__code" id="template-preview-code-inline"></pre>
            </div>
            <div class="template-preview-actions template-preview-actions--wizard" id="template-preview-actions">
                <div class="template-preview-actions__primary">
                    ${O?'<button class="btn btn-primary btn-sm" type="button" data-template-action="apply">Create and open editor</button>':'<button class="btn btn-primary btn-sm" type="button" data-template-action="apply">Use template</button>'}
                    ${O?'<button class="btn btn-secondary btn-sm" type="button" data-template-action="create-studio">Create in JSON Studio</button>':""}
                    <button class="btn btn-secondary btn-sm" type="button" data-template-action="copy">Copy JSON</button>
                </div>
                ${T.source==="user"?`<div class="template-preview-actions__secondary">
                        <button class="btn btn-ghost btn-sm" type="button" data-template-action="edit-template">Edit template</button>
                        <button class="btn btn-ghost btn-sm" type="button" data-template-action="delete-template">Delete</button>
                    </div>`:""}
            </div>
        `;const le=u.querySelector("#template-preview-code-inline");le&&(le.textContent=B);const U=u.querySelector("#template-preview-actions");U&&U.addEventListener("click",async ne=>{const Oe=ne.target instanceof HTMLElement?ne.target.closest("[data-template-action]"):null;if(!Oe)return;const $e=Oe.dataset.templateAction;if($e==="apply"){nt(T,l);return}if($e==="create-studio"){ve(T,{openMode:"studio"});return}if($e==="copy"){const rt=typeof T.content=="string"?T.content:JSON.stringify(T.content,null,2),Re=await G(rt);y(Re?`Template "${T.title}" copied`:"Clipboard copy failed",Re?"success":"error")}if($e==="edit-template"){await Ze(T.id);return}$e==="delete-template"&&pt(T.id)})}function Dt(){if(c.step==="preview"){c.step="templates";return}c.step="goals",c.goalId=null,c.selectedTemplateId=null}function Te(u={}){const{force:b=!1}=u,T=document.getElementById("template-gallery-shell");if(T)try{const O=oe(),k=Ee(O);if(!b&&k===m)return;m=k;const q=c.step==="goals"?1:c.step==="templates"?2:3,B=a.find(ne=>ne.id===c.goalId),Q=c.step!=="goals";T.innerHTML=`
                <div class="template-wizard">
                    <div class="template-wizard__header">
                        <div>
                            <p class="template-wizard__eyebrow">Step ${q}/3</p>
                            <h3 class="template-wizard__title">${c.step==="goals"?"Create a mapping":B?.title||"Pick a template"}</h3>
                            <p class="template-wizard__subtitle">${c.step==="goals"?"Choose the scenario that fits your testing goal":B?.description||""}</p>
                        </div>
                        <div class="template-wizard__header-actions">
                            <div class="template-wizard__progress" role="progressbar" aria-label="Wizard progress" aria-valuemin="1" aria-valuemax="3" aria-valuenow="${q}">
                                <span class="sr-only">Step ${q} of 3</span>
                                ${[1,2,3].map(ne=>`<span class="template-wizard__dot ${ne<=q?"is-active":""}" aria-current="${ne===q?"step":"false"}" aria-label="Step ${ne}"></span>`).join("")}
                            </div>
                            ${Q?'<button type="button" class="btn btn-ghost btn-sm" id="template-wizard-back">\u2190 Back</button>':""}
                        </div>
                    </div>
                    <div class="template-wizard__body" id="template-wizard-body"></div>
                </div>
            `;const le=T.querySelector("#template-wizard-body");if(!le)return;O.length?c.step==="goals"?kt(le,O):c.step==="templates"?xt(le,O):it(le,O):le.innerHTML='<div class="history-empty"><p>No templates available</p><small>Add or import templates to populate this view.</small></div>';const U=T.querySelector("#template-wizard-back");U&&U.addEventListener("click",()=>{Dt(),Te({force:!0})})}catch(O){Logger.error("TEMPLATES","Failed to render template wizard",O),T.innerHTML='<div class="history-empty"><p>Templates unavailable</p><small>Reload the page or try again later.</small></div>'}}function At(u="form"){l=u,c.step="goals",c.goalId=null,c.selectedTemplateId=null,c.searchQuery="",c.activeTags=[],c.showPopularOnly=!1;try{Te({force:!0})}catch(O){Logger.error("TEMPLATES","Unable to prepare template gallery",O);const k=document.getElementById("template-gallery-shell");k&&(k.innerHTML='<div class="history-empty"><p>Templates unavailable</p><small>Reload the page or try again later.</small></div>')}if(typeof e.showModal=="function"){e.showModal(r.GALLERY);return}const T=document.getElementById(r.GALLERY);T&&(T.classList.remove("hidden"),T.style.display="flex")}function Ft(){document.querySelectorAll("[data-template-trigger]").forEach(u=>{u.addEventListener("click",b=>{b.preventDefault(),At(u.dataset.templateTarget||"form")})})}function Nt(){try{Pe(),Te()}catch(u){Logger.error("TEMPLATES","Template manager failed to initialize",u);const b=document.getElementById("template-gallery-shell");b&&(b.innerHTML='<div class="history-empty"><p>Templates unavailable</p><small>Reload the page or try again later.</small></div>')}Ft(),document.getElementById("save-template-btn")?.addEventListener("click",u=>{u.preventDefault(),Me()}),document.getElementById("editor-save-template")?.addEventListener("click",u=>{u.preventDefault(),qe()})}e.TemplateManager={getTemplates:Ve,refresh:Pe,openGallery:Te,openGalleryForTarget:At,getTemplatesWithMeta:oe,getEmptyTemplateSeed:M,getEmptyMappingContent:v,applyTemplateToForm:Ke,applyTemplateToEditor:Qe,createMappingFromTemplate:ve,createMappingsFromPayloads:j,prepareMappingForCreation:x,createEmptyMapping:Fe,saveFormAsTemplate:Me,saveEditorAsTemplate:qe,updateUserTemplate:Xe,editUserTemplate:Ze,deleteUserTemplate:pt},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Nt):Nt()})(typeof window<"u"?window:globalThis);function executeMappingFilters(){const e=document.getElementById("filter-query")?.value?.trim()||"";window.FilterManager.saveFilterState("mappings",{query:e}),updateURLFilterParams(e,"mappings");const n=window.originalMappings;if(!Array.isArray(n)||n.length===0){const l=document.getElementById(SELECTORS.EMPTY.MAPPINGS),d=document.getElementById(SELECTORS.LISTS.MAPPINGS);l&&(l.classList.remove("hidden"),l.removeAttribute("aria-hidden")),d&&(d.style.display="none"),typeof updateMappingsCounter=="function"&&updateMappingsCounter();return}let i;e?window.QueryParser&&typeof window.QueryParser.filterMappingsByQuery=="function"?i=window.QueryParser.filterMappingsByQuery(n,e):(Logger.warn("MANAGERS","[Mapping Filter] QueryParser or filterMappingsByQuery is not available. Showing all mappings."),i=n):i=n,window._filteredMappings=i;const r=document.getElementById(SELECTORS.LISTS.MAPPINGS),a=document.getElementById(SELECTORS.EMPTY.MAPPINGS),s=document.getElementById(SELECTORS.LOADING.MAPPINGS);if(!r)return;const c=[...i].sort((l,d)=>{const m=l?.priority??1,w=d?.priority??1;if(m!==w)return m-w;const E={GET:1,POST:2,PUT:3,PATCH:4,DELETE:5},M=E[l?.request?.method]||999,C=E[d?.request?.method]||999;if(M!==C)return M-C;const v=l?.request?.url||l?.request?.urlPattern||l?.request?.urlPath||"",h=d?.request?.url||d?.request?.urlPattern||d?.request?.urlPath||"";return v.localeCompare(h)});if(window.PaginationManager){window.PaginationManager.updateState(c.length);const l=window.PaginationManager.getCurrentPageItems(c);renderList(r,l,{renderItem:renderMappingMarkup,getKey:getMappingRenderKey,getSignature:getMappingRenderSignature});const d=document.getElementById("mappings-pagination");d&&(d.innerHTML=window.PaginationManager.renderControls())}else renderList(r,c,{renderItem:renderMappingMarkup,getKey:getMappingRenderKey,getSignature:getMappingRenderSignature});s&&s.classList.add("hidden"),c.length===0?(a&&(a.classList.remove("hidden"),a.removeAttribute("aria-hidden")),r.style.display="none"):(a&&(a.classList.add("hidden"),a.setAttribute("aria-hidden","true")),r.style.display="block"),typeof updateMappingsCounter=="function"&&updateMappingsCounter()}function executeRequestFilters(){const e=document.getElementById("req-filter-query")?.value?.trim()||"",n=document.getElementById("req-filter-from"),i=document.getElementById("req-filter-to"),r=n?.value||"",a=i?.value||"";if(window.FilterManager.saveFilterState("requests",{query:e,from:r,to:a}),updateURLFilterParams(e,"requests"),!Array.isArray(window.originalRequests)||window.originalRequests.length===0){window.allRequests=[];const E=document.getElementById(SELECTORS.EMPTY.REQUESTS),M=document.getElementById(SELECTORS.LISTS.REQUESTS);E&&E.classList.remove("hidden"),M&&(M.style.display="none"),typeof updateRequestsCounter=="function"&&updateRequestsCounter();return}let s=e&&window.QueryParser?window.QueryParser.filterRequestsByQuery(window.originalRequests,e):window.originalRequests;const c=r?new Date(r).getTime():null,l=a?new Date(a).getTime():null;(c!==null||l!==null)&&(s=s.filter(E=>{if(!E)return!1;const M=new Date(E.request?.loggedDate||E.loggedDate).getTime();return!(c!==null&&Number.isFinite(c)&&(!Number.isFinite(M)||M<c)||l!==null&&Number.isFinite(l)&&(!Number.isFinite(M)||M>l))})),window.allRequests=s;const d=document.getElementById(SELECTORS.LISTS.REQUESTS),m=document.getElementById(SELECTORS.EMPTY.REQUESTS),w=document.getElementById(SELECTORS.LOADING.REQUESTS);d&&(renderList(d,window.allRequests,{renderItem:renderRequestMarkup,getKey:getRequestRenderKey,getSignature:getRequestRenderSignature}),w&&w.classList.add("hidden"),window.allRequests.length===0?(m&&m.classList.remove("hidden"),d.style.display="none"):(m&&m.classList.add("hidden"),d.style.display="block"),typeof updateRequestsCounter=="function"&&updateRequestsCounter(),Logger.debug("MANAGERS",`Filtered requests: ${window.allRequests.length} items`))}function getRenderKey(t,...e){if(!t||typeof t!="object")return"";for(const n of e){const i=n.includes(".")?n.split(".").reduce((r,a)=>r?.[a],t):t[n];if(i!=null)return String(i)}return""}function getMappingRenderKey(t){return getRenderKey(t,"id","uuid","stubId")}function getMappingRenderSignature(t){if(!t||typeof t!="object")return"";const e=t.request||{},n=t.response||{},i=t.metadata||{},r=a=>{if(a==null)return"";try{const s=typeof a=="string"?a:JSON.stringify(a);return s.length>300?`${s.slice(0,300)}\u2026`:s}catch{return""}};return[e.method||"",e.url||e.urlPattern||e.urlPath||e.urlPathPattern||"",n.status||"",n.fixedDelayMilliseconds||"",t.name||i.name||"",t.priority??"",t.scenarioName||"",i.edited||i.created||"",i.source||"",r(e.headers),r(e.bodyPatterns||e.body||""),r(e.queryParameters),r(n.headers),r(n.jsonBody!==void 0?n.jsonBody:n.body||""),r(i.additionalMetadata||i.tags||i.description||"")].join("|")}function renderMappingMarkup(t){return typeof window.renderMappingCard=="function"?window.renderMappingCard(t):""}function getRequestRenderKey(t){return getRenderKey(t,"id","requestId","mappingUuid","request.id","request.loggedDate","loggedDate")}function getRequestRenderSignature(t){if(!t||typeof t!="object")return"";const e=t.request||{},n=t.responseDefinition||{};return[e.method||"",e.url||e.urlPath||"",e.loggedDate||t.loggedDate||"",t.wasMatched===!1?"unmatched":"matched",n.status??"",(n.body||n.jsonBody||"").length,(e.body||"").length].join("|")}function renderRequestMarkup(t){return typeof window.renderRequestCard=="function"?window.renderRequestCard(t):""}window.FilterManager._applyMappingFilters=window.debounce(executeMappingFilters,180),window.FilterManager._applyRequestFilters=window.debounce(executeRequestFilters,180),window.applyFilters=()=>{FilterManager.applyMappingFilters(),typeof window._updateActiveFiltersDisplayDebounced=="function"?window._updateActiveFiltersDisplayDebounced():typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay()},window.clearMappingFilters=()=>{const t=document.getElementById("filter-query");t&&(t.value=""),FilterManager.applyMappingFilters(),typeof FilterManager.flushMappingFilters=="function"&&FilterManager.flushMappingFilters(),typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay(),typeof window.updateURLFilterParams=="function"&&window.updateURLFilterParams("","mappings")},window.toggleQueryHelp=(t="mappings")=>{const e=t==="requests"?"req-query-help":"query-help",n=document.getElementById(e);if(!n)return;const i=n.classList.contains("hidden"),r=document.querySelector(`[aria-controls="${e}"]`);i?(n.classList.remove("hidden"),r&&(r.textContent="\xD7",r.setAttribute("aria-expanded","true"))):(n.classList.add("hidden"),r&&(r.textContent="?",r.setAttribute("aria-expanded","false")))},window.applyQuickMethodFilter=t=>{const e=document.getElementById("filter-query");if(!e)return;const n=e.value.trim(),i=/method:[^\s]+/;i.test(n)?e.value=n.replace(i,`method:${t}`):e.value=n?`method:${t} ${n}`:`method:${t}`,applyFilters(),updateActiveFiltersDisplay()},window.updateActiveFiltersDisplay=()=>{const t=document.getElementById("filter-query"),e=document.getElementById("active-filters"),n=document.getElementById("active-filters-list");if(!t||!e||!n)return;const i=t.value.trim();if(!i){e.classList.add("filter-hidden");return}const r=window.QueryParser?window.QueryParser.parseQuery(i):null;if(!r||Object.keys(r).length===0){e.classList.add("filter-hidden");return}const a=[];for(const[s,c]of Object.entries(r)){if(s==="text")continue;let l="";if(typeof c=="object"&&c.exclude){const d=Array.isArray(c.exclude)?c.exclude.join(","):c.exclude;l=`-${s}:${d}`}else typeof c=="object"&&c.from&&c.to?l=`${s}:${c.from}-${c.to}`:Array.isArray(c)?l=`${s}:${c.join(",")}`:l=`${s}:${c}`;a.push(`
            <button type="button"
                    class="filter-chip filter-chip-active"
                    data-action="remove-active-filter"
                    data-filter-key="${Utils.escapeHtml(s)}"
                    title="Click to remove">
                ${Utils.escapeHtml(l)}
                <span class="filter-chip-remove" aria-hidden="true">\xD7</span>
            </button>
        `)}n.innerHTML=a.join(""),a.length>0?e.classList.remove("filter-hidden"):e.classList.add("filter-hidden")},window._updateActiveFiltersDisplayDebounced=window.debounce?window.debounce(window.updateActiveFiltersDisplay,200):window.updateActiveFiltersDisplay,window.removeActiveFilter=t=>{const e=document.getElementById("filter-query");if(!e)return;const n=e.value.trim(),i=[new RegExp(`-?${t}:[^\\s]+`,"g"),new RegExp(`\\s+${t}:[^\\s]+`,"g"),new RegExp(`${t}:[^\\s]+\\s+`,"g")];let r=n;for(const a of i)r=r.replace(a," ");r=r.replace(/\s+/g," ").trim(),e.value=r,applyFilters(),updateActiveFiltersDisplay()},window.applyRequestFilters=()=>FilterManager.applyRequestFilters();function applyDateRange(t,e,n,i){t&&(t.value=Utils.formatDateTime(n)),e&&(e.value=Utils.formatDateTime(i)),FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters()}window.applyQuickFilter=()=>{const t=document.getElementById(SELECTORS.REQUEST_FILTERS.QUICK);if(!t)return;const e=t.value,n=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM),i=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO);if(!e){n&&(n.value=""),i&&(i.value=""),FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters();return}const r=new Date,a=new Date(r),s=e.match(/^(\d+)([mhd])$/);if(!s)return;const c=parseInt(s[1]);switch(s[2]){case"m":a.setMinutes(a.getMinutes()-c);break;case"h":a.setHours(a.getHours()-c);break;case"d":a.setDate(a.getDate()-c);break;default:return}applyDateRange(n,i,a,r)},window.clearQuickTimeFilter=()=>{const t=document.getElementById("req-filter-quick");t&&(t.value="")},window.applyQuickTimeFilter=()=>{const t=document.getElementById("req-filter-quick"),e=document.getElementById("req-filter-from"),n=document.getElementById("req-filter-to");if(!t||!e||!n)return;const i=t.value;if(!i){e.value="",n.value="",FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters();return}const r=new Date;let a=new Date(r);const s=i.match(/^(\d+)([mhd])$/);if(s){const c=parseInt(s[1],10);switch(s[2]){case"m":a.setMinutes(a.getMinutes()-c);break;case"h":a.setHours(a.getHours()-c);break;case"d":a.setDate(a.getDate()-c);break}}applyDateRange(e,n,a,r)},window.clearRequestFilters=()=>{const t=document.getElementById("req-filter-query");t&&(t.value="");const e=document.getElementById("req-filter-from"),n=document.getElementById("req-filter-to"),i=document.getElementById("req-filter-quick");e&&(e.value=""),n&&(n.value=""),i&&(i.value=""),FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters(),typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay(),typeof window.updateURLFilterParams=="function"&&window.updateURLFilterParams("","requests")},window.applyQuickRequestFilter=t=>{const e=document.getElementById("req-filter-query");if(!e)return;const n=e.value.trim();if(/^[A-Z]+$/.test(t)){const i=/method:[\w,]+/i;i.test(n)?e.value=n.replace(i,`method:${t}`):e.value=n?`method:${t} ${n}`:`method:${t}`}else{const i=t.match(/^(\w+):/);if(i){const r=i[1],a=new RegExp(`${r}:[^\\s]+`,"i");a.test(n)?e.value=n.replace(a,t):e.value=n?`${t} ${n}`:t}else e.value=n?`${t} ${n}`:t}FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters(),typeof window._updateRequestActiveFiltersDisplayDebounced=="function"?window._updateRequestActiveFiltersDisplayDebounced():typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay()},window.updateRequestActiveFiltersDisplay=()=>{const t=document.getElementById("req-active-filters"),e=document.getElementById("req-filter-query");if(!t||!e)return;const n=e.value.trim();if(!n||!window.QueryParser){t.innerHTML="",t.classList.add("filter-hidden");return}const i=window.QueryParser.parseQuery(n);if(!i){t.innerHTML="",t.classList.add("filter-hidden");return}const r=[];for(const[a,s]of Object.entries(i)){if(a==="text")continue;let c="";if(a==="matched"){const l=Array.isArray(s)?s:[s],d=String(l[0]).toLowerCase();d==="true"||d==="yes"||d==="1"?c="Matched":c="Unmatched"}else if(Array.isArray(s))c=`${a}: ${s.join(", ")}`;else if(typeof s=="object"&&s.exclude){const l=Array.isArray(s.exclude)?s.exclude:[s.exclude];c=`NOT ${a}: ${l.join(", ")}`}else c=`${a}: ${s}`;r.push(`<button type="button" class="filter-chip filter-chip-active" data-action="remove-request-active-filter" data-filter-key="${Utils.escapeHtml(a)}" title="Remove filter">${Utils.escapeHtml(c)} \xD7</button>`)}t.innerHTML=r.join(""),r.length>0?t.classList.remove("filter-hidden"):t.classList.add("filter-hidden")},window._updateRequestActiveFiltersDisplayDebounced=window.debounce?window.debounce(window.updateRequestActiveFiltersDisplay,200):window.updateRequestActiveFiltersDisplay,window.removeRequestActiveFilter=t=>{const e=document.getElementById("req-filter-query");if(!e)return;const n=e.value.trim();if(!n)return;const i=new RegExp(`-?${t}:[\\w\\/\\*.,\\-]+(\\s+|$)`,"gi"),r=n.replace(i,"").replace(/\s+/g," ").trim();e.value=r,FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters(),typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay()};function getSavedFilters(t){const e=`saved-filters-${t}`;try{const n=localStorage.getItem(e);return n?JSON.parse(n):[]}catch(n){return Logger.warn("FILTERS",`Failed to load saved filters for ${t}:`,n),[]}}function setSavedFilters(t,e){const n=`saved-filters-${t}`;try{localStorage.setItem(n,JSON.stringify(e))}catch(i){Logger.error("FILTERS",`Failed to save filters for ${t}:`,i)}}window.saveCurrentMappingFilter=()=>{const t=document.getElementById("filter-query");if(!t)return;const e=t.value.trim();if(!e){typeof NotificationManager<"u"&&NotificationManager.warning("No filter to save");return}const n=prompt("Enter a name for this filter:",e.substring(0,30));if(!n)return;const i=getSavedFilters("mappings"),r=i.findIndex(a=>a.name===n);if(r>=0){if(!confirm(`Filter "${n}" already exists. Overwrite?`))return;i[r]={name:n,query:e}}else i.push({name:n,query:e});setSavedFilters("mappings",i),updateSavedFiltersDisplay("mappings"),typeof NotificationManager<"u"&&NotificationManager.success(`Filter "${n}" saved`)},window.saveCurrentRequestFilter=()=>{const t=document.getElementById("req-filter-query");if(!t)return;const e=t.value.trim();if(!e){typeof NotificationManager<"u"&&NotificationManager.warning("No filter to save");return}const n=prompt("Enter a name for this filter:",e.substring(0,30));if(!n)return;const i=getSavedFilters("requests"),r=i.findIndex(a=>a.name===n);if(r>=0){if(!confirm(`Filter "${n}" already exists. Overwrite?`))return;i[r]={name:n,query:e}}else i.push({name:n,query:e});setSavedFilters("requests",i),updateSavedFiltersDisplay("requests"),typeof NotificationManager<"u"&&NotificationManager.success(`Filter "${n}" saved`)},window.applySavedFilter=(t,e)=>{const i=getSavedFilters(t).find(r=>r.name===e);if(!i){Logger.warn("FILTERS",`Saved filter "${e}" not found`);return}if(t==="mappings"){const r=document.getElementById("filter-query");r&&(r.value=i.query,applyFilters(),updateActiveFiltersDisplay())}else if(t==="requests"){const r=document.getElementById("req-filter-query");r&&(r.value=i.query,FilterManager.applyRequestFilters(),updateRequestActiveFiltersDisplay())}},window.deleteSavedFilter=(t,e)=>{const i=getSavedFilters(t).filter(r=>r.name!==e);setSavedFilters(t,i),updateSavedFiltersDisplay(t),typeof NotificationManager<"u"&&NotificationManager.info(`Filter "${e}" deleted`)};function updateSavedFiltersDisplay(t){const e=getSavedFilters(t);let n,i;if(t==="mappings")n="saved-filters-list",i="saved-filters-separator";else if(t==="requests")n="req-saved-filters-list",i="req-saved-filters-separator";else return;const r=document.getElementById(n),a=document.getElementById(i);if(!r)return;if(e.length===0){r.classList.add("filter-hidden"),a&&a.classList.add("filter-hidden");return}const s=e.map(c=>`
        <button type="button"
                class="filter-chip filter-chip-saved"
                data-action="apply-saved-filter"
                data-filter-tab="${Utils.escapeHtml(t)}"
                data-filter-name="${Utils.escapeHtml(c.name)}"
                title="${Utils.escapeHtml(c.query)}">
            <span class="filter-chip-text">${Utils.escapeHtml(c.name)}</span>
            <span class="filter-chip-remove"
                  data-action="delete-saved-filter"
                  data-filter-tab="${Utils.escapeHtml(t)}"
                  data-filter-name="${Utils.escapeHtml(c.name)}"
                  title="Delete filter"
                  aria-label="Delete filter">\xD7</span>
        </button>
    `);r.innerHTML=s.join(""),r.classList.remove("filter-hidden"),a&&a.classList.remove("filter-hidden")}if(window.loadAllSavedFilters=()=>{updateSavedFiltersDisplay("mappings"),updateSavedFiltersDisplay("requests")},!window._filterChipDelegationInitialized){let t=function(n){const i=n.target.closest('[data-action="delete-saved-filter"]');if(i){n.stopPropagation();const c=i.dataset.filterTab,l=i.dataset.filterName;c&&l&&window.deleteSavedFilter(c,l);return}const r=n.target.closest('[data-action="apply-saved-filter"]');if(r){const c=r.dataset.filterTab,l=r.dataset.filterName;c&&l&&window.applySavedFilter(c,l);return}const a=n.target.closest('[data-action="remove-active-filter"]');if(a){const c=a.dataset.filterKey;c&&window.removeActiveFilter(c);return}const s=n.target.closest('[data-action="remove-request-active-filter"]');if(s){const c=s.dataset.filterKey;c&&window.removeRequestActiveFilter(c);return}};window._filterChipDelegationInitialized=!0,["active-filters-list","req-active-filters","saved-filters-list","req-saved-filters-list"].forEach(n=>{const i=document.getElementById(n);i&&i.addEventListener("click",t)})}function isCacheEnabled(){try{const t=document.getElementById("cache-enabled"),e=typeof window.readWiremockSettings=="function"?window.readWiremockSettings():{},n=t&&typeof t.checked=="boolean"?t.checked:!0;return e.cacheEnabled!==!1&&n}catch(t){return Logger.warn("CACHE","Failed to resolve cache enabled state. Defaulting to cache disabled. Check settings configuration.",t),!1}}window.isCacheEnabled=isCacheEnabled,window.connectToWireMock=async()=>{const t=document.getElementById("wiremock-host")||document.getElementById(SELECTORS.CONNECTION.HOST),e=document.getElementById("wiremock-port")||document.getElementById(SELECTORS.CONNECTION.PORT);let n,i;if(t&&e)n=t.value.trim()||"localhost",i=e.value.trim()||"8080";else if(window.wiremockBaseUrl)Logger.api("Using existing wiremockBaseUrl for connection"),n="localhost",i="8080";else{const c=typeof window.readWiremockSettings=="function"?window.readWiremockSettings():{};n=c.host||"localhost",i=c.port||"8080",Logger.api("Using settings for connection:",{host:n,port:i})}Logger.api("Connecting with:",{host:n,port:i});const r=document.getElementById(SELECTORS.CONNECTION.STATUS_DOT),a=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT),s=document.getElementById(SELECTORS.LOADING.MAPPINGS);if(r&&(r.className="status-dot connecting"),a&&(a.textContent="Connecting..."),s&&s.classList.remove("hidden"),!window.wiremockBaseUrl||t){if(typeof window.normalizeWiremockBaseUrl=="function")window.wiremockBaseUrl=window.normalizeWiremockBaseUrl(n,i);else{const c=/^(https?:)\/\//i.test(n),l=c?n.split(":")[0]:"http",d=c?n.replace(/^(https?:)\/\//i,""):n,m=i&&String(i).trim()||(l==="https"?"443":"8080");window.wiremockBaseUrl=`${l}://${d}:${m}/__admin`}Logger.api("Updated wiremockBaseUrl:",window.wiremockBaseUrl)}else Logger.api("Using pre-configured wiremockBaseUrl:",window.wiremockBaseUrl);try{await checkHealthAndStartUptime(),Logger.info("API","Online mode - proceeding with data loading");const c=document.getElementById(SELECTORS.CONNECTION.SETUP),l=document.getElementById(SELECTORS.BUTTONS.ADD_MAPPING);r&&(r.className="status-dot connected"),a&&(window.lastWiremockSuccess||(window.lastWiremockSuccess=Date.now()),typeof window.updateLastSuccessUI=="function"&&window.updateLastSuccessUI()),c&&(c.style.display="none"),l&&(l.disabled=!1);const d=document.getElementById(SELECTORS.UI.STATS),m=document.getElementById("stats-spacer"),w=document.getElementById(SELECTORS.UI.SEARCH_FILTERS);d&&(d.style.display="flex"),m&&(m.style.display="none"),w&&(w.style.display="block"),startHealthCheck(),Logger.info("API","Using new optimized sync engine");const E=isCacheEnabled();Logger.info("CACHE",`Service cache is ${E?"enabled":"disabled"} for this session`),window.SyncEngine.stop(),await window.SyncEngine.coldStart({useCache:E}),window.SyncEngine.start(),await loadScenarios(),typeof window.hideOnboardingOverlay=="function"&&window.hideOnboardingOverlay(),typeof window.FilterManager?.restoreFilters=="function"&&window.FilterManager.restoreFilters("mappings")?.query&&typeof window.FilterManager.applyMappingFilters=="function"&&(window.FilterManager.applyMappingFilters(),typeof window.FilterManager.flushMappingFilters=="function"&&window.FilterManager.flushMappingFilters()),NotificationManager.success("Connected to WireMock successfully!")}catch(c){Logger.error("API","Connection error - entering offline mode:",c),Logger.warn("API","Offline mode - no server requests will be made"),stopUptime(),r&&(r.className="status-dot disconnected"),a&&(a.textContent="Offline"),s&&s.classList.add("hidden"),NotificationManager.warning("WireMock server is offline. Retrying connection in background..."),startHealthCheck()}};let healthCheckTimeout=null,healthCheckFailureCount=0;window.startHealthCheck=()=>{healthCheckTimeout&&(clearTimeout(healthCheckTimeout),healthCheckTimeout=null);let t;window.isOnline?t=3e4:t=Math.min(2e3*Math.pow(2,healthCheckFailureCount),6e4),Logger.info("HEALTH",`Scheduling next check in ${t}ms (${window.isOnline?"online":`offline, attempt ${healthCheckFailureCount+1}`})`),healthCheckTimeout=setTimeout(async()=>{try{const e=performance.now();let n=!1,i=0;try{const a=await apiFetch(ENDPOINTS.HEALTH);i=Math.round(performance.now()-e),n=typeof a=="object"&&(typeof a.status=="string"&&["up","healthy","ok"].includes(a.status.toLowerCase())||a.healthy===!0)}catch(a){if(a?.message?.includes("404")||a?.status===404){Logger.warn("HEALTH","/health not found (404), trying /mappings fallback for older WireMock");try{const c=await window.apiFetch(window.ENDPOINTS.MAPPINGS);i=Math.round(performance.now()-e),n=typeof c=="object"&&c!==null&&!c.__isDemo}catch{n=!1}}else n=!1}const r=window.isOnline;if(window.isOnline=n,n){healthCheckFailureCount=0;const a=document.getElementById(SELECTORS.HEALTH.INDICATOR);a&&(a.innerHTML=`<span>Response Time: </span><span class="healthy">${i}ms</span>`),r?Logger.info("HEALTH",`Server is healthy (${i}ms)`):(Logger.info("HEALTH",`Server is back online (${i}ms)`),NotificationManager.success("WireMock server is back online! Reconnecting..."),await window.connectToWireMock())}else{healthCheckFailureCount++;const a=document.getElementById(SELECTORS.HEALTH.INDICATOR);if(a&&(a.innerHTML='<span>Response Time: </span><span class="unhealthy">Offline</span>'),r){Logger.warn("HEALTH","Server went offline"),stopUptime();const s=document.getElementById(SELECTORS.CONNECTION.STATUS_DOT),c=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT);s&&(s.className="status-dot disconnected"),c&&(c.textContent="Offline"),NotificationManager.warning("WireMock server went offline. Retrying in background...")}else Logger.warn("HEALTH",`Server still offline (attempt ${healthCheckFailureCount})`)}startHealthCheck()}catch(e){Logger.error("HEALTH","Check error:",e),window.isOnline=!1,healthCheckFailureCount++,startHealthCheck()}},t)},window.stopHealthCheck=()=>{healthCheckTimeout&&(clearTimeout(healthCheckTimeout),healthCheckTimeout=null,healthCheckFailureCount=0,Logger.info("HEALTH","Health check stopped"))},window.checkHealthAndStartUptime=async()=>{try{const t=performance.now();let e=0,n=!1;try{const i=await apiFetch(ENDPOINTS.HEALTH);e=Math.round(performance.now()-t),n=typeof i=="object"&&(typeof i.status=="string"&&["up","healthy","ok"].includes(i.status.toLowerCase())||i.healthy===!0),Logger.info("HEALTH","initial check:",{rawStatus:i?.status,healthyFlag:i?.healthy,isHealthy:n})}catch(i){if(i?.message?.includes("404")||i?.status===404){Logger.warn("HEALTH","/health not found (404), trying /mappings fallback for older WireMock");try{const a=await window.apiFetch(window.ENDPOINTS.MAPPINGS);e=Math.round(performance.now()-t),n=typeof a=="object"&&a!==null&&!a.__isDemo,Logger.info("HEALTH","fallback check (mappings):",{isHealthy:n,responseTime:e})}catch{Logger.warn("HEALTH","fallback failed - offline mode"),n=!1}}else Logger.warn("HEALTH","connection failed - offline mode"),n=!1}if(n){if(window.isOnline=!0,window.startTime=Date.now(),window.uptimeInterval&&window.LifecycleManager.clearInterval(window.uptimeInterval),window.uptimeInterval=window.LifecycleManager.setNamedInterval("uptime-display",updateUptime,1e3),typeof window.applyHealthUI=="function")try{window.applyHealthUI(!0,e)}catch(r){Logger.warn("HEALTH","applyHealthUI failed:",r)}const i=document.getElementById(SELECTORS.HEALTH.INDICATOR);i&&(i.style.display="inline",i.innerHTML=`<span>Response Time: </span><span class="healthy">${e}ms</span>`),Logger.info("HEALTH",`WireMock health check passed (${e}ms), uptime started, online mode`)}else throw window.isOnline=!1,new Error("WireMock is not reachable - offline mode")}catch(t){throw window.isOnline=!1,Logger.error("HEALTH","Health check failed - entering offline mode:",t),t}},(function(){const e=new Map,n=new Map,i=new Set,r=new Map,a={setInterval(s,c){const l=window.setInterval(s,c);return e.set(l,{delay:c,createdAt:Date.now()}),Logger.debug("LIFECYCLE",`Interval created: ${l} (${c}ms)`),l},clearInterval(s){if(s!=null){window.clearInterval(s);const c=e.get(s);e.delete(s),Logger.debug("LIFECYCLE",`Interval cleared: ${s}${c?` (${c.delay}ms, ${Date.now()-c.createdAt}ms ago)`:""}`)}},setTimeout(s,c){const l=window.setTimeout(s,c);return n.set(l,{delay:c,createdAt:Date.now()}),Logger.debug("LIFECYCLE",`Timeout created: ${l} (${c}ms)`),l},clearTimeout(s){if(s!=null){window.clearTimeout(s);const c=n.get(s);n.delete(s),Logger.debug("LIFECYCLE",`Timeout cleared: ${s}${c?` (${c.delay}ms, ${Date.now()-c.createdAt}ms ago)`:""}`)}},requestAnimationFrame(s){const l=(window.requestAnimationFrame||function(d){return setTimeout(d,16)})(s);return i.add(l),Logger.debug("LIFECYCLE",`Animation frame requested: ${l}`),l},cancelAnimationFrame(s){s!=null&&((window.cancelAnimationFrame||clearTimeout)(s),i.delete(s),Logger.debug("LIFECYCLE",`Animation frame cancelled: ${s}`))},addEventListener(s,c,l,d){if(!s||!c||!l){Logger.warn("LIFECYCLE","addEventListener called with missing parameters",{target:s,type:c,handler:!!l});return}s.addEventListener(c,l,d),r.has(s)||r.set(s,new Set),r.get(s).add({type:c,handler:l,options:d});const m=s.id||s.className||s.tagName||"unknown";Logger.debug("LIFECYCLE",`Event listener added: ${c} on ${m}`)},removeEventListener(s,c,l,d){if(!s||!c||!l){Logger.warn("LIFECYCLE","removeEventListener called with missing parameters",{target:s,type:c,handler:!!l});return}s.removeEventListener(c,l,d);const m=r.get(s);if(m){for(const E of m)if(E.type===c&&E.handler===l&&JSON.stringify(E.options)===JSON.stringify(d)){m.delete(E);break}m.size===0&&r.delete(s)}const w=s.id||s.className||s.tagName||"unknown";Logger.debug("LIFECYCLE",`Event listener removed: ${c} on ${w}`)},setNamedInterval(s,c,l){const d=window.setInterval(c,l);return e.set(d,{name:s,delay:l,createdAt:Date.now()}),Logger.debug("LIFECYCLE",`Named interval created: ${s||d} (${l}ms)`),d},getStats(){const s=Array.from(e.entries()).map(([d,m])=>({id:d,name:m.name||`interval-${d}`,delay:m.delay,age:Date.now()-m.createdAt})),c=Array.from(n.entries()).map(([d,m])=>({id:d,name:m.name||`timeout-${d}`,delay:m.delay,age:Date.now()-m.createdAt})),l=Array.from(r.entries()).map(([d,m])=>({target:d.id||d.className||d.tagName||"unknown",eventTypes:Array.from(m).map(E=>E.type),count:m.size}));return{activeIntervals:e.size,activeTimeouts:n.size,activeAnimationFrames:i.size,activeEventListeners:r.size,details:{intervals:s,timeouts:c,animationFrames:Array.from(i),eventListeners:l}}},clearAll(){Logger.debug("LIFECYCLE","Clearing all lifecycle resources");const s=e.size,c=n.size,l=i.size,d=r.size;e.forEach((m,w)=>window.clearInterval(w)),e.clear(),n.forEach((m,w)=>window.clearTimeout(w)),n.clear(),i.forEach(m=>window.cancelAnimationFrame(m)),i.clear(),r.forEach((m,w)=>{m.forEach(({type:E,handler:M,options:C})=>{w.removeEventListener(E,M,C)})}),r.clear(),Logger.debug("LIFECYCLE",`Cleared ${s} intervals, ${c} timeouts, ${l} animation frames, ${d} event listeners`)}};window.LifecycleManager=a,window.addEventListener("beforeunload",()=>{Logger.info("LIFECYCLE","Page unloading, cleaning up resources");try{if(a.clearAll(),window.CacheIntervals&&typeof window.CacheIntervals.stop=="function"&&(Logger.info("LIFECYCLE","Stopping cache intervals"),window.CacheIntervals.stop()),window.SyncEngine&&typeof window.SyncEngine.stop=="function"&&(Logger.info("LIFECYCLE","Stopping sync engine"),window.SyncEngine.stop()),typeof window.cleanupPendingDeletions=="function"&&(Logger.info("LIFECYCLE","Cleaning up pending deletions"),window.cleanupPendingDeletions()),window.deletionTimeouts instanceof Map){Logger.info("LIFECYCLE","Cleaning up deletion timeouts");for(const s of window.deletionTimeouts.values())clearTimeout(s);window.deletionTimeouts.clear()}if(window.pendingDeletedIds instanceof Set&&(Logger.info("LIFECYCLE","Clearing pending deleted IDs"),window.pendingDeletedIds.clear()),typeof window.stopUptime=="function"&&(Logger.info("LIFECYCLE","Stopping uptime tracking"),window.stopUptime()),typeof window.stopHealthCheck=="function"&&(Logger.info("LIFECYCLE","Stopping health check"),window.stopHealthCheck()),window.optimisticShadowMappings&&window.optimisticShadowMappings.clear&&(Logger.info("LIFECYCLE","Clearing optimistic shadow mappings"),window.optimisticShadowMappings.clear()),window.CacheService&&typeof window.CacheService.clear=="function"&&(Logger.info("LIFECYCLE","Clearing CacheService"),window.CacheService.clear()),window.elementCache&&window.elementCache.clear&&(Logger.info("LIFECYCLE","Clearing element cache"),window.elementCache.clear()),window.autoRefreshInterval&&(Logger.info("LIFECYCLE","Clearing auto-refresh interval"),clearInterval(window.autoRefreshInterval),window.autoRefreshInterval=null),typeof window.cacheRefreshChannel<"u"&&window.cacheRefreshChannel){Logger.info("LIFECYCLE","Closing cache refresh BroadcastChannel");try{window.cacheRefreshChannel.close()}catch(s){Logger.warn("LIFECYCLE","Failed to close cache refresh BroadcastChannel:",s)}}if(typeof window.optimisticUpdateChannel<"u"&&window.optimisticUpdateChannel){Logger.info("LIFECYCLE","Closing optimistic update BroadcastChannel");try{window.optimisticUpdateChannel.close()}catch(s){Logger.warn("LIFECYCLE","Failed to close optimistic update BroadcastChannel:",s)}}Logger.info("LIFECYCLE","Cleanup completed successfully")}catch(s){Logger.error("LIFECYCLE","Error during cleanup:",s)}})})(),window.debounce=function(e,n=150,i={}){let r,a,s,c;const{leading:l=!1,trailing:d=!0}=i,m=()=>{r=void 0,d&&a&&(c=e.apply(s,a),a=s=void 0)};return Object.assign(function(...E){return a=E,s=this,r===void 0?(l&&(c=e.apply(s,a),a=s=void 0),r=window.setTimeout(m,n)):(window.clearTimeout(r),r=window.setTimeout(m,n)),c},{cancel(){r!==void 0&&window.clearTimeout(r),r=void 0,a=s=void 0},flush(){return r!==void 0&&(window.clearTimeout(r),m()),c}})},Logger.debug("LIFECYCLE","Lifecycle module loaded"),window.MappingsStore={items:new Map,metadata:{serverVersion:null,lastFullSync:null,lastIncrementalSync:null,isSyncing:!1,syncError:null},pending:new Map,indexes:{byMethod:new Map,byUrl:new Map,byPriority:new Map,byScenario:new Map},stats:{totalMappings:0,pendingOperations:0,lastSyncDuration:0},requests:new Map,getAllRequests(){return Array.from(this.requests.values())},setRequests(t){this.requests.clear(),Array.isArray(t)&&t.forEach(e=>{const n=e.id||e.uuid||e.request&&e.request.url||Date.now().toString();n&&this.requests.set(n,e)})},init(){Logger.info("STORE","Initializing MappingsStore"),this.clear(),Logger.info("STORE","MappingsStore initialized")},get(t){if(!t)return null;const e=this.pending.get(t);return e&&e.type!=="delete"?e.optimisticMapping:this.items.get(t)||null},getAll(){const t=[];return this.items.forEach((e,n)=>{const i=this.pending.get(n);i&&i.type==="delete"||(i&&i.type==="update"?t.push(i.optimisticMapping):t.push(e))}),this.pending.forEach((e,n)=>{e.type==="create"&&!this.items.has(n)&&t.push(e.optimisticMapping)}),t},setFromServer(t,e={}){Logger.info("STORE",`Setting ${t.length} mappings from server`),this.items.clear(),t.forEach(n=>{const i=n.id||n.uuid;i&&this.items.set(i,n)}),this.metadata.serverVersion=e.version||e.etag||null,this.metadata.lastFullSync=Date.now(),this.rebuildIndexes(),this._updateStats(),Logger.info("STORE",`Loaded ${this.items.size} mappings`)},applyChanges({added:t=[],updated:e=[],deleted:n=[]}){Logger.info("STORE",`Applying changes: +${t.length} ~${e.length} -${n.length}`);const i=[];return e.forEach(r=>{const a=r.id||r.uuid,s=this.pending.get(a);if(s&&s.type==="update"){i.push({id:a,type:"update",local:s.optimisticMapping,server:r,localTimestamp:s.timestamp});return}this.items.set(a,r),this._addToIndexes(a,r)}),n.forEach(r=>{this.pending.has(r)&&i.push({id:r,type:"delete",local:this.pending.get(r).optimisticMapping,server:null}),this.items.delete(r),this._removeFromIndexes(r)}),t.forEach(r=>{const a=r.id||r.uuid;this.items.set(a,r),this._addToIndexes(a,r)}),this.metadata.lastIncrementalSync=Date.now(),this._updateStats(),i},addPending(t){const{id:e,type:n,payload:i,optimisticMapping:r}=t;this.pending.set(e,{id:e,type:n,payload:i,optimisticMapping:r,timestamp:Date.now(),retries:0}),Logger.debug("STORE",`Added pending ${n}: ${e}`),this._updateStats()},confirmPending(t,e=null){const n=this.pending.get(t);if(n){if(Logger.info("STORE",`Confirmed pending ${n.type}: ${t}`),n.type==="create"&&e){const i=e.id||e.uuid;this.items.set(i,e),this._addToIndexes(i,e)}else n.type==="update"&&e?(this.items.set(t,e),this._addToIndexes(t,e)):n.type==="delete"&&(this.items.delete(t),this._removeFromIndexes(t));this.pending.delete(t),this._updateStats()}},rollbackPending(t,e=null){const n=this.pending.get(t);n&&(Logger.warn("STORE",`Rolling back pending ${n.type}: ${t}`),n.type==="create"?this.items.delete(t):n.type==="update"&&e?(this.items.set(t,e),this._addToIndexes(t,e)):n.type==="delete"&&e&&(this.items.set(t,e),this._addToIndexes(t,e)),this.pending.delete(t),this._updateStats())},rebuildIndexes(){Object.values(this.indexes).forEach(t=>t.clear()),this.items.forEach((t,e)=>{this._addToIndexes(e,t)}),Logger.debug("STORE",`Rebuilt indexes for ${this.items.size} mappings`)},filter({method:t,url:e,priority:n,scenario:i}){let r=new Set(this.items.keys());if(t){const a=this.indexes.byMethod.get(t.toUpperCase());if(a)r=this._intersect(r,a);else return[]}if(e){const a=this.indexes.byUrl.get(e);a?r=this._intersect(r,a):r=new Set([...r].filter(s=>{const c=this.items.get(s);return this._matchesUrl(c,e)}))}if(n!==void 0){const a=this.indexes.byPriority.get(n);if(a)r=this._intersect(r,a);else return[]}if(i){const a=this.indexes.byScenario.get(i);if(a)r=this._intersect(r,a);else return[]}return Array.from(r).map(a=>this.get(a)).filter(Boolean)},clear(){this.items.clear(),this.pending.clear(),Object.values(this.indexes).forEach(t=>t.clear()),this.metadata={serverVersion:null,lastFullSync:null,lastIncrementalSync:null,isSyncing:!1,syncError:null},this._updateStats(),Logger.info("STORE","Cleared all data")},_addToIndexes(t,e){const n=e.request?.method||"GET";this.indexes.byMethod.has(n)||this.indexes.byMethod.set(n,new Set),this.indexes.byMethod.get(n).add(t);const i=e.request?.urlPattern||e.request?.url||e.request?.urlPath;i&&(this.indexes.byUrl.has(i)||this.indexes.byUrl.set(i,new Set),this.indexes.byUrl.get(i).add(t));const r=e.priority||1;this.indexes.byPriority.has(r)||this.indexes.byPriority.set(r,new Set),this.indexes.byPriority.get(r).add(t),e.scenarioName&&(this.indexes.byScenario.has(e.scenarioName)||this.indexes.byScenario.set(e.scenarioName,new Set),this.indexes.byScenario.get(e.scenarioName).add(t))},_removeFromIndexes(t){Object.values(this.indexes).forEach(e=>{e.forEach((n,i)=>{n.delete(t),n.size===0&&e.delete(i)})})},_intersect(t,e){const n=new Set;return t.forEach(i=>{e.has(i)&&n.add(i)}),n},_matchesUrl(t,e){const n=t.request?.urlPattern||t.request?.url||t.request?.urlPath||"";if(n===e)return!0;try{return new RegExp(e).test(n)}catch{return n.includes(e)}},_updateStats(){this.stats.totalMappings=this.items.size,this.stats.pendingOperations=this.pending.size}},typeof window<"u"&&(window.MappingsStore.init(),Object.defineProperty(window,"originalMappings",{get:function(){return window.MappingsStore?window.MappingsStore.getAll():[]},configurable:!0,enumerable:!0}),Object.defineProperty(window,"allMappings",{get:function(){return window._filteredMappings?window._filteredMappings:window.MappingsStore?window.MappingsStore.getAll():[]},configurable:!0,enumerable:!0}),Object.defineProperty(window,"originalRequests",{get:function(){return window.MappingsStore?window.MappingsStore.getAllRequests():[]},set:function(t){window.MappingsStore&&typeof window.MappingsStore.setRequests=="function"&&window.MappingsStore.setRequests(t);try{delete window._filteredRequests}catch{}},configurable:!0,enumerable:!0}),Object.defineProperty(window,"allRequests",{get:function(){return window._filteredRequests?window._filteredRequests:window.MappingsStore?window.MappingsStore.getAllRequests():[]},set:function(t){window._filteredRequests=Array.isArray(t)?t:[]},configurable:!0,enumerable:!0})),window.SyncEngine={config:{incrementalInterval:3e4,fullSyncInterval:3e5,fullSyncTimeout:6e4,cacheRebuildInterval:6e4,cacheMaxAge:36e5,maxRetries:3,retryDelay:2e3},timers:{incremental:null,fullSync:null,cacheRebuild:null},isStarted:!1,lastCacheHash:null,isIncrementalSyncing:!1,isFullSyncing:!1,useServiceCache:!0,init(){Logger.info("SYNC","Initializing SyncEngine"),this.stop(),Logger.info("SYNC","SyncEngine initialized")},start(){if(this.isStarted){Logger.debug("SYNC","Sync timers already running, skipping start");return}Logger.info("SYNC","Starting sync timers"),this.isStarted=!0,this.timers.incremental=window.LifecycleManager.setInterval(()=>this.incrementalSync(),this.config.incrementalInterval),this.timers.fullSync=window.LifecycleManager.setInterval(()=>this.fullSync({background:!0}),this.config.fullSyncInterval),this.useServiceCache&&(this.timers.cacheRebuild=window.LifecycleManager.setInterval(()=>this.rebuildServiceCache(),this.config.cacheRebuildInterval)),Logger.info("SYNC","Sync timers started")},stop(){Logger.info("SYNC","Stopping sync timers"),Object.keys(this.timers).forEach(t=>{this.timers[t]&&(window.LifecycleManager.clearInterval(this.timers[t]),this.timers[t]=null)}),this.isStarted=!1},async coldStart(t={}){const e=t.useCache===!0;this.useServiceCache=e,Logger.info("SYNC",`Cold start - loading from ${e?"cache or server":"server only"}`),typeof window.showLoadingState=="function"&&window.showLoadingState();try{if(e){const n=await this.loadFromServiceCache();n&&n.items&&n.items.length>0&&(Logger.info("SYNC",`Loaded ${n.items.length} mappings from cache`),window.MappingsStore.setFromServer(n.items,{version:n.version}),typeof window.fetchAndRenderMappings=="function"&&window.fetchAndRenderMappings(window.MappingsStore.getAll(),{source:"cache"}),window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function"&&window.FilterManager.applyMappingFilters(),typeof window.updateDataSourceIndicator=="function"&&window.updateDataSourceIndicator("cache"),Logger.info("SYNC","Initial UI rendered from cache"))}Logger.info("SYNC","Starting background full sync for latest data"),await this.fullSync({background:!0})}catch(n){Logger.error("SYNC","Cold start failed:",n);try{await this.fullSync({background:!1})}catch(i){throw Logger.error("SYNC","Fallback full sync also failed:",i),i}}},async fullSync({background:t=!1}={}){if(this.isFullSyncing){Logger.debug("SYNC","Full sync already in progress, skipping overlapping run");return}if(window.MappingsStore.metadata.isSyncing||window.MappingsStore.metadata.isOptimisticUpdate){Logger.debug("SYNC","Already syncing or optimistic update in progress, skipping full sync");return}this.isFullSyncing=!0,Logger.info("SYNC",`Starting full sync (background: ${t})`),t&&this._showSyncIndicator(),window.MappingsStore.metadata.isSyncing=!0,window.MappingsStore.metadata.syncStartTime=Date.now();const e=Date.now();try{const n=await this._fetchWithTimeout(typeof window.fetchMappingsFromServer=="function"?window.fetchMappingsFromServer({force:!0}):fetch(`${window.wiremockBaseUrl}/mappings`).then(c=>c.json()),this.config.fullSyncTimeout),i=n.mappings||[],r=n.meta?.version||n.meta?.etag||null;Logger.info("SYNC",`Received ${i.length} mappings from server`);const a=i.filter(c=>(c.id||c.uuid)!=="00000000-0000-0000-0000-00000000cace"&&!this._isServiceCacheMapping(c));window.MappingsStore.setFromServer(a,{version:r}),typeof window.fetchAndRenderMappings=="function"&&window.fetchAndRenderMappings(window.MappingsStore.getAll(),{source:"direct",skipSyncCheck:!0}),window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function"&&window.FilterManager.applyMappingFilters(),typeof window.updateDataSourceIndicator=="function"&&window.updateDataSourceIndicator("synced");const s=Date.now()-e;window.MappingsStore.stats.lastSyncDuration=s,Logger.info("SYNC",`Full sync completed in ${s}ms`)}catch(n){if(Logger.error("SYNC","Full sync failed:",n),window.MappingsStore.metadata.syncError=n.message,!t)throw n}finally{this.isFullSyncing=!1,window.MappingsStore.metadata.isSyncing=!1,window.MappingsStore.metadata.syncStartTime=null,this._hideSyncIndicator()}},async incrementalSync(){if(this.isIncrementalSyncing){Logger.debug("SYNC","Incremental sync already in progress, skipping overlapping run");return}this.isIncrementalSyncing=!0;try{if(window.MappingsStore.metadata.isSyncing||window.MappingsStore.metadata.isOptimisticUpdate){Logger.debug("SYNC","Already syncing or optimistic update in progress, skipping incremental sync");return}if(this.isFullSyncing){Logger.debug("SYNC","Full sync in progress, skipping incremental");return}if(!window.MappingsStore.metadata.lastFullSync){Logger.debug("SYNC","No full sync yet, skipping incremental");return}Logger.debug("SYNC","Starting lightweight incremental sync check");const t=Date.now()-(window.MappingsStore.metadata.lastFullSync||0),e=this.config.fullSyncInterval/2;t>e?Logger.debug("SYNC",`Data approaching staleness (${Math.round(t/1e3)}s since last sync), will refresh on next full sync`):Logger.debug("SYNC",`Data is fresh (${Math.round(t/1e3)}s since last sync), skipping server check`)}finally{this.isIncrementalSyncing=!1}},async loadFromServiceCache(){if(!this.useServiceCache)return null;try{Logger.debug("SYNC","Attempting to load from Service Cache");let t;try{t=await window.apiFetch("/mappings/00000000-0000-0000-0000-00000000cace")}catch(a){if(a.status===404)return Logger.debug("SYNC","Service Cache not found"),null;throw a}const e=t.response?.jsonBody||t,n=e.items||e.mappings;if(!n||!Array.isArray(n))return Logger.warn("SYNC","Invalid cache format"),null;const i={...e,items:n},r=Date.now()-(i.timestamp||0);return r>this.config.cacheMaxAge?(Logger.info("SYNC",`Cache is stale (${Math.round(r/1e3)}s old), skipping`),null):(Logger.info("SYNC",`Service Cache loaded (${i.items.length} items, ${Math.round(r/1e3)}s old)`),i)}catch(t){return Logger.warn("SYNC","Failed to load Service Cache:",t),null}},async rebuildServiceCache(){if(!this.useServiceCache)return;if(window.MappingsStore.pending.size>0||window.MappingsStore.metadata.isOptimisticUpdate){Logger.debug("SYNC","Skipping cache rebuild - pending operations or optimistic updates exist");return}const t=this._hashMappings(window.MappingsStore.items);if(t===this.lastCacheHash){Logger.debug("SYNC","Skipping cache rebuild - no changes");return}Logger.info("SYNC","Rebuilding Service Cache");try{const e={timestamp:Date.now(),version:window.MappingsStore.metadata.serverVersion,items:Array.from(window.MappingsStore.items.values()),count:window.MappingsStore.items.size},n={...e,items:e.items.map(r=>{if(!r||typeof r!="object")return r;const a={...r};return delete a._pending,delete a._operation,delete a._deleted,delete a.__optimisticTs,a.request&&(delete a.request._pending,delete a.request._operation,delete a.request._deleted),a.response&&(delete a.response._pending,delete a.response._operation,delete a.response._deleted),a})},i={id:"00000000-0000-0000-0000-00000000cace",priority:1e3,request:{method:"GET",url:"/__imock/cache/v2"},response:{status:200,jsonBody:n}};try{await window.apiFetch(`/mappings/${i.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}catch(r){if(r.status===404)await window.apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});else throw r}this.lastCacheHash=t,Logger.info("SYNC",`Service Cache saved (${e.count} mappings)`)}catch(e){Logger.warn("SYNC","Failed to rebuild Service Cache:",e)}},_detectChanges(t){const e=new Set(t.map(s=>s.id||s.uuid)),n=new Set(window.MappingsStore.items.keys()),i=[],r=[],a=[];return t.forEach(s=>{const c=s.id||s.uuid;if(!n.has(c))i.push(s);else{const l=window.MappingsStore.items.get(c);this._hasChanged(l,s)&&r.push(s)}}),n.forEach(s=>{e.has(s)||a.push(s)}),{added:i,updated:r,deleted:a,hasChanges:i.length>0||r.length>0||a.length>0}},_hasChanged(t,e){try{return JSON.stringify(t)!==JSON.stringify(e)}catch{return!0}},_handleConflicts(t){Logger.warn("SYNC",`Handling ${t.length} conflicts`),t.forEach(e=>{if(e.type==="delete"){if(Logger.warn("SYNC",`Conflict: mapping ${e.id} was deleted on server`),window.NotificationManager&&typeof window.NotificationManager.warning=="function"){const n=e.local?.name||e.id;window.NotificationManager.warning(`Mapping "${n}" was deleted by another user`)}window.MappingsStore.pending.delete(e.id)}else if(e.type==="update"){const n=this._getTimestamp(e.server),i=e.localTimestamp||Date.now();if(n>i){if(Logger.warn("SYNC",`Conflict: server version is newer for ${e.id}`),window.NotificationManager&&typeof window.NotificationManager.warning=="function"){const r=e.server?.name||e.id;window.NotificationManager.warning(`Your changes to "${r}" were overwritten by another user`)}window.MappingsStore.rollbackPending(e.id,e.server)}else Logger.warn("SYNC",`Conflict: local version is newer for ${e.id}, keeping local`)}})},_getTimestamp(t){return t?.metadata?.edited||t?.metadata?.updated||t?.metadata?.created||0},_formatChangesSummary(t){const e=[];return t.added.length>0&&e.push(`+${t.added.length} added`),t.updated.length>0&&e.push(`~${t.updated.length} updated`),t.deleted.length>0&&e.push(`-${t.deleted.length} deleted`),e.join(", ")},_hashMappings(t){if(t.size===0)return"0:";const e=Array.from(t.keys());if(e.length>1e3){const n=e.slice(0,50).sort().join("|").substring(0,100),i=e.slice(-50).sort().join("|").substring(0,100),r=`${n}...${i}`;return`${t.size}:${this._simpleHash(r)}`}else{const n=e.sort().join(",");return`${t.size}:${n}`}},_simpleHash(t){let e=0;for(let n=0;n<t.length;n++){const i=t.charCodeAt(n);e=(e<<5)-e+i,e|=0}return Math.abs(e).toString(36)},_isServiceCacheMapping(t){return(t.id||t.uuid)==="00000000-0000-0000-0000-00000000cace"||t.request?.url?.includes("/__imock/cache")},_fetchWithTimeout(t,e){return Promise.race([t,new Promise((n,i)=>setTimeout(()=>i(new Error("Request timeout")),e))])},_showSyncIndicator(){const t=document.getElementById("sync-indicator");t&&t.classList.add("is-active")},_hideSyncIndicator(){const t=document.getElementById("sync-indicator");t&&t.classList.remove("is-active")}},typeof window<"u"&&window.SyncEngine.init();function normalizeScenarioNameValue(t){if(t==null)return{original:t,normalized:t,changed:!1,cleared:!1,hadWhitespace:!1};const e=typeof t=="string"?t:String(t),n=/\s/.test(e),i=e.trim().replace(/\s+/g,"_");return{original:e,normalized:i,changed:i!==e,cleared:!!e&&!i,hadWhitespace:n}}function normalizeScenarioNameField(t,{notify:e}={}){if(!t||typeof t!="object")return{changed:!1};if(!Object.prototype.hasOwnProperty.call(t,"scenarioName"))return{changed:!1};const i=(typeof window.Utils?.normalizeScenarioName=="function"?window.Utils.normalizeScenarioName:normalizeScenarioNameValue)(t.scenarioName);return!i?.changed||!i?.hadWhitespace?{changed:!1}:(i.cleared?(delete t.scenarioName,e?.("Scenario name contained only whitespace and was cleared")):(t.scenarioName=i.normalized,e?.(`Scenario name cannot contain spaces. Replaced with "${i.normalized}"`)),{changed:!0,original:i.original,normalized:i.normalized,cleared:i.cleared})}window.MappingsOperations={async create(t){const e={...t||{}};normalizeScenarioNameField(e,{notify:r=>window.NotificationManager?.warning?.(r)});const n=typeof crypto?.randomUUID=="function"?`temp-${crypto.randomUUID()}`:`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;Logger.info("OPS",`Creating mapping with temp ID: ${n}`);const i={...e,id:n,_pending:!0,_operation:"create"};try{window.MappingsStore.addPending({id:n,type:"create",payload:e,optimisticMapping:i}),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.info=="function"&&window.NotificationManager.info("Creating mapping...");const r=await this._sendCreateRequest(e),a=r.id||r.uuid;if(Logger.info("OPS",`Mapping created on server with ID: ${a}`),window.MappingsStore.confirmPending(n,r),this._refreshUI(),this._broadcastUpdate("created",r),window.NotificationManager&&typeof window.NotificationManager.success=="function"){const s=r.name||r.id.substring(0,8);window.NotificationManager.success(`Mapping "${s}" created successfully`)}return r}catch(r){throw Logger.error("OPS","Failed to create mapping:",r),window.MappingsStore.rollbackPending(n,null),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.error=="function"&&window.NotificationManager.error(`Failed to create mapping: ${r.message}`),r}},async update(t,e){Logger.info("OPS",`Updating mapping: ${t}`);const n=window.MappingsStore.get(t);if(!n)throw new Error(`Mapping ${t} not found`);if(window.MappingsStore.pending.has(t))throw Logger.warn("OPS",`Mapping ${t} already has pending operation`),new Error("Mapping has pending changes");const i={...e||{}},r={...n,...i,_pending:!0,_operation:"update",metadata:{...n.metadata,...i.metadata,edited:Date.now()}};normalizeScenarioNameField(r,{notify:a=>window.NotificationManager?.warning?.(a)});try{window.MappingsStore.addPending({id:t,type:"update",payload:i,optimisticMapping:r,original:n}),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.info=="function"&&window.NotificationManager.info("Saving changes...");const a=await this._sendUpdateRequest(t,r);if(Logger.info("OPS",`Mapping updated on server: ${t}`),window.MappingsStore.confirmPending(t,a),this._refreshUI(),this._broadcastUpdate("updated",a),window.NotificationManager&&typeof window.NotificationManager.success=="function"){const s=a.name||t.substring(0,8);window.NotificationManager.success(`Mapping "${s}" updated successfully`)}return a}catch(a){throw Logger.error("OPS","Failed to update mapping:",a),window.MappingsStore.rollbackPending(t,n),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.error=="function"&&window.NotificationManager.error(`Failed to update mapping: ${a.message}`),a}},async delete(t){Logger.info("OPS",`Deleting mapping: ${t}`);const e=window.MappingsStore.get(t);if(!e){Logger.warn("OPS",`Mapping ${t} not found, skipping delete`);return}const n={...e,_deleted:!0,_pending:!0,_operation:"delete"};try{if(window.MappingsStore.addPending({id:t,type:"delete",payload:null,optimisticMapping:n,original:e}),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.info=="function"){const i=e.name||t.substring(0,8);window.NotificationManager.info(`Deleting "${i}"...`)}if(await this._sendDeleteRequest(t),Logger.info("OPS",`Mapping deleted on server: ${t}`),window.MappingsStore.confirmPending(t,null),this._refreshUI(),this._broadcastUpdate("deleted",e),window.NotificationManager&&typeof window.NotificationManager.success=="function"){const i=e.name||t.substring(0,8);window.NotificationManager.success(`Mapping "${i}" deleted successfully`)}}catch(i){throw Logger.error("OPS","Failed to delete mapping:",i),window.MappingsStore.rollbackPending(t,e),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.error=="function"&&window.NotificationManager.error(`Failed to delete mapping: ${i.message}`),i}},async batchDelete(t){Logger.info("OPS",`Batch deleting ${t.length} mappings`);const e={success:[],failed:[]};for(const n of t)try{await this.delete(n),e.success.push(n)}catch(i){Logger.error("OPS",`Failed to delete ${n}:`,i),e.failed.push({id:n,error:i.message})}return Logger.info("OPS",`Batch delete complete: ${e.success.length} succeeded, ${e.failed.length} failed`),window.NotificationManager&&(e.failed.length===0?window.NotificationManager.success(`Deleted ${e.success.length} mappings`):window.NotificationManager.warning(`Deleted ${e.success.length} mappings, ${e.failed.length} failed`)),e},async _sendCreateRequest(t){const e=this._cleanMappingData(t);return await window.apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})},async _sendUpdateRequest(t,e){const n=this._cleanMappingData(e);return await window.apiFetch(`/mappings/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})||n},async _sendDeleteRequest(t){await window.apiFetch(`/mappings/${t}`,{method:"DELETE"})},_cleanMappingData(t){const e={...t};return delete e._pending,delete e._operation,delete e._deleted,e},_refreshUI(){if(!window.MappingsStore){Logger.warn("OPS","MappingsStore not available for UI refresh");return}if(typeof window.refreshMappingTabSnapshot=="function"&&window.refreshMappingTabSnapshot(),window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function")window.FilterManager.applyMappingFilters(),typeof window.FilterManager.flushMappingFilters=="function"&&window.FilterManager.flushMappingFilters();else{Logger.warn("OPS","FilterManager not available, rendering without filters");const t=window.MappingsStore.getAll();typeof window.fetchAndRenderMappings=="function"&&window.fetchAndRenderMappings(t,{source:"optimistic"})}},_broadcastUpdate(t,e){if(typeof BroadcastChannel<"u")try{new BroadcastChannel("imock-optimistic-updates").postMessage({type:"mapping-"+t,operation:t,mapping:e,source:"mappings-operations",timestamp:Date.now()}),Logger.debug("OPS",`Broadcasted ${t} update:`,e.id)}catch(n){Logger.warn("OPS","Failed to broadcast update:",n)}try{const n="imock-optimistic-update",i={type:"mapping-"+t,operation:t,mapping:e,source:"mappings-operations",timestamp:Date.now()};localStorage.setItem(n,JSON.stringify(i)),setTimeout(()=>{try{localStorage.removeItem(n)}catch{}},1e3)}catch(n){Logger.warn("OPS","Failed to update localStorage:",n)}}};function isOptimisticShadowMap(t){return t&&typeof t=="object"&&typeof t.forEach=="function"&&typeof t.size=="number"&&Object.prototype.toString.call(t)==="[object Map]"}window.mappingPreviewState instanceof Set||(window.mappingPreviewState=new Set),window.mappingPreviewToastState instanceof Map||(window.mappingPreviewToastState=new Map),isOptimisticShadowMap(window.optimisticShadowMappings)||(window.optimisticShadowMappings=new Map);const UIComponents={createCard:(t,e,n=[])=>{const{id:i,method:r,url:a,status:s,name:c,time:l,extras:d={},expanded:m=!1}=e,w={editMapping:"edit-external",openEditModal:"edit-mapping",deleteMapping:"delete-mapping",duplicateMapping:"duplicate-mapping",viewRequestDetails:"view-request"};return`
            <div class="${t}-card${m?" is-expanded":""}" data-id="${Utils.escapeHtml(i)}">
                <div class="${t}-header" data-action="toggle-details">
                    <div class="${t}-info">
                        <div class="${t}-top-line">
                            <span class="method-badge ${r.toLowerCase()}">
                                <span class="collapse-arrow" id="arrow-${Utils.escapeHtml(i)}">${m?"\u25BC":"\u25B6"}</span> ${r}
                            </span>
                            ${c?`<span class="${t}-name">${Utils.escapeHtml(c)}</span>`:""}
                            ${l?`<span class="${t}-time">${l}</span>`:""}
                        </div>
                        <div class="${t}-url-line">
                            <span class="status-badge ${Utils.getStatusClass(s)}">${s}</span>
                            <span class="${t}-url">${Utils.escapeHtml(a)}</span>
                            ${d.badges||""}
                        </div>
                    </div>
                    <div class="${t}-actions">
                        ${n.map(E=>{const M=w[E.handler]||E.handler;return`
                            <button class="btn btn-sm btn-${E.class}"
                                    data-action="${M}"
                                    data-${t}-id="${Utils.escapeHtml(i)}"
                                    title="${Utils.escapeHtml(E.title)}">
                                ${E.icon?Icons.render(E.icon,{className:"action-icon"}):""}
                                <span class="sr-only">${Utils.escapeHtml(E.title)}</span>
                            </button>
                        `}).join("")}
                    </div>
                </div>
                <div class="${t}-preview" id="preview-${Utils.escapeHtml(i)}" style="display: ${m?"block":"none"};">
                    ${d.preview||""}
                </div>
            </div>`},getCardElement(t,e){const n=document.querySelectorAll(`.${t}-card`),i=String(e??"");for(const r of n)if((r.dataset?.id||"")===i)return r;return null},setCardState(t,e,n,i=!0){const r=this.getCardElement(t,e);r&&r.classList.toggle(n,!!i)},clearCardState(t,e){document.querySelectorAll(`.${t}-card.${e}`).forEach(n=>{n.classList.remove(e)})},createPreviewSection:(t,e)=>`
        <div class="preview-section">
            <h4>${t}</h4>
            ${Object.entries(e).map(([n,i])=>{if(!i)return"";if(typeof i=="object")if(JSON.stringify(i).length>500){const a=Utils.formatJson(i,"Invalid JSON",200),s=`full-${Math.random().toString(36).substr(2,9)}`;return`<div class="preview-value">
                            <strong>${n}:</strong>
                            <pre>${a}</pre>
                            <button class="btn btn-secondary btn-small" data-action="show-full-content" data-target-id="${s}" data-json="${Utils.escapeHtml(JSON.stringify(i))}" style="margin-top: 0.5rem; font-size: 0.8rem;">
                                Show Full Content
                            </button>
                            <div id="${s}" style="display: none;"></div>
                        </div>`}else return`<div class="preview-value"><strong>${n}:</strong><pre>${Utils.formatJson(i)}</pre></div>`;else if(typeof i=="string"){const r=i.trim();if(r.startsWith("{")&&r.endsWith("}"))try{const c=JSON.parse(r);if(JSON.stringify(c).length>500){const d=Utils.formatJson(c,"Invalid JSON",200),m=`full-${Math.random().toString(36).substr(2,9)}`;return`<div class="preview-value">
                                    <strong>${n}:</strong>
                                    <pre>${d}</pre>
                                    <button class="btn btn-secondary btn-small" data-action="show-full-content" data-target-id="${m}" data-json="${Utils.escapeHtml(JSON.stringify(c))}" style="margin-top: 0.5rem; font-size: 0.8rem;">
                                        Show Full Content
                                    </button>
                                    <div id="${m}" style="display: none;"></div>
                                </div>`}return`<div class="preview-value"><strong>${n}:</strong><pre>${Utils.formatJson(c)}</pre></div>`}catch{}const a=Utils.escapeHtml(i),s=a.includes(`
`)?`<pre>${a}</pre>`:a;return`<div class="preview-value"><strong>${n}:</strong> ${s}</div>`}else{const r=Utils.escapeHtml(String(i));return`<div class="preview-value"><strong>${n}:</strong> ${r}</div>`}}).join("")}
        </div>`,toggleDetails:(t,e)=>{const n=String(t??""),i=document.getElementById(`preview-${t}`),r=document.getElementById(`arrow-${t}`),a=i?i.style.display==="none":!1;if(i&&(i.style.display=a?"block":"none"),r&&(r.textContent=a?"\u25BC":"\u25B6"),e==="mapping"){const s=i?i.closest(`.${e}-card`):null;s&&s.classList.toggle("is-expanded",a),window.mappingPreviewState instanceof Set&&(a?window.mappingPreviewState.add(n):window.mappingPreviewState.delete(n))}UIComponents.setCardState(e,t,"is-expanded",a)},toggleFullContent:t=>{const e=document.getElementById(t),n=e.previousElementSibling;if(e.style.display==="none")try{const i=n.getAttribute("data-json"),r=JSON.parse(i);e.innerHTML=`<pre style="max-height: 300px; overflow-y: auto; background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-sm); margin-top: 0.5rem;">${Utils.escapeHtml(JSON.stringify(r,null,2))}</pre>`,e.style.display="block",n.textContent="Hide Full Content"}catch(i){e.innerHTML=`<div class="preview-value warning">Error parsing JSON: ${Utils.escapeHtml(i.message)}</div>`,e.style.display="block",n.textContent="Hide"}else e.style.display="none",n.textContent="Show Full Content"}};window.toggleFullContent=UIComponents.toggleFullContent,window.toggleDetails=UIComponents.toggleDetails;function getOptimisticShadowTtl(){const t=Number(window.DEFAULT_SETTINGS?.optimisticCacheAgeLimit);return Number.isFinite(t)&&t>0?Math.max(t,45e3):6e4}function cloneMappingForOptimisticShadow(t){if(!t||typeof t!="object")return null;try{return typeof structuredClone=="function"?structuredClone(t):JSON.parse(JSON.stringify(t))}catch{return{...t}}}function rememberOptimisticShadowMapping(t,e){if(isOptimisticShadowMap(window.optimisticShadowMappings)||(window.optimisticShadowMappings=new Map),!t||typeof t!="object")return;const n=t.id||t.uuid;if(!n)return;const i=typeof e=="string"?e.toLowerCase():"update";if(i==="delete"){window.optimisticShadowMappings.delete(String(n));return}const r=cloneMappingForOptimisticShadow(t);r&&(typeof r.__optimisticTs!="number"&&Object.defineProperty(r,"__optimisticTs",{value:Date.now(),writable:!1,enumerable:!1,configurable:!0}),window.optimisticShadowMappings.set(String(n),{ts:Date.now(),op:i==="create"?"create":"update",mapping:r}))}function getOptimisticShadowTimestamp(t){if(!t||typeof t!="object")return Number.NaN;const e=t.metadata||{},n=[e.edited,e.updated,e.updatedAt,e.created,e.timestamp];for(const i of n){if(!i)continue;if(i instanceof Date){const s=i.getTime();if(Number.isFinite(s))return s}const r=Date.parse(i);if(Number.isFinite(r))return r;const a=Number(i);if(Number.isFinite(a))return a}return typeof t.__optimisticTs=="number"?t.__optimisticTs:Number.NaN}function applyOptimisticShadowMappings(t){if(!Array.isArray(t)||!isOptimisticShadowMap(window.optimisticShadowMappings)||window.optimisticShadowMappings.size===0)return t;const e=Date.now(),n=getOptimisticShadowTtl(),i=[...t];for(const[r,a]of Array.from(window.optimisticShadowMappings.entries())){const s=String(r||"");if(!a||typeof a!="object"){window.optimisticShadowMappings.delete(s);continue}if(a.mapping==null){const l=i.findIndex(d=>String(d?.id||d?.uuid||"")===s);l!==-1&&i.splice(l,1),window.optimisticShadowMappings.delete(s);continue}if(!Number.isFinite(a.ts)||e-a.ts>n){window.optimisticShadowMappings.delete(s);continue}const c=i.findIndex(l=>String(l?.id||l?.uuid||"")===s);if(c!==-1){let l=!1,d=!0;if(typeof getMappingRenderSignature=="function")try{const m=getMappingRenderSignature(i[c]),w=getMappingRenderSignature(a.mapping);if(m===w){window.optimisticShadowMappings.delete(s);continue}}catch{}if((a.op||"update")==="create")d=!1;else{const m=getOptimisticShadowTimestamp(i[c]),w=getOptimisticShadowTimestamp(a.mapping);Number.isFinite(w)&&(!Number.isFinite(m)||w>m)?l=!0:d=!1}l?(a.ts=e,i[c]=a.mapping):d?a.ts=e:window.optimisticShadowMappings.delete(s)}else i.unshift(a.mapping),Number.isFinite(a.ts)||(a.ts=e)}return i}function pruneOptimisticShadowMappings(t){if(!isOptimisticShadowMap(window.optimisticShadowMappings)||window.optimisticShadowMappings.size===0||!Array.isArray(t)||t.length===0)return;const e=new Map;t.forEach(n=>{if(n&&typeof n=="object"){const i=String(n.id||n.uuid||"");i&&e.set(i,n)}});for(const[n,i]of Array.from(window.optimisticShadowMappings.entries())){if(!e.has(n))continue;if(!i||typeof i!="object"){window.optimisticShadowMappings.delete(n);continue}if((i.op||"update")==="create")continue;if(!i.mapping||typeof i.mapping!="object"){window.optimisticShadowMappings.delete(n);continue}const r=e.get(n);if(!r){window.optimisticShadowMappings.delete(n);continue}try{if(typeof getMappingRenderSignature=="function"&&i.mapping){const c=getMappingRenderSignature(r),l=getMappingRenderSignature(i.mapping);if(c===l){window.optimisticShadowMappings.delete(n);continue}}}catch{}const a=getOptimisticShadowTimestamp(r),s=getOptimisticShadowTimestamp(i.mapping);Number.isFinite(a)&&(!Number.isFinite(s)||a>=s)&&window.optimisticShadowMappings.delete(n)}}window.fetchAndRenderMappings=async(t=null,e={})=>{const n=document.getElementById(SELECTORS.LISTS.MAPPINGS),i=document.getElementById(SELECTORS.EMPTY.MAPPINGS),r=document.getElementById(SELECTORS.LOADING.MAPPINGS);if(!n||!i||!r)return Logger.error("UI","Required DOM elements not found for mappings rendering"),!1;if(!(e?.skipSyncCheck===!0)&&(window.MappingsStore?.metadata?.isSyncing||window.MappingsStore?.metadata?.isRendering))return Logger.debug("UI","Sync or render in progress, skipping render to avoid race condition"),!0;window.MappingsStore?.metadata&&(window.MappingsStore.metadata.isRendering=!0);let s=null;try{if(t===null){r.classList.remove("hidden"),n.style.display="none",i.classList.add("hidden"),i.setAttribute("aria-hidden","true");let E,M="direct";if(e&&e.useCache){const y=await loadImockCacheBestOf3();if(y&&y.data&&Array.isArray(y.data.mappings)){Logger.cache("Cache hit - using cached data for quick start"),M="cache";const A=typeof y.data.timestamp=="number"?y.data.timestamp:(y.data.mappings||[]).reduce((H,X)=>{const _=X?.metadata?.imock?.timestamp;return typeof _=="number"&&_>H?_:H},0);Date.now()-A>3e4&&(async()=>{try{const H=typeof window<"u"&&typeof window.optimisticUpdateDelayMs=="number"?window.optimisticUpdateDelayMs:500;await new Promise(_=>setTimeout(_,H));const X=await fetchMappingsFromServer({force:!0});if(X&&X.mappings){const _=X.mappings.filter(x=>!isImockCacheMapping(x)),de=(y.data.mappings||[]).filter(x=>!isImockCacheMapping(x));if(de.length!==_.length){if(window.MappingsStore&&window.MappingsStore.setFromServer(_),refreshMappingTabSnapshot(),syncCacheWithMappings(_),rebuildMappingIndex(_),typeof NotificationManager<"u"){const x=_.length-de.length;x>0?NotificationManager.info(`${x} new mapping${x===1?"":"s"} from server`,3e3):x<0&&NotificationManager.info(`${Math.abs(x)} mapping${Math.abs(x)===1?"":"s"} removed on server`,3e3),Logger.cache("Cache updated with server data:",{cachedCount:de.length,serverCount:_.length})}}else Logger.debug("CACHE","No changes detected, skipping cache update")}}catch(H){Logger.warn("CACHE","Background cache validation failed:",H)}})(),E=y.data}else{Logger.cache("Cache miss - loading from server"),typeof NotificationManager<"u"&&NotificationManager.info("Loading mappings from server...",2e3),E=await fetchMappingsFromServer({force:!0}),M="direct";try{Logger.cache("Async regenerate after cache miss"),regenerateImockCache()}catch{}}}else E=await fetchMappingsFromServer({force:!0}),M="direct";if(E&&E.__source){M=E.__source,M==="demo"&&markDemoModeActive("mappings-fallback");try{delete E.__source}catch{}}let C=E.mappings||[];const v=window.MappingsStore?.pending?Array.from(window.MappingsStore.pending.values()):[];v.length>0&&(Logger.debug("OPTIMISTIC","Applying optimistic updates to incoming data:",v.length,"updates"),C=C.map(y=>{const A=y.id||y.uuid,R=window.MappingsStore?.pending?window.MappingsStore.pending.get(A):null;return R?R.type==="delete"?(Logger.debug("OPTIMISTIC","Removing deleted mapping from results:",y.id),null):(Logger.debug("OPTIMISTIC","Using optimistic version for:",y.id),R.optimisticMapping):y}).filter(y=>y!==null),v.forEach(y=>{y.type!=="delete"&&!C.some(A=>(A.id||A.uuid)===y.id)&&(Logger.debug("OPTIMISTIC","Adding new optimistic mapping:",y.id),C.unshift(y.optimisticMapping))})),C=applyOptimisticShadowMappings(C);try{if(window.pendingDeletedIds&&window.pendingDeletedIds.size>0){const y=C.length;C=C.filter(A=>!window.pendingDeletedIds.has(A.id||A.uuid)),y!==C.length&&Logger.cache("filtered pending-deleted from render:",y-C.length)}}catch{}const h=Array.isArray(C)?C.filter(y=>!isImockCacheMapping(y)):[];window.MappingsStore&&window.MappingsStore.setFromServer(h),refreshMappingTabSnapshot(),syncCacheWithMappings(h),rebuildMappingIndex(h),pruneOptimisticShadowMappings(h),s=M}else{const E=typeof e?.source=="string"?e.source:null,M=Array.isArray(t)?[...t]:[];window.MappingsStore&&window.MappingsStore.setFromServer(M),refreshMappingTabSnapshot(),rebuildMappingIndex(M),pruneOptimisticShadowMappings(M),s=E,s==="demo"&&markDemoModeActive("manual-mappings")}r.classList.add("hidden");const c=document.getElementById(SELECTORS.MAPPING_FILTERS.QUERY)?.value?.trim()||"";let l=window.MappingsStore?window.MappingsStore.getAll():Array.isArray(t)?t:[];if(c&&window.QueryParser&&typeof window.QueryParser.filterMappingsByQuery=="function"&&(Logger.debug("UI","Applying filters before render:",c),l=window.QueryParser.filterMappingsByQuery(l,c)),window._filteredMappings=l,l.length===0)return i.classList.remove("hidden"),i.setAttribute("aria-hidden","false"),n.style.display="none",updateMappingsCounter(),s&&updateDataSourceIndicator(s),!0;i.classList.add("hidden"),i.setAttribute("aria-hidden","true"),n.style.display="block",window.invalidateElementCache(SELECTORS.LISTS.MAPPINGS);const m=[...l].sort((E,M)=>{const C=E.priority||1,v=M.priority||1;if(C!==v)return C-v;const h={GET:1,POST:2,PUT:3,PATCH:4,DELETE:5},y=h[E.request?.method]||999,A=h[M.request?.method]||999;if(y!==A)return y-A;const R=E.request?.url||E.request?.urlPattern||E.request?.urlPath||"",H=M.request?.url||M.request?.urlPattern||M.request?.urlPath||"";return R.localeCompare(H)}),w=s||"previous";Logger.info("UI",`Mappings render from: ${w} \u2014 ${m.length} items`);try{if(n.style.willChange="contents",window.PaginationManager){window.PaginationManager.updateState(m.length);const M=window.PaginationManager.getCurrentPageItems(m);Logger.debug("UI",`Rendering page ${window.PaginationManager.currentPage}/${window.PaginationManager.totalPages} (${M.length} items)`),renderList(n,M,{renderItem:renderMappingMarkup,getKey:getMappingRenderKey,getSignature:getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const C=document.getElementById("mappings-pagination");C&&(C.innerHTML=window.PaginationManager.renderControls())}else renderList(n,m,{renderItem:renderMappingMarkup,getKey:getMappingRenderKey,getSignature:getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const E=()=>{updateMappingsCounter(),s&&updateDataSourceIndicator(s),n.style.willChange="auto";try{document.getElementById(SELECTORS.MAPPING_FILTERS.QUERY)?.value?.trim()&&typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay()}catch{}};typeof requestAnimationFrame=="function"?requestAnimationFrame(E):E()}catch(E){if(Logger.error("UI","DOM batch update failed:",E),window.PaginationManager){window.PaginationManager.updateState(m.length);const M=window.PaginationManager.getCurrentPageItems(m);renderList(n,M,{renderItem:renderMappingMarkup,getKey:getMappingRenderKey,getSignature:getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const C=document.getElementById("mappings-pagination");C&&(C.innerHTML=window.PaginationManager.renderControls())}else renderList(n,m,{renderItem:renderMappingMarkup,getKey:getMappingRenderKey,getSignature:getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});updateMappingsCounter(),s&&updateDataSourceIndicator(s)}return!0}catch(c){Logger.error("UI","Error in fetchAndRenderMappings:",c);let l="Failed to load mappings";return c.status===401||c.message&&c.message.includes("401")?l="Authorization error: Please check your credentials":c.status===403||c.message&&c.message.includes("403")?l="Access forbidden: Check your permissions":c.status===404||c.message&&c.message.includes("404")?l="Server endpoint not found":c.message&&c.message.includes("timeout")?l="Request timeout: Server not responding":c.message&&(l=`Failed to load mappings: ${c.message}`),NotificationManager.error(l),r.classList.add("hidden"),i.classList.remove("hidden"),n.style.display="none",!1}finally{window.MappingsStore?.metadata&&(window.MappingsStore.metadata.isRendering=!1)}},window.refreshMappingsFromCache=async(t="cache")=>{try{if(!window.MappingsStore)return Logger.warn("CACHE","MappingsStore not available"),!1;const n=window.MappingsStore.getAll().filter(r=>!isImockCacheMapping(r));window.MappingsStore.setFromServer(n),typeof refreshMappingTabSnapshot=="function"&&refreshMappingTabSnapshot(),typeof rebuildMappingIndex=="function"&&rebuildMappingIndex(n),typeof pruneOptimisticShadowMappings=="function"&&pruneOptimisticShadowMappings(n),typeof updateDataSourceIndicator=="function"&&updateDataSourceIndicator(t||"cache");const i=window.MappingsStore?window.MappingsStore.getAll():[];return await fetchAndRenderMappings(i,{source:t||"cache"})}catch(e){return Logger.warn("CACHE","refreshMappingsFromCache failed:",e),!1}},window.initMappingPagination=function(){if(!window.PaginationManager){Logger.warn("UI","PaginationManager not available");return}window.PaginationManager.init("#mappings-pagination",20),window.PaginationManager.attachListeners(t=>{Logger.debug("UI",`Page changed to: ${t}`);const e=document.getElementById(SELECTORS.LISTS.MAPPINGS),n=window.MappingsStore?window.MappingsStore.getAll():[];if(!e||!Array.isArray(n)){Logger.warn("UI","Cannot render page: container or data not available");return}const i=[...n].sort((c,l)=>{const d=c.priority||1,m=l.priority||1;if(d!==m)return d-m;const w={GET:1,POST:2,PUT:3,PATCH:4,DELETE:5},E=w[c.request?.method]||999,M=w[l.request?.method]||999;if(E!==M)return E-M;const C=c.request?.url||c.request?.urlPattern||c.request?.urlPath||"",v=l.request?.url||l.request?.urlPattern||l.request?.urlPath||"";return C.localeCompare(v)}),r=window.PaginationManager.getCurrentPageItems(i);window.invalidateElementCache(SELECTORS.LISTS.MAPPINGS),renderList(e,r,{renderItem:renderMappingMarkup,getKey:getMappingRenderKey,getSignature:getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const a=document.getElementById("mappings-pagination");a&&(a.innerHTML=window.PaginationManager.renderControls());const s=document.getElementById("mappings-page");s&&s.scrollIntoView({behavior:"smooth",block:"start"})}),Logger.info("UI","Mapping pagination initialized")},window.getMappingById=async t=>{try{if(!t)throw new Error("Mapping ID is required");Logger.debug("CACHE",`Fetching mapping with ID: ${t}`),Logger.debug("CACHE","Current wiremockBaseUrl:",window.wiremockBaseUrl);const e=window.MappingsStore?window.MappingsStore.getAll():[];Logger.debug("CACHE","MappingsStore available:",!!window.MappingsStore),Logger.debug("CACHE","Cache size:",e?.length||0);let n=window.MappingsStore?window.MappingsStore.get(t):null;if(n||(n=e.find(a=>a.id===t||a.uuid===t)||null),n)return Logger.cache(`Found mapping in cache: ${t}`,n),n;Logger.cache("Mapping not found in cache, will fetch from API"),Logger.api(`Making API call to: /mappings/${t}`);const i=await apiFetch(`/mappings/${t}`);Logger.api("Raw API response:",i);const r=i&&typeof i=="object"&&i.mapping?i.mapping:i;if(Logger.debug("CACHE","Processed mapping:",r),!r||typeof r!="object")throw Logger.error("CACHE",`API returned invalid data for mapping ${t}`),new Error(`Mapping with ID ${t} not found or invalid response`);return Logger.info("CACHE",`Successfully fetched mapping: ${t}`,r),addMappingToIndex(r),r}catch(e){throw Logger.error("CACHE",`Error fetching mapping ${t}:`,e),Logger.error("CACHE","Error details:",{message:e.message,status:e.status,statusText:e.statusText,url:`${window.wiremockBaseUrl}/mappings/${t}`}),e}},window.duplicateMapping=async t=>{const e=(t??"").toString().trim();if(!e){NotificationManager.error("Invalid mapping identifier");return}if(!window.TemplateManager?.createMappingsFromPayloads){NotificationManager.error("Mapping duplication is not available");return}try{const n=await window.getMappingById(e);if(!n)throw new Error("Mapping not found");await window.TemplateManager.createMappingsFromPayloads([n],{openMode:"inline",source:"duplicate",successMessageFactory:i=>`Duplicated ${i} mapping${i===1?"":"s"}`})}catch(n){Logger.error("OPTIMISTIC","Failed to duplicate mapping:",n),NotificationManager.error(`Failed to duplicate mapping: ${n.message}`)}},window.applyOptimisticMappingUpdate=t=>{try{if(!t){Logger.warn("OPTIMISTIC","No mapping data provided");return}const e=t.mapping||t,n=e?.id||e?.uuid;if(!e||!n){Logger.warn("OPTIMISTIC","Invalid mapping data - missing id:",e);return}if(isImockCacheMapping(e)){Logger.debug("OPTIMISTIC","Skipping cache mapping update");return}const i=window.MappingsStore&&window.MappingsStore.items instanceof Map,r=i&&window.MappingsStore.items.has(n)?"update":"create";if(rememberOptimisticShadowMapping(e,r),typeof updateOptimisticCache=="function")updateOptimisticCache(e,r,{queueMode:"add"});else{if(i){try{window.MappingsStore.addPending({id:n,type:r,payload:e,optimisticMapping:e})}catch(s){Logger.warn("OPTIMISTIC","Failed to enqueue optimistic update:",s)}const a=cloneMappingForCache(e);if(!a)Logger.warn("OPTIMISTIC","Failed to clone mapping for store:",n);else{if(!a.id&&n&&(a.id=n),!a.uuid&&(e.uuid||n)&&(a.uuid=e.uuid||n),window.MappingsStore.items.has(n)){const s=mergeMappingData(window.MappingsStore.items.get(n),a);window.MappingsStore.items.set(n,s)}else window.MappingsStore.items.set(n,a);typeof window.MappingsStore.rebuildIndexes=="function"&&window.MappingsStore.rebuildIndexes()}}window.cacheLastUpdate=Date.now(),window.MappingsStore.metadata.isOptimisticUpdate||(window.MappingsStore.metadata.isOptimisticUpdate=!0,setTimeout(()=>{window.MappingsStore.metadata.isOptimisticUpdate=!1},1e3)),refreshMappingsFromCache()}Logger.debug("OPTIMISTIC","Applied update for mapping:",n)}catch(e){Logger.warn("OPTIMISTIC","Update failed:",e)}},window.backgroundRefreshMappings=async(t=!1)=>{try{if(!window.MappingsStore){Logger.warn("CACHE","MappingsStore not available for background refresh");return}let e,n="direct";if(t){const a=await loadImockCacheBestOf3();a&&a.data&&Array.isArray(a.data.mappings)?(e=a.data,n="cache"):(e=await fetchMappingsFromServer({force:!0}),n="direct")}else e=await fetchMappingsFromServer({force:!0}),n="direct";let i=e.mappings||[];i=applyOptimisticShadowMappings(i);try{if(window.pendingDeletedIds instanceof Set&&window.pendingDeletedIds.size>0){const a=i.length;i=i.filter(s=>{if(!s||typeof s!="object")return!0;const c=s.id||s.uuid;return!window.pendingDeletedIds.has(c)}),a!==i.length&&Logger.cache("background refresh filtered pending-deleted mappings:",a-i.length)}}catch(a){Logger.warn("CACHE","Failed to filter pending deletions during background refresh:",a)}const r=Array.isArray(i)?i.filter(a=>!isImockCacheMapping(a)):[];window.MappingsStore&&window.MappingsStore.setFromServer(r),refreshMappingTabSnapshot(),syncCacheWithMappings(r),rebuildMappingIndex(r),pruneOptimisticShadowMappings(r),updateDataSourceIndicator(n),setTimeout(()=>{const a=window.MappingsStore?window.MappingsStore.getAll():[];fetchAndRenderMappings(a)},0)}catch(e){Logger.warn("CACHE","Background refresh failed:",e)}},window.renderMappingCard=function(t){if(!t||!t.id)return Logger.warn("CACHE","Invalid mapping data:",t),"";const e=[{class:"secondary",handler:"duplicateMapping",title:"Duplicate",icon:"clipboard"},{class:"secondary",handler:"editMapping",title:"Edit in Editor",icon:"open-external"},{class:"primary",handler:"openEditModal",title:"Edit",icon:"pencil"},{class:"danger",handler:"deleteMapping",title:"Delete",icon:"trash"}],n=String(t.id||t.uuid||""),i=window.mappingPreviewState instanceof Set&&window.mappingPreviewState.has(n),r={id:t.id,method:t.request?.method||"GET",url:t.request?.urlPath||t.request?.urlPathPattern||t.request?.urlPattern||t.request?.url||"N/A",status:t.response?.status||200,name:t.name||t.metadata?.name||`Mapping ${t.id.substring(0,8)}`,expanded:i,extras:{preview:i?UIComponents.createPreviewSection(`${Icons.render("request-in",{className:"icon-inline"})} Request`,{Method:t.request?.method||"GET",URL:t.request?.url||t.request?.urlPattern||t.request?.urlPath||t.request?.urlPathPattern,Headers:t.request?.headers,Body:t.request?.bodyPatterns||t.request?.body,"Query Parameters":t.request?.queryParameters})+UIComponents.createPreviewSection(`${Icons.render("response-out",{className:"icon-inline"})} Response`,{Status:t.response?.status,Headers:t.response?.headers,Body:t.response?.jsonBody||t.response?.body,Delay:t.response?.fixedDelayMilliseconds?`${t.response.fixedDelayMilliseconds}ms`:null})+UIComponents.createPreviewSection(`${Icons.render("info",{className:"icon-inline"})} Overview`,{ID:t.id||t.uuid,Name:t.name||t.metadata?.name,Priority:t.priority,Persistent:t.persistent,Scenario:t.scenarioName,"Required State":t.requiredScenarioState,"New State":t.newScenarioState,Created:window.showMetaTimestamps!==!1&&t.metadata?.created?new Date(t.metadata.created).toLocaleString():null,Edited:window.showMetaTimestamps!==!1&&t.metadata?.edited?new Date(t.metadata.edited).toLocaleString():null,Source:t.metadata?.source?`Edited from ${t.metadata.source}`:null}):"",badges:[t.id||t.uuid?`<span class="badge badge-secondary" title="Mapping ID">${Utils.escapeHtml((t.id||t.uuid).length>12?(t.id||t.uuid).slice(0,8)+"\u2026"+(t.id||t.uuid).slice(-4):t.id||t.uuid)}</span>`:"",typeof t.priority=="number"?`<span class="badge badge-secondary" title="Priority">P${t.priority}</span>`:"",t.scenarioName?`<span class="badge badge-secondary" title="Scenario">${Utils.escapeHtml(t.scenarioName)}</span>`:"",window.showMetaTimestamps!==!1&&t.metadata?.created?`<span class="badge badge-secondary" title="Created">C: ${new Date(t.metadata.created).toLocaleString()}</span>`:"",window.showMetaTimestamps!==!1&&t.metadata?.edited?`<span class="badge badge-secondary" title="Edited">E: ${new Date(t.metadata.edited).toLocaleString()}</span>`:"",t.metadata?.source?`<span class="badge badge-info" title="Last edited from">${t.metadata.source.toUpperCase()}</span>`:""].filter(Boolean).join(" ")}};return UIComponents.createCard("mapping",r,e)},window.updateMappingsCounter=function(){const t=document.getElementById(SELECTORS.COUNTERS.MAPPINGS);if(t){const e=window.MappingsStore?window.MappingsStore.getAll():[];t.textContent=Array.isArray(e)?e.length:0}};function updateDataSourceIndicator(t){const e=document.getElementById("data-source-indicator");if(!e)return;let n="Source: direct",i="badge badge-secondary";switch(t){case"cache":n="Source: cache",i="badge badge-success";break;case"cache_rebuilding":n="Source: cache (rebuilding\u2026)",i="badge badge-success";break;case"synced":n="Source: synced",i="badge badge-success";break;case"demo":n="Source: demo data",i="badge badge-info";break;case"custom":n="Source: custom",i="badge badge-secondary";break;case"remote":n="Source: remote",i="badge badge-warning";break;case"remote_error":n="Source: remote (error/CORS)",i="badge badge-danger";break;default:n="Source: direct",i="badge badge-secondary"}e.textContent=n,e.className=i}function updateRequestsSourceIndicator(t){const e=document.getElementById("requests-source-indicator");if(!e)return;let n="Requests: direct",i="badge badge-secondary";switch(t){case"custom":n="Requests: custom",i="badge badge-secondary";break;case"demo":n="Requests: demo data",i="badge badge-info";break;case"remote":n="Requests: remote",i="badge badge-warning";break;case"remote_error":n="Requests: remote (error/CORS)",i="badge badge-danger";break;default:n="Requests: direct",i="badge badge-secondary"}e.textContent=n,e.className=i}function handleMappingItemChanged(t,e){const n=String(t||"");if(!(window.mappingPreviewState instanceof Set)||!window.mappingPreviewState.has(n))return;if(window.mappingPreviewToastState instanceof Map){const r=Date.now(),a=window.mappingPreviewToastState.get(n)||0;if(r-a<4e3)return;window.mappingPreviewToastState.set(n,r)}const i=e?.name||e?.metadata?.name||n;window.NotificationManager&&typeof window.NotificationManager.info=="function"&&window.NotificationManager.info(`Mapping "${i}" refreshed with latest data.`)}function handleMappingItemRemoved(t){const e=String(t||"");window.mappingPreviewState instanceof Set&&window.mappingPreviewState.delete(e),window.mappingPreviewToastState instanceof Map&&window.mappingPreviewToastState.delete(e),isOptimisticShadowMap(window.optimisticShadowMappings)&&window.optimisticShadowMappings.delete(e)}window.toggleMappingDetails=t=>UIComponents.toggleDetails(t,"mapping"),window.toggleRequestDetails=t=>UIComponents.toggleDetails(t,"request"),window.UIComponents=UIComponents,window.updateDataSourceIndicator=updateDataSourceIndicator,window.updateRequestsSourceIndicator=updateRequestsSourceIndicator,window.fetchAndRenderRequests=async(t=null,e={})=>{const n=document.getElementById(SELECTORS.LISTS.REQUESTS),i=document.getElementById(SELECTORS.EMPTY.REQUESTS),r=document.getElementById(SELECTORS.LOADING.REQUESTS);if(!n||!i||!r)return Logger.error("REQUESTS","Required DOM elements not found for requests rendering"),!1;try{let a="direct";if(t===null){r.classList.remove("hidden"),n.style.display="none",i.classList.add("hidden");let s;try{s=await apiFetch(ENDPOINTS.REQUESTS)}catch(l){const d=l?.message||"",m=/^HTTP\s+404\b/.test(d),w=l?.name==="SyntaxError"||/Unexpected end of JSON input/i.test(d);if(m||w)Logger.warn("REQUESTS","Requests endpoint returned no payload; treating as empty list.",l),s={requests:[],__source:"empty"};else throw window.demoModeLastError=l,l}if(s&&s.__source){a=s.__source,a==="demo"&&markDemoModeActive("requests-fallback");try{delete s.__source}catch{}}(!s||typeof s!="object")&&(s={requests:[]});const c=Array.isArray(s.requests)?s.requests:[];window.originalRequests=c,refreshRequestTabSnapshot(),window.allRequests=[...c]}else{const s=e?.source;window.allRequests=Array.isArray(t)?[...t]:[],window.originalRequests=[...window.allRequests],refreshRequestTabSnapshot(),a=s||"custom",a==="demo"&&markDemoModeActive("manual-requests")}return r.classList.add("hidden"),window.allRequests.length===0?(i.classList.remove("hidden"),n.style.display="none",updateRequestsCounter(),!0):(i.classList.add("hidden"),n.style.display="block",window.invalidateElementCache(SELECTORS.LISTS.REQUESTS),renderList(n,window.allRequests,{renderItem:renderRequestMarkup,getKey:getRequestRenderKey,getSignature:getRequestRenderSignature}),updateRequestsCounter(),typeof updateRequestsSourceIndicator=="function"&&updateRequestsSourceIndicator(a),Logger.info("REQUESTS",`Requests render from: ${a} \u2014 ${window.allRequests.length} items`),!0)}catch(a){return Logger.error("REQUESTS","Error in fetchAndRenderRequests:",a),NotificationManager.error(`Failed to load requests: ${a.message}`),r.classList.add("hidden"),i.classList.remove("hidden"),n.style.display="none",!1}},window.renderRequestCard=function(t){if(!t)return Logger.warn("REQUESTS","Invalid request data:",t),"";const e=t.wasMatched!==!1,n=t.request?.clientIp||"Unknown",i={id:t.id||"",method:t.request?.method||"GET",url:t.request?.url||t.request?.urlPath||"N/A",status:t.responseDefinition?.status||(e?200:404),time:`${Utils.parseRequestTime(t.request.loggedDate)} <span class="request-ip">IP: ${Utils.escapeHtml(n)}</span>`,extras:{badges:`
                ${e?`<span class="badge badge-success">${Icons.render("check-circle",{className:"badge-icon"})}<span>Matched</span></span>`:`<span class="badge badge-danger">${Icons.render("x-circle",{className:"badge-icon"})}<span>Unmatched</span></span>`}
            `,preview:UIComponents.createPreviewSection(`${Icons.render("request-in",{className:"icon-inline"})} Request`,{Method:t.request?.method,URL:t.request?.url||t.request?.urlPath,"Client IP":n,Headers:t.request?.headers,Body:t.request?.body})+UIComponents.createPreviewSection(`${Icons.render("response-out",{className:"icon-inline"})} Response`,{Status:t.responseDefinition?.status,Matched:e?"Yes":"No",Headers:t.responseDefinition?.headers,Body:t.responseDefinition?.jsonBody||t.responseDefinition?.body})}};return UIComponents.createCard("request",i,[])};function updateRequestsCounter(){const t=document.getElementById(SELECTORS.COUNTERS.REQUESTS);t&&(t.textContent=Array.isArray(window.allRequests)?window.allRequests.length:0),updateRequestTabCounts()}window.updateRequestsCounter=updateRequestsCounter;function updateRequestTabCounts(){const t=window.requestTabTotals||computeRequestTabTotals(window.originalRequests),e={all:document.getElementById("requests-tab-all"),matched:document.getElementById("requests-tab-matched"),unmatched:document.getElementById("requests-tab-unmatched")};Object.entries(e).forEach(([n,i])=>{i&&(i.textContent=t?.[n]??0)})}function setActiveFilterTab(t){if(!t)return;const e=t.dataset.filterGroup;e&&document.querySelectorAll(`.filter-tab[data-filter-group="${e}"]`).forEach(n=>{n.classList.toggle("active",n===t)})}window.syncFilterTabsFromSelect=function(e,n){const i=(n||"").toString().toLowerCase(),r=document.querySelectorAll(`.filter-tab[data-filter-group="${e}"]`);let a=!1;r.forEach(s=>{const c=(s.dataset.filterValue||"").toLowerCase();c===i||!c&&!i?(s.classList.add("active"),a=!0):s.classList.remove("active")}),!a&&r.length>0&&r[0].classList.add("active")},window.handleRequestTabClick=(t,e)=>{setActiveFilterTab(t);const n=document.getElementById("req-filter-status");n&&(n.value=e||"",typeof applyRequestFilters=="function"&&applyRequestFilters())},window.initializeFilterTabs=()=>{const t=document.getElementById("filter-method");t&&(t.addEventListener("change",()=>{syncFilterTabsFromSelect("mapping",t.value)}),syncFilterTabsFromSelect("mapping",t.value));const e=document.getElementById("req-filter-status");e&&(e.addEventListener("change",()=>{syncFilterTabsFromSelect("requests",e.value)}),syncFilterTabsFromSelect("requests",e.value)),updateRequestTabCounts()},window.openEditModal=async t=>{const n=(r=>typeof r=="string"?r.trim():r==null?"":String(r).trim())(t);if(!n){NotificationManager.show("Invalid mapping identifier",NotificationManager.TYPES.ERROR);return}if(typeof UIComponents?.clearCardState=="function"&&UIComponents.clearCardState("mapping","is-editing"),n&&typeof UIComponents?.setCardState=="function"&&UIComponents.setCardState("mapping",n,"is-editing",!0),typeof window.showModal=="function")window.showModal("edit-mapping-modal");else{Logger.warn("REQUESTS","showModal function not found");return}typeof window.setMappingEditorBusyState=="function"&&window.setMappingEditorBusyState(!0,"Loading\u2026");const i=document.getElementById(SELECTORS.MODAL.TITLE);i&&(i.textContent="Edit Mapping"),Logger.debug("REQUESTS","openEditModal called for mapping identifier:",t);try{const r=await apiFetch(`/mappings/${encodeURIComponent(n)}`),a=r?.mapping||r;if(!a||!a.id)throw new Error("Invalid mapping response from server");if(Logger.debug("REQUESTS","Loaded mapping from server:",a),typeof window.populateEditMappingForm=="function")window.populateEditMappingForm(a);else{Logger.error("REQUESTS","populateEditMappingForm function not found!");return}addMappingToIndex(a),Logger.debug("REQUESTS","openEditModal completed successfully")}catch(r){Logger.error("REQUESTS","Failed to load mapping:",r),NotificationManager.show("Failed to load mapping: "+r.message,NotificationManager.TYPES.ERROR),typeof window.hideModal=="function"&&window.hideModal("edit-mapping-modal")}finally{typeof window.setMappingEditorBusyState=="function"&&window.setMappingEditorBusyState(!1)}},window.deleteMapping=async t=>{if(confirm("Delete this mapping?"))try{await apiFetch(`/mappings/${t}`,{method:"DELETE"}),NotificationManager.success("Mapping deleted!"),removeMappingFromIndex(t),updateOptimisticCache({id:t},"delete")}catch(e){e.message.includes("404")?(Logger.info("REQUESTS","Mapping already deleted from server (404), updating cache locally"),removeMappingFromIndex(t),updateOptimisticCache({id:t},"delete"),NotificationManager.success("Mapping was already deleted")):NotificationManager.error(`Delete failed: ${e.message}`)}},window.clearRequests=async()=>{if(confirm("Clear all requests?"))try{await apiFetch("/requests",{method:"DELETE"}),NotificationManager.success("Requests cleared!"),await fetchAndRenderRequests()}catch(t){NotificationManager.error(`Clear failed: ${t.message}`)}},Array.isArray(window.allScenarios)||(window.allScenarios=[]);let allScenarios=window.allScenarios,scenarioListHandlerAttached=!1;(!window.scenarioExpansionState||typeof window.scenarioExpansionState!="object")&&(window.scenarioExpansionState={});let scenarioExpansionState=window.scenarioExpansionState;(!window.scenarioUiState||typeof window.scenarioUiState!="object")&&(window.scenarioUiState={});const scenarioUiState=window.scenarioUiState;typeof scenarioUiState.searchTerm!="string"&&(scenarioUiState.searchTerm=""),scenarioUiState.selected instanceof Set||(scenarioUiState.selected=new Set),typeof scenarioUiState.bulkMenuOpen!="boolean"&&(scenarioUiState.bulkMenuOpen=!1),Array.isArray(scenarioUiState.lastVisibleSelectable)||(scenarioUiState.lastVisibleSelectable=[]);let scenarioToolbarHandlersAttached=!1;function renderIcon(t,e={}){return typeof window.Icons?.render=="function"?window.Icons.render(t,e):""}function downloadFile(t,e,n){const i=new Blob([e],{type:n}),r=URL.createObjectURL(i),a=document.createElement("a");a.href=r,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>URL.revokeObjectURL(r),0)}function safeDecode(t){if(typeof t!="string")return"";const e=t.trim();if(!e)return"";if(!/%[0-9a-fA-F]{2}/.test(e))return e;try{return decodeURIComponent(e)}catch(n){return Logger.warn("SCENARIOS","safeDecode failed, returning original value",{value:t,error:n}),e}}function normalizeScenarioLink(t){if(typeof t!="string")return"";let e=t.trim();if(!e)return"";if(/^https?:\/\//i.test(e))try{e=new URL(e).pathname}catch(i){Logger.warn("SCENARIOS","normalizeScenarioLink failed to parse absolute URL",{link:t,error:i})}const n="/__admin";return e.startsWith(n)&&(e=e.slice(n.length)||"/"),e=e.replace(/^\/+/,""),e?`/${e}`:""}function normalizeScenario(t,e){if(!t||typeof t!="object")return null;const n=typeof t.id=="string"?t.id:"",i=typeof t.name=="string"?t.name:"",r=safeDecode(n),a=safeDecode(i),s=r||a||n||i||"",c=a||r||i||n||`Scenario ${e+1}`,l=safeDecode(t.state)||t.state||"Started",d=Array.isArray(t.possibleStates)?t.possibleStates.map(M=>safeDecode(M)||M).filter(Boolean):[],m=Array.isArray(t.mappings)?t.mappings.map(M=>!M||typeof M!="object"?M:{...M,requiredScenarioState:safeDecode(M.requiredScenarioState)||M.requiredScenarioState||"",newScenarioState:safeDecode(M.newScenarioState)||M.newScenarioState||""}):[],w=normalizeScenarioLink(t.stateEndpoint||t?._links?.["update-state"]?.href||t?._links?.updateState?.href||t?._links?.state?.href),E=normalizeScenarioLink(t.resetEndpoint||t?._links?.["reset-state"]?.href||t?._links?.resetState?.href||t?._links?.reset?.href);return{...t,id:s||r||n,name:c,displayName:c,identifier:s,originalId:n,originalName:i||a,decodedId:r,decodedName:a,state:l,possibleStates:d,mappings:m,stateEndpoint:w,resetEndpoint:E}}function normalizeScenarioList(t){return Array.isArray(t)?t.map((e,n)=>normalizeScenario(e,n)).filter(Boolean):[]}function getScenarioByIdentifier(t){if(typeof t!="string")return null;const e=t.trim();return e&&(Array.isArray(allScenarios)?allScenarios:[]).find(i=>[i?.identifier,i?.id,i?.name,i?.decodedId,i?.decodedName,i?.originalId,i?.originalName].some(a=>typeof a!="string"?!1:a.trim()===e))||null}function resolveScenarioTarget(t){const e=typeof t=="string"?t.trim():"",n=e?getScenarioByIdentifier(e):null,i=n?.identifier||n?.decodedId||n?.decodedName||e,r=safeDecode(i)||i,a=n?.displayName||n?.decodedName||n?.name||n?.decodedId||n?.id||safeDecode(e)||e,s=typeof n?.stateEndpoint=="string"?n.stateEndpoint:"",c=typeof n?.resetEndpoint=="string"?n.resetEndpoint:"",l=typeof window.buildScenarioStateEndpoint=="function"?window.buildScenarioStateEndpoint:E=>`${ENDPOINTS.SCENARIOS}/${encodeURIComponent(E)}/state`,d=s||(r?l(r):"");return{rawCandidate:e,targetScenario:n,endpointIdentifier:r,displayName:a,stateEndpoint:d,resetEndpoint:c||d,resetMethod:c?"POST":"PUT"}}function setScenariosLoading(t){const e=document.getElementById("scenarios-loading");if(e&&e.classList.toggle("hidden",!t),t){const n=document.getElementById(SELECTORS.LISTS.SCENARIOS);n&&(n.style.display="none")}}window.loadScenarios=async()=>{const t=document.getElementById("scenarios-empty");t&&t.classList.add("hidden"),setScenariosLoading(!0);try{const e=await apiFetch(ENDPOINTS.SCENARIOS),n=Array.isArray(e?.scenarios)?e.scenarios:[];allScenarios=normalizeScenarioList(n),window.allScenarios=allScenarios}catch(e){allScenarios=[],window.allScenarios=allScenarios,Logger.error("SCENARIOS","Load scenarios error:",e),NotificationManager.error(`Failed to load scenarios: ${e.message}`)}finally{setScenariosLoading(!1),renderScenarios()}},window.refreshScenarios=async()=>{await TabManager.refresh("scenarios")},window.resetAllScenarios=async()=>{if(confirm("Reset all scenarios to the initial state?")){setScenariosLoading(!0);try{await apiFetch(ENDPOINTS.SCENARIOS_RESET,{method:"POST"}),NotificationManager.success("All scenarios have been reset!"),await loadScenarios()}catch(t){NotificationManager.error(`Scenario reset failed: ${t.message}`),setScenariosLoading(!1)}}};function updateScenarioStateSuggestions(t){const e=document.getElementById("scenario-state-options"),n=document.getElementById("scenario-state");if(!e)return;const i=Array.isArray(allScenarios)?allScenarios:[],r=getScenarioByIdentifier(t),a=new Set,s=d=>{if(typeof d!="string")return;const m=d.trim();m&&a.add(m)};s("Started");const c=d=>{d&&(s(d.state),(d.possibleStates||[]).forEach(s),(d.mappings||[]).forEach(m=>{s(m?.requiredScenarioState),s(m?.newScenarioState)}))};r&&c(r),a.size===0&&i.forEach(c);const l=Array.from(a).sort((d,m)=>d.localeCompare(m));e.innerHTML=l.map(d=>`
        <option value="${escapeHtml(d)}"></option>
    `).join(""),n&&(l.length>0?n.setAttribute("placeholder",`Enter state (e.g. ${l[0]})`):n.setAttribute("placeholder","Enter state name"))}window.setScenarioState=async(t,e,n={})=>{const i=document.getElementById("scenario-select"),r=document.getElementById("scenario-state"),a=typeof t=="string"?t:"",s=typeof e=="string"?e.trim():"",c=n&&typeof n=="object"?n:{},l=c.refresh!==!1,d=c.silent===!0,m=c.manageLoading!==!1,w=c.syncForm!==!1;let E=a;!E&&i&&(E=i.value||"");const M=resolveScenarioTarget(E),C=M.endpointIdentifier,v=M.displayName,h=s||r?.value?.trim()||"";if(!C||!C.trim()||!h)return d||NotificationManager.warning("Please select scenario and enter state"),!1;const y=M.stateEndpoint;if(!y)return d||NotificationManager.error("Unable to determine the scenario state endpoint."),!1;if(M.targetScenario&&Array.isArray(M.targetScenario.possibleStates)&&M.targetScenario.possibleStates.length===0)return d||NotificationManager.warning(`Scenario "${v}" does not expose any states to switch to.`),!1;if(w)if(i){const R=M.targetScenario?.identifier||M.targetScenario?.decodedId||M.targetScenario?.decodedName||C;i.value=R,updateScenarioStateSuggestions(R)}else updateScenarioStateSuggestions(C);m&&setScenariosLoading(!0);const A=!!M.targetScenario;try{return await apiFetch(y,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:h})}),d||NotificationManager.success(`Scenario "${v}" switched to state "${h}"`),w&&!s&&r&&(r.value=""),w&&updateScenarioStateSuggestions(C),l?await loadScenarios():m&&setScenariosLoading(!1),!0}catch(R){Logger.error("SCENARIOS","Change scenario state error:",R);const H=/HTTP\s+404/.test(R?.message||""),X=/does not support state/i.test(R?.message||"");return d||(H&&!A?NotificationManager.error(`Scenario "${v}" was not found on the server.`):X?NotificationManager.error(`Scenario "${v}" does not allow state changes.`):NotificationManager.error(`Scenario state change failed: ${R.message}`)),m&&setScenariosLoading(!1),!1}};async function resetScenarioState(t,e={}){const n=e&&typeof e=="object"?e:{},i=n.refresh!==!1,r=n.silent===!0,a=n.manageLoading!==!1;if(typeof t!="string"||!t.trim())return r||NotificationManager.warning("Unable to determine which scenario to reset."),!1;const s=resolveScenarioTarget(t),c=s.resetEndpoint,l=s.resetMethod,d=s.displayName;if(!c)return r||NotificationManager.error("Unable to determine the scenario reset endpoint."),!1;a&&setScenariosLoading(!0);try{return await apiFetch(c,{method:l}),r||NotificationManager.success(`Scenario "${d}" has been reset to its initial state.`),i?await loadScenarios():a&&setScenariosLoading(!1),!0}catch(m){if(l==="PUT"&&s.stateEndpoint)try{return await apiFetch(s.stateEndpoint,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:"Started"})}),r||NotificationManager.success(`Scenario "${d}" has been reset to its initial state.`),i?await loadScenarios():a&&setScenariosLoading(!1),!0}catch(w){return Logger.error("SCENARIOS","Reset scenario state error:",w),r||NotificationManager.error(`Scenario reset failed: ${w.message}`),a&&setScenariosLoading(!1),!1}return Logger.error("SCENARIOS","Reset scenario state error:",m),r||NotificationManager.error(`Scenario reset failed: ${m.message}`),a&&setScenariosLoading(!1),!1}}function normalizeSearchTerm(t){return typeof t!="string"?"":t.trim().toLowerCase()}function scenarioMatchesSearch(t,e){return e?!t||typeof t!="object"?!1:[t.displayName,t.name,t.identifier,t.id,t.state,t.description].filter(r=>typeof r=="string"&&r.trim()).map(r=>r.toLowerCase()).some(r=>r.includes(e))?!0:(Array.isArray(t.mappings)?t.mappings:[]).some(r=>!r||typeof r!="object"?!1:[r.name,r.id,r.uuid,r.stubId,r.stubMappingId,r.requiredScenarioState,r.newScenarioState,r.request?.method,r.request?.url,r.request?.urlPattern,r.request?.urlPath,r.request?.urlPathPattern].filter(s=>typeof s=="string"&&s.trim()).map(s=>s.toLowerCase()).some(s=>s.includes(e))):!0}function setScenarioBulkMenuOpen(t){scenarioUiState.bulkMenuOpen=!!t;const e=document.getElementById("scenario-bulk-menu");e&&(e.classList.toggle("is-open",scenarioUiState.bulkMenuOpen),e.setAttribute("aria-hidden",scenarioUiState.bulkMenuOpen?"false":"true"))}function updateScenarioHeaderUI(t,e){const n=document.getElementById("scenario-stats");if(n){const d=Array.isArray(t)?t.reduce((w,E)=>w+(Array.isArray(E?.mappings)?E.mappings.length:0),0):0,m=Array.isArray(t)?t.length:0;n.textContent=`${m}/${e} scenarios \u2022 ${d} mappings`}const i=document.getElementById("scenario-select-all-row"),r=document.getElementById("scenario-select-all-btn"),a=Array.isArray(t)?t.map(d=>{const m=typeof d?.identifier=="string"?d.identifier:typeof d?.decodedId=="string"?d.decodedId:typeof d?.id=="string"?d.id:"";return(typeof m=="string"?m.trim():"")||""}).filter(Boolean):[];scenarioUiState.lastVisibleSelectable=a;const s=scenarioUiState.selected instanceof Set?scenarioUiState.selected.size:0,c=document.getElementById("scenario-bulk-wrap"),l=document.getElementById("scenario-bulk-count");if(l&&(l.textContent=String(s)),c&&c.classList.toggle("is-hidden",s===0),i&&(i.style.display=a.length>0?"":"none"),r){const d=a.length>0&&a.every(m=>scenarioUiState.selected.has(m));r.classList.toggle("is-selected",d),r.setAttribute("aria-checked",d?"true":"false")}s===0&&scenarioUiState.bulkMenuOpen&&setScenarioBulkMenuOpen(!1)}async function bulkResetSelectedScenarios(){const t=scenarioUiState.selected instanceof Set?Array.from(scenarioUiState.selected):[];if(t.length===0||!confirm(`Reset ${t.length} selected scenarios to their initial state?`))return;setScenarioBulkMenuOpen(!1),setScenariosLoading(!0);const e=[];for(const n of t)try{const i=resolveScenarioTarget(n);if(!i.resetEndpoint){e.push({id:n,name:i.displayName||n,error:"No reset endpoint resolved"});continue}try{await apiFetch(i.resetEndpoint,{method:i.resetMethod})}catch(r){if(i.resetMethod==="PUT"&&i.stateEndpoint)await apiFetch(i.stateEndpoint,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:"Started"})});else throw r}}catch(i){e.push({id:n,name:n,error:i?.message||String(i)})}if(e.length>0){scenarioUiState.selected=new Set(e.map(i=>i.id).filter(Boolean));const n=e.slice(0,3).map(i=>i.name||i.id).join(", ");NotificationManager.warning(`Bulk reset: ${e.length} failed${n?` (e.g. ${n})`:""}.`)}else scenarioUiState.selected.clear(),NotificationManager.success("Bulk reset complete.");await loadScenarios()}async function bulkSetScenarioState(){const t=scenarioUiState.selected instanceof Set?Array.from(scenarioUiState.selected):[];if(t.length===0)return;const e=t.length===1&&getScenarioByIdentifier(t[0])?.state||"Started",n=prompt(`Set state for ${t.length} selected scenarios:`,e);if(!n||!n.trim())return;setScenarioBulkMenuOpen(!1),setScenariosLoading(!0);const i=[],r=n.trim();for(const a of t)try{const s=resolveScenarioTarget(a);if(!s.stateEndpoint){i.push({id:a,name:s.displayName||a,error:"No state endpoint resolved"});continue}await apiFetch(s.stateEndpoint,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:r})})}catch(s){i.push({id:a,name:a,error:s?.message||String(s)})}if(i.length>0){scenarioUiState.selected=new Set(i.map(s=>s.id).filter(Boolean));const a=i.slice(0,3).map(s=>s.name||s.id).join(", ");NotificationManager.warning(`Bulk state update: ${i.length} failed${a?` (e.g. ${a})`:""}.`)}else scenarioUiState.selected.clear(),NotificationManager.success(`Bulk state updated: "${r}"`);await loadScenarios()}async function fetchFullMappingById(t){const e=(t??"").toString().trim();if(!e)return null;if(typeof window.getMappingById=="function")try{const a=await window.getMappingById(e);if(a&&typeof a=="object")return a}catch(a){Logger.warn("SCENARIOS","getMappingById failed, falling back to direct fetch",{mappingId:e,error:a})}const n=`/mappings/${encodeURIComponent(e)}`,i=await apiFetch(n),r=i&&typeof i=="object"&&i.mapping?i.mapping:i;return r&&typeof r=="object"?r:null}async function bulkExportSelectedMappings(){const t=scenarioUiState.selected instanceof Set?Array.from(scenarioUiState.selected):[];if(t.length===0)return;setScenarioBulkMenuOpen(!1);const e=[],n=new Set;if(t.forEach(c=>{const l=getScenarioByIdentifier(c);(Array.isArray(l?.mappings)?l.mappings:[]).forEach(m=>{const w=(m?.id||m?.uuid||m?.stubMappingId||m?.stubId||m?.mappingId||"").toString().trim();!w||n.has(w)||(n.add(w),e.push(w))})}),e.length===0){NotificationManager.warning("No mappings found for selected scenarios.");return}setScenariosLoading(!0);const i=[],r=[];for(const c of e)try{const l=await fetchFullMappingById(c);if(!l){r.push({id:c,error:"Empty mapping payload"});continue}i.push(l)}catch(l){r.push({id:c,error:l?.message||String(l)})}const s=`wiremock-mappings-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;if(downloadFile(s,`${JSON.stringify({mappings:i},null,2)}
`,"application/json"),r.length>0){const c=r.slice(0,3).map(l=>l.id).join(", ");NotificationManager.warning(`Exported ${i.length}/${e.length} mapping(s). Failed: ${r.length}${c?` (e.g. ${c})`:""}.`)}else NotificationManager.success(`Exported ${i.length} mapping(s).`);setScenariosLoading(!1)}function clearScenarioSelection(){scenarioUiState.selected instanceof Set&&scenarioUiState.selected.clear(),setScenarioBulkMenuOpen(!1),renderScenarios()}function toggleSelectAllVisibleScenarios(){const t=Array.isArray(scenarioUiState.lastVisibleSelectable)?scenarioUiState.lastVisibleSelectable:[];scenarioUiState.selected instanceof Set||(scenarioUiState.selected=new Set),t.length>0&&t.every(n=>scenarioUiState.selected.has(n))?t.forEach(n=>scenarioUiState.selected.delete(n)):t.forEach(n=>scenarioUiState.selected.add(n)),renderScenarios()}window.renderScenarios=()=>{const t=document.getElementById(SELECTORS.LISTS.SCENARIOS),e=document.getElementById("scenarios-empty"),n=document.getElementById("scenarios-count"),i=document.getElementById("scenario-select"),r=document.getElementById("scenario-state-options"),a=document.getElementById("scenario-search"),s=document.getElementById("scenario-bulk-btn"),c=document.getElementById("scenario-bulk-reset"),l=document.getElementById("scenario-bulk-set-state"),d=document.getElementById("scenario-bulk-export"),m=document.getElementById("scenario-bulk-clear"),w=document.getElementById("scenario-select-all-btn");if(!t)return;n&&(n.textContent=Array.isArray(allScenarios)?allScenarios.length:0);const E=Array.isArray(allScenarios)?allScenarios:[];if(E.length===0){t.innerHTML="",t.style.display="none",e&&e.classList.remove("hidden"),i&&(i.innerHTML='<option value="">Select Scenario</option>'),r&&(r.innerHTML=""),updateScenarioStateSuggestions(""),updateScenarioHeaderUI([],0);return}if(e&&e.classList.add("hidden"),scenarioUiState.selected instanceof Set&&scenarioUiState.selected.size>0){const h=new Set(E.map(y=>{const A=typeof y?.identifier=="string"?y.identifier:typeof y?.decodedId=="string"?y.decodedId:typeof y?.id=="string"?y.id:"";return typeof A=="string"?A.trim():""}).filter(Boolean));for(const y of Array.from(scenarioUiState.selected))h.has(y)||scenarioUiState.selected.delete(y)}a&&(a.value||"")!==scenarioUiState.searchTerm&&(a.value=scenarioUiState.searchTerm),scenarioToolbarHandlersAttached||(a&&a.addEventListener("input",h=>{scenarioUiState.searchTerm=typeof h.target?.value=="string"?h.target.value:"",renderScenarios()}),s&&s.addEventListener("click",h=>{h.stopPropagation(),setScenarioBulkMenuOpen(!scenarioUiState.bulkMenuOpen)}),c&&c.addEventListener("click",()=>{bulkResetSelectedScenarios()}),l&&l.addEventListener("click",()=>{bulkSetScenarioState()}),d&&d.addEventListener("click",()=>{bulkExportSelectedMappings()}),m&&m.addEventListener("click",clearScenarioSelection),w&&w.addEventListener("click",toggleSelectAllVisibleScenarios),document.addEventListener("click",h=>{const y=document.getElementById("scenario-bulk-wrap");y&&scenarioUiState.bulkMenuOpen&&(typeof y.contains=="function"&&y.contains(h.target)||setScenarioBulkMenuOpen(!1))}),document.addEventListener("keydown",h=>{scenarioUiState.bulkMenuOpen&&h.key==="Escape"&&setScenarioBulkMenuOpen(!1)}),scenarioToolbarHandlersAttached=!0);const M=i?.value||"";if(i){const h=['<option value="">Select Scenario</option>'].concat(E.map(y=>{const A=typeof y?.identifier=="string"?y.identifier:typeof y?.decodedId=="string"?y.decodedId:typeof y?.id=="string"?y.id:"",R=typeof y?.displayName=="string"?y.displayName:typeof y?.name=="string"?y.name:typeof y?.decodedName=="string"?y.decodedName:"Unnamed scenario";return`
                <option value="${escapeHtml(A)}">${escapeHtml(R)}</option>
            `}));if(i.innerHTML=h.join(""),M){const y=getScenarioByIdentifier(M);y&&(i.value=y.identifier||y.decodedId||y.decodedName||y.id||y.name||"")}}r&&updateScenarioStateSuggestions(i?.value||M||""),i&&!i.dataset.scenarioHandlerAttached&&(i.addEventListener("change",h=>{updateScenarioStateSuggestions(h.target.value)}),i.dataset.scenarioHandlerAttached="1"),t.style.display="";const C=normalizeSearchTerm(scenarioUiState.searchTerm),v=E.filter(h=>scenarioMatchesSearch(h,C));if(v.length===0){if(t.innerHTML="",t.style.display="none",e){e.classList.remove("hidden");const h=typeof e.querySelector=="function"?e.querySelector("h3"):null,y=typeof e.querySelector=="function"?e.querySelector("p"):null;h&&(h.textContent="No scenarios match your filter"),y&&(y.textContent="Try clearing the filter or searching by mapping URL/state.")}updateScenarioHeaderUI([],E.length);return}if(e){const h=typeof e.querySelector=="function"?e.querySelector("h3"):null,y=typeof e.querySelector=="function"?e.querySelector("p"):null;h&&(h.textContent="No scenarios found"),y&&(y.textContent="Create mappings with scenarios to manage state here."),e.classList.add("hidden")}updateScenarioHeaderUI(v,E.length),t.innerHTML=v.map((h,y)=>{const A=typeof h?.identifier=="string"?h.identifier:typeof h?.decodedId=="string"?h.decodedId:typeof h?.id=="string"?h.id:"",R=escapeHtml(A),H=typeof h?.displayName=="string"?h.displayName:typeof h?.name=="string"?h.name:typeof h?.decodedName=="string"?h.decodedName:"Unnamed scenario",X=escapeHtml(H),_=escapeHtml(h.state||"Started"),de=Array.isArray(h.possibleStates)?h.possibleStates.filter(Boolean):[],be=A||h?.decodedId||h?.decodedName||h?.id||h?.name||`scenario-${y}`,x=typeof be=="string"&&be.trim()?be.trim():`scenario-${y}`,j=scenarioExpansionState[x]===!0,F=escapeHtml(x),D=typeof A=="string"&&A.trim().length>0,re=D?A.trim():"",J=re&&scenarioUiState.selected instanceof Set?scenarioUiState.selected.has(re):!1,se=D?`
            <button
                type="button"
                class="scenario-select-btn${J?" is-selected":""}"
                data-scenario-action="select"
                data-scenario="${R}"
                role="checkbox"
                aria-checked="${J?"true":"false"}"
                aria-label="Select scenario ${X}"
                title="Select"
            >
                <span class="scenario-select-box" aria-hidden="true"></span>
            </button>
        `:`
            <span style="width:18px;height:18px;display:inline-block;"></span>
        `,ye=new Set,we=[],je=oe=>{if(typeof oe!="string")return;const Ce=oe.trim();!Ce||ye.has(Ce)||(ye.add(Ce),we.push(Ce))};je(h.state||""),de.forEach(je);const _e=we.map(oe=>{const Ce=escapeHtml(oe),Pe=oe===h.state,He="scenario-state-pill";return Pe?`<span class="${He} is-active" data-current="true">${Ce}</span>`:D?`
                <button
                    type="button"
                    class="${He}"
                    data-scenario-action="transition"
                    data-scenario="${R}"
                    data-state="${Ce}"
                >
                    ${Ce}
                </button>
            `:`<span class="${He}">${Ce}</span>`}).join(""),ct=D?`
            <button
                type="button"
                class="scenario-reset-btn"
                data-scenario-action="reset"
                data-scenario="${R}"
            >
                ${renderIcon("refresh",{className:"icon-inline"})} Reset
            </button>
        `:"",Ve=_e||ct?`
            <div class="scenario-summary-controls">
                <div class="scenario-state-pill-list">${_e}</div>
                ${ct}
            </div>
        `:"",Rt=h.description?`
            <div class="scenario-info">
                <div class="scenario-description">${escapeHtml(h.description)}</div>
            </div>
        `:"",lt=Array.isArray(h.mappings)?h.mappings:[],vt=lt.length?`
            <ul class="scenario-mapping-list">
                ${lt.map(oe=>{const Ce=oe?.id||oe?.uuid||oe?.stubMappingId||oe?.stubId||oe?.mappingId||"",Pe=Ce?escapeHtml(Ce):"",He=escapeHtml(oe?.name||Ce||"Unnamed mapping"),Ke=oe?.request?.method||oe?.method||oe?.requestMethod||"",ut=oe?.request?.urlPattern||oe?.request?.urlPath||oe?.request?.url||oe?.url||oe?.requestUrl||"",Qe=Ke?`<span class="scenario-mapping-method">${escapeHtml(Ke)}</span>`:"",ve=ut?`<span class="scenario-mapping-url">${escapeHtml(ut)}</span>`:"",Fe=Qe||ve?`
                        <div class="scenario-mapping-meta">
                            ${[Qe,ve].filter(Boolean).join(" \xB7 ")}
                        </div>
                    `:"",Me=oe?.requiredScenarioState||oe?.requiredState||"",qe=oe?.newScenarioState||oe?.newState||"",Xe=[Me?`<span class="badge badge-warning" title="Required scenario state">Requires: ${escapeHtml(Me)}</span>`:"",qe?`<span class="badge badge-info" title="Next scenario state">\u2192 ${escapeHtml(qe)}</span>`:""].filter(Boolean).join(" "),Ze=Xe?`
                        <div class="scenario-mapping-states">${Xe}</div>
                    `:"",pt=renderIcon("pencil",{className:"action-icon"}),wt=renderIcon("clipboard",{className:"action-icon"}),St=renderIcon("trash",{className:"action-icon"}),Ue=Ce?`
                        <div class="scenario-mapping-actions">
                            <button
                                class="btn btn-sm btn-secondary"
                                data-scenario-action="edit-mapping"
                                data-mapping-id="${Pe}"
                                title="Edit mapping"
                            >
                                ${pt||""}<span>Edit</span>
                            </button>
                            <button
                                class="btn btn-sm btn-secondary"
                                data-scenario-action="duplicate-mapping"
                                data-mapping-id="${Pe}"
                                title="Duplicate mapping"
                            >
                                ${wt||""}<span>Duplicate</span>
                            </button>
                            <button
                                class="btn btn-sm btn-danger"
                                data-scenario-action="delete-mapping"
                                data-mapping-id="${Pe}"
                                title="Delete mapping"
                            >
                                ${St||""}<span>Delete</span>
                            </button>
                        </div>
                    `:"";return`
                        <li class="scenario-mapping-item">
                            <div class="scenario-mapping-name">${He}</div>
                            ${Fe}
                            ${Ze}
                            ${Ue}
                        </li>
                    `}).join("")}
            </ul>
        `:`
            <div class="scenario-mapping-empty">No stub mappings are bound to this scenario yet.</div>
        `,yt=`<span class="collapse-arrow" aria-hidden="true">${j?"\u25BC":"\u25B6"}</span>`,dt=`${j?"Collapse":"Expand"} scenario ${H}`;return`
            <div class="scenario-item ${j?"expanded":"collapsed"}${J?" is-selected":""}" data-scenario="${R}" data-scenario-key="${F}">
                <div class="scenario-summary">
                    ${se}
                    <button
                        type="button"
                        class="scenario-toggle-btn"
                        data-scenario-action="toggle"
                        data-scenario-key="${F}"
                        aria-expanded="${j?"true":"false"}"
                        aria-label="${escapeHtml(dt)}"
                    >
                        ${yt}
                    </button>
                    <div class="scenario-summary-main">
                        <div class="scenario-summary-header">
                            <div class="scenario-name">${X}</div>
                            <div class="scenario-state">State: ${_}</div>
                        </div>
                        ${Ve}
                    </div>
                </div>
                <div class="scenario-body">
                    ${Rt}
                    <div class="scenario-mappings">
                        <div class="scenario-section-title">Stub mappings</div>
                        ${vt}
                    </div>
                </div>
            </div>
        `}).join(""),scenarioListHandlerAttached||(t.addEventListener("click",async h=>{const y=h.target.closest("[data-scenario-action]");if(!y||typeof t.contains=="function"&&!t.contains(y))return;const A=y.dataset.scenarioAction;if(A==="toggle"){h.preventDefault();const R=y.dataset.scenarioKey||y.dataset.scenario||"";if(!R.trim())return;const H=scenarioExpansionState[R]===!0;scenarioExpansionState[R]=!H,renderScenarios()}else if(A==="select"){h.preventDefault();const R=y.dataset.scenario||"",H=typeof R=="string"?R.trim():"";if(!H)return;scenarioUiState.selected instanceof Set||(scenarioUiState.selected=new Set),scenarioUiState.selected.has(H)?scenarioUiState.selected.delete(H):scenarioUiState.selected.add(H),renderScenarios()}else if(A==="transition"){const R=y.dataset.scenario||"",H=y.dataset.state||"";if(!R.trim()||!H.trim())return;y.disabled=!0;try{await setScenarioState(R,H)}finally{y.disabled=!1}}else if(A==="reset"){const R=y.dataset.scenario||"";if(!R.trim())return;y.disabled=!0;try{await resetScenarioState(R)}finally{y.disabled=!1}}else if(A==="edit-mapping"){const R=y.dataset.mappingId;R&&typeof window.openEditModal=="function"&&window.openEditModal(R)}else if(A==="duplicate-mapping"){const R=y.dataset.mappingId;if(R&&typeof window.duplicateMapping=="function"){y.disabled=!0;try{await window.duplicateMapping(R),await loadScenarios()}finally{y.disabled=!1}}}else if(A==="delete-mapping"){const R=y.dataset.mappingId;if(R&&typeof window.deleteMapping=="function"){y.disabled=!0;try{await window.deleteMapping(R),await loadScenarios()}finally{y.disabled=!1}}}}),scenarioListHandlerAttached=!0)},window.startRecording=async(t={})=>{try{const n={...{targetBaseUrl:"https://example.com",filters:{urlPathPatterns:[".*"],method:"ANY",headers:{}},captureHeaders:{},requestBodyPattern:{},persist:!0,repeatsAsScenarios:!1,transformers:["response-template"],transformerParameters:{}},...t};await apiFetch(ENDPOINTS.RECORDINGS_START,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),NotificationManager.success("Recording started!"),window.isRecording=!0;const i=document.getElementById(SELECTORS.RECORDING.INDICATOR);i&&(i.style.display="block")}catch(e){Logger.error("RECORDING","Start recording error:",e),NotificationManager.error(`Failed to start recording: ${e.message}`)}},window.stopRecording=async()=>{try{const t=await apiFetch(ENDPOINTS.RECORDINGS_STOP,{method:"POST"});window.isRecording=!1,window.recordedCount=0;const e=document.getElementById(SELECTORS.RECORDING.INDICATOR);e&&(e.style.display="none");const n=t.mappings?t.mappings.length:0;NotificationManager.success(`Recording stopped! Captured ${n} mappings`);const i=window.MappingsStore.getAll();return await fetchAndRenderMappings(i),t.mappings||[]}catch(t){return Logger.error("RECORDING","Stop recording error:",t),NotificationManager.error(`Failed to stop recording: ${t.message}`),[]}},window.getRecordingStatus=async()=>{try{return(await apiFetch(ENDPOINTS.RECORDINGS_STATUS)).status||"Unknown"}catch(t){return Logger.error("RECORDING","Recording status error:",t),"Unknown"}},window.takeRecordingSnapshot=async(t={})=>{try{const e=await apiFetch(ENDPOINTS.RECORDINGS_SNAPSHOT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=e.mappings?e.mappings.length:0;return NotificationManager.success(`Snapshot created! Captured ${n} mappings`),e.mappings||[]}catch(e){return Logger.error("RECORDING","Recording snapshot error:",e),NotificationManager.error(`Snapshot failed: ${e.message}`),[]}},window.clearRecordings=async()=>{if(confirm("Clear all recorded requests?"))try{await apiFetch(ENDPOINTS.REQUESTS,{method:"DELETE"}),window.recordedCount=0;const t=document.getElementById("recordings-list");t&&(t.innerHTML=""),typeof fetchAndRenderRequests=="function"&&await fetchAndRenderRequests(),NotificationManager.success("Recording log cleared.")}catch(t){Logger.error("RECORDING","Clear recordings error:",t),NotificationManager.error(`Failed to clear recordings: ${t.message}`)}},window.refreshRequests=async()=>{await fetchAndRenderRequests(),(document.getElementById(SELECTORS.REQUEST_FILTERS.METHOD)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.URL)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.STATUS)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO)?.value)&&FilterManager.applyRequestFilters()},window.applyQuickTimeFilter=()=>{const t=new Date,e=new Date(t.getTime()-1440*60*1e3),n=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM),i=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO);n&&(n.value=Utils.formatDateTime(e)),i&&(i.value=Utils.formatDateTime(t)),FilterManager.applyRequestFilters()},window.cleanupPendingDeletions=()=>{for(const[t,e]of window.deletionTimeouts)clearTimeout(e);window.deletionTimeouts.clear(),window.pendingDeletedIds.clear()},window.addEventListener("beforeunload",window.cleanupPendingDeletions),window.toggleElementById=t=>document.getElementById(t)?.classList.toggle("hidden"),window.togglePreview=t=>window.toggleElementById(`preview-${t}`),window.toggleRequestPreview=t=>window.toggleElementById(`request-preview-${t}`),window.getRequestCount=async(t={})=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_COUNT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).count||0}catch(e){return Logger.error("REQUESTS","Request count error:",e),NotificationManager.error(`Request count failed: ${e.message}`),0}},window.findRequests=async t=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_FIND,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).requests||[]}catch(e){return Logger.error("REQUESTS","Find requests error:",e),NotificationManager.error(`Request search failed: ${e.message}`),[]}},window.getUnmatchedRequests=async()=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_UNMATCHED)).requests||[]}catch(t){return Logger.error("REQUESTS","Unmatched requests error:",t),[]}},window.findMappingsByMetadata=async t=>{try{return(await apiFetch(ENDPOINTS.MAPPINGS_FIND_BY_METADATA,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).mappings||[]}catch(e){return Logger.error("METADATA","Find mappings by metadata error:",e),[]}},Logger.info("UI","Features.js loaded - Business functions for mappings, requests, scenarios + WireMock 3.9.1+ API fixes"),window.updateLastSuccessUI=()=>{try{const t=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT);if(!t)return;const e=window.lastWiremockSuccess||Date.now(),n=new Date(e).toLocaleTimeString();t.textContent=`Last OK: ${n}`,Logger.info("HEALTH","last success UI updated:",{ts:e,time:n})}catch{}},window.applyHealthUI=(t,e)=>{try{window.healthState=window.healthState||{isHealthy:null,lastCheckAt:null,lastOkAt:null,lastLatencyMs:null},window.healthState.lastCheckAt=Date.now(),t===!0?(window.healthState.isHealthy=!0,window.healthState.lastOkAt=Date.now(),window.healthState.lastLatencyMs=typeof e=="number"?e:null):t===!1&&(window.healthState.isHealthy=!1,window.healthState.lastLatencyMs=null);const n=document.getElementById(SELECTORS.HEALTH.INDICATOR);if(n)if(n.style.display="inline",t===!0){const i=typeof e=="number"?`${e}ms`:"OK";n.innerHTML=`<span>Response Time: </span><span class="healthy">${i}</span>`}else t===!1?n.innerHTML='<span>Response Time: </span><span class="unhealthy">Unhealthy</span>':n.innerHTML='<span>Response Time: </span><span class="error">Error</span>';t===!0&&(window.lastWiremockSuccess=Date.now(),typeof window.updateLastSuccessUI=="function"&&window.updateLastSuccessUI())}catch(n){Logger.warn("HEALTH","applyHealthUI failed:",n)}};try{const t=localStorage.getItem("imock-show-meta-timestamps");t!==null&&(window.showMetaTimestamps=t==="1")}catch{}window.toggleMetaTimestamps=()=>{try{window.showMetaTimestamps=window.showMetaTimestamps===!1,localStorage.setItem("imock-show-meta-timestamps",window.showMetaTimestamps?"1":"0");const t=window.MappingsStore.getAll();Array.isArray(t)&&fetchAndRenderMappings(t)}catch(t){Logger.warn("METADATA","toggleMetaTimestamps failed:",t)}};const IMOCK_CACHE_ID="00000000-0000-0000-0000-00000000cace",IMOCK_CACHE_URL="/__imock/cache";function isImockCacheMapping(t){try{const e=(t?.id||t?.uuid)===IMOCK_CACHE_ID,n=t?.metadata?.imock?.type==="cache",i=(t?.name||"").toLowerCase()==="imock cache",r=(t?.request?.url||t?.request?.urlPath)===IMOCK_CACHE_URL;return!!(e||n||i||r)}catch{return!1}}function slimMapping(t){return{id:t.id||t.uuid,name:t.name||t.metadata?.name,priority:t.priority,persistent:t.persistent,scenarioName:t.scenarioName,requiredScenarioState:t.requiredScenarioState,newScenarioState:t.newScenarioState,request:{method:t.request?.method,url:t.request?.urlPath||t.request?.urlPathPattern||t.request?.urlPattern||t.request?.url||"N/A"},response:{status:t.response?.status},metadata:{created:t.metadata?.created,edited:t.metadata?.edited,source:t.metadata?.source}}}function buildSlimList(t){return{mappings:(t||[]).filter(n=>!isImockCacheMapping(n)).map(slimMapping)}}async function getCacheByFixedId(){try{Logger.cache("Trying fixed ID lookup...");const t=await apiFetch(`/mappings/${IMOCK_CACHE_ID}`);if(t&&isImockCacheMapping(t))return t;Logger.cache("Fixed ID miss")}catch(t){t.status===401||t.message&&t.message.includes("401")?Logger.warn("CACHE","Authorization error loading cache by fixed ID - check credentials"):t.status===404||t.message&&t.message.includes("404")?Logger.debug("CACHE","Cache mapping not found by fixed ID (404)"):Logger.debug("CACHE","Error loading cache by fixed ID:",t.message)}return null}async function upsertImockCacheMapping(t){Logger.cache("Upsert cache mapping start");const e=JSON.stringify(t||{});let n=0;for(let s=0;s<e.length;s++)n=n*31+e.charCodeAt(s)|0;const i=(n>>>0).toString(16),r={imock:{type:"cache",version:1,timestamp:Date.now(),count:(t?.mappings||[]).length,hash:i}},a={id:IMOCK_CACHE_ID,name:"iMock Cache",priority:1,persistent:!1,request:{method:"GET",url:IMOCK_CACHE_URL},response:{status:200,jsonBody:t,headers:{"Content-Type":"application/json; charset=utf-8"}},metadata:r};try{Logger.cache("PUT /mappings/{id}");const s=await apiFetch(`/mappings/${IMOCK_CACHE_ID}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return Logger.cache("Upsert done (PUT)"),s}catch{Logger.cache("PUT failed, POST /mappings");const s=await apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return Logger.cache("Upsert done (POST)"),s}}async function regenerateImockCache(t=null){Logger.cache("Regenerate cache start");const e=performance.now();let n=t;n||(n=await fetchMappingsFromServer({force:!0}));const i=n?.mappings||[];Logger.cache("Using fresh server data for cache regeneration");const r=buildSlimList(i);let a=r;try{const c=await upsertImockCacheMapping(r),l=extractCacheJsonBody(c);l&&(a=l)}catch(c){Logger.warn("CACHE","Upsert cache failed:",c)}const s=Math.round(performance.now()-e);return Logger.cache(`Regenerate cache done (${(a?.mappings||[]).length} items) in ${s}ms`),a}async function refreshImockCache(){Logger.cache("Refresh cache requested");try{const t=await regenerateImockCache();return typeof window.refreshMappingsFromCache=="function"&&window.refreshMappingsFromCache(),Logger.cache("Refresh cache completed"),t}catch(t){throw Logger.error("CACHE","Refresh cache failed:",t),t}}window.refreshImockCache=refreshImockCache;async function loadImockCacheBestOf3(){Logger.cache("loadImockCacheBestOf3 start (fixed-id only)");const t=await getCacheByFixedId();return t&&t.response?.jsonBody?(Logger.cache("Using cache: fixed id"),{source:"cache",data:t.response.jsonBody}):(Logger.cache("No cache found - will load from server"),null)}function cloneMappingForCache(t){if(!t)return null;try{if(typeof structuredClone=="function")return structuredClone(t)}catch(e){Logger.warn("CACHE","structuredClone failed for mapping cache clone:",e)}try{return JSON.parse(JSON.stringify(t))}catch(e){Logger.warn("CACHE","JSON clone failed for mapping cache clone:",e)}return{...t}}function mergeMappingData(t,e){return t?e?{...t,...e,request:{...t.request,...e.request},response:{...t.response,...e.response},metadata:{...t.metadata,...e.metadata}}:t:e}function syncCacheWithMappings(t){try{const e=window.MappingsStore;if(!e||!(e.items instanceof Map)||!Array.isArray(t))return;const n=e.items,i=new Set;t.forEach(s=>{if(!s||isImockCacheMapping(s))return;const c=s.id||s.uuid;if(!c)return;i.add(c);const l=cloneMappingForCache(s)||{...s};n.has(c)?n.set(c,mergeMappingData(n.get(c),l)):n.set(c,l)});const r=e.pending instanceof Map?Array.from(e.pending.values()):[],a=new Set;for(const s of r)!s||s.type==="delete"||s.id&&a.add(s.id);Array.from(n.keys()).forEach(s=>{!i.has(s)&&!a.has(s)&&n.delete(s)}),window.cacheLastUpdate=Date.now()}catch(e){Logger.warn("CACHE","syncCacheWithMappings failed:",e)}}function extractCacheJsonBody(t){try{if(!t||typeof t!="object")return null;if(t.response?.jsonBody)return t.response.jsonBody;if(t.mapping?.response?.jsonBody)return t.mapping.response.jsonBody;if(t.jsonBody?.mappings||Array.isArray(t.mappings))return{mappings:(Array.isArray(t.jsonBody?.mappings)?t.jsonBody.mappings:Array.isArray(t.mappings)?t.mappings:[]).map(n=>({...n}))}}catch(e){Logger.warn("CACHE","extractCacheJsonBody failed:",e)}return null}(function(e){function n(i={}){const{markDemoModeActive:r,notificationManager:a,fetchAndRenderMappings:s,fetchAndRenderRequests:c,isDatasetAvailable:l,getDataset:d}=i;if(typeof r!="function")throw new Error("Demo loader requires markDemoModeActive callback");if(!a||typeof a=="function")throw new Error("Demo loader requires a notification manager object");if(typeof s!="function")throw new Error("Demo loader requires fetchAndRenderMappings function");if(typeof c!="function")throw new Error("Demo loader requires fetchAndRenderRequests function");const m=a?.success?.bind(a)||a?.info?.bind(a)||(M=>Logger.warn("DEMO",M)),w=a?.error?.bind(a)||a?.warning?.bind(a)||(M=>Logger.warn("DEMO",M)),E=a?.warning?.bind(a)||a?.info?.bind(a)||(M=>Logger.warn("DEMO",M));return async function(){if(!(typeof l=="function"?l():!0))return w("Demo dataset is not available in this build."),{status:"unavailable",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};const v=typeof d=="function"?d():null;if(!v)return w("Unable to load the demo dataset."),{status:"missing",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};const h=Array.isArray(v.mappings)?v.mappings:[],y=Array.isArray(v.requests)?v.requests:[];r("manual-trigger");const[A,R]=await Promise.allSettled([s(h,{source:"demo"}),c(y,{source:"demo"})]),H=A.status==="fulfilled"?A.value!==!1:!1,X=R.status==="fulfilled"?R.value!==!1:!1,_=[];A.status==="rejected"&&_.push(A.reason),R.status==="rejected"&&_.push(R.reason);const de=H&&X?"success":H||X?"partial":"failed";return de==="success"?m("Demo data loaded locally. Explore the interface freely."):(E("Demo data only loaded partially. Check the console for details."),_.length&&w("Some demo data failed to load. Inspect console for details.")),{status:de,mappingsLoaded:H,requestsLoaded:X,errors:_}}}e.DemoMode={createLoader:n}})(typeof window<"u"?window:globalThis),(function(e){let n=!1;function i(r){if(n)return!0;if(!r)return!1;n=!0;const a=e,s=r,{markDemoModeActive:c,addMappingToIndex:l,rebuildMappingIndex:d,computeMappingTabTotals:m,refreshMappingTabSnapshot:w,computeRequestTabTotals:E,refreshRequestTabSnapshot:M,removeMappingFromIndex:C,fetchMappingsFromServer:v}=s;a.updateUptime=function(){if(!a.startTime)return;const x=Math.floor((Date.now()-a.startTime)/1e3),j=Math.floor(x/3600),F=Math.floor(x%3600/60),D=x%60,re=document.getElementById("uptime");re&&(j>0?re.textContent=`${j}h ${F}m ${D}s`:F>0?re.textContent=`${F}m ${D}s`:re.textContent=`${D}s`)},a.stopUptime=function(){a.uptimeInterval&&(a.LifecycleManager.clearInterval(a.uptimeInterval),a.uptimeInterval=null),a.startTime=null;const x=document.getElementById("uptime");x&&(x.textContent="0s")},a.checkHealth=async()=>{try{const x=document.getElementById("wiremock-host"),j=document.getElementById("wiremock-port");if(x&&j&&(x.value.trim()||j.value.trim())){const F=x.value.trim()||"localhost",D=j.value.trim()||"8080";typeof a.normalizeWiremockBaseUrl=="function"?a.wiremockBaseUrl=a.normalizeWiremockBaseUrl(F,D):a.wiremockBaseUrl=`http://${F}:${D}/__admin`,Logger.info("FEATURES","Updated WireMock URL from form:",a.wiremockBaseUrl)}await checkHealthAndStartUptime(),NotificationManager.success("Health check passed!")}catch(x){NotificationManager.error(`Health check failed: ${x.message}`)}},a.refreshMappings=async()=>{try{const x=typeof a.readWiremockSettings=="function"?a.readWiremockSettings():{},j=isCacheEnabled();await fetchAndRenderMappings(null,{useCache:j})&&NotificationManager.success("Mappings refreshed!")}catch(x){NotificationManager.error(`Failed to refresh mappings: ${x.message}`)}},a.forceRefreshCache=async()=>{try{if(!isCacheEnabled()){NotificationManager.warning("Cache is not enabled. Enable it in Settings first.");return}if(typeof a.refreshImockCache!="function"){NotificationManager.error("Cache service not available");return}const x=document.querySelector('[onclick="forceRefreshCache()"]');x&&(x.classList.add("is-loading"),x.disabled=!0);const j=await a.refreshImockCache();let F=!0;j&&typeof j=="object"&&(j.cacheMessage&&y(SELECTORS.IMPORT.RESULT,"info",j.cacheMessage),typeof j.useCache=="boolean"&&(F=j.useCache)),await fetchAndRenderMappings(null,{useCache:F})&&NotificationManager.success("Cache rebuilt and mappings refreshed!")}catch(x){NotificationManager.error(`Failed to rebuild cache: ${x.message}`)}finally{const x=document.querySelector('[onclick="forceRefreshCache()"]');x&&(x.classList.remove("is-loading"),x.disabled=!1)}};const h=a.DemoMode&&typeof a.DemoMode.createLoader=="function"?a.DemoMode.createLoader({markDemoModeActive:c,notificationManager:NotificationManager,fetchAndRenderMappings,fetchAndRenderRequests,isDatasetAvailable:()=>a.DemoData?.isAvailable?.(),getDataset:()=>a.DemoData?.getDataset?.()}):null;a.loadMockData=async()=>{if(!h)return NotificationManager.error("Demo mode is not available in this build."),{status:"unavailable",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};a.demoModeLastError=null;const x=await h();if(x&&x.status!=="success"){const[j]=Array.isArray(x.errors)?x.errors:[];a.demoModeLastError=j||x.status}return a.demoModeLastResult=x,x},a.updateScenarioState=async()=>{const x=document.getElementById("scenario-select"),j=document.getElementById("scenario-state"),F=document.getElementById("scenario-update-btn");if(!x?.value||!j?.value){NotificationManager.warning("Please select scenario and enter state");return}F&&(F.disabled=!0);try{await a.setScenarioState()}finally{F&&(F.disabled=!1)}},a.updateFileDisplay=()=>{const x=document.getElementById(SELECTORS.IMPORT.FILE),j=document.getElementById(SELECTORS.IMPORT.DISPLAY),F=document.getElementById(SELECTORS.IMPORT.ACTIONS);if(!x||!j){Logger.warn("FEATURES","Import file elements not found.");return}if(x.files?.length>0){const D=x.files[0],re=D.size?` (${Math.round(D.size/1024)} KB)`:"";j.innerHTML=`<strong>${D.name}</strong>${re}`,F&&(F.style.display="block")}else j.innerHTML='<span class="file-placeholder">No file selected</span>',F&&(F.style.display="none")},a.updateRecorderLink=(x,j)=>{try{const F=document.getElementById("recorder-link");if(!F)return;const D=(x||"").trim();if(!D){F.removeAttribute("href"),F.setAttribute("title","Configure host in Settings to enable recorder link"),F.textContent="Recorder UI (configure host first)";return}let re=D;/^https?:\/\//i.test(re)||(re=`http://${re}`);const J=new URL(re);j&&String(j).trim()&&(J.port=String(j).trim()),J.pathname="/__admin/recorder/",F.href=J.toString(),F.textContent=J.toString(),F.removeAttribute("title")}catch(F){Logger.warn("FEATURES","Failed to update recorder link:",F)}};function y(x,j,F){const D=document.getElementById(x);if(!D)return;const re=j==="success"?"\u2705":j==="error"?"\u274C":"\u2139\uFE0F";D.textContent=`${re} ${F}`}function A(x,j,F){const D=new Blob([j],{type:F}),re=URL.createObjectURL(D),J=document.createElement("a");J.href=re,J.download=x,document.body.appendChild(J),J.click(),document.body.removeChild(J),setTimeout(()=>URL.revokeObjectURL(re),0)}function R(){if(a.elementCache?.has(SELECTORS.IMPORT.ACTIONS)){const F=a.elementCache.get(SELECTORS.IMPORT.ACTIONS);if(F){const D=F.querySelector("button");if(D)return D}}const x=document.getElementById(SELECTORS.IMPORT.ACTIONS);if(!x)return null;const j=x.querySelector("button");return j&&a.elementCache&&a.elementCache.set(SELECTORS.IMPORT.ACTIONS,x),j}function H(x){const j=R();j&&(j.classList.toggle("is-loading",x),j.disabled=x)}function X(x=null){if(x)return x;const j=document.getElementById(SELECTORS.IMPORT.MODE);return j&&j.value||"MERGE"}async function _(){const x=document.getElementById(SELECTORS.IMPORT.FILE);if(!x?.files?.length)throw new Error("Please select a file to import.");const j=x.files[0],F=await j.text(),D=j.name.split(".").pop()?.toLowerCase();if(D==="yaml"||D==="yml"){if(a.jsyaml?.load)return a.jsyaml.load(F);throw new Error("YAML parser is not available.")}try{return JSON.parse(F)}catch{throw new Error("Failed to parse JSON import file.")}}function de(x,j){if(!x||typeof x!="object")throw new Error("Import file is empty or malformed.");const F=JSON.parse(JSON.stringify(x)),D={};if(["meta","globalSettings","requestJournal","importSettings"].forEach(se=>{F&&Object.prototype.hasOwnProperty.call(F,se)&&(D[se]=F[se])}),Array.isArray(F))D.mappings=F;else if(Array.isArray(F.mappings))D.mappings=F.mappings;else if(F.mappings&&typeof F.mappings=="object"){if(Array.isArray(F.mappings.mappings))D.mappings=F.mappings.mappings;else if(Array.isArray(F.mappings.items))D.mappings=F.mappings.items;else{const ye=Object.values(F.mappings).filter(Boolean).filter(we=>typeof we=="object"&&(we.request||we.response));ye.length>0&&(D.mappings=ye)}!D.mappings&&(F.mappings.request||F.mappings.response)&&(D.mappings=[F.mappings])}else F.mappings?D.mappings=[F.mappings]:Array.isArray(F.mapping)?D.mappings=F.mapping:F.mapping?D.mappings=[F.mapping]:Array.isArray(F.stubs)?D.mappings=F.stubs:F.stubs&&typeof F.stubs=="object"?D.mappings=Object.values(F.stubs).filter(Boolean):(F.request||F.response)&&(D.mappings=[F]);if(!Array.isArray(D.mappings))throw new Error("No mappings array found in the import file.");if(D.mappings=D.mappings.filter(Boolean),D.mappings.length===0)throw new Error("The import file does not contain any mappings.");Object.keys(F).forEach(se=>{["mappings","mapping","importMode"].includes(se)||Object.prototype.hasOwnProperty.call(D,se)||(D[se]=F[se])});const J=j||F.importMode||"MERGE";return D.importMode=J,D}async function be(x=null){try{H(!0),y(SELECTORS.IMPORT.RESULT,"info","Processing import file...");const j=await _(),F=X(x),D=de(j,F);D.importMode=F,await apiFetch(ENDPOINTS.MAPPINGS_IMPORT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(D)}),NotificationManager.success(`Imported ${D.mappings.length} mapping(s).`);const re=document.getElementById(SELECTORS.IMPORT.FILE);re&&(re.value="",a.updateFileDisplay());try{typeof a.refreshImockCache=="function"&&await a.refreshImockCache(),await fetchAndRenderMappings(null,{useCache:!1})}catch(J){Logger.warn("FEATURES","Failed to refresh mappings after import:",J)}y(SELECTORS.IMPORT.RESULT,"success",`Imported ${D.mappings.length} mapping(s) using mode ${F}.`)}catch(j){throw Logger.error("FEATURES","Import failed:",j),y(SELECTORS.IMPORT.RESULT,"error",j.message||"Import failed."),NotificationManager.error(`Import failed: ${j.message}`),j}finally{H(!1)}}return a.executeImport=be,a.exportMappings=async()=>{const j=document.getElementById(SELECTORS.EXPORT.FORMAT)?.value||"json";y(SELECTORS.EXPORT.RESULT,"info","Preparing mappings export...");try{const D=(await apiFetch(ENDPOINTS.MAPPINGS))?.mappings||[],J=`wiremock-mappings-${new Date().toISOString().replace(/[:.]/g,"-")}`;if(j==="yaml"){if(!a.jsyaml?.dump)throw new Error("YAML serializer is not available.");const se=a.jsyaml.dump({mappings:D},{noRefs:!0});A(`${J}.yaml`,se.endsWith(`
`)?se:`${se}
`,"text/yaml")}else{const se=JSON.stringify({mappings:D},null,2);A(`${J}.json`,`${se}
`,"application/json")}y(SELECTORS.EXPORT.RESULT,"success",`Exported ${D.length} mapping(s) as ${j.toUpperCase()}.`),NotificationManager.success(`Exported ${D.length} mapping(s).`)}catch(F){Logger.error("FEATURES","Export mappings failed:",F),y(SELECTORS.EXPORT.RESULT,"error",F.message||"Failed to export mappings."),NotificationManager.error(`Failed to export mappings: ${F.message}`)}},a.exportRequests=async()=>{const j=document.getElementById(SELECTORS.EXPORT.FORMAT)?.value||"json";y(SELECTORS.EXPORT.RESULT,"info","Preparing request log export...");try{const D=(await apiFetch(ENDPOINTS.REQUESTS))?.requests||[],J=`wiremock-requests-${new Date().toISOString().replace(/[:.]/g,"-")}`;if(j==="yaml"){if(!a.jsyaml?.dump)throw new Error("YAML serializer is not available.");const se=a.jsyaml.dump({requests:D},{noRefs:!0});A(`${J}.yaml`,se.endsWith(`
`)?se:`${se}
`,"text/yaml")}else{const se=JSON.stringify({requests:D},null,2);A(`${J}.json`,`${se}
`,"application/json")}y(SELECTORS.EXPORT.RESULT,"success",`Exported ${D.length} request(s) as ${j.toUpperCase()}.`),NotificationManager.success(`Exported ${D.length} request(s).`)}catch(F){Logger.error("FEATURES","Export requests failed:",F),y(SELECTORS.EXPORT.RESULT,"error",F.message||"Failed to export request log."),NotificationManager.error(`Failed to export request log: ${F.message}`)}},!0}if(!i(e.FeaturesState)){let r=null;const a=s=>{const c=s&&s.detail&&s.detail.state||e.FeaturesState;return i(c)?(typeof e.removeEventListener=="function"&&e.removeEventListener("features:state-ready",a),r!==null&&(e.clearInterval(r),r=null),!0):!1};if(typeof e.addEventListener=="function"&&e.addEventListener("features:state-ready",a),typeof e.setInterval=="function"){let s=0;r=e.setInterval(()=>{s+=1,!a()&&s>=200&&(e.clearInterval(r),r=null,n||Logger.error("FEATURES","features.js could not find FeaturesState after waiting for 10 seconds."))},50)}}})(typeof window<"u"?window:globalThis),Logger.info("UI","\u2705 All required modules loaded successfully"),window.DEFAULT_SETTINGS={host:"localhost",port:"8080",requestTimeout:"69000",customHeaders:{},customHeadersRaw:"",cacheEnabled:!0,autoRefreshEnabled:!1,refreshInterval:"0",autoConnect:!0,cacheRebuildDelay:"1000",cacheValidationDelay:"1500",optimisticCacheAgeLimit:"30000",cacheCountDiffThreshold:"2",backgroundFetchDelay:"200"};const DEFAULT_SETTINGS=window.DEFAULT_SETTINGS;window.customHeaders={...DEFAULT_SETTINGS.customHeaders||{}};let autoConnectInitiated=!1;function getStoredSettings(){const t=Utils.safeCall(window.readWiremockSettings);if(t)return t;try{const e=localStorage.getItem("wiremock-settings");if(!e)return{};const n=JSON.parse(e),i=Utils.safeCall(window.normalizeWiremockSettings,n);return i||(n&&typeof n=="object"?n:{})}catch(e){return Logger.warn("UI","Failed to parse stored settings, falling back to defaults:",e),{}}}function parseCustomHeadersInput(t){const e=(t||"").trim();if(!e)return{headers:{},raw:""};try{const n=JSON.parse(e);if(!n||typeof n!="object"||Array.isArray(n))throw new Error("Custom headers must be a JSON object.");return{headers:n,raw:e}}catch{const i=e.split(/\n+/),r={};let a=!0;for(const s of i){if(!s.trim())continue;const c=s.indexOf(":");if(c===-1){a=!1;break}const l=s.slice(0,c).trim(),d=s.slice(c+1).trim();if(!l){a=!1;break}r[l]=d}if(a&&Object.keys(r).length>0)return{headers:r,raw:e};throw new Error('Custom headers must be valid JSON or "Key: Value" pairs.')}}function serializeCustomHeaders(t){if(!t)return"";if(t.customHeadersRaw)return t.customHeadersRaw;if(t.customHeaders&&typeof t.customHeaders=="object"&&!Array.isArray(t.customHeaders))try{return JSON.stringify(t.customHeaders,null,2)}catch(e){Logger.warn("UI","Failed to serialize custom headers:",e)}return""}function shouldAutoConnect(t){return!!(t&&t.host&&t.port&&t.autoConnect!==!1)}function showOnboardingOverlay(){const t=document.getElementById("onboarding-overlay");if(!t)return;t.classList.remove("hidden"),requestAnimationFrame(()=>{t.classList.add("visible")}),document.body&&document.body.classList.add("onboarding-active");const e=t.querySelector("#onboarding-host");e&&e.focus()}function hideOnboardingOverlay(){const t=document.getElementById("onboarding-overlay");t&&(t.classList.remove("visible"),setTimeout(()=>{t.classList.add("hidden")},220),document.body&&document.body.classList.remove("onboarding-active"))}function attemptAutoConnect(t,e={}){if(Logger.info("UI","\u{1F50C} [attemptAutoConnect] Called with settings:",t),Logger.info("UI","\u{1F50C} [attemptAutoConnect] Options:",e),Logger.info("UI","\u{1F50C} [attemptAutoConnect] shouldAutoConnect:",shouldAutoConnect(t)),Logger.info("UI","\u{1F50C} [attemptAutoConnect] autoConnectInitiated:",autoConnectInitiated),!shouldAutoConnect(t)){Logger.info("UI","\u26A0\uFE0F [attemptAutoConnect] Skipping - shouldAutoConnect returned false");return}if(autoConnectInitiated&&!e.force){Logger.info("UI","\u26A0\uFE0F [attemptAutoConnect] Skipping - already initiated and not forced");return}autoConnectInitiated=!0,Logger.info("UI","\u2705 [attemptAutoConnect] Proceeding with autoconnect");const n=()=>{try{Logger.info("UI","\u{1F50C} [attemptAutoConnect] Triggering connection...");const i=typeof window.connectToWireMock=="function"?window.connectToWireMock():null;i&&typeof i.catch=="function"&&i.catch(r=>{Logger.error("UI","\u274C Auto-connect failed:",r),autoConnectInitiated=!1})}catch(i){Logger.error("UI","\u274C Auto-connect encountered an error:",i),autoConnectInitiated=!1}};e.immediate?(Logger.info("UI","\u{1F50C} [attemptAutoConnect] Immediate mode - connecting now"),n()):(Logger.info("UI","\u{1F50C} [attemptAutoConnect] Delayed mode - connecting in 150ms"),setTimeout(n,150))}function initializeOnboardingFlow(){const t=document.getElementById("onboarding-overlay"),e=document.getElementById("onboarding-form"),n=document.getElementById("onboarding-host"),i=document.getElementById("onboarding-port"),r=document.getElementById("onboarding-headers"),a=document.getElementById("onboarding-auto-connect"),s=getStoredSettings(),c=!!(s.host&&s.port);Logger.info("UI","\u{1F527} [initializeOnboardingFlow] Settings:",s),Logger.info("UI","\u{1F527} [initializeOnboardingFlow] Has configuration:",c),Logger.info("UI","\u{1F527} [initializeOnboardingFlow] autoConnect setting:",s.autoConnect),n&&(n.value=s.host||DEFAULT_SETTINGS.host||""),i&&(i.value=s.port||DEFAULT_SETTINGS.port||""),r&&(r.value=serializeCustomHeaders(s)),a&&(a.checked=s.autoConnect!==!1),c?(Logger.info("UI","\u2705 [initializeOnboardingFlow] Configuration found - attempting autoconnect"),attemptAutoConnect(s)):(Logger.info("UI","\u26A0\uFE0F [initializeOnboardingFlow] No configuration - showing onboarding overlay"),showOnboardingOverlay()),e&&e.addEventListener("submit",l=>{l.preventDefault();const d=n?.value.trim(),m=i?.value.trim();if(!d){typeof NotificationManager<"u"&&NotificationManager.error("Host is required."),n?.focus();return}let w;try{w=parseCustomHeadersInput(r?.value??"")}catch(M){Logger.error("UI","Failed to parse onboarding headers:",M),typeof NotificationManager<"u"&&NotificationManager.error(M.message),r?.focus();return}const E={...DEFAULT_SETTINGS,...getStoredSettings(),host:d,port:m||DEFAULT_SETTINGS.port,customHeaders:w.headers,customHeadersRaw:w.raw,autoConnect:a?a.checked:DEFAULT_SETTINGS.autoConnect};localStorage.setItem("wiremock-settings",JSON.stringify(E)),window.customHeaders={...E.customHeaders||{}},loadSettings(),loadConnectionSettings(),hideOnboardingOverlay(),shouldAutoConnect(E)?attemptAutoConnect(E,{immediate:!0,force:!0}):typeof NotificationManager<"u"&&NotificationManager.info("Connection saved. You can connect from the dashboard when you are ready.")},{once:!1})}window.initializeOnboardingFlow=initializeOnboardingFlow,window.attemptAutoConnect=attemptAutoConnect,window.hideOnboardingOverlay=hideOnboardingOverlay,window.editMapping=t=>{Logger.info("UI","\u{1F527} Opening editor for mapping:",t);const e=getStoredSettings(),n=encodeURIComponent(JSON.stringify(e)),i=`editor/json-editor.html?mappingId=${t}&mode=edit&settings=${n}`,r=window.open(i,`editor_${t}`,"width=1200,height=800,scrollbars=yes,resizable=yes,status=yes");if(!r){NotificationManager.error("Popup blocked. Please allow popups for this site.");return}NotificationManager.info(`Editor opened for mapping ${t}`);const a=window.LifecycleManager.setNamedInterval("editor-close-watch",()=>{r.closed&&(window.LifecycleManager.clearInterval(a),Logger.info("UI","\u{1F504} Editor closed, updating counters only"),Utils.safeCall(window.updateMappingsCounter),Utils.safeCall(window.updateRequestsCounter))},1e3);window.LifecycleManager.setTimeout(()=>{r.closed||(window.LifecycleManager.clearInterval(a),Logger.info("UI","\u{1F504} Editor interval cleaned up after timeout"))},300*1e3)};function computeSwaggerUiUrl(t,e){const n=(t??"").toString().trim(),i=(e??"").toString().trim();if(!n&&!i)return null;try{const r=typeof window.normalizeWiremockBaseUrl=="function"?window.normalizeWiremockBaseUrl(n,i):`http://${n||"localhost"}:${i||"8080"}/__admin`;return r?`${r.replace(/\/?$/,"")}/swagger-ui/`:null}catch(r){return Logger.warn("UI","Failed to compute Swagger UI URL:",r),null}}window.updateSwaggerUILink=(t,e)=>{const n=document.getElementById("swagger-ui-link"),i=document.getElementById("swagger-ui-link-hint");if(!n)return;const r=t??document.getElementById("default-host")?.value??"",a=e??document.getElementById("default-port")?.value??"",s=computeSwaggerUiUrl(r,a);s?(n.href=s,n.textContent=s,n.classList.remove("is-disabled"),n.removeAttribute("aria-disabled"),i&&(i.textContent="Opens the WireMock Admin Swagger UI in a new tab.")):(n.removeAttribute("href"),n.textContent="Define host and port to enable Swagger UI link",n.classList.add("is-disabled"),n.setAttribute("aria-disabled","true"),i&&(i.textContent="We build this link from your saved connection details."))},window.saveSettings=()=>{try{const t=document.getElementById("cache-enabled"),e=document.getElementById("auto-refresh-enabled"),n=document.getElementById("auto-connect-enabled"),i=document.getElementById("custom-headers");let r;try{r=parseCustomHeadersInput(i?.value??"")}catch(l){Logger.error("UI","Failed to parse custom headers:",l),typeof NotificationManager<"u"&&NotificationManager.error(l.message),i?.focus();return}const a={...DEFAULT_SETTINGS,...getStoredSettings(),host:document.getElementById("default-host")?.value||DEFAULT_SETTINGS.host,port:document.getElementById("default-port")?.value||DEFAULT_SETTINGS.port,requestTimeout:document.getElementById("request-timeout")?.value||DEFAULT_SETTINGS.requestTimeout,cacheEnabled:t?.checked??DEFAULT_SETTINGS.cacheEnabled,autoRefreshEnabled:e?.checked??DEFAULT_SETTINGS.autoRefreshEnabled,refreshInterval:document.getElementById("refresh-interval")?.value||DEFAULT_SETTINGS.refreshInterval,cacheRebuildDelay:document.getElementById("cache-rebuild-delay")?.value||DEFAULT_SETTINGS.cacheRebuildDelay,cacheValidationDelay:document.getElementById("cache-validation-delay")?.value||DEFAULT_SETTINGS.cacheValidationDelay,optimisticCacheAgeLimit:document.getElementById("optimistic-cache-age-limit")?.value||DEFAULT_SETTINGS.optimisticCacheAgeLimit,cacheCountDiffThreshold:document.getElementById("cache-count-diff-threshold")?.value||DEFAULT_SETTINGS.cacheCountDiffThreshold,backgroundFetchDelay:document.getElementById("background-fetch-delay")?.value||DEFAULT_SETTINGS.backgroundFetchDelay,autoConnect:n?.checked??DEFAULT_SETTINGS.autoConnect,customHeaders:r.headers,customHeadersRaw:r.raw},s=document.getElementById("wiremock-host"),c=document.getElementById("wiremock-port");s&&(s.value=a.host),c&&(c.value=a.port),localStorage.setItem("wiremock-settings",JSON.stringify(a)),Logger.info("UI","\u{1F527} [main.js] Settings saved to localStorage:",a),Logger.info("UI","\u{1F527} [main.js] Request timeout field value:",document.getElementById("request-timeout")?.value),typeof window.normalizeWiremockBaseUrl=="function"?window.wiremockBaseUrl=window.normalizeWiremockBaseUrl(a.host,a.port):window.wiremockBaseUrl=`http://${a.host}:${a.port}/__admin`,window.customHeaders={...a.customHeaders||{}},broadcastSettingsUpdate(a),NotificationManager.success("Settings saved successfully!"),Logger.info("UI","\u{1F4BE} Settings saved:",a),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(a.host,a.port)}catch(t){Logger.error("UI","Error saving settings:",t),NotificationManager.error("Failed to save settings")}},window.resetSettings=()=>{if(confirm("Reset all settings to defaults?"))try{const t={host:document.getElementById("default-host"),port:document.getElementById("default-port"),timeout:document.getElementById("request-timeout"),cacheEnabled:document.getElementById("cache-enabled"),autoRefresh:document.getElementById("auto-refresh-enabled"),refreshInterval:document.getElementById("refresh-interval"),customHeaders:document.getElementById("custom-headers"),autoConnect:document.getElementById("auto-connect-enabled")};t.host&&(t.host.value=DEFAULT_SETTINGS.host),t.port&&(t.port.value=DEFAULT_SETTINGS.port),t.timeout&&(t.timeout.value=DEFAULT_SETTINGS.requestTimeout),t.cacheEnabled&&(t.cacheEnabled.checked=DEFAULT_SETTINGS.cacheEnabled),t.autoRefresh&&(t.autoRefresh.checked=DEFAULT_SETTINGS.autoRefreshEnabled),t.refreshInterval&&(t.refreshInterval.value=DEFAULT_SETTINGS.refreshInterval),t.customHeaders&&(t.customHeaders.value=DEFAULT_SETTINGS.customHeadersRaw||""),t.autoConnect&&(t.autoConnect.checked=DEFAULT_SETTINGS.autoConnect),localStorage.setItem("wiremock-settings",JSON.stringify(DEFAULT_SETTINGS)),window.wiremockBaseUrl=`http://${DEFAULT_SETTINGS.host}:${DEFAULT_SETTINGS.port}/__admin`,window.customHeaders={...DEFAULT_SETTINGS.customHeaders||{}},broadcastSettingsUpdate(DEFAULT_SETTINGS),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(DEFAULT_SETTINGS.host,DEFAULT_SETTINGS.port),NotificationManager.success("Settings reset to defaults!"),Logger.info("UI","\u{1F504} Settings reset to defaults")}catch(t){Logger.error("UI","Error resetting settings:",t),NotificationManager.error("Failed to reset settings")}},window.loadSettings=()=>{try{const t=getStoredSettings();Logger.info("UI","\u{1F527} [main.js] Loading settings from localStorage:",t);const e={host:document.getElementById("default-host"),port:document.getElementById("default-port"),timeout:document.getElementById("request-timeout"),cacheEnabled:document.getElementById("cache-enabled"),autoRefresh:document.getElementById("auto-refresh-enabled"),refreshInterval:document.getElementById("refresh-interval"),cacheRebuildDelay:document.getElementById("cache-rebuild-delay"),cacheValidationDelay:document.getElementById("cache-validation-delay"),optimisticCacheAgeLimit:document.getElementById("optimistic-cache-age-limit"),cacheCountDiffThreshold:document.getElementById("cache-count-diff-threshold"),backgroundFetchDelay:document.getElementById("background-fetch-delay"),customHeaders:document.getElementById("custom-headers"),autoConnect:document.getElementById("auto-connect-enabled")};if(e.host&&(e.host.value=t.host||DEFAULT_SETTINGS.host),e.port&&(e.port.value=t.port||DEFAULT_SETTINGS.port),e.timeout&&(e.timeout.value=t.requestTimeout||DEFAULT_SETTINGS.requestTimeout),e.cacheEnabled&&(e.cacheEnabled.checked=t.cacheEnabled!==void 0?t.cacheEnabled:DEFAULT_SETTINGS.cacheEnabled),e.autoRefresh&&(e.autoRefresh.checked=t.autoRefreshEnabled!==void 0?t.autoRefreshEnabled:DEFAULT_SETTINGS.autoRefreshEnabled),e.refreshInterval&&(e.refreshInterval.value=t.refreshInterval||DEFAULT_SETTINGS.refreshInterval),e.cacheRebuildDelay&&(e.cacheRebuildDelay.value=t.cacheRebuildDelay||DEFAULT_SETTINGS.cacheRebuildDelay),e.cacheValidationDelay&&(e.cacheValidationDelay.value=t.cacheValidationDelay||DEFAULT_SETTINGS.cacheValidationDelay),e.optimisticCacheAgeLimit&&(e.optimisticCacheAgeLimit.value=t.optimisticCacheAgeLimit||DEFAULT_SETTINGS.optimisticCacheAgeLimit),e.cacheCountDiffThreshold&&(e.cacheCountDiffThreshold.value=t.cacheCountDiffThreshold||DEFAULT_SETTINGS.cacheCountDiffThreshold),e.backgroundFetchDelay&&(e.backgroundFetchDelay.value=t.backgroundFetchDelay||DEFAULT_SETTINGS.backgroundFetchDelay),e.customHeaders&&(e.customHeaders.value=serializeCustomHeaders(t)),e.autoConnect&&(e.autoConnect.checked=t.autoConnect!==!1),window.customHeaders=t.customHeaders&&typeof t.customHeaders=="object"&&!Array.isArray(t.customHeaders)?{...t.customHeaders}:{...DEFAULT_SETTINGS.customHeaders||{}},Logger.info("UI","\u{1F4CB} Settings loaded into settings form"),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(t.host,t.port),typeof window.updateRecorderLink=="function")try{window.updateRecorderLink(t.host,t.port)}catch(n){Logger.warn("UI","Failed to update recorder link:",n)}}catch(t){Logger.error("UI","Error loading settings:",t)}};function broadcastSettingsUpdate(t){try{localStorage.setItem("wiremock-settings-broadcast",JSON.stringify({timestamp:Date.now(),settings:t})),Logger.info("UI","\u{1F4E1} Broadcasting settings update to editor windows")}catch(e){Logger.warn("UI","Failed to broadcast settings update:",e)}}if(window.wiremockBaseUrl||(window.wiremockBaseUrl=`http://${DEFAULT_SETTINGS.host}:${DEFAULT_SETTINGS.port}/__admin`,Logger.info("UI","\u{1F527} [main.js] Initialized default WireMock URL:",window.wiremockBaseUrl)),window.applyDefaultsToForm=()=>{Logger.info("UI","\u{1F527} [applyDefaultsToForm] Setting form defaults from DEFAULT_SETTINGS");const t=document.getElementById("default-host"),e=document.getElementById("default-port"),n=document.getElementById("request-timeout"),i=document.getElementById("cache-enabled"),r=document.getElementById("auto-refresh-enabled"),a=document.getElementById("refresh-interval"),s=document.getElementById("custom-headers"),c=document.getElementById("auto-connect-enabled");t&&!t.value&&(t.value=DEFAULT_SETTINGS.host),e&&!e.value&&(e.value=DEFAULT_SETTINGS.port),n&&!n.value&&(n.value=DEFAULT_SETTINGS.requestTimeout),i&&(i.checked=DEFAULT_SETTINGS.cacheEnabled),r&&(r.checked=DEFAULT_SETTINGS.autoRefreshEnabled),a&&!a.value&&(a.value=DEFAULT_SETTINGS.refreshInterval),s&&!s.value&&(s.value=DEFAULT_SETTINGS.customHeadersRaw||""),c&&(c.checked=DEFAULT_SETTINGS.autoConnect),Logger.info("UI","\u{1F527} [applyDefaultsToForm] Form defaults applied")},document.addEventListener("DOMContentLoaded",async()=>{if(await new Promise(s=>requestAnimationFrame(s)),window.location.pathname.includes("json-editor.html")||window.location.search.includes("mappingId=")||window.location.search.includes("mode=edit")||window.location.search.includes("mode=create")){Logger.info("UI","\u{1F4DD} JSON Editor page detected - skipping main app initialization");return}typeof window.initializeSidebarPreference=="function"&&window.initializeSidebarPreference(),applyDefaultsToForm(),loadSettings(),loadConnectionSettings(),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink();const e=document.getElementById("default-host"),n=document.getElementById("default-port"),i=()=>{typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink()};e?.addEventListener("input",i),n?.addEventListener("input",i),e?.addEventListener("change",i),n?.addEventListener("change",i),Logger.info("UI","\u{1F527} [main.js] Page loaded, defaults applied, settings initialized, ready for user interaction"),typeof window.initializeFilterTabs=="function"&&window.initializeFilterTabs(),typeof window.initMappingPagination=="function"&&window.initMappingPagination(),typeof window.FilterManager?.restoreFilters=="function"&&(window.FilterManager.restoreFilters("mappings"),typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay(),window.FilterManager.restoreFilters("requests"),typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay()),typeof window.loadAllSavedFilters=="function"&&window.loadAllSavedFilters();const r=typeof window.getActiveTabFromURL=="function"?window.getActiveTabFromURL():null;r&&["mappings","requests","scenarios","import-export","recording","settings"].includes(r)&&typeof window.showPage=="function"&&(Logger.info("UI",`\u{1F517} Switching to tab from URL: ${r}`),window.showPage(r,document.querySelector(`[onclick*="showPage('${r}')"]`))),initializeOnboardingFlow()}),window.addEventListener("popstate",()=>{if(Logger.info("UI","\u2B05\uFE0F Browser navigation detected, syncing filters from URL"),typeof window.URLStateManager>"u")return;const t=window.TabManager?.getCurrentTab();t==="mappings"?(window.URLStateManager.syncUIFromURL("mappings"),typeof window.FilterManager<"u"&&window.FilterManager.flushMappingFilters()):t==="requests"&&(window.URLStateManager.syncUIFromURL("requests"),typeof window.FilterManager<"u"&&window.FilterManager.flushRequestFilters())}),window.addEventListener("storage",t=>{if(t.key==="wiremock-settings"&&t.newValue)try{const e=JSON.parse(t.newValue);Logger.info("UI","\u{1F527} [main.js] Settings updated from external source:",e);const n=document.getElementById("wiremock-host"),i=document.getElementById("wiremock-port");n&&e.host&&(n.value=e.host),i&&e.port&&(i.value=e.port),e.host&&e.port&&(typeof window.normalizeWiremockBaseUrl=="function"?window.wiremockBaseUrl=window.normalizeWiremockBaseUrl(e.host,e.port):window.wiremockBaseUrl=`http://${e.host}:${e.port}/__admin`,Logger.info("UI","\u{1F527} [main.js] URL updated from settings change:",window.wiremockBaseUrl)),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(e.host,e.port),e.customHeaders&&typeof e.customHeaders=="object"&&!Array.isArray(e.customHeaders)?window.customHeaders={...e.customHeaders}:window.customHeaders={}}catch(e){Logger.error("UI","\u{1F527} [main.js] Error processing settings update:",e)}}),window.addEventListener("message",t=>{if(t.origin===window.location.origin){if(t.data&&t.data.type==="imock-cache-refresh"&&(Logger.info("UI","\u{1F4E8} [main.js] Received cache refresh request from:",t.data.source),typeof window.refreshImockCache=="function"&&window.refreshImockCache().catch(e=>{Logger.warn("UI","Failed to refresh cache from message:",e)})),t.data&&t.data.type==="imock-optimistic-mapping-update"&&(Logger.info("UI","\u{1F3AF} [main.js] Received optimistic mapping update from:",t.data.source,t.data.mapping.id),typeof window.applyOptimisticMappingUpdate=="function"&&(window.applyOptimisticMappingUpdate(t.data.mapping),typeof window.fetchAndRenderMappings=="function"))){Logger.info("UI","\u{1F3AF} [main.js] Triggering UI refresh after optimistic update");const e=window.MappingsStore.getAll();window.fetchAndRenderMappings(e)}t.data&&t.data.type==="imock-optimistic-cache-update"&&(Logger.info("UI","\u{1F9E9} [main.js] Received optimistic cache update from:",t.data.source,t.data.operation,t.data.mapping?.id),typeof window.updateOptimisticCache=="function"&&window.updateOptimisticCache(t.data.mapping,t.data.operation))}}),window.addEventListener("storage",t=>{if(t.key==="imock-cache-refresh-trigger"&&t.newValue&&(Logger.info("UI","\u{1F4BE} [main.js] Received localStorage cache refresh trigger"),typeof window.refreshImockCache=="function"&&window.refreshImockCache().catch(e=>{Logger.warn("UI","Failed to refresh cache from localStorage trigger:",e)})),t.key==="imock-optimistic-update"&&t.newValue)try{const e=JSON.parse(t.newValue);if(Logger.info("UI","\u{1F3AF} [main.js] Received localStorage optimistic update from:",e.source,"for mapping:",e.mapping?.id),e.mapping&&typeof window.applyOptimisticMappingUpdate=="function"){if(window.applyOptimisticMappingUpdate(e.mapping),typeof window.fetchAndRenderMappings=="function"){Logger.info("UI","\u{1F3AF} [main.js] Triggering UI refresh after localStorage optimistic update");const n=window.MappingsStore.getAll();window.fetchAndRenderMappings(n)}typeof window.updateMappingsCounter=="function"&&window.updateMappingsCounter()}}catch(e){Logger.warn("UI","Failed to process optimistic update from localStorage:",e)}}),typeof BroadcastChannel<"u")try{const t=new BroadcastChannel("imock-cache-refresh"),e=new BroadcastChannel("imock-optimistic-updates");t.addEventListener("message",n=>{n.data&&n.data.type==="cache-refresh"&&(Logger.info("UI","\u{1F4E1} [main.js] Received BroadcastChannel cache refresh from:",n.data.source),typeof window.refreshImockCache=="function"&&window.refreshImockCache().catch(i=>{Logger.warn("UI","Failed to refresh cache from BroadcastChannel:",i)}))}),e.addEventListener("message",n=>{if(n.data&&n.data.type==="optimistic-mapping-update"&&(Logger.info("UI","\u{1F3AF} [main.js] Received BroadcastChannel optimistic update from:",n.data.source,n.data.mapping.id),typeof window.applyOptimisticMappingUpdate=="function"&&(window.applyOptimisticMappingUpdate(n.data.mapping),typeof window.fetchAndRenderMappings=="function"))){Logger.info("UI","\u{1F3AF} [main.js] Triggering UI refresh after BroadcastChannel optimistic update");const i=window.MappingsStore.getAll();window.fetchAndRenderMappings(i)}}),window.addEventListener("beforeunload",()=>{t.close(),e.close()})}catch(t){Logger.warn("UI","BroadcastChannel setup failed:",t)}function loadConnectionSettings(){try{const t=getStoredSettings();Logger.info("UI","\u{1F527} [loadConnectionSettings] Loading settings:",t);const e=document.getElementById("wiremock-host"),n=document.getElementById("wiremock-port");e&&t.host&&(e.value=t.host,Logger.info("UI","\u{1F527} [loadConnectionSettings] Set host input:",t.host)),n&&t.port&&(n.value=t.port,Logger.info("UI","\u{1F527} [loadConnectionSettings] Set port input:",t.port)),Logger.info("UI","\u{1F527} [loadConnectionSettings] Form fields updated, URL will be set by connectToWireMock()")}catch(t){Logger.error("UI","Error loading connection settings:",t),Logger.info("UI","\u{1F527} [loadConnectionSettings] Error loading settings, form fields may remain empty")}}function convertJSONToYAML(t,e=0){const n="  ".repeat(e);if(Array.isArray(t))return t.length===0?`${n}[]`:t.map(i=>{if(isPlainObject(i)||Array.isArray(i)){const r=convertJSONToYAML(i,e+1).split(`
`),a=r.shift()||"";let s=`${n}- ${a.trimStart()}`;return r.length>0&&(s+=`
${r.join(`
`)}`),s}return`${n}- ${formatYAMLScalar(i)}`}).join(`
`);if(isPlainObject(t)){const i=Object.keys(t);return i.length===0?`${n}{}`:i.map(r=>{const a=formatYAMLKey(r),s=t[r];if(isPlainObject(s)||Array.isArray(s)){const c=convertJSONToYAML(s,e+1);return`${n}${a}:
${c}`}return`${n}${a}: ${formatYAMLScalar(s)}`}).join(`
`)}return`${n}${formatYAMLScalar(t)}`}function formatYAMLScalar(t){if(t==null)return"null";if(typeof t=="number"||typeof t=="boolean")return String(t);if(t instanceof Date)return JSON.stringify(t.toISOString());if(typeof t=="string"){if(t==="")return'""';const e=/^[A-Za-z0-9_\-]+$/,n=/^(?:true|false|null|yes|no|on|off|~)$/i;return e.test(t)&&!n.test(t)||!/[\n\r]/.test(t)&&!/^\s|\s$/.test(t)&&!/[#:>{}\[\],&*?]|!/.test(t)?t:JSON.stringify(t)}return JSON.stringify(t)}function formatYAMLKey(t){return typeof t=="string"&&/^[A-Za-z0-9_\-]+$/.test(t)?t:JSON.stringify(t)}function isPlainObject(t){return Object.prototype.toString.call(t)==="[object Object]"}function convertPathArrayToJSONPath(t){if(!Array.isArray(t)||t.length===0)return"$";let e="$";for(let n=1;n<t.length;n++){const i=t[n];if(typeof i=="number")e+=`[${i}]`;else if(typeof i=="string")if(isSimpleJsonPathSegment(i))e+=`.${i}`;else{const r=i.replace(/'/g,"\\'");e+=`['${r}']`}else i!=null&&(e+=`[${String(i)}]`)}return e}function convertPathArrayToPointer(t){if(!Array.isArray(t)||t.length===0)return"$";let e="$";for(let n=1;n<t.length;n++){const i=t[n];e=appendPointerSegment(e,i)}return e}function appendPointerSegment(t,e){return typeof e=="number"?`${t}/${e}`:`${t}/${escapeJsonPointerSegment(e)}`}function escapeJsonPointerSegment(t){return String(t).replace(/~/g,"~0").replace(/\//g,"~1")}function isSimpleJsonPathSegment(t){return/^[A-Za-z_][A-Za-z0-9_]*$/.test(t)}function buildJSONPointerLocator(t){if(typeof t!="string"||t.length===0)return null;try{const e=new Map,n=t.length,i=[0];for(let v=0;v<n;v++)t[v]===`
`&&i.push(v+1);let r=0;const a=v=>{v<0&&(v=0),v>n&&(v=n);let h=0,y=i.length-1;for(;h<=y;){const H=Math.floor((h+y)/2),X=i[H],_=H+1<i.length?i[H+1]:n+1;if(v<X)y=H-1;else if(v>=_)h=H+1;else return{lineNumber:H+1,column:v-X+1}}const A=i.length-1,R=i[A]||0;return{lineNumber:A+1,column:v-R+1}},s=()=>{for(;r<n;){const v=t[r];if(v===" "||v==="	"||v===`
`||v==="\r")r++;else break}},c=(v,h,y)=>{v&&h<=y&&e.set(v,{start:h,end:y})},l=v=>{if(s(),r>=n)throw new Error("Unexpected end of JSON input");const h=t[r];if(h==="{"){d(v);return}if(h==="["){m(v);return}if(h==='"'){const{start:y,end:A}=w();c(v,y,A);return}if(h==="-"||C(h)){const{start:y,end:A}=E();c(v,y,A);return}if(t.startsWith("true",r)){const{start:y,end:A}=M("true");c(v,y,A);return}if(t.startsWith("false",r)){const{start:y,end:A}=M("false");c(v,y,A);return}if(t.startsWith("null",r)){const{start:y,end:A}=M("null");c(v,y,A);return}throw new Error(`Unexpected token ${h} at position ${r}`)},d=v=>{const h=r;if(r++,s(),r<n&&t[r]==="}"){r++,c(v,h,r);return}for(;r<n;){if(t[r]!=='"')throw new Error("Expected string for object key");const{value:y}=w();if(s(),t[r]!==":")throw new Error("Expected colon after object key");r++;const A=appendPointerSegment(v,y);l(A),s();const R=t[r];if(R===","){r++,s();continue}if(R==="}"){r++,c(v,h,r);return}throw new Error("Expected comma or closing brace in object")}throw new Error("Unterminated object literal")},m=v=>{const h=r;if(r++,s(),r<n&&t[r]==="]"){r++,c(v,h,r);return}let y=0;for(;r<n;){const A=appendPointerSegment(v,y);l(A),y++,s();const R=t[r];if(R===","){r++,s();continue}if(R==="]"){r++,c(v,h,r);return}throw new Error("Expected comma or closing bracket in array")}throw new Error("Unterminated array literal")},w=()=>{const v=r;r++;let h="";for(;r<n;){const y=t[r];if(y==='"')return r++,{value:h,start:v,end:r};if(y==="\\"){if(r++,r>=n)throw new Error("Unterminated string literal");const A=t[r];switch(A){case'"':case"\\":case"/":h+=A;break;case"b":h+="\b";break;case"f":h+="\f";break;case"n":h+=`
`;break;case"r":h+="\r";break;case"t":h+="	";break;case"u":const R=t.slice(r+1,r+5);if(!/^[0-9a-fA-F]{4}$/.test(R))throw new Error("Invalid Unicode escape sequence");h+=String.fromCharCode(parseInt(R,16)),r+=4;break;default:h+=A;break}}else h+=y;r++}throw new Error("Unterminated string literal")},E=()=>{const v=r;if(t[r]==="-"&&r++,t[r]==="0")r++;else{if(!C(t[r]))throw new Error("Invalid number literal");for(;r<n&&C(t[r]);)r++}if(t[r]==="."){if(r++,!C(t[r]))throw new Error("Invalid number literal");for(;r<n&&C(t[r]);)r++}if(t[r]==="e"||t[r]==="E"){if(r++,(t[r]==="+"||t[r]==="-")&&r++,!C(t[r]))throw new Error("Invalid number literal");for(;r<n&&C(t[r]);)r++}return{start:v,end:r}},M=v=>{const h=r;if(t.slice(r,r+v.length)!==v)throw new Error(`Expected literal ${v}`);return r+=v.length,{start:h,end:r}},C=v=>v>="0"&&v<="9";return l("$"),s(),{getRange(v){if(!e.has(v))return null;const h=e.get(v),y=a(h.start),A=a(h.end);return{startLineNumber:y.lineNumber,startColumn:y.column,endLineNumber:A.lineNumber,endColumn:A.column}}}}catch(e){return console.warn("Failed to build JSON pointer locator:",e),null}}const TEMPLATE_CATEGORY_LABELS={basic:"Basic",advanced:"Advanced",testing:"Testing",integration:"Integration",proxy:"Proxy"};function getTemplateLibrarySnapshot(){return window.MonacoTemplateLibrary&&typeof window.MonacoTemplateLibrary.getAll=="function"?window.MonacoTemplateLibrary.getAll():[]}function formatRelativeTime(t){if(!t)return"\u2014";const e=Date.now(),n=t-e,i=Math.abs(n),r=[{limit:60*1e3,divisor:1e3,unit:"second"},{limit:3600*1e3,divisor:60*1e3,unit:"minute"},{limit:1440*60*1e3,divisor:3600*1e3,unit:"hour"},{limit:10080*60*1e3,divisor:1440*60*1e3,unit:"day"},{limit:720*60*60*1e3,divisor:10080*60*1e3,unit:"week"},{limit:1/0,divisor:720*60*60*1e3,unit:"month"}],a=typeof Intl<"u"&&Intl.RelativeTimeFormat?new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}):null;for(const{limit:s,divisor:c,unit:l}of r)if(i<s){const d=Math.round(n/c);if(a)return a.format(d,l);const m=d<0?"ago":"from now";return`${Math.abs(d)} ${l}${Math.abs(d)!==1?"s":""} ${m}`}return new Date(t).toLocaleString()}function formatBytes(t){if(!Number.isFinite(t)||t<=0)return"0 B";const e=[{limit:1024,suffix:"B",divisor:1},{limit:1024*1024,suffix:"KB",divisor:1024},{limit:1024*1024*1024,suffix:"MB",divisor:1024*1024}];for(const{limit:i,suffix:r,divisor:a}of e)if(t<i){const s=t/a;return r==="B"?`${Math.round(s)} ${r}`:`${s>=100?Math.round(s):s.toFixed(1)} ${r}`}return`${(t/(1024*1024*1024)).toFixed(2)} GB`}const HISTORY_DB_NAME="imock-history-ak",HISTORY_DB_VERSION=1,HISTORY_FRAMES_STORE="frames",HISTORY_SHA_STORE="shaIndex",HISTORY_LOCK_KEY="imock-history-lock",HISTORY_LOCK_TTL=3e3,DEBOUNCE_MS=1e4,MIN_DELTA_LEN=200,DEFAULT_HISTORY_BUDGET=50*1024*1024,IOS_HISTORY_BUDGET=30*1024*1024,LARGE_DIGEST_THRESHOLD=1e6,HEADER_PARENT_KEYS=new Set(["headers"]),IGNORED_KEYS=new Set(["id","uuid","updatedAt","insertionIndex"]);function isInsideJsonBody(t){return!t||!Array.isArray(t.path)?!1:t.path.includes("jsonBody")}function detectHistoryBudget(){if(typeof navigator>"u")return DEFAULT_HISTORY_BUDGET;const t=navigator.userAgent||"";return/iphone|ipad|ipod/i.test(t)?IOS_HISTORY_BUDGET:DEFAULT_HISTORY_BUDGET}function promisifyRequest(t){return new Promise((e,n)=>{t.onsuccess=()=>e(t.result),t.onerror=()=>n(t.error)})}function waitForTransaction(t){return new Promise((e,n)=>{t.oncomplete=()=>e(),t.onabort=()=>n(t.error||new Error("Transaction aborted")),t.onerror=()=>n(t.error||new Error("Transaction error"))})}function openHistoryDatabase(){if(typeof indexedDB>"u")throw new Error("IndexedDB is not available");return new Promise((t,e)=>{const n=indexedDB.open(HISTORY_DB_NAME,HISTORY_DB_VERSION);n.onupgradeneeded=()=>{const i=n.result;if(!i.objectStoreNames.contains(HISTORY_FRAMES_STORE)){const r=i.createObjectStore(HISTORY_FRAMES_STORE,{keyPath:"seq",autoIncrement:!0});r.createIndex("id","id",{unique:!0}),r.createIndex("ts","ts")}i.objectStoreNames.contains(HISTORY_SHA_STORE)||i.createObjectStore(HISTORY_SHA_STORE,{keyPath:"sha256"})},n.onsuccess=()=>{const i=n.result;i.onversionchange=()=>{i.close()},t(i)},n.onerror=()=>e(n.error)})}function mappingSortKey(t){if(!t||typeof t!="object")return"";if(t.name)return String(t.name).toLowerCase();const e=t.request||{},n=e.method?String(e.method):"",i=e.url||e.urlPath||e.urlPattern||e.urlPathPattern||"";return[n,i].filter(Boolean).join(" ").toLowerCase()}function normalizeLineEndings(t){return typeof t=="string"?t.replace(/\r\n/g,`
`):t}function canonicalizeValue(t,e={path:[]}){if(Array.isArray(t)){const n=e.path[e.path.length-1],i=t.map(r=>canonicalizeValue(r,{path:[...e.path,null]}));return n==="mappings"?i.map(r=>({key:mappingSortKey(r),item:r})).sort((r,a)=>r.key.localeCompare(a.key)).map(({item:r})=>r):i}if(t&&typeof t=="object"){const n=[],i=isInsideJsonBody(e);for(const[s,c]of Object.entries(t)){if(IGNORED_KEYS.has(s)&&!i)continue;const l=e.path[e.path.length-1],m=l&&HEADER_PARENT_KEYS.has(l)&&!i?s.toLowerCase():s,w={path:[...e.path,m]},E=canonicalizeValue(c,w);n.push([m,E])}const r={},a=i?n:n.sort((s,c)=>s[0].localeCompare(c[0]));for(const[s,c]of a)r[s]=c;return r}return typeof t=="string"?normalizeLineEndings(t):t}function stableStringifyWireMock(t){if(typeof t=="string"){if(!t.trim())return"";try{const n=JSON.parse(normalizeLineEndings(t)),i=canonicalizeValue(n,{path:[]});return JSON.stringify(i,null,2)}catch{return normalizeLineEndings(t)}}if(t&&typeof t=="object"){const e=canonicalizeValue(t,{path:[]});return JSON.stringify(e,null,2)}return typeof t>"u"?"":String(t)}function crc32(t){let e=-1;for(let n=0;n<t.length;n+=1){e^=t[n];for(let i=0;i<8;i+=1){const r=-(e&1);e=e>>>1^3988292384&r}}return(e^-1)>>>0}let digestWorker=null;async function digestInWorker(t){if(typeof Worker>"u")return null;if(!digestWorker){const n=`self.onmessage = async (event) => {
    try {
        const buffer = event.data;
        const digest = await crypto.subtle.digest('SHA-256', buffer);
        self.postMessage(digest, [digest]);
    } catch (error) {
        self.postMessage({ error: error.message });
    }
};`,i=new Blob([n],{type:"application/javascript"});digestWorker=new Worker(URL.createObjectURL(i))}const e=t.buffer.slice(0);return new Promise((n,i)=>{const r=s=>{digestWorker.removeEventListener("message",r),digestWorker.removeEventListener("error",a);const{data:c}=s;c&&c.error?i(new Error(c.error)):n(c)},a=s=>{digestWorker.removeEventListener("message",r),digestWorker.removeEventListener("error",a),i(s)};digestWorker.addEventListener("message",r),digestWorker.addEventListener("error",a),digestWorker.postMessage(e,[e])})}async function sha256Hex(t){if(typeof crypto<"u"&&crypto.subtle)try{if(t.byteLength>LARGE_DIGEST_THRESHOLD){const r=await digestInWorker(t);if(r instanceof ArrayBuffer)return{algorithm:"sha256",hash:Array.from(new Uint8Array(r)).map(s=>s.toString(16).padStart(2,"0")).join("")}}const n=await crypto.subtle.digest("SHA-256",t);return{algorithm:"sha256",hash:Array.from(new Uint8Array(n)).map(r=>r.toString(16).padStart(2,"0")).join("")}}catch(n){console.warn("[HISTORY] Failed to compute SHA-256, falling back to CRC32",n)}return{algorithm:"crc32",hash:crc32(t).toString(16).padStart(8,"0")}}function delay(t){return new Promise(e=>setTimeout(e,t))}class EditorHistory{constructor(e=50){this.limit=Math.max(5,e),this.dbPromise=openHistoryDatabase(),this.cache=new Map,this.cacheLimit=5,this.currentId=null,this.lastEntry=null,this.budgetBytes=detectHistoryBudget(),this.stats={count:0,byteSize:0,latestTimestamp:null,latestLabel:null},this.ready=this.initialiseState()}async initialiseState(){try{const e=await this.dbPromise,n=await this.readAllFrames(e);if(n.length){const s=n[n.length-1];this.currentId=s.id,this.lastEntry={seq:s.seq,length:s.json.length,timestamp:s.ts,manual:!!s.manual}}let i=0,r=null,a=null;for(const s of n)i+=s.byteSize||0,(!r||s.ts>=r)&&(r=s.ts,a=s.label);this.stats={count:n.length,byteSize:i,latestTimestamp:r,latestLabel:a},this.scheduleCleanup()}catch(e){console.warn("[HISTORY] Failed to initialise history",e)}}async reset(e="",n={}){await this.ready;const i=typeof e=="string"?e:"";await this.withLock(async()=>{const a=(await this.dbPromise).transaction([HISTORY_FRAMES_STORE,HISTORY_SHA_STORE],"readwrite");a.objectStore(HISTORY_FRAMES_STORE).clear(),a.objectStore(HISTORY_SHA_STORE).clear(),await waitForTransaction(a),this.cache.clear(),this.currentId=null,this.lastEntry=null,this.stats={count:0,byteSize:0,latestTimestamp:null,latestLabel:null}}),(i.length>0||n.forceInitial)&&await this.record(i,{...n,reason:n.reason||"Initial snapshot",label:n.label||"Initial document",force:!0})}async readAllFrames(e){return new Promise((n,i)=>{const a=e.transaction(HISTORY_FRAMES_STORE,"readonly").objectStore(HISTORY_FRAMES_STORE),s=[],c=a.openCursor();c.onsuccess=l=>{const d=l.target.result;d?(s.push(d.value),d.continue()):n(s)},c.onerror=()=>i(c.error)})}updateCache(e,n){if(e)for(this.cache.has(e)&&this.cache.delete(e),this.cache.set(e,n);this.cache.size>this.cacheLimit;){const i=this.cache.keys().next().value;this.cache.delete(i)}}async withLock(e){if(typeof localStorage>"u")return e();const n=Date.now()+HISTORY_LOCK_TTL;let i=!1;for(let r=0;r<10;r+=1){const a=localStorage.getItem(HISTORY_LOCK_KEY);if(!a||Number(a)<Date.now())try{localStorage.setItem(HISTORY_LOCK_KEY,String(n)),i=!0;break}catch(s){console.warn("[HISTORY] Failed to acquire lock",s)}await delay(100)}if(!i)return e();try{return await e()}finally{localStorage.getItem(HISTORY_LOCK_KEY)===String(n)&&localStorage.removeItem(HISTORY_LOCK_KEY)}}cleanMeta(e){if(!e||typeof e!="object")return{};const n={...e};return delete n.force,delete n.contentOverride,delete n.editor,delete n.labelGenerated,n}deriveLabel(e,n={}){const i=n&&n.action?n.action:"Snapshot",r=typeof e=="string"?e.trim():"";if(!r)return i;try{const s=JSON.parse(r);if(s&&typeof s=="object"){if(s.name)return s.name;const c=s.request||{},l=c.method||"",d=c.url||c.urlPath||c.urlPattern||c.urlPathPattern||"",m=[];if(l&&m.push(l),d&&m.push(d),m.length)return m.join(" \xB7 ")}}catch{}const a=r.split(`
`)[0];return a.length>60?`${a.slice(0,57)}\u2026`:a||i}buildPreview(e){if(typeof e!="string"||e.trim().length===0)return"(empty document)";try{const n=JSON.parse(e),i=JSON.stringify(n,null,2);return this.truncatePreview(i)}catch{const i=e.split(`
`).slice(0,12).join(`
`);return this.truncatePreview(i)}}truncatePreview(e){return e.length<=480?e:`${e.slice(0,479)}\u2026`}async record(e,n={}){await this.ready;const i=typeof e=="string"?e:"",r=Date.now(),a=!!n.manual,s=this.cleanMeta(n),c=stableStringifyWireMock(i),l=typeof TextEncoder<"u"?new TextEncoder:null,d=l?l.encode(c):new Uint8Array(Array.from(c,M=>M.charCodeAt(0)&255)),{hash:m,algorithm:w}=await sha256Hex(d),E=this.lastEntry;if(!a&&E&&!n.force){const M=Math.abs(c.length-E.length),C=r-E.timestamp;if(M<MIN_DELTA_LEN&&C<DEBOUNCE_MS)return{recorded:!1,reason:"debounced",entry:null}}return this.withLock(async()=>{const M=await this.dbPromise,C=M.transaction([HISTORY_FRAMES_STORE,HISTORY_SHA_STORE],"readwrite"),v=C.objectStore(HISTORY_FRAMES_STORE),h=C.objectStore(HISTORY_SHA_STORE),y=await promisifyRequest(h.get(m));if(y!=null){const X=typeof y=="object"&&y.lastSeq?y.lastSeq:y,_=X!=null?await promisifyRequest(v.get(X)):null;if(_&&_.json===c)return _.occurrences=(_.occurrences||1)+1,_.lastAt=r,a&&!_.manual&&(_.manual=!0),_.meta={..._.meta||{},...s,manual:a||_.meta?.manual||_.manual,occurrences:_.occurrences,lastRecordedAt:new Date(r).toISOString(),hashAlgorithm:w},await promisifyRequest(v.put(_)),await waitForTransaction(C),this.stats.latestTimestamp=r,this.stats.latestLabel=_.label,this.currentId=_.id,this.lastEntry={seq:_.seq,length:c.length,timestamp:r,manual:_.manual},this.updateCache(_.seq,c),{recorded:!1,reason:"duplicate",entry:this.normalizeEntry(_)}}const A=s.label||this.deriveLabel(c,s),R={id:typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`hist-${r}-${Math.random().toString(36).slice(2,8)}`,ts:r,kind:"full",sha256:m,shaAlgorithm:w,byteSize:d.byteLength,label:A,occurrences:1,json:c,manual:a,meta:{...s,label:A,reason:s.reason||s.action||"Edit",occurrences:1,firstRecordedAt:new Date(r).toISOString(),lastRecordedAt:new Date(r).toISOString(),hashAlgorithm:w}},H=await promisifyRequest(v.add(R));return R.seq=H,await promisifyRequest(h.put({sha256:m,lastSeq:H})),await waitForTransaction(C),this.updateCache(H,c),this.currentId=R.id,this.lastEntry={seq:H,length:c.length,timestamp:r,manual:a},this.stats.count+=1,this.stats.byteSize+=R.byteSize,this.stats.latestTimestamp=r,this.stats.latestLabel=A,await this.enforceBudget({withinLock:!0,db:M}),{recorded:!0,entry:this.normalizeEntry(R)}})}normalizeEntry(e){const n=typeof e.json=="string"?e.json:"";return{id:e.id,seq:e.seq,timestamp:e.ts,content:n,label:e.label,preview:this.buildPreview(n),byteSize:e.byteSize,sizeLabel:formatBytes(e.byteSize||0),meta:{...e.meta||{},occurrences:e.occurrences||1,recordedAt:new Date(e.ts).toISOString()}}}async getEntries(e={}){await this.ready;const n=e.newestFirst===!0,i=await this.dbPromise,a=(await this.readAllFrames(i)).map(s=>this.normalizeEntry(s));return a.sort((s,c)=>n?c.timestamp-s.timestamp:s.timestamp-c.timestamp),e.limit?a.slice(0,e.limit):a}async getStats(){return await this.ready,{...this.stats}}getCurrentId(){return this.currentId}async getEntryById(e){await this.ready;const n=await this.dbPromise;return new Promise((i,r)=>{const l=n.transaction(HISTORY_FRAMES_STORE,"readonly").objectStore(HISTORY_FRAMES_STORE).index("id").get(e);l.onsuccess=()=>{i(l.result?this.normalizeEntry(l.result):null)},l.onerror=()=>r(l.error)})}markCurrent(e){this.currentId=e}async clear(e={}){await this.ready;const n=e.keepLatest!==!1,i=e.latestContent||"",r=e.label||"Current document";let a=null;n&&(a=(await this.getEntries({newestFirst:!0,limit:1}))[0]||null),await this.withLock(async()=>{const c=(await this.dbPromise).transaction([HISTORY_FRAMES_STORE,HISTORY_SHA_STORE],"readwrite");c.objectStore(HISTORY_FRAMES_STORE).clear(),c.objectStore(HISTORY_SHA_STORE).clear(),await waitForTransaction(c)}),this.cache.clear(),this.currentId=null,this.lastEntry=null,this.stats={count:0,byteSize:0,latestTimestamp:null,latestLabel:null},a?await this.record(a.content,{...a.meta,label:a.label,reason:"Preserved latest snapshot",manual:!!a.meta?.manual,force:!0}):n&&i&&await this.record(i,{label:r,reason:"Current document",force:!0})}async enforceBudget(e={}){if(await this.ready,this.stats.byteSize<=this.budgetBytes)return;const n=async i=>{const r=await this.readAllFrames(i);if(!r.length)return;const a=r[r.length-1].seq,s=new Set(r.filter(C=>C.manual).map(C=>C.seq)),c=new Set([a]),l=new Map,d=Date.now();for(const C of r){if(s.has(C.seq)){c.add(C.seq);continue}const v=d-C.ts;let h;v<=3600*1e3?h=60*1e3:v<=1440*60*1e3?h=600*1e3:v<=10080*60*1e3?h=3600*1e3:h=1440*60*1e3;const y=`${h}:${Math.floor(C.ts/h)}`,A=l.get(y);(!A||A.ts<C.ts)&&l.set(y,{seq:C.seq,ts:C.ts})}for(const C of l.values())c.add(C.seq);const m=r.filter(C=>!c.has(C.seq)&&!s.has(C.seq)).sort((C,v)=>C.ts-v.ts);if(!m.length)return;const w=i.transaction([HISTORY_FRAMES_STORE,HISTORY_SHA_STORE],"readwrite"),E=w.objectStore(HISTORY_FRAMES_STORE),M=w.objectStore(HISTORY_SHA_STORE);for(const C of m){await promisifyRequest(E.delete(C.seq)),this.stats.byteSize-=C.byteSize||0,this.stats.count-=1;const v=await promisifyRequest(M.get(C.sha256));if(v&&(v.lastSeq===C.seq||v===C.seq)){const h=r.filter(y=>y.sha256===C.sha256&&y.seq!==C.seq).sort((y,A)=>A.seq-y.seq)[0];h?await promisifyRequest(M.put({sha256:C.sha256,lastSeq:h.seq})):await promisifyRequest(M.delete(C.sha256))}if(this.stats.byteSize<=this.budgetBytes)break}if(await waitForTransaction(w),this.stats.byteSize<=0||this.stats.count<=0)this.stats={count:0,byteSize:0,latestTimestamp:null,latestLabel:null},this.currentId=null,this.lastEntry=null;else{const C=await this.readAllFrames(i);if(C.length){this.stats.count=C.length,this.stats.byteSize=C.reduce((h,y)=>h+(y.byteSize||0),0);const v=C[C.length-1];this.currentId=v.id,this.lastEntry={seq:v.seq,length:v.json.length,timestamp:v.ts,manual:!!v.manual},this.stats.latestTimestamp=v.ts,this.stats.latestLabel=v.label}else this.stats={count:0,byteSize:0,latestTimestamp:null,latestLabel:null},this.currentId=null,this.lastEntry=null}};if(e.withinLock&&e.db){await n(e.db);return}await this.withLock(async()=>{const i=await this.dbPromise;await n(i)})}async cleanup(e={}){const n=e.maxAgeMs||2592e6,i=e.maxEntries||50;await this.ready,await this.withLock(async()=>{const r=await this.dbPromise,a=r.transaction(HISTORY_FRAMES_STORE,"readwrite"),c=a.objectStore(HISTORY_FRAMES_STORE).index("ts"),l=Date.now()-n,d=IDBKeyRange.upperBound(l);let m=0;const w=c.openCursor(d);await new Promise((A,R)=>{w.onsuccess=H=>{const X=H.target.result;X?(X.delete(),m++,X.continue()):A()},w.onerror=()=>R(w.error)}),await waitForTransaction(a);const E=r.transaction(HISTORY_FRAMES_STORE,"readwrite"),M=E.objectStore(HISTORY_FRAMES_STORE),C=M.count(),v=await promisifyRequest(C);let h=0;if(v>i){const A=v-i,R=M.openCursor();await new Promise((H,X)=>{let _=0;R.onsuccess=de=>{const be=de.target.result;be&&_<A?(be.delete(),_++,h++,be.continue()):H()},R.onerror=()=>X(R.error)})}if(await waitForTransaction(E),m+h>0){console.log(`\u2705 [HISTORY] Cleanup completed: deleted ${m} old entries (>${Math.round(n/864e5)}d) + ${h} excess entries`);const A=await this.readAllFrames(r);if(this.stats.count=A.length,this.stats.byteSize=A.reduce((R,H)=>R+(H.byteSize||0),0),A.length>0){const R=A[A.length-1];this.stats.latestTimestamp=R.ts,this.stats.latestLabel=R.label}else this.stats.latestTimestamp=null,this.stats.latestLabel=null,this.currentId=null,this.lastEntry=null;console.log(`\u{1F4CA} [HISTORY] Stats after cleanup: ${this.stats.count} entries, ${(this.stats.byteSize/1024/1024).toFixed(2)} MB`)}})}scheduleCleanup(e=1440*60*1e3,n={}){const i=async()=>{try{await this.cleanup(n)}catch(a){console.error("[HISTORY] Cleanup failed:",a)}};setTimeout(i,1e4);const r=setInterval(i,e);return console.log(`\u2705 [HISTORY] Cleanup scheduled: every ${Math.round(e/36e5)}h, max age ${Math.round((n.maxAgeMs||720*60*60*1e3)/864e5)}d, max ${n.maxEntries||50} entries`),r}}function resolveTemplatePath(t,e){return!t||!e?void 0:(Array.isArray(e)?e:String(e).replace(/\[(\d+)\]/g,".$1").split(".")).reduce((i,r)=>{if(i!=null){if(Array.isArray(i)){const a=Number(r);return Number.isInteger(a)?i[a]:void 0}return i[r]}},t)}function formatFeatureValue(t){if(t==null)return"";if(typeof t=="string")return t.length>80?`${t.slice(0,77)}\u2026`:t;if(typeof t=="number"||typeof t=="boolean")return String(t);try{const e=JSON.stringify(t);return e.length>80?`${e.slice(0,77)}\u2026`:e}catch(e){return console.warn("Failed to serialise feature value",e),""}}function getTemplateFeature(t){if(!t||!t.feature)return null;const e=t.feature.path||t.feature,n=t.feature.label||(Array.isArray(e)?e.join("."):String(e)),i=resolveTemplatePath(t.content,e);return typeof i>"u"?null:{label:n,value:formatFeatureValue(i)}}function getTemplateHeadline(t){if(!t)return"";if(t.highlight)return t.highlight;const e=[];return t.content?.request?.method&&e.push(t.content.request.method),(t.content?.request?.url||t.content?.request?.urlPath)&&e.push(t.content.request.url||t.content.request.urlPath),e.join(" \xB7 ")}function buildTemplatePreview(t){try{const e=t&&t.content?t.content:{};if(typeof e=="string")return e;const r=JSON.stringify(e,null,2).split(`
`).slice(0,8).join(`
`);return r.length>320?`${r.slice(0,319)}\u2026`:r}catch{return"[unavailable template preview]"}}function copyTextToClipboard(t){if(typeof t!="string"&&(t=String(t??"")),typeof navigator<"u"&&navigator.clipboard&&typeof navigator.clipboard.writeText=="function")return navigator.clipboard.writeText(t).then(()=>!0).catch(()=>e(t));return Promise.resolve(e(t));function e(n){try{const i=document.createElement("textarea");return i.value=n,i.setAttribute("readonly",""),i.style.position="absolute",i.style.left="-9999px",document.body.appendChild(i),i.select(),document.execCommand("copy"),document.body.removeChild(i),!0}catch(i){return console.warn("Clipboard fallback failed:",i),!1}}}const HISTORY_SUMMARY_MAX_CHANGES=8,HISTORY_SUMMARY_MODAL_CHANGES=20,HISTORY_SUMMARY_MAX_DEPTH=4,HISTORY_SUMMARY_BRANCH_LIMIT=20;function safeParseSnapshot(t){if(typeof t!="string")return null;try{return JSON.parse(t)}catch{return null}}function formatHistoryLeafValue(t){if(t===void 0)return"\u2014";if(t===null)return"null";if(typeof t=="string")return`"${t.length>80?`${t.slice(0,77)}\u2026`:t}"`;if(typeof t=="number"||typeof t=="boolean")return String(t);if(Array.isArray(t))return t.length===0?"[]":t.every(n=>n==null||["string","number","boolean"].includes(typeof n))&&t.length<=5?`[${t.map(n=>formatHistoryLeafValue(n)).join(", ")}]`:`[${t.length} items]`;if(typeof t=="object"){const e=Object.keys(t||{});return e.length?`{${e.slice(0,5).join(", ")}${e.length>5?", \u2026":""}}`:"{}"}return String(t)}function flattenSnapshotForSummary(t,e,n="",i=0){if(i>=HISTORY_SUMMARY_MAX_DEPTH||t==null||typeof t!="object"){e.set(n||"(root)",formatHistoryLeafValue(t));return}if(Array.isArray(t)){if(t.length===0){e.set(n||"(root)","[]");return}const s=Math.min(t.length,HISTORY_SUMMARY_BRANCH_LIMIT);for(let c=0;c<s;c+=1){const l=n?`${n}[${c}]`:`[${c}]`;flattenSnapshotForSummary(t[c],e,l,i+1)}return}const r=Object.keys(t);if(!r.length){e.set(n||"(root)","{}");return}const a=r.sort((s,c)=>s.localeCompare(c)).slice(0,HISTORY_SUMMARY_BRANCH_LIMIT);for(const s of a){const c=n?`${n}.${s}`:s;flattenSnapshotForSummary(t[s],e,c,i+1)}}function summarizeHistoryChanges(t,e,n={}){const i=typeof n.limit=="number"?n.limit:HISTORY_SUMMARY_MAX_CHANGES,r=safeParseSnapshot(t),a=safeParseSnapshot(e);if(!r){const E=typeof t=="string"?t.length:0;if(a)return`Snapshot replaced with non-JSON content (${E} chars)`;const M=typeof e=="string"?e.length:0;return e==null?`Snapshot captured (non-JSON, ${E} chars)`:typeof e=="string"&&e===t?"No textual changes detected":`Content changed (${M} \u2192 ${E} chars)`}const s=new Map;flattenSnapshotForSummary(r,s);const c=new Map;a&&flattenSnapshotForSummary(a,c);const l=new Set([...s.keys(),...c.keys()]),d=Array.from(l).sort((E,M)=>E.localeCompare(M)),m=[];let w=0;for(const E of d){const M=c.has(E)?c.get(E):void 0,C=s.has(E)?s.get(E):void 0;if(M===C)continue;const v=E||"(root)";let h;typeof M>"u"?h=`${v}: ++ ${C}`:typeof C>"u"?h=`${v}: -- ${M}`:h=`${v}: ${M} \u2192 ${C}`,m.length<i?m.push(h):w+=1}return m.length?(w>0&&m.push(`\u2026and ${w} more change${w===1?"":"s"}`),m.join(`
`)):e==null?"Snapshot captured":"No field-level changes detected"}function formatHistoryFullContent(t){if(typeof t!="string")return"";const e=safeParseSnapshot(t);if(e!=null)try{return JSON.stringify(e,null,2)}catch{}return t}function renderHistoryPreviewMeta(t,e){t&&(t.innerHTML="",e.forEach(([n,i])=>{const r=document.createElement("div");r.className="history-preview-meta__row";const a=document.createElement("span");a.className="history-preview-meta__label",a.textContent=n;const s=document.createElement("span");s.className="history-preview-meta__value",s.textContent=i,r.appendChild(a),r.appendChild(s),t.appendChild(r)}))}function openHistoryPreview(t,e){const n=document.getElementById("historyPreviewModal");if(!n||!t)return;const i=window.monacoInitializer,r=n.querySelector("#modal-title-history-preview");r&&(r.textContent=t.label||"Snapshot preview");const a=n.querySelector("#historyPreviewMeta"),s=t.meta?.occurrences||1;renderHistoryPreviewMeta(a,[["Saved",`${formatRelativeTime(t.timestamp)} \xB7 ${new Date(t.timestamp).toLocaleString()}`],["Reason",t.meta?.reason||"edit"],["Size",t.sizeLabel||formatBytes(t.byteSize||(t.content?t.content.length:0))],["Occurrences",`${s}\xD7`]]);const c=n.querySelector("#historyPreviewSummary");c&&(c.textContent=summarizeHistoryChanges(t.content,e?e.content:null,{limit:HISTORY_SUMMARY_MODAL_CHANGES}));const l=n.querySelector("#historyPreviewContent");l&&(l.textContent=formatHistoryFullContent(t.content));const d=n.querySelector("#historyPreviewActions");if(d){d.dataset.currentContent=t.content||"",d.dataset.entryId=t.id||"";const m=d.querySelector('[data-history-preview-action="restore"]');if(m){const w=i&&typeof i.getCurrentHistoryEntryId=="function"?i.getCurrentHistoryEntryId():null,E=w&&t.id===w;m.disabled=!!E,m.textContent=E?"Current version":"Restore"}d.dataset.bound||(d.dataset.bound="true",d.addEventListener("click",async w=>{const E=w.target instanceof HTMLElement?w.target.closest("[data-history-preview-action]"):null;if(E){if(w.preventDefault(),E.dataset.historyPreviewAction==="copy"){const M=d.dataset.currentContent||"",C=await copyTextToClipboard(M);i&&typeof i.showNotification=="function"&&i.showNotification(C?"Snapshot copied to clipboard":"Failed to copy snapshot",C?"success":"error");return}if(E.dataset.historyPreviewAction==="restore"){if(!i||typeof i.restoreHistoryEntry!="function")return;const M=d.dataset.entryId;if(!M||E.disabled)return;const C=E.textContent;E.disabled=!0;try{await i.restoreHistoryEntry(M,{forceRestore:!1,requireConfirm:!0})}catch(y){console.error("[HISTORY] Failed to restore entry from preview",y),E.disabled=!1,E.textContent=C;return}const v=typeof i.getCurrentHistoryEntryId=="function"?i.getCurrentHistoryEntryId():null;v&&M===v?E.textContent="Current version":(E.disabled=!1,E.textContent=C)}}}))}window.openModal("historyPreviewModal")}async function renderHistoryModal(t={}){const e=document.getElementById("historyModal");if(!e)return;const n=window.monacoInitializer;if(n)try{const i=e.querySelector(".modal-body"),r=i?i.querySelector("#historyList"):null;if(!i||!r)return;let a=i.querySelector("#historyStats");a||(a=document.createElement("div"),a.id="historyStats",a.className="history-stats",i.insertBefore(a,i.firstChild));const s=await n.getHistoryStats(),c=formatBytes(s.byteSize),l=s.latestTimestamp?`${formatRelativeTime(s.latestTimestamp)} (${new Date(s.latestTimestamp).toLocaleString()})`:"\u2014",d=s.latestLabel||"\u2014",m=window.Utils.escapeHtml(c),w=window.Utils.escapeHtml(l),E=window.Utils.escapeHtml(d),M=typeof s.count=="number"?s.count:window.Utils.escapeHtml(String(s.count||"\u2014"));if(a.innerHTML=`
            <div class="history-meta">
                <span class="history-meta__label">Snapshots</span>
                <span>${M}</span>
            </div>
            <div class="history-meta">
                <span class="history-meta__label">Approx size</span>
                <span>${m}</span>
            </div>
            <div class="history-meta">
                <span class="history-meta__label">Last save</span>
                <span>${w}</span>
            </div>
            <div class="history-meta">
                <span class="history-meta__label">Latest label</span>
                <span>${E}</span>
            </div>
            <div class="history-actions-row">
                <button class="btn btn-secondary btn-sm" data-history-action="snapshot">Manual snapshot</button>
                <button class="btn btn-secondary btn-sm" data-history-action="export">Copy history JSON</button>
                <button class="btn btn-danger btn-sm" data-history-action="clear">Clear history</button>
            </div>
        `,a.dataset.bound||(a.dataset.bound="true",a.addEventListener("click",async h=>{const y=h.target instanceof HTMLElement?h.target.closest("[data-history-action]"):null;if(!y)return;h.preventDefault();const A=y.dataset.historyAction;if(A==="snapshot"){await n.recordHistorySnapshot("Manual snapshot",{label:"Manual snapshot",manual:!0,force:!0}),await n.refreshHistoryUI({force:!0});return}if(A==="export"){const R=await n.getHistoryEntries({newestFirst:!1}),H={exportedAt:new Date().toISOString(),count:s.count,entries:R.map(_=>({id:_.id,timestamp:_.timestamp,label:_.label,reason:_.meta?.reason,occurrences:_.meta?.occurrences||1,firstRecordedAt:_.meta?.firstRecordedAt,lastRecordedAt:_.meta?.lastRecordedAt,size:_.byteSize,content:_.content}))},X=await copyTextToClipboard(JSON.stringify(H,null,2));n.showNotification(X?"History copied to clipboard":"Failed to copy history",X?"success":"error");return}A==="clear"&&(typeof window.confirm!="function"||window.confirm("Clear history snapshots? The current document will remain as the first entry."))&&await n.clearHistory({keepLatest:!0,label:"Current document"})})),t.statsOnly){n.markHistoryRendered();return}const C=await n.getHistoryEntries({newestFirst:!0}),v=n.getCurrentHistoryEntryId();if(r.innerHTML="",!C.length){const h=document.createElement("div");h.className="history-empty",h.innerHTML="<p>No history yet</p><small>Changes are tracked automatically \u2013 edit the document or create a manual snapshot.</small>",r.appendChild(h),n.markHistoryRendered();return}C.forEach((h,y)=>{const A=document.createElement("article");A.className="history-item",A.dataset.entryId=h.id,h.id===v&&A.classList.add("current");const R=C[y+1]||null,H=document.createElement("div");H.className="history-header";const X=document.createElement("div");X.className="history-title",X.textContent=h.label||"Snapshot";const _=document.createElement("div");_.className="history-time",_.textContent=`${formatRelativeTime(h.timestamp)} \xB7 ${new Date(h.timestamp).toLocaleString()}`,H.appendChild(X),H.appendChild(_);const de=document.createElement("pre");de.className="history-preview is-clickable",de.textContent=summarizeHistoryChanges(h.content,R?R.content:null),de.title="View full snapshot",de.setAttribute("role","button"),de.tabIndex=0,de.addEventListener("click",ye=>{ye.stopPropagation(),openHistoryPreview(h,R)}),de.addEventListener("keydown",ye=>{(ye.key==="Enter"||ye.key===" ")&&(ye.preventDefault(),ye.stopPropagation(),openHistoryPreview(h,R))});const be=document.createElement("div");be.className="history-meta";const x=h.meta?.reason||"edit",j=document.createElement("span");j.textContent=`Reason: ${x}`,be.appendChild(j);const F=h.meta?.occurrences||1;if(F>1){const ye=document.createElement("span");ye.className="history-meta__occurrences";const we=h.meta?.lastRecordedAt?new Date(h.meta.lastRecordedAt).toLocaleString():new Date(h.timestamp).toLocaleString();ye.textContent=`Saved ${F}\xD7`,ye.title=`Captured ${F} times (last at ${we})`,be.appendChild(ye)}const D=document.createElement("span");D.textContent=h.sizeLabel,be.appendChild(D);const re=document.createElement("div");re.className="history-action-buttons";const J=document.createElement("button");J.type="button",J.className=h.id===v?"btn btn-secondary btn-sm":"btn btn-primary btn-sm",J.textContent=h.id===v?"Current version":"Restore",J.disabled=h.id===v,J.addEventListener("click",ye=>{ye.stopPropagation(),n.restoreHistoryEntry(h.id,{forceRestore:!1,requireConfirm:!0}).catch(we=>console.error("[HISTORY] Failed to restore entry",we))});const se=document.createElement("button");se.type="button",se.className="btn btn-secondary btn-sm",se.textContent="Copy JSON",se.addEventListener("click",async ye=>{ye.stopPropagation();const we=await copyTextToClipboard(h.content);n.showNotification(we?"Snapshot copied to clipboard":"Failed to copy snapshot",we?"success":"error")}),re.appendChild(J),re.appendChild(se),A.appendChild(H),A.appendChild(de),A.appendChild(be),A.appendChild(re),r.appendChild(A)}),n.markHistoryRendered()}catch(i){console.error("[HISTORY] Failed to render history modal",i)}}class MonacoInitializer{constructor(){this.isInitialized=!1,this.editors=new Map,this.performanceController=typeof PerformanceController<"u"?new PerformanceController:null,this.searchIndex=typeof IndexedSearch<"u"?new IndexedSearch:{updateIndex:()=>{},searchAll:()=>[],buildIndex:()=>{}},this.resultCache=typeof ResultCache<"u"?new ResultCache:{get:()=>null,set:()=>{}},this.workerPool=null,this.diffEditor=null,this.virtualRenderer=null,this.healthMonitoring={enabled:!1,interval:null,stats:{}},this.lastJSONPathResults=[],this.lastJSONPathPointerLocator=null,this.lastJSONPathMeta={totalCount:0,truncated:!1},this.currentJSONPathIndex=-1,this.lastJSONPathQuery="",this.jsonPathSearchRequestId=0,this.findWidgetIntegration=null,this.history=new EditorHistory(60),this.historyDebounce=null,this.suspendHistoryRecording=!1,this.historyNeedsRender=!0,this.monacoSources=this.resolveMonacoSources(),this.activeMonacoSource=null,this.pendingReadOnlyRestore=null,this.editorReadOnlyLocked=!1,this.pendingMappingLoadId=null}resolveMonacoSources(){const e=[{label:"jsDelivr",baseUrl:"https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs"},{label:"cdnjs",baseUrl:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs"},{label:"unpkg",baseUrl:"https://unpkg.com/monaco-editor@0.44.0/min/vs"}],n=typeof window<"u"&&Array.isArray(window.MONACO_CDN_SOURCES)&&window.MONACO_CDN_SOURCES.length?window.MONACO_CDN_SOURCES:e,i=c=>c?typeof c=="string"?{label:c,baseUrl:c}:c.baseUrl?{label:c.label||c.baseUrl,baseUrl:c.baseUrl}:c.url?{label:c.label||c.url,baseUrl:c.url}:null:null,r=n.map(i).filter(c=>c&&c.baseUrl),a=[],s=new Set;for(const c of r){const l=c.baseUrl.replace(/\/+$/,"");s.has(l)||(s.add(l),a.push({label:c.label||l,baseUrl:l}))}return a.length?a:e.map(c=>({label:c.label,baseUrl:c.baseUrl.replace(/\/+$/,"")}))}async initialize(){if(!this.isInitialized)try{await this.loadMonaco(),this.setupWireMockSchema(),this.setupOptimizations(),await this.createEditors(),this.setupEventHandlers(),this.isInitialized=!0,console.log("\u2705 Monaco Editor initialized with WireMock integration")}catch(e){throw console.error("\u274C Monaco Editor initialization failed:",e),e}}async loadMonaco(){if(typeof MonacoLoader<"u"&&MonacoLoader.load){console.log("\u{1F680} [Lazy Loading] Loading Monaco via MonacoLoader..."),await MonacoLoader.load(),console.log("\u2705 [Lazy Loading] Monaco loaded successfully");return}console.warn("\u26A0\uFE0F [Lazy Loading] MonacoLoader not available, using fallback"),await this.waitForMonacoLoader();const e=[];for(const r of this.monacoSources){this.configureMonacoLoader(r);try{await this.requireMonacoModule(),this.activeMonacoSource=r.baseUrl,console.log(`\u{1F3AF} Monaco loaded from ${r.label||r.baseUrl}`);return}catch(a){const s=this.normalizeMonacoLoadError(a,r);e.push({source:r,error:s}),console.warn(s.message),this.invalidateFailedMonacoLoad(r)}}const n=e.map(({error:r})=>r.message).join("; "),i=new Error(`Monaco Editor could not be loaded from any configured source. Attempts: ${n||"none"}`);throw i.attempts=e,i}async waitForMonacoLoader(e=1e4){const n=Date.now();for(;!this.isMonacoLoaderAvailable();){if(Date.now()-n>e)throw new Error("Monaco AMD loader did not become available");await MonacoInitializer.sleep(50)}}isMonacoLoaderAvailable(){const e=typeof require=="function"?require:typeof window<"u"?window.require:void 0;return typeof e=="function"&&typeof e.config=="function"}configureMonacoLoader(e){const n=e.baseUrl.replace(/\/+$/,""),i=typeof require=="function"?require:typeof window<"u"?window.require:void 0;i&&typeof i.config=="function"?i.config({paths:{vs:n}}):typeof window<"u"&&(window.require=window.require||{},window.require.paths=Object.assign({},window.require.paths||{},{vs:n})),typeof window<"u"&&(window.MONACO_BASE_URL=n)}requireMonacoModule(){const e=typeof require=="function"?require:typeof window<"u"?window.require:void 0;return new Promise((n,i)=>{try{if(typeof e!="function"){i(new Error("Monaco AMD loader is not available"));return}e(["vs/editor/editor.main"],n,r=>i(r))}catch(r){i(r)}})}normalizeMonacoLoadError(e,n){const i=n.label||n.baseUrl;if(!e)return new Error(`[${i}] Unknown error while loading Monaco Editor`);if(e instanceof Event){const a=e.target,s=a&&a.src?a.src:null,c=s?`[${i}] Network error while loading ${s}`:`[${i}] Network error while loading Monaco Editor`,l=new Error(c);return l.cause=e,l.script=s,l}if(typeof e=="string")return new Error(`[${i}] ${e}`);if(e&&e.message){const a=new Error(`[${i}] ${e.message}`);return a.cause=e,a}const r=new Error(`[${i}] ${String(e)}`);return r.cause=e,r}invalidateFailedMonacoLoad(e){const n=e.baseUrl.replace(/\/+$/,""),i=typeof require=="function"?require:typeof window<"u"?window.require:void 0;if(i&&typeof i.undef=="function")try{i.undef("vs/editor/editor.main")}catch(a){console&&typeof console.debug=="function"&&console.debug("Monaco loader undef failed",a)}const r=i&&i.s&&i.s.contexts&&i.s.contexts._;if(r){if(r.urlFetched)for(const a of Object.keys(r.urlFetched))a&&a.startsWith(n)&&delete r.urlFetched[a];if(r.defined)for(const a of Object.keys(r.defined))a&&a.startsWith("vs/")&&delete r.defined[a]}typeof document<"u"&&document.querySelectorAll("script[src]").forEach(s=>{const c=s.getAttribute("src");c&&c.startsWith(`${n}/`)&&/\/vs\//.test(c)&&!/loader\.js$/i.test(c)&&s.remove()})}static sleep(e){return new Promise(n=>setTimeout(n,e))}setupWireMockSchema(){const e={type:"object",properties:{id:{type:"string",description:"Unique identifier for the mapping"},name:{type:"string",description:"Human-readable name for the mapping"},request:{type:"object",description:"Request matching criteria",properties:{method:{enum:["GET","POST","PUT","DELETE","PATCH","HEAD","OPTIONS","ANY"],description:"HTTP method to match"},url:{type:"string",description:"Exact URL to match"},urlPath:{type:"string",description:"URL path to match"},urlPathPattern:{type:"string",description:"URL path pattern (regex)"},urlPattern:{type:"string",description:"Full URL pattern (regex)"},queryParameters:{type:"object",description:"Query parameter matching"},headers:{type:"object",description:"HTTP headers matching"},bodyPatterns:{type:"array",description:"Request body matching patterns",items:{type:"object"}}}},response:{type:"object",description:"Response configuration",properties:{status:{type:"number",minimum:100,maximum:599,description:"HTTP status code"},body:{type:"string",description:"Response body as string"},jsonBody:{type:["object","array"],description:"Response body as JSON"},headers:{type:"object",description:"Response headers"},fixedDelayMilliseconds:{type:"number",description:"Fixed delay in milliseconds"}}},priority:{type:"number",description:"Mapping priority"},scenarioName:{type:"string",description:"Scenario this mapping belongs to"},metadata:{type:"object",description:"Custom metadata"}},required:["request","response"]};monaco.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!0,schemas:[{uri:"http://wiremock.org/schemas/mapping.json",fileMatch:["*"],schema:e}]})}setupOptimizations(){try{typeof WorkerPool<"u"?(this.workerPool=new WorkerPool("json-worker.js",2),this.startHealthMonitoring(),console.log("\u26A1 Real WorkerPool initialized with health monitoring")):(this.workerPool={execute:async(e,n,i)=>{switch(e){case"format":const r=JSON.parse(n.text);return JSON.stringify(r,null,2);case"minify":const a=JSON.parse(n.text);return JSON.stringify(a);case"validate":try{return JSON.parse(n.text),{valid:!0}}catch(d){return{valid:!1,error:d.message}}case"sort_keys":const s=n&&typeof n.indent=="number"&&n.indent>=0?n.indent:2,c=JSON.parse(n.text),l=this.sortKeysDeep(c);return JSON.stringify(l,null,s);default:return n}},terminate:()=>{},getStats:()=>({workers:0,busy:0,queued:0,pending:0})},console.log("\u26A1 Fallback WorkerPool initialized")),typeof VirtualizedJSONRenderer<"u"&&(this.virtualRenderer=null,console.log("\u{1F4C4} VirtualizedJSONRenderer available"))}catch(e){console.warn("Performance optimizations initialization failed:",e)}}async createEditors(){const e=document.body.dataset.theme==="dark"?"vs-dark":"vs",r=new URLSearchParams(window.location.search).get("mappingId")?"":this.getDefaultStub(),a=document.getElementById("jsonEditor");a&&(window.editor=this.createEditor(a,{language:"json",theme:e,value:r,automaticLayout:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,wordWrap:"on",formatOnPaste:!0,formatOnType:!0,folding:!0,foldingMaximumRegions:1e5}),this.editors.set("main",window.editor),await this.initializeHistory(r))}prepareEditorForMappingLoad(e){const n=this.getActiveEditor();if(!n)return;let i=!1;try{if(typeof monaco<"u"&&monaco.editor&&monaco.editor.EditorOption)i=!!n.getOption(monaco.editor.EditorOption.readOnly);else if(typeof n.getRawOptions=="function"){const r=n.getRawOptions();i=!!(r&&r.readOnly)}}catch(r){console.debug("[EDITOR] Unable to detect current readOnly state",r)}if(this.pendingReadOnlyRestore=i,i)this.editorReadOnlyLocked=!1;else try{n.updateOptions({readOnly:!0}),this.editorReadOnlyLocked=!0}catch(r){console.debug("[EDITOR] Failed to toggle readOnly before load",r),this.editorReadOnlyLocked=!1}this.suspendHistoryRecording=!0;try{n&&typeof n.setSelection=="function"&&n.setSelection(new monaco.Range(1,1,n.getModel().getLineCount(),1)),n&&typeof n.trigger=="function"&&n.trigger("source","editor.action.selectAll"),n&&typeof n.executeCommand=="function"&&n.executeCommand("editor.action.deleteAll"),n.setValue("")}finally{this.suspendHistoryRecording=!1}this.historyDebounce&&(clearTimeout(this.historyDebounce),this.historyDebounce=null),e&&(this.pendingMappingLoadId=e)}finalizeEditorMappingLoad(){const e=this.getActiveEditor();if(e){if(this.editorReadOnlyLocked)try{e.updateOptions({readOnly:!1})}catch(n){console.debug("[EDITOR] Failed to restore readOnly after load",n)}else if(typeof this.pendingReadOnlyRestore=="boolean")try{e.updateOptions({readOnly:this.pendingReadOnlyRestore})}catch(n){console.debug("[EDITOR] Failed to reset readOnly flag",n)}}this.editorReadOnlyLocked=!1,this.pendingReadOnlyRestore=null,this.pendingMappingLoadId=null}createEditor(e,n){const i=monaco.editor.create(e,n);if(this.setupFindWidgetIntegration(i),typeof VirtualizedJSONRenderer<"u"){const r=new VirtualizedJSONRenderer(i);i.virtualRenderer=r,n.value&&r.setContent(n.value)}return i.onDidChangeModelContent(()=>{this.changeTimeout&&clearTimeout(this.changeTimeout),this.changeTimeout=setTimeout(()=>{this.onContentChange(i)},500)}),i}async initializeHistory(e=""){const n=typeof e=="string"?e:"";this.history||(this.history=new EditorHistory(60)),await this.history.reset(n,{label:"Initial document",reason:"Initial snapshot"}),this.historyNeedsRender=!0,await this.refreshHistoryUI({statsOnly:!0})}markHistoryRendered(){this.historyNeedsRender=!1}getHistoryEntries(e={}){return this.history?this.history.getEntries(e):Promise.resolve([])}getHistoryStats(){return this.history?this.history.getStats():Promise.resolve({count:0,byteSize:0,latestTimestamp:null})}getCurrentHistoryEntryId(){return this.history?this.history.getCurrentId():null}async recordHistorySnapshot(e="Edit",n={}){if(!this.history)return null;const i=n.editor||this.getActiveEditor();if(!i)return null;let r;if(typeof n.contentOverride=="string"?r=n.contentOverride:i.virtualRenderer&&typeof i.virtualRenderer.getFullContent=="function"?r=i.virtualRenderer.getFullContent():typeof i.getValue=="function"?r=i.getValue():r="",!(n.allowInvalid??!!n.manual))try{JSON.parse(r)}catch(l){return n.silent||console.debug("[HISTORY] Skipped snapshot \u2013 invalid JSON",l),{recorded:!1,skipped:!0,reason:"invalid-json"}}const s={reason:e,label:n.label,manual:!!n.manual,action:e,force:!!n.force},c=await this.history.record(r,s);return c&&c.recorded&&(this.historyNeedsRender=!0,await this.refreshHistoryUI({statsOnly:n.statsOnly===!0})),c}async refreshHistoryUI(e={}){if(typeof window.renderHistoryModal!="function")return;const n=document.getElementById("historyModal"),i=n&&(n.classList.contains("show")||n.getAttribute("aria-hidden")==="false");if(e.force||i){await window.renderHistoryModal({statsOnly:!!e.statsOnly}),this.historyNeedsRender=!1;return}e.statsOnly&&document.getElementById("historyStats")&&(await window.renderHistoryModal({statsOnly:!0}),this.historyNeedsRender=!1)}shouldRenderHistory(){return this.historyNeedsRender}async restoreHistoryEntry(e,n={}){if(!this.history)return this.showNotification("History is unavailable","warning"),!1;const i=await this.history.getEntryById(e);if(!i)return this.showNotification("History entry not found","warning"),!1;const r=this.getActiveEditor();if(!r)return this.showNotification("No active editor to restore into","warning"),!1;if((r.getValue?r.getValue():"")===i.content&&!n.forceRestore)return this.history.markCurrent(i.id),await this.refreshHistoryUI({force:!0}),this.showNotification("Already on this version","info"),!0;if(!n.forceRestore&&n.requireConfirm!==!1){const s=i.label||"snapshot",c=`Restore snapshot "${s.length>80?`${s.slice(0,77)}\u2026`:s}"? Current editor content will be replaced.`;if(!(typeof window.confirm=="function"?window.confirm(c):!0))return!1}if(this.suspendHistoryRecording=!0,r.setValue(i.content),this.suspendHistoryRecording=!1,this.history.markCurrent(i.id),this.historyNeedsRender=!0,await this.refreshHistoryUI({force:!0}),this.showNotification(`Restored snapshot: ${i.label}`,"success"),typeof document<"u"){const s=Array.from(document.querySelectorAll('.modal.show, .modal[aria-hidden="false"]'));if(s.length)for(const c of s)!(typeof HTMLElement>"u"||c instanceof HTMLElement)||!c||!c.id||(typeof window.closeModal=="function"?window.closeModal(c.id):(c.classList.remove("show"),c.classList.add("hidden"),c.style.display="none",c.setAttribute("aria-hidden","true")))}return!0}async clearHistory(e={}){if(!this.history)return;const n=this.getActiveEditor(),i=n&&typeof n.getValue=="function"?n.getValue():"";await this.history.clear({keepLatest:e.keepLatest!==!1,latestContent:i,label:e.label||"Current document"}),this.historyNeedsRender=!0,await this.refreshHistoryUI({force:!0})}getTemplateLibrary(){return getTemplateLibrarySnapshot()}applyTemplateById(e,n={}){const i=this.getTemplateLibrary().find(r=>r.id===e);return i?this.applyTemplate(i,n):(this.showNotification("Template not found","error"),!1)}applyTemplate(e,n={}){const i=this.getActiveEditor();if(!i)return this.showNotification("No active editor to apply template","warning"),!1;const r=e&&e.content?e.content:{};let a=typeof r=="string"?r:JSON.stringify(r,null,2);typeof n.transform=="function"&&(a=n.transform(a,e)||a);const s=i.getValue?i.getValue():"",c=n.replace!==!1;let l=a;return!c&&s&&(l=`${s.trimEnd()}

${a}`),c&&s&&!n.silent&&n.confirm!==!1&&!(typeof window.confirm=="function"?window.confirm(`Replace current document with "${e.title}" template?`):!0)?!1:(this.suspendHistoryRecording=!0,i.setValue(l),this.suspendHistoryRecording=!1,this.recordHistorySnapshot("Template applied",{label:e.title,manual:!0,force:!0,statsOnly:!1}).catch(d=>{console.debug("[HISTORY] Failed to record template snapshot",d)}),this.showNotification(`Template "${e.title}" applied`,"success"),!0)}setupEventHandlers(){this.setupKeyboardShortcuts(),this.setupThemeHandler()}setupKeyboardShortcuts(){if(!window.editor)return;[{key:monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyN,action:()=>this.newDocument()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyO,action:()=>this.loadFile()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyS,action:()=>this.saveFile()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.KeyF,action:()=>this.formatJSON()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyM,action:()=>this.minifyJSON()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyT,action:()=>this.validateJSON()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.BracketLeft,action:()=>this.collapseAllFolds({focus:!0})},{key:monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.BracketRight,action:()=>this.expandAllFolds({focus:!0})},{key:monaco.KeyMod.CtrlCmd|monaco.KeyMod.Alt|monaco.KeyCode.KeyS,action:()=>this.sortJSONKeys()},{key:monaco.KeyMod.Alt|monaco.KeyCode.KeyN,action:()=>this.navigateJSONPathMatches(1)},{key:monaco.KeyMod.Alt|monaco.KeyCode.KeyP,action:()=>this.navigateJSONPathMatches(-1)},{key:monaco.KeyMod.Alt|monaco.KeyCode.KeyJ,action:()=>this.toggleFindWidgetJSONPathMode()}].forEach(({key:n,action:i})=>{window.editor.addCommand(n,i)})}setupThemeHandler(){new MutationObserver(n=>{n.forEach(i=>{if(i.type==="attributes"&&i.attributeName==="data-theme"){const r=document.body.dataset.theme==="dark"?"vs-dark":"vs";monaco.editor.setTheme(r),this.diffEditor&&this.diffEditor.updateOptions({theme:r})}})}).observe(document.body,{attributes:!0,attributeFilter:["data-theme"]})}onContentChange(e){const n=e.virtualRenderer?e.virtualRenderer.getFullContent():e.getValue();this.searchIndex&&typeof this.searchIndex.buildIndex=="function"?this.searchIndex.buildIndex(n):this.searchIndex&&typeof this.searchIndex.updateIndex=="function"&&this.searchIndex.updateIndex(n),e.virtualRenderer&&n.split(`
`).length>5e3&&e.virtualRenderer.setContent(n),!this.suspendHistoryRecording&&(this.historyNeedsRender=!0,this.historyDebounce&&clearTimeout(this.historyDebounce),this.historyDebounce=setTimeout(()=>{this.recordHistorySnapshot("Auto snapshot",{statsOnly:!0,allowInvalid:!1}).catch(i=>{console.debug("[HISTORY] Failed to record auto snapshot",i)})},1500))}getDefaultStub(){const e=()=>JSON.stringify({name:"Example WireMock Mapping",request:{method:"GET",urlPath:"/api/example"},response:{status:200,jsonBody:{message:"Hello from WireMock!",timestamp:"2024-01-01T00:00:00Z"},headers:{"Content-Type":"application/json"}}},null,2);try{if(window.TemplateManager?.getEmptyMappingContent){const n=window.TemplateManager.getEmptyMappingContent();return JSON.stringify(n,null,2)}}catch(n){console.warn("Unable to get empty mapping content from TemplateManager, falling back to default stub",n)}return e()}async formatJSON(){const e=this.getActiveEditor(),n=e.getValue();e&&typeof e.setValue=="function"&&e.setValue("");try{if(this.workerPool){const i=await this.workerPool.execute("format",{text:n},1);e.setValue(i)}else{const i=JSON.parse(n),r=JSON.stringify(i,null,2);e.setValue(r)}this.showNotification("JSON formatted","success")}catch(i){this.showNotification("Format error: "+i.message,"error")}}async minifyJSON(){const e=this.getActiveEditor(),n=e.getValue();try{if(this.workerPool){const i=await this.workerPool.execute("minify",{text:n},1);e.setValue(i)}else{const i=JSON.parse(n),r=JSON.stringify(i);e.setValue(r)}this.showNotification("JSON minified","success")}catch(i){this.showNotification("Minify error: "+i.message,"error")}}async validateJSON(){const n=this.getActiveEditor().getValue();try{if(this.workerPool){const i=await this.workerPool.execute("validate",{text:n},1);i.valid?this.showNotification("JSON is valid","success"):this.showNotification(`JSON invalid: ${i.error}`,"error")}else JSON.parse(n),this.showNotification("JSON is valid","success")}catch(i){this.showNotification("JSON invalid: "+i.message,"error")}}getActiveEditor(){return window.editor||this.editors.get("main")}resolveTargetEditors(e={}){if(e&&e.editor)return e.editor?[e.editor]:[];if(e&&Array.isArray(e.editors)&&e.editors.length)return e.editors.filter(Boolean);const n=new Set,i=document.getElementById("editorContainer");if(!i||i.style.display!=="none"){const a=this.editors.get("main");a&&n.add(a)}const r=document.getElementById("compareContainer");if(r&&r.style.display!=="none")if(this.diffEditor){const a=typeof this.diffEditor.getOriginalEditor=="function"?this.diffEditor.getOriginalEditor():null,s=typeof this.diffEditor.getModifiedEditor=="function"?this.diffEditor.getModifiedEditor():null;a&&n.add(a),s&&n.add(s)}else{const a=this.editors.get("compareEditorLeft"),s=this.editors.get("compareEditorRight");a&&n.add(a),s&&n.add(s)}if(!n.size){const a=this.getActiveEditor();a&&n.add(a)}return Array.from(n).filter(Boolean)}runEditorCommand(e,n,i=null){if(!e)return!1;try{if(typeof e.getAction=="function"){const r=e.getAction(n);if(r&&typeof r.run=="function"&&(!r.isSupported||r.isSupported())){const a=r.run();return a&&typeof a.then=="function"&&a.catch(s=>console.warn(`Command ${n} failed:`,s)),!0}}if(typeof e.trigger=="function")return e.trigger("json-tools",n,i),!0}catch(r){console.warn(`Command ${n} failed:`,r)}return!1}executeCommandOnEditors(e,n={}){const i=this.resolveTargetEditors(n);let r=0;return i.forEach(a=>{this.runEditorCommand(a,e,n.payload)&&r++}),n.focus&&i[0]&&typeof i[0].focus=="function"&&i[0].focus(),{executed:r,editors:i}}collapseAllFolds(e={}){const{executed:n}=this.executeCommandOnEditors("editor.foldAll",e);if(n>0){const i=n>1?"Collapsed JSON structures in all visible editors":"Collapsed JSON structures";this.showNotification(i,"success")}else this.showNotification("Unable to collapse JSON structures","warning")}expandAllFolds(e={}){const{executed:n}=this.executeCommandOnEditors("editor.unfoldAll",e);if(n>0){const i=n>1?"Expanded JSON structures in all visible editors":"Expanded JSON structures";this.showNotification(i,"success")}else this.showNotification("Unable to expand JSON structures","warning")}async sortJSONKeys(e={}){const n=this.getActiveEditor();if(!n){this.showNotification("No active editor","warning");return}const i=n.getValue(),r=n.getModel&&n.getModel(),a=e&&typeof e.indent=="number"&&e.indent>=0?e.indent:r&&typeof r.getOptions=="function"?r.getOptions().tabSize:2,s=Number.isFinite(a)?a:2;try{let c;if(this.workerPool&&typeof this.workerPool.execute=="function")c=await this.workerPool.execute("sort_keys",{text:i,indent:s},1);else{const l=JSON.parse(i),d=this.sortKeysDeep(l);c=JSON.stringify(d,null,s)}typeof c!="string"&&(c=JSON.stringify(c)),c!==i&&n.setValue(c),this.showNotification("JSON keys sorted alphabetically","success")}catch(c){console.error("Sort keys error:",c),this.showNotification("Sort keys error: "+c.message,"error")}}sortKeysDeep(e){if(Array.isArray(e))return e.map(n=>this.sortKeysDeep(n));if(e&&typeof e=="object"){const n=Object.keys(e).sort((r,a)=>r.localeCompare(a)),i={};return n.forEach(r=>{i[r]=this.sortKeysDeep(e[r])}),i}return e}showNotification(e,n){typeof showNotification<"u"?showNotification(e,n):console.log(`[${n.toUpperCase()}] ${e}`)}loadMappingIntoEditor(e,n={}){const i=this.getActiveEditor();if(i&&e){const r=typeof n=="boolean"?{notify:n}:n&&typeof n=="object"?n:{},a=JSON.stringify(e,null,2);i.setValue(a),this.finalizeEditorMappingLoad();const s=e&&(e.mapping||e),c=s&&(s.id||s.uuid);if(typeof window<"u"&&typeof window.rememberEditorMappingId=="function"&&window.rememberEditorMappingId(c),r.notify){const l=s&&(s.name||c),m=(typeof r.message=="string"?r.message.trim():"")||(l?`Mapping "${l}" loaded`:"Mapping loaded");this.showNotification(m,"success")}}}getMappingFromEditor(){const e=this.getActiveEditor();if(!e)return null;try{const n=e.getValue(),i=JSON.parse(n);if(typeof window<"u"&&typeof window.rememberEditorMappingId=="function"){const r=i&&(i.id||i.uuid);window.rememberEditorMappingId(r)}return i}catch{return this.showNotification("Invalid JSON in editor","error"),null}}search(e){const n=this.getActiveEditor();if(!n){this.showNotification("No active editor","warning");return}try{n.trigger("search","actions.find",{searchString:e,replaceString:"",isRegex:!1,matchCase:!1,matchWholeWord:!1,preserveCase:!1}),this.showNotification(`Searching for "${e}"`,"success")}catch(i){console.error("Search error:",i),this.showNotification("Search error: "+i.message,"error")}}loadCompareContent(e,n){try{if(this.diffEditor||this.initializeDiffEditor(),this.diffEditor){const i=JSON.parse(n),r=JSON.stringify(i,null,2),a=this.diffEditor.getModel();let s,c;a?(s=a.original,c=a.modified):(s=monaco.editor.createModel("","json"),c=monaco.editor.createModel("","json")),e==="left"||e==="original"?s.setValue(r):c.setValue(r),this.diffEditor.setModel({original:s,modified:c}),this.showNotification(`Content loaded to ${e} panel with diff highlighting`,"success")}else this.loadCompareContentFallback(e,n)}catch(i){console.error("Error loading compare content:",i),this.showNotification(`Error loading ${e} content: `+i.message,"error")}}initializeDiffEditor(){const e=document.getElementById("compareContainer");if(!e){console.warn("Compare container not found, cannot initialize diff editor");return}try{const n=document.body.dataset.theme==="dark"?"vs-dark":"vs";this.diffEditor=monaco.editor.createDiffEditor(e,{theme:n,readOnly:!1,automaticLayout:!0,renderSideBySide:!0,ignoreTrimWhitespace:!1,renderWhitespace:"boundary",diffWordWrap:"on",originalEditable:!0,scrollBeyondLastLine:!1,minimap:{enabled:!1},enableSplitViewResizing:!0,renderOverviewRuler:!0,diffCodeLens:!0,folding:!0,foldingMaximumRegions:1e5,scrollbar:{verticalScrollbarSize:8,horizontalScrollbarSize:8,useShadows:!1}});const i=monaco.editor.createModel("","json"),r=monaco.editor.createModel("","json");this.diffEditor.setModel({original:i,modified:r}),this.setupDiffEditorEnhancements(),this.editors.set("diffEditor",this.diffEditor),console.log("\u2705 Enhanced Monaco DiffEditor initialized with lock-step scrolling")}catch(n){console.error("Failed to initialize diff editor:",n)}}setupDiffEditorEnhancements(){if(!this.diffEditor)return;const e=this.diffEditor.getOriginalEditor(),n=this.diffEditor.getModifiedEditor();[{key:monaco.KeyMod.Alt|monaco.KeyCode.KeyN,action:()=>this.diffEditor.goToNextDiff()},{key:monaco.KeyMod.Alt|monaco.KeyCode.KeyP,action:()=>this.diffEditor.goToPrevDiff()},{key:monaco.KeyMod.CtrlCmd|monaco.KeyMod.Alt|monaco.KeyCode.KeyR,action:()=>this.resetDiffView()}].forEach(({key:r,action:a})=>{e.addCommand(r,a),n.addCommand(r,a)}),e.addAction({id:"diff-copy-to-modified",label:"Copy to Right Side",keybindings:[monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.RightArrow],run:()=>{const r=e.getValue();n.setValue(r),this.showNotification("Content copied to right side","success")}}),n.addAction({id:"diff-copy-to-original",label:"Copy to Left Side",keybindings:[monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.LeftArrow],run:()=>{const r=n.getValue();e.setValue(r),this.showNotification("Content copied to left side","success")}}),e.onDidChangeModelContent(()=>{this.onDiffContentChange("original")}),n.onDidChangeModelContent(()=>{this.onDiffContentChange("modified")})}onDiffContentChange(e){this.diffAnalysisTimeout&&clearTimeout(this.diffAnalysisTimeout),this.diffAnalysisTimeout=setTimeout(()=>{this.analyzeDiffChanges(e)},1e3)}analyzeDiffChanges(e){if(!this.diffEditor)return;const n=this.diffEditor.getModel();if(!n)return;const i=n.original.getValue(),r=n.modified.getValue();if(i&&r){const a=this.diffEditor.getDiffComputationResult();if(a&&a.changes){const s=a.changes.length;this.showNotification(`${s} difference${s!==1?"s":""} detected`,"info")}}}resetDiffView(){if(!this.diffEditor)return;const e=this.diffEditor.getModel();e&&(e.original.setValue(""),e.modified.setValue(""),this.showNotification("Diff view reset","success"))}loadCompareContentFallback(e,n){const i=e==="left"?"compareEditorLeft":"compareEditorRight";let r=this.editors.get(i);if(!r){const a=document.getElementById(i);if(a){const s=document.body.dataset.theme==="dark"?"vs-dark":"vs";r=this.createEditor(a,{language:"json",theme:s,readOnly:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,wordWrap:"on"}),this.editors.set(i,r)}}if(r){const a=JSON.parse(n),s=JSON.stringify(a,null,2);r.setValue(s),this.showNotification(`Content loaded to ${e} panel`,"success")}else throw new Error(`Cannot find container for ${e} compare editor`)}clearCompareContent(e){try{if(this.diffEditor){const n=this.diffEditor.getModel();n&&(e==="left"||e==="original"?n.original.setValue(""):e==="right"||e==="modified"?n.modified.setValue(""):e==="both"&&(n.original.setValue(""),n.modified.setValue(""))),this.showNotification(`${e.charAt(0).toUpperCase()+e.slice(1)} diff panel cleared`,"success")}else{const n=e==="left"?"compareEditorLeft":"compareEditorRight",i=this.editors.get(n);i?(i.setValue(""),this.showNotification(`${e.charAt(0).toUpperCase()+e.slice(1)} panel cleared`,"success")):this.showNotification(`${e} compare editor not found`,"warning")}}catch(n){console.error(`Error clearing ${e} panel:`,n),this.showNotification(`Error clearing ${e} panel: `+n.message,"error")}}evaluateJSONPath(e,n,i,r){const a=[],s=this.createPointerLocator(i),c="$",l=typeof n=="string"?n.trim():"";if(!l||l==="$"){const w=this.findValuePosition(e,i,r,"$",s,c);return a.push({value:e,path:"$",pointer:c,position:w}),a}const d=l.replace(/^\$\.?/,""),m=d?d.split(".").filter(Boolean):[];return this.traverseJSONPath(e,m,i,r,"$",a,s,c),a}traverseJSONPath(e,n,i,r,a,s,c,l){if(n.length===0){const w=this.findValuePosition(e,i,r,a,c,l);s.push({value:e,path:a,pointer:l,position:w});return}const[d,...m]=n;if(d.includes("[")&&d.includes("]")){const[w,E]=d.split("["),M=E.replace("]","");let C=e,v=l;if(w){if(!e||typeof e!="object"||!Object.prototype.hasOwnProperty.call(e,w))return;C=e[w],v=appendPointerSegment(v,w)}if(Array.isArray(C))if(M==="*")C.forEach((h,y)=>{const A=a+(w?`.${w}`:"")+`[${y}]`,R=appendPointerSegment(v,y);this.traverseJSONPath(h,m,i,r,A,s,c,R)});else{const h=parseInt(M,10);if(!Number.isNaN(h)&&h>=0&&h<C.length){const y=a+(w?`.${w}`:"")+`[${h}]`,A=appendPointerSegment(v,h);this.traverseJSONPath(C[h],m,i,r,y,s,c,A)}}}else if(d==="*")e&&typeof e=="object"&&!Array.isArray(e)&&Object.keys(e).forEach(w=>{const E=a+`.${w}`,M=appendPointerSegment(l,w);this.traverseJSONPath(e[w],m,i,r,E,s,c,M)});else if(e&&typeof e=="object"&&Object.prototype.hasOwnProperty.call(e,d)){const w=a+`.${d}`,E=appendPointerSegment(l,d);this.traverseJSONPath(e[d],m,i,r,w,s,c,E)}}findValuePosition(e,n,i,r,a=null,s=null){try{let c=a||null,l=s;if(typeof l=="string"&&l.startsWith("$.")){const w=this.convertJSONPathToPointer(l);w&&(l=w)}if(!l&&typeof r=="string"&&r.length>0&&(l=this.convertJSONPathToPointer(r)),l&&(c||(c=this.createPointerLocator(n)),c)){const w=c.getRange(l);if(w)return w}const d=i&&typeof i.getModel=="function"?i.getModel():null;if(!d)return null;let m;if(typeof e=="string"?m=`"${e}"`:m=JSON.stringify(e),m){const w=d.findMatches(m,!1,!1,!0,null,!1);if(w.length>0){const{range:E}=w[0];return{startLineNumber:E.startLineNumber,startColumn:E.startColumn,endLineNumber:E.endLineNumber,endColumn:E.endColumn}}}if(e&&typeof e=="object"){const w=JSON.stringify(e,null,2);if(w&&w!==m){const E=d.findMatches(w,!1,!1,!0,null,!1);if(E.length>0){const{range:M}=E[0];return{startLineNumber:M.startLineNumber,startColumn:M.startColumn,endLineNumber:M.endLineNumber,endColumn:M.endColumn}}}}}catch(c){console.warn("Could not find position for value:",c)}return null}formatValuePreview(e){if(e===null)return"null";if(e===void 0)return"undefined";let n=JSON.stringify(e);return n.length>100&&(n=n.slice(0,97)+"..."),n}newDocument(){try{const e=this.getActiveEditor();e&&(e.setValue(this.getDefaultStub()),this.showNotification("New document created","success"))}catch(e){this.showNotification("Error creating new document: "+e.message,"error")}}loadFile(){try{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=n=>{const i=n.target.files[0];if(i){const r=new FileReader;r.onload=a=>{try{const s=a.target.result,c=this.getActiveEditor();c&&(c.setValue(s),this.showNotification("File loaded successfully","success"))}catch(s){this.showNotification("Error loading file: "+s.message,"error")}},r.readAsText(i)}},e.click()}catch(e){this.showNotification("Error opening file dialog: "+e.message,"error")}}saveFile(){try{const e=this.getActiveEditor();if(e){const n=e.getValue(),i=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(i),a=document.createElement("a");a.href=r,a.download="wiremock-mapping.json",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r),this.showNotification("File saved successfully","success")}}catch(e){this.showNotification("Error saving file: "+e.message,"error")}}exportAsYAML(){const e=this.getActiveEditor();if(!e){this.showNotification("No active editor","warning");return}let n;try{n=JSON.parse(e.getValue())}catch(i){this.showNotification("Cannot export YAML: "+i.message,"error");return}try{const i=convertJSONToYAML(n),r=i.endsWith(`
`)?i:`${i}
`,a=new Blob([r],{type:"text/yaml"}),s=URL.createObjectURL(a),c=document.createElement("a");c.href=s,c.download="wiremock-mapping.yaml",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(s),this.showNotification("YAML exported","success")}catch(i){this.showNotification("YAML export failed: "+i.message,"error")}}async searchJSONPath(e,n={}){if(!this.getActiveEditor())return n.notify!==!1&&this.showNotification("No active editor","warning"),[];const a=(typeof e=="string"?e:"").trim(),s=a.length>0,c=n.allowEmpty===!0;if(!s&&!c)return n.notify!==!1&&this.showNotification("Please enter a search term","warning"),[];const l=typeof n.jsonPathMode=="boolean"?n.jsonPathMode:null,d=s&&this.isJSONPathQuery(a),m=l!==null?l:d;return await this.openFindWidget({query:s?a:void 0,jsonPathMode:m,focus:n.focus!==!1,select:typeof n.select=="boolean"?n.select:!1,notify:n.notify===!0})?s?m?Array.isArray(this.lastJSONPathResults)?this.lastJSONPathResults:[]:[]:[]:(n.notify!==!1&&this.showNotification("Find widget is not available","error"),[])}async searchWithJSONPath(e,n,i={}){const{notify:r=!0,revealFirst:a=!0,fromWidget:s=!1}=i||{},c=++this.jsonPathSearchRequestId,l=n.getValue();if(!l||!l.trim())return this.resetJSONPathResults({keepQuery:!0}),this.lastJSONPathQuery=e,s&&this.updateFindWidgetMatchesCount(0,!1,-1,{noContent:!0}),r&&this.showNotification("No content to search","warning"),[];let d=null;if(this.canUseWorkerForJSONPath())try{d=await this.workerPool.execute("jsonpath",{text:l,path:e},5,1e4)}catch(m){console.warn("JSONPath worker execution failed, falling back to local parser:",m)}if(d&&typeof d=="object"&&Array.isArray(d.values)){const{matches:m,pointerLocator:w}=this.convertWorkerResultToMatches(d,e,l,n),E=typeof d.count=="number"?d.count:m.length,M=!!d.truncated;return c!==this.jsonPathSearchRequestId?m:(this.lastJSONPathPointerLocator=w,this.handleJSONPathMatches(e,m,n,E,M,{notify:r,revealFirst:a,fromWidget:s}))}try{const m=JSON.parse(l),w=this.evaluateJSONPath(m,e,l,n)||[];return c!==this.jsonPathSearchRequestId?w:(this.lastJSONPathPointerLocator=null,this.handleJSONPathMatches(e,w,n,w.length,!1,{notify:r,revealFirst:a,fromWidget:s}))}catch(m){return this.resetJSONPathResults({keepQuery:!0}),this.lastJSONPathPointerLocator=null,this.lastJSONPathQuery=e,s&&this.updateFindWidgetMatchesCount(0,!1,-1,{error:m.message}),r&&this.showNotification("Invalid JSON or JSONPath: "+m.message,"error"),[]}}isJSONPathQuery(e){return e?e.trim().startsWith("$"):!1}canUseWorkerForJSONPath(){return!this.workerPool||typeof this.workerPool.execute!="function"?!1:Array.isArray(this.workerPool.workers)?this.workerPool.workers.length>0:!1}convertWorkerResultToMatches(e,n,i,r){const a=Array.isArray(e.values)?e.values:[],s=this.extractJSONPathStrings(e,n,a.length),c=this.extractPointerPaths(e,a.length),d=c.some(w=>typeof w=="string"&&w.length>0)?this.createPointerLocator(i):null;return{matches:a.map((w,E)=>{const M=s[E]||n,C=c[E]||null;let v=null;if(C&&d){const h=d.getRange(C);h&&(v=h)}return v||(v=this.findValuePosition(w,i,r,M,d,C)),{value:w,path:M,pointer:C,position:v}}),pointerLocator:d,pointerPaths:c}}extractJSONPathStrings(e,n,i=0){return e?Array.isArray(e.jsonPaths)&&e.jsonPaths.length>0?e.jsonPaths:Array.isArray(e.paths)&&e.paths.length>0?e.paths.map(r=>Array.isArray(r)?convertPathArrayToJSONPath(r):String(r)):i>0?new Array(i).fill(n):[]:[]}extractPointerPaths(e,n=0){return e?Array.isArray(e.pointerPaths)&&e.pointerPaths.length>0?e.pointerPaths:Array.isArray(e.paths)&&e.paths.length>0?e.paths.map(i=>Array.isArray(i)?convertPathArrayToPointer(i):null):n>0?new Array(n).fill(null):[]:[]}createPointerLocator(e){return buildJSONPointerLocator(e)}convertJSONPathToPointer(e){if(typeof e!="string")return null;const n=e.trim();if(!n)return null;if(n==="$")return"$";if(!n.startsWith("$"))return null;let i="$",r=1;for(;r<n.length;){const a=n[r];if(a==="."){if(r++,r>=n.length)break;if(n[r]===".")return null;if(n[r]==="[")continue;let s=r;for(;r<n.length&&n[r]!=="."&&n[r]!=="[";)r++;const c=n.slice(s,r);c&&(i=appendPointerSegment(i,c));continue}if(a==="["){if(r++,r>=n.length)break;if(n[r]==="'"||n[r]==='"'){const s=n[r];r++;let c="";for(;r<n.length;){const l=n[r];if(l==="\\"&&r+1<n.length){c+=n[r+1],r+=2;continue}if(l===s)break;c+=l,r++}if(r<n.length&&n[r]===s&&r++,r<n.length&&n[r]==="]"&&r++,!c)return null;i=appendPointerSegment(i,c)}else{let s=r;for(;r<n.length&&n[r]!=="]";)r++;const c=n.slice(s,r);if(r<n.length&&n[r]==="]"&&r++,!c||c==="*")return null;const l=Number(c);Number.isNaN(l)?i=appendPointerSegment(i,c):i=appendPointerSegment(i,l)}continue}r++}return i}handleJSONPathMatches(e,n,i,r,a,s={}){const{notify:c=!0,revealFirst:l=!0,fromWidget:d=!1}=s||{};if(!Array.isArray(n)||n.length===0)return this.resetJSONPathResults({keepQuery:!0}),this.lastJSONPathQuery=e,this.lastJSONPathMeta={totalCount:0,truncated:!1},d&&this.updateFindWidgetMatchesCount(0,a,-1,{query:e}),c&&this.showNotification(`JSONPath "${e}" not found`,"info"),[];if(this.lastJSONPathResults=n,this.lastJSONPathMeta={totalCount:r,truncated:a},this.lastJSONPathQuery=e,l?this.focusJSONPathMatch(0,i,{fromWidget:d,reveal:!0}):(this.currentJSONPathIndex<0||this.currentJSONPathIndex>=n.length)&&(this.currentJSONPathIndex=0),d&&this.updateFindWidgetMatchesCount(r,a,this.currentJSONPathIndex),c){const m=Math.max(0,this.currentJSONPathIndex),w=n[m]||n[0];let E=`JSONPath "${e}" found ${r} match${r===1?"":"es"}`;a&&n.length<r&&(E+=` (showing first ${n.length})`),w&&Object.prototype.hasOwnProperty.call(w,"value")&&(E+=`: ${this.formatValuePreview(w.value)}`),this.showNotification(E,"success"),r>1&&this.showNotification(`Use Alt+N/Alt+P to navigate between ${r} matches`,"info")}return n}resetJSONPathResults(e={}){const{keepQuery:n=!1}=e||{};this.lastJSONPathResults=[],this.lastJSONPathMeta={totalCount:0,truncated:!1},this.lastJSONPathPointerLocator=null,this.currentJSONPathIndex=-1,n||(this.lastJSONPathQuery="")}focusJSONPathMatch(e,n=this.getActiveEditor(),i={}){const{reveal:r=!0,fromWidget:a=!1}=i||{};if(!n)return!1;const s=Array.isArray(this.lastJSONPathResults)?this.lastJSONPathResults:[];if(s.length===0)return this.currentJSONPathIndex=-1,a&&this.updateFindWidgetMatchesCount(0,!1,-1),!1;const c=Number(e);if(Number.isNaN(c)||c<0||c>=s.length)return!1;const l=s[c];if(!l)return!1;const d=n.getValue();let m=l.position,w=this.lastJSONPathPointerLocator;if(w||(w=this.createPointerLocator(d),this.lastJSONPathPointerLocator=w),(!m||typeof m.startLineNumber!="number")&&w){const M=l.pointer||this.convertJSONPathToPointer(l.path);if(M){const C=w.getRange(M);C&&(m=C,l.position=C)}}if(!m||typeof m.startLineNumber!="number"){const M=l.pointer||null,C=this.findValuePosition(l.value,d,n,l.path,w,M);C&&(m=C,l.position=C)}if(!m||typeof m.startLineNumber!="number")return!1;const E=new monaco.Range(m.startLineNumber,m.startColumn,m.endLineNumber,m.endColumn);if(n.setSelection(E),r&&(monaco?.editor?.ScrollType?n.revealRangeInCenter(E,monaco.editor.ScrollType.Smooth):n.revealRangeInCenter(E)),this.currentJSONPathIndex=c,a||this.findWidgetIntegration&&this.findWidgetIntegration.enabled){const M=this.lastJSONPathMeta||{},C=typeof M.totalCount=="number"&&M.totalCount>0?M.totalCount:s.length;this.updateFindWidgetMatchesCount(C,!!M.truncated,c)}return!0}navigateJSONPathMatches(e=1,n=this.getActiveEditor(),i={}){const r=Array.isArray(this.lastJSONPathResults)?this.lastJSONPathResults:[];if(!n||r.length===0)return i.notify!==!1&&this.showNotification("No JSONPath matches to navigate","warning"),!1;let a=Number(e);(Number.isNaN(a)||a===0)&&(a=1);const s=r.length;let c=typeof this.currentJSONPathIndex=="number"?this.currentJSONPathIndex:-1;c<0||c>=s?c=a>0?0:s-1:c=(c+a+s)%s;const l=this.focusJSONPathMatch(c,n,{fromWidget:i.fromWidget,reveal:i.reveal!==!1});return!l&&i.notify!==!1&&this.showNotification("Unable to navigate to JSONPath match","warning"),l}updateFindWidgetMatchesCount(e,n,i=this.currentJSONPathIndex,r={}){const a=this.findWidgetIntegration;if(!a||!a.matchesElement)return;const s=a.matchesElement;if(r.reset){typeof a.originalMatchesText=="string"&&(s.textContent=a.originalMatchesText),s.removeAttribute("data-jsonpath"),s.removeAttribute("data-jsonpath-state"),s.removeAttribute("data-jsonpath-partial"),s.removeAttribute("title");return}if(!a.enabled&&!r.force)return;const c=(E,M="status",C={})=>{s.dataset.jsonpath="true",s.dataset.jsonpathState=M,C.partial?s.dataset.jsonpathPartial="true":s.removeAttribute("data-jsonpath-partial"),s.innerHTML="";const v=document.createElement("span");if(v.className="jsonpath-chip",v.textContent="JSONPath",s.appendChild(v),E){const h=document.createElement("span");h.className="jsonpath-status",h.textContent=E,s.appendChild(h)}C.title?s.title=C.title:E?s.title=`JSONPath \xB7 ${E}`:s.removeAttribute("title")};if(r.searching){c("searching\u2026");return}if(r.emptyQuery){c("enter path");return}if(r.noContent){c("no content");return}if(r.error){c("error","error");return}if(!e||e<=0){c("no results");return}const l=typeof i=="number"&&i>=0?i+1:1,d=`${l}/${e}`,m=n&&Array.isArray(this.lastJSONPathResults)&&this.lastJSONPathResults.length<e,w=m?`JSONPath results \xB7 ${l}/${e} (partial)`:`JSONPath results \xB7 ${l}/${e}`;c(d,"count",{partial:m,title:w})}performFindWidgetJSONPathSearch(e,n={}){const i=this.findWidgetIntegration;if(!i||!i.enabled)return;const r=typeof e=="string"?e.trim():"",a=!!n.immediate,s=typeof n.delay=="number"?n.delay:150;if(i.searchDebounce&&(clearTimeout(i.searchDebounce),i.searchDebounce=null),!r){this.resetJSONPathResults({keepQuery:!1}),this.lastJSONPathQuery="",this.updateFindWidgetMatchesCount(0,!1,-1,{emptyQuery:!0});return}const c=()=>{i.searchDebounce=null;const l=i.editor||this.getActiveEditor();l&&this.searchWithJSONPath(r,l,{notify:!1,revealFirst:n.revealFirst!==!1,fromWidget:!0})};if(this.updateFindWidgetMatchesCount(null,!1,-1,{searching:!0,force:!0}),a){c();return}i.searchDebounce=setTimeout(c,s)}setupFindWidgetIntegration(e){if(typeof document>"u")return;this.findWidgetIntegration?(this.findWidgetIntegration.editor=e,"resizeHandler"in this.findWidgetIntegration||(this.findWidgetIntegration.resizeHandler=null),"resizeObserver"in this.findWidgetIntegration||(this.findWidgetIntegration.resizeObserver=null),"layoutRaf"in this.findWidgetIntegration||(this.findWidgetIntegration.layoutRaf=null),"layoutScheduler"in this.findWidgetIntegration||(this.findWidgetIntegration.layoutScheduler="raf"),"lastLayoutWidth"in this.findWidgetIntegration||(this.findWidgetIntegration.lastLayoutWidth=null),"lastReservedPadding"in this.findWidgetIntegration||(this.findWidgetIntegration.lastReservedPadding=null)):this.findWidgetIntegration={editor:e,widget:null,toggleElement:null,matchesElement:null,inputElement:null,nextButton:null,prevButton:null,closeButton:null,enabled:!1,observer:null,searchDebounce:null,originalMatchesText:"",resizeHandler:null,resizeObserver:null,layoutRaf:null,layoutScheduler:"raf",lastLayoutWidth:null,lastReservedPadding:null};const n=this.findWidgetIntegration;(()=>{const r=document.querySelector(".editor-widget.find-widget");return r?(this.decorateFindWidget(r,n),!0):!1})()||n.observer||(n.observer=new MutationObserver(r=>{for(const a of r){if(a.addedNodes)for(const s of a.addedNodes){if(!s||s.nodeType!==1)continue;const c=s;if(c.classList.contains("find-widget")){this.decorateFindWidget(c,n);continue}const l=c.querySelector?c.querySelector(".editor-widget.find-widget, .find-widget"):null;if(l){const d=l.classList&&l.classList.contains("find-widget")?l:l.querySelector(".find-widget");d&&this.decorateFindWidget(d,n)}}if(a.removedNodes&&n.widget)for(const s of a.removedNodes)!s||s.nodeType!==1||(s===n.widget||s.contains&&s.contains(n.widget))&&this.handleFindWidgetRemoval()}}),n.observer.observe(document.body,{childList:!0,subtree:!0}))}async openFindWidget(e={}){const n=this.getActiveEditor();if(!n)return null;this.setupFindWidgetIntegration(n);const i=n.getAction&&n.getAction("actions.find");try{i&&typeof i.run=="function"?await i.run():n.trigger("keyboard","actions.find",null)}catch(s){console.warn("Find widget command failed, triggering fallback:",s),n.trigger("keyboard","actions.find",null)}const r=Date.now(),a=typeof requestAnimationFrame=="function"?requestAnimationFrame:s=>setTimeout(s,30);return new Promise(s=>{const c=()=>{const l=this.findWidgetIntegration;if(l&&l.widget&&l.inputElement){const d=l.inputElement,m=e.focus!==!1,w=e.select!==!1,E=e.notify===!0,M=typeof e.jsonPathMode=="boolean",C=M?e.jsonPathMode:null,v=typeof e.query=="string",y=(v?e.query:"").trim();v&&d.value!==y&&(d.value=y),M&&this.setFindWidgetJSONPathMode(C,{notify:E,focusInput:!1}),(!M||C!==!0)&&v&&d.dispatchEvent(new Event("input",{bubbles:!0})),m&&(d.focus(),w&&d.select()),s(l);return}if(Date.now()-r>1200){s(null);return}a(c)};c()})}decorateFindWidget(e,n=this.findWidgetIntegration){if(!n||!e||typeof e.querySelector!="function")return;e.dataset&&(e.dataset.jsonpathDecorated="true"),e.classList.add("jsonpath-extended"),n.widget=e,typeof window<"u"&&(n.resizeHandler&&window.removeEventListener("resize",n.resizeHandler),n.resizeHandler=window.debounce?window.debounce(()=>this.refreshFindWidgetLayout(),150):()=>this.refreshFindWidgetLayout(),window.addEventListener("resize",n.resizeHandler,{passive:!0})),typeof ResizeObserver<"u"&&(n.resizeObserver?n.resizeObserver.disconnect():n.resizeObserver=new ResizeObserver(()=>{this.refreshFindWidgetLayout()}),n.resizeObserver.observe(e));const i=e.querySelector(".matchesCount");i&&(n.matchesElement=i,n.originalMatchesText||(n.originalMatchesText=i.textContent||""));const r=e.querySelector(".controls");if(r&&r.classList.add("jsonpath-widget-controls"),r&&!e.querySelector("[data-jsonpath-toggle]")){const d=document.createElement("div");d.className="monaco-custom-toggle codicon codicon-symbol-structure",d.setAttribute("role","checkbox"),d.setAttribute("tabindex","0"),d.setAttribute("aria-checked","false"),d.setAttribute("aria-label","Use JSONPath (Alt+J)"),d.setAttribute("title","Use JSONPath (Alt+J)"),d.dataset.jsonpathToggle="true",d.classList.add("monaco-jsonpath-toggle");const m=w=>{w.preventDefault(),w.stopPropagation(),this.setFindWidgetJSONPathMode(!n.enabled,{notify:!0,focusInput:!0})};d.addEventListener("click",m),d.addEventListener("keydown",w=>{(w.key===" "||w.key==="Enter")&&m(w)}),r.firstChild?r.insertBefore(d,r.firstChild):r.appendChild(d),n.toggleElement=d}else r&&(n.toggleElement||(n.toggleElement=r.querySelector("[data-jsonpath-toggle]")),n.toggleElement&&n.toggleElement.classList.add("monaco-jsonpath-toggle"));const a=e.querySelector(".find-part .input");a&&(n.inputElement=a,a.dataset.jsonpathBound||(a.dataset.jsonpathBound="true",a.addEventListener("input",()=>{n.enabled&&this.performFindWidgetJSONPathSearch(a.value)}),a.addEventListener("keydown",d=>{if(n.enabled&&d.key==="Enter"){d.preventDefault(),d.stopPropagation();const m=a.value.trim();if(!m){this.updateFindWidgetMatchesCount(0,!1,-1,{emptyQuery:!0});return}if(m!==this.lastJSONPathQuery){this.performFindWidgetJSONPathSearch(m,{immediate:!0});return}const w=d.shiftKey?-1:1;this.navigateJSONPathMatches(w,n.editor,{fromWidget:!0,notify:!1})}})));const s=e.querySelector(".codicon-find-next-match");s&&(n.nextButton=s,s.dataset.jsonpathBound||(s.dataset.jsonpathBound="true",s.addEventListener("mousedown",d=>{n.enabled&&(d.preventDefault(),d.stopPropagation())}),s.addEventListener("click",d=>{if(!n.enabled)return;d.preventDefault(),d.stopPropagation();const m=n.inputElement?n.inputElement.value.trim():"";if(m&&m!==this.lastJSONPathQuery){this.performFindWidgetJSONPathSearch(m,{immediate:!0});return}this.navigateJSONPathMatches(1,n.editor,{fromWidget:!0,notify:!1})})));const c=e.querySelector(".codicon-find-previous-match");c&&(n.prevButton=c,c.dataset.jsonpathBound||(c.dataset.jsonpathBound="true",c.addEventListener("mousedown",d=>{n.enabled&&(d.preventDefault(),d.stopPropagation())}),c.addEventListener("click",d=>{if(!n.enabled)return;d.preventDefault(),d.stopPropagation();const m=n.inputElement?n.inputElement.value.trim():"";if(m&&m!==this.lastJSONPathQuery){this.performFindWidgetJSONPathSearch(m,{immediate:!0});return}this.navigateJSONPathMatches(-1,n.editor,{fromWidget:!0,notify:!1})})));const l=e.querySelector(".codicon-widget-close");if(l&&(n.closeButton=l,l.dataset.jsonpathBound||(l.dataset.jsonpathBound="true",l.addEventListener("click",()=>{n.enabled&&this.setFindWidgetJSONPathMode(!1,{notify:!1})}))),n.enabled){const d=this.lastJSONPathMeta||{},m=typeof d.totalCount=="number"&&d.totalCount>0?d.totalCount:Array.isArray(this.lastJSONPathResults)?this.lastJSONPathResults.length:0;m>0?this.updateFindWidgetMatchesCount(m,!!d.truncated,this.currentJSONPathIndex,{force:!0}):this.updateFindWidgetMatchesCount(0,!1,-1,{emptyQuery:!this.lastJSONPathQuery})}this.refreshFindWidgetLayout({immediate:!0})}refreshFindWidgetLayout(e={}){const n=this.findWidgetIntegration;if(!n||!n.widget)return;const i=n.widget;i.classList.add("jsonpath-extended");const r=typeof requestAnimationFrame=="function"?"raf":"timeout",a=r==="raf"?requestAnimationFrame:c=>setTimeout(c,20);n.layoutRaf!==null&&(n.layoutScheduler==="raf"&&typeof cancelAnimationFrame=="function"?cancelAnimationFrame(n.layoutRaf):clearTimeout(n.layoutRaf),n.layoutRaf=null),n.layoutScheduler=r;const s=()=>{n.layoutRaf=null;const c=typeof window<"u"&&window.innerWidth||0;let l=460;if(c>0){const h=c<600?24:48,y=c<1280?.62:.5,A=Math.round(c*y);l=Math.max(380,Math.min(720,c-h,A)),c<=520&&(l=Math.max(320,c-20))}let d=l;if(c>0){const h=Math.max(320,c-32);d=Math.min(l,h)}n.lastLayoutWidth!==d&&(i.style.width=`${d}px`,i.style.maxWidth="calc(100vw - 32px)",i.style.minWidth=`${Math.min(Math.max(d,320),420)}px`,n.lastLayoutWidth=d);const m=i.querySelector(".find-part");m&&(m.style.flex="1 1 auto",m.style.minWidth="0");const w=i.querySelector(".find-part .monaco-findInput");w&&(w.style.flex="1 1 auto",w.style.minWidth="0");const E=i.querySelector(".replace-part");E&&(E.style.flex="1 1 auto",E.style.minWidth="0");const M=i.querySelector(".find-part .controls");let C=88;if(M){M.classList.add("jsonpath-widget-controls");const h=M.getBoundingClientRect();h&&h.width?C=Math.max(72,Math.round(h.width)+12):M.children&&M.children.length&&(C=Math.max(72,M.children.length*24+12))}if(n.lastReservedPadding!==C){const h=(y,A,R)=>{const H=i.querySelector(y);if(!H)return;const X=H.querySelector(".input"),_=H.querySelector(".mirror"),de=Math.max(R,C-A);X&&(X.style.width=`calc(100% - ${de}px)`),_&&(_.style.paddingRight=`${de}px`)};h(".find-part .monaco-findInput",0,72),h(".replace-part .monaco-findInput",24,56),n.lastReservedPadding=C}const v=i.querySelector(".matchesCount");v&&(v.style.minWidth="96px",v.style.textAlign="right")};e.immediate&&s(),n.layoutRaf=a(()=>{s()})}toggleFindWidgetJSONPathMode(e){const n=this.getActiveEditor();if(!n)return;const i=this.findWidgetIntegration,r=typeof e=="boolean"?e:!(i&&i.enabled),a=()=>{this.setupFindWidgetIntegration(n);const s=this.findWidgetIntegration;s&&s.widget&&this.setFindWidgetJSONPathMode(r,{notify:!0,focusInput:!0})};if(!i||!i.widget){const s=n.getAction&&n.getAction("actions.find");s&&typeof s.run=="function"?s.run().then(()=>{setTimeout(a,0)}).catch(()=>{setTimeout(a,0)}):(n.trigger("keyboard","actions.find",null),setTimeout(a,0))}else a()}setFindWidgetJSONPathMode(e,n={}){const i=this.findWidgetIntegration;if(!i)return;const r=i.enabled;if(i.enabled=!!e,i.toggleElement){i.toggleElement.setAttribute("aria-checked",i.enabled?"true":"false"),i.toggleElement.classList.toggle("checked",i.enabled);const c=i.enabled?"Disable JSONPath (Alt+J)":"Use JSONPath (Alt+J)";i.toggleElement.setAttribute("aria-label",c),i.toggleElement.setAttribute("title",c)}if(i.widget&&i.widget.classList.toggle("jsonpath-mode",i.enabled),this.refreshFindWidgetLayout(),!i.enabled){i.searchDebounce&&(clearTimeout(i.searchDebounce),i.searchDebounce=null),this.updateFindWidgetMatchesCount(null,!1,-1,{reset:!0}),n.notify&&r!==i.enabled&&this.showNotification("JSONPath mode disabled in find widget","info");return}n.notify&&r!==i.enabled&&this.showNotification("JSONPath mode enabled in find widget","info");const a=i.inputElement;n.focusInput&&a&&(a.focus(),a.select());const s=a?a.value.trim():"";s?this.performFindWidgetJSONPathSearch(s,{immediate:!0}):this.updateFindWidgetMatchesCount(0,!1,-1,{emptyQuery:!0})}handleFindWidgetRemoval(){const e=this.findWidgetIntegration;if(e){if(e.searchDebounce&&(clearTimeout(e.searchDebounce),e.searchDebounce=null),e.layoutRaf!==null&&(e.layoutScheduler==="raf"&&typeof cancelAnimationFrame=="function"?cancelAnimationFrame(e.layoutRaf):clearTimeout(e.layoutRaf),e.layoutRaf=null),e.resizeObserver&&typeof e.resizeObserver.disconnect=="function"&&(e.resizeObserver.disconnect(),e.resizeObserver=null),e.resizeHandler&&typeof window<"u"&&(window.removeEventListener("resize",e.resizeHandler),e.resizeHandler=null),e.widget){e.widget.classList.remove("jsonpath-extended","jsonpath-mode"),e.widget.style.removeProperty("width"),e.widget.style.removeProperty("maxWidth"),e.widget.style.removeProperty("minWidth");const n=e.widget.querySelector(".find-part .input"),i=e.widget.querySelector(".find-part .mirror");n&&n.style.removeProperty("width"),i&&i.style.removeProperty("padding-right");const r=e.widget.querySelector(".replace-part .input"),a=e.widget.querySelector(".replace-part .mirror");r&&r.style.removeProperty("width"),a&&a.style.removeProperty("padding-right")}e.lastLayoutWidth=null,e.lastReservedPadding=null,e.widget=null,e.toggleElement=null,e.matchesElement=null,e.inputElement=null,e.nextButton=null,e.prevButton=null,e.closeButton=null,e.enabled=!1}}startHealthMonitoring(){this.healthMonitoring.enabled||(this.healthMonitoring.enabled=!0,this.healthMonitoring.interval=setInterval(()=>{this.updateHealthStats()},5e3),console.log("\u{1F48A} Health monitoring started"))}updateHealthStats(){try{const e={timestamp:Date.now(),workerPool:this.workerPool?this.workerPool.getStats():null,searchIndex:this.searchIndex&&typeof this.searchIndex.getStats=="function"?this.searchIndex.getStats():null,performance:this.performanceController&&typeof this.performanceController.getStats=="function"?this.performanceController.getStats():null,memory:performance.memory?{used:Math.round(performance.memory.usedJSHeapSize/1024/1024),total:Math.round(performance.memory.totalJSHeapSize/1024/1024),limit:Math.round(performance.memory.jsHeapSizeLimit/1024/1024)}:null};this.healthMonitoring.stats=e,e.workerPool&&e.workerPool.queued>10&&console.warn("\u26A0\uFE0F Worker pool queue is growing:",e.workerPool.queued),e.memory&&e.memory.used>e.memory.limit*.8&&console.warn("\u26A0\uFE0F Memory usage high:",e.memory)}catch(e){console.error("Health monitoring error:",e)}}getHealthStats(){return this.healthMonitoring.stats}showPerformanceBadge(){const e=this.getHealthStats();if(!e)return;let n=document.getElementById("performanceBadge");n||(n=document.createElement("div"),n.id="performanceBadge",n.className="perf-monitor",document.body.appendChild(n));const i=[];e.workerPool&&(i.push(`Workers: ${e.workerPool.busy}/${e.workerPool.workers}`),e.workerPool.queued>0&&i.push(`Queue: ${e.workerPool.queued}`)),e.memory&&i.push(`RAM: ${e.memory.used}MB`),n.textContent=i.join(" | "),n.classList.add("show")}dispose(){this.healthMonitoring.interval&&(clearInterval(this.healthMonitoring.interval),this.healthMonitoring.interval=null,this.healthMonitoring.enabled=!1),this.editors.forEach(e=>{e.virtualRenderer&&e.virtualRenderer.dispose(),e.dispose()}),this.editors.clear(),this.diffEditor&&(this.diffEditor.dispose(),this.diffEditor=null),this.workerPool&&this.workerPool.terminate(),this.searchIndex&&typeof this.searchIndex.clear=="function"&&this.searchIndex.clear(),this.findWidgetIntegration&&(this.handleFindWidgetRemoval(),this.findWidgetIntegration.observer&&(this.findWidgetIntegration.observer.disconnect(),this.findWidgetIntegration.observer=null),this.findWidgetIntegration.searchDebounce&&(clearTimeout(this.findWidgetIntegration.searchDebounce),this.findWidgetIntegration.searchDebounce=null),this.findWidgetIntegration=null),this.isInitialized=!1}}const monacoInitializer=new MonacoInitializer;let monacoInitializationPromise=null,monacoReadyEventDispatched=!1;function dispatchMonacoReadyEvent(){if(monacoReadyEventDispatched||(monacoReadyEventDispatched=!0,typeof window>"u"||typeof window.dispatchEvent!="function"))return;let t=null;typeof window.CustomEvent=="function"?t=new CustomEvent("monaco:ready",{detail:{initializer:monacoInitializer}}):typeof document<"u"&&typeof document.createEvent=="function"&&(t=document.createEvent("Event"),t.initEvent("monaco:ready",!1,!1),t.detail={initializer:monacoInitializer}),t&&window.dispatchEvent(t)}function bootstrapMonacoInitializer(){if(!monacoInitializationPromise){try{monacoInitializationPromise=monacoInitializer.initialize()}catch(t){console.error(t),monacoInitializationPromise=Promise.reject(t)}monacoInitializationPromise.then(dispatchMonacoReadyEvent).catch(t=>{console.error(t)})}return monacoInitializationPromise}window.addEventListener("monaco:loaded",()=>{console.log("\u{1F680} [Lazy Init] monaco:loaded event received, initializing editor..."),bootstrapMonacoInitializer()}),window.bootstrapMonacoInitializer=bootstrapMonacoInitializer,typeof window<"u"&&(window.monacoInitializer=monacoInitializer,window.renderHistoryModal=renderHistoryModal);
