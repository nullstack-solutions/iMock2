"use strict";const Logger=(function(){const e={DEBUG:0,INFO:1,WARN:2,ERROR:3,SILENT:4};let t=e.WARN;const n={API:"\u{1F517}",CACHE:"\u{1F9E9}",DEMO:"\u{1F9EA}",EDITOR:"\u{1F4DD}",EVENTS:"\u{1F4E2}",FEATURES:"\u{1F9E0}",FILTERS:"\u{1F50D}",HEALTH:"\u{1F493}",MANAGERS:"\u{1F9ED}",METADATA:"\u{1F4C5}",OPS:"\u{1F6E0}\uFE0F",OPTIMISTIC:"\u{1F3AF}",PAGINATION:"\u2194\uFE0F",QUERY:"\u2753",RECORDING:"\u23FA\uFE0F",REQUESTS:"\u{1F4E1}",SCENARIOS:"\u{1F3AC}",STATE:"\u{1F310}",STORE:"\u{1F5C2}\uFE0F",SYNC:"\u{1F504}",TEMPLATES:"\u{1F9FE}",UI:"\u{1F5A5}\uFE0F",DEFAULT:"\u{1F4CB}"};function a(){try{const s=localStorage.getItem("imock-log-level");s&&e[s.toUpperCase()]!==void 0&&(t=e[s.toUpperCase()])}catch{}}function o(s,...d){const g=n[s]||n.DEFAULT;return[`[${new Date().toISOString().substring(11,23)}] ${g} [${s}]`,...d]}function r(s){const d=(s||"").toUpperCase();if(e[d]!==void 0){t=e[d];try{localStorage.setItem("imock-log-level",d)}catch{}}}const c={LEVELS:e,setLevel:r,debug:(s,...d)=>{t<=e.DEBUG&&console.log(...o(s,...d))},info:(s,...d)=>{t<=e.INFO&&console.info(...o(s,...d))},warn:(s,...d)=>{t<=e.WARN&&console.warn(...o(s,...d))},error:(s,...d)=>{t<=e.ERROR&&console.error(...o(s,...d))},api:(...s)=>c.debug("API",...s),cache:(...s)=>c.debug("CACHE",...s),ui:(...s)=>c.debug("UI",...s)};return a(),c})();window.Logger=Logger,(function(t){const n=[{id:"happy-get-resource",title:"GET Resource",description:"Return a resource by id with templated fields.",category:"happy-path",highlight:"GET \xB7 /api/resources/{id}",feature:{path:["response","jsonBody","id"],label:"response.jsonBody.id"},content:{request:{method:"GET",urlPathPattern:"/api/resources/[a-f0-9-]+"},response:{status:200,headers:{"Content-Type":"application/json"},jsonBody:{id:"{{request.pathSegments.[2]}}",name:"Example Resource",createdAt:"{{now}}"},transformers:["response-template"]}}},{id:"happy-post-create",title:"POST Create (201)",description:"Create a new resource with Location header.",category:"happy-path",highlight:"POST \xB7 /api/resources",feature:{path:["response","headers","Location"],label:"response.headers.Location"},popular:!0,content:{request:{method:"POST",urlPath:"/api/resources",headers:{"Content-Type":{equalTo:"application/json"}}},response:{status:201,headers:{"Content-Type":"application/json",Location:"/api/resources/{{randomValue type='UUID'}}"},jsonBody:{id:"{{randomValue type='UUID'}}",message:"Resource created"},transformers:["response-template"]}}},{id:"error-400-validation",title:"400 Bad Request",description:"Validation error example for POST payloads.",category:"errors",highlight:"POST \xB7 /api/resources \xB7 400",content:{request:{method:"POST",urlPath:"/api/resources",bodyPatterns:[{matchesJsonPath:"$[?(!@.name)]"}]},response:{status:400,jsonBody:{error:"Bad Request",details:[{field:"name",error:"required"}]}}}},{id:"error-401-unauthorized",title:"401 Unauthorized",description:"Missing or invalid auth header.",category:"errors",highlight:"ANY \xB7 /api/* \xB7 401",content:{request:{method:"ANY",urlPathPattern:"/api/.*",headers:{Authorization:{absent:!0}}},response:{status:401,headers:{"WWW-Authenticate":'Bearer realm="api"'},jsonBody:{error:"Unauthorized"}}}},{id:"error-404-not-found",title:"404 Not Found",description:"Simple not-found stub for missing resources.",category:"errors",highlight:"GET \xB7 /api/resources/non-existent",content:{request:{method:"GET",urlPath:"/api/resources/non-existent"},response:{status:404,jsonBody:{error:"Not Found"}}}},{id:"error-429-rate-limit",title:"429 Rate Limit",description:"Throttle response with retry guidance.",category:"errors",highlight:"ANY \xB7 429 Too Many Requests",popular:!0,content:{request:{method:"ANY",urlPattern:"/api/.*"},response:{status:429,headers:{"Retry-After":"60","X-RateLimit-Remaining":"0"},jsonBody:{error:"Too Many Requests"}}}},{id:"fault-fixed-delay",title:"Fixed Delay",description:"Deterministic slow response.",category:"faults",highlight:"GET \xB7 /api/slow \xB7 delay",feature:{path:["response","fixedDelayMilliseconds"],label:"response.fixedDelayMilliseconds"},content:{request:{method:"GET",urlPath:"/api/slow"},response:{status:200,fixedDelayMilliseconds:5e3,jsonBody:{message:"Delayed"}}}},{id:"fault-random-delay-uniform",title:"Random Delay (Uniform)",description:"Variable latency within bounds.",category:"faults",highlight:"ANY \xB7 delayDistribution.uniform",content:{request:{method:"GET",urlPath:"/api/variable-latency"},response:{status:200,delayDistribution:{type:"uniform",lower:500,upper:2e3}}}},{id:"fault-random-delay-lognormal",title:"Random Delay (Lognormal)",description:"Realistic latency distribution.",category:"faults",highlight:"ANY \xB7 delayDistribution.lognormal",content:{request:{method:"GET",urlPath:"/api/realistic-latency"},response:{status:200,delayDistribution:{type:"lognormal",median:100,sigma:.4}}}},{id:"fault-chunked-dribble",title:"Chunked Dribble",description:"Slow streaming response.",category:"faults",highlight:"GET \xB7 /api/slow-download",content:{request:{method:"GET",urlPath:"/api/slow-download"},response:{status:200,body:"Slow response...",chunkedDribbleDelay:{numberOfChunks:10,totalDuration:5e3}}}},{id:"fault-connection-reset",title:"Connection Reset",description:"Simulate TCP reset failure.",category:"faults",highlight:"GET \xB7 /api/reset \xB7 fault",popular:!0,content:{request:{method:"GET",urlPath:"/api/reset"},response:{fault:"CONNECTION_RESET_BY_PEER"}}},{id:"fault-empty-response",title:"Empty Response",description:"Return no body to mimic dropped payloads.",category:"faults",highlight:"ANY \xB7 fault: EMPTY_RESPONSE",content:{request:{method:"GET",urlPath:"/api/empty"},response:{status:200,fault:"EMPTY_RESPONSE"}}},{id:"fault-malformed-response",title:"Malformed Response",description:"Corrupted chunk fault.",category:"faults",highlight:"ANY \xB7 fault: MALFORMED_RESPONSE_CHUNK",content:{request:{method:"GET",urlPath:"/api/corrupt"},response:{status:200,fault:"MALFORMED_RESPONSE_CHUNK"}}},{id:"scenario-retry-500-200",title:"Retry: 500 \u2192 200",description:"First call fails, retry succeeds.",category:"scenarios",highlight:"Scenario \xB7 /api/flaky",popular:!0,content:{mappings:[{scenarioName:"Retry_Scenario",requiredScenarioState:"Started",newScenarioState:"Recovered",request:{method:"GET",urlPath:"/api/flaky"},response:{status:500,jsonBody:{error:"Temporary failure"}}},{scenarioName:"Retry_Scenario",requiredScenarioState:"Recovered",request:{method:"GET",urlPath:"/api/flaky"},response:{status:200,jsonBody:{message:"Success"}}}]}},{id:"scenario-todo-workflow",title:"Todo List Workflow",description:"Create \u2192 Read \u2192 Update lifecycle.",category:"scenarios",highlight:"Scenario \xB7 /todo/items",content:{mappings:[{scenarioName:"todo_list",requiredScenarioState:"Started",request:{method:"GET",url:"/todo/items"},response:{status:200,jsonBody:{items:["Buy milk"]}}},{scenarioName:"todo_list",requiredScenarioState:"Started",newScenarioState:"Item added",request:{method:"POST",url:"/todo/items",bodyPatterns:[{contains:"Cancel subscription"}]},response:{status:201}},{scenarioName:"todo_list",requiredScenarioState:"Item added",request:{method:"GET",url:"/todo/items"},response:{status:200,jsonBody:{items:["Buy milk","Cancel subscription"]}}}]}},{id:"scenario-order-lifecycle",title:"Order Lifecycle",description:"Order status across states.",category:"scenarios",highlight:"Scenario \xB7 /orders/123/status",content:{mappings:[{scenarioName:"Order_Status",requiredScenarioState:"Started",newScenarioState:"Processing",request:{method:"GET",urlPath:"/orders/123/status"},response:{status:200,jsonBody:{status:"pending"}}},{scenarioName:"Order_Status",requiredScenarioState:"Processing",newScenarioState:"Shipped",request:{method:"GET",urlPath:"/orders/123/status"},response:{status:200,jsonBody:{status:"processing"}}},{scenarioName:"Order_Status",requiredScenarioState:"Shipped",request:{method:"GET",urlPath:"/orders/123/status"},response:{status:200,jsonBody:{status:"shipped"}}}]}},{id:"dynamic-echo-request",title:"Echo Request",description:"Reflect request values in the response.",category:"dynamic",highlight:"ANY \xB7 /api/echo/*",feature:{path:["response","jsonBody","path"],label:"response.jsonBody.*"},popular:!0,content:{request:{method:"ANY",urlPathPattern:"/api/echo/.*"},response:{status:200,jsonBody:{path:"{{request.path}}",query:"{{request.query.q}}",header:"{{request.headers.X-Custom}}",timestamp:"{{now}}"},transformers:["response-template"]}}},{id:"dynamic-jsonpath-extract",title:"JSONPath Extract",description:"Use JSONPath to pull fields from the request body.",category:"dynamic",highlight:"POST \xB7 /api/process",content:{request:{method:"POST",urlPath:"/api/process"},response:{status:200,body:`{"name": "{{jsonPath request.body '$.name'}}"}`,transformers:["response-template"]}}},{id:"dynamic-random-values",title:"Random Values",description:"Generate UUIDs, codes, and numbers in the response.",category:"dynamic",highlight:"ANY \xB7 response-template random values",content:{request:{method:"GET",urlPath:"/api/generate"},response:{status:200,jsonBody:{uuid:"{{randomValue type='UUID'}}",code:"{{randomValue length=8 type='ALPHANUMERIC'}}",number:"{{randomInt lower=1 upper=100}}",type:"ORDER_ACCEPTED",orderId:"{{jsonPath request.body '$.orderId'}}",occurredAt:`{{now offset='0' pattern=\\"yyyy-MM-dd'T'HH:mm:ssXXX\\"}}`},transformers:["response-template"]}}},{id:"match-url-regex",title:"URL Pattern (Regex)",description:"Regex path matcher for numeric IDs.",category:"matching",highlight:"GET \xB7 /api/users/{id}/orders/{orderId}",content:{request:{method:"GET",urlPathPattern:"/api/users/[0-9]+/orders/[a-f0-9-]+"}}},{id:"match-query-params",title:"Query Parameters",description:"Match search params with combinations.",category:"matching",highlight:"GET \xB7 /api/search?q=\u2026",popular:!0,content:{request:{method:"GET",urlPath:"/api/search",queryParameters:{q:{matches:".+"},page:{equalTo:"1"},limit:{or:[{equalTo:"10"},{equalTo:"20"}]}}},response:{status:200}}},{id:"match-headers",title:"Headers",description:"Match requests by required headers.",category:"matching",highlight:"ANY \xB7 header matchers",content:{request:{method:"ANY",urlPath:"/api/data",headers:{Accept:{contains:"application/json"},Authorization:{matches:"Bearer .+"}}},response:{status:200}}},{id:"match-json-equal",title:"JSON Body (equalToJson)",description:"Semantic JSON comparison with json-unit helpers.",category:"matching",highlight:"POST \xB7 equalToJson",content:{request:{method:"POST",urlPath:"/api/orders",bodyPatterns:[{equalToJson:{customerId:"${json-unit.any-string}",total:"${json-unit.any-number}"},ignoreArrayOrder:!0,ignoreExtraElements:!0}]},response:{status:201}}},{id:"match-jsonpath",title:"JSONPath",description:"Multiple JSONPath checks in one stub.",category:"matching",highlight:"POST \xB7 matchesJsonPath",content:{request:{method:"POST",urlPath:"/api/events",bodyPatterns:[{matchesJsonPath:"$.type"},{matchesJsonPath:"$[?(@.priority > 5)]"},{matchesJsonPath:{expression:"$.email",contains:"@example.com"}}]},response:{status:200}}},{id:"match-basic-auth",title:"Basic Auth",description:"Protect endpoints with HTTP Basic Auth.",category:"matching",highlight:"ANY \xB7 basicAuthCredentials",content:{request:{method:"GET",urlPath:"/api/secure",basicAuthCredentials:{username:"admin",password:"secret"}},response:{status:200}}},{id:"webhook-simple",title:"Simple Webhook",description:"Send a POST callback after accepting a request.",category:"webhooks",highlight:"POST \xB7 /api/trigger \xB7 webhook",popular:!0,content:{request:{method:"POST",urlPath:"/api/trigger"},response:{status:202},serveEventListeners:[{name:"webhook",parameters:{method:"POST",url:"http://callback-service/webhook",headers:{"Content-Type":"application/json"},body:'{"status": "complete"}'}}]}},{id:"webhook-templated",title:"Templated Webhook",description:"Populate webhook payload from the original request.",category:"webhooks",highlight:"POST \xB7 templated callback",content:{request:{method:"POST",urlPath:"/api/orders"},response:{status:202},serveEventListeners:[{name:"webhook",parameters:{url:"{{jsonPath originalRequest.body '$.callbackUrl'}}",body:`{"orderId": "{{jsonPath originalRequest.body '$.orderId'}}"}`}}]}},{id:"webhook-delayed",title:"Delayed Webhook",description:"Schedule a callback after a fixed delay.",category:"webhooks",highlight:"POST \xB7 delay \u2192 webhook",content:{request:{method:"POST",urlPath:"/api/async-job"},response:{status:202},serveEventListeners:[{name:"webhook",parameters:{url:"http://service/callback",delay:{type:"fixed",milliseconds:5e3}}}]}},{id:"proxy-full",title:"Full Proxy",description:"Pass all traffic through to an upstream API.",category:"proxy",highlight:"ANY \xB7 /api/* \u2192 proxy",popular:!0,content:{priority:10,request:{method:"ANY",urlPattern:"/api/.*"},response:{status:200,proxyBaseUrl:"https://api.example.com"}}},{id:"proxy-override",title:"Proxy + Override",description:"Forward with extra headers or overrides.",category:"proxy",highlight:"ANY \xB7 proxy with headers",content:{priority:100,request:{method:"ANY",urlPattern:"/api/.*"},response:{status:200,proxyBaseUrl:"https://api.example.com",additionalProxyRequestHeaders:{"X-Forwarded-By":"WireMock"}}}},{id:"proxy-start-recording",title:"Start Recording",description:"Record traffic for snapshotting stubs.",category:"proxy",highlight:"ADMIN \xB7 recording",content:{request:{method:"POST",urlPath:"/__admin/recordings/start"},response:{status:200},targetBaseUrl:"https://api.example.com",captureHeaders:{Accept:{},Authorization:{caseInsensitive:!0}},requestBodyPattern:{matcher:"equalToJson",ignoreArrayOrder:!0},persist:!0,repeatsAsScenarios:!0}}];function a(c){return JSON.parse(JSON.stringify(c))}function o(c){if(!c||typeof c!="object")throw new Error("Template must be an object");if(!c.id)throw new Error("Template requires an id");return JSON.parse(JSON.stringify(c))}const r={getAll(){return n.map(a)},findById(c){return n.find(s=>s.id===c)||null},register(c){const s=o(c),d=n.findIndex(g=>g.id===s.id);return d>=0?n[d]=s:n.push(s),this.getAll()},replaceAll(c){if(!Array.isArray(c))throw new Error("replaceAll expects an array of templates");n.length=0;for(const s of c)n.push(JSON.parse(JSON.stringify(s)));return this.getAll()}};Object.freeze(r),t.MonacoTemplateLibrary||Object.defineProperty(t,"MonacoTemplateLibrary",{value:r,configurable:!1,enumerable:!0,writable:!1})})(typeof window<"u"?window:globalThis);/*! js-yaml 4.1.0 https://github.com/nodeca/js-yaml @license MIT */(function(e,t){typeof exports=="object"&&typeof module<"u"?t(exports):typeof define=="function"&&define.amd?define(["exports"],t):t((e=typeof globalThis<"u"?globalThis:e||self).jsyaml={})})(this,(function(e){"use strict";function t(i){return i==null}var n={isNothing:t,isObject:function(i){return typeof i=="object"&&i!==null},toArray:function(i){return Array.isArray(i)?i:t(i)?[]:[i]},repeat:function(i,l){var p,h="";for(p=0;p<l;p+=1)h+=i;return h},isNegativeZero:function(i){return i===0&&Number.NEGATIVE_INFINITY===1/i},extend:function(i,l){var p,h,m,T;if(l)for(p=0,h=(T=Object.keys(l)).length;p<h;p+=1)i[m=T[p]]=l[m];return i}};function a(i,l){var p="",h=i.reason||"(unknown reason)";return i.mark?(i.mark.name&&(p+='in "'+i.mark.name+'" '),p+="("+(i.mark.line+1)+":"+(i.mark.column+1)+")",!l&&i.mark.snippet&&(p+=`

`+i.mark.snippet),h+" "+p):h}function o(i,l){Error.call(this),this.name="YAMLException",this.reason=i,this.mark=l,this.message=a(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}o.prototype=Object.create(Error.prototype),o.prototype.constructor=o,o.prototype.toString=function(i){return this.name+": "+a(this,i)};var r=o;function c(i,l,p,h,m){var T="",A="",C=Math.floor(m/2)-1;return h-l>C&&(l=h-C+(T=" ... ").length),p-h>C&&(p=h+C-(A=" ...").length),{str:T+i.slice(l,p).replace(/\t/g,"\u2192")+A,pos:h-l+T.length}}function s(i,l){return n.repeat(" ",l-i.length)+i}var d=function(i,l){if(l=Object.create(l||null),!i.buffer)return null;l.maxLength||(l.maxLength=79),typeof l.indent!="number"&&(l.indent=1),typeof l.linesBefore!="number"&&(l.linesBefore=3),typeof l.linesAfter!="number"&&(l.linesAfter=2);for(var p,h=/\r?\n|\r|\0/g,m=[0],T=[],A=-1;p=h.exec(i.buffer);)T.push(p.index),m.push(p.index+p[0].length),i.position<=p.index&&A<0&&(A=m.length-2);A<0&&(A=m.length-1);var C,q,z="",V=Math.min(i.line+l.linesAfter,T.length).toString().length,X=l.maxLength-(l.indent+V+3);for(C=1;C<=l.linesBefore&&!(A-C<0);C++)q=c(i.buffer,m[A-C],T[A-C],i.position-(m[A]-m[A-C]),X),z=n.repeat(" ",l.indent)+s((i.line-C+1).toString(),V)+" | "+q.str+`
`+z;for(q=c(i.buffer,m[A],T[A],i.position,X),z+=n.repeat(" ",l.indent)+s((i.line+1).toString(),V)+" | "+q.str+`
`,z+=n.repeat("-",l.indent+V+3+q.pos)+`^
`,C=1;C<=l.linesAfter&&!(A+C>=T.length);C++)q=c(i.buffer,m[A+C],T[A+C],i.position-(m[A]-m[A+C]),X),z+=n.repeat(" ",l.indent)+s((i.line+C+1).toString(),V)+" | "+q.str+`
`;return z.replace(/\n$/,"")},g=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],E=["scalar","sequence","mapping"],b=function(i,l){if(l=l||{},Object.keys(l).forEach((function(p){if(g.indexOf(p)===-1)throw new r('Unknown option "'+p+'" is met in definition of "'+i+'" YAML type.')})),this.options=l,this.tag=i,this.kind=l.kind||null,this.resolve=l.resolve||function(){return!0},this.construct=l.construct||function(p){return p},this.instanceOf=l.instanceOf||null,this.predicate=l.predicate||null,this.represent=l.represent||null,this.representName=l.representName||null,this.defaultStyle=l.defaultStyle||null,this.multi=l.multi||!1,this.styleAliases=(function(p){var h={};return p!==null&&Object.keys(p).forEach((function(m){p[m].forEach((function(T){h[String(T)]=m}))})),h})(l.styleAliases||null),E.indexOf(this.kind)===-1)throw new r('Unknown kind "'+this.kind+'" is specified for "'+i+'" YAML type.')};function S(i,l){var p=[];return i[l].forEach((function(h){var m=p.length;p.forEach((function(T,A){T.tag===h.tag&&T.kind===h.kind&&T.multi===h.multi&&(m=A)})),p[m]=h})),p}function I(i){return this.extend(i)}I.prototype.extend=function(i){var l=[],p=[];if(i instanceof b)p.push(i);else if(Array.isArray(i))p=p.concat(i);else{if(!i||!Array.isArray(i.implicit)&&!Array.isArray(i.explicit))throw new r("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");i.implicit&&(l=l.concat(i.implicit)),i.explicit&&(p=p.concat(i.explicit))}l.forEach((function(m){if(!(m instanceof b))throw new r("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(m.loadKind&&m.loadKind!=="scalar")throw new r("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(m.multi)throw new r("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")})),p.forEach((function(m){if(!(m instanceof b))throw new r("Specified list of YAML types (or a single Type object) contains a non-Type object.")}));var h=Object.create(I.prototype);return h.implicit=(this.implicit||[]).concat(l),h.explicit=(this.explicit||[]).concat(p),h.compiledImplicit=S(h,"implicit"),h.compiledExplicit=S(h,"explicit"),h.compiledTypeMap=(function(){var m,T,A={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}};function C(q){q.multi?(A.multi[q.kind].push(q),A.multi.fallback.push(q)):A[q.kind][q.tag]=A.fallback[q.tag]=q}for(m=0,T=arguments.length;m<T;m+=1)arguments[m].forEach(C);return A})(h.compiledImplicit,h.compiledExplicit),h};var L=I,B=new b("tag:yaml.org,2002:str",{kind:"scalar",construct:function(i){return i!==null?i:""}}),M=new b("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(i){return i!==null?i:[]}}),w=new b("tag:yaml.org,2002:map",{kind:"mapping",construct:function(i){return i!==null?i:{}}}),D=new L({explicit:[B,M,w]}),O=new b("tag:yaml.org,2002:null",{kind:"scalar",resolve:function(i){if(i===null)return!0;var l=i.length;return l===1&&i==="~"||l===4&&(i==="null"||i==="Null"||i==="NULL")},construct:function(){return null},predicate:function(i){return i===null},represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"}),Q=new b("tag:yaml.org,2002:bool",{kind:"scalar",resolve:function(i){if(i===null)return!1;var l=i.length;return l===4&&(i==="true"||i==="True"||i==="TRUE")||l===5&&(i==="false"||i==="False"||i==="FALSE")},construct:function(i){return i==="true"||i==="True"||i==="TRUE"},predicate:function(i){return Object.prototype.toString.call(i)==="[object Boolean]"},represent:{lowercase:function(i){return i?"true":"false"},uppercase:function(i){return i?"TRUE":"FALSE"},camelcase:function(i){return i?"True":"False"}},defaultStyle:"lowercase"});function de(i){return 48<=i&&i<=55}function se(i){return 48<=i&&i<=57}var be=new b("tag:yaml.org,2002:int",{kind:"scalar",resolve:function(i){if(i===null)return!1;var l,p,h=i.length,m=0,T=!1;if(!h)return!1;if((l=i[m])!=="-"&&l!=="+"||(l=i[++m]),l==="0"){if(m+1===h)return!0;if((l=i[++m])==="b"){for(m++;m<h;m++)if((l=i[m])!=="_"){if(l!=="0"&&l!=="1")return!1;T=!0}return T&&l!=="_"}if(l==="x"){for(m++;m<h;m++)if((l=i[m])!=="_"){if(!(48<=(p=i.charCodeAt(m))&&p<=57||65<=p&&p<=70||97<=p&&p<=102))return!1;T=!0}return T&&l!=="_"}if(l==="o"){for(m++;m<h;m++)if((l=i[m])!=="_"){if(!de(i.charCodeAt(m)))return!1;T=!0}return T&&l!=="_"}}if(l==="_")return!1;for(;m<h;m++)if((l=i[m])!=="_"){if(!se(i.charCodeAt(m)))return!1;T=!0}return!(!T||l==="_")},construct:function(i){var l,p=i,h=1;if(p.indexOf("_")!==-1&&(p=p.replace(/_/g,"")),(l=p[0])!=="-"&&l!=="+"||(l==="-"&&(h=-1),l=(p=p.slice(1))[0]),p==="0")return 0;if(l==="0"){if(p[1]==="b")return h*parseInt(p.slice(2),2);if(p[1]==="x")return h*parseInt(p.slice(2),16);if(p[1]==="o")return h*parseInt(p.slice(2),8)}return h*parseInt(p,10)},predicate:function(i){return Object.prototype.toString.call(i)==="[object Number]"&&i%1==0&&!n.isNegativeZero(i)},represent:{binary:function(i){return i>=0?"0b"+i.toString(2):"-0b"+i.toString(2).slice(1)},octal:function(i){return i>=0?"0o"+i.toString(8):"-0o"+i.toString(8).slice(1)},decimal:function(i){return i.toString(10)},hexadecimal:function(i){return i>=0?"0x"+i.toString(16).toUpperCase():"-0x"+i.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),Ne=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$"),U=/^[-+]?[0-9]+e/,H=new b("tag:yaml.org,2002:float",{kind:"scalar",resolve:function(i){return i!==null&&!(!Ne.test(i)||i[i.length-1]==="_")},construct:function(i){var l,p;return p=(l=i.replace(/_/g,"").toLowerCase())[0]==="-"?-1:1,"+-".indexOf(l[0])>=0&&(l=l.slice(1)),l===".inf"?p===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:l===".nan"?NaN:p*parseFloat(l,10)},predicate:function(i){return Object.prototype.toString.call(i)==="[object Number]"&&(i%1!=0||n.isNegativeZero(i))},represent:function(i,l){var p;if(isNaN(i))switch(l){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===i)switch(l){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===i)switch(l){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(n.isNegativeZero(i))return"-0.0";return p=i.toString(10),U.test(p)?p.replace("e",".e"):p},defaultStyle:"lowercase"}),P=D.extend({implicit:[O,Q,be,H]}),y=P,N=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),$=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$"),G=new b("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:function(i){return i!==null&&(N.exec(i)!==null||$.exec(i)!==null)},construct:function(i){var l,p,h,m,T,A,C,q,z=0,V=null;if((l=N.exec(i))===null&&(l=$.exec(i)),l===null)throw new Error("Date resolve error");if(p=+l[1],h=+l[2]-1,m=+l[3],!l[4])return new Date(Date.UTC(p,h,m));if(T=+l[4],A=+l[5],C=+l[6],l[7]){for(z=l[7].slice(0,3);z.length<3;)z+="0";z=+z}return l[9]&&(V=6e4*(60*+l[10]+ +(l[11]||0)),l[9]==="-"&&(V=-V)),q=new Date(Date.UTC(p,h,m,T,A,C,z)),V&&q.setTime(q.getTime()-V),q},instanceOf:Date,represent:function(i){return i.toISOString()}}),fe=new b("tag:yaml.org,2002:merge",{kind:"scalar",resolve:function(i){return i==="<<"||i===null}}),Pe=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`,et=new b("tag:yaml.org,2002:binary",{kind:"scalar",resolve:function(i){if(i===null)return!1;var l,p,h=0,m=i.length,T=Pe;for(p=0;p<m;p++)if(!((l=T.indexOf(i.charAt(p)))>64)){if(l<0)return!1;h+=6}return h%8==0},construct:function(i){var l,p,h=i.replace(/[\r\n=]/g,""),m=h.length,T=Pe,A=0,C=[];for(l=0;l<m;l++)l%4==0&&l&&(C.push(A>>16&255),C.push(A>>8&255),C.push(255&A)),A=A<<6|T.indexOf(h.charAt(l));return(p=m%4*6)===0?(C.push(A>>16&255),C.push(A>>8&255),C.push(255&A)):p===18?(C.push(A>>10&255),C.push(A>>2&255)):p===12&&C.push(A>>4&255),new Uint8Array(C)},predicate:function(i){return Object.prototype.toString.call(i)==="[object Uint8Array]"},represent:function(i){var l,p,h="",m=0,T=i.length,A=Pe;for(l=0;l<T;l++)l%3==0&&l&&(h+=A[m>>18&63],h+=A[m>>12&63],h+=A[m>>6&63],h+=A[63&m]),m=(m<<8)+i[l];return(p=T%3)===0?(h+=A[m>>18&63],h+=A[m>>12&63],h+=A[m>>6&63],h+=A[63&m]):p===2?(h+=A[m>>10&63],h+=A[m>>4&63],h+=A[m<<2&63],h+=A[64]):p===1&&(h+=A[m>>2&63],h+=A[m<<4&63],h+=A[64],h+=A[64]),h}}),Oe=Object.prototype.hasOwnProperty,Ge=Object.prototype.toString,tt=new b("tag:yaml.org,2002:omap",{kind:"sequence",resolve:function(i){if(i===null)return!0;var l,p,h,m,T,A=[],C=i;for(l=0,p=C.length;l<p;l+=1){if(h=C[l],T=!1,Ge.call(h)!=="[object Object]")return!1;for(m in h)if(Oe.call(h,m)){if(T)return!1;T=!0}if(!T||A.indexOf(m)!==-1)return!1;A.push(m)}return!0},construct:function(i){return i!==null?i:[]}}),St=Object.prototype.toString,Je=new b("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:function(i){if(i===null)return!0;var l,p,h,m,T,A=i;for(T=new Array(A.length),l=0,p=A.length;l<p;l+=1){if(h=A[l],St.call(h)!=="[object Object]"||(m=Object.keys(h)).length!==1)return!1;T[l]=[m[0],h[m[0]]]}return!0},construct:function(i){if(i===null)return[];var l,p,h,m,T,A=i;for(T=new Array(A.length),l=0,p=A.length;l<p;l+=1)h=A[l],m=Object.keys(h),T[l]=[m[0],h[m[0]]];return T}}),Et=Object.prototype.hasOwnProperty,Be=new b("tag:yaml.org,2002:set",{kind:"mapping",resolve:function(i){if(i===null)return!0;var l,p=i;for(l in p)if(Et.call(p,l)&&p[l]!==null)return!1;return!0},construct:function(i){return i!==null?i:{}}}),nt=y.extend({implicit:[G,fe],explicit:[et,tt,Je,Be]}),ae=Object.prototype.hasOwnProperty,Me=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,je=/[\x85\u2028\u2029]/,Fe=/[,\[\]\{\}]/,Ye=/^(?:!|!!|![a-z\-]+!)$/i,Ve=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function We(i){return Object.prototype.toString.call(i)}function Ie(i){return i===10||i===13}function qe(i){return i===9||i===32}function Se(i){return i===9||i===32||i===10||i===13}function He(i){return i===44||i===91||i===93||i===123||i===125}function mt(i){var l;return 48<=i&&i<=57?i-48:97<=(l=32|i)&&l<=102?l-97+10:-1}function st(i){return i===48?"\0":i===97?"\x07":i===98?"\b":i===116||i===9?"	":i===110?`
`:i===118?"\v":i===102?"\f":i===114?"\r":i===101?"\x1B":i===32?" ":i===34?'"':i===47?"/":i===92?"\\":i===78?"\x85":i===95?"\xA0":i===76?"\u2028":i===80?"\u2029":""}function ct(i){return i<=65535?String.fromCharCode(i):String.fromCharCode(55296+(i-65536>>10),56320+(i-65536&1023))}for(var lt=new Array(256),dt=new Array(256),ke=0;ke<256;ke++)lt[ke]=st(ke)?1:0,dt[ke]=st(ke);function gt(i,l){this.input=i,this.filename=l.filename||null,this.schema=l.schema||nt,this.onWarning=l.onWarning||null,this.legacy=l.legacy||!1,this.json=l.json||!1,this.listener=l.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=i.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function bt(i,l){var p={name:i.filename,buffer:i.input.slice(0,-1),position:i.position,line:i.line,column:i.position-i.lineStart};return p.snippet=d(p),new r(l,p)}function W(i,l){throw bt(i,l)}function ut(i,l){i.onWarning&&i.onWarning.call(null,bt(i,l))}var it={YAML:function(i,l,p){var h,m,T;i.version!==null&&W(i,"duplication of %YAML directive"),p.length!==1&&W(i,"YAML directive accepts exactly one argument"),(h=/^([0-9]+)\.([0-9]+)$/.exec(p[0]))===null&&W(i,"ill-formed argument of the YAML directive"),m=parseInt(h[1],10),T=parseInt(h[2],10),m!==1&&W(i,"unacceptable YAML version of the document"),i.version=p[0],i.checkLineBreaks=T<2,T!==1&&T!==2&&ut(i,"unsupported YAML version of the document")},TAG:function(i,l,p){var h,m;p.length!==2&&W(i,"TAG directive accepts exactly two arguments"),h=p[0],m=p[1],Ye.test(h)||W(i,"ill-formed tag handle (first argument) of the TAG directive"),ae.call(i.tagMap,h)&&W(i,'there is a previously declared suffix for "'+h+'" tag handle'),Ve.test(m)||W(i,"ill-formed tag prefix (second argument) of the TAG directive");try{m=decodeURIComponent(m)}catch{W(i,"tag prefix is malformed: "+m)}i.tagMap[h]=m}};function ze(i,l,p,h){var m,T,A,C;if(l<p){if(C=i.input.slice(l,p),h)for(m=0,T=C.length;m<T;m+=1)(A=C.charCodeAt(m))===9||32<=A&&A<=1114111||W(i,"expected valid JSON character");else Me.test(C)&&W(i,"the stream contains non-printable characters");i.result+=C}}function ht(i,l,p,h){var m,T,A,C;for(n.isObject(p)||W(i,"cannot merge mappings; the provided source object is unacceptable"),A=0,C=(m=Object.keys(p)).length;A<C;A+=1)T=m[A],ae.call(l,T)||(l[T]=p[T],h[T]=!0)}function Ke(i,l,p,h,m,T,A,C,q){var z,V;if(Array.isArray(m))for(z=0,V=(m=Array.prototype.slice.call(m)).length;z<V;z+=1)Array.isArray(m[z])&&W(i,"nested arrays are not supported inside keys"),typeof m=="object"&&We(m[z])==="[object Object]"&&(m[z]="[object Object]");if(typeof m=="object"&&We(m)==="[object Object]"&&(m="[object Object]"),m=String(m),l===null&&(l={}),h==="tag:yaml.org,2002:merge")if(Array.isArray(T))for(z=0,V=T.length;z<V;z+=1)ht(i,l,T[z],p);else ht(i,l,T,p);else i.json||ae.call(p,m)||!ae.call(l,m)||(i.line=A||i.line,i.lineStart=C||i.lineStart,i.position=q||i.position,W(i,"duplicated mapping key")),m==="__proto__"?Object.defineProperty(l,m,{configurable:!0,enumerable:!0,writable:!0,value:T}):l[m]=T,delete p[m];return l}function wt(i){var l;(l=i.input.charCodeAt(i.position))===10?i.position++:l===13?(i.position++,i.input.charCodeAt(i.position)===10&&i.position++):W(i,"a line break is expected"),i.line+=1,i.lineStart=i.position,i.firstTabInLine=-1}function ye(i,l,p){for(var h=0,m=i.input.charCodeAt(i.position);m!==0;){for(;qe(m);)m===9&&i.firstTabInLine===-1&&(i.firstTabInLine=i.position),m=i.input.charCodeAt(++i.position);if(l&&m===35)do m=i.input.charCodeAt(++i.position);while(m!==10&&m!==13&&m!==0);if(!Ie(m))break;for(wt(i),m=i.input.charCodeAt(i.position),h++,i.lineIndent=0;m===32;)i.lineIndent++,m=i.input.charCodeAt(++i.position)}return p!==-1&&h!==0&&i.lineIndent<p&&ut(i,"deficient indentation"),h}function pt(i){var l,p=i.position;return!((l=i.input.charCodeAt(p))!==45&&l!==46||l!==i.input.charCodeAt(p+1)||l!==i.input.charCodeAt(p+2)||(p+=3,(l=i.input.charCodeAt(p))!==0&&!Se(l)))}function yt(i,l){l===1?i.result+=" ":l>1&&(i.result+=n.repeat(`
`,l-1))}function Mt(i,l){var p,h,m=i.tag,T=i.anchor,A=[],C=!1;if(i.firstTabInLine!==-1)return!1;for(i.anchor!==null&&(i.anchorMap[i.anchor]=A),h=i.input.charCodeAt(i.position);h!==0&&(i.firstTabInLine!==-1&&(i.position=i.firstTabInLine,W(i,"tab characters must not be used in indentation")),h===45)&&Se(i.input.charCodeAt(i.position+1));)if(C=!0,i.position++,ye(i,!0,-1)&&i.lineIndent<=l)A.push(null),h=i.input.charCodeAt(i.position);else if(p=i.line,Xe(i,l,3,!1,!0),A.push(i.result),ye(i,!0,-1),h=i.input.charCodeAt(i.position),(i.line===p||i.lineIndent>l)&&h!==0)W(i,"bad indentation of a sequence entry");else if(i.lineIndent<l)break;return!!C&&(i.tag=m,i.anchor=T,i.kind="sequence",i.result=A,!0)}function Te(i){var l,p,h,m,T=!1,A=!1;if((m=i.input.charCodeAt(i.position))!==33)return!1;if(i.tag!==null&&W(i,"duplication of a tag property"),(m=i.input.charCodeAt(++i.position))===60?(T=!0,m=i.input.charCodeAt(++i.position)):m===33?(A=!0,p="!!",m=i.input.charCodeAt(++i.position)):p="!",l=i.position,T){do m=i.input.charCodeAt(++i.position);while(m!==0&&m!==62);i.position<i.length?(h=i.input.slice(l,i.position),m=i.input.charCodeAt(++i.position)):W(i,"unexpected end of the stream within a verbatim tag")}else{for(;m!==0&&!Se(m);)m===33&&(A?W(i,"tag suffix cannot contain exclamation marks"):(p=i.input.slice(l-1,i.position+1),Ye.test(p)||W(i,"named tag handle cannot contain such characters"),A=!0,l=i.position+1)),m=i.input.charCodeAt(++i.position);h=i.input.slice(l,i.position),Fe.test(h)&&W(i,"tag suffix cannot contain flow indicator characters")}h&&!Ve.test(h)&&W(i,"tag name cannot contain such characters: "+h);try{h=decodeURIComponent(h)}catch{W(i,"tag name is malformed: "+h)}return T?i.tag=h:ae.call(i.tagMap,p)?i.tag=i.tagMap[p]+h:p==="!"?i.tag="!"+h:p==="!!"?i.tag="tag:yaml.org,2002:"+h:W(i,'undeclared tag handle "'+p+'"'),!0}function Tt(i){var l,p;if((p=i.input.charCodeAt(i.position))!==38)return!1;for(i.anchor!==null&&W(i,"duplication of an anchor property"),p=i.input.charCodeAt(++i.position),l=i.position;p!==0&&!Se(p)&&!He(p);)p=i.input.charCodeAt(++i.position);return i.position===l&&W(i,"name of an anchor node must contain at least one character"),i.anchor=i.input.slice(l,i.position),!0}function Xe(i,l,p,h,m){var T,A,C,q,z,V,X,we,J,me=1,pe=!1,ge=!1;if(i.listener!==null&&i.listener("open",i),i.tag=null,i.anchor=null,i.kind=null,i.result=null,T=A=C=p===4||p===3,h&&ye(i,!0,-1)&&(pe=!0,i.lineIndent>l?me=1:i.lineIndent===l?me=0:i.lineIndent<l&&(me=-1)),me===1)for(;Te(i)||Tt(i);)ye(i,!0,-1)?(pe=!0,C=T,i.lineIndent>l?me=1:i.lineIndent===l?me=0:i.lineIndent<l&&(me=-1)):C=!1;if(C&&(C=pe||m),me!==1&&p!==4||(we=p===1||p===2?l:l+1,J=i.position-i.lineStart,me===1?C&&(Mt(i,J)||(function(u,te,Z){var K,re,Y,ce,oe,ue,he,ie=u.tag,Ee=u.anchor,ve={},Ae=Object.create(null),Ue=null,_e=null,ot=null,Le=!1,ft=!1;if(u.firstTabInLine!==-1)return!1;for(u.anchor!==null&&(u.anchorMap[u.anchor]=ve),he=u.input.charCodeAt(u.position);he!==0;){if(Le||u.firstTabInLine===-1||(u.position=u.firstTabInLine,W(u,"tab characters must not be used in indentation")),K=u.input.charCodeAt(u.position+1),Y=u.line,he!==63&&he!==58||!Se(K)){if(ce=u.line,oe=u.lineStart,ue=u.position,!Xe(u,Z,2,!1,!0))break;if(u.line===Y){for(he=u.input.charCodeAt(u.position);qe(he);)he=u.input.charCodeAt(++u.position);if(he===58)Se(he=u.input.charCodeAt(++u.position))||W(u,"a whitespace character is expected after the key-value separator within a block mapping"),Le&&(Ke(u,ve,Ae,Ue,_e,null,ce,oe,ue),Ue=_e=ot=null),ft=!0,Le=!1,re=!1,Ue=u.tag,_e=u.result;else{if(!ft)return u.tag=ie,u.anchor=Ee,!0;W(u,"can not read an implicit mapping pair; a colon is missed")}}else{if(!ft)return u.tag=ie,u.anchor=Ee,!0;W(u,"can not read a block mapping entry; a multiline key may not be an implicit key")}}else he===63?(Le&&(Ke(u,ve,Ae,Ue,_e,null,ce,oe,ue),Ue=_e=ot=null),ft=!0,Le=!0,re=!0):Le?(Le=!1,re=!0):W(u,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),u.position+=1,he=K;if((u.line===Y||u.lineIndent>te)&&(Le&&(ce=u.line,oe=u.lineStart,ue=u.position),Xe(u,te,4,!0,re)&&(Le?_e=u.result:ot=u.result),Le||(Ke(u,ve,Ae,Ue,_e,ot,ce,oe,ue),Ue=_e=ot=null),ye(u,!0,-1),he=u.input.charCodeAt(u.position)),(u.line===Y||u.lineIndent>te)&&he!==0)W(u,"bad indentation of a mapping entry");else if(u.lineIndent<te)break}return Le&&Ke(u,ve,Ae,Ue,_e,null,ce,oe,ue),ft&&(u.tag=ie,u.anchor=Ee,u.kind="mapping",u.result=ve),ft})(i,J,we))||(function(u,te){var Z,K,re,Y,ce,oe,ue,he,ie,Ee,ve,Ae,Ue=!0,_e=u.tag,ot=u.anchor,Le=Object.create(null);if((Ae=u.input.charCodeAt(u.position))===91)ce=93,he=!1,Y=[];else{if(Ae!==123)return!1;ce=125,he=!0,Y={}}for(u.anchor!==null&&(u.anchorMap[u.anchor]=Y),Ae=u.input.charCodeAt(++u.position);Ae!==0;){if(ye(u,!0,te),(Ae=u.input.charCodeAt(u.position))===ce)return u.position++,u.tag=_e,u.anchor=ot,u.kind=he?"mapping":"sequence",u.result=Y,!0;Ue?Ae===44&&W(u,"expected the node content, but found ','"):W(u,"missed comma between flow collection entries"),ve=null,oe=ue=!1,Ae===63&&Se(u.input.charCodeAt(u.position+1))&&(oe=ue=!0,u.position++,ye(u,!0,te)),Z=u.line,K=u.lineStart,re=u.position,Xe(u,te,1,!1,!0),Ee=u.tag,ie=u.result,ye(u,!0,te),Ae=u.input.charCodeAt(u.position),!ue&&u.line!==Z||Ae!==58||(oe=!0,Ae=u.input.charCodeAt(++u.position),ye(u,!0,te),Xe(u,te,1,!1,!0),ve=u.result),he?Ke(u,Y,Le,Ee,ie,ve,Z,K,re):oe?Y.push(Ke(u,null,Le,Ee,ie,ve,Z,K,re)):Y.push(ie),ye(u,!0,te),(Ae=u.input.charCodeAt(u.position))===44?(Ue=!0,Ae=u.input.charCodeAt(++u.position)):Ue=!1}W(u,"unexpected end of the stream within a flow collection")})(i,we)?ge=!0:(A&&(function(u,te){var Z,K,re,Y,ce,oe=1,ue=!1,he=!1,ie=te,Ee=0,ve=!1;if((Y=u.input.charCodeAt(u.position))===124)K=!1;else{if(Y!==62)return!1;K=!0}for(u.kind="scalar",u.result="";Y!==0;)if((Y=u.input.charCodeAt(++u.position))===43||Y===45)oe===1?oe=Y===43?3:2:W(u,"repeat of a chomping mode identifier");else{if(!((re=48<=(ce=Y)&&ce<=57?ce-48:-1)>=0))break;re===0?W(u,"bad explicit indentation width of a block scalar; it cannot be less than one"):he?W(u,"repeat of an indentation width identifier"):(ie=te+re-1,he=!0)}if(qe(Y)){do Y=u.input.charCodeAt(++u.position);while(qe(Y));if(Y===35)do Y=u.input.charCodeAt(++u.position);while(!Ie(Y)&&Y!==0)}for(;Y!==0;){for(wt(u),u.lineIndent=0,Y=u.input.charCodeAt(u.position);(!he||u.lineIndent<ie)&&Y===32;)u.lineIndent++,Y=u.input.charCodeAt(++u.position);if(!he&&u.lineIndent>ie&&(ie=u.lineIndent),Ie(Y))Ee++;else{if(u.lineIndent<ie){oe===3?u.result+=n.repeat(`
`,ue?1+Ee:Ee):oe===1&&ue&&(u.result+=`
`);break}for(K?qe(Y)?(ve=!0,u.result+=n.repeat(`
`,ue?1+Ee:Ee)):ve?(ve=!1,u.result+=n.repeat(`
`,Ee+1)):Ee===0?ue&&(u.result+=" "):u.result+=n.repeat(`
`,Ee):u.result+=n.repeat(`
`,ue?1+Ee:Ee),ue=!0,he=!0,Ee=0,Z=u.position;!Ie(Y)&&Y!==0;)Y=u.input.charCodeAt(++u.position);ze(u,Z,u.position,!1)}}return!0})(i,we)||(function(u,te){var Z,K,re;if((Z=u.input.charCodeAt(u.position))!==39)return!1;for(u.kind="scalar",u.result="",u.position++,K=re=u.position;(Z=u.input.charCodeAt(u.position))!==0;)if(Z===39){if(ze(u,K,u.position,!0),(Z=u.input.charCodeAt(++u.position))!==39)return!0;K=u.position,u.position++,re=u.position}else Ie(Z)?(ze(u,K,re,!0),yt(u,ye(u,!1,te)),K=re=u.position):u.position===u.lineStart&&pt(u)?W(u,"unexpected end of the document within a single quoted scalar"):(u.position++,re=u.position);W(u,"unexpected end of the stream within a single quoted scalar")})(i,we)||(function(u,te){var Z,K,re,Y,ce,oe,ue;if((oe=u.input.charCodeAt(u.position))!==34)return!1;for(u.kind="scalar",u.result="",u.position++,Z=K=u.position;(oe=u.input.charCodeAt(u.position))!==0;){if(oe===34)return ze(u,Z,u.position,!0),u.position++,!0;if(oe===92){if(ze(u,Z,u.position,!0),Ie(oe=u.input.charCodeAt(++u.position)))ye(u,!1,te);else if(oe<256&&lt[oe])u.result+=dt[oe],u.position++;else if((ce=(ue=oe)===120?2:ue===117?4:ue===85?8:0)>0){for(re=ce,Y=0;re>0;re--)(ce=mt(oe=u.input.charCodeAt(++u.position)))>=0?Y=(Y<<4)+ce:W(u,"expected hexadecimal character");u.result+=ct(Y),u.position++}else W(u,"unknown escape sequence");Z=K=u.position}else Ie(oe)?(ze(u,Z,K,!0),yt(u,ye(u,!1,te)),Z=K=u.position):u.position===u.lineStart&&pt(u)?W(u,"unexpected end of the document within a double quoted scalar"):(u.position++,K=u.position)}W(u,"unexpected end of the stream within a double quoted scalar")})(i,we)?ge=!0:(function(u){var te,Z,K;if((K=u.input.charCodeAt(u.position))!==42)return!1;for(K=u.input.charCodeAt(++u.position),te=u.position;K!==0&&!Se(K)&&!He(K);)K=u.input.charCodeAt(++u.position);return u.position===te&&W(u,"name of an alias node must contain at least one character"),Z=u.input.slice(te,u.position),ae.call(u.anchorMap,Z)||W(u,'unidentified alias "'+Z+'"'),u.result=u.anchorMap[Z],ye(u,!0,-1),!0})(i)?(ge=!0,i.tag===null&&i.anchor===null||W(i,"alias node should not have any properties")):(function(u,te,Z){var K,re,Y,ce,oe,ue,he,ie,Ee=u.kind,ve=u.result;if(Se(ie=u.input.charCodeAt(u.position))||He(ie)||ie===35||ie===38||ie===42||ie===33||ie===124||ie===62||ie===39||ie===34||ie===37||ie===64||ie===96||(ie===63||ie===45)&&(Se(K=u.input.charCodeAt(u.position+1))||Z&&He(K)))return!1;for(u.kind="scalar",u.result="",re=Y=u.position,ce=!1;ie!==0;){if(ie===58){if(Se(K=u.input.charCodeAt(u.position+1))||Z&&He(K))break}else if(ie===35){if(Se(u.input.charCodeAt(u.position-1)))break}else{if(u.position===u.lineStart&&pt(u)||Z&&He(ie))break;if(Ie(ie)){if(oe=u.line,ue=u.lineStart,he=u.lineIndent,ye(u,!1,-1),u.lineIndent>=te){ce=!0,ie=u.input.charCodeAt(u.position);continue}u.position=Y,u.line=oe,u.lineStart=ue,u.lineIndent=he;break}}ce&&(ze(u,re,Y,!1),yt(u,u.line-oe),re=Y=u.position,ce=!1),qe(ie)||(Y=u.position+1),ie=u.input.charCodeAt(++u.position)}return ze(u,re,Y,!1),!!u.result||(u.kind=Ee,u.result=ve,!1)})(i,we,p===1)&&(ge=!0,i.tag===null&&(i.tag="?")),i.anchor!==null&&(i.anchorMap[i.anchor]=i.result)):me===0&&(ge=C&&Mt(i,J))),i.tag===null)i.anchor!==null&&(i.anchorMap[i.anchor]=i.result);else if(i.tag==="?"){for(i.result!==null&&i.kind!=="scalar"&&W(i,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+i.kind+'"'),q=0,z=i.implicitTypes.length;q<z;q+=1)if((X=i.implicitTypes[q]).resolve(i.result)){i.result=X.construct(i.result),i.tag=X.tag,i.anchor!==null&&(i.anchorMap[i.anchor]=i.result);break}}else if(i.tag!=="!"){if(ae.call(i.typeMap[i.kind||"fallback"],i.tag))X=i.typeMap[i.kind||"fallback"][i.tag];else for(X=null,q=0,z=(V=i.typeMap.multi[i.kind||"fallback"]).length;q<z;q+=1)if(i.tag.slice(0,V[q].tag.length)===V[q].tag){X=V[q];break}X||W(i,"unknown tag !<"+i.tag+">"),i.result!==null&&X.kind!==i.kind&&W(i,"unacceptable node kind for !<"+i.tag+'> tag; it should be "'+X.kind+'", not "'+i.kind+'"'),X.resolve(i.result,i.tag)?(i.result=X.construct(i.result,i.tag),i.anchor!==null&&(i.anchorMap[i.anchor]=i.result)):W(i,"cannot resolve a node with !<"+i.tag+"> explicit tag")}return i.listener!==null&&i.listener("close",i),i.tag!==null||i.anchor!==null||ge}function It(i){var l,p,h,m,T=i.position,A=!1;for(i.version=null,i.checkLineBreaks=i.legacy,i.tagMap=Object.create(null),i.anchorMap=Object.create(null);(m=i.input.charCodeAt(i.position))!==0&&(ye(i,!0,-1),m=i.input.charCodeAt(i.position),!(i.lineIndent>0||m!==37));){for(A=!0,m=i.input.charCodeAt(++i.position),l=i.position;m!==0&&!Se(m);)m=i.input.charCodeAt(++i.position);for(h=[],(p=i.input.slice(l,i.position)).length<1&&W(i,"directive name must not be less than one character in length");m!==0;){for(;qe(m);)m=i.input.charCodeAt(++i.position);if(m===35){do m=i.input.charCodeAt(++i.position);while(m!==0&&!Ie(m));break}if(Ie(m))break;for(l=i.position;m!==0&&!Se(m);)m=i.input.charCodeAt(++i.position);h.push(i.input.slice(l,i.position))}m!==0&&wt(i),ae.call(it,p)?it[p](i,p,h):ut(i,'unknown document directive "'+p+'"')}ye(i,!0,-1),i.lineIndent===0&&i.input.charCodeAt(i.position)===45&&i.input.charCodeAt(i.position+1)===45&&i.input.charCodeAt(i.position+2)===45?(i.position+=3,ye(i,!0,-1)):A&&W(i,"directives end mark is expected"),Xe(i,i.lineIndent-1,4,!1,!0),ye(i,!0,-1),i.checkLineBreaks&&je.test(i.input.slice(T,i.position))&&ut(i,"non-ASCII line breaks are interpreted as content"),i.documents.push(i.result),i.position===i.lineStart&&pt(i)?i.input.charCodeAt(i.position)===46&&(i.position+=3,ye(i,!0,-1)):i.position<i.length-1&&W(i,"end of the stream or a document separator is expected")}function f(i,l){l=l||{},(i=String(i)).length!==0&&(i.charCodeAt(i.length-1)!==10&&i.charCodeAt(i.length-1)!==13&&(i+=`
`),i.charCodeAt(0)===65279&&(i=i.slice(1)));var p=new gt(i,l),h=i.indexOf("\0");for(h!==-1&&(p.position=h,W(p,"null byte is not allowed in input")),p.input+="\0";p.input.charCodeAt(p.position)===32;)p.lineIndent+=1,p.position+=1;for(;p.position<p.length-1;)It(p);return p.documents}var v={loadAll:function(i,l,p){l!==null&&typeof l=="object"&&p===void 0&&(p=l,l=null);var h=f(i,p);if(typeof l!="function")return h;for(var m=0,T=h.length;m<T;m+=1)l(h[m])},load:function(i,l){var p=f(i,l);if(p.length!==0){if(p.length===1)return p[0];throw new r("expected a single document in the stream, but found more")}}},R=Object.prototype.toString,k=Object.prototype.hasOwnProperty,_=65279,F={0:"\\0",7:"\\a",8:"\\b",9:"\\t",10:"\\n",11:"\\v",12:"\\f",13:"\\r",27:"\\e",34:'\\"',92:"\\\\",133:"\\N",160:"\\_",8232:"\\L",8233:"\\P"},j=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],ee=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function le(i){var l,p,h;if(l=i.toString(16).toUpperCase(),i<=255)p="x",h=2;else if(i<=65535)p="u",h=4;else{if(!(i<=4294967295))throw new r("code point within a string may not be greater than 0xFFFFFFFF");p="U",h=8}return"\\"+p+n.repeat("0",h-l.length)+l}function x(i){this.schema=i.schema||nt,this.indent=Math.max(1,i.indent||2),this.noArrayIndent=i.noArrayIndent||!1,this.skipInvalid=i.skipInvalid||!1,this.flowLevel=n.isNothing(i.flowLevel)?-1:i.flowLevel,this.styleMap=(function(l,p){var h,m,T,A,C,q,z;if(p===null)return{};for(h={},T=0,A=(m=Object.keys(p)).length;T<A;T+=1)C=m[T],q=String(p[C]),C.slice(0,2)==="!!"&&(C="tag:yaml.org,2002:"+C.slice(2)),(z=l.compiledTypeMap.fallback[C])&&k.call(z.styleAliases,q)&&(q=z.styleAliases[q]),h[C]=q;return h})(this.schema,i.styles||null),this.sortKeys=i.sortKeys||!1,this.lineWidth=i.lineWidth||80,this.noRefs=i.noRefs||!1,this.noCompatMode=i.noCompatMode||!1,this.condenseFlow=i.condenseFlow||!1,this.quotingType=i.quotingType==='"'?2:1,this.forceQuotes=i.forceQuotes||!1,this.replacer=typeof i.replacer=="function"?i.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function ne(i,l){for(var p,h=n.repeat(" ",l),m=0,T=-1,A="",C=i.length;m<C;)(T=i.indexOf(`
`,m))===-1?(p=i.slice(m),m=C):(p=i.slice(m,T+1),m=T+1),p.length&&p!==`
`&&(A+=h),A+=p;return A}function Ce(i,l){return`
`+n.repeat(" ",i.indent*l)}function $e(i){return i===32||i===9}function xe(i){return 32<=i&&i<=126||161<=i&&i<=55295&&i!==8232&&i!==8233||57344<=i&&i<=65533&&i!==_||65536<=i&&i<=1114111}function Re(i){return xe(i)&&i!==_&&i!==13&&i!==10}function at(i,l,p){var h=Re(i),m=h&&!$e(i);return(p?h:h&&i!==44&&i!==91&&i!==93&&i!==123&&i!==125)&&i!==35&&!(l===58&&!m)||Re(l)&&!$e(l)&&i===35||l===58&&m}function De(i,l){var p,h=i.charCodeAt(l);return h>=55296&&h<=56319&&l+1<i.length&&(p=i.charCodeAt(l+1))>=56320&&p<=57343?1024*(h-55296)+p-56320+65536:h}function Ze(i){return/^\n* /.test(i)}function rt(i,l,p,h,m,T,A,C){var q,z,V=0,X=null,we=!1,J=!1,me=h!==-1,pe=-1,ge=xe(z=De(i,0))&&z!==_&&!$e(z)&&z!==45&&z!==63&&z!==58&&z!==44&&z!==91&&z!==93&&z!==123&&z!==125&&z!==35&&z!==38&&z!==42&&z!==33&&z!==124&&z!==61&&z!==62&&z!==39&&z!==34&&z!==37&&z!==64&&z!==96&&(function(u){return!$e(u)&&u!==58})(De(i,i.length-1));if(l||A)for(q=0;q<i.length;V>=65536?q+=2:q++){if(!xe(V=De(i,q)))return 5;ge=ge&&at(V,X,C),X=V}else{for(q=0;q<i.length;V>=65536?q+=2:q++){if((V=De(i,q))===10)we=!0,me&&(J=J||q-pe-1>h&&i[pe+1]!==" ",pe=q);else if(!xe(V))return 5;ge=ge&&at(V,X,C),X=V}J=J||me&&q-pe-1>h&&i[pe+1]!==" "}return we||J?p>9&&Ze(i)?5:A?T===2?5:2:J?4:3:!ge||A||m(i)?T===2?5:2:1}function vt(i,l,p,h,m){i.dump=(function(){if(l.length===0)return i.quotingType===2?'""':"''";if(!i.noCompatMode&&(j.indexOf(l)!==-1||ee.test(l)))return i.quotingType===2?'"'+l+'"':"'"+l+"'";var T=i.indent*Math.max(1,p),A=i.lineWidth===-1?-1:Math.max(Math.min(i.lineWidth,40),i.lineWidth-T),C=h||i.flowLevel>-1&&p>=i.flowLevel;switch(rt(l,C,i.indent,A,(function(q){return(function(z,V){var X,we;for(X=0,we=z.implicitTypes.length;X<we;X+=1)if(z.implicitTypes[X].resolve(V))return!0;return!1})(i,q)}),i.quotingType,i.forceQuotes&&!h,m)){case 1:return l;case 2:return"'"+l.replace(/'/g,"''")+"'";case 3:return"|"+Rt(l,i.indent)+Nt(ne(l,T));case 4:return">"+Rt(l,i.indent)+Nt(ne((function(q,z){for(var V,X,we=/(\n+)([^\n]*)/g,J=(pe=q.indexOf(`
`),pe=pe!==-1?pe:q.length,we.lastIndex=pe,Pt(q.slice(0,pe),z)),me=q[0]===`
`||q[0]===" ",pe;X=we.exec(q);){var ge=X[1],u=X[2];V=u[0]===" ",J+=ge+(me||V||u===""?"":`
`)+Pt(u,z),me=V}return J})(l,A),T));case 5:return'"'+(function(q){for(var z,V="",X=0,we=0;we<q.length;X>=65536?we+=2:we++)X=De(q,we),!(z=F[X])&&xe(X)?(V+=q[we],X>=65536&&(V+=q[we+1])):V+=z||le(X);return V})(l)+'"';default:throw new r("impossible error: invalid scalar style")}})()}function Rt(i,l){var p=Ze(i)?String(l):"",h=i[i.length-1]===`
`;return p+(h&&(i[i.length-2]===`
`||i===`
`)?"+":h?"":"-")+`
`}function Nt(i){return i[i.length-1]===`
`?i.slice(0,-1):i}function Pt(i,l){if(i===""||i[0]===" ")return i;for(var p,h,m=/ [^ ]/g,T=0,A=0,C=0,q="";p=m.exec(i);)(C=p.index)-T>l&&(h=A>T?A:C,q+=`
`+i.slice(T,h),T=h+1),A=C;return q+=`
`,i.length-T>l&&A>T?q+=i.slice(T,A)+`
`+i.slice(A+1):q+=i.slice(T),q.slice(1)}function Ot(i,l,p,h){var m,T,A,C="",q=i.tag;for(m=0,T=p.length;m<T;m+=1)A=p[m],i.replacer&&(A=i.replacer.call(p,String(m),A)),(Qe(i,l+1,A,!0,!0,!1,!0)||A===void 0&&Qe(i,l+1,null,!0,!0,!1,!0))&&(h&&C===""||(C+=Ce(i,l)),i.dump&&i.dump.charCodeAt(0)===10?C+="-":C+="- ",C+=i.dump);i.tag=q,i.dump=C||"[]"}function Lt(i,l,p){var h,m,T,A,C,q;for(T=0,A=(m=p?i.explicitTypes:i.implicitTypes).length;T<A;T+=1)if(((C=m[T]).instanceOf||C.predicate)&&(!C.instanceOf||typeof l=="object"&&l instanceof C.instanceOf)&&(!C.predicate||C.predicate(l))){if(p?C.multi&&C.representName?i.tag=C.representName(l):i.tag=C.tag:i.tag="?",C.represent){if(q=i.styleMap[C.tag]||C.defaultStyle,R.call(C.represent)==="[object Function]")h=C.represent(l,q);else{if(!k.call(C.represent,q))throw new r("!<"+C.tag+'> tag resolver accepts not "'+q+'" style');h=C.represent[q](l,q)}i.dump=h}return!0}return!1}function Qe(i,l,p,h,m,T,A){i.tag=null,i.dump=p,Lt(i,p,!1)||Lt(i,p,!0);var C,q=R.call(i.dump),z=h;h&&(h=i.flowLevel<0||i.flowLevel>l);var V,X,we=q==="[object Object]"||q==="[object Array]";if(we&&(X=(V=i.duplicates.indexOf(p))!==-1),(i.tag!==null&&i.tag!=="?"||X||i.indent!==2&&l>0)&&(m=!1),X&&i.usedDuplicates[V])i.dump="*ref_"+V;else{if(we&&X&&!i.usedDuplicates[V]&&(i.usedDuplicates[V]=!0),q==="[object Object]")h&&Object.keys(i.dump).length!==0?((function(J,me,pe,ge){var u,te,Z,K,re,Y,ce="",oe=J.tag,ue=Object.keys(pe);if(J.sortKeys===!0)ue.sort();else if(typeof J.sortKeys=="function")ue.sort(J.sortKeys);else if(J.sortKeys)throw new r("sortKeys must be a boolean or a function");for(u=0,te=ue.length;u<te;u+=1)Y="",ge&&ce===""||(Y+=Ce(J,me)),K=pe[Z=ue[u]],J.replacer&&(K=J.replacer.call(pe,Z,K)),Qe(J,me+1,Z,!0,!0,!0)&&((re=J.tag!==null&&J.tag!=="?"||J.dump&&J.dump.length>1024)&&(J.dump&&J.dump.charCodeAt(0)===10?Y+="?":Y+="? "),Y+=J.dump,re&&(Y+=Ce(J,me)),Qe(J,me+1,K,!0,re)&&(J.dump&&J.dump.charCodeAt(0)===10?Y+=":":Y+=": ",ce+=Y+=J.dump));J.tag=oe,J.dump=ce||"{}"})(i,l,i.dump,m),X&&(i.dump="&ref_"+V+i.dump)):((function(J,me,pe){var ge,u,te,Z,K,re="",Y=J.tag,ce=Object.keys(pe);for(ge=0,u=ce.length;ge<u;ge+=1)K="",re!==""&&(K+=", "),J.condenseFlow&&(K+='"'),Z=pe[te=ce[ge]],J.replacer&&(Z=J.replacer.call(pe,te,Z)),Qe(J,me,te,!1,!1)&&(J.dump.length>1024&&(K+="? "),K+=J.dump+(J.condenseFlow?'"':"")+":"+(J.condenseFlow?"":" "),Qe(J,me,Z,!1,!1)&&(re+=K+=J.dump));J.tag=Y,J.dump="{"+re+"}"})(i,l,i.dump),X&&(i.dump="&ref_"+V+" "+i.dump));else if(q==="[object Array]")h&&i.dump.length!==0?(i.noArrayIndent&&!A&&l>0?Ot(i,l-1,i.dump,m):Ot(i,l,i.dump,m),X&&(i.dump="&ref_"+V+i.dump)):((function(J,me,pe){var ge,u,te,Z="",K=J.tag;for(ge=0,u=pe.length;ge<u;ge+=1)te=pe[ge],J.replacer&&(te=J.replacer.call(pe,String(ge),te)),(Qe(J,me,te,!1,!1)||te===void 0&&Qe(J,me,null,!1,!1))&&(Z!==""&&(Z+=","+(J.condenseFlow?"":" ")),Z+=J.dump);J.tag=K,J.dump="["+Z+"]"})(i,l,i.dump),X&&(i.dump="&ref_"+V+" "+i.dump));else{if(q!=="[object String]"){if(q==="[object Undefined]"||i.skipInvalid)return!1;throw new r("unacceptable kind of an object to dump "+q)}i.tag!=="?"&&vt(i,i.dump,l,T,z)}i.tag!==null&&i.tag!=="?"&&(C=encodeURI(i.tag[0]==="!"?i.tag.slice(1):i.tag).replace(/!/g,"%21"),C=i.tag[0]==="!"?"!"+C:C.slice(0,18)==="tag:yaml.org,2002:"?"!!"+C.slice(18):"!<"+C+">",i.dump=C+" "+i.dump)}return!0}function Yt(i,l){var p,h,m=[],T=[];for(At(i,m,T),p=0,h=T.length;p<h;p+=1)l.duplicates.push(m[T[p]]);l.usedDuplicates=new Array(h)}function At(i,l,p){var h,m,T;if(i!==null&&typeof i=="object")if((m=l.indexOf(i))!==-1)p.indexOf(m)===-1&&p.push(m);else if(l.push(i),Array.isArray(i))for(m=0,T=i.length;m<T;m+=1)At(i[m],l,p);else for(m=0,T=(h=Object.keys(i)).length;m<T;m+=1)At(i[h[m]],l,p)}function Ct(i,l){return function(){throw new Error("Function yaml."+i+" is removed in js-yaml 4. Use yaml."+l+" instead, which is now safe by default.")}}var Ft=b,qt=L,kt=D,$t=P,Dt=y,Ut=nt,Bt=v.load,xt=v.loadAll,_t=function(i,l){var p=new x(l=l||{});p.noRefs||Yt(i,p);var h=i;return p.replacer&&(h=p.replacer.call({"":h},"",h)),Qe(p,0,h,!0,!0)?p.dump+`
`:""},jt=r,Ht={binary:et,float:H,map:w,null:O,pairs:Je,set:Be,timestamp:G,bool:Q,int:be,merge:fe,omap:tt,seq:M,str:B},zt=Ct("safeLoad","load"),Gt=Ct("safeLoadAll","loadAll"),Jt=Ct("safeDump","dump"),Wt={Type:Ft,Schema:qt,FAILSAFE_SCHEMA:kt,JSON_SCHEMA:$t,CORE_SCHEMA:Dt,DEFAULT_SCHEMA:Ut,load:Bt,loadAll:xt,dump:_t,YAMLException:jt,types:Ht,safeLoad:zt,safeLoadAll:Gt,safeDump:Jt};e.CORE_SCHEMA=Dt,e.DEFAULT_SCHEMA=Ut,e.FAILSAFE_SCHEMA=kt,e.JSON_SCHEMA=$t,e.Schema=qt,e.Type=Ft,e.YAMLException=jt,e.default=Wt,e.dump=_t,e.load=Bt,e.loadAll=xt,e.safeDump=Jt,e.safeLoad=zt,e.safeLoadAll=Gt,e.types=Ht,Object.defineProperty(e,"__esModule",{value:!0})})),window.SELECTORS={PAGES:{MAPPINGS:"mappings-page",REQUESTS:"requests-page",SCENARIOS:"scenarios-page","IMPORT-EXPORT":"import-export-page",RECORDING:"recording-page",SETTINGS:"settings-page"},REQUEST_FILTERS:{METHOD:"req-filter-method",STATUS:"req-filter-status",URL:"req-filter-url",DATE_FROM:"req-filter-from",DATE_TO:"req-filter-to",QUICK:"req-filter-quick"},MAPPING_FILTERS:{QUERY:"filter-query"},LISTS:{MAPPINGS:"mappings-list",REQUESTS:"requests-list",SCENARIOS:"scenarios-list"},EMPTY:{MAPPINGS:"mappings-empty",REQUESTS:"requests-empty"},UI:{STATS:"stats",SEARCH_FILTERS:"search-filters",UPTIME:"uptime",DATA_SOURCE_INDICATOR:"data-source-indicator",REQUESTS_SOURCE_INDICATOR:"requests-source-indicator"},LOADING:{MAPPINGS:"mappings-loading",REQUESTS:"requests-loading"},COUNTERS:{MAPPINGS:"mappings-count",REQUESTS:"requests-count"},CONNECTION:{SETUP:"connection-setup",HOST:"wiremock-host",PORT:"wiremock-port",CONNECT_BTN:"connect-btn",STATUS_DOT:"status-dot",STATUS_TEXT:"status-text",UPTIME:"uptime"},MODAL:{FORM:"mapping-form",ID:"mapping-id",TITLE:"modal-title"},FORM_FIELDS:{METHOD:"mapping-method",URL:"mapping-url",STATUS:"mapping-status",HEADERS:"mapping-headers",BODY:"mapping-body",PRIORITY:"mapping-priority",NAME:"mapping-name"},BUTTONS:{ADD_MAPPING:"add-mapping-btn",START_RECORDING:"start-recording-btn"},RECORDING:{URL:"recording-url",CAPTURE_HEADERS:"capture-headers",CAPTURE_BODY:"capture-body",URL_FILTER:"url-filter",INDICATOR:"recording-indicator",TARGET:"recording-target",COUNT:"recording-count",STOP_BTN:"stop-recording-btn"},SETTINGS:{HOST:"settings-host",PORT:"settings-port",TIMEOUT:"settings-timeout",AUTO_REFRESH:"auto-refresh",THEME:"theme-select",CUSTOM_HEADERS:"custom-headers",CACHE_ENABLED:"cache-enabled"},IMPORT:{FILE:"import-file",DISPLAY:"file-display",ACTIONS:"import-actions",RESULT:"import-result",MODE:"import-mode"},EXPORT:{FORMAT:"export-format",RESULT:"export-result"},STATS:{TOTAL_MAPPINGS:"total-mappings",TOTAL_REQUESTS:"total-requests"},HEALTH:{INDICATOR:"health-indicator"}},window.Icons={render(e,t={}){if(!e)return"";const n=["icon",`icon-${e}`];return t.className&&n.push(t.className),`<svg class="${n.join(" ")}" aria-hidden="true" focusable="false"><use href="#icon-${e}"></use></svg>`}},window.ENDPOINTS={HEALTH:"/health",MAPPINGS:"/mappings",MAPPINGS_RESET:"/mappings/reset",MAPPINGS_SAVE:"/mappings/save",MAPPINGS_IMPORT:"/mappings/import",MAPPINGS_FIND_BY_METADATA:"/mappings/find-by-metadata",MAPPINGS_REMOVE_BY_METADATA:"/mappings/remove-by-metadata",MAPPINGS_UNMATCHED:"/mappings/unmatched",REQUESTS:"/requests",REQUESTS_COUNT:"/requests/count",REQUESTS_REMOVE:"/requests/remove",REQUESTS_FIND:"/requests/find",REQUESTS_UNMATCHED:"/requests/unmatched",REQUESTS_UNMATCHED_NEAR_MISSES:"/requests/unmatched/near-misses",RECORDINGS_START:"/recordings/start",RECORDINGS_STOP:"/recordings/stop",RECORDINGS_STATUS:"/recordings/status",RECORDINGS_SNAPSHOT:"/recordings/snapshot",SCENARIOS:"/scenarios",SCENARIOS_RESET:"/scenarios/reset"},(function(){const t=new Map,n=new Map,a=new Set,o=new Map,r=(d,g,E)=>t.set(d,{name:g,delay:E,createdAt:Date.now()}),c=(d,g,E)=>n.set(d,{name:g,delay:E,createdAt:Date.now()}),s={setInterval(d,g,E){const b=window.setInterval(d,g);return r(b,E,g),b},setNamedInterval(d,g,E){return this.setInterval(g,E,d)},clearInterval(d){d!=null&&(window.clearInterval(d),t.delete(d))},setTimeout(d,g,E){const b=window.setTimeout(()=>{n.delete(b),d()},g);return c(b,E,g),b},clearTimeout(d){d!=null&&(window.clearTimeout(d),n.delete(d))},requestAnimationFrame(d){const g=window.requestAnimationFrame(d);return a.add(g),g},cancelAnimationFrame(d){d!=null&&(window.cancelAnimationFrame(d),a.delete(d))},addEventListener(d,g,E,b){!d||!g||!E||(d.addEventListener(g,E,b),o.has(d)||o.set(d,new Set),o.get(d).add({type:g,handler:E,options:b}))},removeEventListener(d,g,E,b){if(!d||!g||!E)return;d.removeEventListener(g,E,b);const S=o.get(d);if(S){for(const I of S)if(I.type===g&&I.handler===E&&JSON.stringify(I.options)===JSON.stringify(b)){S.delete(I);break}S.size===0&&o.delete(d)}},clearAll(){t.forEach((d,g)=>window.clearInterval(g)),t.clear(),n.forEach((d,g)=>window.clearTimeout(g)),n.clear(),a.forEach(d=>window.cancelAnimationFrame(d)),a.clear(),o.forEach((d,g)=>{d.forEach(({type:E,handler:b,options:S})=>{g.removeEventListener(E,b,S)})}),o.clear()},getStats(){return{intervals:t.size,timeouts:n.size,rafs:a.size,eventTargets:o.size,details:{intervals:Array.from(t.entries()),timeouts:Array.from(n.entries())}}}};window.LifecycleManager=s,window.addEventListener("beforeunload",()=>s.clearAll())})(),(function(){if(window.AppEvents&&typeof window.AppEvents.emit=="function")return;const t=new Map,n=(o,r)=>{t.has(o)||t.set(o,new Set),t.get(o).add(r)},a=(o,r)=>{const c=t.get(o);c&&(c.delete(r),c.size===0&&t.delete(o))};window.AppEvents={on(o,r){return!o||typeof r!="function"?()=>{}:(n(o,r),()=>a(o,r))},off(o,r){!o||typeof r!="function"||a(o,r)},emit(o,r={}){const c=t.get(o);if(!c||c.size===0)return!1;const s={type:o,detail:r};return[...c].forEach(d=>{try{d(s)}catch(g){Logger.warn("CORE",`AppEvents handler failed for "${o}":`,g)}}),!0},listenerCount(o){return t.get(o)?.size||0}}})(),window.debounce=function(t,n=150,a={}){let o,r,c,s;const{leading:d=!1,trailing:g=!0}=a,E=()=>{o=void 0,g&&r&&(s=t.apply(c,r),r=c=void 0)};return Object.assign(function(...S){return r=S,c=this,o===void 0?(d&&(s=t.apply(c,r),r=c=void 0),o=window.setTimeout(E,n)):(window.clearTimeout(o),o=window.setTimeout(E,n)),s},{cancel(){o!==void 0&&window.clearTimeout(o),o=void 0,r=c=void 0},flush(){return o!==void 0&&(window.clearTimeout(o),E()),s}})},(function(){const t=new WeakMap;function n(a){if(typeof a!="string"||!a.trim())return null;const o=document.createElement("template");return o.innerHTML=a.trim(),o.content.firstElementChild}window.renderList=function(o,r,c={}){if(!(o instanceof Element)||!Array.isArray(r))return;const{renderItem:s,getKey:d,getSignature:g,onItemChanged:E,onItemRemoved:b}=c;if(typeof s!="function")return;const S=new Map;Array.from(o.children).forEach(B=>{B instanceof HTMLElement&&B.dataset&&B.dataset.id&&S.set(B.dataset.id,B)});const I=document.createDocumentFragment();r.forEach(B=>{const M=typeof d=="function"?d(B):B&&(B.id||B.uuid);if(!M)return;const w=String(M),D=typeof g=="function"?g(B):w,O=S.get(w);if(O&&O.dataset.renderSignature===D){O.dataset.renderSignature=D,I.appendChild(O),S.delete(w);return}const Q=O&&O.dataset.renderSignature||null;if(O&&typeof E=="function"&&Q!==D)try{E(w,B,D)}catch(be){Logger.warn("UI","renderList onItemChanged failed:",be)}const de=s(B),se=n(de);if(!se){S.delete(w);return}se.dataset.id=w,se.dataset.renderSignature=D,I.appendChild(se),S.delete(w)}),S.forEach((B,M)=>{if(B.remove(),typeof b=="function")try{b(String(M),B)}catch(w){Logger.warn("UI","renderList onItemRemoved failed:",w)}});const L=()=>{o.replaceChildren(I)};if(window.LifecycleManager&&typeof window.LifecycleManager.requestAnimationFrame=="function"){const B=t.get(o);B&&window.LifecycleManager.cancelAnimationFrame(B);const M=window.LifecycleManager.requestAnimationFrame(()=>{L(),t.delete(o)});M!==null&&t.set(o,M)}else if(typeof window.requestAnimationFrame=="function"){const B=window.requestAnimationFrame(L);t.set(o,B)}else L()}})();const ensureCustomHeaderObject=e=>!e||typeof e!="object"||Array.isArray(e)?{}:Object.keys(e).reduce((t,n)=>{const a=String(n).trim();return a&&(t[a]=e[n]),t},{}),migrateLegacySettings=e=>{if(!e||typeof e!="object"||Array.isArray(e))return{};const t={...e},n=ensureCustomHeaderObject(t.customHeaders);if(typeof t.authHeader=="string"&&t.authHeader.trim()){const a=t.authHeader.trim();if(Object.prototype.hasOwnProperty.call(n,"Authorization")||(n.Authorization=a),delete t.authHeader,!t.customHeadersRaw||typeof t.customHeadersRaw!="string"||!t.customHeadersRaw.trim())try{t.customHeadersRaw=JSON.stringify(n,null,2)}catch(o){Logger.warn("API","Failed to serialize migrated custom headers:",o),t.customHeadersRaw=""}}return t.customHeaders=n,typeof t.customHeadersRaw!="string"&&(t.customHeadersRaw=""),t.autoConnect=t.autoConnect!==!1,t};window.normalizeWiremockSettings=e=>migrateLegacySettings(e),window.readWiremockSettings=()=>{try{const e=localStorage.getItem("wiremock-settings");if(!e)return{};const t=JSON.parse(e);return migrateLegacySettings(t)}catch(e){return Logger.warn("UI","Failed to read stored settings, returning empty object:",e),{}}},window.buildScenarioStateEndpoint=e=>{const t=typeof e=="string"?e:"";return t.trim()?`${ENDPOINTS.SCENARIOS}/${encodeURIComponent(t)}/state`:""};let wiremockBaseUrl="",requestTimeout=window.DEFAULT_SETTINGS?.requestTimeout?parseInt(window.DEFAULT_SETTINGS.requestTimeout):69e3;window.customHeaders=ensureCustomHeaderObject(window.DEFAULT_SETTINGS?.customHeaders||{}),window.startTime=null,window.uptimeInterval=null;let autoRefreshInterval=null;window.allRequests=[],window.allScenarios=[],window.isRecording=!1,window.recordedCount=0,window.normalizeWiremockBaseUrl=(e,t)=>{let n=(e||"").trim()||"localhost",a=(t||"").trim(),o="http",r="";try{const c=new URL(n.includes("://")?n:`http://${n}`);o=c.protocol.replace(":","")||"http",r=c.hostname,a||(a=c.port)}catch{const s=n.match(/^([^:/]+)(?::(\d+))?$/);r=s?s[1]:n,a||(a=s?.[2])}return`${o}://${r||"localhost"}:${a||(o==="https"?"443":"8080")}/__admin`},window.apiFetch=async(e,t={})=>{const n=new AbortController,a=Utils.safeCall(window.readWiremockSettings)||{},o=a.requestTimeout?parseInt(a.requestTimeout):window.DEFAULT_SETTINGS?.requestTimeout?parseInt(window.DEFAULT_SETTINGS.requestTimeout):69e3,r=setTimeout(()=>n.abort(),o),c=`${window.wiremockBaseUrl}${e}`,s=t.method||"GET",d={"Content-Type":"application/json",...ensureCustomHeaderObject(a.customHeaders||window.customHeaders),...t.headers},E=!(e===window.ENDPOINTS?.HEALTH||e===window.ENDPOINTS?.MAPPINGS);E&&Logger.api(`${s} ${e}`);try{const b=await fetch(c,{...t,signal:n.signal,headers:d});if(clearTimeout(r),!b.ok){const I=await b.text();E&&Logger.error("API",`HTTP ${b.status}: ${I||b.statusText}`,{endpoint:e,method:s});const L=new Error(`HTTP ${b.status}: ${I||b.statusText}`);throw L.status=b.status,L.statusText=b.statusText,L}const S=b.headers.get("content-type")?.includes("application/json")?await b.json():await b.text();E&&Logger.api(`${s} ${e} - OK`);try{if(e===window.ENDPOINTS?.HEALTH||e===window.ENDPOINTS?.MAPPINGS){const I=Date.now();window.lastWiremockSuccess=I,window.AppEvents&&typeof window.AppEvents.emit=="function"&&window.AppEvents.emit("wiremock:success",{endpoint:e,method:s,timestamp:I})}}catch{}return S}catch(b){throw clearTimeout(r),E&&Logger.error("API",`${s} ${e} - ${b.name}: ${b.message}`),b.name==="AbortError"?new Error(`Request timeout after ${o}ms`):b}},window.showPage=(e,t)=>{Logger.info("UI",`Switching to tab: ${e}`),document.querySelectorAll('.main-content > div[id$="-page"]').forEach(a=>a.classList.add("hidden"));const n=document.getElementById(SELECTORS.PAGES[e.toUpperCase()]);if(!n){Logger.warn("UI",`Page not found: ${e}`);return}if(n.classList.remove("hidden"),document.querySelectorAll(".sidebar .nav-item").forEach(a=>a.classList.remove("active")),t&&t.classList.add("active"),window.history&&window.history.replaceState){const a=new URL(window.location.href),o=a.searchParams.get("tab");a.searchParams.set("tab",e);const r=a.toString();Logger.api(`showPage: ${o} \u2192 ${e}`),Logger.api(`showPage URL: ${r}`),window.history.replaceState({},"",r)}else Logger.warn("UI","history.replaceState not available")};const SIDEBAR_COLLAPSED_CLASS="sidebar-collapsed",SIDEBAR_STATE_STORAGE_KEY="imock-sidebar-state",applySidebarState=(e,{persist:t=!0}={})=>{if(!document.body)return;document.body.classList.toggle(SIDEBAR_COLLAPSED_CLASS,e);const n=document.querySelector(".sidebar-toggle");if(n){const a=e?"Expand sidebar":"Collapse sidebar";n.setAttribute("aria-expanded",String(!e)),n.setAttribute("aria-label",a),n.setAttribute("title",a),n.querySelector("use")?.setAttribute("href",e?"#icon-sidebar-expand":"#icon-sidebar-collapse")}if(t)try{localStorage.setItem(SIDEBAR_STATE_STORAGE_KEY,e?"collapsed":"expanded")}catch(a){Logger.warn("UI","Unable to persist sidebar state:",a)}};window.toggleSidebar=()=>{const e=document.body?.classList.contains(SIDEBAR_COLLAPSED_CLASS);applySidebarState(!e)},window.initializeSidebarPreference=()=>{let e=null;try{e=localStorage.getItem(SIDEBAR_STATE_STORAGE_KEY)}catch(t){Logger.warn("UI","Unable to read sidebar state from storage:",t)}applySidebarState(e==="collapsed",{persist:!1})};const resolveModalElement=e=>{if(!e)return Logger.warn("UI","Modal ID is required to resolve modal element"),null;const t=document.getElementById(e);return t||Logger.warn("UI",`Modal element not found for id: ${e}`),t};window.showModal=e=>{const t=resolveModalElement(e);if(!t)return;t.classList.remove("hidden"),t.style.display="flex";const n=t.querySelector("input, select, textarea");n&&LifecycleManager.requestAnimationFrame(()=>n.focus())},window.openAddMappingModal=()=>{if(window.TemplateManager?.openGalleryForTarget){window.TemplateManager.openGalleryForTarget("create-inline");return}const e=document.querySelector('[data-template-trigger][data-template-target="create-inline"]');e?e.click():window.showModal("template-gallery-modal")},window.hideModal=e=>{const t=typeof e=="string"?resolveModalElement(e):e;if(t&&(t.classList.add("hidden"),t.style.display="none",t.querySelector("form")?.reset(),t.id==="edit-mapping-modal"&&(typeof UIComponents?.clearCardState=="function"&&UIComponents.clearCardState("mapping","is-editing"),window.editor&&typeof window.editor.setValue=="function")))try{window.editor.setValue("")}catch(n){Logger.warn("UI","Failed to clear editor:",n)}},window.showTab=(e,t)=>{if(document.querySelectorAll(".tab-content").forEach(n=>n.classList.add("hidden")),document.querySelectorAll(".tab-button").forEach(n=>n.classList.remove("active")),document.getElementById(`${e}-tab`).classList.remove("hidden"),t.classList.add("active"),window.history&&window.history.replaceState){const n=new URL(window.location.href);n.searchParams.set("tab",e),window.history.replaceState({},"",n.toString())}};const applyThemeToDom=e=>{if(!document.body)return;document.body.setAttribute("data-theme",e);const t=[document.getElementById("theme-icon"),document.getElementById("editor-theme-icon")].filter(Boolean);if(t.length){const n=e==="dark"?"#icon-sun":"#icon-moon";t.forEach(a=>{a.setAttribute("href",n),a.setAttribute("xlink:href",n)})}},persistThemePreference=e=>{localStorage.setItem("theme",e);try{localStorage.setItem("wiremock-settings",JSON.stringify({...Utils.safeCall(window.readWiremockSettings)||{},theme:e}))}catch{}};window.toggleTheme=()=>{if(!document.body)return;const e=(document.body.getAttribute("data-theme")||"dark")==="dark"?"light":"dark";applyThemeToDom(e),persistThemePreference(e),window.NotificationManager&&NotificationManager.show(`Switched to ${e} theme`,"success")},window.changeTheme=()=>{const e=document.getElementById("theme-select");if(!e)return;const t=e.value,n=t==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":t;applyThemeToDom(n),persistThemePreference(t),window.NotificationManager&&NotificationManager.show(`Theme changed to ${t}`,"success")},window.initializeTheme=()=>{const e=localStorage.getItem("theme")||"dark",t=e==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;applyThemeToDom(t);const n=document.getElementById("theme-select");n&&(n.value=e)},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initializeTheme):initializeTheme(),LifecycleManager.addEventListener(document,"click",e=>{e.target.classList.contains("modal")&&hideModal(e.target)}),LifecycleManager.addEventListener(document,"keydown",e=>{if(e.key==="Escape"){const t=document.querySelector(".modal:not(.hidden)");t&&hideModal(t)}}),window.elementCache=new Map,window.invalidateElementCache=e=>e?window.elementCache.delete(e):window.elementCache.clear(),Logger.info("UI","Core.js loaded - Constants, API client, basic UI functions"),window.NotificationManager||(window.NotificationManager={TYPES:{INFO:"info",SUCCESS:"success",ERROR:"error",WARNING:"warning"},ICONS:{info:"\u2139\uFE0F",success:"\u2705",warning:"\u26A0\uFE0F",error:"\u26D4"},queue:[],visibleToasts:[],dedupeMap:new Map,toastContainer:null,cooldownTimer:null,lastShownAt:0,maxVisible:3,cooldownMs:650,dedupeWindowMs:4e3,defaultDuration:4e3,motionQuery:null,_boundHandleKeydown:null,init(){this.toastContainer||(this.toastContainer=document.getElementById("toast-container"),this.toastContainer||(this.toastContainer=document.createElement("div"),this.toastContainer.id="toast-container",this.toastContainer.setAttribute("aria-live","polite"),this.toastContainer.setAttribute("aria-atomic","false"),document.body.appendChild(this.toastContainer))),!this.motionQuery&&window.matchMedia&&(this.motionQuery=window.matchMedia("(prefers-reduced-motion: reduce)")),this._boundHandleKeydown||(this._boundHandleKeydown=this.handleKeydown.bind(this),window.LifecycleManager?window.LifecycleManager.addEventListener(document,"keydown",this._boundHandleKeydown):document.addEventListener("keydown",this._boundHandleKeydown))},cleanup(){this._boundHandleKeydown&&(window.LifecycleManager?window.LifecycleManager.removeEventListener(document,"keydown",this._boundHandleKeydown):document.removeEventListener("keydown",this._boundHandleKeydown),this._boundHandleKeydown=null)},normalizePayload(e,t=this.TYPES.INFO,n=void 0){if(e==null)return null;const a={message:String(e).trim(),type:this.TYPES.INFO,duration:this.defaultDuration,action:null};return typeof t=="object"&&t!==null?Object.assign(a,t):(a.type=typeof t=="string"?t:this.TYPES.INFO,typeof n=="number"?a.duration=n:typeof n=="object"&&n!==null&&Object.assign(a,n)),a.message?(Object.values(this.TYPES).includes(a.type)||(a.type=this.TYPES.INFO),a.action&&typeof a.action!="object"&&(a.action=null),a.action&&typeof a.action?.label!="string"&&(a.action=null),a.action&&typeof a.action?.handler!="function"&&(a.action.handler=()=>{}),a.action?a.duration=null:(typeof a.duration!="number"||a.duration<=0)&&(a.duration=this.defaultDuration),a.createdAt=Date.now(),a.count=a.count&&Number.isInteger(a.count)?a.count:1,a.dedupeKey=this.getDedupeKey(a),a):null},show(e,t=this.TYPES.INFO,n=void 0){this.init();const a=this.normalizePayload(e,t,n);if(!a)return;const o=this.dedupeMap.get(a.dedupeKey);if(o&&Date.now()-o.timestamp<=this.dedupeWindowMs){o.count+=1,o.timestamp=Date.now(),o.payload.count=o.count,this.updateToastCount(o),clearTimeout(o.cleanupTimer),o.cleanupTimer=setTimeout(()=>{this.dedupeMap.delete(a.dedupeKey)},this.dedupeWindowMs);return}this.queue.push(a),this.dedupeMap.set(a.dedupeKey,{count:a.count,timestamp:Date.now(),payload:a,toastEl:null,cleanupTimer:setTimeout(()=>{this.dedupeMap.delete(a.dedupeKey)},this.dedupeWindowMs)}),this.processQueue()},success(e,t){this.show(e,{type:this.TYPES.SUCCESS,...typeof t=="object"?t:{duration:t}})},error(e,t){this.show(e,{type:this.TYPES.ERROR,...typeof t=="object"?t:{duration:t}})},warning(e,t){this.show(e,{type:this.TYPES.WARNING,...typeof t=="object"?t:{duration:t}})},info(e,t){this.show(e,{type:this.TYPES.INFO,...typeof t=="object"?t:{duration:t}})},handleKeydown(e){if(e.key!=="Escape"||!this.visibleToasts.length)return;const t=this.visibleToasts[this.visibleToasts.length-1];t&&this.dismissToast(t.toastEl,t.payload,"escape")},processQueue(){if(!this.queue.length||this.visibleToasts.length>=this.maxVisible)return;const t=Date.now()-this.lastShownAt;if(t<this.cooldownMs){this.cooldownTimer||(this.cooldownTimer=setTimeout(()=>{this.cooldownTimer=null,this.processQueue()},this.cooldownMs-t));return}const n=this.getNextToastIndex();if(n===-1)return;const a=this.queue.splice(n,1)[0];this.displayToast(a)},getNextToastIndex(){if(!this.queue.length)return-1;const e={[this.TYPES.ERROR]:3,[this.TYPES.WARNING]:2,[this.TYPES.INFO]:1,[this.TYPES.SUCCESS]:1};let t=0,n=-1/0,a=1/0;for(let o=0;o<this.queue.length;o+=1){const r=this.queue[o],c=e[r.type]||0;(c>n||c===n&&r.createdAt<a)&&(n=c,a=r.createdAt,t=o)}return t},displayToast(e){const t=document.createElement("div");t.className=`toast toast-${e.type}`,t.setAttribute("role",e.type===this.TYPES.ERROR?"alert":"status"),t.setAttribute("aria-live",e.type===this.TYPES.ERROR?"assertive":"polite"),t.setAttribute("aria-atomic","true"),t.dataset.key=e.dedupeKey;const n=document.createElement("span");n.className="toast-icon",n.setAttribute("aria-hidden","true"),n.textContent=this.ICONS[e.type]||this.ICONS.info;const a=document.createElement("div");a.className="toast-content";const o=document.createElement("p");o.className="toast-message",o.textContent=e.message;const r=document.createElement("span");r.className="toast-count",e.count>1&&(r.textContent=`\xD7${e.count}`,r.setAttribute("aria-label",`${e.count} occurrences`));const c=document.createElement("div");c.className="toast-actions";const s=document.createElement("button");if(s.type="button",s.className="toast-close",s.setAttribute("aria-label","Dismiss notification"),s.textContent="\u2715",s.addEventListener("click",()=>this.dismissToast(t,e,"close")),e.action){const S=document.createElement("button");S.type="button",S.className="toast-action",S.textContent=e.action.label,S.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation();try{e.action.handler()}finally{this.dismissToast(t,e,"action")}}),c.appendChild(S)}c.appendChild(s),a.appendChild(o),e.count>1&&a.appendChild(r),t.appendChild(n),t.appendChild(a),t.appendChild(c),this.toastContainer.firstChild?this.toastContainer.insertBefore(t,this.toastContainer.firstChild):this.toastContainer.appendChild(t);const d=this.dedupeMap.get(e.dedupeKey);d&&(d.toastEl=t,d.payload=e);const g={toastEl:t,payload:e,remaining:e.duration,hideTimer:null,startedAt:null};this.visibleToasts.push(g),this.lastShownAt=Date.now(),requestAnimationFrame(()=>{t.classList.add("show")});const E=()=>{g.hideTimer&&(clearTimeout(g.hideTimer),g.hideTimer=null,g.startedAt&&g.remaining&&(g.remaining-=Date.now()-g.startedAt))},b=()=>{g.hideTimer||e.duration===null||((typeof g.remaining!="number"||g.remaining<=0)&&(g.remaining=this.defaultDuration),g.startedAt=Date.now(),g.hideTimer=setTimeout(()=>{this.dismissToast(t,e,"timeout")},g.remaining))};t.addEventListener("mouseenter",E),t.addEventListener("focusin",E),t.addEventListener("mouseleave",b),t.addEventListener("focusout",b),e.duration!==null&&(g.remaining=e.duration,b()),this.motionQuery&&this.motionQuery.matches&&t.classList.add("toast-reduced-motion"),this.processQueue()},dismissToast(e,t,n){if(!e||e.dataset.dismissed==="true")return;e.dataset.dismissed="true",e.classList.remove("show");const a=this.visibleToasts.findIndex(r=>r.toastEl===e);if(a!==-1){const r=this.visibleToasts[a];r.hideTimer&&clearTimeout(r.hideTimer),this.visibleToasts.splice(a,1)}const o=this.dedupeMap.get(t.dedupeKey);o&&o.toastEl===e&&(o.toastEl=null),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e),this.processQueue()},this.motionQuery&&this.motionQuery.matches?0:250)},updateToastCount(e){if(e)if(e.toastEl){const t=e.toastEl.querySelector(".toast-count"),n=e.toastEl.querySelector(".toast-content");if(e.count>1){if(t)t.textContent=`\xD7${e.count}`,t.setAttribute("aria-label",`${e.count} occurrences`);else if(n){const o=document.createElement("span");o.className="toast-count",o.textContent=`\xD7${e.count}`,o.setAttribute("aria-label",`${e.count} occurrences`),n.appendChild(o)}}else t&&t.parentNode&&t.parentNode.removeChild(t);const a=this.visibleToasts.find(o=>o.toastEl===e.toastEl);a&&a.payload.duration!==null&&(a.hideTimer&&clearTimeout(a.hideTimer),a.remaining=Math.max(a.payload.duration,this.defaultDuration),a.startedAt=Date.now(),a.hideTimer=setTimeout(()=>{this.dismissToast(a.toastEl,a.payload,"timeout")},a.remaining))}else e.payload&&(e.payload.count=e.count)},getDedupeKey(e){return`${e.type}::${e.message}::${e.action?e.action.label:""}`}}),window.NotificationManager||Logger.warn("MANAGERS","NotificationManager is not loaded before managers.js"),window.TabManager={configs:{mappings:{name:"Mappings",loadFunction:"loadMappings",clearFunction:"clearMappingFilters"},requests:{name:"Requests",loadFunction:"loadRequests",clearFunction:"clearRequestFilters"},scenarios:{name:"Scenarios",loadFunction:"loadScenarios",clearFunction:null}},getCurrentTab(){const e=document.querySelector(".tab-link.active");if(e){const t=e.getAttribute("onclick");if(t){const n=t.match(/showTab\(['"](\w+)['"]\)/);if(n)return n[1]}}return"mappings"},async refresh(e){const t=this.configs[e];if(!t){Logger.warn("MANAGERS",`Tab config not found: ${e}`);return}try{const n=window[t.loadFunction];typeof n=="function"?(await n(),Logger.info("MANAGERS",`${t.name} refreshed`)):Logger.warn("MANAGERS",`Load function not found: ${t.loadFunction}`)}catch(n){Logger.error("MANAGERS",`Error refreshing ${t.name}:`,n),NotificationManager.error(`Failed to refresh ${t.name}: ${n.message}`)}},clearFilters(e){const t=this.configs[e];if(!(!t||!t.clearFunction))try{const n=window[t.clearFunction];typeof n=="function"&&(n(),Logger.info("MANAGERS",`${t.name} filters cleared`))}catch(n){Logger.error("MANAGERS",`Error clearing ${t.name} filters:`,n)}}};function updateURLFilterParams(e,t="mappings"){if(!window.history||!window.history.replaceState)return;const n=new URL(window.location.href),a=`${t}_filter`;e?n.searchParams.set(a,e):n.searchParams.delete(a),window.history.replaceState({},"",n.toString())}function getFilterFromURL(e="mappings"){const t=new URLSearchParams(window.location.search),n=`${e}_filter`;return t.get(n)}function getActiveTabFromURL(){return new URLSearchParams(window.location.search).get("tab")}window.updateURLFilterParams=updateURLFilterParams,window.getFilterFromURL=getFilterFromURL,window.getActiveTabFromURL=getActiveTabFromURL,Logger.info("MANAGERS","Managers.js loaded - NotificationManager, TabManager, URL helpers");const FILTER_STATE_PREFIX="imock-filters-";window.FilterManager={saveFilterState(e,t){try{const n=`${FILTER_STATE_PREFIX}${e}`;localStorage.setItem(n,JSON.stringify(t))}catch(n){Logger.warn("MANAGERS","Failed to save filter state:",n)}},loadFilterState(e){try{const t=`${FILTER_STATE_PREFIX}${e}`,n=localStorage.getItem(t);return n?JSON.parse(n):{}}catch(t){return Logger.warn("MANAGERS","Failed to load filter state:",t),{}}},applyMappingFilters(){typeof this._applyMappingFilters=="function"&&this._applyMappingFilters()},flushMappingFilters(){this._applyMappingFilters&&typeof this._applyMappingFilters.flush=="function"&&this._applyMappingFilters.flush()},applyRequestFilters(){typeof this._applyRequestFilters=="function"&&this._applyRequestFilters()},flushRequestFilters(){this._applyRequestFilters&&typeof this._applyRequestFilters.flush=="function"&&this._applyRequestFilters.flush()},restoreFilters(e){if(e==="mappings"){const t=getFilterFromURL("mappings");if(t){const a=document.getElementById("filter-query");return a&&(a.value=t),{query:t}}const n=this.loadFilterState(e);if(n.query){const a=document.getElementById("filter-query");a&&(a.value=n.query)}return n}else if(e==="requests"){const t=getFilterFromURL("requests");if(t){const c=document.getElementById("req-filter-query");if(c)return c.value=t,{query:t}}const n=this.loadFilterState(e),a=document.getElementById("req-filter-query");a&&n.query&&(a.value=n.query);const o=document.getElementById("req-filter-from"),r=document.getElementById("req-filter-to");return o&&(o.value=n.from||""),r&&(r.value=n.to||""),n}return{}},getFiltersFromURL(e){return{query:getFilterFromURL(e)||""}},hasURLFilters(e){const t=this.getFiltersFromURL(e);return Object.values(t).some(n=>n!=="")}},Logger.info("MANAGERS","Filter state manager loaded");const CUSTOM_PRESETS_KEY="imock-filter-presets-custom";window.FilterPresetsManager={getAllPresets(){try{const e=localStorage.getItem(CUSTOM_PRESETS_KEY);return e?JSON.parse(e):{}}catch(e){return Logger.warn("MANAGERS","Failed to load custom presets:",e),{}}},applyPreset(e,t="mappings"){const a=this.getAllPresets()[e];if(!a){Logger.warn("MANAGERS",`Preset not found: ${e}`);return}if(t==="mappings"){const o=document.getElementById("filter-method"),r=document.getElementById("filter-url"),c=document.getElementById("filter-status");o&&(o.value=a.filters.method||""),r&&(r.value=a.filters.query||""),c&&(c.value=a.filters.status||""),typeof window.applyFilters=="function"&&window.applyFilters(),a.filters.method&&typeof window.syncFilterTabsFromSelect=="function"&&window.syncFilterTabsFromSelect("mapping",a.filters.method),typeof NotificationManager<"u"&&NotificationManager.info(`Applied preset: ${a.name}`)}},saveCustomPreset(e,t){try{const n=this.getCustomPresets();n[e]=t,localStorage.setItem(CUSTOM_PRESETS_KEY,JSON.stringify(n)),typeof NotificationManager<"u"&&NotificationManager.success(`Preset "${t.name}" saved`),typeof window.renderFilterPresets=="function"&&window.renderFilterPresets()}catch(n){Logger.error("MANAGERS","Failed to save preset:",n),typeof NotificationManager<"u"&&NotificationManager.error("Failed to save preset")}},getCustomPresets(){try{const e=localStorage.getItem(CUSTOM_PRESETS_KEY);return e?JSON.parse(e):{}}catch(e){return Logger.warn("MANAGERS","Failed to load custom presets:",e),{}}},deleteCustomPreset(e){try{const t=this.getCustomPresets();delete t[e],localStorage.setItem(CUSTOM_PRESETS_KEY,JSON.stringify(t)),typeof NotificationManager<"u"&&NotificationManager.success("Preset deleted"),typeof window.renderFilterPresets=="function"&&window.renderFilterPresets()}catch(t){Logger.error("MANAGERS","Failed to delete preset:",t),typeof NotificationManager<"u"&&NotificationManager.error("Failed to delete preset")}},getCurrentFiltersAsPreset(e="mappings"){return e==="mappings"?{method:document.getElementById("filter-method")?.value||"",query:document.getElementById("filter-url")?.value||"",status:document.getElementById("filter-status")?.value||""}:{}}},Logger.info("MANAGERS","Filter presets manager loaded"),(function(){const e=Date.now(),t=(c=0)=>new Date(e-c).toISOString(),n=[{id:"demo-mapping-products-list",name:"List products",priority:1,request:{method:"GET",urlPath:"/api/products",headers:{Accept:"application/json"}},response:{status:200,headers:{"Content-Type":"application/json"},jsonBody:{items:[{id:"sku-1000",name:"Demo Sneakers",price:129.99},{id:"sku-1001",name:"Demo Backpack",price:89.5}]}},metadata:{created:t(1e3*60*60*6),edited:t(1e3*60*60*2),source:"demo-seed",tags:["catalog","demo"]}},{id:"demo-mapping-create-order",name:"Create order",priority:2,persistent:!0,request:{method:"POST",urlPath:"/api/orders",bodyPatterns:[{matchesJsonPath:"$.items[*].sku"}]},response:{status:201,fixedDelayMilliseconds:120,headers:{"Content-Type":"application/json",Location:"/api/orders/90001"},jsonBody:{orderId:"90001",status:"processing",estimatedDelivery:t(-1e3*60*15)}},metadata:{created:t(1e3*60*60*12),edited:t(1e3*60*45),scenarioName:"checkout-flow",source:"demo-seed"}},{id:"demo-mapping-update-profile",name:"Update profile",priority:3,request:{method:"PUT",urlPattern:"/api/users/\\d+",headers:{"X-Demo-Auth":"Bearer ***"}},response:{status:204,headers:{"X-Demo-Trace":"profile-update"}},metadata:{created:t(1e3*60*30),edited:t(1e3*60*15),source:"demo-seed",tags:["profile"]}},{id:"demo-mapping-delete-session",name:"Delete session",priority:4,request:{method:"DELETE",urlPathPattern:"/api/sessions/.*"},response:{status:202,headers:{"Retry-After":"30"},jsonBody:{status:"scheduled"}},metadata:{created:t(1e3*60*60*3),source:"demo-seed"}}],a=[{id:"demo-request-001",wasMatched:!0,request:{method:"GET",url:"/api/products",urlPath:"/api/products",loggedDate:t(1e3*60*8),headers:{Accept:["application/json"],Host:["demo.wiremock.local"]},clientIp:"192.168.10.14"},responseDefinition:{status:200,headers:{"Content-Type":"application/json"},body:JSON.stringify({items:[{id:"sku-1000"},{id:"sku-1001"}]})}},{id:"demo-request-002",wasMatched:!1,request:{method:"POST",url:"/api/orders",loggedDate:t(1e3*60*5),body:JSON.stringify({items:[]}),headers:{"Content-Type":["application/json"],Host:["demo.wiremock.local"]},clientIp:"192.168.10.18"},responseDefinition:{status:404,body:"No matching mapping found",headers:{"Content-Type":"text/plain"}}},{id:"demo-request-003",wasMatched:!0,request:{method:"PATCH",url:"/api/orders/90001",loggedDate:t(1e3*60*3),body:JSON.stringify({status:"cancelled"}),headers:{"Content-Type":["application/json"],"X-Demo-Auth":["Bearer demo-token"]},clientIp:"192.168.10.20"},responseDefinition:{status:409,body:JSON.stringify({message:"Order already fulfilled"}),headers:{"Content-Type":"application/json"}}},{id:"demo-request-004",wasMatched:!0,request:{method:"DELETE",url:"/api/sessions/abc123",loggedDate:t(1e3*60*2),headers:{"X-Demo-Auth":["Bearer demo-token"],Host:["demo.wiremock.local"]},clientIp:"192.168.10.22"},responseDefinition:{status:202,body:"Session deletion scheduled",headers:{"Retry-After":"30"}}}],o={generatedAt:t()},r=c=>JSON.parse(JSON.stringify(c));window.DemoData={isAvailable(){return n.length>0||a.length>0},getMappingsPayload(){return{mappings:r(n),meta:{...o},__source:"demo"}},getRequestsPayload(){return{requests:r(a),meta:{...o},__source:"demo"}},getDataset(){return{mappings:r(n),requests:r(a),meta:{...o},__source:"demo"}}}})(),(function(t){const n=t,a=n.FeaturesState||{},o=1e3;n.mappingIndex instanceof Map||(n.mappingIndex=new Map),n.mappingTabTotals??(n.mappingTabTotals={all:0,get:0,post:0,put:0,patch:0,delete:0}),n.requestTabTotals??(n.requestTabTotals={all:0,matched:0,unmatched:0}),n.pendingDeletedIds instanceof Set||(n.pendingDeletedIds=new Set),n.deletionTimeouts instanceof Map||(n.deletionTimeouts=new Map),n.isDemoMode??(n.isDemoMode=!1),n.demoModeAnnounced??(n.demoModeAnnounced=!1),n.demoModeLastError??(n.demoModeLastError=null);let r=null;function c(M="automatic"){n.isDemoMode=!0,n.demoModeReason=M,!n.demoModeAnnounced&&n.NotificationManager?.info&&(n.NotificationManager.info("WireMock API unreachable. Showing demo data so the interface stays interactive."),n.demoModeAnnounced=!0)}function s(M){if(!M||typeof M!="object")return;n.mappingIndex instanceof Map||(n.mappingIndex=new Map);const w=new Set;["id","uuid","stubMappingId","stubId","mappingId"].forEach(D=>{M[D]&&w.add(String(M[D]).trim())}),M.metadata?.id&&w.add(String(M.metadata.id).trim()),w.forEach(D=>{D&&n.mappingIndex.set(D,M)})}function d(M){n.mappingIndex instanceof Map?n.mappingIndex.clear():n.mappingIndex=new Map,Array.isArray(M)&&M.forEach(s)}function g(M=[]){const w={all:0,get:0,post:0,put:0,patch:0,delete:0};return(!Array.isArray(M)||M.length===0)&&(M=n.MappingsStore?.getAll?n.MappingsStore.getAll():[]),!Array.isArray(M)||M.length===0||(w.all=M.length,M.forEach(D=>{const O=(D?.request?.method||"").toLowerCase();Object.prototype.hasOwnProperty.call(w,O)&&(w[O]+=1)})),w}function E(){const M=n.MappingsStore?.getAll?n.MappingsStore.getAll():[];n.mappingTabTotals=g(M)}function b(M=[]){const w={all:0,matched:0,unmatched:0};return!Array.isArray(M)||M.length===0||(w.all=M.length,M.forEach(D=>{D?.wasMatched!==!1?w.matched+=1:w.unmatched+=1})),w}function S(){const M=n.MappingsStore?.getAllRequests?n.MappingsStore.getAllRequests():[];n.requestTabTotals=b(M),typeof n.updateRequestTabCounts=="function"&&n.updateRequestTabCounts()}function I(M){if(!(n.mappingIndex instanceof Map))return;const w=typeof M=="object"?M:n.mappingIndex.get(M);if(w)for(const[D,O]of n.mappingIndex.entries())(O===w||D===M)&&n.mappingIndex.delete(D)}async function L({force:M=!1}={}){if(r){if(!M)return Logger.debug("STATE","fetchMappingsFromServer: reusing in-flight request"),r;try{Logger.debug("STATE","fetchMappingsFromServer: waiting for in-flight request before force refresh");const D=await r;if(Date.now()-(n._lastMappingsFetchTime||0)<o)return Logger.debug("STATE","fetchMappingsFromServer: reusing just-completed result"),D}catch(D){Logger.warn("STATE","fetchMappingsFromServer: previous request failed, starting a new one",D)}}const w=(async()=>{try{const D=await n.apiFetch(n.ENDPOINTS.MAPPINGS);return n._lastMappingsFetchTime=Date.now(),D}catch(D){throw n.demoModeLastError=D,D}finally{r===w&&(r=null)}})();return r=w,w}function B(M,w,D={}){try{if(!M){Logger.warn("STATE","updateOptimisticCache: no mapping provided");return}const O=M.id||M.uuid;if(w==="delete"){if(!O){Logger.warn("STATE","updateOptimisticCache: delete operation requires mapping ID");return}n.MappingsStore?.items instanceof Map&&(n.MappingsStore.items.delete(O),typeof n.MappingsStore?.addPending=="function"&&n.MappingsStore.addPending({id:O,type:"delete",payload:null,optimisticMapping:null}),typeof n.MappingsStore.rebuildIndexes=="function"&&n.MappingsStore.rebuildIndexes()),n.cacheLastUpdate=Date.now(),typeof n.refreshMappingsFromCache=="function"&&n.refreshMappingsFromCache(),Logger.info("STATE","Deleted mapping from optimistic cache:",O);return}if(!O){Logger.warn("STATE","updateOptimisticCache: mapping must have an id or uuid");return}if(n.MappingsStore?.items instanceof Map){const Q=n.MappingsStore.items.get(O),de=Q&&w==="update"?{...Q,...M}:M;n.MappingsStore.items.set(O,de),D.queueMode==="add"&&typeof n.MappingsStore?.addPending=="function"?n.MappingsStore.addPending({id:O,type:w,payload:M,optimisticMapping:de}):D.queueMode==="confirm"&&typeof n.MappingsStore?.confirmPending=="function"&&n.MappingsStore.confirmPending(O),typeof n.MappingsStore.rebuildIndexes=="function"&&n.MappingsStore.rebuildIndexes()}n.cacheLastUpdate=Date.now(),typeof n.refreshMappingsFromCache=="function"&&n.refreshMappingsFromCache(),Logger.info("STATE",`[updateOptimisticCache] ${w} mapping:`,O)}catch(O){Logger.error("STATE","updateOptimisticCache failed:",O)}}if(a.markDemoModeActive=c,a.addMappingToIndex=s,a.rebuildMappingIndex=d,a.computeMappingTabTotals=g,a.refreshMappingTabSnapshot=E,a.computeRequestTabTotals=b,a.refreshRequestTabSnapshot=S,a.removeMappingFromIndex=I,a.fetchMappingsFromServer=L,a.updateOptimisticCache=B,n.markDemoModeActive=c,n.addMappingToIndex=s,n.rebuildMappingIndex=d,n.computeMappingTabTotals=g,n.refreshMappingTabSnapshot=E,n.computeRequestTabTotals=b,n.refreshRequestTabSnapshot=S,n.removeMappingFromIndex=I,n.fetchMappingsFromServer=L,n.updateOptimisticCache=B,n.FeaturesState=a,Logger.info("STATE","state.js loaded - State management functions registered"),typeof n.dispatchEvent=="function"){let M;typeof n.CustomEvent=="function"?M=new CustomEvent("features:state-ready",{detail:{state:a}}):typeof document<"u"&&document.createEvent&&(M=document.createEvent("Event"),M.initEvent("features:state-ready",!1,!1),M.detail={state:a}),M&&n.dispatchEvent(M)}})(typeof window<"u"?window:globalThis);const Utils={escapeHtml:e=>typeof e!="string"?String(e):e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[t]),normalizeScenarioName:(e,t="_")=>{if(e==null)return{original:e,normalized:e,changed:!1,cleared:!1,hadWhitespace:!1};const n=typeof e=="string"?e:String(e),a=/\s/.test(n),o=n.trim().replace(/\s+/g,t);return{original:n,normalized:o,changed:o!==n,cleared:!!n&&!o,hadWhitespace:a}},formatJson:(e,t="Invalid JSON",n=1e3)=>{try{const a=JSON.stringify(e,null,2);return a.length>n?a.substring(0,n)+`
... (truncated - `+(a.length-n)+" more characters)":a}catch{return t}},parseRequestTime:e=>{if(!e)return new Date().toLocaleString("en-US");try{const t=new Date(typeof e=="number"?e>1e12?e:e*1e3:e);return isNaN(t.getTime())?`Invalid: ${e}`:t.toLocaleString("en-US")}catch{return`Invalid: ${e}`}},getStatusClass:e=>{const t=parseInt(e)||0;return t>=200&&t<300?"success":t>=300&&t<400?"redirect":t>=400&&t<500?"client-error":t>=500?"server-error":"unknown"},formatDateTime:e=>{const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),o=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${t}-${n}-${a}T${o}:${r}`},isFunction:e=>typeof e=="function",safeCall:(e,...t)=>{if(typeof e=="function")return e(...t)},toggleElement:(e,t)=>{e&&(t?e.classList.remove("hidden"):e.classList.add("hidden"))},showElement:e=>{e&&e.classList.remove("hidden")},hideElement:e=>{e&&e.classList.add("hidden")}},escapeHtml=Utils.escapeHtml;window.Utils=Utils,window.escapeHtml=escapeHtml,(function(){if(window.SettingsStore)return;const t=()=>{const r=window.Utils?.safeCall?.(window.readWiremockSettings);if(r)return r;try{const c=localStorage.getItem("wiremock-settings");if(!c)return{};const s=JSON.parse(c),d=window.Utils?.safeCall?.(window.normalizeWiremockSettings,s);return d||(s&&typeof s=="object"?s:{})}catch(c){return Logger.warn("UI","Failed to parse stored settings, falling back to defaults:",c),{}}},n=r=>{const c=(r||"").trim();if(!c)return{headers:{},raw:""};try{const s=JSON.parse(c);if(!s||typeof s!="object"||Array.isArray(s))throw new Error("Custom headers must be a JSON object.");return{headers:s,raw:c}}catch{const d=c.split(/\n+/),g={};let E=!0;for(const b of d){if(!b.trim())continue;const S=b.indexOf(":");if(S===-1){E=!1;break}const I=b.slice(0,S).trim(),L=b.slice(S+1).trim();if(!I){E=!1;break}g[I]=L}if(E&&Object.keys(g).length>0)return{headers:g,raw:c};throw new Error('Custom headers must be valid JSON or "Key: Value" pairs.')}},a=r=>{if(!r)return"";if(r.customHeadersRaw)return r.customHeadersRaw;if(r.customHeaders&&typeof r.customHeaders=="object"&&!Array.isArray(r.customHeaders))try{return JSON.stringify(r.customHeaders,null,2)}catch(c){Logger.warn("UI","Failed to serialize custom headers:",c)}return""},o=r=>!!(r&&r.host&&r.port&&r.autoConnect!==!1);window.SettingsStore={getStoredSettings:t,parseCustomHeadersInput:n,serializeCustomHeaders:a,shouldAutoConnect:o}})(),(function(t){if(t.TemplateRepoModule)return;function n(a={}){const o=a.runtime||t,r=a.storageKey||"imock-custom-templates",c=typeof a.getEmptyTemplate=="function"?a.getEmptyTemplate:()=>null,s={builtIn:null,user:null,userSignature:"",merged:null,mergedSignature:"",enriched:null,enrichedSignature:""},d=(...y)=>{if(o.Logger&&typeof o.Logger.warn=="function"){o.Logger.warn(...y);return}try{console.warn(...y)}catch{}},g=y=>({category:"custom",source:"user",...y,category:y?.category||"custom",source:y?.source||"user"}),E=(y="all")=>{(y==="all"||y==="user")&&(s.user=null),s.merged=null,s.mergedSignature="",s.enriched=null,s.enrichedSignature=""},b=()=>{if(s.builtIn)return[...s.builtIn];try{const y=o.MonacoTemplateLibrary?.getAll?.();return Array.isArray(y)?(s.builtIn=y.map(N=>({...N,source:"built-in"})),[...s.builtIn]):[]}catch(y){return d("TEMPLATES","Unable to read Monaco template library:",y),[]}},S=()=>{const y=localStorage.getItem(r);if(s.user&&s.userSignature===y)return[...s.user];try{const N=y?JSON.parse(y):[];return s.user=Array.isArray(N)?N.map($=>g($)):[],s.userSignature=y||"",[...s.user]}catch(N){return d("TEMPLATES","Failed to read user templates from storage:",N),[]}},I=y=>{try{const N=(y||[]).filter(Boolean).map(G=>g(G)),$=JSON.stringify(N);localStorage.setItem(r,$),s.user=[...N],s.userSignature=$,E("user")}catch(N){d("TEMPLATES","Failed to persist user templates:",N)}},L=()=>{const y=[...b(),...S()],N=c();N&&!y.some(G=>G.id===N.id)&&y.unshift(N);const $=y.map(G=>`${G.id}:${G.source||""}:${G.title||""}`).join("|");return s.merged&&s.mergedSignature===$?s.merged:(s.merged=y,s.mergedSignature=$,s.enriched=null,s.enrichedSignature="",y)},B=()=>L(),M=y=>B().find(N=>N.id===y)||null,w=y=>{const N=new Set,$=y.content||{},G=$.request||{},fe=$.response||{},Pe=G.method||"ANY";return N.add(Pe),$.category&&N.add($.category),y.category&&N.add(y.category),y.source==="user"&&N.add("custom"),(G.bodyPatterns||G.multipartPatterns)&&N.add("matching"),G.headers&&N.add("headers"),G.queryParameters&&N.add("query"),G.cookies&&N.add("cookies"),(G.urlPathPattern||G.urlPattern||G.urlPathTemplate)&&N.add("pattern"),Array.isArray(G.bodyPatterns)&&G.bodyPatterns.some(Oe=>Oe.matchesJsonPath||Oe.matchesXPath)&&N.add("jsonpath"),(fe.proxyBaseUrl||$.proxyBaseUrl)&&N.add("proxy"),(fe.serveEventListeners||$.serveEventListeners||fe.postServeActions)&&N.add("webhook"),(fe.transformers||$.transformers)&&N.add("templating"),(fe.fixedDelayMilliseconds||fe.delayDistribution||fe.chunkedDribbleDelay)&&N.add("delay"),fe.fault&&N.add("fault"),$.mappings&&N.add("scenario"),y.popular&&N.add("popular"),Array.from(N)},D=y=>{const N=y.content||{},$=N.response||{};return $.proxyBaseUrl||N.proxyBaseUrl?"proxy":$.fault?"fault":$.status?`${$.status}`:Array.isArray(N.mappings)&&N.mappings.length?"scenario":"200"},O=y=>{const N=y.content||{},$=N.request||{};return $.method?$.method:Array.isArray(N.mappings)&&N.mappings[0]?.request?.method?N.mappings[0].request.method:"ANY"},Q=y=>{const N=O(y),$=D(y),G=w(y),fe=!!y.popular||["basic","integration","proxy"].includes(y.category),Pe=Array.isArray(y.content?.mappings)&&y.content.mappings.length>0;return{...y,method:N,outcome:$,tags:G,popular:fe,isScenario:Pe}},de=()=>{const y=L();return s.enriched&&s.enrichedSignature===s.mergedSignature||(s.enriched=y.map(Q),s.enrichedSignature=s.mergedSignature),s.enriched},se=y=>{if(y==null||y==="")return null;if(typeof y=="object")return{jsonBody:y};try{return{jsonBody:JSON.parse(y)}}catch{return{body:y}}},be=(y,N)=>N?(Array.isArray(N)?N:String(N).split(".").map(G=>G.match(/^\d+$/)?Number(G):G)).reduce((G,fe)=>G&&typeof G=="object"?G[fe]:void 0,y):void 0,Ne=y=>{if(y===null)return"null";if(typeof y>"u")return"";if(typeof y=="string")return y.length>64?`${y.slice(0,61)}\u2026`:y;if(typeof y=="number"||typeof y=="boolean")return String(y);try{const N=JSON.stringify(y);return N.length>80?`${N.slice(0,77)}\u2026`:N}catch(N){return d("TEMPLATES","Failed to serialise feature value",N),""}};return{normalizeUserTemplate:g,invalidateTemplateCache:E,getBuiltInTemplates:b,readUserTemplates:S,persistUserTemplates:I,getAllTemplates:B,findTemplateById:M,getTemplatesWithMeta:de,toJsonBody:se,resolveTemplatePath:be,formatFeatureValue:Ne,getTemplateFeature:y=>{if(!y||!y.feature)return null;const N=y.feature.path||y.feature,$=y.feature.label||(Array.isArray(N)?N.join("."):String(N)),G=be(y.content,N);return typeof G>"u"?null:{label:$,value:Ne(G)}},getTemplateHeadline:y=>{if(!y)return"";if(y.highlight)return y.highlight;const N=[];return y.content?.request?.method&&N.push(y.content.request.method),(y.content?.request?.url||y.content?.request?.urlPath)&&N.push(y.content.request.url||y.content.request.urlPath),N.join(" \xB7 ")},buildTemplatePreview:y=>{try{const N=y.content?y.content:{};if(typeof N=="string")return N;const fe=JSON.stringify(N,null,2).split(`
`).slice(0,24).join(`
`);return fe.length>1280?`${fe.slice(0,1279)}\u2026`:fe}catch{return"[unavailable template preview]"}}}}t.TemplateRepoModule={createTemplateRepo:n}})(typeof window<"u"?window:globalThis),(function(t){if(t.TemplateActionsModule)return;function n(a={}){const o=a.runtime||t,r=a.selectors||{},c=typeof a.getAllTemplates=="function"?a.getAllTemplates:()=>[],s=E=>{const b=document.createElement("option");b.value=E.id;const S=E.title||E.name||E.id;return b.textContent=E.source==="user"?`${S} (yours)`:S,b.dataset.source=E.source||"built-in",b};return{createOption:s,populateSelectors:()=>{const E=c();[r.FORM,r.EDITOR].forEach(b=>{const S=document.getElementById(b);if(!S)return;const I=S.value;S.innerHTML='<option value="">Select a template</option>',E.forEach(L=>S.appendChild(s(L))),I&&E.some(L=>L.id===I)&&(S.value=I)})},copyTextToClipboard:E=>{const b=typeof E=="string"?E:String(E??"");if(typeof navigator<"u"&&navigator.clipboard?.writeText)return navigator.clipboard.writeText(b).then(()=>!0).catch(()=>S(b));return Promise.resolve(S(b));function S(I){try{const L=document.createElement("textarea");return L.value=I,L.setAttribute("readonly",""),L.style.position="absolute",L.style.left="-9999px",document.body.appendChild(L),L.select(),document.execCommand("copy"),document.body.removeChild(L),!0}catch(L){return o.Logger?.warn?.("TEMPLATES","Clipboard fallback failed:",L),!1}}}}}t.TemplateActionsModule={createTemplateActions:n}})(typeof window<"u"?window:globalThis),(function(t){const n="imock-custom-templates",a={FORM:"template-selector",EDITOR:"editor-template-selector"},o={GALLERY:"template-gallery-modal",PREVIEW:"template-preview-modal"},r=[{id:"happy-path",icon:"\u2713",title:"Happy path",subtitle:"Client flows succeed",color:"#10b981",description:"Standard successful API responses"},{id:"errors",icon:"\u26A0",title:"Errors",subtitle:"Client handles failures correctly",color:"#f59e0b",description:"HTTP errors and validation cases"},{id:"faults",icon:"\u26A1",title:"Network issues",subtitle:"Timeouts, disconnects, slow responses",color:"#ef4444",description:"Network fault simulation"},{id:"scenarios",icon:"\u21BB",title:"Scenarios",subtitle:"Stateful steps and retries",color:"#8b5cf6",description:"Changing service behaviour"},{id:"dynamic",icon:"\u2387",title:"Dynamic response",subtitle:"Response templating and conditions",color:"#3b82f6",description:"Response depends on request"},{id:"matching",icon:"\u{1F3AF}",title:"Request Matching",subtitle:"URL, headers, body, JSONPath",color:"#06b6d4",description:"Advanced request matching"},{id:"webhooks",icon:"\u{1F4E4}",title:"Webhooks",subtitle:"Asynchronous callbacks",color:"#ec4899",description:"Outgoing HTTP callbacks"},{id:"proxy",icon:"\u21C4",title:"Proxy & Record",subtitle:"Proxying and recording",color:"#14b8a6",description:"Working against real APIs"},{id:"custom",icon:"\u2605",title:"My templates",subtitle:"Saved by you",color:"#0ea5e9",description:"Personal templates you created"}],c="empty-mapping-skeleton",s={step:"goals",goalId:null,selectedTemplateId:null,searchQuery:"",activeTags:[],showPopularOnly:!1};let d="form";const g={templateId:null,target:null};let E="",b=null;const S={handler:null,label:null,mode:"mapping"};function I(){const f=document.getElementById("method"),v=document.getElementById("url-pattern"),R=document.getElementById("editor-method"),k=document.getElementById("editor-url"),_=f?.value||R?.value,F=v?.value||k?.value;return{method:(_||"GET").toUpperCase(),urlPath:F||"/api/example"}}function L(f=I()){const v={method:(f?.method||"GET").toUpperCase(),urlPath:f?.urlPath||"/api/example"};return{name:"Empty mapping",request:{method:v.method,urlPath:v.urlPath},response:{status:200}}}function B(f){return D(L(f))}function M(){const f=I(),v=B(f);return{id:c,title:"Empty mapping",description:"Create a minimal stub and fill in the request/response yourself.",category:"happy-path",highlight:`${v.request.method} \xB7 ${v.request.urlPath}`,feature:{path:["response","status"],label:"response.status"},content:v}}function w(f,v="info"){const R=t.NotificationManager;if(R&&typeof R[v]=="function"){R[v](f);return}console[v==="error"?"error":"log"](`[TEMPLATES] ${f}`)}function D(f){try{if(typeof structuredClone=="function")return structuredClone(f)}catch(v){Logger.warn("TEMPLATES","Failed to structuredClone, falling back to JSON:",v)}try{return JSON.parse(JSON.stringify(f))}catch(v){if(Logger.warn("TEMPLATES","Failed to JSON clone value, returning shallow copy:",v),f&&typeof f=="object")return Array.isArray(f)?[...f]:{...f}}return f}function O(f,v){g.templateId=f||null,g.target=f?v:null,de()}function Q(){return!!g.templateId&&(!g.target||g.target==="editor")}function de(){se(Q())}function se(f){const v=document.getElementById("update-mapping-btn");if(!v)return;const R=v.querySelector?.(".btn-label")||v;if(f){if(S.mode==="template-save")return;S.handler||(S.handler=v.onclick||(typeof t.updateMapping=="function"?k=>t.updateMapping(k):null)),!S.label&&R&&(S.label=R.textContent||"Update Mapping"),v.onclick=k=>(k?.preventDefault?.(),We({skipNamePrompt:!0,reuseExistingMetadata:!0})),R&&(R.textContent="Save template"),v.setAttribute("data-template-edit-mode","true"),S.mode="template-save";return}S.mode==="template-save"&&(v.onclick=S.handler||v.onclick,R&&S.label&&(R.textContent=S.label),v.removeAttribute("data-template-edit-mode"),S.mode="mapping")}function be(f){["id","uuid","stubMappingId","stubId","mappingId"].forEach(v=>delete f[v]),f.metadata&&delete f.metadata.id}function Ne(f){if(!f||typeof f!="object"||!Object.prototype.hasOwnProperty.call(f,"scenarioName"))return null;const v=_=>{if(_==null)return{original:_,normalized:_,changed:!1,cleared:!1,hadWhitespace:!1};const F=typeof _=="string"?_:String(_),j=/\s/.test(F),ee=F.trim().replace(/\s+/g,"_");return{original:F,normalized:ee,changed:ee!==F,cleared:!!F&&!ee,hadWhitespace:j}},k=(typeof t?.Utils?.normalizeScenarioName=="function"?t.Utils.normalizeScenarioName:v)(f.scenarioName);return!k?.changed||!k?.hadWhitespace?null:(k.cleared?delete f.scenarioName:f.scenarioName=k.normalized,{original:k.original,normalized:k.normalized,cleared:k.cleared})}function U(f,v={}){if(!f||typeof f!="object")return null;const{source:R="ui",seed:k=I(),scenarioFixes:_}=v,F=new Date().toISOString(),j=D(f);be(j),gt(j,k);const ee=Ne(j);return ee&&_ instanceof Map&&!_.has(ee.original)&&_.set(ee.original,ee),j.metadata={...j.metadata||{},created:j.metadata?.created||F,edited:F,source:j.metadata?.source||R},j}async function H(f,v={}){const{openMode:R="inline",source:k="ui",successMessageFactory:_}=v,F=Array.isArray(f)?f:[f],j=new Map,ee=F.map(x=>U(x,{source:k,scenarioFixes:j})).filter(Boolean);if(j.size){const x=Array.from(j.values()).slice(0,3).map(ne=>ne.cleared?"cleared":`"${ne.original}" \u2192 "${ne.normalized}"`).join(", ");w(`Scenario name cannot contain spaces. Normalized: ${x}`,"warning")}if(!ee.length)return w("No valid mapping payloads to create","warning"),{success:!1,createdIds:[]};const le=ee.map((x,ne)=>({index:ne,error:W(x)})).filter(x=>!!x.error);if(le.length){const x=le[0];return w(`Mapping payload is missing required fields (entry ${x.index+1}): ${x.error}`,"error"),{success:!1,createdIds:[]}}try{const x=[],ne=[];for(let Re=0;Re<ee.length;Re+=1){const at=ee[Re];try{const De=await apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(at)}),Ze=De?.mapping||De,rt=Ze?.id;if(rt&&typeof updateOptimisticCache=="function")try{updateOptimisticCache(Ze,"create")}catch(vt){Logger.warn("TEMPLATES","Failed to update optimistic cache after create:",vt)}rt&&x.push(rt)}catch(De){ne.push({index:Re,error:De});break}}if(ne.length){const Re=[];for(const Ze of x)try{await apiFetch(`/mappings/${Ze}`,{method:"DELETE"}),typeof updateOptimisticCache=="function"&&updateOptimisticCache({id:Ze},"delete")}catch(rt){Re.push(rt)}const at=ne[0],De=Re.length?` Rollback issues: ${Re.length} delete${Re.length===1?"":"s"} failed.`:"";return w(`Failed to create mapping ${at.index+1}/${ee.length}: ${at.error.message}.${De}`,"error"),Logger.error("TEMPLATES","Mapping create failed",{errors:ne,rollbackErrors:Re}),{success:!1,createdIds:[]}}const Ce=x.length||ee.length,$e=typeof _=="function"?_(Ce):`Created ${Ce} mapping${Ce===1?"":"s"}`;w($e,"success");const xe=x[0];return xe&&(R==="studio"&&typeof t.editMapping=="function"?t.editMapping(xe):typeof t.openEditModal=="function"&&t.openEditModal(xe)),{success:!0,createdIds:x}}catch(x){return w(`Failed to create mapping: ${x.message}`,"error"),Logger.error("TEMPLATES","Failed to create mapping from payloads",x),{success:!1,createdIds:[]}}}function P(){let f=document.getElementById("template-name-modal");if(f)return f;f=document.createElement("div"),f.id="template-name-modal",f.className="modal hidden",f.innerHTML=`
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="template-name-title">
                <div class="modal-header">
                    <div class="modal-header-main">
                        <h3 id="template-name-title" class="modal-title">Save as template</h3>
                        <p class="modal-subtitle">Name your template to reuse it later.</p>
                    </div>
                    <button type="button" class="modal-close" aria-label="Close" data-action="close-template-name">\xD7</button>
                </div>
                <div class="modal-body">
                    <label class="form-label" for="template-name-input">Template name</label>
                    <input id="template-name-input" class="form-control" type="text" name="template-name" placeholder="My template" />
                    <p class="form-hint">Titles help you find templates quickly in the gallery.</p>
                </div>
                <div class="modal-footer">
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" data-action="cancel-template-name">Cancel</button>
                        <button type="button" class="btn btn-primary" data-action="confirm-template-name">Save template</button>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(f),f.addEventListener("click",k=>{k.target===f&&y(null)}),f.querySelectorAll('[data-action="close-template-name"], [data-action="cancel-template-name"]').forEach(k=>k.addEventListener("click",()=>y(null))),f.querySelector('[data-action="confirm-template-name"]').addEventListener("click",()=>{const _=f.querySelector("#template-name-input")?.value?.trim();y(_||null)});const R=f.querySelector("#template-name-input");return R?.addEventListener("keydown",k=>{k.key==="Enter"&&(k.preventDefault(),y(R.value.trim()||null))}),f}function y(f){document.getElementById("template-name-modal")?.classList.add("hidden"),typeof b=="function"&&(b(f),b=null)}function N(f=""){const v=P(),R=v.querySelector("#template-name-input");return R&&(R.value=f||"",setTimeout(()=>R.focus(),0)),v.classList.remove("hidden"),b&&y(null),new Promise(k=>{b=k})}const $=!t.TemplateRepoModule||typeof t.TemplateRepoModule.createTemplateRepo!="function"?(Logger.error("TEMPLATES","TemplateRepoModule is not loaded"),null):t.TemplateRepoModule.createTemplateRepo({runtime:t,storageKey:n,getEmptyTemplate:M}),G=!t.TemplateActionsModule||typeof t.TemplateActionsModule.createTemplateActions!="function"?(Logger.error("TEMPLATES","TemplateActionsModule is not loaded"),null):t.TemplateActionsModule.createTemplateActions({runtime:t,selectors:a,getAllTemplates:tt});function fe(f){return $?.normalizeUserTemplate?$.normalizeUserTemplate(f):{...f}}function Pe(f="all"){return $?.invalidateTemplateCache?$.invalidateTemplateCache(f):void 0}function et(){return $?.getBuiltInTemplates?$.getBuiltInTemplates():[]}function Oe(){return $?.readUserTemplates?$.readUserTemplates():[]}function Ge(f){return $?.persistUserTemplates?$.persistUserTemplates(f):void 0}function tt(){return $?.getAllTemplates?$.getAllTemplates():[]}function St(f){return $?.findTemplateById?$.findTemplateById(f):null}function Je(){return $?.getTemplatesWithMeta?$.getTemplatesWithMeta():[]}function Et(f){return G?.createOption?G.createOption(f):document.createElement("option")}function Be(){G?.populateSelectors&&G.populateSelectors()}function nt(f){return $?.toJsonBody?$.toJsonBody(f):null}function ae(f){if(!f){w("Select a template first","warning");return}const v=f.content||{},R=v.request||{},k=v.response||{},_=document.getElementById("mapping-name"),F=document.getElementById("method"),j=document.getElementById("url-pattern"),ee=document.getElementById("response-status"),le=document.getElementById("response-body");_&&(_.value=v.name||f.title||f.id||""),F&&R.method&&(F.value=R.method),j&&(j.value=R.url||R.urlPath||""),ee&&typeof k.status<"u"&&(ee.value=k.status);const x=k.jsonBody??k.body;if(le&&typeof x<"u"){const ne=typeof x=="object"?JSON.stringify(x,null,2):String(x);le.value=ne}w(`Template "${f.title||f.id}" applied to form`,"success")}async function Me(){if(t.monacoInitializer?.isInitialized)return t.monacoInitializer;if(t.monacoInitializationPromise?.then)try{if(await t.monacoInitializationPromise,t.monacoInitializer?.isInitialized)return t.monacoInitializer}catch(f){Logger.warn("TEMPLATES","Monaco initializer failed to load in time",f)}return t.monacoInitializer}async function je(f){if(!f){w("Select a template first","warning");return}const v=f.content??{},R=await Me();if(R&&(typeof R.applyTemplate=="function"||typeof R.applyTemplateById=="function")){let F=!1;typeof R.applyTemplate=="function"?F=R.applyTemplate(f):F=R.applyTemplateById?.(f.id),w(F?`Template "${f.title||f.id}" applied to editor`:"Template could not be applied",F?"success":"error");return}const k=typeof v=="string"?v:JSON.stringify(v,null,2),_=document.getElementById("json-editor");if(_){_.value=k;try{const j=JSON.parse(typeof v=="string"?v:JSON.stringify(v));t.editorState&&(t.editorState.currentMapping=j,t.editorState.isDirty=!0)}catch(j){Logger.warn("TEMPLATES","Failed to parse template content into editorState:",j)}const F=document.getElementById("editor-dirty-indicator");F&&(F.style.display="inline")}w(`Template "${f.title||f.id}" applied to editor`,"success")}async function Fe(f,v={}){const{openMode:R="inline"}=v;if(!f){w("Select a template first","warning");return}const k=bt(f);if(!k){w("Template content is not available","error");return}const _=Array.isArray(k)?k:[k],F=_.map((j,ee)=>({index:ee,error:W(j)})).filter(j=>!!j.error);if(F.length){const j=F[0];w(`Template is missing required fields (entry ${j.index+1}): ${j.error}`,"error");return}try{await H(_,{openMode:R,source:"template",successMessageFactory:j=>`Created ${j} mapping${j===1?"":"s"} from template`})}catch(j){w(`Failed to create mapping: ${j.message}`,"error"),Logger.error("TEMPLATES","Failed to create mapping from template",j)}finally{t.hideModal?.(o.GALLERY),t.hideModal?.(o.PREVIEW)}}function Ye(){const f=M();if(ke()){Fe(f,{openMode:d==="create-studio"?"studio":"inline"});return}it(f,d)}async function Ve(){const f=await N(document.getElementById("mapping-name")?.value||"")||"";if(!f.trim()){w("Template name is required","warning");return}const v=document.getElementById("method")?.value||"GET",R=document.getElementById("url-pattern")?.value||"/api/example",k=parseInt(document.getElementById("response-status")?.value,10)||200,_=document.getElementById("response-body")?.value||"",F=!!g.templateId&&(!g.target||g.target==="form"),j=F?Oe().find(le=>le.id===g.templateId):null,ee={id:F&&j?j.id:`user-${Date.now()}`,title:f.trim(),description:j?.description||"User template saved from mapping form",category:"custom",source:"user",content:{name:f.trim(),request:{method:v,urlPath:R},response:{status:k,...nt(_)||{}}}};if(F&&j)Ie(j.id,ee),O(null),w(`Template "${f.trim()}" updated`,"success");else{const le=Oe();le.push(ee),Ge(le),Te({force:!0}),Be(),w(`Template "${f.trim()}" saved`,"success"),O(null)}}async function We(f={}){const{skipNamePrompt:v=!1,reuseExistingMetadata:R=!1}=f,k=document.getElementById("json-editor");if(!k){w("Editor not available","warning");return}const _=!!g.templateId&&(!g.target||g.target==="editor"),F=_?Oe().find(x=>x.id===g.templateId):null;let j="";if(_&&F&&(v||R)?j=F.title||"":j=await N(F?.title||"")||"",!j.trim()){w("Template name is required","warning");return}let ee;try{ee=JSON.parse(k.value)}catch{w("Cannot save template: current JSON is invalid","error");return}const le={id:_&&F?F.id:`user-${Date.now()}`,title:j.trim(),description:R&&F?.description||F?.description||"User template saved from JSON editor",category:"custom",source:"user",content:ee};if(_&&F)Ie(F.id,le),O(null),w(`Template "${j.trim()}" updated`,"success");else{const x=Oe();x.push(le),Ge(x),Te({force:!0}),Be(),w(`Template "${j.trim()}" saved`,"success"),O(null)}}function Ie(f,v={}){if(!f)return null;const R=Oe(),k=R.findIndex(j=>j.id===f);if(k===-1)return null;const _=R[k],F=fe({..._,...v.title?{title:v.title}:{},...v.description?{description:v.description}:{},...v.content?{content:v.content}:{}});return R[k]=F,Ge(R),Te({force:!0}),Be(),F}async function qe(f,v={}){const R=Oe().find(_=>_.id===f);if(!R)return w("Template not found","warning"),!1;const k=v.target||(document.getElementById("json-editor")?"editor":"form");return O(f,k),k==="editor"?(it(R,"editor"),w("Template loaded into JSON Studio. Save to keep changes.","info"),document.getElementById("update-mapping-btn")?.focus?.()):(it(R,"form"),w("Template loaded into mapping form. Update and save to keep changes.","info"),document.getElementById("save-template-btn")?.focus?.()),!0}function Se(f,v={}){const{skipConfirm:R=!1}=v;if(!f)return!1;const k=Oe(),_=k.find(j=>j.id===f);if(!_||!R&&typeof t.confirm=="function"&&!t.confirm(`Delete template "${_.title||_.id}"? This cannot be undone.`))return!1;const F=k.filter(j=>j.id!==f);return Ge(F),Te({force:!0}),Be(),w(`Template "${_.title||_.id}" deleted`,"info"),g.templateId===f&&O(null),!0}function He(f,v){return $?.resolveTemplatePath?$.resolveTemplatePath(f,v):void 0}function mt(f){return $?.formatFeatureValue?$.formatFeatureValue(f):""}function st(f){return $?.getTemplateFeature?$.getTemplateFeature(f):null}function ct(f){return $?.getTemplateHeadline?$.getTemplateHeadline(f):""}function lt(f){return $?.buildTemplatePreview?$.buildTemplatePreview(f):"[unavailable template preview]"}function dt(f){return G?.copyTextToClipboard?G.copyTextToClipboard(f):Promise.resolve(!1)}function ke(f=d){return typeof f=="string"&&f.startsWith("create")}function gt(f,v){f.request||(f.request={}),f.response||(f.response={}),f.request.method||(f.request.method=v.method||"ANY"),f.request.url||f.request.urlPath||f.request.urlPattern||f.request.urlPathPattern||f.request.urlPathTemplate||(f.request.urlPath=v.urlPath||v.url||"/api/example"),typeof f.response.status!="number"&&!("fault"in f.response)&&(f.response.status=200)}function bt(f){if(!f)return null;let v=f.content??{};if(typeof v=="string")try{v=JSON.parse(v)}catch(j){Logger.warn("TEMPLATES","Failed to parse string template content:",j),v={}}const R=new Date().toISOString(),k=j=>{["id","uuid","stubMappingId","stubId","mappingId"].forEach(ee=>delete j[ee])},_=I();if(Array.isArray(v?.mappings))return v.mappings.map((ee,le)=>{const x=JSON.parse(JSON.stringify(ee||{}));return k(x),x.name=x.name||`${f.title||f.id||"Scenario mapping"} #${le+1}`,gt(x,_),Ne(x),x.metadata={...x.metadata||{},created:x.metadata?.created||R,edited:R,source:x.metadata?.source||"template"},x});const F=JSON.parse(JSON.stringify(v||{}));return k(F),F.name||(F.name=f.title||f.id||"New mapping"),gt(F,_),Ne(F),F.metadata={...F.metadata||{},created:F.metadata?.created||R,edited:R,source:F.metadata?.source||"template"},F}function W(f){if(!f||typeof f!="object")return"Mapping payload is empty";const v=f.request||{},R=f.response||{};if(!v.method)return"request.method is required";if(!!!(v.url||v.urlPath||v.urlPattern||v.urlPathPattern||v.urlPathTemplate))return"request URL or pattern is required";const _=typeof R.status=="number",F=!!R.fault;return!_&&!F?"response.status is required":null}function ut(){const f=document.getElementById("edit-mapping-modal");return f?(typeof t.showModal=="function"?t.showModal("edit-mapping-modal"):(f.classList.remove?.("hidden"),f.style.display="flex"),!0):!1}function it(f,v=d){if(f){if(v==="create-inline"){Fe(f,{openMode:"inline"});return}if(v==="create-studio"){Fe(f,{openMode:"studio"});return}v==="editor"?(ut(),je(f)):ae(f),t.hideModal?.(o.GALLERY),t.hideModal?.(o.PREVIEW)}}function ze(f){const v=f.map(R=>`${R.id}:${R.source||""}:${R.title||""}:${R.method}:${R.outcome}`).join("|");return[d,s.goalId||"none",s.searchQuery,s.activeTags.join(","),s.showPopularOnly,v].join("|")}function ht(f,v){return v?v==="happy-path"?f.outcome.startsWith("2"):v==="errors"?["4","5"].includes(f.outcome.charAt(0)):v==="faults"?f.tags.includes("fault")||f.tags.includes("delay"):v==="scenarios"?f.isScenario:v==="dynamic"?f.tags.includes("templating"):v==="matching"?f.tags.includes("matching")||f.tags.includes("pattern")||f.tags.includes("jsonpath"):v==="webhooks"?f.tags.includes("webhook"):v==="proxy"?f.tags.includes("proxy"):v==="custom"?f.source==="user":!0:!0}function Ke(f){return Je().filter(v=>ht(v,f))}function wt(f,v){f.innerHTML=`
            <div class="template-wizard__grid template-wizard__goals"></div>
            <div class="template-wizard__actions">
                <button type="button" class="btn btn-ghost" data-action="show-all">Show all templates</button>
                <div class="template-wizard__actions-right">
                    <button type="button" class="btn btn-primary" data-action="create-empty">Create empty</button>
                </div>
            </div>
        `;const R=f.querySelector(".template-wizard__grid");r.forEach(k=>{const _=v.filter(j=>ht(j,k.id)).length,F=document.createElement("button");F.type="button",F.className="template-goal",F.dataset.goalId=k.id,F.innerHTML=`
                <span class="template-goal__icon" aria-hidden="true">${k.icon}</span>
                <span class="template-goal__title">${k.title}</span>
                <span class="template-goal__subtitle">${k.subtitle}</span>
                <span class="template-goal__count">${_} templates</span>
            `,F.style.setProperty("--goal-color",k.color),F.disabled=_===0,F.addEventListener("click",()=>{s.goalId=k.id,s.step="templates",s.activeTags=[],s.searchQuery="",s.showPopularOnly=!1,Te({force:!0})}),R.appendChild(F)}),f.querySelectorAll('[data-action="show-all"]').forEach(k=>{k.addEventListener("click",()=>{s.goalId=null,s.step="templates",Te({force:!0})})}),f.querySelectorAll('[data-action="create-empty"]').forEach(k=>{k.addEventListener("click",()=>{Ye()})})}function ye(f,v){const R=f.outcome==="proxy"?"proxy":f.outcome==="fault"?"fault":f.outcome,k=ke(d),_=document.createElement("div");return _.className="template-card template-card--wizard",_.dataset.templateId=f.id,_.setAttribute("role","button"),_.tabIndex=0,_.innerHTML=`
            <div class="template-card__header">
                <span class="badge badge-soft" data-method="${f.method}">${f.method}</span>
                <span class="badge badge-soft" data-outcome="${f.outcome}">${R}</span>
                ${f.isScenario?`<span class="badge badge-soft badge-scenario">${f.content?.mappings?.length||0} steps</span>`:""}
                ${f.popular?'<span class="template-card__star" aria-hidden="true">\u2B50</span>':""}
            </div>
            <div class="template-card__title">${f.title||f.name||f.id}</div>
            <div class="template-card__desc">${f.description||"WireMock template"}</div>
            <div class="template-card__meta">${ct(f)}</div>
            <div class="template-card__tags">
                ${f.tags.slice(0,4).map(F=>`<span class="chip">${F}</span>`).join("")}
            </div>
            <div class="template-card__actions">
                <button class="btn btn-primary btn-sm" type="button" data-card-action="select">${k?"Create":"Select"}</button>
                <button class="btn btn-secondary btn-sm" type="button" data-card-action="details">Details</button>
                ${f.source==="user"?'<button class="btn btn-ghost btn-sm" type="button" data-card-action="edit-template">Edit</button>':""}
                ${f.source==="user"?'<button class="btn btn-ghost btn-sm" type="button" data-card-action="delete-template">Delete</button>':""}
            </div>
        `,_.addEventListener("click",F=>{const j=F.target instanceof HTMLElement?F.target.closest("[data-card-action]"):null;if(j){F.stopPropagation();const ee=j.dataset.cardAction;if(ee==="edit-template"){qe(f.id);return}if(ee==="delete-template"){Se(f.id);return}}v(f)}),_.addEventListener("keydown",F=>{(F.key==="Enter"||F.key===" ")&&(F.preventDefault(),v(f))}),_}function pt(f,v){const R=Ke(s.goalId),k=Array.from(new Set(R.flatMap(x=>x.tags))).sort(),_=!s.goalId;let F=R.filter(x=>{if(s.showPopularOnly&&!x.popular||s.activeTags.length&&!s.activeTags.every(Ce=>x.tags.includes(Ce)))return!1;if(!s.searchQuery)return!0;const ne=s.searchQuery.toLowerCase();return(x.title||x.id).toLowerCase().includes(ne)||(x.description||"").toLowerCase().includes(ne)||x.tags.some(Ce=>Ce.toLowerCase().includes(ne))});f.innerHTML=`
            <div class="template-toolbar template-toolbar--wizard">
                <div class="template-toolbar__search">
                    <svg class="icon icon-16" aria-hidden="true" focusable="false"><use href="#icon-search"></use></svg>
                    <input type="search" placeholder="Search templates..." value="${s.searchQuery}" aria-label="Search templates" />
                </div>
                <div class="template-toolbar__actions">
                    <button type="button" class="btn btn-ghost btn-sm" data-action="show-all" ${_?"disabled":""}>Show all</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-action="toggle-popular" aria-pressed="${s.showPopularOnly}">\u2B50 Popular</button>
                    <button type="button" class="btn btn-primary btn-sm" data-action="create-empty">Create empty</button>
                </div>
            </div>
            <div class="template-tags" aria-label="Tags">
                ${k.map(x=>`<button type="button" class="chip chip--toggle ${s.activeTags.includes(x)?"is-active":""}" data-tag="${x}">${x}</button>`).join("")}
            </div>
            <div class="template-wizard__grid template-wizard__cards" id="template-wizard-cards"></div>
            <div class="template-info template-info--inline">
                <p class="template-info__lead">Need more examples? Visit the <a href="https://library.wiremock.org/" target="_blank" rel="noopener">official WireMock Template Library</a> and import JSON via Import/Export \u2192 Import Data.</p>
            </div>
        `;const j=f.querySelector("#template-wizard-cards"),ee=document.createElement("div");ee.className="history-empty",ee.innerHTML="<p>No templates found</p><small>Adjust filters or import JSON from the WireMock Template Library.</small>",F.length?F.forEach(x=>{j.appendChild(ye(x,ne=>{s.selectedTemplateId=ne.id,s.step="preview",Te({force:!0})}))}):j.replaceWith(ee);const le=f.querySelector('input[type="search"]');le&&le.addEventListener("input",x=>{s.searchQuery=x.target.value,Te({force:!0})}),f.querySelectorAll('[data-action="toggle-popular"]').forEach(x=>{x.addEventListener("click",()=>{s.showPopularOnly=!s.showPopularOnly,Te({force:!0})})}),f.querySelectorAll('[data-action="show-all"]').forEach(x=>{x.addEventListener("click",()=>{s.goalId=null,s.step="templates",Te({force:!0})})}),f.querySelectorAll('[data-action="create-empty"]').forEach(x=>{x.addEventListener("click",()=>{Ye()})}),f.querySelectorAll("[data-tag]").forEach(x=>{x.addEventListener("click",()=>{const ne=x.dataset.tag;s.activeTags.includes(ne)?s.activeTags=s.activeTags.filter(Ce=>Ce!==ne):s.activeTags=[...s.activeTags,ne],Te({force:!0})})})}function yt(f,v){const R=v.find(ne=>ne.id===s.selectedTemplateId);if(!R){s.step="templates",Te({force:!0});return}const k=ke(d),_=ct(R),F=st(R),j=lt(R),ee=R.tags||[];f.innerHTML=`
            <div class="template-preview-card">
                <div class="template-preview-card__meta">
                    <div class="template-preview-card__badges">
                        <span class="badge badge-soft" data-method="${R.method}">${R.method}</span>
                        <span class="badge badge-soft" data-outcome="${R.outcome}">${R.outcome==="proxy"?"proxy":R.outcome}</span>
                        ${R.isScenario?`<span class="badge badge-soft badge-scenario">${R.content?.mappings?.length||0} steps</span>`:""}
                    </div>
                    <h4 class="template-preview-card__title">${R.title||R.name||R.id}</h4>
                    <p class="template-preview-card__desc">${R.description||""}</p>
                    <div class="template-preview-card__summary">${_||"\u2014"}</div>
                    ${F?`<div class="template-preview-meta__row"><span class="template-preview-meta__label">${F.label}</span><code class="template-preview-meta__code">${F.value}</code></div>`:""}
                    <div class="template-preview-card__tags">${ee.map(ne=>`<span class="chip">${ne}</span>`).join("")}</div>
                </div>
                <pre class="template-preview-card__code" id="template-preview-code-inline"></pre>
            </div>
            <div class="template-preview-actions template-preview-actions--wizard" id="template-preview-actions">
                <div class="template-preview-actions__primary">
                    ${k?'<button class="btn btn-primary btn-sm" type="button" data-template-action="apply">Create and open editor</button>':'<button class="btn btn-primary btn-sm" type="button" data-template-action="apply">Use template</button>'}
                    ${k?'<button class="btn btn-secondary btn-sm" type="button" data-template-action="create-studio">Create in JSON Studio</button>':""}
                    <button class="btn btn-secondary btn-sm" type="button" data-template-action="copy">Copy JSON</button>
                </div>
                ${R.source==="user"?`<div class="template-preview-actions__secondary">
                        <button class="btn btn-ghost btn-sm" type="button" data-template-action="edit-template">Edit template</button>
                        <button class="btn btn-ghost btn-sm" type="button" data-template-action="delete-template">Delete</button>
                    </div>`:""}
            </div>
        `;const le=f.querySelector("#template-preview-code-inline");le&&(le.textContent=j);const x=f.querySelector("#template-preview-actions");x&&x.addEventListener("click",async ne=>{const Ce=ne.target instanceof HTMLElement?ne.target.closest("[data-template-action]"):null;if(!Ce)return;const $e=Ce.dataset.templateAction;if($e==="apply"){it(R,d);return}if($e==="create-studio"){Fe(R,{openMode:"studio"});return}if($e==="copy"){const xe=typeof R.content=="string"?R.content:JSON.stringify(R.content,null,2),Re=await dt(xe);w(Re?`Template "${R.title}" copied`:"Clipboard copy failed",Re?"success":"error")}if($e==="edit-template"){await qe(R.id);return}$e==="delete-template"&&Se(R.id)})}function Mt(){if(s.step==="preview"){s.step="templates";return}s.step="goals",s.goalId=null,s.selectedTemplateId=null}function Te(f={}){const{force:v=!1}=f,R=document.getElementById("template-gallery-shell");if(R)try{const k=Je(),_=ze(k);if(!v&&_===E)return;E=_;const F=s.step==="goals"?1:s.step==="templates"?2:3,j=r.find(ne=>ne.id===s.goalId),ee=s.step!=="goals";R.innerHTML=`
                <div class="template-wizard">
                    <div class="template-wizard__header">
                        <div>
                            <p class="template-wizard__eyebrow">Step ${F}/3</p>
                            <h3 class="template-wizard__title">${s.step==="goals"?"Create a mapping":j?.title||"Pick a template"}</h3>
                            <p class="template-wizard__subtitle">${s.step==="goals"?"Choose the scenario that fits your testing goal":j?.description||""}</p>
                        </div>
                        <div class="template-wizard__header-actions">
                            <div class="template-wizard__progress" role="progressbar" aria-label="Wizard progress" aria-valuemin="1" aria-valuemax="3" aria-valuenow="${F}">
                                <span class="sr-only">Step ${F} of 3</span>
                                ${[1,2,3].map(ne=>`<span class="template-wizard__dot ${ne<=F?"is-active":""}" aria-current="${ne===F?"step":"false"}" aria-label="Step ${ne}"></span>`).join("")}
                            </div>
                            ${ee?'<button type="button" class="btn btn-ghost btn-sm" id="template-wizard-back">\u2190 Back</button>':""}
                        </div>
                    </div>
                    <div class="template-wizard__body" id="template-wizard-body"></div>
                </div>
            `;const le=R.querySelector("#template-wizard-body");if(!le)return;k.length?s.step==="goals"?wt(le,k):s.step==="templates"?pt(le,k):yt(le,k):le.innerHTML='<div class="history-empty"><p>No templates available</p><small>Add or import templates to populate this view.</small></div>';const x=R.querySelector("#template-wizard-back");x&&x.addEventListener("click",()=>{Mt(),Te({force:!0})})}catch(k){Logger.error("TEMPLATES","Failed to render template wizard",k),R.innerHTML='<div class="history-empty"><p>Templates unavailable</p><small>Reload the page or try again later.</small></div>'}}function Tt(f="form"){d=f,s.step="goals",s.goalId=null,s.selectedTemplateId=null,s.searchQuery="",s.activeTags=[],s.showPopularOnly=!1;try{Te({force:!0})}catch(k){Logger.error("TEMPLATES","Unable to prepare template gallery",k);const _=document.getElementById("template-gallery-shell");_&&(_.innerHTML='<div class="history-empty"><p>Templates unavailable</p><small>Reload the page or try again later.</small></div>')}if(typeof t.showModal=="function"){t.showModal(o.GALLERY);return}const R=document.getElementById(o.GALLERY);R&&(R.classList.remove("hidden"),R.style.display="flex")}function Xe(){document.querySelectorAll("[data-template-trigger]").forEach(f=>{f.addEventListener("click",v=>{v.preventDefault(),Tt(f.dataset.templateTarget||"form")})})}function It(){try{Be(),Te()}catch(f){Logger.error("TEMPLATES","Template manager failed to initialize",f);const v=document.getElementById("template-gallery-shell");v&&(v.innerHTML='<div class="history-empty"><p>Templates unavailable</p><small>Reload the page or try again later.</small></div>')}Xe(),document.getElementById("save-template-btn")?.addEventListener("click",f=>{f.preventDefault(),Ve()}),document.getElementById("editor-save-template")?.addEventListener("click",f=>{f.preventDefault(),We()})}t.TemplateManager={getTemplates:tt,refresh:Be,openGallery:Te,openGalleryForTarget:Tt,getTemplatesWithMeta:Je,getEmptyTemplateSeed:I,getEmptyMappingContent:B,applyTemplateToForm:ae,applyTemplateToEditor:je,createMappingFromTemplate:Fe,createMappingsFromPayloads:H,prepareMappingForCreation:U,createEmptyMapping:Ye,saveFormAsTemplate:Ve,saveEditorAsTemplate:We,updateUserTemplate:Ie,editUserTemplate:qe,deleteUserTemplate:Se},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",It):It()})(typeof window<"u"?window:globalThis);const KEYWORDS=["method","url","status","name","scenario","matched","client"],RANGE_KEYWORDS=["priority"];function parseQuery(e){if(!e||typeof e!="string")return null;const t=e.trim();if(!t)return null;try{const n={},a=/(-?)(\w+):([\w\/\*.,\-]+|"[^"]*")/g;let o;const r=[];for(;(o=a.exec(t))!==null;){const c=o[1]==="-",s=o[2];let d=o[3];if(d.startsWith('"')&&d.endsWith('"')&&(d=d.slice(1,-1)),!KEYWORDS.includes(s)&&!RANGE_KEYWORDS.includes(s))continue;if(r.push({start:o.index,end:o.index+o[0].length}),RANGE_KEYWORDS.includes(s)){const E=d.match(/^(\d+)-(\d+)$/);E?n[s]={from:E[1],to:E[2]}:/^\d+$/.test(d)&&(n[s]={from:d,to:d});continue}if(c){const E=d.split(",");n[s]={exclude:E.length>1?E:E[0]};continue}const g=d.split(",");n[s]=g.length>1?g:g[0]}if(r.length>0){let c=[],s=0;r.sort((g,E)=>g.start-E.start);for(const g of r){if(g.start>s){const E=t.slice(s,g.start).trim();E&&c.push(E)}s=g.end}if(s<t.length){const g=t.slice(s).trim();g&&c.push(g)}const d=c.join(" ").trim();d&&(n.text=d)}else n.text=t;return Object.keys(n).length>0?n:null}catch(n){return Logger.error("QUERY","Query parse error:",n),null}}function matchesCondition(e,t){if(!e&&e!==0)return!1;const n=String(e).toLowerCase();if(t&&typeof t=="object"&&t.exclude){const o=Array.isArray(t.exclude)?t.exclude:[t.exclude];for(const r of o)if(n.includes(String(r).toLowerCase()))return!1;return!0}const a=Array.isArray(t)?t:[t];for(const o of a){const r=String(o).toLowerCase();if(n.includes(r))return!0}return!1}function matchesRange(e,t){const n=Number(e);if(isNaN(n))return!1;const a=t.from!==void 0?Number(t.from):-1/0,o=t.to!==void 0?Number(t.to):1/0;return n>=a&&n<=o}function filterMappings(e,t){return Array.isArray(e)?!t||typeof t!="object"?e:e.filter(n=>{if(!n)return!1;if(t.method){const a=n.request?.method||"";if(!matchesCondition(a,t.method))return!1}if(t.url){const a=n.request?.url||n.request?.urlPattern||n.request?.urlPath||"";if(!matchesCondition(a,t.url))return!1}if(t.status){const a=n.response?.status??"";if(!matchesCondition(a,t.status))return!1}if(t.name){const a=n.name||"";if(!matchesCondition(a,t.name))return!1}if(t.scenario){const a=n.scenarioName||"";if(!matchesCondition(a,t.scenario))return!1}if(t.priority){const a=n.priority??1;if(!matchesRange(a,t.priority))return!1}if(t.text){const a=String(t.text).toLowerCase(),o=(n.request?.url||n.request?.urlPattern||n.request?.urlPath||"").toLowerCase(),r=(n.name||"").toLowerCase(),c=(n.request?.method||"").toLowerCase();if(!o.includes(a)&&!r.includes(a)&&!c.includes(a))return!1}return!0}):[]}function filterMappingsByQuery(e,t){const n=parseQuery(t);return filterMappings(e,n)}function filterRequests(e,t){return Array.isArray(e)?!t||typeof t!="object"?e:e.filter(n=>{if(!n)return!1;if(t.method){const a=n.request?.method||"";if(!matchesCondition(a,t.method))return!1}if(t.url){const a=n.request?.url||n.request?.urlPath||"";if(!matchesCondition(a,t.url))return!1}if(t.status){const a=n.response?.status??n.responseDefinition?.status??"";if(!matchesCondition(a,t.status))return!1}if(t.matched!==void 0){const a=n.wasMatched!==!1,o=Array.isArray(t.matched)?t.matched:[t.matched];let r=!1;for(const c of o){const s=String(c).toLowerCase();if((s==="true"||s==="yes"||s==="1")&&a){r=!0;break}if((s==="false"||s==="no"||s==="0")&&!a){r=!0;break}}if(!r)return!1}if(t.client){const a=n.request?.clientIp||"";if(!matchesCondition(a,t.client))return!1}if(t.text){const a=String(t.text).toLowerCase(),o=(n.request?.url||n.request?.urlPath||"").toLowerCase(),r=(n.request?.method||"").toLowerCase(),c=(n.request?.clientIp||"").toLowerCase();if(!o.includes(a)&&!r.includes(a)&&!c.includes(a))return!1}return!0}):[]}function filterRequestsByQuery(e,t){const n=parseQuery(t);return filterRequests(e,n)}window.QueryParser={parseQuery,filterMappings,filterMappingsByQuery,filterRequests,filterRequestsByQuery,matchesCondition,matchesRange},(function(){const t={GET:1,POST:2,PUT:3,PATCH:4,DELETE:5},n=(S,...I)=>{if(!S||typeof S!="object")return"";for(const L of I){const B=L.includes(".")?L.split(".").reduce((M,w)=>M?.[w],S):S[L];if(B!=null)return String(B)}return""},a=S=>{if(S==null)return"";try{const I=typeof S=="string"?S:JSON.stringify(S);return I.length>300?`${I.slice(0,300)}\u2026`:I}catch{return""}},o=S=>n(S,"id","uuid","stubId"),r=S=>n(S,"id","requestId","mappingUuid","request.id","request.loggedDate","loggedDate"),c=S=>{if(!S||typeof S!="object")return"";const I=S.request||{},L=S.response||{},B=S.metadata||{};return[I.method||"",I.url||I.urlPattern||I.urlPath||I.urlPathPattern||"",L.status||"",L.fixedDelayMilliseconds||"",S.name||B.name||"",S.priority??"",S.scenarioName||"",B.edited||B.created||"",B.source||"",a(I.headers),a(I.bodyPatterns||I.body||""),a(I.queryParameters),a(L.headers),a(L.jsonBody!==void 0?L.jsonBody:L.body||""),a(B.additionalMetadata||B.tags||B.description||"")].join("|")},s=S=>{if(!S||typeof S!="object")return"";const I=S.request||{},L=S.responseDefinition||{};return[I.method||"",I.url||I.urlPath||"",I.loggedDate||S.loggedDate||"",S.wasMatched===!1?"unmatched":"matched",L.status??"",(L.body||L.jsonBody||"").length,(I.body||"").length].join("|")},d=S=>[...Array.isArray(S)?S:[]].sort((L,B)=>{const M=L?.priority??1,w=B?.priority??1;if(M!==w)return M-w;const D=t[L?.request?.method]||999,O=t[B?.request?.method]||999;if(D!==O)return D-O;const Q=L?.request?.url||L?.request?.urlPattern||L?.request?.urlPath||"",de=B?.request?.url||B?.request?.urlPattern||B?.request?.urlPath||"";return Q.localeCompare(de)}),g=S=>typeof window.renderMappingCard=="function"?window.renderMappingCard(S):"",E=S=>typeof window.renderRequestCard=="function"?window.renderRequestCard(S):"",b=(S,I,L={})=>{if(!S||typeof window.renderList!="function")return[];const B=L.preSorted===!0?[...I||[]]:d(I),M=L.onItemChanged,w=L.onItemRemoved;if(window.PaginationManager){window.PaginationManager.updateState(B.length);const D=window.PaginationManager.getCurrentPageItems(B);window.renderList(S,D,{renderItem:g,getKey:o,getSignature:c,onItemChanged:M,onItemRemoved:w});const O=document.getElementById(L.paginationContainerId||"mappings-pagination");return O&&(O.innerHTML=window.PaginationManager.renderControls()),B}return window.renderList(S,B,{renderItem:g,getKey:o,getSignature:c,onItemChanged:M,onItemRemoved:w}),B};window.getRenderKey=n,window.getMappingRenderKey=o,window.getRequestRenderKey=r,window.getMappingRenderSignature=c,window.getRequestRenderSignature=s,window.renderMappingMarkup=g,window.renderRequestMarkup=E,window.sortMappingsForDisplay=d,window.renderMappingsCollection=b})();function executeMappingFilters(){const t=document.getElementById("filter-query")?.value?.trim()||"";window.FilterManager.saveFilterState("mappings",{query:t}),updateURLFilterParams(t,"mappings");const n=window.originalMappings;if(!Array.isArray(n)||n.length===0){const d=document.getElementById(SELECTORS.EMPTY.MAPPINGS),g=document.getElementById(SELECTORS.LISTS.MAPPINGS);d&&(d.classList.remove("hidden"),d.removeAttribute("aria-hidden")),g&&(g.style.display="none"),typeof updateMappingsCounter=="function"&&updateMappingsCounter();return}let a;t?window.QueryParser&&typeof window.QueryParser.filterMappingsByQuery=="function"?a=window.QueryParser.filterMappingsByQuery(n,t):(Logger.warn("MANAGERS","[Mapping Filter] QueryParser or filterMappingsByQuery is not available. Showing all mappings."),a=n):a=n,window._filteredMappings=a;const o=document.getElementById(SELECTORS.LISTS.MAPPINGS),r=document.getElementById(SELECTORS.EMPTY.MAPPINGS),c=document.getElementById(SELECTORS.LOADING.MAPPINGS);if(!o)return;if(window.MappingsStore?.metadata?.isRendering){window.MappingsStore.metadata.pendingFilterRender=!0;return}const s=typeof window.sortMappingsForDisplay=="function"?window.sortMappingsForDisplay(a):[...a];if(typeof window.renderMappingsCollection=="function")window.renderMappingsCollection(o,s,{preSorted:!0});else if(window.PaginationManager){window.PaginationManager.updateState(s.length);const d=window.PaginationManager.getCurrentPageItems(s);renderList(o,d,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature});const g=document.getElementById("mappings-pagination");g&&(g.innerHTML=window.PaginationManager.renderControls())}else renderList(o,s,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature});c&&c.classList.add("hidden"),s.length===0?(r&&(r.classList.remove("hidden"),r.removeAttribute("aria-hidden")),o.style.display="none"):(r&&(r.classList.add("hidden"),r.setAttribute("aria-hidden","true")),o.style.display="block"),typeof updateMappingsCounter=="function"&&updateMappingsCounter()}function executeRequestFilters(){const t=document.getElementById("req-filter-query")?.value?.trim()||"",n=document.getElementById("req-filter-from"),a=document.getElementById("req-filter-to"),o=n?.value||"",r=a?.value||"";if(window.FilterManager.saveFilterState("requests",{query:t,from:o,to:r}),updateURLFilterParams(t,"requests"),!Array.isArray(window.originalRequests)||window.originalRequests.length===0){window.allRequests=[];const S=document.getElementById(SELECTORS.EMPTY.REQUESTS),I=document.getElementById(SELECTORS.LISTS.REQUESTS);S&&S.classList.remove("hidden"),I&&(I.style.display="none"),typeof updateRequestsCounter=="function"&&updateRequestsCounter();return}let c=t&&window.QueryParser?window.QueryParser.filterRequestsByQuery(window.originalRequests,t):window.originalRequests;const s=o?new Date(o).getTime():null,d=r?new Date(r).getTime():null;(s!==null||d!==null)&&(c=c.filter(S=>{if(!S)return!1;const I=new Date(S.request?.loggedDate||S.loggedDate).getTime();return!(s!==null&&Number.isFinite(s)&&(!Number.isFinite(I)||I<s)||d!==null&&Number.isFinite(d)&&(!Number.isFinite(I)||I>d))})),window.allRequests=c;const g=document.getElementById(SELECTORS.LISTS.REQUESTS),E=document.getElementById(SELECTORS.EMPTY.REQUESTS),b=document.getElementById(SELECTORS.LOADING.REQUESTS);g&&(renderList(g,window.allRequests,{renderItem:window.renderRequestMarkup,getKey:window.getRequestRenderKey,getSignature:window.getRequestRenderSignature}),b&&b.classList.add("hidden"),window.allRequests.length===0?(E&&E.classList.remove("hidden"),g.style.display="none"):(E&&E.classList.add("hidden"),g.style.display="block"),typeof updateRequestsCounter=="function"&&updateRequestsCounter(),Logger.debug("MANAGERS",`Filtered requests: ${window.allRequests.length} items`))}window.FilterManager._applyMappingFilters=window.debounce(executeMappingFilters,180),window.FilterManager._applyRequestFilters=window.debounce(executeRequestFilters,180),window.applyFilters=()=>{FilterManager.applyMappingFilters(),typeof window._updateActiveFiltersDisplayDebounced=="function"?window._updateActiveFiltersDisplayDebounced():typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay()},window.clearMappingFilters=()=>{const e=document.getElementById("filter-query");e&&(e.value=""),FilterManager.applyMappingFilters(),typeof FilterManager.flushMappingFilters=="function"&&FilterManager.flushMappingFilters(),typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay(),typeof window.updateURLFilterParams=="function"&&window.updateURLFilterParams("","mappings")},window.toggleQueryHelp=(e="mappings")=>{const t=e==="requests"?"req-query-help":"query-help",n=document.getElementById(t);if(!n)return;const a=n.classList.contains("hidden"),o=document.querySelector(`[aria-controls="${t}"]`);a?(n.classList.remove("hidden"),o&&(o.textContent="\xD7",o.setAttribute("aria-expanded","true"))):(n.classList.add("hidden"),o&&(o.textContent="?",o.setAttribute("aria-expanded","false")))},window.applyQuickMethodFilter=e=>{const t=document.getElementById("filter-query");if(!t)return;const n=t.value.trim(),a=/method:[^\s]+/;a.test(n)?t.value=n.replace(a,`method:${e}`):t.value=n?`method:${e} ${n}`:`method:${e}`,applyFilters(),updateActiveFiltersDisplay()},window.updateActiveFiltersDisplay=()=>{const e=document.getElementById("filter-query"),t=document.getElementById("active-filters"),n=document.getElementById("active-filters-list");if(!e||!t||!n)return;const a=e.value.trim();if(!a){t.classList.add("filter-hidden");return}const o=window.QueryParser?window.QueryParser.parseQuery(a):null;if(!o||Object.keys(o).length===0){t.classList.add("filter-hidden");return}const r=[];for(const[c,s]of Object.entries(o)){if(c==="text")continue;let d="";if(typeof s=="object"&&s.exclude){const g=Array.isArray(s.exclude)?s.exclude.join(","):s.exclude;d=`-${c}:${g}`}else typeof s=="object"&&s.from&&s.to?d=`${c}:${s.from}-${s.to}`:Array.isArray(s)?d=`${c}:${s.join(",")}`:d=`${c}:${s}`;r.push(`
            <button type="button"
                    class="filter-chip filter-chip-active"
                    data-action="remove-active-filter"
                    data-filter-key="${Utils.escapeHtml(c)}"
                    title="Click to remove">
                ${Utils.escapeHtml(d)}
                <span class="filter-chip-remove" aria-hidden="true">\xD7</span>
            </button>
        `)}n.innerHTML=r.join(""),r.length>0?t.classList.remove("filter-hidden"):t.classList.add("filter-hidden")},window._updateActiveFiltersDisplayDebounced=window.debounce?window.debounce(window.updateActiveFiltersDisplay,200):window.updateActiveFiltersDisplay,window.removeActiveFilter=e=>{const t=document.getElementById("filter-query");if(!t)return;const n=t.value.trim(),a=[new RegExp(`-?${e}:[^\\s]+`,"g"),new RegExp(`\\s+${e}:[^\\s]+`,"g"),new RegExp(`${e}:[^\\s]+\\s+`,"g")];let o=n;for(const r of a)o=o.replace(r," ");o=o.replace(/\s+/g," ").trim(),t.value=o,applyFilters(),updateActiveFiltersDisplay()},window.applyRequestFilters=()=>FilterManager.applyRequestFilters();function applyDateRange(e,t,n,a){e&&(e.value=Utils.formatDateTime(n)),t&&(t.value=Utils.formatDateTime(a)),FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters()}window.applyQuickFilter=()=>{const e=document.getElementById(SELECTORS.REQUEST_FILTERS.QUICK);if(!e)return;const t=e.value,n=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM),a=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO);if(!t){n&&(n.value=""),a&&(a.value=""),FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters();return}const o=new Date,r=new Date(o),c=t.match(/^(\d+)([mhd])$/);if(!c)return;const s=parseInt(c[1]);switch(c[2]){case"m":r.setMinutes(r.getMinutes()-s);break;case"h":r.setHours(r.getHours()-s);break;case"d":r.setDate(r.getDate()-s);break;default:return}applyDateRange(n,a,r,o)},window.clearQuickTimeFilter=()=>{const e=document.getElementById("req-filter-quick");e&&(e.value="")},window.applyQuickTimeFilter=()=>{const e=document.getElementById("req-filter-quick"),t=document.getElementById("req-filter-from"),n=document.getElementById("req-filter-to");if(!e||!t||!n)return;const a=e.value;if(!a){t.value="",n.value="",FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters();return}const o=new Date;let r=new Date(o);const c=a.match(/^(\d+)([mhd])$/);if(c){const s=parseInt(c[1],10);switch(c[2]){case"m":r.setMinutes(r.getMinutes()-s);break;case"h":r.setHours(r.getHours()-s);break;case"d":r.setDate(r.getDate()-s);break}}applyDateRange(t,n,r,o)},window.clearRequestFilters=()=>{const e=document.getElementById("req-filter-query");e&&(e.value="");const t=document.getElementById("req-filter-from"),n=document.getElementById("req-filter-to"),a=document.getElementById("req-filter-quick");t&&(t.value=""),n&&(n.value=""),a&&(a.value=""),FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters(),typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay(),typeof window.updateURLFilterParams=="function"&&window.updateURLFilterParams("","requests")},window.applyQuickRequestFilter=e=>{const t=document.getElementById("req-filter-query");if(!t)return;const n=t.value.trim();if(/^[A-Z]+$/.test(e)){const a=/method:[\w,]+/i;a.test(n)?t.value=n.replace(a,`method:${e}`):t.value=n?`method:${e} ${n}`:`method:${e}`}else{const a=e.match(/^(\w+):/);if(a){const o=a[1],r=new RegExp(`${o}:[^\\s]+`,"i");r.test(n)?t.value=n.replace(r,e):t.value=n?`${e} ${n}`:e}else t.value=n?`${e} ${n}`:e}FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters(),typeof window._updateRequestActiveFiltersDisplayDebounced=="function"?window._updateRequestActiveFiltersDisplayDebounced():typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay()},window.updateRequestActiveFiltersDisplay=()=>{const e=document.getElementById("req-active-filters"),t=document.getElementById("req-filter-query");if(!e||!t)return;const n=t.value.trim();if(!n||!window.QueryParser){e.innerHTML="",e.classList.add("filter-hidden");return}const a=window.QueryParser.parseQuery(n);if(!a){e.innerHTML="",e.classList.add("filter-hidden");return}const o=[];for(const[r,c]of Object.entries(a)){if(r==="text")continue;let s="";if(r==="matched"){const d=Array.isArray(c)?c:[c],g=String(d[0]).toLowerCase();g==="true"||g==="yes"||g==="1"?s="Matched":s="Unmatched"}else if(Array.isArray(c))s=`${r}: ${c.join(", ")}`;else if(typeof c=="object"&&c.exclude){const d=Array.isArray(c.exclude)?c.exclude:[c.exclude];s=`NOT ${r}: ${d.join(", ")}`}else s=`${r}: ${c}`;o.push(`<button type="button" class="filter-chip filter-chip-active" data-action="remove-request-active-filter" data-filter-key="${Utils.escapeHtml(r)}" title="Remove filter">${Utils.escapeHtml(s)} \xD7</button>`)}e.innerHTML=o.join(""),o.length>0?e.classList.remove("filter-hidden"):e.classList.add("filter-hidden")},window._updateRequestActiveFiltersDisplayDebounced=window.debounce?window.debounce(window.updateRequestActiveFiltersDisplay,200):window.updateRequestActiveFiltersDisplay,window.removeRequestActiveFilter=e=>{const t=document.getElementById("req-filter-query");if(!t)return;const n=t.value.trim();if(!n)return;const a=new RegExp(`-?${e}:[\\w\\/\\*.,\\-]+(\\s+|$)`,"gi"),o=n.replace(a,"").replace(/\s+/g," ").trim();t.value=o,FilterManager.applyRequestFilters(),typeof FilterManager.flushRequestFilters=="function"&&FilterManager.flushRequestFilters(),typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay()};function getSavedFilters(e){const t=`saved-filters-${e}`;try{const n=localStorage.getItem(t);return n?JSON.parse(n):[]}catch(n){return Logger.warn("FILTERS",`Failed to load saved filters for ${e}:`,n),[]}}function setSavedFilters(e,t){const n=`saved-filters-${e}`;try{localStorage.setItem(n,JSON.stringify(t))}catch(a){Logger.error("FILTERS",`Failed to save filters for ${e}:`,a)}}window.saveCurrentMappingFilter=()=>{const e=document.getElementById("filter-query");if(!e)return;const t=e.value.trim();if(!t){typeof NotificationManager<"u"&&NotificationManager.warning("No filter to save");return}const n=prompt("Enter a name for this filter:",t.substring(0,30));if(!n)return;const a=getSavedFilters("mappings"),o=a.findIndex(r=>r.name===n);if(o>=0){if(!confirm(`Filter "${n}" already exists. Overwrite?`))return;a[o]={name:n,query:t}}else a.push({name:n,query:t});setSavedFilters("mappings",a),updateSavedFiltersDisplay("mappings"),typeof NotificationManager<"u"&&NotificationManager.success(`Filter "${n}" saved`)},window.saveCurrentRequestFilter=()=>{const e=document.getElementById("req-filter-query");if(!e)return;const t=e.value.trim();if(!t){typeof NotificationManager<"u"&&NotificationManager.warning("No filter to save");return}const n=prompt("Enter a name for this filter:",t.substring(0,30));if(!n)return;const a=getSavedFilters("requests"),o=a.findIndex(r=>r.name===n);if(o>=0){if(!confirm(`Filter "${n}" already exists. Overwrite?`))return;a[o]={name:n,query:t}}else a.push({name:n,query:t});setSavedFilters("requests",a),updateSavedFiltersDisplay("requests"),typeof NotificationManager<"u"&&NotificationManager.success(`Filter "${n}" saved`)},window.applySavedFilter=(e,t)=>{const a=getSavedFilters(e).find(o=>o.name===t);if(!a){Logger.warn("FILTERS",`Saved filter "${t}" not found`);return}if(e==="mappings"){const o=document.getElementById("filter-query");o&&(o.value=a.query,applyFilters(),updateActiveFiltersDisplay())}else if(e==="requests"){const o=document.getElementById("req-filter-query");o&&(o.value=a.query,FilterManager.applyRequestFilters(),updateRequestActiveFiltersDisplay())}},window.deleteSavedFilter=(e,t)=>{const a=getSavedFilters(e).filter(o=>o.name!==t);setSavedFilters(e,a),updateSavedFiltersDisplay(e),typeof NotificationManager<"u"&&NotificationManager.info(`Filter "${t}" deleted`)};function updateSavedFiltersDisplay(e){const t=getSavedFilters(e);let n,a;if(e==="mappings")n="saved-filters-list",a="saved-filters-separator";else if(e==="requests")n="req-saved-filters-list",a="req-saved-filters-separator";else return;const o=document.getElementById(n),r=document.getElementById(a);if(!o)return;if(t.length===0){o.classList.add("filter-hidden"),r&&r.classList.add("filter-hidden");return}const c=t.map(s=>`
        <button type="button"
                class="filter-chip filter-chip-saved"
                data-action="apply-saved-filter"
                data-filter-tab="${Utils.escapeHtml(e)}"
                data-filter-name="${Utils.escapeHtml(s.name)}"
                title="${Utils.escapeHtml(s.query)}">
            <span class="filter-chip-text">${Utils.escapeHtml(s.name)}</span>
            <span class="filter-chip-remove"
                  data-action="delete-saved-filter"
                  data-filter-tab="${Utils.escapeHtml(e)}"
                  data-filter-name="${Utils.escapeHtml(s.name)}"
                  title="Delete filter"
                  aria-label="Delete filter">\xD7</span>
        </button>
    `);o.innerHTML=c.join(""),o.classList.remove("filter-hidden"),r&&r.classList.remove("filter-hidden")}if(window.loadAllSavedFilters=()=>{updateSavedFiltersDisplay("mappings"),updateSavedFiltersDisplay("requests")},!window._filterChipDelegationInitialized){let e=function(n){const a=n.target.closest('[data-action="delete-saved-filter"]');if(a){n.stopPropagation();const s=a.dataset.filterTab,d=a.dataset.filterName;s&&d&&window.deleteSavedFilter(s,d);return}const o=n.target.closest('[data-action="apply-saved-filter"]');if(o){const s=o.dataset.filterTab,d=o.dataset.filterName;s&&d&&window.applySavedFilter(s,d);return}const r=n.target.closest('[data-action="remove-active-filter"]');if(r){const s=r.dataset.filterKey;s&&window.removeActiveFilter(s);return}const c=n.target.closest('[data-action="remove-request-active-filter"]');if(c){const s=c.dataset.filterKey;s&&window.removeRequestActiveFilter(s);return}};window._filterChipDelegationInitialized=!0,["active-filters-list","req-active-filters","saved-filters-list","req-saved-filters-list"].forEach(n=>{const a=document.getElementById(n);a&&a.addEventListener("click",e)})}window.renderFilterPresets=()=>{const e=document.getElementById("filter-presets-list");if(!e)return;const t=window.FilterPresetsManager.getAllPresets();e.innerHTML="";const n=Object.entries(t);if(n.length===0){e.innerHTML='<span class="filter-presets-hint">No saved presets. Set filters and click \u{1F4BE} to save.</span>';return}n.forEach(([a,o])=>{const r=document.createElement("button");r.type="button",r.className="filter-preset-btn",r.onclick=()=>window.FilterPresetsManager.applyPreset(a,"mappings"),r.title=`Apply ${o.name}`,r.innerHTML=`
            <span class="preset-icon">${o.icon||"\u2B50"}</span>
            <span class="preset-name">${o.name}</span>
            <span class="preset-delete" onclick="event.stopPropagation(); deletePreset('${a}');" title="Delete preset">\xD7</span>
        `,e.appendChild(r)})},window.showSavePresetDialog=()=>{const e=prompt("Enter preset name:");if(!e||!e.trim())return;const t=prompt("Enter emoji icon (optional):")||"\u2B50",n=window.FilterPresetsManager.getCurrentFiltersAsPreset("mappings");if(!n.method&&!n.query&&!n.status){typeof NotificationManager<"u"&&NotificationManager.warning("No active filters to save");return}const a=`custom-${Date.now()}`;window.FilterPresetsManager.saveCustomPreset(a,{name:e.trim(),icon:t.trim(),filters:n})},window.deletePreset=e=>{confirm("Delete this preset?")&&window.FilterPresetsManager.deleteCustomPreset(e)},window.renderFilterPills=()=>{const e=document.getElementById("filter-pills-container"),t=document.getElementById("filter-pills");if(!e||!t)return;const n=document.getElementById("filter-method")?.value||"",a=document.getElementById("filter-url")?.value||"",o=document.getElementById("filter-status")?.value||"",r=!!(n||a||o);if(t.style.display=r?"flex":"none",!r){e.innerHTML="";return}const c=[];n&&c.push({label:"Method",value:n,onRemove:()=>{document.getElementById("filter-method").value="",window.applyFilters()}}),a&&c.push({label:"Search",value:a,onRemove:()=>{document.getElementById("filter-url").value="",window.applyFilters()}}),o&&c.push({label:"Status",value:o,onRemove:()=>{document.getElementById("filter-status").value="",window.applyFilters()}}),e.innerHTML=c.map((s,d)=>`
        <div class="filter-pill">
            <span class="filter-pill-label">${s.label}:</span>
            <span class="filter-pill-value">${s.value}</span>
            <button type="button" class="filter-pill-remove" onclick="window.removeFilterPill(${d})" title="Remove filter">
                \xD7
            </button>
        </div>
    `).join(""),window._filterPillCallbacks=c.map(s=>s.onRemove)},window.removeFilterPill=e=>{window._filterPillCallbacks&&window._filterPillCallbacks[e]&&window._filterPillCallbacks[e]()};const originalApplyFilters=window.applyFilters;window.applyFilters=()=>{typeof originalApplyFilters=="function"&&originalApplyFilters(),typeof window.renderFilterPills=="function"&&window.renderFilterPills()},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{typeof window.renderFilterPresets=="function"&&window.renderFilterPresets(),typeof window.renderFilterPills=="function"&&window.renderFilterPills()}):(typeof window.renderFilterPresets=="function"&&window.renderFilterPresets(),typeof window.renderFilterPills=="function"&&window.renderFilterPills()),Logger.info("FILTERS","Filter Presets and Pills UI loaded"),window.MappingsStore={items:new Map,metadata:{serverVersion:null,lastFullSync:null,lastIncrementalSync:null,isSyncing:!1,syncError:null},pending:new Map,indexes:{byMethod:new Map,byUrl:new Map,byPriority:new Map,byScenario:new Map},stats:{totalMappings:0,pendingOperations:0,lastSyncDuration:0},requests:new Map,getAllRequests(){return Array.from(this.requests.values())},setRequests(e){this.requests.clear(),Array.isArray(e)&&e.forEach(t=>{const n=t.id||t.uuid||t.request&&t.request.url||Date.now().toString();n&&this.requests.set(n,t)})},init(){Logger.info("STORE","Initializing MappingsStore"),this.clear(),Logger.info("STORE","MappingsStore initialized")},get(e){if(!e)return null;const t=this.pending.get(e);return t&&t.type!=="delete"?t.optimisticMapping:this.items.get(e)||null},getAll(){const e=[];return this.items.forEach((t,n)=>{const a=this.pending.get(n);a&&a.type==="delete"||(a&&a.type==="update"?e.push(a.optimisticMapping):e.push(t))}),this.pending.forEach((t,n)=>{t.type==="create"&&!this.items.has(n)&&e.push(t.optimisticMapping)}),e},setFromServer(e,t={}){Logger.info("STORE",`Setting ${e.length} mappings from server`),this.items.clear(),e.forEach(n=>{const a=n.id||n.uuid;a&&this.items.set(a,n)}),this.metadata.serverVersion=t.version||t.etag||null,this.metadata.lastFullSync=Date.now(),this.rebuildIndexes(),this._updateStats(),Logger.info("STORE",`Loaded ${this.items.size} mappings`)},applyChanges({added:e=[],updated:t=[],deleted:n=[]}){Logger.info("STORE",`Applying changes: +${e.length} ~${t.length} -${n.length}`);const a=[];return t.forEach(o=>{const r=o.id||o.uuid,c=this.pending.get(r);if(c&&c.type==="update"){a.push({id:r,type:"update",local:c.optimisticMapping,server:o,localTimestamp:c.timestamp});return}this.items.set(r,o),this._addToIndexes(r,o)}),n.forEach(o=>{this.pending.has(o)&&a.push({id:o,type:"delete",local:this.pending.get(o).optimisticMapping,server:null}),this.items.delete(o),this._removeFromIndexes(o)}),e.forEach(o=>{const r=o.id||o.uuid;this.items.set(r,o),this._addToIndexes(r,o)}),this.metadata.lastIncrementalSync=Date.now(),this._updateStats(),a},addPending(e){const{id:t,type:n,payload:a,optimisticMapping:o}=e;this.pending.set(t,{id:t,type:n,payload:a,optimisticMapping:o,timestamp:Date.now(),retries:0}),Logger.debug("STORE",`Added pending ${n}: ${t}`),this._updateStats()},confirmPending(e,t=null){const n=this.pending.get(e);if(n){if(Logger.info("STORE",`Confirmed pending ${n.type}: ${e}`),n.type==="create"&&t){const a=t.id||t.uuid;this.items.set(a,t),this._addToIndexes(a,t)}else n.type==="update"&&t?(this.items.set(e,t),this._addToIndexes(e,t)):n.type==="delete"&&(this.items.delete(e),this._removeFromIndexes(e));this.pending.delete(e),this._updateStats()}},rollbackPending(e,t=null){const n=this.pending.get(e);n&&(Logger.warn("STORE",`Rolling back pending ${n.type}: ${e}`),n.type==="create"?this.items.delete(e):n.type==="update"&&t?(this.items.set(e,t),this._addToIndexes(e,t)):n.type==="delete"&&t&&(this.items.set(e,t),this._addToIndexes(e,t)),this.pending.delete(e),this._updateStats())},rebuildIndexes(){Object.values(this.indexes).forEach(e=>e.clear()),this.items.forEach((e,t)=>{this._addToIndexes(t,e)}),Logger.debug("STORE",`Rebuilt indexes for ${this.items.size} mappings`)},filter({method:e,url:t,priority:n,scenario:a}){let o=new Set(this.items.keys());if(e){const r=this.indexes.byMethod.get(e.toUpperCase());if(r)o=this._intersect(o,r);else return[]}if(t){const r=this.indexes.byUrl.get(t);r?o=this._intersect(o,r):o=new Set([...o].filter(c=>{const s=this.items.get(c);return this._matchesUrl(s,t)}))}if(n!==void 0){const r=this.indexes.byPriority.get(n);if(r)o=this._intersect(o,r);else return[]}if(a){const r=this.indexes.byScenario.get(a);if(r)o=this._intersect(o,r);else return[]}return Array.from(o).map(r=>this.get(r)).filter(Boolean)},clear(){this.items.clear(),this.pending.clear(),Object.values(this.indexes).forEach(e=>e.clear()),this.metadata={serverVersion:null,lastFullSync:null,lastIncrementalSync:null,isSyncing:!1,syncError:null},this._updateStats(),Logger.info("STORE","Cleared all data")},_addToIndexes(e,t){const n=t.request?.method||"GET";this.indexes.byMethod.has(n)||this.indexes.byMethod.set(n,new Set),this.indexes.byMethod.get(n).add(e);const a=t.request?.urlPattern||t.request?.url||t.request?.urlPath;a&&(this.indexes.byUrl.has(a)||this.indexes.byUrl.set(a,new Set),this.indexes.byUrl.get(a).add(e));const o=t.priority||1;this.indexes.byPriority.has(o)||this.indexes.byPriority.set(o,new Set),this.indexes.byPriority.get(o).add(e),t.scenarioName&&(this.indexes.byScenario.has(t.scenarioName)||this.indexes.byScenario.set(t.scenarioName,new Set),this.indexes.byScenario.get(t.scenarioName).add(e))},_removeFromIndexes(e){Object.values(this.indexes).forEach(t=>{t.forEach((n,a)=>{n.delete(e),n.size===0&&t.delete(a)})})},_intersect(e,t){const n=new Set;return e.forEach(a=>{t.has(a)&&n.add(a)}),n},_matchesUrl(e,t){const n=e.request?.urlPattern||e.request?.url||e.request?.urlPath||"";if(n===t)return!0;try{return new RegExp(t).test(n)}catch{return n.includes(t)}},_updateStats(){this.stats.totalMappings=this.items.size,this.stats.pendingOperations=this.pending.size}},typeof window<"u"&&(window.MappingsStore.init(),Object.defineProperty(window,"originalMappings",{get:function(){return window.MappingsStore?window.MappingsStore.getAll():[]},configurable:!0,enumerable:!0}),Object.defineProperty(window,"allMappings",{get:function(){return window._filteredMappings?window._filteredMappings:window.MappingsStore?window.MappingsStore.getAll():[]},configurable:!0,enumerable:!0}),Object.defineProperty(window,"originalRequests",{get:function(){return window.MappingsStore?window.MappingsStore.getAllRequests():[]},set:function(e){window.MappingsStore&&typeof window.MappingsStore.setRequests=="function"&&window.MappingsStore.setRequests(e);try{delete window._filteredRequests}catch{}},configurable:!0,enumerable:!0}),Object.defineProperty(window,"allRequests",{get:function(){return window._filteredRequests?window._filteredRequests:window.MappingsStore?window.MappingsStore.getAllRequests():[]},set:function(e){window._filteredRequests=Array.isArray(e)?e:[]},configurable:!0,enumerable:!0})),window.SyncEngine={config:{incrementalInterval:3e4,fullSyncInterval:3e5,fullSyncTimeout:6e4,cacheRebuildInterval:6e4,cacheMaxAge:36e5,maxRetries:3,retryDelay:2e3},timers:{incremental:null,fullSync:null,cacheRebuild:null},isStarted:!1,lastCacheHash:null,isIncrementalSyncing:!1,isFullSyncing:!1,useServiceCache:!0,init(){Logger.info("SYNC","Initializing SyncEngine"),this.stop(),Logger.info("SYNC","SyncEngine initialized")},start(){if(this.isStarted){Logger.debug("SYNC","Sync timers already running, skipping start");return}Logger.info("SYNC","Starting sync timers"),this.isStarted=!0,this.timers.incremental=window.LifecycleManager.setInterval(()=>this.incrementalSync(),this.config.incrementalInterval),this.timers.fullSync=window.LifecycleManager.setInterval(()=>this.fullSync({background:!0}),this.config.fullSyncInterval),this.useServiceCache&&(this.timers.cacheRebuild=window.LifecycleManager.setInterval(()=>this.rebuildServiceCache(),this.config.cacheRebuildInterval)),Logger.info("SYNC","Sync timers started")},stop(){Logger.info("SYNC","Stopping sync timers"),Object.keys(this.timers).forEach(e=>{this.timers[e]&&(window.LifecycleManager.clearInterval(this.timers[e]),this.timers[e]=null)}),this.isStarted=!1},async coldStart(e={}){const t=e.useCache===!0;this.useServiceCache=t,Logger.info("SYNC",`Cold start - loading from ${t?"cache or server":"server only"}`),this._showLoadingState();try{if(t){const n=await this.loadFromServiceCache();n&&n.items&&n.items.length>0&&(Logger.info("SYNC",`Loaded ${n.items.length} mappings from cache`),window.MappingsStore.setFromServer(n.items,{version:n.version}),this._renderMappings("cache"),this._applyMappingFilters(),this._updateDataSourceIndicator("cache"),Logger.info("SYNC","Initial UI rendered from cache"))}Logger.info("SYNC","Starting background full sync for latest data"),await this.fullSync({background:!0})}catch(n){Logger.error("SYNC","Cold start failed:",n);try{await this.fullSync({background:!1})}catch(a){throw Logger.error("SYNC","Fallback full sync also failed:",a),a}}},async fullSync({background:e=!1}={}){if(this.isFullSyncing){Logger.debug("SYNC","Full sync already in progress, skipping overlapping run");return}if(window.MappingsStore.metadata.isSyncing||window.MappingsStore.metadata.isOptimisticUpdate){Logger.debug("SYNC","Already syncing or optimistic update in progress, skipping full sync");return}this.isFullSyncing=!0,Logger.info("SYNC",`Starting full sync (background: ${e})`),e&&this._showSyncIndicator(),window.MappingsStore.metadata.isSyncing=!0,window.MappingsStore.metadata.syncStartTime=Date.now();const t=Date.now();try{const n=await this._fetchWithTimeout(typeof window.fetchMappingsFromServer=="function"?window.fetchMappingsFromServer({force:!0}):fetch(`${window.wiremockBaseUrl}/mappings`).then(s=>s.json()),this.config.fullSyncTimeout),a=n.mappings||[],o=n.meta?.version||n.meta?.etag||null;Logger.info("SYNC",`Received ${a.length} mappings from server`);const r=a.filter(s=>(s.id||s.uuid)!=="00000000-0000-0000-0000-00000000cace"&&!this._isServiceCacheMapping(s));window.MappingsStore.setFromServer(r,{version:o}),this._renderMappings("direct",{skipSyncCheck:!0}),this._applyMappingFilters(),this._updateDataSourceIndicator("synced");const c=Date.now()-t;window.MappingsStore.stats.lastSyncDuration=c,Logger.info("SYNC",`Full sync completed in ${c}ms`)}catch(n){if(Logger.error("SYNC","Full sync failed:",n),window.MappingsStore.metadata.syncError=n.message,!e)throw n}finally{this.isFullSyncing=!1,window.MappingsStore.metadata.isSyncing=!1,window.MappingsStore.metadata.syncStartTime=null,this._hideSyncIndicator()}},async incrementalSync(){if(this.isIncrementalSyncing){Logger.debug("SYNC","Incremental sync already in progress, skipping overlapping run");return}this.isIncrementalSyncing=!0;try{if(window.MappingsStore.metadata.isSyncing||window.MappingsStore.metadata.isOptimisticUpdate){Logger.debug("SYNC","Already syncing or optimistic update in progress, skipping incremental sync");return}if(this.isFullSyncing){Logger.debug("SYNC","Full sync in progress, skipping incremental");return}if(!window.MappingsStore.metadata.lastFullSync){Logger.debug("SYNC","No full sync yet, skipping incremental");return}Logger.debug("SYNC","Starting lightweight incremental sync check");const e=Date.now()-(window.MappingsStore.metadata.lastFullSync||0),t=this.config.fullSyncInterval/2;e>t?Logger.debug("SYNC",`Data approaching staleness (${Math.round(e/1e3)}s since last sync), will refresh on next full sync`):Logger.debug("SYNC",`Data is fresh (${Math.round(e/1e3)}s since last sync), skipping server check`)}finally{this.isIncrementalSyncing=!1}},async loadFromServiceCache(){if(!this.useServiceCache)return null;try{Logger.debug("SYNC","Attempting to load from Service Cache");let e;try{e=await window.apiFetch("/mappings/00000000-0000-0000-0000-00000000cace")}catch(r){if(r.status===404)return Logger.debug("SYNC","Service Cache not found"),null;throw r}const t=e.response?.jsonBody||e,n=t.items||t.mappings;if(!n||!Array.isArray(n))return Logger.warn("SYNC","Invalid cache format"),null;const a={...t,items:n},o=Date.now()-(a.timestamp||0);return o>this.config.cacheMaxAge?(Logger.info("SYNC",`Cache is stale (${Math.round(o/1e3)}s old), skipping`),null):(Logger.info("SYNC",`Service Cache loaded (${a.items.length} items, ${Math.round(o/1e3)}s old)`),a)}catch(e){return Logger.warn("SYNC","Failed to load Service Cache:",e),null}},async rebuildServiceCache(){if(!this.useServiceCache)return;if(window.MappingsStore.pending.size>0||window.MappingsStore.metadata.isOptimisticUpdate){Logger.debug("SYNC","Skipping cache rebuild - pending operations or optimistic updates exist");return}const e=this._hashMappings(window.MappingsStore.items);if(e===this.lastCacheHash){Logger.debug("SYNC","Skipping cache rebuild - no changes");return}Logger.info("SYNC","Rebuilding Service Cache");try{const t={timestamp:Date.now(),version:window.MappingsStore.metadata.serverVersion,items:Array.from(window.MappingsStore.items.values()),count:window.MappingsStore.items.size},n={...t,items:t.items.map(o=>{if(!o||typeof o!="object")return o;const r={...o};return delete r._pending,delete r._operation,delete r._deleted,delete r.__optimisticTs,r.request&&(delete r.request._pending,delete r.request._operation,delete r.request._deleted),r.response&&(delete r.response._pending,delete r.response._operation,delete r.response._deleted),r})},a={id:"00000000-0000-0000-0000-00000000cace",priority:1e3,request:{method:"GET",url:"/__imock/cache/v2"},response:{status:200,jsonBody:n}};try{await window.apiFetch(`/mappings/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}catch(o){if(o.status===404)await window.apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});else throw o}this.lastCacheHash=e,Logger.info("SYNC",`Service Cache saved (${t.count} mappings)`)}catch(t){Logger.warn("SYNC","Failed to rebuild Service Cache:",t)}},_emit(e,t={}){return window.AppEvents&&typeof window.AppEvents.emit=="function"?window.AppEvents.emit(e,t):!1},_showLoadingState(){this._emit("sync:loading",{})||typeof window.showLoadingState=="function"&&window.showLoadingState()},_renderMappings(e,t={}){const n={source:e||"direct",skipSyncCheck:t.skipSyncCheck===!0,mappings:window.MappingsStore?.getAll?.()||[]};this._emit("sync:render-mappings",n)||typeof window.fetchAndRenderMappings=="function"&&window.fetchAndRenderMappings(n.mappings,{source:n.source,skipSyncCheck:n.skipSyncCheck})},_applyMappingFilters(){this._emit("sync:apply-mapping-filters",{})||window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function"&&window.FilterManager.applyMappingFilters()},_updateDataSourceIndicator(e){this._emit("sync:data-source",{source:e})||typeof window.updateDataSourceIndicator=="function"&&window.updateDataSourceIndicator(e)},_notifyWarning(e,t={}){this._emit("sync:notify",{level:"warning",message:e,...t})||window.NotificationManager&&typeof window.NotificationManager.warning=="function"&&window.NotificationManager.warning(e)},_detectChanges(e){const t=new Set(e.map(c=>c.id||c.uuid)),n=new Set(window.MappingsStore.items.keys()),a=[],o=[],r=[];return e.forEach(c=>{const s=c.id||c.uuid;if(!n.has(s))a.push(c);else{const d=window.MappingsStore.items.get(s);this._hasChanged(d,c)&&o.push(c)}}),n.forEach(c=>{t.has(c)||r.push(c)}),{added:a,updated:o,deleted:r,hasChanges:a.length>0||o.length>0||r.length>0}},_hasChanged(e,t){try{return JSON.stringify(e)!==JSON.stringify(t)}catch{return!0}},_handleConflicts(e){Logger.warn("SYNC",`Handling ${e.length} conflicts`),e.forEach(t=>{if(t.type==="delete"){Logger.warn("SYNC",`Conflict: mapping ${t.id} was deleted on server`);const n=t.local?.name||t.id;this._notifyWarning(`Mapping "${n}" was deleted by another user`,{type:"delete",mappingId:t.id,conflict:t}),window.MappingsStore.pending.delete(t.id)}else if(t.type==="update"){const n=this._getTimestamp(t.server),a=t.localTimestamp||Date.now();if(n>a){Logger.warn("SYNC",`Conflict: server version is newer for ${t.id}`);const o=t.server?.name||t.id;this._notifyWarning(`Your changes to "${o}" were overwritten by another user`,{type:"update",mappingId:t.id,conflict:t}),window.MappingsStore.rollbackPending(t.id,t.server)}else Logger.warn("SYNC",`Conflict: local version is newer for ${t.id}, keeping local`)}})},_getTimestamp(e){return e?.metadata?.edited||e?.metadata?.updated||e?.metadata?.created||0},_formatChangesSummary(e){const t=[];return e.added.length>0&&t.push(`+${e.added.length} added`),e.updated.length>0&&t.push(`~${e.updated.length} updated`),e.deleted.length>0&&t.push(`-${e.deleted.length} deleted`),t.join(", ")},_hashMappings(e){if(e.size===0)return"0:";const t=Array.from(e.keys());if(t.length>1e3){const n=t.slice(0,50).sort().join("|").substring(0,100),a=t.slice(-50).sort().join("|").substring(0,100),o=`${n}...${a}`;return`${e.size}:${this._simpleHash(o)}`}else{const n=t.sort().join(",");return`${e.size}:${n}`}},_simpleHash(e){let t=0;for(let n=0;n<e.length;n++){const a=e.charCodeAt(n);t=(t<<5)-t+a,t|=0}return Math.abs(t).toString(36)},_isServiceCacheMapping(e){return(e.id||e.uuid)==="00000000-0000-0000-0000-00000000cace"||e.request?.url?.includes("/__imock/cache")},_fetchWithTimeout(e,t){return Promise.race([e,new Promise((n,a)=>setTimeout(()=>a(new Error("Request timeout")),t))])},_showSyncIndicator(){if(this._emit("sync:indicator",{active:!0}))return;const e=document.getElementById("sync-indicator");e&&e.classList.add("is-active")},_hideSyncIndicator(){if(this._emit("sync:indicator",{active:!1}))return;const e=document.getElementById("sync-indicator");e&&e.classList.remove("is-active")}},typeof window<"u"&&window.SyncEngine.init(),(function(){if(window.__syncEngineUiBridgeReady)return;window.__syncEngineUiBridgeReady=!0;const t=(n,a)=>{!window.AppEvents||typeof window.AppEvents.on!="function"||window.AppEvents.on(n,a)};t("sync:loading",()=>{typeof window.showLoadingState=="function"&&window.showLoadingState()}),t("sync:render-mappings",n=>{if(typeof window.fetchAndRenderMappings!="function")return;const a=n?.detail||{},o=Array.isArray(a.mappings)?a.mappings:window.MappingsStore?.getAll?.()||[];window.fetchAndRenderMappings(o,{source:a.source||"direct",skipSyncCheck:a.skipSyncCheck===!0})}),t("sync:apply-mapping-filters",()=>{window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function"&&window.FilterManager.applyMappingFilters()}),t("sync:data-source",n=>{if(typeof window.updateDataSourceIndicator!="function")return;const a=n?.detail?.source;typeof a=="string"&&a.length>0&&window.updateDataSourceIndicator(a)}),t("sync:indicator",n=>{const a=document.getElementById("sync-indicator");if(!a)return;const o=n?.detail?.active===!0;a.classList.toggle("is-active",o)}),t("sync:notify",n=>{const a=n?.detail||{},o=a.level||"warning",r=a.message;!r||!window.NotificationManager||(typeof window.NotificationManager[o]=="function"?window.NotificationManager[o](r):typeof window.NotificationManager.warning=="function"&&window.NotificationManager.warning(r))}),t("wiremock:success",n=>{const a=n?.detail?.timestamp;if(typeof a=="number"&&(window.lastWiremockSuccess=a),window.Utils&&typeof window.Utils.safeCall=="function")window.Utils.safeCall(window.updateLastSuccessUI);else if(typeof window.updateLastSuccessUI=="function")try{window.updateLastSuccessUI()}catch{}})})();function normalizeScenarioNameValue(e){if(e==null)return{original:e,normalized:e,changed:!1,cleared:!1,hadWhitespace:!1};const t=typeof e=="string"?e:String(e),n=/\s/.test(t),a=t.trim().replace(/\s+/g,"_");return{original:t,normalized:a,changed:a!==t,cleared:!!t&&!a,hadWhitespace:n}}function normalizeScenarioNameField(e,{notify:t}={}){if(!e||typeof e!="object")return{changed:!1};if(!Object.prototype.hasOwnProperty.call(e,"scenarioName"))return{changed:!1};const a=(typeof window.Utils?.normalizeScenarioName=="function"?window.Utils.normalizeScenarioName:normalizeScenarioNameValue)(e.scenarioName);return!a?.changed||!a?.hadWhitespace?{changed:!1}:(a.cleared?(delete e.scenarioName,t?.("Scenario name contained only whitespace and was cleared")):(e.scenarioName=a.normalized,t?.(`Scenario name cannot contain spaces. Replaced with "${a.normalized}"`)),{changed:!0,original:a.original,normalized:a.normalized,cleared:a.cleared})}window.MappingsOperations={async create(e){const t={...e||{}};normalizeScenarioNameField(t,{notify:o=>window.NotificationManager?.warning?.(o)});const n=typeof crypto?.randomUUID=="function"?`temp-${crypto.randomUUID()}`:`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;Logger.info("OPS",`Creating mapping with temp ID: ${n}`);const a={...t,id:n,_pending:!0,_operation:"create"};try{window.MappingsStore.addPending({id:n,type:"create",payload:t,optimisticMapping:a}),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.info=="function"&&window.NotificationManager.info("Creating mapping...");const o=await this._sendCreateRequest(t),r=o.id||o.uuid;if(Logger.info("OPS",`Mapping created on server with ID: ${r}`),window.MappingsStore.confirmPending(n,o),this._refreshUI(),this._broadcastUpdate("created",o),window.NotificationManager&&typeof window.NotificationManager.success=="function"){const c=o.name||o.id.substring(0,8);window.NotificationManager.success(`Mapping "${c}" created successfully`)}return o}catch(o){throw Logger.error("OPS","Failed to create mapping:",o),window.MappingsStore.rollbackPending(n,null),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.error=="function"&&window.NotificationManager.error(`Failed to create mapping: ${o.message}`),o}},async update(e,t){Logger.info("OPS",`Updating mapping: ${e}`);const n=window.MappingsStore.get(e);if(!n)throw new Error(`Mapping ${e} not found`);if(window.MappingsStore.pending.has(e))throw Logger.warn("OPS",`Mapping ${e} already has pending operation`),new Error("Mapping has pending changes");const a={...t||{}},o={...n,...a,_pending:!0,_operation:"update",metadata:{...n.metadata,...a.metadata,edited:Date.now()}};normalizeScenarioNameField(o,{notify:r=>window.NotificationManager?.warning?.(r)});try{window.MappingsStore.addPending({id:e,type:"update",payload:a,optimisticMapping:o,original:n}),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.info=="function"&&window.NotificationManager.info("Saving changes...");const r=await this._sendUpdateRequest(e,o);if(Logger.info("OPS",`Mapping updated on server: ${e}`),window.MappingsStore.confirmPending(e,r),this._refreshUI(),this._broadcastUpdate("updated",r),window.NotificationManager&&typeof window.NotificationManager.success=="function"){const c=r.name||e.substring(0,8);window.NotificationManager.success(`Mapping "${c}" updated successfully`)}return r}catch(r){throw Logger.error("OPS","Failed to update mapping:",r),window.MappingsStore.rollbackPending(e,n),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.error=="function"&&window.NotificationManager.error(`Failed to update mapping: ${r.message}`),r}},async delete(e){Logger.info("OPS",`Deleting mapping: ${e}`);const t=window.MappingsStore.get(e);if(!t){Logger.warn("OPS",`Mapping ${e} not found, skipping delete`);return}const n={...t,_deleted:!0,_pending:!0,_operation:"delete"};try{if(window.MappingsStore.addPending({id:e,type:"delete",payload:null,optimisticMapping:n,original:t}),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.info=="function"){const a=t.name||e.substring(0,8);window.NotificationManager.info(`Deleting "${a}"...`)}if(await this._sendDeleteRequest(e),Logger.info("OPS",`Mapping deleted on server: ${e}`),window.MappingsStore.confirmPending(e,null),this._refreshUI(),this._broadcastUpdate("deleted",t),window.NotificationManager&&typeof window.NotificationManager.success=="function"){const a=t.name||e.substring(0,8);window.NotificationManager.success(`Mapping "${a}" deleted successfully`)}}catch(a){throw Logger.error("OPS","Failed to delete mapping:",a),window.MappingsStore.rollbackPending(e,t),this._refreshUI(),window.NotificationManager&&typeof window.NotificationManager.error=="function"&&window.NotificationManager.error(`Failed to delete mapping: ${a.message}`),a}},async batchDelete(e){Logger.info("OPS",`Batch deleting ${e.length} mappings`);const t={success:[],failed:[]};for(const n of e)try{await this.delete(n),t.success.push(n)}catch(a){Logger.error("OPS",`Failed to delete ${n}:`,a),t.failed.push({id:n,error:a.message})}return Logger.info("OPS",`Batch delete complete: ${t.success.length} succeeded, ${t.failed.length} failed`),window.NotificationManager&&(t.failed.length===0?window.NotificationManager.success(`Deleted ${t.success.length} mappings`):window.NotificationManager.warning(`Deleted ${t.success.length} mappings, ${t.failed.length} failed`)),t},async _sendCreateRequest(e){const t=this._cleanMappingData(e);return await window.apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})},async _sendUpdateRequest(e,t){const n=this._cleanMappingData(t);return await window.apiFetch(`/mappings/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})||n},async _sendDeleteRequest(e){await window.apiFetch(`/mappings/${e}`,{method:"DELETE"})},_cleanMappingData(e){const t={...e};return delete t._pending,delete t._operation,delete t._deleted,t},_refreshUI(){if(!window.MappingsStore){Logger.warn("OPS","MappingsStore not available for UI refresh");return}if(typeof window.refreshMappingTabSnapshot=="function"&&window.refreshMappingTabSnapshot(),window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function")window.FilterManager.applyMappingFilters(),typeof window.FilterManager.flushMappingFilters=="function"&&window.FilterManager.flushMappingFilters();else{Logger.warn("OPS","FilterManager not available, rendering without filters");const e=window.MappingsStore.getAll();typeof window.fetchAndRenderMappings=="function"&&window.fetchAndRenderMappings(e,{source:"optimistic"})}},_broadcastUpdate(e,t){if(typeof BroadcastChannel<"u")try{new BroadcastChannel("imock-optimistic-updates").postMessage({type:"mapping-"+e,operation:e,mapping:t,source:"mappings-operations",timestamp:Date.now()}),Logger.debug("OPS",`Broadcasted ${e} update:`,t.id)}catch(n){Logger.warn("OPS","Failed to broadcast update:",n)}try{const n="imock-optimistic-update",a={type:"mapping-"+e,operation:e,mapping:t,source:"mappings-operations",timestamp:Date.now()};localStorage.setItem(n,JSON.stringify(a)),setTimeout(()=>{try{localStorage.removeItem(n)}catch{}},1e3)}catch(n){Logger.warn("OPS","Failed to update localStorage:",n)}}};function isCacheEnabled(){try{const e=document.getElementById("cache-enabled"),t=typeof window.readWiremockSettings=="function"?window.readWiremockSettings():{},n=e&&typeof e.checked=="boolean"?e.checked:!0;return t.cacheEnabled!==!1&&n}catch(e){return Logger.warn("CACHE","Failed to resolve cache enabled state. Defaulting to cache disabled. Check settings configuration.",e),!1}}window.isCacheEnabled=isCacheEnabled,window.connectToWireMock=async()=>{const e=document.getElementById("wiremock-host")||document.getElementById(SELECTORS.CONNECTION.HOST),t=document.getElementById("wiremock-port")||document.getElementById(SELECTORS.CONNECTION.PORT);let n,a;if(e&&t)n=e.value.trim()||"localhost",a=t.value.trim()||"8080";else if(window.wiremockBaseUrl)Logger.api("Using existing wiremockBaseUrl for connection"),n="localhost",a="8080";else{const s=typeof window.readWiremockSettings=="function"?window.readWiremockSettings():{};n=s.host||"localhost",a=s.port||"8080",Logger.api("Using settings for connection:",{host:n,port:a})}Logger.api("Connecting with:",{host:n,port:a});const o=document.getElementById(SELECTORS.CONNECTION.STATUS_DOT),r=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT),c=document.getElementById(SELECTORS.LOADING.MAPPINGS);if(o&&(o.className="status-dot connecting"),r&&(r.textContent="Connecting..."),c&&c.classList.remove("hidden"),!window.wiremockBaseUrl||e){if(typeof window.normalizeWiremockBaseUrl=="function")window.wiremockBaseUrl=window.normalizeWiremockBaseUrl(n,a);else{const s=/^(https?:)\/\//i.test(n),d=s?n.split(":")[0]:"http",g=s?n.replace(/^(https?:)\/\//i,""):n,E=a&&String(a).trim()||(d==="https"?"443":"8080");window.wiremockBaseUrl=`${d}://${g}:${E}/__admin`}Logger.api("Updated wiremockBaseUrl:",window.wiremockBaseUrl)}else Logger.api("Using pre-configured wiremockBaseUrl:",window.wiremockBaseUrl);try{await checkHealthAndStartUptime(),Logger.info("API","Online mode - proceeding with data loading");const s=document.getElementById(SELECTORS.CONNECTION.SETUP),d=document.getElementById(SELECTORS.BUTTONS.ADD_MAPPING);o&&(o.className="status-dot connected"),r&&(window.lastWiremockSuccess||(window.lastWiremockSuccess=Date.now()),typeof window.updateLastSuccessUI=="function"&&window.updateLastSuccessUI()),s&&(s.style.display="none"),d&&(d.disabled=!1);const g=document.getElementById(SELECTORS.UI.STATS),E=document.getElementById("stats-spacer"),b=document.getElementById(SELECTORS.UI.SEARCH_FILTERS);g&&(g.style.display="flex"),E&&(E.style.display="none"),b&&(b.style.display="block"),startHealthCheck(),Logger.info("API","Using new optimized sync engine");const S=isCacheEnabled();Logger.info("CACHE",`Service cache is ${S?"enabled":"disabled"} for this session`),window.SyncEngine.stop(),await window.SyncEngine.coldStart({useCache:S}),window.SyncEngine.start(),await loadScenarios(),typeof window.hideOnboardingOverlay=="function"&&window.hideOnboardingOverlay(),typeof window.FilterManager?.restoreFilters=="function"&&window.FilterManager.restoreFilters("mappings")?.query&&typeof window.FilterManager.applyMappingFilters=="function"&&(window.FilterManager.applyMappingFilters(),typeof window.FilterManager.flushMappingFilters=="function"&&window.FilterManager.flushMappingFilters()),NotificationManager.success("Connected to WireMock successfully!")}catch(s){Logger.error("API","Connection error - entering offline mode:",s),Logger.warn("API","Offline mode - no server requests will be made"),stopUptime(),o&&(o.className="status-dot disconnected"),r&&(r.textContent="Offline"),c&&c.classList.add("hidden"),NotificationManager.warning("WireMock server is offline. Retrying connection in background..."),startHealthCheck()}};let healthCheckTimeout=null,healthCheckFailureCount=0;window.startHealthCheck=()=>{healthCheckTimeout&&(clearTimeout(healthCheckTimeout),healthCheckTimeout=null);let e;window.isOnline?e=3e4:e=Math.min(2e3*Math.pow(2,healthCheckFailureCount),6e4),Logger.info("HEALTH",`Scheduling next check in ${e}ms (${window.isOnline?"online":`offline, attempt ${healthCheckFailureCount+1}`})`),healthCheckTimeout=setTimeout(async()=>{try{const t=performance.now();let n=!1,a=0;try{const r=await apiFetch(ENDPOINTS.HEALTH);a=Math.round(performance.now()-t),n=typeof r=="object"&&(typeof r.status=="string"&&["up","healthy","ok"].includes(r.status.toLowerCase())||r.healthy===!0)}catch(r){if(r?.message?.includes("404")||r?.status===404){Logger.warn("HEALTH","/health not found (404), trying /mappings fallback for older WireMock");try{const s=await window.apiFetch(window.ENDPOINTS.MAPPINGS);a=Math.round(performance.now()-t),n=typeof s=="object"&&s!==null&&!s.__isDemo}catch{n=!1}}else n=!1}const o=window.isOnline;if(window.isOnline=n,n){healthCheckFailureCount=0;const r=document.getElementById(SELECTORS.HEALTH.INDICATOR);r&&(r.innerHTML=`<span>Response Time: </span><span class="healthy">${a}ms</span>`),o?Logger.info("HEALTH",`Server is healthy (${a}ms)`):(Logger.info("HEALTH",`Server is back online (${a}ms)`),NotificationManager.success("WireMock server is back online! Reconnecting..."),await window.connectToWireMock())}else{healthCheckFailureCount++;const r=document.getElementById(SELECTORS.HEALTH.INDICATOR);if(r&&(r.innerHTML='<span>Response Time: </span><span class="unhealthy">Offline</span>'),o){Logger.warn("HEALTH","Server went offline"),stopUptime();const c=document.getElementById(SELECTORS.CONNECTION.STATUS_DOT),s=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT);c&&(c.className="status-dot disconnected"),s&&(s.textContent="Offline"),NotificationManager.warning("WireMock server went offline. Retrying in background...")}else Logger.warn("HEALTH",`Server still offline (attempt ${healthCheckFailureCount})`)}startHealthCheck()}catch(t){Logger.error("HEALTH","Check error:",t),window.isOnline=!1,healthCheckFailureCount++,startHealthCheck()}},e)},window.stopHealthCheck=()=>{healthCheckTimeout&&(clearTimeout(healthCheckTimeout),healthCheckTimeout=null,healthCheckFailureCount=0,Logger.info("HEALTH","Health check stopped"))},window.checkHealthAndStartUptime=async()=>{try{const e=performance.now();let t=0,n=!1;try{const a=await apiFetch(ENDPOINTS.HEALTH);t=Math.round(performance.now()-e),n=typeof a=="object"&&(typeof a.status=="string"&&["up","healthy","ok"].includes(a.status.toLowerCase())||a.healthy===!0),Logger.info("HEALTH","initial check:",{rawStatus:a?.status,healthyFlag:a?.healthy,isHealthy:n})}catch(a){if(a?.message?.includes("404")||a?.status===404){Logger.warn("HEALTH","/health not found (404), trying /mappings fallback for older WireMock");try{const r=await window.apiFetch(window.ENDPOINTS.MAPPINGS);t=Math.round(performance.now()-e),n=typeof r=="object"&&r!==null&&!r.__isDemo,Logger.info("HEALTH","fallback check (mappings):",{isHealthy:n,responseTime:t})}catch{Logger.warn("HEALTH","fallback failed - offline mode"),n=!1}}else Logger.warn("HEALTH","connection failed - offline mode"),n=!1}if(n){if(window.isOnline=!0,window.startTime=Date.now(),window.uptimeInterval&&window.LifecycleManager.clearInterval(window.uptimeInterval),window.uptimeInterval=window.LifecycleManager.setNamedInterval("uptime-display",updateUptime,1e3),typeof window.applyHealthUI=="function")try{window.applyHealthUI(!0,t)}catch(o){Logger.warn("HEALTH","applyHealthUI failed:",o)}const a=document.getElementById(SELECTORS.HEALTH.INDICATOR);a&&(a.style.display="inline",a.innerHTML=`<span>Response Time: </span><span class="healthy">${t}ms</span>`),Logger.info("HEALTH",`WireMock health check passed (${t}ms), uptime started, online mode`)}else throw window.isOnline=!1,new Error("WireMock is not reachable - offline mode")}catch(e){throw window.isOnline=!1,Logger.error("HEALTH","Health check failed - entering offline mode:",e),e}};function isOptimisticShadowMap(e){return e&&typeof e=="object"&&typeof e.forEach=="function"&&typeof e.size=="number"&&Object.prototype.toString.call(e)==="[object Map]"}window.mappingPreviewState instanceof Set||(window.mappingPreviewState=new Set),window.mappingPreviewToastState instanceof Map||(window.mappingPreviewToastState=new Map),isOptimisticShadowMap(window.optimisticShadowMappings)||(window.optimisticShadowMappings=new Map);const UIComponents={createCard:(e,t,n=[])=>{const{id:a,method:o,url:r,status:c,name:s,time:d,extras:g={},expanded:E=!1}=t,b={editMapping:"edit-external",openEditModal:"edit-mapping",deleteMapping:"delete-mapping",duplicateMapping:"duplicate-mapping",viewRequestDetails:"view-request"};return`
            <div class="${e}-card${E?" is-expanded":""}" data-id="${Utils.escapeHtml(a)}">
                <div class="${e}-header" data-action="toggle-details">
                    <div class="${e}-info">
                        <div class="${e}-top-line">
                            <span class="method-badge ${o.toLowerCase()}">
                                <span class="collapse-arrow" id="arrow-${Utils.escapeHtml(a)}">${E?"\u25BC":"\u25B6"}</span> ${o}
                            </span>
                            ${s?`<span class="${e}-name">${Utils.escapeHtml(s)}</span>`:""}
                            ${d?`<span class="${e}-time">${d}</span>`:""}
                        </div>
                        <div class="${e}-url-line">
                            <span class="status-badge ${Utils.getStatusClass(c)}">${c}</span>
                            <span class="${e}-url">${Utils.escapeHtml(r)}</span>
                            ${g.badges||""}
                        </div>
                    </div>
                    <div class="${e}-actions">
                        ${n.map(S=>{const I=b[S.handler]||S.handler;return`
                            <button class="btn btn-sm btn-${S.class}"
                                    data-action="${I}"
                                    data-${e}-id="${Utils.escapeHtml(a)}"
                                    title="${Utils.escapeHtml(S.title)}">
                                ${S.icon?Icons.render(S.icon,{className:"action-icon"}):""}
                                <span class="sr-only">${Utils.escapeHtml(S.title)}</span>
                            </button>
                        `}).join("")}
                    </div>
                </div>
                <div class="${e}-preview" id="preview-${Utils.escapeHtml(a)}" style="display: ${E?"block":"none"};">
                    ${g.preview||""}
                </div>
            </div>`},getCardElement(e,t){const n=document.querySelectorAll(`.${e}-card`),a=String(t??"");for(const o of n)if((o.dataset?.id||"")===a)return o;return null},setCardState(e,t,n,a=!0){const o=this.getCardElement(e,t);o&&o.classList.toggle(n,!!a)},clearCardState(e,t){document.querySelectorAll(`.${e}-card.${t}`).forEach(n=>{n.classList.remove(t)})},createPreviewSection:(e,t)=>`
        <div class="preview-section">
            <h4>${e}</h4>
            ${Object.entries(t).map(([n,a])=>{if(!a)return"";if(typeof a=="object")if(JSON.stringify(a).length>500){const r=Utils.formatJson(a,"Invalid JSON",200),c=`full-${Math.random().toString(36).substr(2,9)}`;return`<div class="preview-value">
                            <strong>${n}:</strong>
                            <pre>${r}</pre>
                            <button class="btn btn-secondary btn-small" data-action="show-full-content" data-target-id="${c}" data-json="${Utils.escapeHtml(JSON.stringify(a))}" style="margin-top: 0.5rem; font-size: 0.8rem;">
                                Show Full Content
                            </button>
                            <div id="${c}" style="display: none;"></div>
                        </div>`}else return`<div class="preview-value"><strong>${n}:</strong><pre>${Utils.formatJson(a)}</pre></div>`;else if(typeof a=="string"){const o=a.trim();if(o.startsWith("{")&&o.endsWith("}"))try{const s=JSON.parse(o);if(JSON.stringify(s).length>500){const g=Utils.formatJson(s,"Invalid JSON",200),E=`full-${Math.random().toString(36).substr(2,9)}`;return`<div class="preview-value">
                                    <strong>${n}:</strong>
                                    <pre>${g}</pre>
                                    <button class="btn btn-secondary btn-small" data-action="show-full-content" data-target-id="${E}" data-json="${Utils.escapeHtml(JSON.stringify(s))}" style="margin-top: 0.5rem; font-size: 0.8rem;">
                                        Show Full Content
                                    </button>
                                    <div id="${E}" style="display: none;"></div>
                                </div>`}return`<div class="preview-value"><strong>${n}:</strong><pre>${Utils.formatJson(s)}</pre></div>`}catch{}const r=Utils.escapeHtml(a),c=r.includes(`
`)?`<pre>${r}</pre>`:r;return`<div class="preview-value"><strong>${n}:</strong> ${c}</div>`}else{const o=Utils.escapeHtml(String(a));return`<div class="preview-value"><strong>${n}:</strong> ${o}</div>`}}).join("")}
        </div>`,toggleDetails:(e,t)=>{const n=String(e??""),a=document.getElementById(`preview-${e}`),o=document.getElementById(`arrow-${e}`),r=a?a.style.display==="none":!1;if(a&&(a.style.display=r?"block":"none"),o&&(o.textContent=r?"\u25BC":"\u25B6"),t==="mapping"){const c=a?a.closest(`.${t}-card`):null;c&&c.classList.toggle("is-expanded",r),window.mappingPreviewState instanceof Set&&(r?window.mappingPreviewState.add(n):window.mappingPreviewState.delete(n))}UIComponents.setCardState(t,e,"is-expanded",r)},toggleFullContent:e=>{const t=document.getElementById(e),n=t.previousElementSibling;if(t.style.display==="none")try{const a=n.getAttribute("data-json"),o=JSON.parse(a);t.innerHTML=`<pre style="max-height: 300px; overflow-y: auto; background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-sm); margin-top: 0.5rem;">${Utils.escapeHtml(JSON.stringify(o,null,2))}</pre>`,t.style.display="block",n.textContent="Hide Full Content"}catch(a){t.innerHTML=`<div class="preview-value warning">Error parsing JSON: ${Utils.escapeHtml(a.message)}</div>`,t.style.display="block",n.textContent="Hide"}else t.style.display="none",n.textContent="Show Full Content"}};window.toggleFullContent=UIComponents.toggleFullContent,window.toggleDetails=UIComponents.toggleDetails;function getOptimisticShadowTtl(){const e=Number(window.DEFAULT_SETTINGS?.optimisticCacheAgeLimit);return Number.isFinite(e)&&e>0?Math.max(e,45e3):6e4}function cloneMappingForOptimisticShadow(e){if(!e||typeof e!="object")return null;try{return typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e))}catch{return{...e}}}function rememberOptimisticShadowMapping(e,t){if(isOptimisticShadowMap(window.optimisticShadowMappings)||(window.optimisticShadowMappings=new Map),!e||typeof e!="object")return;const n=e.id||e.uuid;if(!n)return;const a=typeof t=="string"?t.toLowerCase():"update";if(a==="delete"){window.optimisticShadowMappings.delete(String(n));return}const o=cloneMappingForOptimisticShadow(e);o&&(typeof o.__optimisticTs!="number"&&Object.defineProperty(o,"__optimisticTs",{value:Date.now(),writable:!1,enumerable:!1,configurable:!0}),window.optimisticShadowMappings.set(String(n),{ts:Date.now(),op:a==="create"?"create":"update",mapping:o}))}function getOptimisticShadowTimestamp(e){if(!e||typeof e!="object")return Number.NaN;const t=e.metadata||{},n=[t.edited,t.updated,t.updatedAt,t.created,t.timestamp];for(const a of n){if(!a)continue;if(a instanceof Date){const c=a.getTime();if(Number.isFinite(c))return c}const o=Date.parse(a);if(Number.isFinite(o))return o;const r=Number(a);if(Number.isFinite(r))return r}return typeof e.__optimisticTs=="number"?e.__optimisticTs:Number.NaN}function applyOptimisticShadowMappings(e){if(!Array.isArray(e)||!isOptimisticShadowMap(window.optimisticShadowMappings)||window.optimisticShadowMappings.size===0)return e;const t=Date.now(),n=getOptimisticShadowTtl(),a=[...e];for(const[o,r]of Array.from(window.optimisticShadowMappings.entries())){const c=String(o||"");if(!r||typeof r!="object"){window.optimisticShadowMappings.delete(c);continue}if(r.mapping==null){const d=a.findIndex(g=>String(g?.id||g?.uuid||"")===c);d!==-1&&a.splice(d,1),window.optimisticShadowMappings.delete(c);continue}if(!Number.isFinite(r.ts)||t-r.ts>n){window.optimisticShadowMappings.delete(c);continue}const s=a.findIndex(d=>String(d?.id||d?.uuid||"")===c);if(s!==-1){let d=!1,g=!0;if(typeof window.getMappingRenderSignature=="function")try{const E=window.getMappingRenderSignature(a[s]),b=window.getMappingRenderSignature(r.mapping);if(E===b){window.optimisticShadowMappings.delete(c);continue}}catch{}if((r.op||"update")==="create")g=!1;else{const E=getOptimisticShadowTimestamp(a[s]),b=getOptimisticShadowTimestamp(r.mapping);Number.isFinite(b)&&(!Number.isFinite(E)||b>E)?d=!0:g=!1}d?(r.ts=t,a[s]=r.mapping):g?r.ts=t:window.optimisticShadowMappings.delete(c)}else a.unshift(r.mapping),Number.isFinite(r.ts)||(r.ts=t)}return a}function pruneOptimisticShadowMappings(e){if(!isOptimisticShadowMap(window.optimisticShadowMappings)||window.optimisticShadowMappings.size===0||!Array.isArray(e)||e.length===0)return;const t=new Map;e.forEach(n=>{if(n&&typeof n=="object"){const a=String(n.id||n.uuid||"");a&&t.set(a,n)}});for(const[n,a]of Array.from(window.optimisticShadowMappings.entries())){if(!t.has(n))continue;if(!a||typeof a!="object"){window.optimisticShadowMappings.delete(n);continue}if((a.op||"update")==="create")continue;if(!a.mapping||typeof a.mapping!="object"){window.optimisticShadowMappings.delete(n);continue}const o=t.get(n);if(!o){window.optimisticShadowMappings.delete(n);continue}try{if(typeof window.getMappingRenderSignature=="function"&&a.mapping){const s=window.getMappingRenderSignature(o),d=window.getMappingRenderSignature(a.mapping);if(s===d){window.optimisticShadowMappings.delete(n);continue}}}catch{}const r=getOptimisticShadowTimestamp(o),c=getOptimisticShadowTimestamp(a.mapping);Number.isFinite(r)&&(!Number.isFinite(c)||r>=c)&&window.optimisticShadowMappings.delete(n)}}window.fetchAndRenderMappings=async(e=null,t={})=>{const n=document.getElementById(SELECTORS.LISTS.MAPPINGS),a=document.getElementById(SELECTORS.EMPTY.MAPPINGS),o=document.getElementById(SELECTORS.LOADING.MAPPINGS);if(!n||!a||!o)return Logger.error("UI","Required DOM elements not found for mappings rendering"),!1;const r=t?.skipSyncCheck===!0;if(!r&&window.MappingsStore?.metadata?.isRendering)return window.MappingsStore.metadata.pendingRenderRequest={mappingsToRender:Array.isArray(e)?[...e]:null,options:{...t||{},skipSyncCheck:!0,_queuedRender:!0}},Logger.debug("UI","Render in progress, queued next render to avoid lost updates"),!0;if(!r&&window.MappingsStore?.metadata?.isSyncing)return Logger.debug("UI","Sync in progress, skipping render to avoid race condition"),!0;window.MappingsStore?.metadata&&(window.MappingsStore.metadata.isRendering=!0);let c=null;try{if(e===null){o.classList.remove("hidden"),n.style.display="none",a.classList.add("hidden"),a.setAttribute("aria-hidden","true");let S,I="direct";if(t&&t.useCache){const w=await loadImockCacheBestOf3();if(w&&w.data&&Array.isArray(w.data.mappings)){Logger.cache("Cache hit - using cached data for quick start"),I="cache";const D=typeof w.data.timestamp=="number"?w.data.timestamp:(w.data.mappings||[]).reduce((Q,de)=>{const se=de?.metadata?.imock?.timestamp;return typeof se=="number"&&se>Q?se:Q},0);Date.now()-D>3e4&&(async()=>{try{const Q=typeof window<"u"&&typeof window.optimisticUpdateDelayMs=="number"?window.optimisticUpdateDelayMs:500;await new Promise(se=>setTimeout(se,Q));const de=await fetchMappingsFromServer({force:!0});if(de&&de.mappings){const se=de.mappings.filter(U=>!isImockCacheMapping(U)),be=(w.data.mappings||[]).filter(U=>!isImockCacheMapping(U));if(be.length!==se.length){if(window.MappingsStore&&window.MappingsStore.setFromServer(se),refreshMappingTabSnapshot(),syncCacheWithMappings(se),rebuildMappingIndex(se),typeof NotificationManager<"u"){const U=se.length-be.length;U>0?NotificationManager.info(`${U} new mapping${U===1?"":"s"} from server`,3e3):U<0&&NotificationManager.info(`${Math.abs(U)} mapping${Math.abs(U)===1?"":"s"} removed on server`,3e3),Logger.cache("Cache updated with server data:",{cachedCount:be.length,serverCount:se.length})}}else Logger.debug("CACHE","No changes detected, skipping cache update")}}catch(Q){Logger.warn("CACHE","Background cache validation failed:",Q)}})(),S=w.data}else{Logger.cache("Cache miss - loading from server"),typeof NotificationManager<"u"&&NotificationManager.info("Loading mappings from server...",2e3),S=await fetchMappingsFromServer({force:!0}),I="direct";try{Logger.cache("Async regenerate after cache miss"),regenerateImockCache()}catch{}}}else S=await fetchMappingsFromServer({force:!0}),I="direct";if(S&&S.__source){I=S.__source,I==="demo"&&markDemoModeActive("mappings-fallback");try{delete S.__source}catch{}}let L=S.mappings||[];const B=window.MappingsStore?.pending?Array.from(window.MappingsStore.pending.values()):[];B.length>0&&(Logger.debug("OPTIMISTIC","Applying optimistic updates to incoming data:",B.length,"updates"),L=L.map(w=>{const D=w.id||w.uuid,O=window.MappingsStore?.pending?window.MappingsStore.pending.get(D):null;return O?O.type==="delete"?(Logger.debug("OPTIMISTIC","Removing deleted mapping from results:",w.id),null):(Logger.debug("OPTIMISTIC","Using optimistic version for:",w.id),O.optimisticMapping):w}).filter(w=>w!==null),B.forEach(w=>{w.type!=="delete"&&!L.some(D=>(D.id||D.uuid)===w.id)&&(Logger.debug("OPTIMISTIC","Adding new optimistic mapping:",w.id),L.unshift(w.optimisticMapping))})),L=applyOptimisticShadowMappings(L);try{if(window.pendingDeletedIds&&window.pendingDeletedIds.size>0){const w=L.length;L=L.filter(D=>!window.pendingDeletedIds.has(D.id||D.uuid)),w!==L.length&&Logger.cache("filtered pending-deleted from render:",w-L.length)}}catch{}const M=Array.isArray(L)?L.filter(w=>!isImockCacheMapping(w)):[];window.MappingsStore&&window.MappingsStore.setFromServer(M),refreshMappingTabSnapshot(),syncCacheWithMappings(M),rebuildMappingIndex(M),pruneOptimisticShadowMappings(M),c=I}else{const S=typeof t?.source=="string"?t.source:null,I=Array.isArray(e)?[...e]:[];window.MappingsStore&&window.MappingsStore.setFromServer(I),refreshMappingTabSnapshot(),rebuildMappingIndex(I),pruneOptimisticShadowMappings(I),c=S,c==="demo"&&markDemoModeActive("manual-mappings")}o.classList.add("hidden");const s=document.getElementById(SELECTORS.MAPPING_FILTERS.QUERY)?.value?.trim()||"";let d=window.MappingsStore?window.MappingsStore.getAll():Array.isArray(e)?e:[];if(s&&window.QueryParser&&typeof window.QueryParser.filterMappingsByQuery=="function"&&(Logger.debug("UI","Applying filters before render:",s),d=window.QueryParser.filterMappingsByQuery(d,s)),window._filteredMappings=d,d.length===0)return a.classList.remove("hidden"),a.setAttribute("aria-hidden","false"),n.style.display="none",updateMappingsCounter(),c&&updateDataSourceIndicator(c),!0;a.classList.add("hidden"),a.setAttribute("aria-hidden","true"),n.style.display="block",window.invalidateElementCache(SELECTORS.LISTS.MAPPINGS);const g=d,E=typeof window.sortMappingsForDisplay=="function"?window.sortMappingsForDisplay(g):[...g],b=c||"previous";Logger.info("UI",`Mappings render from: ${b} \u2014 ${E.length} items`);try{if(n.style.willChange="contents",window.PaginationManager&&Logger.debug("UI",`Rendering page ${window.PaginationManager.currentPage}/${window.PaginationManager.totalPages}`),typeof window.renderMappingsCollection=="function")window.renderMappingsCollection(n,E,{preSorted:!0,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});else if(window.PaginationManager){window.PaginationManager.updateState(E.length);const I=window.PaginationManager.getCurrentPageItems(E);renderList(n,I,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const L=document.getElementById("mappings-pagination");L&&(L.innerHTML=window.PaginationManager.renderControls())}else renderList(n,E,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const S=()=>{updateMappingsCounter(),c&&updateDataSourceIndicator(c),n.style.willChange="auto";try{document.getElementById(SELECTORS.MAPPING_FILTERS.QUERY)?.value?.trim()&&typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay()}catch{}};typeof requestAnimationFrame=="function"?requestAnimationFrame(S):S()}catch(S){if(Logger.error("UI","DOM batch update failed:",S),typeof window.renderMappingsCollection=="function")window.renderMappingsCollection(n,E,{preSorted:!0,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});else if(window.PaginationManager){window.PaginationManager.updateState(E.length);const I=window.PaginationManager.getCurrentPageItems(E);renderList(n,I,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const L=document.getElementById("mappings-pagination");L&&(L.innerHTML=window.PaginationManager.renderControls())}else renderList(n,E,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});updateMappingsCounter(),c&&updateDataSourceIndicator(c)}return!0}catch(s){Logger.error("UI","Error in fetchAndRenderMappings:",s);let d="Failed to load mappings";return s.status===401||s.message&&s.message.includes("401")?d="Authorization error: Please check your credentials":s.status===403||s.message&&s.message.includes("403")?d="Access forbidden: Check your permissions":s.status===404||s.message&&s.message.includes("404")?d="Server endpoint not found":s.message&&s.message.includes("timeout")?d="Request timeout: Server not responding":s.message&&(d=`Failed to load mappings: ${s.message}`),NotificationManager.error(d),o.classList.add("hidden"),a.classList.remove("hidden"),n.style.display="none",!1}finally{if(window.MappingsStore?.metadata){window.MappingsStore.metadata.isRendering=!1;const s=window.MappingsStore.metadata.pendingRenderRequest;if(s&&!t?._queuedRender){window.MappingsStore.metadata.pendingRenderRequest=null;const d=()=>{window.fetchAndRenderMappings(s.mappingsToRender,s.options)};typeof requestAnimationFrame=="function"?requestAnimationFrame(d):setTimeout(d,0)}else window.MappingsStore.metadata.pendingFilterRender&&(window.MappingsStore.metadata.pendingFilterRender=!1,window.FilterManager&&typeof window.FilterManager.applyMappingFilters=="function"&&window.FilterManager.applyMappingFilters())}}},window.refreshMappingsFromCache=async(e="cache")=>{try{if(!window.MappingsStore)return Logger.warn("CACHE","MappingsStore not available"),!1;const n=window.MappingsStore.getAll().filter(o=>!isImockCacheMapping(o));window.MappingsStore.setFromServer(n),typeof refreshMappingTabSnapshot=="function"&&refreshMappingTabSnapshot(),typeof rebuildMappingIndex=="function"&&rebuildMappingIndex(n),typeof pruneOptimisticShadowMappings=="function"&&pruneOptimisticShadowMappings(n),typeof updateDataSourceIndicator=="function"&&updateDataSourceIndicator(e||"cache");const a=window.MappingsStore?window.MappingsStore.getAll():[];return await fetchAndRenderMappings(a,{source:e||"cache"})}catch(t){return Logger.warn("CACHE","refreshMappingsFromCache failed:",t),!1}},window.initMappingPagination=function(){if(!window.PaginationManager){Logger.warn("UI","PaginationManager not available");return}window.PaginationManager.init("#mappings-pagination",20),window.PaginationManager.attachListeners(e=>{Logger.debug("UI",`Page changed to: ${e}`);const t=document.getElementById(SELECTORS.LISTS.MAPPINGS),n=window.MappingsStore?window.MappingsStore.getAll():[];if(!t||!Array.isArray(n)){Logger.warn("UI","Cannot render page: container or data not available");return}const a=typeof window.sortMappingsForDisplay=="function"?window.sortMappingsForDisplay(n):[...n],o=window.PaginationManager.getCurrentPageItems(a);window.invalidateElementCache(SELECTORS.LISTS.MAPPINGS),renderList(t,o,{renderItem:window.renderMappingMarkup,getKey:window.getMappingRenderKey,getSignature:window.getMappingRenderSignature,onItemChanged:handleMappingItemChanged,onItemRemoved:handleMappingItemRemoved});const r=document.getElementById("mappings-pagination");r&&(r.innerHTML=window.PaginationManager.renderControls());const c=document.getElementById("mappings-page");c&&c.scrollIntoView({behavior:"smooth",block:"start"})}),Logger.info("UI","Mapping pagination initialized")},window.getMappingById=async e=>{try{if(!e)throw new Error("Mapping ID is required");Logger.debug("CACHE",`Fetching mapping with ID: ${e}`),Logger.debug("CACHE","Current wiremockBaseUrl:",window.wiremockBaseUrl);const t=window.MappingsStore?window.MappingsStore.getAll():[];Logger.debug("CACHE","MappingsStore available:",!!window.MappingsStore),Logger.debug("CACHE","Cache size:",t?.length||0);let n=window.MappingsStore?window.MappingsStore.get(e):null;if(n||(n=t.find(r=>r.id===e||r.uuid===e)||null),n)return Logger.cache(`Found mapping in cache: ${e}`,n),n;Logger.cache("Mapping not found in cache, will fetch from API"),Logger.api(`Making API call to: /mappings/${e}`);const a=await apiFetch(`/mappings/${e}`);Logger.api("Raw API response:",a);const o=a&&typeof a=="object"&&a.mapping?a.mapping:a;if(Logger.debug("CACHE","Processed mapping:",o),!o||typeof o!="object")throw Logger.error("CACHE",`API returned invalid data for mapping ${e}`),new Error(`Mapping with ID ${e} not found or invalid response`);return Logger.info("CACHE",`Successfully fetched mapping: ${e}`,o),addMappingToIndex(o),o}catch(t){throw Logger.error("CACHE",`Error fetching mapping ${e}:`,t),Logger.error("CACHE","Error details:",{message:t.message,status:t.status,statusText:t.statusText,url:`${window.wiremockBaseUrl}/mappings/${e}`}),t}},window.duplicateMapping=async e=>{const t=(e??"").toString().trim();if(!t){NotificationManager.error("Invalid mapping identifier");return}if(!window.TemplateManager?.createMappingsFromPayloads){NotificationManager.error("Mapping duplication is not available");return}try{const n=await window.getMappingById(t);if(!n)throw new Error("Mapping not found");await window.TemplateManager.createMappingsFromPayloads([n],{openMode:"inline",source:"duplicate",successMessageFactory:a=>`Duplicated ${a} mapping${a===1?"":"s"}`})}catch(n){Logger.error("OPTIMISTIC","Failed to duplicate mapping:",n),NotificationManager.error(`Failed to duplicate mapping: ${n.message}`)}},window.applyOptimisticMappingUpdate=e=>{try{if(!e){Logger.warn("OPTIMISTIC","No mapping data provided");return}const t=e.mapping||e,n=t?.id||t?.uuid;if(!t||!n){Logger.warn("OPTIMISTIC","Invalid mapping data - missing id:",t);return}if(isImockCacheMapping(t)){Logger.debug("OPTIMISTIC","Skipping cache mapping update");return}const a=window.MappingsStore&&window.MappingsStore.items instanceof Map,o=a&&window.MappingsStore.items.has(n)?"update":"create";if(rememberOptimisticShadowMapping(t,o),typeof updateOptimisticCache=="function")updateOptimisticCache(t,o,{queueMode:"add"});else{if(a){try{window.MappingsStore.addPending({id:n,type:o,payload:t,optimisticMapping:t})}catch(c){Logger.warn("OPTIMISTIC","Failed to enqueue optimistic update:",c)}const r=cloneMappingForCache(t);if(!r)Logger.warn("OPTIMISTIC","Failed to clone mapping for store:",n);else{if(!r.id&&n&&(r.id=n),!r.uuid&&(t.uuid||n)&&(r.uuid=t.uuid||n),window.MappingsStore.items.has(n)){const c=mergeMappingData(window.MappingsStore.items.get(n),r);window.MappingsStore.items.set(n,c)}else window.MappingsStore.items.set(n,r);typeof window.MappingsStore.rebuildIndexes=="function"&&window.MappingsStore.rebuildIndexes()}}window.cacheLastUpdate=Date.now(),window.MappingsStore.metadata.isOptimisticUpdate||(window.MappingsStore.metadata.isOptimisticUpdate=!0,setTimeout(()=>{window.MappingsStore.metadata.isOptimisticUpdate=!1},1e3)),refreshMappingsFromCache()}Logger.debug("OPTIMISTIC","Applied update for mapping:",n)}catch(t){Logger.warn("OPTIMISTIC","Update failed:",t)}},window.backgroundRefreshMappings=async(e=!1)=>{try{if(!window.MappingsStore){Logger.warn("CACHE","MappingsStore not available for background refresh");return}let t,n="direct";if(e){const r=await loadImockCacheBestOf3();r&&r.data&&Array.isArray(r.data.mappings)?(t=r.data,n="cache"):(t=await fetchMappingsFromServer({force:!0}),n="direct")}else t=await fetchMappingsFromServer({force:!0}),n="direct";let a=t.mappings||[];a=applyOptimisticShadowMappings(a);try{if(window.pendingDeletedIds instanceof Set&&window.pendingDeletedIds.size>0){const r=a.length;a=a.filter(c=>{if(!c||typeof c!="object")return!0;const s=c.id||c.uuid;return!window.pendingDeletedIds.has(s)}),r!==a.length&&Logger.cache("background refresh filtered pending-deleted mappings:",r-a.length)}}catch(r){Logger.warn("CACHE","Failed to filter pending deletions during background refresh:",r)}const o=Array.isArray(a)?a.filter(r=>!isImockCacheMapping(r)):[];window.MappingsStore&&window.MappingsStore.setFromServer(o),refreshMappingTabSnapshot(),syncCacheWithMappings(o),rebuildMappingIndex(o),pruneOptimisticShadowMappings(o),updateDataSourceIndicator(n),setTimeout(()=>{const r=window.MappingsStore?window.MappingsStore.getAll():[];fetchAndRenderMappings(r)},0)}catch(t){Logger.warn("CACHE","Background refresh failed:",t)}},window.renderMappingCard=function(e){if(!e||!e.id)return Logger.warn("CACHE","Invalid mapping data:",e),"";const t=[{class:"secondary",handler:"duplicateMapping",title:"Duplicate",icon:"clipboard"},{class:"secondary",handler:"editMapping",title:"Edit in Editor",icon:"open-external"},{class:"primary",handler:"openEditModal",title:"Edit",icon:"pencil"},{class:"danger",handler:"deleteMapping",title:"Delete",icon:"trash"}],n=String(e.id||e.uuid||""),a=window.mappingPreviewState instanceof Set&&window.mappingPreviewState.has(n),o={id:e.id,method:e.request?.method||"GET",url:e.request?.urlPath||e.request?.urlPathPattern||e.request?.urlPattern||e.request?.url||"N/A",status:e.response?.status||200,name:e.name||e.metadata?.name||`Mapping ${e.id.substring(0,8)}`,expanded:a,extras:{preview:a?UIComponents.createPreviewSection(`${Icons.render("request-in",{className:"icon-inline"})} Request`,{Method:e.request?.method||"GET",URL:e.request?.url||e.request?.urlPattern||e.request?.urlPath||e.request?.urlPathPattern,Headers:e.request?.headers,Body:e.request?.bodyPatterns||e.request?.body,"Query Parameters":e.request?.queryParameters})+UIComponents.createPreviewSection(`${Icons.render("response-out",{className:"icon-inline"})} Response`,{Status:e.response?.status,Headers:e.response?.headers,Body:e.response?.jsonBody||e.response?.body,Delay:e.response?.fixedDelayMilliseconds?`${e.response.fixedDelayMilliseconds}ms`:null})+UIComponents.createPreviewSection(`${Icons.render("info",{className:"icon-inline"})} Overview`,{ID:e.id||e.uuid,Name:e.name||e.metadata?.name,Priority:e.priority,Persistent:e.persistent,Scenario:e.scenarioName,"Required State":e.requiredScenarioState,"New State":e.newScenarioState,Created:window.showMetaTimestamps!==!1&&e.metadata?.created?new Date(e.metadata.created).toLocaleString():null,Edited:window.showMetaTimestamps!==!1&&e.metadata?.edited?new Date(e.metadata.edited).toLocaleString():null,Source:e.metadata?.source?`Edited from ${e.metadata.source}`:null}):"",badges:[e.id||e.uuid?`<span class="badge badge-secondary" title="Mapping ID">${Utils.escapeHtml((e.id||e.uuid).length>12?(e.id||e.uuid).slice(0,8)+"\u2026"+(e.id||e.uuid).slice(-4):e.id||e.uuid)}</span>`:"",typeof e.priority=="number"?`<span class="badge badge-secondary" title="Priority">P${e.priority}</span>`:"",e.scenarioName?`<span class="badge badge-secondary" title="Scenario">${Utils.escapeHtml(e.scenarioName)}</span>`:"",window.showMetaTimestamps!==!1&&e.metadata?.created?`<span class="badge badge-secondary" title="Created">C: ${new Date(e.metadata.created).toLocaleString()}</span>`:"",window.showMetaTimestamps!==!1&&e.metadata?.edited?`<span class="badge badge-secondary" title="Edited">E: ${new Date(e.metadata.edited).toLocaleString()}</span>`:"",e.metadata?.source?`<span class="badge badge-info" title="Last edited from">${e.metadata.source.toUpperCase()}</span>`:""].filter(Boolean).join(" ")}};return UIComponents.createCard("mapping",o,t)},window.updateMappingsCounter=function(){const e=document.getElementById(SELECTORS.COUNTERS.MAPPINGS);if(e){const t=window.MappingsStore?window.MappingsStore.getAll():[];e.textContent=Array.isArray(t)?t.length:0}};function updateDataSourceIndicator(e){const t=document.getElementById("data-source-indicator");if(!t)return;let n="Source: direct",a="badge badge-secondary";switch(e){case"cache":n="Source: cache",a="badge badge-success";break;case"cache_rebuilding":n="Source: cache (rebuilding\u2026)",a="badge badge-success";break;case"synced":n="Source: synced",a="badge badge-success";break;case"demo":n="Source: demo data",a="badge badge-info";break;case"custom":n="Source: custom",a="badge badge-secondary";break;case"remote":n="Source: remote",a="badge badge-warning";break;case"remote_error":n="Source: remote (error/CORS)",a="badge badge-danger";break;default:n="Source: direct",a="badge badge-secondary"}t.textContent=n,t.className=a}function updateRequestsSourceIndicator(e){const t=document.getElementById("requests-source-indicator");if(!t)return;let n="Requests: direct",a="badge badge-secondary";switch(e){case"custom":n="Requests: custom",a="badge badge-secondary";break;case"demo":n="Requests: demo data",a="badge badge-info";break;case"remote":n="Requests: remote",a="badge badge-warning";break;case"remote_error":n="Requests: remote (error/CORS)",a="badge badge-danger";break;default:n="Requests: direct",a="badge badge-secondary"}t.textContent=n,t.className=a}function handleMappingItemChanged(e,t){const n=String(e||"");if(!(window.mappingPreviewState instanceof Set)||!window.mappingPreviewState.has(n))return;if(window.mappingPreviewToastState instanceof Map){const o=Date.now(),r=window.mappingPreviewToastState.get(n)||0;if(o-r<4e3)return;window.mappingPreviewToastState.set(n,o)}const a=t?.name||t?.metadata?.name||n;window.NotificationManager&&typeof window.NotificationManager.info=="function"&&window.NotificationManager.info(`Mapping "${a}" refreshed with latest data.`)}function handleMappingItemRemoved(e){const t=String(e||"");window.mappingPreviewState instanceof Set&&window.mappingPreviewState.delete(t),window.mappingPreviewToastState instanceof Map&&window.mappingPreviewToastState.delete(t),isOptimisticShadowMap(window.optimisticShadowMappings)&&window.optimisticShadowMappings.delete(t)}window.toggleMappingDetails=e=>UIComponents.toggleDetails(e,"mapping"),window.toggleRequestDetails=e=>UIComponents.toggleDetails(e,"request"),window.UIComponents=UIComponents,window.updateDataSourceIndicator=updateDataSourceIndicator,window.updateRequestsSourceIndicator=updateRequestsSourceIndicator;class PaginationManager{constructor(){this.itemsPerPage=20,this.currentPage=1,this.totalItems=0,this.totalPages=1,this.containerSelector=null}init(t,n=20){this.containerSelector=t,this.itemsPerPage=n,this.currentPage=1,Logger.info("PAGINATION","Pagination initialized:",{itemsPerPage:n,containerSelector:t})}updateState(t){this.totalItems=t,this.totalPages=Math.ceil(t/this.itemsPerPage),this.currentPage>this.totalPages&&(this.currentPage=1),Logger.debug("PAGINATION","Pagination state updated:",{totalItems:t,totalPages:this.totalPages,currentPage:this.currentPage,itemsPerPage:this.itemsPerPage})}getCurrentPageItems(t){if(!Array.isArray(t))return[];const n=(this.currentPage-1)*this.itemsPerPage,a=n+this.itemsPerPage;return t.slice(n,a)}goToPage(t){return t<1||t>this.totalPages?(Logger.warn("PAGINATION","Invalid page number:",t),!1):(this.currentPage=t,Logger.debug("PAGINATION",`Navigated to page ${t}/${this.totalPages}`),!0)}nextPage(){return this.currentPage<this.totalPages?(this.currentPage++,!0):!1}prevPage(){return this.currentPage>1?(this.currentPage--,!0):!1}renderControls(){if(this.totalPages<=1)return"";const t=(this.currentPage-1)*this.itemsPerPage+1,n=Math.min(this.currentPage*this.itemsPerPage,this.totalItems),a=this.generatePageNumbers();return`
            <div class="pagination-controls">
                <div class="pagination-info">
                    Showing ${t}-${n} of ${this.totalItems}
                </div>
                <div class="pagination-buttons">
                    <button class="pagination-btn"
                            data-action="prev-page"
                            ${this.currentPage===1?"disabled":""}
                            title="Previous page">
                        \u2039
                    </button>
                    ${a.map(o=>o==="..."?'<span class="pagination-ellipsis">...</span>':`<button class="pagination-btn ${o===this.currentPage?"active":""}"
                                        data-action="goto-page"
                                        data-page="${o}"
                                        ${o===this.currentPage?"disabled":""}>${o}</button>`).join("")}
                    <button class="pagination-btn"
                            data-action="next-page"
                            ${this.currentPage===this.totalPages?"disabled":""}
                            title="Next page">
                        \u203A
                    </button>
                </div>
            </div>
        `}generatePageNumbers(){const t=[];if(this.totalPages<=7)for(let a=1;a<=this.totalPages;a++)t.push(a);else{t.push(1);const a=Math.max(2,this.currentPage-2),o=Math.min(this.totalPages-1,this.currentPage+2);a>2&&t.push("...");for(let r=a;r<=o;r++)t.push(r);o<this.totalPages-1&&t.push("..."),t.push(this.totalPages)}return t}attachListeners(t){if(!this.containerSelector){Logger.warn("PAGINATION","Pagination container not set");return}const n=document.querySelector(this.containerSelector);if(!n){Logger.warn("PAGINATION","Pagination container not found:",this.containerSelector);return}n.addEventListener("click",a=>{const o=a.target.closest("[data-action]");if(!o)return;const r=o.dataset.action;let c=!1;if(r==="prev-page")c=this.prevPage();else if(r==="next-page")c=this.nextPage();else if(r==="goto-page"){const s=parseInt(o.dataset.page,10);c=this.goToPage(s)}c&&typeof t=="function"&&t(this.currentPage)}),Logger.info("PAGINATION","Pagination event listeners attached")}}window.PaginationManager=new PaginationManager,Logger.info("PAGINATION","Pagination module loaded");class EventDelegationManager{constructor(){this.initialized=!1,this.handlers=new Map,this.debounceTimers=new Map}debounce(t,n,a=100){this.debounceTimers.has(t)&&clearTimeout(this.debounceTimers.get(t));const o=setTimeout(()=>{n(),this.debounceTimers.delete(t)},a);this.debounceTimers.set(t,o)}init(){if(this.initialized){Logger.debug("EVENTS","EventDelegation already initialized");return}const t=document.getElementById(SELECTORS.LISTS.MAPPINGS);t&&(t.addEventListener("click",a=>this.handleMappingClick(a)),Logger.info("EVENTS","Event delegation initialized for mappings"));const n=document.getElementById(SELECTORS.LISTS.REQUESTS);n&&(n.addEventListener("click",a=>this.handleRequestClick(a)),Logger.info("EVENTS","Event delegation initialized for requests")),this.initialized=!0}handleMappingClick(t){const n=t.target.closest('[data-action="edit-mapping"]');if(n){t.stopPropagation();const d=n.dataset.mappingId;d&&typeof window.openEditModal=="function"&&window.openEditModal(d);return}const a=t.target.closest('[data-action="edit-external"]');if(a){t.stopPropagation();const d=a.dataset.mappingId;d&&typeof window.editMapping=="function"&&window.editMapping(d);return}const o=t.target.closest('[data-action="duplicate-mapping"]');if(o){t.stopPropagation();const d=o.dataset.mappingId;d&&typeof window.duplicateMapping=="function"&&window.duplicateMapping(d);return}const r=t.target.closest('[data-action="delete-mapping"]');if(r){t.stopPropagation();const d=r.dataset.mappingId;d&&typeof window.deleteMapping=="function"&&window.deleteMapping(d);return}const c=t.target.closest('[data-action="show-full-content"]');if(c){t.stopPropagation();const d=c.dataset.targetId;d&&typeof window.toggleFullContent=="function"&&window.toggleFullContent(d);return}if(t.target.closest(".mapping-actions, .request-actions")){t.stopPropagation();return}if(t.target.closest('[data-action="toggle-details"]')){const d=t.target.closest(".mapping-card");if(!d)return;const g=d.dataset.id;if(!g)return;this.handleToggleDetails(g,"mapping",d);return}}handleRequestClick(t){if(t.target.closest('[data-action="toggle-details"]')){const o=t.target.closest(".request-card");if(!o)return;const r=o.dataset.id;if(!r)return;this.handleToggleDetails(r,"request",o);return}const a=t.target.closest('[data-action="view-request"]');if(a){const o=a.dataset.requestId;o&&typeof window.viewRequestDetails=="function"&&window.viewRequestDetails(o);return}}handleToggleDetails(t,n,a){const o=`toggle-${n}-${t}`;this.debounce(o,()=>{const r=document.getElementById(`preview-${t}`),c=document.getElementById(`arrow-${t}`);if(!r)return;const s=r.style.display==="none";r.style.display=s?"block":"none",c&&(c.textContent=s?"\u25BC":"\u25B6"),a.classList.toggle("is-expanded",s),s&&!a.dataset.previewLoaded&&r.innerHTML.trim()===""&&setTimeout(()=>{this.loadPreviewContent(t,n,a,r),a.dataset.previewLoaded="true"},0),n==="mapping"&&window.mappingPreviewState instanceof Set&&(s?window.mappingPreviewState.add(String(t)):window.mappingPreviewState.delete(String(t))),typeof window.UIComponents?.setCardState=="function"&&window.UIComponents.setCardState(n,t,"is-expanded",s)},50)}loadPreviewContent(t,n,a,o){const r=`preview-${n}-${t}`;this.debounce(r,()=>{const c=performance.now();try{if(n==="mapping"){const s=window.MappingsStore.get(t)||window.mappingIndex?.get(t);if(!s){o.innerHTML='<div class="preview-section"><p>Mapping data not found</p></div>';return}const d=this.generateMappingPreview(s);o.innerHTML=d;const g=performance.now()-c;Logger.debug("EVENTS",`Lazy loaded preview for mapping: ${t} (${Math.round(g)}ms)`),g>100&&Logger.warn("EVENTS",`Slow preview load for mapping: ${t} (${Math.round(g)}ms)`)}else if(n==="request"){const s=window.allRequests?.find(E=>(E.id||E.requestId||E.request?.id)===t);if(!s){o.innerHTML='<div class="preview-section"><p>Request data not found</p></div>';return}const d=this.generateRequestPreview(s);o.innerHTML=d;const g=performance.now()-c;Logger.debug("EVENTS",`Lazy loaded preview for request: ${t} (${Math.round(g)}ms)`),g>100&&Logger.warn("EVENTS",`Slow preview load for request: ${t} (${Math.round(g)}ms)`)}}catch(s){Logger.error("EVENTS",`Failed to load preview for ${n} ${t}:`,s),o.innerHTML='<div class="preview-section"><p>Error loading preview</p></div>'}},50)}generateMappingPreview(t){if(typeof window.UIComponents?.createPreviewSection!="function")return'<div class="preview-section"><p>Preview generator not available</p></div>';const n=[],a=this._createSimplePreviewSection("Request",{Method:t.request?.method||"GET",URL:t.request?.url||t.request?.urlPattern||t.request?.urlPath||t.request?.urlPathPattern,Headers:t.request?.headers,Body:t.request?.bodyPatterns||t.request?.body,"Query Parameters":t.request?.queryParameters}),o=this._createSimplePreviewSection("Response",{Status:t.response?.status,Headers:t.response?.headers,Body:t.response?.jsonBody||t.response?.body,Delay:t.response?.fixedDelayMilliseconds?`${t.response.fixedDelayMilliseconds}ms`:null}),r=this._createSimplePreviewSection("Overview",{ID:t.id||t.uuid,Name:t.name||t.metadata?.name,Priority:t.priority,Persistent:t.persistent,Scenario:t.scenarioName,"Required State":t.requiredScenarioState,"New State":t.newScenarioState,Created:window.showMetaTimestamps!==!1&&t.metadata?.created?new Date(t.metadata.created).toLocaleString():null,Edited:window.showMetaTimestamps!==!1&&t.metadata?.edited?new Date(t.metadata.edited).toLocaleString():null,Source:t.metadata?.source?`Edited from ${t.metadata.source}`:null});return`${a}${o}${r}`}_createSimplePreviewSection(t,n){const a=Object.entries(n).filter(([r,c])=>c!=null);if(a.length===0)return"";const o=a.map(([r,c])=>{if(!c)return"";if(typeof c=="object"){const s=JSON.stringify(c);if(s.length>500){const d=s.substring(0,200)+"...";return`<div class="preview-value"><strong>${r}:</strong> <pre>${this._escapeHtml(d)}</pre></div>`}else return`<div class="preview-value"><strong>${r}:</strong> <pre>${this._escapeHtml(s)}</pre></div>`}else{const s=this._escapeHtml(String(c)),d=s.includes(`
`)?`<pre>${s}</pre>`:s;return`<div class="preview-value"><strong>${r}:</strong> ${d}</div>`}}).join("");return`<div class="preview-section"><h4>${t}</h4>${o}</div>`}_escapeHtml(t){return typeof t!="string"?String(t):t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}generateRequestPreview(t){if(typeof window.UIComponents?.createPreviewSection!="function")return'<div class="preview-section"><p>Preview generator not available</p></div>';const n=t.request||{},a=t.responseDefinition||{},o=[];return o.push(window.UIComponents.createPreviewSection("Request Details",{Method:n.method,URL:n.url,Headers:n.headers,Body:n.body,"Logged At":n.loggedDate?new Date(n.loggedDate).toLocaleString():null})),o.push(window.UIComponents.createPreviewSection("Response Details",{Status:a.status,Headers:a.headers,Body:a.body||a.jsonBody,Matched:t.wasMatched?"Yes":"No","Mapping ID":t.stubMapping?.id||t.stubMapping?.uuid})),o.join("")}destroy(){this.initialized=!1,Logger.info("EVENTS","Event delegation destroyed")}}const eventDelegation=new EventDelegationManager;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{eventDelegation.init()}):eventDelegation.init(),window.EventDelegation=eventDelegation,Logger.info("EVENTS","Event delegation module loaded"),window.fetchAndRenderRequests=async(e=null,t={})=>{const n=document.getElementById(SELECTORS.LISTS.REQUESTS),a=document.getElementById(SELECTORS.EMPTY.REQUESTS),o=document.getElementById(SELECTORS.LOADING.REQUESTS);if(!n||!a||!o)return Logger.error("REQUESTS","Required DOM elements not found for requests rendering"),!1;try{let r="direct";if(e===null){o.classList.remove("hidden"),n.style.display="none",a.classList.add("hidden");let c;try{c=await apiFetch(ENDPOINTS.REQUESTS)}catch(d){const g=d?.message||"",E=/^HTTP\s+404\b/.test(g),b=d?.name==="SyntaxError"||/Unexpected end of JSON input/i.test(g);if(E||b)Logger.warn("REQUESTS","Requests endpoint returned no payload; treating as empty list.",d),c={requests:[],__source:"empty"};else throw window.demoModeLastError=d,d}if(c&&c.__source){r=c.__source,r==="demo"&&markDemoModeActive("requests-fallback");try{delete c.__source}catch{}}(!c||typeof c!="object")&&(c={requests:[]});const s=Array.isArray(c.requests)?c.requests:[];window.originalRequests=s,refreshRequestTabSnapshot(),window.allRequests=[...s]}else{const c=t?.source;window.allRequests=Array.isArray(e)?[...e]:[],window.originalRequests=[...window.allRequests],refreshRequestTabSnapshot(),r=c||"custom",r==="demo"&&markDemoModeActive("manual-requests")}return o.classList.add("hidden"),window.allRequests.length===0?(a.classList.remove("hidden"),n.style.display="none",updateRequestsCounter(),!0):(a.classList.add("hidden"),n.style.display="block",window.invalidateElementCache(SELECTORS.LISTS.REQUESTS),renderList(n,window.allRequests,{renderItem:window.renderRequestMarkup,getKey:window.getRequestRenderKey,getSignature:window.getRequestRenderSignature}),updateRequestsCounter(),typeof updateRequestsSourceIndicator=="function"&&updateRequestsSourceIndicator(r),Logger.info("REQUESTS",`Requests render from: ${r} \u2014 ${window.allRequests.length} items`),!0)}catch(r){return Logger.error("REQUESTS","Error in fetchAndRenderRequests:",r),NotificationManager.error(`Failed to load requests: ${r.message}`),o.classList.add("hidden"),a.classList.remove("hidden"),n.style.display="none",!1}},window.renderRequestCard=function(e){if(!e)return Logger.warn("REQUESTS","Invalid request data:",e),"";const t=e.wasMatched!==!1,n=e.request?.clientIp||"Unknown",a={id:e.id||"",method:e.request?.method||"GET",url:e.request?.url||e.request?.urlPath||"N/A",status:e.responseDefinition?.status||(t?200:404),time:`${Utils.parseRequestTime(e.request.loggedDate)} <span class="request-ip">IP: ${Utils.escapeHtml(n)}</span>`,extras:{badges:`
                ${t?`<span class="badge badge-success">${Icons.render("check-circle",{className:"badge-icon"})}<span>Matched</span></span>`:`<span class="badge badge-danger">${Icons.render("x-circle",{className:"badge-icon"})}<span>Unmatched</span></span>`}
            `,preview:UIComponents.createPreviewSection(`${Icons.render("request-in",{className:"icon-inline"})} Request`,{Method:e.request?.method,URL:e.request?.url||e.request?.urlPath,"Client IP":n,Headers:e.request?.headers,Body:e.request?.body})+UIComponents.createPreviewSection(`${Icons.render("response-out",{className:"icon-inline"})} Response`,{Status:e.responseDefinition?.status,Matched:t?"Yes":"No",Headers:e.responseDefinition?.headers,Body:e.responseDefinition?.jsonBody||e.responseDefinition?.body})}};return UIComponents.createCard("request",a,[])};function updateRequestsCounter(){const e=document.getElementById(SELECTORS.COUNTERS.REQUESTS);e&&(e.textContent=Array.isArray(window.allRequests)?window.allRequests.length:0),updateRequestTabCounts()}window.updateRequestsCounter=updateRequestsCounter;function updateRequestTabCounts(){const e=window.requestTabTotals||computeRequestTabTotals(window.originalRequests),t={all:document.getElementById("requests-tab-all"),matched:document.getElementById("requests-tab-matched"),unmatched:document.getElementById("requests-tab-unmatched")};Object.entries(t).forEach(([n,a])=>{a&&(a.textContent=e?.[n]??0)})}function setActiveFilterTab(e){if(!e)return;const t=e.dataset.filterGroup;t&&document.querySelectorAll(`.filter-tab[data-filter-group="${t}"]`).forEach(n=>{n.classList.toggle("active",n===e)})}window.syncFilterTabsFromSelect=function(t,n){const a=(n||"").toString().toLowerCase(),o=document.querySelectorAll(`.filter-tab[data-filter-group="${t}"]`);let r=!1;o.forEach(c=>{const s=(c.dataset.filterValue||"").toLowerCase();s===a||!s&&!a?(c.classList.add("active"),r=!0):c.classList.remove("active")}),!r&&o.length>0&&o[0].classList.add("active")},window.handleRequestTabClick=(e,t)=>{setActiveFilterTab(e);const n=document.getElementById("req-filter-status");n&&(n.value=t||"",typeof applyRequestFilters=="function"&&applyRequestFilters())},window.initializeFilterTabs=()=>{const e=document.getElementById("filter-method");e&&(e.addEventListener("change",()=>{syncFilterTabsFromSelect("mapping",e.value)}),syncFilterTabsFromSelect("mapping",e.value));const t=document.getElementById("req-filter-status");t&&(t.addEventListener("change",()=>{syncFilterTabsFromSelect("requests",t.value)}),syncFilterTabsFromSelect("requests",t.value)),updateRequestTabCounts()},window.openEditModal=async e=>{const n=(o=>typeof o=="string"?o.trim():o==null?"":String(o).trim())(e);if(!n){NotificationManager.show("Invalid mapping identifier",NotificationManager.TYPES.ERROR);return}if(typeof UIComponents?.clearCardState=="function"&&UIComponents.clearCardState("mapping","is-editing"),n&&typeof UIComponents?.setCardState=="function"&&UIComponents.setCardState("mapping",n,"is-editing",!0),typeof window.showModal=="function")window.showModal("edit-mapping-modal");else{Logger.warn("REQUESTS","showModal function not found");return}typeof window.setMappingEditorBusyState=="function"&&window.setMappingEditorBusyState(!0,"Loading\u2026");const a=document.getElementById(SELECTORS.MODAL.TITLE);a&&(a.textContent="Edit Mapping"),Logger.debug("REQUESTS","openEditModal called for mapping identifier:",e);try{const o=await apiFetch(`/mappings/${encodeURIComponent(n)}`),r=o?.mapping||o;if(!r||!r.id)throw new Error("Invalid mapping response from server");if(Logger.debug("REQUESTS","Loaded mapping from server:",r),typeof window.populateEditMappingForm=="function")window.populateEditMappingForm(r);else{Logger.error("REQUESTS","populateEditMappingForm function not found!");return}addMappingToIndex(r),Logger.debug("REQUESTS","openEditModal completed successfully")}catch(o){Logger.error("REQUESTS","Failed to load mapping:",o),NotificationManager.show("Failed to load mapping: "+o.message,NotificationManager.TYPES.ERROR),typeof window.hideModal=="function"&&window.hideModal("edit-mapping-modal")}finally{typeof window.setMappingEditorBusyState=="function"&&window.setMappingEditorBusyState(!1)}},window.deleteMapping=async e=>{if(confirm("Delete this mapping?"))try{await apiFetch(`/mappings/${e}`,{method:"DELETE"}),NotificationManager.success("Mapping deleted!"),removeMappingFromIndex(e),updateOptimisticCache({id:e},"delete")}catch(t){t.message.includes("404")?(Logger.info("REQUESTS","Mapping already deleted from server (404), updating cache locally"),removeMappingFromIndex(e),updateOptimisticCache({id:e},"delete"),NotificationManager.success("Mapping was already deleted")):NotificationManager.error(`Delete failed: ${t.message}`)}},window.clearRequests=async()=>{if(confirm("Clear all requests?"))try{await apiFetch("/requests",{method:"DELETE"}),NotificationManager.success("Requests cleared!"),await fetchAndRenderRequests()}catch(e){NotificationManager.error(`Clear failed: ${e.message}`)}},(function(){if(window.ScenarioModel)return;const t=s=>{if(typeof s!="string")return"";const d=s.trim();if(!d)return"";if(!/%[0-9a-fA-F]{2}/.test(d))return d;try{return decodeURIComponent(d)}catch(g){return Logger.warn("SCENARIOS","safeDecode failed, returning original value",{value:s,error:g}),d}},n=s=>{if(typeof s!="string")return"";let d=s.trim();if(!d)return"";if(/^https?:\/\//i.test(d))try{d=new URL(d).pathname}catch(E){Logger.warn("SCENARIOS","normalizeScenarioLink failed to parse absolute URL",{link:s,error:E})}const g="/__admin";return d.startsWith(g)&&(d=d.slice(g.length)||"/"),d=d.replace(/^\/+/,""),d?`/${d}`:""},a=(s,d)=>{if(!s||typeof s!="object")return null;const g=typeof s.id=="string"?s.id:"",E=typeof s.name=="string"?s.name:"",b=t(g),S=t(E),I=b||S||g||E||"",L=S||b||E||g||`Scenario ${d+1}`,B=t(s.state)||s.state||"Started",M=Array.isArray(s.possibleStates)?s.possibleStates.map(Q=>t(Q)||Q).filter(Boolean):[],w=Array.isArray(s.mappings)?s.mappings.map(Q=>!Q||typeof Q!="object"?Q:{...Q,requiredScenarioState:t(Q.requiredScenarioState)||Q.requiredScenarioState||"",newScenarioState:t(Q.newScenarioState)||Q.newScenarioState||""}):[],D=n(s.stateEndpoint||s?._links?.["update-state"]?.href||s?._links?.updateState?.href||s?._links?.state?.href),O=n(s.resetEndpoint||s?._links?.["reset-state"]?.href||s?._links?.resetState?.href||s?._links?.reset?.href);return{...s,id:I||b||g,name:L,displayName:L,identifier:I,originalId:g,originalName:E||S,decodedId:b,decodedName:S,state:B,possibleStates:M,mappings:w,stateEndpoint:D,resetEndpoint:O}},o=s=>Array.isArray(s)?s.map((d,g)=>a(d,g)).filter(Boolean):[],r=s=>typeof s!="string"?"":s.trim().toLowerCase(),c=(s,d)=>d?!s||typeof s!="object"?!1:[s.displayName,s.name,s.identifier,s.id,s.state,s.description].filter(b=>typeof b=="string"&&b.trim()).map(b=>b.toLowerCase()).some(b=>b.includes(d))?!0:(Array.isArray(s.mappings)?s.mappings:[]).some(b=>!b||typeof b!="object"?!1:[b.name,b.id,b.uuid,b.stubId,b.stubMappingId,b.requiredScenarioState,b.newScenarioState,b.request?.method,b.request?.url,b.request?.urlPattern,b.request?.urlPath,b.request?.urlPathPattern].filter(I=>typeof I=="string"&&I.trim()).map(I=>I.toLowerCase()).some(I=>I.includes(d))):!0;window.ScenarioModel={safeDecode:t,normalizeScenarioLink:n,normalizeScenario:a,normalizeScenarioList:o,normalizeSearchTerm:r,scenarioMatchesSearch:c}})(),Array.isArray(window.allScenarios)||(window.allScenarios=[]);let allScenarios=window.allScenarios,scenarioListHandlerAttached=!1;(!window.scenarioExpansionState||typeof window.scenarioExpansionState!="object")&&(window.scenarioExpansionState={});let scenarioExpansionState=window.scenarioExpansionState;(!window.scenarioUiState||typeof window.scenarioUiState!="object")&&(window.scenarioUiState={});const scenarioUiState=window.scenarioUiState;typeof scenarioUiState.searchTerm!="string"&&(scenarioUiState.searchTerm=""),scenarioUiState.selected instanceof Set||(scenarioUiState.selected=new Set),typeof scenarioUiState.bulkMenuOpen!="boolean"&&(scenarioUiState.bulkMenuOpen=!1),Array.isArray(scenarioUiState.lastVisibleSelectable)||(scenarioUiState.lastVisibleSelectable=[]);let scenarioToolbarHandlersAttached=!1;function renderIcon(e,t={}){return typeof window.Icons?.render=="function"?window.Icons.render(e,t):""}function downloadFile(e,t,n){const a=new Blob([t],{type:n}),o=URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(o),0)}function safeDecode(e){return window.ScenarioModel&&typeof window.ScenarioModel.safeDecode=="function"?window.ScenarioModel.safeDecode(e):typeof e=="string"?e.trim():""}function normalizeScenarioLink(e){return window.ScenarioModel&&typeof window.ScenarioModel.normalizeScenarioLink=="function"?window.ScenarioModel.normalizeScenarioLink(e):""}function normalizeScenario(e,t){return window.ScenarioModel&&typeof window.ScenarioModel.normalizeScenario=="function"?window.ScenarioModel.normalizeScenario(e,t):e||null}function normalizeScenarioList(e){return window.ScenarioModel&&typeof window.ScenarioModel.normalizeScenarioList=="function"?window.ScenarioModel.normalizeScenarioList(e):Array.isArray(e)?e.filter(Boolean):[]}function getScenarioByIdentifier(e){if(typeof e!="string")return null;const t=e.trim();return t&&(Array.isArray(allScenarios)?allScenarios:[]).find(a=>[a?.identifier,a?.id,a?.name,a?.decodedId,a?.decodedName,a?.originalId,a?.originalName].some(r=>typeof r!="string"?!1:r.trim()===t))||null}function resolveScenarioTarget(e){const t=typeof e=="string"?e.trim():"",n=t?getScenarioByIdentifier(t):null,a=n?.identifier||n?.decodedId||n?.decodedName||t,o=safeDecode(a)||a,r=n?.displayName||n?.decodedName||n?.name||n?.decodedId||n?.id||safeDecode(t)||t,c=typeof n?.stateEndpoint=="string"?n.stateEndpoint:"",s=typeof n?.resetEndpoint=="string"?n.resetEndpoint:"",d=typeof window.buildScenarioStateEndpoint=="function"?window.buildScenarioStateEndpoint:S=>`${ENDPOINTS.SCENARIOS}/${encodeURIComponent(S)}/state`,g=c||(o?d(o):"");return{rawCandidate:t,targetScenario:n,endpointIdentifier:o,displayName:r,stateEndpoint:g,resetEndpoint:s||g,resetMethod:s?"POST":"PUT"}}function setScenariosLoading(e){const t=document.getElementById("scenarios-loading");if(t&&t.classList.toggle("hidden",!e),e){const n=document.getElementById(SELECTORS.LISTS.SCENARIOS);n&&(n.style.display="none")}}window.loadScenarios=async()=>{const e=document.getElementById("scenarios-empty");e&&e.classList.add("hidden"),setScenariosLoading(!0);try{const t=await apiFetch(ENDPOINTS.SCENARIOS),n=Array.isArray(t?.scenarios)?t.scenarios:[];allScenarios=normalizeScenarioList(n),window.allScenarios=allScenarios}catch(t){allScenarios=[],window.allScenarios=allScenarios,Logger.error("SCENARIOS","Load scenarios error:",t),NotificationManager.error(`Failed to load scenarios: ${t.message}`)}finally{setScenariosLoading(!1),renderScenarios()}},window.refreshScenarios=async()=>{await TabManager.refresh("scenarios")},window.resetAllScenarios=async()=>{if(confirm("Reset all scenarios to the initial state?")){setScenariosLoading(!0);try{await apiFetch(ENDPOINTS.SCENARIOS_RESET,{method:"POST"}),NotificationManager.success("All scenarios have been reset!"),await loadScenarios()}catch(e){NotificationManager.error(`Scenario reset failed: ${e.message}`),setScenariosLoading(!1)}}};function updateScenarioStateSuggestions(e){const t=document.getElementById("scenario-state-options"),n=document.getElementById("scenario-state");if(!t)return;const a=Array.isArray(allScenarios)?allScenarios:[],o=getScenarioByIdentifier(e),r=new Set,c=g=>{if(typeof g!="string")return;const E=g.trim();E&&r.add(E)};c("Started");const s=g=>{g&&(c(g.state),(g.possibleStates||[]).forEach(c),(g.mappings||[]).forEach(E=>{c(E?.requiredScenarioState),c(E?.newScenarioState)}))};o&&s(o),r.size===0&&a.forEach(s);const d=Array.from(r).sort((g,E)=>g.localeCompare(E));t.innerHTML=d.map(g=>`
        <option value="${escapeHtml(g)}"></option>
    `).join(""),n&&(d.length>0?n.setAttribute("placeholder",`Enter state (e.g. ${d[0]})`):n.setAttribute("placeholder","Enter state name"))}window.setScenarioState=async(e,t,n={})=>{const a=document.getElementById("scenario-select"),o=document.getElementById("scenario-state"),r=typeof e=="string"?e:"",c=typeof t=="string"?t.trim():"",s=n&&typeof n=="object"?n:{},d=s.refresh!==!1,g=s.silent===!0,E=s.manageLoading!==!1,b=s.syncForm!==!1;let S=r;!S&&a&&(S=a.value||"");const I=resolveScenarioTarget(S),L=I.endpointIdentifier,B=I.displayName,M=c||o?.value?.trim()||"";if(!L||!L.trim()||!M)return g||NotificationManager.warning("Please select scenario and enter state"),!1;const w=I.stateEndpoint;if(!w)return g||NotificationManager.error("Unable to determine the scenario state endpoint."),!1;if(I.targetScenario&&Array.isArray(I.targetScenario.possibleStates)&&I.targetScenario.possibleStates.length===0)return g||NotificationManager.warning(`Scenario "${B}" does not expose any states to switch to.`),!1;if(b)if(a){const O=I.targetScenario?.identifier||I.targetScenario?.decodedId||I.targetScenario?.decodedName||L;a.value=O,updateScenarioStateSuggestions(O)}else updateScenarioStateSuggestions(L);E&&setScenariosLoading(!0);const D=!!I.targetScenario;try{return await apiFetch(w,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:M})}),g||NotificationManager.success(`Scenario "${B}" switched to state "${M}"`),b&&!c&&o&&(o.value=""),b&&updateScenarioStateSuggestions(L),d?await loadScenarios():E&&setScenariosLoading(!1),!0}catch(O){Logger.error("SCENARIOS","Change scenario state error:",O);const Q=/HTTP\s+404/.test(O?.message||""),de=/does not support state/i.test(O?.message||"");return g||(Q&&!D?NotificationManager.error(`Scenario "${B}" was not found on the server.`):de?NotificationManager.error(`Scenario "${B}" does not allow state changes.`):NotificationManager.error(`Scenario state change failed: ${O.message}`)),E&&setScenariosLoading(!1),!1}};async function resetScenarioState(e,t={}){const n=t&&typeof t=="object"?t:{},a=n.refresh!==!1,o=n.silent===!0,r=n.manageLoading!==!1;if(typeof e!="string"||!e.trim())return o||NotificationManager.warning("Unable to determine which scenario to reset."),!1;const c=resolveScenarioTarget(e),s=c.resetEndpoint,d=c.resetMethod,g=c.displayName;if(!s)return o||NotificationManager.error("Unable to determine the scenario reset endpoint."),!1;r&&setScenariosLoading(!0);try{return await apiFetch(s,{method:d}),o||NotificationManager.success(`Scenario "${g}" has been reset to its initial state.`),a?await loadScenarios():r&&setScenariosLoading(!1),!0}catch(E){if(d==="PUT"&&c.stateEndpoint)try{return await apiFetch(c.stateEndpoint,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:"Started"})}),o||NotificationManager.success(`Scenario "${g}" has been reset to its initial state.`),a?await loadScenarios():r&&setScenariosLoading(!1),!0}catch(b){return Logger.error("SCENARIOS","Reset scenario state error:",b),o||NotificationManager.error(`Scenario reset failed: ${b.message}`),r&&setScenariosLoading(!1),!1}return Logger.error("SCENARIOS","Reset scenario state error:",E),o||NotificationManager.error(`Scenario reset failed: ${E.message}`),r&&setScenariosLoading(!1),!1}}function normalizeSearchTerm(e){return window.ScenarioModel&&typeof window.ScenarioModel.normalizeSearchTerm=="function"?window.ScenarioModel.normalizeSearchTerm(e):""}function scenarioMatchesSearch(e,t){return window.ScenarioModel&&typeof window.ScenarioModel.scenarioMatchesSearch=="function"?window.ScenarioModel.scenarioMatchesSearch(e,t):!0}function setScenarioBulkMenuOpen(e){scenarioUiState.bulkMenuOpen=!!e;const t=document.getElementById("scenario-bulk-menu");t&&(t.classList.toggle("is-open",scenarioUiState.bulkMenuOpen),t.setAttribute("aria-hidden",scenarioUiState.bulkMenuOpen?"false":"true"))}function updateScenarioHeaderUI(e,t){const n=document.getElementById("scenario-stats");if(n){const g=Array.isArray(e)?e.reduce((b,S)=>b+(Array.isArray(S?.mappings)?S.mappings.length:0),0):0,E=Array.isArray(e)?e.length:0;n.textContent=`${E}/${t} scenarios \u2022 ${g} mappings`}const a=document.getElementById("scenario-select-all-row"),o=document.getElementById("scenario-select-all-btn"),r=Array.isArray(e)?e.map(g=>{const E=typeof g?.identifier=="string"?g.identifier:typeof g?.decodedId=="string"?g.decodedId:typeof g?.id=="string"?g.id:"";return(typeof E=="string"?E.trim():"")||""}).filter(Boolean):[];scenarioUiState.lastVisibleSelectable=r;const c=scenarioUiState.selected instanceof Set?scenarioUiState.selected.size:0,s=document.getElementById("scenario-bulk-wrap"),d=document.getElementById("scenario-bulk-count");if(d&&(d.textContent=String(c)),s&&s.classList.toggle("is-hidden",c===0),a&&(a.style.display=r.length>0?"":"none"),o){const g=r.length>0&&r.every(E=>scenarioUiState.selected.has(E));o.classList.toggle("is-selected",g),o.setAttribute("aria-checked",g?"true":"false")}c===0&&scenarioUiState.bulkMenuOpen&&setScenarioBulkMenuOpen(!1)}async function bulkResetSelectedScenarios(){const e=scenarioUiState.selected instanceof Set?Array.from(scenarioUiState.selected):[];if(e.length===0||!confirm(`Reset ${e.length} selected scenarios to their initial state?`))return;setScenarioBulkMenuOpen(!1),setScenariosLoading(!0);const t=[];for(const n of e)try{const a=resolveScenarioTarget(n);if(!a.resetEndpoint){t.push({id:n,name:a.displayName||n,error:"No reset endpoint resolved"});continue}try{await apiFetch(a.resetEndpoint,{method:a.resetMethod})}catch(o){if(a.resetMethod==="PUT"&&a.stateEndpoint)await apiFetch(a.stateEndpoint,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:"Started"})});else throw o}}catch(a){t.push({id:n,name:n,error:a?.message||String(a)})}if(t.length>0){scenarioUiState.selected=new Set(t.map(a=>a.id).filter(Boolean));const n=t.slice(0,3).map(a=>a.name||a.id).join(", ");NotificationManager.warning(`Bulk reset: ${t.length} failed${n?` (e.g. ${n})`:""}.`)}else scenarioUiState.selected.clear(),NotificationManager.success("Bulk reset complete.");await loadScenarios()}async function bulkSetScenarioState(){const e=scenarioUiState.selected instanceof Set?Array.from(scenarioUiState.selected):[];if(e.length===0)return;const t=e.length===1&&getScenarioByIdentifier(e[0])?.state||"Started",n=prompt(`Set state for ${e.length} selected scenarios:`,t);if(!n||!n.trim())return;setScenarioBulkMenuOpen(!1),setScenariosLoading(!0);const a=[],o=n.trim();for(const r of e)try{const c=resolveScenarioTarget(r);if(!c.stateEndpoint){a.push({id:r,name:c.displayName||r,error:"No state endpoint resolved"});continue}await apiFetch(c.stateEndpoint,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:o})})}catch(c){a.push({id:r,name:r,error:c?.message||String(c)})}if(a.length>0){scenarioUiState.selected=new Set(a.map(c=>c.id).filter(Boolean));const r=a.slice(0,3).map(c=>c.name||c.id).join(", ");NotificationManager.warning(`Bulk state update: ${a.length} failed${r?` (e.g. ${r})`:""}.`)}else scenarioUiState.selected.clear(),NotificationManager.success(`Bulk state updated: "${o}"`);await loadScenarios()}async function fetchFullMappingById(e){const t=(e??"").toString().trim();if(!t)return null;if(typeof window.getMappingById=="function")try{const r=await window.getMappingById(t);if(r&&typeof r=="object")return r}catch(r){Logger.warn("SCENARIOS","getMappingById failed, falling back to direct fetch",{mappingId:t,error:r})}const n=`/mappings/${encodeURIComponent(t)}`,a=await apiFetch(n),o=a&&typeof a=="object"&&a.mapping?a.mapping:a;return o&&typeof o=="object"?o:null}async function bulkExportSelectedMappings(){const e=scenarioUiState.selected instanceof Set?Array.from(scenarioUiState.selected):[];if(e.length===0)return;setScenarioBulkMenuOpen(!1);const t=[],n=new Set;if(e.forEach(s=>{const d=getScenarioByIdentifier(s);(Array.isArray(d?.mappings)?d.mappings:[]).forEach(E=>{const b=(E?.id||E?.uuid||E?.stubMappingId||E?.stubId||E?.mappingId||"").toString().trim();!b||n.has(b)||(n.add(b),t.push(b))})}),t.length===0){NotificationManager.warning("No mappings found for selected scenarios.");return}setScenariosLoading(!0);const a=[],o=[];for(const s of t)try{const d=await fetchFullMappingById(s);if(!d){o.push({id:s,error:"Empty mapping payload"});continue}a.push(d)}catch(d){o.push({id:s,error:d?.message||String(d)})}const c=`wiremock-mappings-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;if(downloadFile(c,`${JSON.stringify({mappings:a},null,2)}
`,"application/json"),o.length>0){const s=o.slice(0,3).map(d=>d.id).join(", ");NotificationManager.warning(`Exported ${a.length}/${t.length} mapping(s). Failed: ${o.length}${s?` (e.g. ${s})`:""}.`)}else NotificationManager.success(`Exported ${a.length} mapping(s).`);setScenariosLoading(!1)}function clearScenarioSelection(){scenarioUiState.selected instanceof Set&&scenarioUiState.selected.clear(),setScenarioBulkMenuOpen(!1),renderScenarios()}function toggleSelectAllVisibleScenarios(){const e=Array.isArray(scenarioUiState.lastVisibleSelectable)?scenarioUiState.lastVisibleSelectable:[];scenarioUiState.selected instanceof Set||(scenarioUiState.selected=new Set),e.length>0&&e.every(n=>scenarioUiState.selected.has(n))?e.forEach(n=>scenarioUiState.selected.delete(n)):e.forEach(n=>scenarioUiState.selected.add(n)),renderScenarios()}window.renderScenarios=()=>{const e=document.getElementById(SELECTORS.LISTS.SCENARIOS),t=document.getElementById("scenarios-empty"),n=document.getElementById("scenarios-count"),a=document.getElementById("scenario-select"),o=document.getElementById("scenario-state-options"),r=document.getElementById("scenario-search"),c=document.getElementById("scenario-bulk-btn"),s=document.getElementById("scenario-bulk-reset"),d=document.getElementById("scenario-bulk-set-state"),g=document.getElementById("scenario-bulk-export"),E=document.getElementById("scenario-bulk-clear"),b=document.getElementById("scenario-select-all-btn");if(!e)return;n&&(n.textContent=Array.isArray(allScenarios)?allScenarios.length:0);const S=Array.isArray(allScenarios)?allScenarios:[];if(S.length===0){e.innerHTML="",e.style.display="none",t&&t.classList.remove("hidden"),a&&(a.innerHTML='<option value="">Select Scenario</option>'),o&&(o.innerHTML=""),updateScenarioStateSuggestions(""),updateScenarioHeaderUI([],0);return}if(t&&t.classList.add("hidden"),scenarioUiState.selected instanceof Set&&scenarioUiState.selected.size>0){const M=new Set(S.map(w=>{const D=typeof w?.identifier=="string"?w.identifier:typeof w?.decodedId=="string"?w.decodedId:typeof w?.id=="string"?w.id:"";return typeof D=="string"?D.trim():""}).filter(Boolean));for(const w of Array.from(scenarioUiState.selected))M.has(w)||scenarioUiState.selected.delete(w)}r&&(r.value||"")!==scenarioUiState.searchTerm&&(r.value=scenarioUiState.searchTerm),scenarioToolbarHandlersAttached||(r&&r.addEventListener("input",M=>{scenarioUiState.searchTerm=typeof M.target?.value=="string"?M.target.value:"",renderScenarios()}),c&&c.addEventListener("click",M=>{M.stopPropagation(),setScenarioBulkMenuOpen(!scenarioUiState.bulkMenuOpen)}),s&&s.addEventListener("click",()=>{bulkResetSelectedScenarios()}),d&&d.addEventListener("click",()=>{bulkSetScenarioState()}),g&&g.addEventListener("click",()=>{bulkExportSelectedMappings()}),E&&E.addEventListener("click",clearScenarioSelection),b&&b.addEventListener("click",toggleSelectAllVisibleScenarios),document.addEventListener("click",M=>{const w=document.getElementById("scenario-bulk-wrap");w&&scenarioUiState.bulkMenuOpen&&(typeof w.contains=="function"&&w.contains(M.target)||setScenarioBulkMenuOpen(!1))}),document.addEventListener("keydown",M=>{scenarioUiState.bulkMenuOpen&&M.key==="Escape"&&setScenarioBulkMenuOpen(!1)}),scenarioToolbarHandlersAttached=!0);const I=a?.value||"";if(a){const M=['<option value="">Select Scenario</option>'].concat(S.map(w=>{const D=typeof w?.identifier=="string"?w.identifier:typeof w?.decodedId=="string"?w.decodedId:typeof w?.id=="string"?w.id:"",O=typeof w?.displayName=="string"?w.displayName:typeof w?.name=="string"?w.name:typeof w?.decodedName=="string"?w.decodedName:"Unnamed scenario";return`
                <option value="${escapeHtml(D)}">${escapeHtml(O)}</option>
            `}));if(a.innerHTML=M.join(""),I){const w=getScenarioByIdentifier(I);w&&(a.value=w.identifier||w.decodedId||w.decodedName||w.id||w.name||"")}}o&&updateScenarioStateSuggestions(a?.value||I||""),a&&!a.dataset.scenarioHandlerAttached&&(a.addEventListener("change",M=>{updateScenarioStateSuggestions(M.target.value)}),a.dataset.scenarioHandlerAttached="1"),e.style.display="";const L=normalizeSearchTerm(scenarioUiState.searchTerm),B=S.filter(M=>scenarioMatchesSearch(M,L));if(B.length===0){if(e.innerHTML="",e.style.display="none",t){t.classList.remove("hidden");const M=typeof t.querySelector=="function"?t.querySelector("h3"):null,w=typeof t.querySelector=="function"?t.querySelector("p"):null;M&&(M.textContent="No scenarios match your filter"),w&&(w.textContent="Try clearing the filter or searching by mapping URL/state.")}updateScenarioHeaderUI([],S.length);return}if(t){const M=typeof t.querySelector=="function"?t.querySelector("h3"):null,w=typeof t.querySelector=="function"?t.querySelector("p"):null;M&&(M.textContent="No scenarios found"),w&&(w.textContent="Create mappings with scenarios to manage state here."),t.classList.add("hidden")}updateScenarioHeaderUI(B,S.length),e.innerHTML=B.map((M,w)=>{const D=typeof M?.identifier=="string"?M.identifier:typeof M?.decodedId=="string"?M.decodedId:typeof M?.id=="string"?M.id:"",O=escapeHtml(D),Q=typeof M?.displayName=="string"?M.displayName:typeof M?.name=="string"?M.name:typeof M?.decodedName=="string"?M.decodedName:"Unnamed scenario",de=escapeHtml(Q),se=escapeHtml(M.state||"Started"),be=Array.isArray(M.possibleStates)?M.possibleStates.filter(Boolean):[],Ne=D||M?.decodedId||M?.decodedName||M?.id||M?.name||`scenario-${w}`,U=typeof Ne=="string"&&Ne.trim()?Ne.trim():`scenario-${w}`,H=scenarioExpansionState[U]===!0,P=escapeHtml(U),y=typeof D=="string"&&D.trim().length>0,N=y?D.trim():"",$=N&&scenarioUiState.selected instanceof Set?scenarioUiState.selected.has(N):!1,G=y?`
            <button
                type="button"
                class="scenario-select-btn${$?" is-selected":""}"
                data-scenario-action="select"
                data-scenario="${O}"
                role="checkbox"
                aria-checked="${$?"true":"false"}"
                aria-label="Select scenario ${de}"
                title="Select"
            >
                <span class="scenario-select-box" aria-hidden="true"></span>
            </button>
        `:`
            <span style="width:18px;height:18px;display:inline-block;"></span>
        `,fe=new Set,Pe=[],et=ae=>{if(typeof ae!="string")return;const Me=ae.trim();!Me||fe.has(Me)||(fe.add(Me),Pe.push(Me))};et(M.state||""),be.forEach(et);const Oe=Pe.map(ae=>{const Me=escapeHtml(ae),je=ae===M.state,Fe="scenario-state-pill";return je?`<span class="${Fe} is-active" data-current="true">${Me}</span>`:y?`
                <button
                    type="button"
                    class="${Fe}"
                    data-scenario-action="transition"
                    data-scenario="${O}"
                    data-state="${Me}"
                >
                    ${Me}
                </button>
            `:`<span class="${Fe}">${Me}</span>`}).join(""),Ge=y?`
            <button
                type="button"
                class="scenario-reset-btn"
                data-scenario-action="reset"
                data-scenario="${O}"
            >
                ${renderIcon("refresh",{className:"icon-inline"})} Reset
            </button>
        `:"",tt=Oe||Ge?`
            <div class="scenario-summary-controls">
                <div class="scenario-state-pill-list">${Oe}</div>
                ${Ge}
            </div>
        `:"",St=M.description?`
            <div class="scenario-info">
                <div class="scenario-description">${escapeHtml(M.description)}</div>
            </div>
        `:"",Je=Array.isArray(M.mappings)?M.mappings:[],Et=Je.length?`
            <ul class="scenario-mapping-list">
                ${Je.map(ae=>{const Me=ae?.id||ae?.uuid||ae?.stubMappingId||ae?.stubId||ae?.mappingId||"",je=Me?escapeHtml(Me):"",Fe=escapeHtml(ae?.name||Me||"Unnamed mapping"),Ye=ae?.request?.method||ae?.method||ae?.requestMethod||"",Ve=ae?.request?.urlPattern||ae?.request?.urlPath||ae?.request?.url||ae?.url||ae?.requestUrl||"",We=Ye?`<span class="scenario-mapping-method">${escapeHtml(Ye)}</span>`:"",Ie=Ve?`<span class="scenario-mapping-url">${escapeHtml(Ve)}</span>`:"",qe=We||Ie?`
                        <div class="scenario-mapping-meta">
                            ${[We,Ie].filter(Boolean).join(" \xB7 ")}
                        </div>
                    `:"",Se=ae?.requiredScenarioState||ae?.requiredState||"",He=ae?.newScenarioState||ae?.newState||"",mt=[Se?`<span class="badge badge-warning" title="Required scenario state">Requires: ${escapeHtml(Se)}</span>`:"",He?`<span class="badge badge-info" title="Next scenario state">\u2192 ${escapeHtml(He)}</span>`:""].filter(Boolean).join(" "),st=mt?`
                        <div class="scenario-mapping-states">${mt}</div>
                    `:"",ct=renderIcon("pencil",{className:"action-icon"}),lt=renderIcon("clipboard",{className:"action-icon"}),dt=renderIcon("trash",{className:"action-icon"}),ke=Me?`
                        <div class="scenario-mapping-actions">
                            <button
                                class="btn btn-sm btn-secondary"
                                data-scenario-action="edit-mapping"
                                data-mapping-id="${je}"
                                title="Edit mapping"
                            >
                                ${ct||""}<span>Edit</span>
                            </button>
                            <button
                                class="btn btn-sm btn-secondary"
                                data-scenario-action="duplicate-mapping"
                                data-mapping-id="${je}"
                                title="Duplicate mapping"
                            >
                                ${lt||""}<span>Duplicate</span>
                            </button>
                            <button
                                class="btn btn-sm btn-danger"
                                data-scenario-action="delete-mapping"
                                data-mapping-id="${je}"
                                title="Delete mapping"
                            >
                                ${dt||""}<span>Delete</span>
                            </button>
                        </div>
                    `:"";return`
                        <li class="scenario-mapping-item">
                            <div class="scenario-mapping-name">${Fe}</div>
                            ${qe}
                            ${st}
                            ${ke}
                        </li>
                    `}).join("")}
            </ul>
        `:`
            <div class="scenario-mapping-empty">No stub mappings are bound to this scenario yet.</div>
        `,Be=`<span class="collapse-arrow" aria-hidden="true">${H?"\u25BC":"\u25B6"}</span>`,nt=`${H?"Collapse":"Expand"} scenario ${Q}`;return`
            <div class="scenario-item ${H?"expanded":"collapsed"}${$?" is-selected":""}" data-scenario="${O}" data-scenario-key="${P}">
                <div class="scenario-summary">
                    ${G}
                    <button
                        type="button"
                        class="scenario-toggle-btn"
                        data-scenario-action="toggle"
                        data-scenario-key="${P}"
                        aria-expanded="${H?"true":"false"}"
                        aria-label="${escapeHtml(nt)}"
                    >
                        ${Be}
                    </button>
                    <div class="scenario-summary-main">
                        <div class="scenario-summary-header">
                            <div class="scenario-name">${de}</div>
                            <div class="scenario-state">State: ${se}</div>
                        </div>
                        ${tt}
                    </div>
                </div>
                <div class="scenario-body">
                    ${St}
                    <div class="scenario-mappings">
                        <div class="scenario-section-title">Stub mappings</div>
                        ${Et}
                    </div>
                </div>
            </div>
        `}).join(""),scenarioListHandlerAttached||(e.addEventListener("click",async M=>{const w=M.target.closest("[data-scenario-action]");if(!w||typeof e.contains=="function"&&!e.contains(w))return;const D=w.dataset.scenarioAction;if(D==="toggle"){M.preventDefault();const O=w.dataset.scenarioKey||w.dataset.scenario||"";if(!O.trim())return;const Q=scenarioExpansionState[O]===!0;scenarioExpansionState[O]=!Q,renderScenarios()}else if(D==="select"){M.preventDefault();const O=w.dataset.scenario||"",Q=typeof O=="string"?O.trim():"";if(!Q)return;scenarioUiState.selected instanceof Set||(scenarioUiState.selected=new Set),scenarioUiState.selected.has(Q)?scenarioUiState.selected.delete(Q):scenarioUiState.selected.add(Q),renderScenarios()}else if(D==="transition"){const O=w.dataset.scenario||"",Q=w.dataset.state||"";if(!O.trim()||!Q.trim())return;w.disabled=!0;try{await setScenarioState(O,Q)}finally{w.disabled=!1}}else if(D==="reset"){const O=w.dataset.scenario||"";if(!O.trim())return;w.disabled=!0;try{await resetScenarioState(O)}finally{w.disabled=!1}}else if(D==="edit-mapping"){const O=w.dataset.mappingId;O&&typeof window.openEditModal=="function"&&window.openEditModal(O)}else if(D==="duplicate-mapping"){const O=w.dataset.mappingId;if(O&&typeof window.duplicateMapping=="function"){w.disabled=!0;try{await window.duplicateMapping(O),await loadScenarios()}finally{w.disabled=!1}}}else if(D==="delete-mapping"){const O=w.dataset.mappingId;if(O&&typeof window.deleteMapping=="function"){w.disabled=!0;try{await window.deleteMapping(O),await loadScenarios()}finally{w.disabled=!1}}}}),scenarioListHandlerAttached=!0)},window.startRecording=async(e={})=>{try{const n={...{targetBaseUrl:"https://example.com",filters:{urlPathPatterns:[".*"],method:"ANY",headers:{}},captureHeaders:{},requestBodyPattern:{},persist:!0,repeatsAsScenarios:!1,transformers:["response-template"],transformerParameters:{}},...e};await apiFetch(ENDPOINTS.RECORDINGS_START,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),NotificationManager.success("Recording started!"),window.isRecording=!0;const a=document.getElementById(SELECTORS.RECORDING.INDICATOR);a&&(a.style.display="block")}catch(t){Logger.error("RECORDING","Start recording error:",t),NotificationManager.error(`Failed to start recording: ${t.message}`)}},window.stopRecording=async()=>{try{const e=await apiFetch(ENDPOINTS.RECORDINGS_STOP,{method:"POST"});window.isRecording=!1,window.recordedCount=0;const t=document.getElementById(SELECTORS.RECORDING.INDICATOR);t&&(t.style.display="none");const n=e.mappings?e.mappings.length:0;NotificationManager.success(`Recording stopped! Captured ${n} mappings`);const a=window.MappingsStore.getAll();return await fetchAndRenderMappings(a),e.mappings||[]}catch(e){return Logger.error("RECORDING","Stop recording error:",e),NotificationManager.error(`Failed to stop recording: ${e.message}`),[]}},window.getRecordingStatus=async()=>{try{return(await apiFetch(ENDPOINTS.RECORDINGS_STATUS)).status||"Unknown"}catch(e){return Logger.error("RECORDING","Recording status error:",e),"Unknown"}},window.takeRecordingSnapshot=async(e={})=>{try{const t=await apiFetch(ENDPOINTS.RECORDINGS_SNAPSHOT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=t.mappings?t.mappings.length:0;return NotificationManager.success(`Snapshot created! Captured ${n} mappings`),t.mappings||[]}catch(t){return Logger.error("RECORDING","Recording snapshot error:",t),NotificationManager.error(`Snapshot failed: ${t.message}`),[]}},window.clearRecordings=async()=>{if(confirm("Clear all recorded requests?"))try{await apiFetch(ENDPOINTS.REQUESTS,{method:"DELETE"}),window.recordedCount=0;const e=document.getElementById("recordings-list");e&&(e.innerHTML=""),typeof fetchAndRenderRequests=="function"&&await fetchAndRenderRequests(),NotificationManager.success("Recording log cleared.")}catch(e){Logger.error("RECORDING","Clear recordings error:",e),NotificationManager.error(`Failed to clear recordings: ${e.message}`)}},window.refreshRequests=async()=>{await fetchAndRenderRequests(),(document.getElementById(SELECTORS.REQUEST_FILTERS.METHOD)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.URL)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.STATUS)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM)?.value||document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO)?.value)&&FilterManager.applyRequestFilters()},window.applyQuickTimeFilter=()=>{const e=new Date,t=new Date(e.getTime()-1440*60*1e3),n=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_FROM),a=document.getElementById(SELECTORS.REQUEST_FILTERS.DATE_TO);n&&(n.value=Utils.formatDateTime(t)),a&&(a.value=Utils.formatDateTime(e)),FilterManager.applyRequestFilters()},window.cleanupPendingDeletions=()=>{for(const[e,t]of window.deletionTimeouts)clearTimeout(t);window.deletionTimeouts.clear(),window.pendingDeletedIds.clear()},window.addEventListener("beforeunload",window.cleanupPendingDeletions),window.toggleElementById=e=>document.getElementById(e)?.classList.toggle("hidden"),window.togglePreview=e=>window.toggleElementById(`preview-${e}`),window.toggleRequestPreview=e=>window.toggleElementById(`request-preview-${e}`),window.getRequestCount=async(e={})=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_COUNT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).count||0}catch(t){return Logger.error("REQUESTS","Request count error:",t),NotificationManager.error(`Request count failed: ${t.message}`),0}},window.findRequests=async e=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_FIND,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).requests||[]}catch(t){return Logger.error("REQUESTS","Find requests error:",t),NotificationManager.error(`Request search failed: ${t.message}`),[]}},window.getUnmatchedRequests=async()=>{try{return(await apiFetch(ENDPOINTS.REQUESTS_UNMATCHED)).requests||[]}catch(e){return Logger.error("REQUESTS","Unmatched requests error:",e),[]}},window.findMappingsByMetadata=async e=>{try{return(await apiFetch(ENDPOINTS.MAPPINGS_FIND_BY_METADATA,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).mappings||[]}catch(t){return Logger.error("METADATA","Find mappings by metadata error:",t),[]}},Logger.info("UI","Features.js loaded - Business functions for mappings, requests, scenarios + WireMock 3.9.1+ API fixes"),window.updateLastSuccessUI=()=>{try{const e=document.getElementById(SELECTORS.CONNECTION.STATUS_TEXT);if(!e)return;const t=window.lastWiremockSuccess||Date.now(),n=new Date(t).toLocaleTimeString();e.textContent=`Last OK: ${n}`,Logger.info("HEALTH","last success UI updated:",{ts:t,time:n})}catch{}},window.applyHealthUI=(e,t)=>{try{window.healthState=window.healthState||{isHealthy:null,lastCheckAt:null,lastOkAt:null,lastLatencyMs:null},window.healthState.lastCheckAt=Date.now(),e===!0?(window.healthState.isHealthy=!0,window.healthState.lastOkAt=Date.now(),window.healthState.lastLatencyMs=typeof t=="number"?t:null):e===!1&&(window.healthState.isHealthy=!1,window.healthState.lastLatencyMs=null);const n=document.getElementById(SELECTORS.HEALTH.INDICATOR);if(n)if(n.style.display="inline",e===!0){const a=typeof t=="number"?`${t}ms`:"OK";n.innerHTML=`<span>Response Time: </span><span class="healthy">${a}</span>`}else e===!1?n.innerHTML='<span>Response Time: </span><span class="unhealthy">Unhealthy</span>':n.innerHTML='<span>Response Time: </span><span class="error">Error</span>';e===!0&&(window.lastWiremockSuccess=Date.now(),typeof window.updateLastSuccessUI=="function"&&window.updateLastSuccessUI())}catch(n){Logger.warn("HEALTH","applyHealthUI failed:",n)}};try{const e=localStorage.getItem("imock-show-meta-timestamps");e!==null&&(window.showMetaTimestamps=e==="1")}catch{}window.toggleMetaTimestamps=()=>{try{window.showMetaTimestamps=window.showMetaTimestamps===!1,localStorage.setItem("imock-show-meta-timestamps",window.showMetaTimestamps?"1":"0");const e=window.MappingsStore.getAll();Array.isArray(e)&&fetchAndRenderMappings(e)}catch(e){Logger.warn("METADATA","toggleMetaTimestamps failed:",e)}};const IMOCK_CACHE_ID="00000000-0000-0000-0000-00000000cace",IMOCK_CACHE_URL="/__imock/cache";function isImockCacheMapping(e){try{const t=(e?.id||e?.uuid)===IMOCK_CACHE_ID,n=e?.metadata?.imock?.type==="cache",a=(e?.name||"").toLowerCase()==="imock cache",o=(e?.request?.url||e?.request?.urlPath)===IMOCK_CACHE_URL;return!!(t||n||a||o)}catch{return!1}}function slimMapping(e){return{id:e.id||e.uuid,name:e.name||e.metadata?.name,priority:e.priority,persistent:e.persistent,scenarioName:e.scenarioName,requiredScenarioState:e.requiredScenarioState,newScenarioState:e.newScenarioState,request:{method:e.request?.method,url:e.request?.urlPath||e.request?.urlPathPattern||e.request?.urlPattern||e.request?.url||"N/A"},response:{status:e.response?.status},metadata:{created:e.metadata?.created,edited:e.metadata?.edited,source:e.metadata?.source}}}function buildSlimList(e){return{mappings:(e||[]).filter(n=>!isImockCacheMapping(n)).map(slimMapping)}}async function getCacheByFixedId(){try{Logger.cache("Trying fixed ID lookup...");const e=await apiFetch(`/mappings/${IMOCK_CACHE_ID}`);if(e&&isImockCacheMapping(e))return e;Logger.cache("Fixed ID miss")}catch(e){e.status===401||e.message&&e.message.includes("401")?Logger.warn("CACHE","Authorization error loading cache by fixed ID - check credentials"):e.status===404||e.message&&e.message.includes("404")?Logger.debug("CACHE","Cache mapping not found by fixed ID (404)"):Logger.debug("CACHE","Error loading cache by fixed ID:",e.message)}return null}async function upsertImockCacheMapping(e){Logger.cache("Upsert cache mapping start");const t=JSON.stringify(e||{});let n=0;for(let c=0;c<t.length;c++)n=n*31+t.charCodeAt(c)|0;const a=(n>>>0).toString(16),o={imock:{type:"cache",version:1,timestamp:Date.now(),count:(e?.mappings||[]).length,hash:a}},r={id:IMOCK_CACHE_ID,name:"iMock Cache",priority:1,persistent:!1,request:{method:"GET",url:IMOCK_CACHE_URL},response:{status:200,jsonBody:e,headers:{"Content-Type":"application/json; charset=utf-8"}},metadata:o};try{Logger.cache("PUT /mappings/{id}");const c=await apiFetch(`/mappings/${IMOCK_CACHE_ID}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});return Logger.cache("Upsert done (PUT)"),c}catch{Logger.cache("PUT failed, POST /mappings");const c=await apiFetch("/mappings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});return Logger.cache("Upsert done (POST)"),c}}async function regenerateImockCache(e=null){Logger.cache("Regenerate cache start");const t=performance.now();let n=e;n||(n=await fetchMappingsFromServer({force:!0}));const a=n?.mappings||[];Logger.cache("Using fresh server data for cache regeneration");const o=buildSlimList(a);let r=o;try{const s=await upsertImockCacheMapping(o),d=extractCacheJsonBody(s);d&&(r=d)}catch(s){Logger.warn("CACHE","Upsert cache failed:",s)}const c=Math.round(performance.now()-t);return Logger.cache(`Regenerate cache done (${(r?.mappings||[]).length} items) in ${c}ms`),r}async function refreshImockCache(){Logger.cache("Refresh cache requested");try{const e=await regenerateImockCache();return typeof window.refreshMappingsFromCache=="function"&&window.refreshMappingsFromCache(),Logger.cache("Refresh cache completed"),e}catch(e){throw Logger.error("CACHE","Refresh cache failed:",e),e}}window.refreshImockCache=refreshImockCache;async function loadImockCacheBestOf3(){Logger.cache("loadImockCacheBestOf3 start (fixed-id only)");const e=await getCacheByFixedId();return e&&e.response?.jsonBody?(Logger.cache("Using cache: fixed id"),{source:"cache",data:e.response.jsonBody}):(Logger.cache("No cache found - will load from server"),null)}function cloneMappingForCache(e){if(!e)return null;try{if(typeof structuredClone=="function")return structuredClone(e)}catch(t){Logger.warn("CACHE","structuredClone failed for mapping cache clone:",t)}try{return JSON.parse(JSON.stringify(e))}catch(t){Logger.warn("CACHE","JSON clone failed for mapping cache clone:",t)}return{...e}}function mergeMappingData(e,t){return e?t?{...e,...t,request:{...e.request,...t.request},response:{...e.response,...t.response},metadata:{...e.metadata,...t.metadata}}:e:t}function syncCacheWithMappings(e){try{const t=window.MappingsStore;if(!t||!(t.items instanceof Map)||!Array.isArray(e))return;const n=t.items,a=new Set;e.forEach(c=>{if(!c||isImockCacheMapping(c))return;const s=c.id||c.uuid;if(!s)return;a.add(s);const d=cloneMappingForCache(c)||{...c};n.has(s)?n.set(s,mergeMappingData(n.get(s),d)):n.set(s,d)});const o=t.pending instanceof Map?Array.from(t.pending.values()):[],r=new Set;for(const c of o)!c||c.type==="delete"||c.id&&r.add(c.id);Array.from(n.keys()).forEach(c=>{!a.has(c)&&!r.has(c)&&n.delete(c)}),window.cacheLastUpdate=Date.now()}catch(t){Logger.warn("CACHE","syncCacheWithMappings failed:",t)}}function extractCacheJsonBody(e){try{if(!e||typeof e!="object")return null;if(e.response?.jsonBody)return e.response.jsonBody;if(e.mapping?.response?.jsonBody)return e.mapping.response.jsonBody;if(e.jsonBody?.mappings||Array.isArray(e.mappings))return{mappings:(Array.isArray(e.jsonBody?.mappings)?e.jsonBody.mappings:Array.isArray(e.mappings)?e.mappings:[]).map(n=>({...n}))}}catch(t){Logger.warn("CACHE","extractCacheJsonBody failed:",t)}return null}(function(t){function n(a={}){const{markDemoModeActive:o,notificationManager:r,fetchAndRenderMappings:c,fetchAndRenderRequests:s,isDatasetAvailable:d,getDataset:g}=a;if(typeof o!="function")throw new Error("Demo loader requires markDemoModeActive callback");if(!r||typeof r=="function")throw new Error("Demo loader requires a notification manager object");if(typeof c!="function")throw new Error("Demo loader requires fetchAndRenderMappings function");if(typeof s!="function")throw new Error("Demo loader requires fetchAndRenderRequests function");const E=r?.success?.bind(r)||r?.info?.bind(r)||(I=>Logger.warn("DEMO",I)),b=r?.error?.bind(r)||r?.warning?.bind(r)||(I=>Logger.warn("DEMO",I)),S=r?.warning?.bind(r)||r?.info?.bind(r)||(I=>Logger.warn("DEMO",I));return async function(){if(!(typeof d=="function"?d():!0))return b("Demo dataset is not available in this build."),{status:"unavailable",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};const B=typeof g=="function"?g():null;if(!B)return b("Unable to load the demo dataset."),{status:"missing",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};const M=Array.isArray(B.mappings)?B.mappings:[],w=Array.isArray(B.requests)?B.requests:[];o("manual-trigger");const[D,O]=await Promise.allSettled([c(M,{source:"demo"}),s(w,{source:"demo"})]),Q=D.status==="fulfilled"?D.value!==!1:!1,de=O.status==="fulfilled"?O.value!==!1:!1,se=[];D.status==="rejected"&&se.push(D.reason),O.status==="rejected"&&se.push(O.reason);const be=Q&&de?"success":Q||de?"partial":"failed";return be==="success"?E("Demo data loaded locally. Explore the interface freely."):(S("Demo data only loaded partially. Check the console for details."),se.length&&b("Some demo data failed to load. Inspect console for details.")),{status:be,mappingsLoaded:Q,requestsLoaded:de,errors:se}}}t.DemoMode={createLoader:n}})(typeof window<"u"?window:globalThis),(function(t){let n=!1;function a(o){if(n)return!0;if(!o)return!1;n=!0;const r=t,c=o,{markDemoModeActive:s,addMappingToIndex:d,rebuildMappingIndex:g,computeMappingTabTotals:E,refreshMappingTabSnapshot:b,computeRequestTabTotals:S,refreshRequestTabSnapshot:I,removeMappingFromIndex:L,fetchMappingsFromServer:B}=c;r.updateUptime=function(){if(!r.startTime)return;const U=Math.floor((Date.now()-r.startTime)/1e3),H=Math.floor(U/3600),P=Math.floor(U%3600/60),y=U%60,N=document.getElementById("uptime");N&&(H>0?N.textContent=`${H}h ${P}m ${y}s`:P>0?N.textContent=`${P}m ${y}s`:N.textContent=`${y}s`)},r.stopUptime=function(){r.uptimeInterval&&(r.LifecycleManager.clearInterval(r.uptimeInterval),r.uptimeInterval=null),r.startTime=null;const U=document.getElementById("uptime");U&&(U.textContent="0s")},r.checkHealth=async()=>{try{const U=document.getElementById("wiremock-host"),H=document.getElementById("wiremock-port");if(U&&H&&(U.value.trim()||H.value.trim())){const P=U.value.trim()||"localhost",y=H.value.trim()||"8080";typeof r.normalizeWiremockBaseUrl=="function"?r.wiremockBaseUrl=r.normalizeWiremockBaseUrl(P,y):r.wiremockBaseUrl=`http://${P}:${y}/__admin`,Logger.info("FEATURES","Updated WireMock URL from form:",r.wiremockBaseUrl)}await checkHealthAndStartUptime(),NotificationManager.success("Health check passed!")}catch(U){NotificationManager.error(`Health check failed: ${U.message}`)}},r.refreshMappings=async()=>{try{const U=typeof r.readWiremockSettings=="function"?r.readWiremockSettings():{},H=isCacheEnabled();await fetchAndRenderMappings(null,{useCache:H})&&NotificationManager.success("Mappings refreshed!")}catch(U){NotificationManager.error(`Failed to refresh mappings: ${U.message}`)}},r.forceRefreshCache=async()=>{try{if(!isCacheEnabled()){NotificationManager.warning("Cache is not enabled. Enable it in Settings first.");return}if(typeof r.refreshImockCache!="function"){NotificationManager.error("Cache service not available");return}const U=document.querySelector('[onclick="forceRefreshCache()"]');U&&(U.classList.add("is-loading"),U.disabled=!0);const H=await r.refreshImockCache();let P=!0;H&&typeof H=="object"&&(H.cacheMessage&&w(SELECTORS.IMPORT.RESULT,"info",H.cacheMessage),typeof H.useCache=="boolean"&&(P=H.useCache)),await fetchAndRenderMappings(null,{useCache:P})&&NotificationManager.success("Cache rebuilt and mappings refreshed!")}catch(U){NotificationManager.error(`Failed to rebuild cache: ${U.message}`)}finally{const U=document.querySelector('[onclick="forceRefreshCache()"]');U&&(U.classList.remove("is-loading"),U.disabled=!1)}};const M=r.DemoMode&&typeof r.DemoMode.createLoader=="function"?r.DemoMode.createLoader({markDemoModeActive:s,notificationManager:NotificationManager,fetchAndRenderMappings,fetchAndRenderRequests,isDatasetAvailable:()=>r.DemoData?.isAvailable?.(),getDataset:()=>r.DemoData?.getDataset?.()}):null;r.loadMockData=async()=>{if(!M)return NotificationManager.error("Demo mode is not available in this build."),{status:"unavailable",mappingsLoaded:!1,requestsLoaded:!1,errors:[]};r.demoModeLastError=null;const U=await M();if(U&&U.status!=="success"){const[H]=Array.isArray(U.errors)?U.errors:[];r.demoModeLastError=H||U.status}return r.demoModeLastResult=U,U},r.updateScenarioState=async()=>{const U=document.getElementById("scenario-select"),H=document.getElementById("scenario-state"),P=document.getElementById("scenario-update-btn");if(!U?.value||!H?.value){NotificationManager.warning("Please select scenario and enter state");return}P&&(P.disabled=!0);try{await r.setScenarioState()}finally{P&&(P.disabled=!1)}},r.updateFileDisplay=()=>{const U=document.getElementById(SELECTORS.IMPORT.FILE),H=document.getElementById(SELECTORS.IMPORT.DISPLAY),P=document.getElementById(SELECTORS.IMPORT.ACTIONS);if(!U||!H){Logger.warn("FEATURES","Import file elements not found.");return}if(U.files?.length>0){const y=U.files[0],N=y.size?` (${Math.round(y.size/1024)} KB)`:"";H.innerHTML=`<strong>${y.name}</strong>${N}`,P&&(P.style.display="block")}else H.innerHTML='<span class="file-placeholder">No file selected</span>',P&&(P.style.display="none")},r.updateRecorderLink=(U,H)=>{try{const P=document.getElementById("recorder-link");if(!P)return;const y=(U||"").trim();if(!y){P.removeAttribute("href"),P.setAttribute("title","Configure host in Settings to enable recorder link"),P.textContent="Recorder UI (configure host first)";return}let N=y;/^https?:\/\//i.test(N)||(N=`http://${N}`);const $=new URL(N);H&&String(H).trim()&&($.port=String(H).trim()),$.pathname="/__admin/recorder/",P.href=$.toString(),P.textContent=$.toString(),P.removeAttribute("title")}catch(P){Logger.warn("FEATURES","Failed to update recorder link:",P)}};function w(U,H,P){const y=document.getElementById(U);if(!y)return;const N=H==="success"?"\u2705":H==="error"?"\u274C":"\u2139\uFE0F";y.textContent=`${N} ${P}`}function D(U,H,P){const y=new Blob([H],{type:P}),N=URL.createObjectURL(y),$=document.createElement("a");$.href=N,$.download=U,document.body.appendChild($),$.click(),document.body.removeChild($),setTimeout(()=>URL.revokeObjectURL(N),0)}function O(){if(r.elementCache?.has(SELECTORS.IMPORT.ACTIONS)){const P=r.elementCache.get(SELECTORS.IMPORT.ACTIONS);if(P){const y=P.querySelector("button");if(y)return y}}const U=document.getElementById(SELECTORS.IMPORT.ACTIONS);if(!U)return null;const H=U.querySelector("button");return H&&r.elementCache&&r.elementCache.set(SELECTORS.IMPORT.ACTIONS,U),H}function Q(U){const H=O();H&&(H.classList.toggle("is-loading",U),H.disabled=U)}function de(U=null){if(U)return U;const H=document.getElementById(SELECTORS.IMPORT.MODE);return H&&H.value||"MERGE"}async function se(){const U=document.getElementById(SELECTORS.IMPORT.FILE);if(!U?.files?.length)throw new Error("Please select a file to import.");const H=U.files[0],P=await H.text(),y=H.name.split(".").pop()?.toLowerCase();if(y==="yaml"||y==="yml"){if(r.jsyaml?.load)return r.jsyaml.load(P);throw new Error("YAML parser is not available.")}try{return JSON.parse(P)}catch{throw new Error("Failed to parse JSON import file.")}}function be(U,H){if(!U||typeof U!="object")throw new Error("Import file is empty or malformed.");const P=JSON.parse(JSON.stringify(U)),y={};if(["meta","globalSettings","requestJournal","importSettings"].forEach(G=>{P&&Object.prototype.hasOwnProperty.call(P,G)&&(y[G]=P[G])}),Array.isArray(P))y.mappings=P;else if(Array.isArray(P.mappings))y.mappings=P.mappings;else if(P.mappings&&typeof P.mappings=="object"){if(Array.isArray(P.mappings.mappings))y.mappings=P.mappings.mappings;else if(Array.isArray(P.mappings.items))y.mappings=P.mappings.items;else{const fe=Object.values(P.mappings).filter(Boolean).filter(Pe=>typeof Pe=="object"&&(Pe.request||Pe.response));fe.length>0&&(y.mappings=fe)}!y.mappings&&(P.mappings.request||P.mappings.response)&&(y.mappings=[P.mappings])}else P.mappings?y.mappings=[P.mappings]:Array.isArray(P.mapping)?y.mappings=P.mapping:P.mapping?y.mappings=[P.mapping]:Array.isArray(P.stubs)?y.mappings=P.stubs:P.stubs&&typeof P.stubs=="object"?y.mappings=Object.values(P.stubs).filter(Boolean):(P.request||P.response)&&(y.mappings=[P]);if(!Array.isArray(y.mappings))throw new Error("No mappings array found in the import file.");if(y.mappings=y.mappings.filter(Boolean),y.mappings.length===0)throw new Error("The import file does not contain any mappings.");Object.keys(P).forEach(G=>{["mappings","mapping","importMode"].includes(G)||Object.prototype.hasOwnProperty.call(y,G)||(y[G]=P[G])});const $=H||P.importMode||"MERGE";return y.importMode=$,y}async function Ne(U=null){try{Q(!0),w(SELECTORS.IMPORT.RESULT,"info","Processing import file...");const H=await se(),P=de(U),y=be(H,P);y.importMode=P,await apiFetch(ENDPOINTS.MAPPINGS_IMPORT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)}),NotificationManager.success(`Imported ${y.mappings.length} mapping(s).`);const N=document.getElementById(SELECTORS.IMPORT.FILE);N&&(N.value="",r.updateFileDisplay());try{typeof r.refreshImockCache=="function"&&await r.refreshImockCache(),await fetchAndRenderMappings(null,{useCache:!1})}catch($){Logger.warn("FEATURES","Failed to refresh mappings after import:",$)}w(SELECTORS.IMPORT.RESULT,"success",`Imported ${y.mappings.length} mapping(s) using mode ${P}.`)}catch(H){throw Logger.error("FEATURES","Import failed:",H),w(SELECTORS.IMPORT.RESULT,"error",H.message||"Import failed."),NotificationManager.error(`Import failed: ${H.message}`),H}finally{Q(!1)}}return r.executeImport=Ne,r.exportMappings=async()=>{const H=document.getElementById(SELECTORS.EXPORT.FORMAT)?.value||"json";w(SELECTORS.EXPORT.RESULT,"info","Preparing mappings export...");try{const y=(await apiFetch(ENDPOINTS.MAPPINGS))?.mappings||[],$=`wiremock-mappings-${new Date().toISOString().replace(/[:.]/g,"-")}`;if(H==="yaml"){if(!r.jsyaml?.dump)throw new Error("YAML serializer is not available.");const G=r.jsyaml.dump({mappings:y},{noRefs:!0});D(`${$}.yaml`,G.endsWith(`
`)?G:`${G}
`,"text/yaml")}else{const G=JSON.stringify({mappings:y},null,2);D(`${$}.json`,`${G}
`,"application/json")}w(SELECTORS.EXPORT.RESULT,"success",`Exported ${y.length} mapping(s) as ${H.toUpperCase()}.`),NotificationManager.success(`Exported ${y.length} mapping(s).`)}catch(P){Logger.error("FEATURES","Export mappings failed:",P),w(SELECTORS.EXPORT.RESULT,"error",P.message||"Failed to export mappings."),NotificationManager.error(`Failed to export mappings: ${P.message}`)}},r.exportRequests=async()=>{const H=document.getElementById(SELECTORS.EXPORT.FORMAT)?.value||"json";w(SELECTORS.EXPORT.RESULT,"info","Preparing request log export...");try{const y=(await apiFetch(ENDPOINTS.REQUESTS))?.requests||[],$=`wiremock-requests-${new Date().toISOString().replace(/[:.]/g,"-")}`;if(H==="yaml"){if(!r.jsyaml?.dump)throw new Error("YAML serializer is not available.");const G=r.jsyaml.dump({requests:y},{noRefs:!0});D(`${$}.yaml`,G.endsWith(`
`)?G:`${G}
`,"text/yaml")}else{const G=JSON.stringify({requests:y},null,2);D(`${$}.json`,`${G}
`,"application/json")}w(SELECTORS.EXPORT.RESULT,"success",`Exported ${y.length} request(s) as ${H.toUpperCase()}.`),NotificationManager.success(`Exported ${y.length} request(s).`)}catch(P){Logger.error("FEATURES","Export requests failed:",P),w(SELECTORS.EXPORT.RESULT,"error",P.message||"Failed to export request log."),NotificationManager.error(`Failed to export request log: ${P.message}`)}},!0}if(!a(t.FeaturesState)){let o=null;const r=c=>{const s=c&&c.detail&&c.detail.state||t.FeaturesState;return a(s)?(typeof t.removeEventListener=="function"&&t.removeEventListener("features:state-ready",r),o!==null&&(t.clearInterval(o),o=null),!0):!1};if(typeof t.addEventListener=="function"&&t.addEventListener("features:state-ready",r),typeof t.setInterval=="function"){let c=0;o=t.setInterval(()=>{c+=1,!r()&&c>=200&&(t.clearInterval(o),o=null,n||Logger.error("FEATURES","features.js could not find FeaturesState after waiting for 10 seconds."))},50)}}})(typeof window<"u"?window:globalThis);let editorState={originalMapping:null,currentMapping:null,isDirty:!1};document.addEventListener("DOMContentLoaded",()=>{setupMappingFormListeners(),setupEditorModeHandlers()});function setupMappingFormListeners(){const e=document.getElementById("edit-mapping-form");e&&e.addEventListener("submit",handleEditMappingSubmit)}function setupEditorModeHandlers(){const e=document.getElementById("open-json-studio-btn");e&&e.addEventListener("click",()=>{const n=editorState.currentMapping?.id;n&&typeof window.editMapping=="function"?(hideModal("edit-mapping-modal"),window.editMapping(n)):NotificationManager.warning("No mapping loaded")}),document.addEventListener("keydown",n=>{const a=document.getElementById("edit-mapping-modal");if(!(!a||a.classList.contains("hidden"))){if((n.ctrlKey||n.metaKey)&&n.key==="s"){n.preventDefault(),updateMapping();return}if((n.ctrlKey||n.metaKey)&&n.key==="Enter"){n.preventDefault(),updateMapping().then(()=>{hideModal("edit-mapping-modal")});return}if(n.key==="Escape"){editorState.isDirty?confirm("You have unsaved changes. Close anyway?")&&hideModal("edit-mapping-modal"):hideModal("edit-mapping-modal");return}}}),document.addEventListener("click",n=>{n.target.matches('[data-action="validate-json"]')&&validateCurrentJSON(),n.target.matches('[data-action="format-json"]')&&formatCurrentJSON(),n.target.matches('[data-action="minify-json"]')&&minifyCurrentJSON()});let t=null;document.addEventListener("input",n=>{if(n.target.id==="json-editor"){const a=!editorState.isDirty;editorState.isDirty=!0,a?updateDirtyIndicator():(t&&clearTimeout(t),t=setTimeout(()=>{updateDirtyIndicator(),t=null},300))}})}function setButtonLoadingState(e,t,n){if(!e)return;const a=e.querySelector(".btn-label");t?(e.classList.add("is-loading"),e.disabled=!0,e.setAttribute("aria-busy","true"),a&&(a.dataset.originalText||(a.dataset.originalText=a.textContent),n&&(a.textContent=n))):(e.classList.remove("is-loading"),e.disabled=!1,e.removeAttribute("aria-busy"),a&&a.dataset.originalText&&(a.textContent=a.dataset.originalText,delete a.dataset.originalText))}window.setMappingEditorBusyState=(e,t)=>{const n=document.getElementById("update-mapping-btn");n&&setButtonLoadingState(n,e,t)};async function handleEditMappingSubmit(e){e.preventDefault(),await updateMapping()}function normalizeScenarioNameInMapping(e){if(!e||typeof e!="object"||!Object.prototype.hasOwnProperty.call(e,"scenarioName"))return;const t=window.Utils?.normalizeScenarioName;if(typeof t!="function")return;const n=t(e.scenarioName);if(!n?.changed||!n?.hadWhitespace)return;n.cleared?(delete e.scenarioName,NotificationManager.warning("Scenario name contained only whitespace and was cleared")):(e.scenarioName=n.normalized,NotificationManager.warning(`Scenario name cannot contain spaces. Replaced with "${n.normalized}"`));const a=document.getElementById("json-editor");if(a)try{a.value=JSON.stringify(e,null,2)}catch{}}window.updateMapping=async()=>{Logger.debug("EDITOR","updateMapping called");try{window.setMappingEditorBusyState(!0,"Updating\u2026"),saveFromJSONMode();const e=editorState.currentMapping,t=e?.id;if(!t){NotificationManager.error("Mapping ID not found");return}if(normalizeScenarioNameInMapping(e),typeof e=="object"&&e){const r=new Date().toISOString();e.metadata||(e.metadata={}),e.metadata.created||(e.metadata.created=r),e.metadata.edited=r,e.metadata.source="ui"}const n=await apiFetch(`/mappings/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),a=n?.mapping||n;NotificationManager.success("Mapping updated!"),a&&updateOptimisticCache(a,"update"),editorState.isDirty=!1,updateDirtyIndicator(),hideModal("edit-mapping-modal"),(document.getElementById(SELECTORS.MAPPING_FILTERS.METHOD)?.value||document.getElementById(SELECTORS.MAPPING_FILTERS.URL)?.value||document.getElementById(SELECTORS.MAPPING_FILTERS.STATUS)?.value)&&FilterManager.applyMappingFilters()}catch(e){Logger.error("EDITOR","Error in updateMapping:",e),NotificationManager.error(`Update failed: ${e.message}`)}finally{window.setMappingEditorBusyState(!1)}},window.populateEditMappingForm=e=>{Logger.debug("EDITOR","populateEditMappingForm called"),Logger.debug("EDITOR","Incoming mapping ID:",e?.id),Logger.debug("EDITOR","Incoming mapping name:",e?.name),editorState.originalMapping=e,editorState.currentMapping=e,editorState.isDirty=!1,updateDirtyIndicator(),Logger.debug("EDITOR","After state update - currentMapping ID:",editorState.currentMapping?.id),Logger.debug("EDITOR","Loading JSON mode for mapping ID:",editorState.currentMapping?.id),loadJSONMode(),Logger.debug("EDITOR","populateEditMappingForm completed for mapping ID:",e?.id)};function saveFromJSONMode(){const e=document.getElementById("json-editor");if(!e)return;const t=e.value.trim();if(t)try{editorState.currentMapping=JSON.parse(t)}catch(n){throw new Error("Invalid JSON: "+n.message)}}function loadJSONMode(){const e=document.getElementById("json-editor");if(!e){Logger.warn("EDITOR","JSON editor element not found!");return}if(!editorState.currentMapping){Logger.warn("EDITOR","No currentMapping in editorState!");return}const t=JSON.stringify(editorState.currentMapping,null,2);e.value=t,Logger.debug("EDITOR","JSON editor populated with mapping ID:",editorState.currentMapping?.id),Logger.debug("EDITOR","JSON content length:",t.length)}function validateCurrentJSON(){const e=document.getElementById("json-editor"),t=document.getElementById("json-validation-result");if(!e||!t)return;const n=e.value;if(!n.trim()){t.innerHTML='<div class="validation-warning">JSON is empty</div>';return}try{JSON.parse(n),t.innerHTML='<div class="validation-success">\u2713 JSON is valid</div>'}catch(a){t.innerHTML=`<div class="validation-error">\u2717 JSON error: ${a.message}</div>`}}function formatCurrentJSON(){const e=document.getElementById("json-editor");if(e)try{const t=JSON.parse(e.value);e.value=JSON.stringify(t,null,2),showNotification("JSON formatted","success")}catch(t){showNotification("Formatting failed: "+t.message,"error")}}function minifyCurrentJSON(){const e=document.getElementById("json-editor");if(e)try{const t=JSON.parse(e.value);e.value=JSON.stringify(t),showNotification("JSON minified","success")}catch(t){showNotification("Minification failed: "+t.message,"error")}}function updateDirtyIndicator(){const e=document.getElementById("editor-dirty-indicator");e&&(e.style.display=editorState.isDirty?"inline":"none")}function showNotification(e,t="info"){if(typeof NotificationManager<"u"){t==="success"?NotificationManager.success(e):t==="error"?NotificationManager.error(e):NotificationManager.info(e);return}Logger.info("EDITOR",`[${t.toUpperCase()}] ${e}`)}Logger.info("UI","\u2705 All required modules loaded successfully"),window.DEFAULT_SETTINGS={host:"localhost",port:"8080",requestTimeout:"69000",customHeaders:{},customHeadersRaw:"",cacheEnabled:!0,autoRefreshEnabled:!1,refreshInterval:"0",autoConnect:!0,cacheRebuildDelay:"1000",cacheValidationDelay:"1500",optimisticCacheAgeLimit:"30000",cacheCountDiffThreshold:"2",backgroundFetchDelay:"200"};const DEFAULT_SETTINGS=window.DEFAULT_SETTINGS;window.customHeaders={...DEFAULT_SETTINGS.customHeaders||{}};let autoConnectInitiated=!1;function getStoredSettings(){return window.SettingsStore&&typeof window.SettingsStore.getStoredSettings=="function"?window.SettingsStore.getStoredSettings():{}}function parseCustomHeadersInput(e){return window.SettingsStore&&typeof window.SettingsStore.parseCustomHeadersInput=="function"?window.SettingsStore.parseCustomHeadersInput(e):{headers:{},raw:""}}function serializeCustomHeaders(e){return window.SettingsStore&&typeof window.SettingsStore.serializeCustomHeaders=="function"?window.SettingsStore.serializeCustomHeaders(e):""}function shouldAutoConnect(e){return window.SettingsStore&&typeof window.SettingsStore.shouldAutoConnect=="function"?window.SettingsStore.shouldAutoConnect(e):!1}function showOnboardingOverlay(){const e=document.getElementById("onboarding-overlay");if(!e)return;e.classList.remove("hidden"),requestAnimationFrame(()=>{e.classList.add("visible")}),document.body&&document.body.classList.add("onboarding-active");const t=e.querySelector("#onboarding-host");t&&t.focus()}function hideOnboardingOverlay(){const e=document.getElementById("onboarding-overlay");e&&(e.classList.remove("visible"),setTimeout(()=>{e.classList.add("hidden")},220),document.body&&document.body.classList.remove("onboarding-active"))}function attemptAutoConnect(e,t={}){if(Logger.info("UI","\u{1F50C} [attemptAutoConnect] Called with settings:",e),Logger.info("UI","\u{1F50C} [attemptAutoConnect] Options:",t),Logger.info("UI","\u{1F50C} [attemptAutoConnect] shouldAutoConnect:",shouldAutoConnect(e)),Logger.info("UI","\u{1F50C} [attemptAutoConnect] autoConnectInitiated:",autoConnectInitiated),!shouldAutoConnect(e)){Logger.info("UI","\u26A0\uFE0F [attemptAutoConnect] Skipping - shouldAutoConnect returned false");return}if(autoConnectInitiated&&!t.force){Logger.info("UI","\u26A0\uFE0F [attemptAutoConnect] Skipping - already initiated and not forced");return}autoConnectInitiated=!0,Logger.info("UI","\u2705 [attemptAutoConnect] Proceeding with autoconnect");const n=()=>{try{Logger.info("UI","\u{1F50C} [attemptAutoConnect] Triggering connection...");const a=typeof window.connectToWireMock=="function"?window.connectToWireMock():null;a&&typeof a.catch=="function"&&a.catch(o=>{Logger.error("UI","\u274C Auto-connect failed:",o),autoConnectInitiated=!1})}catch(a){Logger.error("UI","\u274C Auto-connect encountered an error:",a),autoConnectInitiated=!1}};t.immediate?(Logger.info("UI","\u{1F50C} [attemptAutoConnect] Immediate mode - connecting now"),n()):(Logger.info("UI","\u{1F50C} [attemptAutoConnect] Delayed mode - connecting in 150ms"),setTimeout(n,150))}function initializeOnboardingFlow(){const e=document.getElementById("onboarding-overlay"),t=document.getElementById("onboarding-form"),n=document.getElementById("onboarding-host"),a=document.getElementById("onboarding-port"),o=document.getElementById("onboarding-headers"),r=document.getElementById("onboarding-auto-connect"),c=getStoredSettings(),s=!!(c.host&&c.port);Logger.info("UI","\u{1F527} [initializeOnboardingFlow] Settings:",c),Logger.info("UI","\u{1F527} [initializeOnboardingFlow] Has configuration:",s),Logger.info("UI","\u{1F527} [initializeOnboardingFlow] autoConnect setting:",c.autoConnect),n&&(n.value=c.host||DEFAULT_SETTINGS.host||""),a&&(a.value=c.port||DEFAULT_SETTINGS.port||""),o&&(o.value=serializeCustomHeaders(c)),r&&(r.checked=c.autoConnect!==!1),s?(Logger.info("UI","\u2705 [initializeOnboardingFlow] Configuration found - attempting autoconnect"),attemptAutoConnect(c)):(Logger.info("UI","\u26A0\uFE0F [initializeOnboardingFlow] No configuration - showing onboarding overlay"),showOnboardingOverlay()),t&&t.addEventListener("submit",d=>{d.preventDefault();const g=n?.value.trim(),E=a?.value.trim();if(!g){typeof NotificationManager<"u"&&NotificationManager.error("Host is required."),n?.focus();return}let b;try{b=parseCustomHeadersInput(o?.value??"")}catch(I){Logger.error("UI","Failed to parse onboarding headers:",I),typeof NotificationManager<"u"&&NotificationManager.error(I.message),o?.focus();return}const S={...DEFAULT_SETTINGS,...getStoredSettings(),host:g,port:E||DEFAULT_SETTINGS.port,customHeaders:b.headers,customHeadersRaw:b.raw,autoConnect:r?r.checked:DEFAULT_SETTINGS.autoConnect};localStorage.setItem("wiremock-settings",JSON.stringify(S)),window.customHeaders={...S.customHeaders||{}},loadSettings(),loadConnectionSettings(),hideOnboardingOverlay(),shouldAutoConnect(S)?attemptAutoConnect(S,{immediate:!0,force:!0}):typeof NotificationManager<"u"&&NotificationManager.info("Connection saved. You can connect from the dashboard when you are ready.")},{once:!1})}window.initializeOnboardingFlow=initializeOnboardingFlow,window.attemptAutoConnect=attemptAutoConnect,window.hideOnboardingOverlay=hideOnboardingOverlay,window.editMapping=e=>{Logger.info("UI","\u{1F527} Opening editor for mapping:",e);const t=getStoredSettings(),n=encodeURIComponent(JSON.stringify(t)),a=`editor/json-editor.html?mappingId=${e}&mode=edit&settings=${n}`,o=window.open(a,`editor_${e}`,"width=1200,height=800,scrollbars=yes,resizable=yes,status=yes");if(!o){NotificationManager.error("Popup blocked. Please allow popups for this site.");return}NotificationManager.info(`Editor opened for mapping ${e}`);const r=window.LifecycleManager.setNamedInterval("editor-close-watch",()=>{o.closed&&(window.LifecycleManager.clearInterval(r),Logger.info("UI","\u{1F504} Editor closed, updating counters only"),Utils.safeCall(window.updateMappingsCounter),Utils.safeCall(window.updateRequestsCounter))},1e3);window.LifecycleManager.setTimeout(()=>{o.closed||(window.LifecycleManager.clearInterval(r),Logger.info("UI","\u{1F504} Editor interval cleaned up after timeout"))},300*1e3)};function computeSwaggerUiUrl(e,t){const n=(e??"").toString().trim(),a=(t??"").toString().trim();if(!n&&!a)return null;try{const o=typeof window.normalizeWiremockBaseUrl=="function"?window.normalizeWiremockBaseUrl(n,a):`http://${n||"localhost"}:${a||"8080"}/__admin`;return o?`${o.replace(/\/?$/,"")}/swagger-ui/`:null}catch(o){return Logger.warn("UI","Failed to compute Swagger UI URL:",o),null}}window.updateSwaggerUILink=(e,t)=>{const n=document.getElementById("swagger-ui-link"),a=document.getElementById("swagger-ui-link-hint");if(!n)return;const o=e??document.getElementById("default-host")?.value??"",r=t??document.getElementById("default-port")?.value??"",c=computeSwaggerUiUrl(o,r);c?(n.href=c,n.textContent=c,n.classList.remove("is-disabled"),n.removeAttribute("aria-disabled"),a&&(a.textContent="Opens the WireMock Admin Swagger UI in a new tab.")):(n.removeAttribute("href"),n.textContent="Define host and port to enable Swagger UI link",n.classList.add("is-disabled"),n.setAttribute("aria-disabled","true"),a&&(a.textContent="We build this link from your saved connection details."))},window.saveSettings=()=>{try{const e=document.getElementById("cache-enabled"),t=document.getElementById("auto-refresh-enabled"),n=document.getElementById("auto-connect-enabled"),a=document.getElementById("custom-headers");let o;try{o=parseCustomHeadersInput(a?.value??"")}catch(d){Logger.error("UI","Failed to parse custom headers:",d),typeof NotificationManager<"u"&&NotificationManager.error(d.message),a?.focus();return}const r={...DEFAULT_SETTINGS,...getStoredSettings(),host:document.getElementById("default-host")?.value||DEFAULT_SETTINGS.host,port:document.getElementById("default-port")?.value||DEFAULT_SETTINGS.port,requestTimeout:document.getElementById("request-timeout")?.value||DEFAULT_SETTINGS.requestTimeout,cacheEnabled:e?.checked??DEFAULT_SETTINGS.cacheEnabled,autoRefreshEnabled:t?.checked??DEFAULT_SETTINGS.autoRefreshEnabled,refreshInterval:document.getElementById("refresh-interval")?.value||DEFAULT_SETTINGS.refreshInterval,cacheRebuildDelay:document.getElementById("cache-rebuild-delay")?.value||DEFAULT_SETTINGS.cacheRebuildDelay,cacheValidationDelay:document.getElementById("cache-validation-delay")?.value||DEFAULT_SETTINGS.cacheValidationDelay,optimisticCacheAgeLimit:document.getElementById("optimistic-cache-age-limit")?.value||DEFAULT_SETTINGS.optimisticCacheAgeLimit,cacheCountDiffThreshold:document.getElementById("cache-count-diff-threshold")?.value||DEFAULT_SETTINGS.cacheCountDiffThreshold,backgroundFetchDelay:document.getElementById("background-fetch-delay")?.value||DEFAULT_SETTINGS.backgroundFetchDelay,autoConnect:n?.checked??DEFAULT_SETTINGS.autoConnect,customHeaders:o.headers,customHeadersRaw:o.raw},c=document.getElementById("wiremock-host"),s=document.getElementById("wiremock-port");c&&(c.value=r.host),s&&(s.value=r.port),localStorage.setItem("wiremock-settings",JSON.stringify(r)),Logger.info("UI","\u{1F527} [main.js] Settings saved to localStorage:",r),Logger.info("UI","\u{1F527} [main.js] Request timeout field value:",document.getElementById("request-timeout")?.value),typeof window.normalizeWiremockBaseUrl=="function"?window.wiremockBaseUrl=window.normalizeWiremockBaseUrl(r.host,r.port):window.wiremockBaseUrl=`http://${r.host}:${r.port}/__admin`,window.customHeaders={...r.customHeaders||{}},broadcastSettingsUpdate(r),NotificationManager.success("Settings saved successfully!"),Logger.info("UI","\u{1F4BE} Settings saved:",r),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(r.host,r.port)}catch(e){Logger.error("UI","Error saving settings:",e),NotificationManager.error("Failed to save settings")}},window.resetSettings=()=>{if(confirm("Reset all settings to defaults?"))try{const e={host:document.getElementById("default-host"),port:document.getElementById("default-port"),timeout:document.getElementById("request-timeout"),cacheEnabled:document.getElementById("cache-enabled"),autoRefresh:document.getElementById("auto-refresh-enabled"),refreshInterval:document.getElementById("refresh-interval"),customHeaders:document.getElementById("custom-headers"),autoConnect:document.getElementById("auto-connect-enabled")};e.host&&(e.host.value=DEFAULT_SETTINGS.host),e.port&&(e.port.value=DEFAULT_SETTINGS.port),e.timeout&&(e.timeout.value=DEFAULT_SETTINGS.requestTimeout),e.cacheEnabled&&(e.cacheEnabled.checked=DEFAULT_SETTINGS.cacheEnabled),e.autoRefresh&&(e.autoRefresh.checked=DEFAULT_SETTINGS.autoRefreshEnabled),e.refreshInterval&&(e.refreshInterval.value=DEFAULT_SETTINGS.refreshInterval),e.customHeaders&&(e.customHeaders.value=DEFAULT_SETTINGS.customHeadersRaw||""),e.autoConnect&&(e.autoConnect.checked=DEFAULT_SETTINGS.autoConnect),localStorage.setItem("wiremock-settings",JSON.stringify(DEFAULT_SETTINGS)),window.wiremockBaseUrl=`http://${DEFAULT_SETTINGS.host}:${DEFAULT_SETTINGS.port}/__admin`,window.customHeaders={...DEFAULT_SETTINGS.customHeaders||{}},broadcastSettingsUpdate(DEFAULT_SETTINGS),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(DEFAULT_SETTINGS.host,DEFAULT_SETTINGS.port),NotificationManager.success("Settings reset to defaults!"),Logger.info("UI","\u{1F504} Settings reset to defaults")}catch(e){Logger.error("UI","Error resetting settings:",e),NotificationManager.error("Failed to reset settings")}},window.loadSettings=()=>{try{const e=getStoredSettings();Logger.info("UI","\u{1F527} [main.js] Loading settings from localStorage:",e);const t={host:document.getElementById("default-host"),port:document.getElementById("default-port"),timeout:document.getElementById("request-timeout"),cacheEnabled:document.getElementById("cache-enabled"),autoRefresh:document.getElementById("auto-refresh-enabled"),refreshInterval:document.getElementById("refresh-interval"),cacheRebuildDelay:document.getElementById("cache-rebuild-delay"),cacheValidationDelay:document.getElementById("cache-validation-delay"),optimisticCacheAgeLimit:document.getElementById("optimistic-cache-age-limit"),cacheCountDiffThreshold:document.getElementById("cache-count-diff-threshold"),backgroundFetchDelay:document.getElementById("background-fetch-delay"),customHeaders:document.getElementById("custom-headers"),autoConnect:document.getElementById("auto-connect-enabled")};if(t.host&&(t.host.value=e.host||DEFAULT_SETTINGS.host),t.port&&(t.port.value=e.port||DEFAULT_SETTINGS.port),t.timeout&&(t.timeout.value=e.requestTimeout||DEFAULT_SETTINGS.requestTimeout),t.cacheEnabled&&(t.cacheEnabled.checked=e.cacheEnabled!==void 0?e.cacheEnabled:DEFAULT_SETTINGS.cacheEnabled),t.autoRefresh&&(t.autoRefresh.checked=e.autoRefreshEnabled!==void 0?e.autoRefreshEnabled:DEFAULT_SETTINGS.autoRefreshEnabled),t.refreshInterval&&(t.refreshInterval.value=e.refreshInterval||DEFAULT_SETTINGS.refreshInterval),t.cacheRebuildDelay&&(t.cacheRebuildDelay.value=e.cacheRebuildDelay||DEFAULT_SETTINGS.cacheRebuildDelay),t.cacheValidationDelay&&(t.cacheValidationDelay.value=e.cacheValidationDelay||DEFAULT_SETTINGS.cacheValidationDelay),t.optimisticCacheAgeLimit&&(t.optimisticCacheAgeLimit.value=e.optimisticCacheAgeLimit||DEFAULT_SETTINGS.optimisticCacheAgeLimit),t.cacheCountDiffThreshold&&(t.cacheCountDiffThreshold.value=e.cacheCountDiffThreshold||DEFAULT_SETTINGS.cacheCountDiffThreshold),t.backgroundFetchDelay&&(t.backgroundFetchDelay.value=e.backgroundFetchDelay||DEFAULT_SETTINGS.backgroundFetchDelay),t.customHeaders&&(t.customHeaders.value=serializeCustomHeaders(e)),t.autoConnect&&(t.autoConnect.checked=e.autoConnect!==!1),window.customHeaders=e.customHeaders&&typeof e.customHeaders=="object"&&!Array.isArray(e.customHeaders)?{...e.customHeaders}:{...DEFAULT_SETTINGS.customHeaders||{}},Logger.info("UI","\u{1F4CB} Settings loaded into settings form"),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(e.host,e.port),typeof window.updateRecorderLink=="function")try{window.updateRecorderLink(e.host,e.port)}catch(n){Logger.warn("UI","Failed to update recorder link:",n)}}catch(e){Logger.error("UI","Error loading settings:",e)}};function broadcastSettingsUpdate(e){try{localStorage.setItem("wiremock-settings-broadcast",JSON.stringify({timestamp:Date.now(),settings:e})),Logger.info("UI","\u{1F4E1} Broadcasting settings update to editor windows")}catch(t){Logger.warn("UI","Failed to broadcast settings update:",t)}}if(window.wiremockBaseUrl||(window.wiremockBaseUrl=`http://${DEFAULT_SETTINGS.host}:${DEFAULT_SETTINGS.port}/__admin`,Logger.info("UI","\u{1F527} [main.js] Initialized default WireMock URL:",window.wiremockBaseUrl)),window.applyDefaultsToForm=()=>{Logger.info("UI","\u{1F527} [applyDefaultsToForm] Setting form defaults from DEFAULT_SETTINGS");const e=document.getElementById("default-host"),t=document.getElementById("default-port"),n=document.getElementById("request-timeout"),a=document.getElementById("cache-enabled"),o=document.getElementById("auto-refresh-enabled"),r=document.getElementById("refresh-interval"),c=document.getElementById("custom-headers"),s=document.getElementById("auto-connect-enabled");e&&!e.value&&(e.value=DEFAULT_SETTINGS.host),t&&!t.value&&(t.value=DEFAULT_SETTINGS.port),n&&!n.value&&(n.value=DEFAULT_SETTINGS.requestTimeout),a&&(a.checked=DEFAULT_SETTINGS.cacheEnabled),o&&(o.checked=DEFAULT_SETTINGS.autoRefreshEnabled),r&&!r.value&&(r.value=DEFAULT_SETTINGS.refreshInterval),c&&!c.value&&(c.value=DEFAULT_SETTINGS.customHeadersRaw||""),s&&(s.checked=DEFAULT_SETTINGS.autoConnect),Logger.info("UI","\u{1F527} [applyDefaultsToForm] Form defaults applied")},document.addEventListener("DOMContentLoaded",async()=>{if(await new Promise(c=>requestAnimationFrame(c)),window.location.pathname.includes("json-editor.html")||window.location.search.includes("mappingId=")||window.location.search.includes("mode=edit")||window.location.search.includes("mode=create")){Logger.info("UI","\u{1F4DD} JSON Editor page detected - skipping main app initialization");return}typeof window.initializeSidebarPreference=="function"&&window.initializeSidebarPreference(),applyDefaultsToForm(),loadSettings(),loadConnectionSettings(),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink();const t=document.getElementById("default-host"),n=document.getElementById("default-port"),a=()=>{typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink()};t?.addEventListener("input",a),n?.addEventListener("input",a),t?.addEventListener("change",a),n?.addEventListener("change",a),Logger.info("UI","\u{1F527} [main.js] Page loaded, defaults applied, settings initialized, ready for user interaction"),typeof window.initializeFilterTabs=="function"&&window.initializeFilterTabs(),typeof window.initMappingPagination=="function"&&window.initMappingPagination(),typeof window.FilterManager?.restoreFilters=="function"&&(window.FilterManager.restoreFilters("mappings"),typeof window.updateActiveFiltersDisplay=="function"&&window.updateActiveFiltersDisplay(),window.FilterManager.restoreFilters("requests"),typeof window.updateRequestActiveFiltersDisplay=="function"&&window.updateRequestActiveFiltersDisplay()),typeof window.loadAllSavedFilters=="function"&&window.loadAllSavedFilters();const o=typeof window.getActiveTabFromURL=="function"?window.getActiveTabFromURL():null;o&&["mappings","requests","scenarios","import-export","recording","settings"].includes(o)&&typeof window.showPage=="function"&&(Logger.info("UI",`\u{1F517} Switching to tab from URL: ${o}`),window.showPage(o,document.querySelector(`[onclick*="showPage('${o}')"]`))),initializeOnboardingFlow()}),window.addEventListener("popstate",()=>{if(Logger.info("UI","\u2B05\uFE0F Browser navigation detected, syncing filters from URL"),typeof window.URLStateManager>"u")return;const e=window.TabManager?.getCurrentTab();e==="mappings"?(window.URLStateManager.syncUIFromURL("mappings"),typeof window.FilterManager<"u"&&window.FilterManager.flushMappingFilters()):e==="requests"&&(window.URLStateManager.syncUIFromURL("requests"),typeof window.FilterManager<"u"&&window.FilterManager.flushRequestFilters())}),window.addEventListener("storage",e=>{if(e.key==="wiremock-settings"&&e.newValue)try{const t=JSON.parse(e.newValue);Logger.info("UI","\u{1F527} [main.js] Settings updated from external source:",t);const n=document.getElementById("wiremock-host"),a=document.getElementById("wiremock-port");n&&t.host&&(n.value=t.host),a&&t.port&&(a.value=t.port),t.host&&t.port&&(typeof window.normalizeWiremockBaseUrl=="function"?window.wiremockBaseUrl=window.normalizeWiremockBaseUrl(t.host,t.port):window.wiremockBaseUrl=`http://${t.host}:${t.port}/__admin`,Logger.info("UI","\u{1F527} [main.js] URL updated from settings change:",window.wiremockBaseUrl)),typeof window.updateSwaggerUILink=="function"&&window.updateSwaggerUILink(t.host,t.port),t.customHeaders&&typeof t.customHeaders=="object"&&!Array.isArray(t.customHeaders)?window.customHeaders={...t.customHeaders}:window.customHeaders={}}catch(t){Logger.error("UI","\u{1F527} [main.js] Error processing settings update:",t)}}),window.addEventListener("message",e=>{if(e.origin===window.location.origin){if(e.data&&e.data.type==="imock-cache-refresh"&&(Logger.info("UI","\u{1F4E8} [main.js] Received cache refresh request from:",e.data.source),typeof window.refreshImockCache=="function"&&window.refreshImockCache().catch(t=>{Logger.warn("UI","Failed to refresh cache from message:",t)})),e.data&&e.data.type==="imock-optimistic-mapping-update"&&(Logger.info("UI","\u{1F3AF} [main.js] Received optimistic mapping update from:",e.data.source,e.data.mapping.id),typeof window.applyOptimisticMappingUpdate=="function"&&(window.applyOptimisticMappingUpdate(e.data.mapping),typeof window.fetchAndRenderMappings=="function"))){Logger.info("UI","\u{1F3AF} [main.js] Triggering UI refresh after optimistic update");const t=window.MappingsStore.getAll();window.fetchAndRenderMappings(t)}e.data&&e.data.type==="imock-optimistic-cache-update"&&(Logger.info("UI","\u{1F9E9} [main.js] Received optimistic cache update from:",e.data.source,e.data.operation,e.data.mapping?.id),typeof window.updateOptimisticCache=="function"&&window.updateOptimisticCache(e.data.mapping,e.data.operation))}}),window.addEventListener("storage",e=>{if(e.key==="imock-cache-refresh-trigger"&&e.newValue&&(Logger.info("UI","\u{1F4BE} [main.js] Received localStorage cache refresh trigger"),typeof window.refreshImockCache=="function"&&window.refreshImockCache().catch(t=>{Logger.warn("UI","Failed to refresh cache from localStorage trigger:",t)})),e.key==="imock-optimistic-update"&&e.newValue)try{const t=JSON.parse(e.newValue);if(Logger.info("UI","\u{1F3AF} [main.js] Received localStorage optimistic update from:",t.source,"for mapping:",t.mapping?.id),t.mapping&&typeof window.applyOptimisticMappingUpdate=="function"){if(window.applyOptimisticMappingUpdate(t.mapping),typeof window.fetchAndRenderMappings=="function"){Logger.info("UI","\u{1F3AF} [main.js] Triggering UI refresh after localStorage optimistic update");const n=window.MappingsStore.getAll();window.fetchAndRenderMappings(n)}typeof window.updateMappingsCounter=="function"&&window.updateMappingsCounter()}}catch(t){Logger.warn("UI","Failed to process optimistic update from localStorage:",t)}}),typeof BroadcastChannel<"u")try{const e=new BroadcastChannel("imock-cache-refresh"),t=new BroadcastChannel("imock-optimistic-updates");e.addEventListener("message",n=>{n.data&&n.data.type==="cache-refresh"&&(Logger.info("UI","\u{1F4E1} [main.js] Received BroadcastChannel cache refresh from:",n.data.source),typeof window.refreshImockCache=="function"&&window.refreshImockCache().catch(a=>{Logger.warn("UI","Failed to refresh cache from BroadcastChannel:",a)}))}),t.addEventListener("message",n=>{if(n.data&&n.data.type==="optimistic-mapping-update"&&(Logger.info("UI","\u{1F3AF} [main.js] Received BroadcastChannel optimistic update from:",n.data.source,n.data.mapping.id),typeof window.applyOptimisticMappingUpdate=="function"&&(window.applyOptimisticMappingUpdate(n.data.mapping),typeof window.fetchAndRenderMappings=="function"))){Logger.info("UI","\u{1F3AF} [main.js] Triggering UI refresh after BroadcastChannel optimistic update");const a=window.MappingsStore.getAll();window.fetchAndRenderMappings(a)}}),window.addEventListener("beforeunload",()=>{e.close(),t.close()})}catch(e){Logger.warn("UI","BroadcastChannel setup failed:",e)}function loadConnectionSettings(){try{const e=getStoredSettings();Logger.info("UI","\u{1F527} [loadConnectionSettings] Loading settings:",e);const t=document.getElementById("wiremock-host"),n=document.getElementById("wiremock-port");t&&e.host&&(t.value=e.host,Logger.info("UI","\u{1F527} [loadConnectionSettings] Set host input:",e.host)),n&&e.port&&(n.value=e.port,Logger.info("UI","\u{1F527} [loadConnectionSettings] Set port input:",e.port)),Logger.info("UI","\u{1F527} [loadConnectionSettings] Form fields updated, URL will be set by connectToWireMock()")}catch(e){Logger.error("UI","Error loading connection settings:",e),Logger.info("UI","\u{1F527} [loadConnectionSettings] Error loading settings, form fields may remain empty")}}
