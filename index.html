<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iMock - Wiremock UI Client</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- CSS files in logical loading order -->
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/modals.css">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body data-theme="light">
    <div class="header">
        <div class="logo">
            üçé iMock
            <span class="version">v2.2</span>
        </div>
        <div class="status">
            <div class="status-indicator">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Disconnected</span>
                <span id="health-indicator" style="display: none; margin-left: 10px; font-size: 0.9em;"></span>
            </div>
            <button class="theme-toggle" onclick="if(typeof toggleTheme === 'function') toggleTheme()">
                <span id="theme-icon">üåô</span>
            </button>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="nav-item active" onclick="showPage('mappings', this)">
                <span class="nav-icon">üìã</span> Mappings
            </div>
            <div class="nav-item" onclick="showPage('requests', this)">
                <span class="nav-icon">üì•</span> Request Log
            </div>
            <div class="nav-item" onclick="showPage('scenarios', this)">
                <span class="nav-icon">üé≠</span> Scenarios
            </div>
            <div class="nav-item" onclick="showPage('import-export', this)">
                <span class="nav-icon">üì¶</span> Import/Export
            </div>
            <div class="nav-item" onclick="showPage('recording', this)">
                <span class="nav-icon">üéôÔ∏è</span> Recording
            </div>
            <div class="nav-item" onclick="showPage('settings', this)">
                <span class="nav-icon">‚öôÔ∏è</span> Settings
            </div>
        </div>
        
        <div class="main-content">
            <!-- MAPPINGS PAGE -->
            <div id="mappings-page">
                <div class="page-header">
                    <div class="stats-spacer" id="stats-spacer"></div>
                    <div class="stats" id="stats" style="display: none;">
                        <div class="stat-card">
                            <div class="stat-number" id="mappings-count">0</div>
                            <div class="stat-label">Mappings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="requests-count">0</div>
                            <div class="stat-label">Requests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="scenarios-count">0</div>
                            <div class="stat-label">Scenarios</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="uptime">0s</div>
                            <div class="stat-label">Uptime</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--space-3); align-items: center;">
                        <span id="data-source-indicator" class="badge badge-secondary" title="Current data source">Source: direct</span>
                        <button class="btn btn-secondary" onclick="refreshMappings()">üîÑ Refresh</button>
                        <button class="btn btn-secondary" onclick="forceRefreshCache()" title="Rebuild the service cache mapping and reload">‚ö° Force Refresh Cache</button>
                        <button class="btn btn-primary" onclick="openAddMappingModal()" id="add-mapping-btn" disabled>+ Add Mapping</button>
                    </div>
                </div>

                <div class="card" id="connection-setup">
                    <div class="card-header">
                        <h3 class="card-title">Connect to WireMock Server</h3>
                    </div>
                    <p style="margin-bottom: var(--space-6); color: var(--text-secondary);">Enter your WireMock server details to get started:</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Host</label>
                            <input type="text" class="form-input" id="wiremock-host" value="localhost">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-input" id="wiremock-port" value="8080">
                        </div>
                        <div class="form-group" style="display: flex; gap: var(--space-2); align-items: end;">
                            <button class="btn btn-success" onclick="connectToWireMock()">Connect</button>
                            <button class="btn btn-secondary" onclick="loadMockData()">Demo Mode</button>
                            <button class="btn btn-warning" onclick="checkHealth()">Health Check</button>
                        </div>
                    </div>
                </div>
                
                
                <div class="search-filters" id="search-filters" style="display: none;">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label class="form-label">Method</label>
                            <select class="form-select" id="filter-method" onchange="applyFilters()">
                                <option value="">All Methods</option>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Search by URL or Name</label>
                            <input type="text" class="form-input" id="filter-url" placeholder="Enter URL or Name" oninput="applyFilters()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <input type="number" class="form-input" id="filter-status" placeholder="e.g., 200" min="100" max="599" oninput="applyFilters()">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="clearMappingFilters()">Clear Filters</button>
                        </div>
                    </div>
                </div>
                
                <div id="mappings-loading" class="loading hidden">Loading mappings...</div>
                <div id="mappings-list-container">
                    <div id="mappings-empty" class="empty-state hidden">
                        <h3>No mappings found</h3>
                        <p>Connect to WireMock server or use Demo Mode to see mappings.</p>
                    </div>
                    <div class="cards-container" id="mappings-list" style="display: none;">
                        <!-- Mapping items will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- REQUESTS PAGE -->
            <div id="requests-page" class="hidden">
                <div class="page-header">
                    <div class="page-title">Request Log</div>
                    <div style="display: flex; gap: var(--space-2); align-items: center;">
                        <span id="requests-source-indicator" class="badge badge-secondary" title="Current data source">Requests: direct</span>
                        <button class="btn btn-secondary" onclick="refreshRequests()">üîÑ Refresh</button>
                        <button class="btn btn-danger" onclick="clearRequests()">üóëÔ∏è Clear Log</button>
                        <button class="btn btn-secondary" onclick="clearRequestFilters()">üßπ Clear Filters</button>
                    </div>
                </div>
                
                <div class="search-filters">
                    <!-- First row: Basic filters -->
                    <div class="filter-grid">
                        <div class="form-group">
                            <label class="form-label">Method</label>
                            <select class="form-select" id="req-filter-method" onchange="applyRequestFilters()">
                                <option value="">All Methods</option>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="req-filter-status" onchange="applyRequestFilters()">
                                <option value="">All Statuses</option>
                                <option value="matched">‚úÖ Matched</option>
                                <option value="unmatched">‚ùå Unmatched</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">URL Pattern</label>
                            <input type="text" class="form-input" id="req-filter-url" placeholder="e.g., /api/*" oninput="applyRequestFilters()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quick Filter</label>
                            <select class="form-select" id="req-filter-quick" onchange="applyQuickFilter()">
                                <option value="">Select time range</option>
                                <option value="5m">Last 5 minutes</option>
                                <option value="15m">Last 15 minutes</option>
                                <option value="30m">Last 30 minutes</option>
                                <option value="1h">Last 1 hour</option>
                                <option value="3h">Last 3 hours</option>
                                <option value="6h">Last 6 hours</option>
                                <option value="12h">Last 12 hours</option>
                                <option value="1d">Last 1 day</option>
                                <option value="3d">Last 3 days</option>
                                <option value="7d">Last 7 days</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Second row: Time Range -->
                    <div class="filter-grid" style="margin-top: var(--space-3);">
                        <div class="form-group">
                            <label class="form-label">Custom Time Range</label>
                            <div style="display: flex; gap: var(--space-2);">
                                <input type="datetime-local" class="form-input" id="req-filter-from" onchange="clearQuickFilter(); applyRequestFilters()" style="flex: 1;" placeholder="From">
                                <input type="datetime-local" class="form-input" id="req-filter-to" onchange="clearQuickFilter(); applyRequestFilters()" style="flex: 1;" placeholder="To">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="requests-loading" class="loading hidden">Loading requests...</div>
                <div id="requests-list-container">
                    <div id="requests-empty" class="empty-state hidden">
                        <h3>No requests logged</h3>
                        <p>Make some API calls to see them here.</p>
                    </div>
                    <div class="cards-container" id="requests-list" style="display: none;">
                        <!-- Request items will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- SCENARIOS PAGE -->
            <div id="scenarios-page" class="hidden">
                <div class="page-header">
                    <div class="page-title">Scenario Management</div>
                    <div style="display: flex; gap: var(--space-2);">
                        <button class="btn btn-secondary" onclick="refreshScenarios()">üîÑ Refresh</button>
                        <button class="btn btn-danger" onclick="resetAllScenarios()">üîÑ Reset All</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Scenario State Control</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Scenario</label>
                            <select class="form-select" id="scenario-select">
                                <option value="">Select Scenario</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Set State</label>
                            <input type="text" class="form-input" id="scenario-state" placeholder="Enter state name">
                        </div>
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button class="btn btn-primary" onclick="setScenarioState()">Update State</button>
                        </div>
                    </div>
                </div>
                
                <div id="scenarios-loading" class="loading hidden">Loading scenarios...</div>
                <div id="scenarios-list-container">
                    <div id="scenarios-empty" class="empty-state hidden">
                        <h3>No scenarios found</h3>
                        <p>Create mappings with scenarios to manage state here.</p>
                    </div>
                    <div class="cards-container" id="scenarios-list" style="display: none;">
                        <!-- Scenario items will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- IMPORT/EXPORT PAGE -->
            <div id="import-export-page" class="hidden">
                <div class="page-header">
                    <div class="page-title">Import/Export</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6);">
                    <!-- Export Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üì§ Export Data</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Export Format</label>
                            <select class="form-select" id="export-format">
                                <option value="json">JSON</option>
                                <option value="yaml">YAML</option>
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                            <button class="btn btn-primary" onclick="exportMappings()">üì§ Export All Mappings</button>
                            <button class="btn btn-secondary" onclick="exportRequests()">üì§ Export Request Log</button>
                        </div>
                        <div id="export-result" style="margin-top: var(--space-4);"></div>
                    </div>
                    
                    <!-- Import Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üì• Import Data</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Import File</label>
                            <div class="file-input-container">
                                <input type="file" class="file-input" id="import-file" accept=".json,.yaml,.yml" onchange="updateFileDisplay()">
                                <label for="import-file" class="btn btn-secondary" style="width: 100%; justify-content: center;">üìÅ Choose File</label>
                                <div class="file-display" style="margin-top: var(--space-2); padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center; color: var(--text-secondary);" id="file-display">
                                    <span class="file-placeholder">No file selected</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" id="import-actions" style="display: none;">
                            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                <button class="btn btn-primary" onclick="importMappings()">üì• Add to Existing</button>
                                <button class="btn btn-danger" onclick="importAndReplace()">üîÑ Replace All</button>
                            </div>
                        </div>
                        <div id="import-result" style="margin-top: var(--space-4);"></div>
                    </div>
                </div>
            </div>
            
            <!-- RECORDING PAGE -->
            <div id="recording-page" class="hidden">
                <div class="page-header">
                    <div class="page-title">Recording</div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üéôÔ∏è Record API Calls</h3>
                    </div>
                    <p style="margin-bottom: var(--space-4); color: var(--text-secondary);">Configure recording settings to capture real API calls and generate mappings automatically.</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Target URL</label>
                            <input type="text" class="form-input" id="record-target-url" placeholder="https://api.example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Recording Mode</label>
                            <select class="form-select" id="record-mode">
                                <option value="record">Record</option>
                                <option value="snapshot">Snapshot</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-3); margin-top: var(--space-4);">
                        <button class="btn btn-success" onclick="startRecording()">‚ñ∂Ô∏è Start Recording</button>
                        <button class="btn btn-danger" onclick="stopRecording()">‚èπÔ∏è Stop Recording</button>
                        <button class="btn btn-secondary" onclick="clearRecordings()">üóëÔ∏è Clear Recordings</button>
                    </div>
                    
                    <div id="recording-status" style="margin-top: var(--space-4);"></div>
                </div>
                
                <div id="recordings-list" style="margin-top: var(--space-6);">
                    <!-- Recorded mappings will appear here -->
                </div>
            </div>
            
            <!-- SETTINGS PAGE -->
            <div id="settings-page" class="hidden">
                <div class="page-header">
                    <div class="page-title">Settings</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6);">
                    <!-- General Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‚öôÔ∏è General Settings</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Theme</label>
                            <select class="form-select" id="theme-select" onchange="changeTheme()">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="auto">Auto</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Auto-refresh Interval (seconds)</label>
                            <input type="number" class="form-input" id="refresh-interval" value="30" min="5" max="300">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="auto-refresh-enabled" checked> Enable Auto-refresh
                            </label>
                        </div>
                    </div>
                    
                    <!-- Connection Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üîó Connection Settings</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Host</label>
                            <input type="text" class="form-input" id="default-host" value="localhost">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Port</label>
                            <input type="number" class="form-input" id="default-port" value="8080">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Request Timeout (ms)</label>
                            <input type="number" class="form-input" id="request-timeout" value="5000" min="1000" max="30000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Authorization Header</label>
                            <input type="text" class="form-input" id="auth-header" placeholder="Bearer token123 or Basic dXNlcjpwYXNz">
                            <small class="form-help">Optional. Will be added to all WireMock API requests</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="cache-enabled"> Enable Cache Service (use /__cache/mappings)
                            </label>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: var(--space-6); text-align: center;">
                    <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
                    <button class="btn btn-secondary" onclick="resetSettings()">üîÑ Reset to Defaults</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FOR ADDING/EDITING MAPPINGS -->
    <div id="add-mapping-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn btn-primary" onclick="saveMappingWrapper()">Save Mapping</button>
                <h3 id="modal-title">Add New Mapping</h3>
                <button class="modal-close" onclick="hideModal('add-mapping-modal')">&times;</button>
            </div>
            <form id="mapping-form">
                <input type="hidden" id="mapping-id">
                
                <div class="form-group">
                    <label class="form-label">Mapping Name</label>
                    <input type="text" class="form-input" id="mapping-name" placeholder="Enter mapping name">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Method</label>
                        <select class="form-select" id="method">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL Pattern</label>
                        <input type="text" class="form-input" id="url-pattern" placeholder="/api/users" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Response Status</label>
                    <input type="number" class="form-input" id="response-status" value="200" min="100" max="599">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Response Body</label>
                    <textarea class="form-textarea" id="response-body" rows="6" placeholder='{ "message": "Hello World" }'></textarea>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL FOR EDITING MAPPINGS -->
    <div id="edit-mapping-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn btn-primary" id="update-mapping-btn" onclick="updateMapping()">
                    <span class="btn-label">Update Mapping</span>
                    <span class="btn-spinner loading-spinner" aria-hidden="true"></span>
                </button>
                <h3 id="edit-modal-title">Edit Mapping</h3>
                <button class="modal-close" onclick="hideModal('edit-mapping-modal')">&times;</button>
            </div>
            
            <!-- Form Editor (Hidden by default) -->
            <div id="form-editor-container" style="display: none;">
            <form id="edit-mapping-form">
                <input type="hidden" id="edit-mapping-id">
                
                <div class="form-group">
                    <label class="form-label">Mapping Name</label>
                    <input type="text" class="form-input" id="edit-mapping-name" placeholder="Enter mapping name">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Method</label>
                        <select class="form-select" id="edit-method">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL Pattern</label>
                        <input type="text" class="form-input" id="edit-url-pattern" placeholder="/api/users" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Response Status</label>
                    <input type="number" class="form-input" id="edit-response-status" value="200" min="100" max="599">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Response Delay (ms)</label>
                    <input type="number" class="form-input" id="edit-response-delay" placeholder="Delay in milliseconds">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Request Headers (JSON)</label>
                    <textarea class="form-textarea" id="edit-request-headers" rows="3" placeholder='{ "Content-Type": "application/json" }'></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Request Body</label>
                    <textarea class="form-textarea" id="edit-request-body" rows="3" placeholder='{ "name": "example" }'></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Response Headers (JSON)</label>
                    <textarea class="form-textarea" id="edit-response-headers" rows="3" placeholder='{ "Content-Type": "application/json" }'></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Response Body</label>
                    <textarea class="form-textarea" id="edit-response-body" rows="6" placeholder='{ "message": "Hello World" }'></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <input type="number" class="form-input" id="edit-mapping-priority" placeholder="Priority">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Scenario Name</label>
                        <input type="text" class="form-input" id="edit-mapping-scenario" placeholder="Scenario name">
                    </div>
                </div>
            </form>
            </div>
            
            <!-- JSON Editor Container -->
            <div id="json-editor-container" class="json-editor-wrapper">
                <div class="json-editor-toolbar">
                    <div class="json-editor-meta">
                        <span id="editor-dirty-indicator" class="dirty-indicator" style="display: none;">‚óè Unsaved changes</span>
                    </div>
                    <div class="json-editor-actions">
                        <button type="button" class="btn btn-sm" data-action="format-json">üé® Format</button>
                        <button type="button" class="btn btn-sm" data-action="minify-json">üì¶ Minify</button>
                    </div>
                </div>
                <textarea id="json-editor" class="json-editor" rows="1" placeholder="{
  \"name\": \"My Mapping\",
  \"request\": {
    \"method\": \"GET\",
    \"url\": \"/api/example\"
  },
  \"response\": {
    \"status\": 200,
    \"body\": \"{\\\"message\\\":\\\"Hello World\\\"}\",
    \"headers\": {
      \"Content-Type\": \"application/json\"
    }
  }
}"></textarea>
            </div>
        </div>
    </div>

    <!-- MODAL FOR REQUEST DETAILS -->
    <div id="request-details-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Request Details</h3>
                <button class="modal-close" onclick="hideModal('request-details-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="request-details-content">
                    <!-- Request details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal('request-details-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- MODAL FOR MAPPING DETAILS -->
    <div id="mapping-details-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Mapping Details</h3>
                <button class="modal-close" onclick="hideModal('mapping-details-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mapping-details-content">
                    <!-- Mapping details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal('mapping-details-modal')">Close</button>
            </div>
        </div>
    </div>

<!-- JavaScript modules in loading order -->
<script src="js/core.js"></script>
<script src="js/managers.js"></script>
<script src="js/features.js"></script>
<script src="js/editor.js"></script>
<script src="js/main.js"></script>

</body>
</html>
